<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>OrgWeekValidationRule.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.swap.request.validation</a> &gt; <span class="el_source">OrgWeekValidationRule.java</span></div><h1>OrgWeekValidationRule.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.swap.request.validation;

import java.io.Serializable;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.empworkrule.ejb.EmpWorkRuleManager;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TOCalcUtil;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.WorkResourceAssignment;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.l10n.RmEjbLogBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validatable;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validator;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.swap.shiftitem.model.ShiftSwapItem;
import com.bluepumpkin.ejb.rm.util.RmUtil;
import com.bluepumpkin.ejb.rm.util.ShiftSwapRequestUtil;
import com.verint.ejb.wfm.WfmManagerFactory;

/**
 * &lt;li&gt;Rule from UI: Both agents comply with a weekly hours rule.
 *
 * For week with shift being given up and for the week with shift being
 * received, verify rule hour constraints, taking into account the shift being
 * given up and the shift being received.
 *
 * &lt;p&gt;
 * TODO: verifyrule contraint for week with shift being given up. Presently
 * validation only for week with shift being received.
 *
 * &lt;p&gt;
 * For one way swaps:&lt;br&gt;
 * for employee giving up shift, for week shift given up, verify rule constraint
 * &lt;br&gt;
 * for employee giving up timeoff, for week shift being received, verify rule
 * constraint. &lt;br&gt;
 *
 * &lt;p&gt;
 * For tentative approvals: processing logic same as non tentative requests as
 * it uses only the published schedule for calculation of rule hours
 *
 * &lt;p&gt;
 * Algorithm:
 * &lt;p&gt;
 * &lt;li&gt;Validation rule to ensure that each employee, participating in the shift
 * swap, does not violate the rule hours per week allocated to him/her.
 * &lt;ul&gt;
 * &lt;li&gt;for the first employee find the start of the week which contains the
 * shift (or day off) this employee will get through the swap.
 * &lt;li&gt;get the schedule information for this employee for this week
 * &lt;li&gt;calculate the work hours for this week plus the shift hours gained
 * &lt;li&gt;compare the week work hours with employee rule hours per week
 * &lt;li&gt;for the first employee, find the start of the week which contains the
 * shift being given up.
 * &lt;li&gt;get the schedule information for this employee for this week.
 * &lt;li&gt;calculate the work hours for this week minus the shift hours lost
 * &lt;li&gt;compare the week work hours with employee rule hours.
 * &lt;li&gt;repeat for each employee
 * &lt;li&gt;validation result in case of failure should have information about the
 * employee, work hours, rule limits
 * &lt;ul&gt;
 *
 * */
public abstract class OrgWeekValidationRule implements Validator {

<span class="nc" id="L85">	private static String CLASS_NAME = OrgWeekValidationRule.class.getName();</span>
<span class="nc" id="L86">	private static Category LOGGER = Log.initCategory(CLASS_NAME);</span>

	protected ShiftSwapValidationCache cache;

<span class="nc" id="L90">	protected WorkResourceManager wrmManager = null;</span>

<span class="nc" id="L92">	protected EmpWorkRuleManager ewrManager = null;</span>

	private boolean isDifferentWeek;

<span class="nc" id="L96">	public OrgWeekValidationRule() {</span>
<span class="nc" id="L97">	};</span>

	@Override
	public ValidationResult validate(Validatable validatable) throws Exception {
		// todo: move to util; common code for casting and checking for null.
<span class="nc" id="L102">		ShiftSwapRequest ssr = (ShiftSwapRequest) validatable;</span>
<span class="nc" id="L103">		String methodName = &quot;validate&quot;;</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">		if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L105">			LOGGER.debug(RmUtil.dumpEnterMethod(methodName, validatable));</span>
		}

		// todo: accomodate shiftswap items that are of type timeoff
<span class="nc" id="L109">		ValidationResult result = null;</span>

		// todo: can this be assigned once instead of during every invocaton
<span class="nc" id="L112">		cache = (ShiftSwapValidationCache) ssr.getValidationCache();</span>

		// items is an ordered list item(0) ... item(N-1)
		// item(A) gives its shift to item((A+1)modN)
		// item(A) receives its new shift from item((A+N-1)modN)
<span class="nc" id="L117">		List&lt;ShiftSwapItem&gt; ssItems = ssr.getShiftSwapItems();</span>

<span class="nc bnc" id="L119" title="All 2 branches missed.">		if (wrmManager == null) {</span>
<span class="nc" id="L120">			wrmManager = BbmManagerFactory.getWorkResourceManager();</span>
		}
<span class="nc bnc" id="L122" title="All 2 branches missed.">		if (ewrManager == null) {</span>
<span class="nc" id="L123">			ewrManager = WfmManagerFactory.getEmpWorkRuleManager();</span>
		}

		// get an array of new ShiftAssignments after the swap, and no saving to DB
<span class="nc" id="L127">		ShiftAssignment[] saArray = getShiftsAfterSwap(validatable);</span>
<span class="nc" id="L128">		this.isDifferentWeek = true;</span>

<span class="nc" id="L130">		int index = 0;</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">		for (ShiftSwapItem itemOut: ssItems) { // for each shift</span>
			// employee swapping out shift.
			//
			// Note: DETAIL_LEVEL_EMPLOYEE_TIMEBASEDPROPERTY used to obtain the
			// org association for the employee.
<span class="nc" id="L136">			Employee empOut = cache.getEmployeeForCurrTimeByID(itemOut.getEmployeeID(),</span>
					Employee.DETAIL_LEVEL_EMPLOYEE_BASIC );

			// shift being swapped in
			// shift timeoff being swapped in
<span class="nc" id="L141">			int itemInIndex = (index  + ssItems.size() - 1) % ssItems.size();</span>
<span class="nc" id="L142">			ShiftSwapItem itemIn = ssItems.get(itemInIndex);</span>

<span class="nc bnc" id="L144" title="All 4 branches missed.">			if (itemIn.isSwapTypeShift() &amp;&amp; this.isDifferentWeek) {</span>
				// also do reverse test for other item: call only if
				// different weeks
<span class="nc" id="L147">				Employee empIn = cache.getEmployeeForCurrTimeByID(itemIn.getEmployeeID(),</span>
						Employee.DETAIL_LEVEL_EMPLOYEE_BASIC);
<span class="nc" id="L149">				result = checkRuleForReceivingWeekForPartialShift(saArray, validatable, empOut, empIn, itemIn,</span>
						itemOut);
			}

<span class="nc" id="L153">			index++;</span>
<span class="nc" id="L154">		}</span>

<span class="nc bnc" id="L156" title="All 2 branches missed.">		if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L157">			LOGGER.debug(RmUtil.dumpExitMethod(methodName));</span>
		}

<span class="nc" id="L160">		return result;</span>
	}

	/**
	 * @param validatable
	 * @return
	 * @throws Exception
	 * @throws BbmEJBCreateException
	 */
	protected ShiftAssignment[] getShiftsAfterSwap(Validatable validatable) throws Exception, BbmEJBCreateException {
<span class="nc" id="L170">		return ShiftSwapRequestUtil.getShiftsAfterSwap((ShiftSwapRequest) validatable, ((ShiftSwapRequest) validatable).isTentative());</span>
	}

	protected ValidationResult checkForPubShiftIfNotFoundCreateValidationAlert(Validatable validatable,
			ValidationResult result, ID idEmp, Date itemStartDate, Date itemEndDate, ShiftAssignment shiftAssn,
			ScheduleAccessManager sam)
			throws Exception {
<span class="nc bnc" id="L177" title="All 2 branches missed.">		if (shiftAssn == null){</span>
<span class="nc" id="L178">  	        result = ValidationUtil.setAndLogHardValidationResult(validatable, &quot;SS_CANNOT_FIND_PUB_SHIFT&quot;, &quot;SS_CANNOT_FIND_PUB_SHIFT&quot;,</span>
<span class="nc" id="L179">  	        		new Serializable[] { itemStartDate, itemEndDate, this.cache.getEmployeeNameByID(idEmp) }, CLASS_NAME);</span>
  	    }
<span class="nc" id="L181">		return result;</span>
	}

	protected ShiftAssignment getShiftAssignForShiftSwapItem(ShiftSwapItem itemIn, ScheduleAccessManager sam)
			throws Exception {
		ShiftAssignment shiftAssnIn;
<span class="nc" id="L187">		shiftAssnIn = cache.getShiftAssignForShiftSwapItem(itemIn, true, sam);</span>
<span class="nc" id="L188">		return shiftAssnIn;</span>
	}

	/**
	 * Will be overidden by child classes
	 *
	 * @param startDate
	 * @param org
	 * @return
	 */
	public Date extendStartDays(Date startDate, Organization org) {
<span class="nc" id="L199">		return TOCalcUtil.getDateForOrgWeekStart(org, startDate);</span>
	}

	/**
	 * Will be overidden by child classes
	 *
	 * @param endDate
	 * @param org
	 * @return
	 */
	public Date extendEndDays(Date endDate, Organization org) {
<span class="nc" id="L210">		return TOCalcUtil.getDateForOrgWeekEnd(org, endDate);</span>
	}

	/**
	 * This is where you check the rule given the week's assigments after swap
	 * for the empoyee.
	 *
	 * @param empID
	 * @param orgWeekStart
	 * @param orgWeekEnd
	 * @param shiftsDuringOrgWeek
	 * @param org
	 * @param empOut		(out is the giver)
	 * @param validatable
	 * @return
	 * @throws Exception
	 */
	abstract protected ValidationResult checkRuleHours(ID empID, Date orgWeekStart, Date orgWeekEnd,
			Collection&lt;ShiftAssignment&gt; shiftsDuringOrgWeek, Organization org, Employee empOut, Validatable validatable)
			throws Exception;

	/**
	 *
	 * @param saArray
	 * @param validatable
	 * @param pEmpOut		(out is the giver)
	 * @param pEmpIn		(in is the receiver)
	 * @param pItemIn
	 * @param pItemOut
	 * @return
	 * @throws Exception
	 */
	protected ValidationResult checkRuleForReceivingWeekForPartialShift(ShiftAssignment[] saArray,
			Validatable validatable, Employee pEmpOut, Employee pEmpIn, ShiftSwapItem pItemIn, ShiftSwapItem pItemOut)
			throws Exception {
		// get workResource assignments
<span class="nc" id="L246">		Collection wrAssns = ValidationUtil.getWorkResAssnWithTZForWRID(pItemOut.getEmployeeID(),</span>
<span class="nc" id="L247">				pItemOut.getStartDate(), pItemOut.getEndDate());</span>
		// if no workResource assignments were found
<span class="nc bnc" id="L249" title="All 2 branches missed.">		if (wrAssns.isEmpty()) {</span>
			// set soft validation result
<span class="nc" id="L251">			ValidationResult valResult = ValidationUtil.setSoftValidationResult(validatable,</span>
<span class="nc" id="L252">					RmEjbBundleKey.EMP_NOT_AFFLIATED_WITH_ANYORG, pItemOut.getEmployeeID(), pItemOut.getStartDate(),</span>
<span class="nc" id="L253">					pItemOut.getEndDate(), CLASS_NAME);</span>

			// return.
<span class="nc" id="L256">			return valResult;</span>
		}
		// check for validation errors
<span class="nc" id="L259">		ValidationResult result = null;</span>

<span class="nc" id="L261">		WorkResourceAssignment workResAssn = (WorkResourceAssignment) wrAssns.iterator().next();</span>
<span class="nc" id="L262">		ID empOrgID = workResAssn.getOrganizationID();</span>
<span class="nc" id="L263">		Organization orgForEmpOut = ValidationUtil.getOrganizationByID(empOrgID);</span>

		//out is the giver, and in is the receiver
<span class="nc" id="L266">		result = checkRuleForReceivingWeekForItem(saArray, validatable, pEmpOut, pItemIn, pItemOut, orgForEmpOut);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">		if (result != null) {</span>
<span class="nc" id="L268">			return result;</span>
		}

		// get workResource assignments
<span class="nc" id="L272">		wrAssns = ValidationUtil.getWorkResAssnWithTZForWRID(pItemIn.getEmployeeID(), pItemIn.getStartDate(),</span>
<span class="nc" id="L273">				pItemIn.getEndDate());</span>
		// if no workResource assignments were found
<span class="nc bnc" id="L275" title="All 2 branches missed.">		if (wrAssns.isEmpty()) {</span>
			// set soft validation result
<span class="nc" id="L277">			ValidationResult valResult = ValidationUtil.setSoftValidationResult(validatable,</span>
<span class="nc" id="L278">					RmEjbBundleKey.EMP_NOT_AFFLIATED_WITH_ANYORG, pItemIn.getEmployeeID(), pItemIn.getStartDate(),</span>
<span class="nc" id="L279">					pItemIn.getEndDate(), CLASS_NAME);</span>

			// return.
<span class="nc" id="L282">			return valResult;</span>
		}
<span class="nc" id="L284">		workResAssn = (WorkResourceAssignment) wrAssns.iterator().next();</span>
<span class="nc" id="L285">		empOrgID = workResAssn.getOrganizationID();</span>
<span class="nc" id="L286">		Organization orgForEmpIn = ValidationUtil.getOrganizationByID(empOrgID);</span>
<span class="nc" id="L287">		result = checkRuleForReceivingWeekForItem(saArray, validatable, pEmpIn, pItemOut, pItemIn, orgForEmpIn);</span>

<span class="nc" id="L289">		return result;</span>
	}

	/**
	 *
	 * @param saArray
	 * @param validatable
	 * @param pEmpOut		(out is the give, in is the receiver)
	 * @param pItemIn
	 * @param pItemOut
	 * @param orgForEmpOut
	 * @return
	 * @throws Exception
	 */
	protected ValidationResult checkRuleForReceivingWeekForItem(ShiftAssignment[] saArray, Validatable validatable,
			Employee pEmpOut, ShiftSwapItem pItemIn, ShiftSwapItem pItemOut, Organization orgForEmpOut)
			throws Exception {
<span class="nc" id="L306">		ValidationResult result = null;</span>
		// get schedule information for employee for the entire org week during
		// which the shift being received falls.
<span class="nc" id="L309">		ID idEmpOut = pEmpOut.getID();</span>
<span class="nc" id="L310">		Date orgWeekStartForItemInStart = extendStartDays(pItemIn.getStartDate(), orgForEmpOut);</span>
<span class="nc" id="L311">		Date orgWeekEndForItemInStart = extendEndDays(pItemIn.getEndDate(), orgForEmpOut);</span>
<span class="nc" id="L312">		Collection&lt;ShiftAssignment&gt; shiftAssnsDuringOrgWeekForItemIn = ValidationUtil.getPublishedEventsForWorkResourceByType(</span>
				Event.EVENT_TYPE_SHIFT_ASSIGNMENT, idEmpOut, orgWeekStartForItemInStart, orgWeekEndForItemInStart);

		// find shift assignment for item to be received &amp;&amp; add it to the
		// collection.
<span class="nc" id="L317">		ScheduleAccessManager sam = WfmManagerFactory.getScheduleAccessManager();</span>
<span class="nc" id="L318">		ShiftAssignment shiftAssnForItemIn = cache.getShiftAssignForShiftSwapItem(pItemIn, true, sam);</span>
<span class="nc bnc" id="L319" title="All 4 branches missed.">		if (pItemIn.isSwapTypeShift() &amp;&amp; shiftAssnForItemIn == null) {</span>
			// SS_CANNOT_FIND_PUB_SHIFT,
			// &quot;Unable to find the published shift between {0} and {1} for employee {2} for the specified shift swap item&quot;},
<span class="nc" id="L322">			result = ValidationUtil.setAndLogHardValidationResult(</span>
					validatable,
					RmEjbBundleKey.SS_CANNOT_FIND_PUB_SHIFT,
					RmEjbLogBundleKey.SS_CANNOT_FIND_PUB_SHIFT,
<span class="nc" id="L326">					new Serializable[] { pItemIn.getStartDate(), pItemIn.getEndDate(),</span>
<span class="nc" id="L327">							cache.getEmployeeNameByID(pItemOut.getEmployeeID()) }, CLASS_NAME);</span>

<span class="nc" id="L329">			return result;</span>
		}

		// get the shift after the swap from the array: get org day start and
		// end for item
<span class="nc" id="L334">		Date dayStart = TOCalcUtil.getDateForOrgDayStart(orgForEmpOut, pItemIn.getStartDate());</span>
<span class="nc" id="L335">		Date dayEnd = TOCalcUtil.getDateForOrgDayEnd(orgForEmpOut, pItemIn.getStartDate());</span>

		//replace shift by the receiver's shift
<span class="nc" id="L338">		fixSAColl(idEmpOut, dayStart, dayEnd, shiftAssnsDuringOrgWeekForItemIn, saArray);</span>

<span class="nc" id="L340">		Date itemOutDayStart = TOCalcUtil.getDateForOrgDayStart(orgForEmpOut, pItemOut.getStartDate());</span>
<span class="nc" id="L341">		Date itemOutDayEnd = TOCalcUtil.getDateForOrgDayEnd(orgForEmpOut, pItemOut.getStartDate());</span>

<span class="nc" id="L343">		Date orgWeekStartForItemOutStart = extendStartDays(pItemOut.getStartDate(), orgForEmpOut);</span>

<span class="nc bnc" id="L345" title="All 4 branches missed.">		if (!dayStart.equals(itemOutDayStart) &amp;&amp; isSameWeek(orgWeekStartForItemInStart, orgWeekStartForItemOutStart)) {</span>
			//replace shift by the giver's shift
			// also replace shift being swapped out with new reduced one
<span class="nc" id="L348">			fixSAColl(idEmpOut, itemOutDayStart, itemOutDayEnd, shiftAssnsDuringOrgWeekForItemIn, saArray);</span>
		}

<span class="nc" id="L351">		result = checkRuleHours(idEmpOut, orgWeekStartForItemInStart, orgWeekEndForItemInStart,</span>
				shiftAssnsDuringOrgWeekForItemIn, orgForEmpOut, pEmpOut, validatable);

		// set flag if same week
<span class="nc bnc" id="L355" title="All 2 branches missed.">		this.isDifferentWeek = !isSameWeek(orgWeekStartForItemInStart, orgWeekStartForItemOutStart);</span>

<span class="nc" id="L357">		return result;</span>
	}

	protected boolean isSameWeek(Date orgWeekStartForItemInStart, Date orgWeekStartForItemOutStart) {
<span class="nc" id="L361">		return orgWeekStartForItemInStart.equals(orgWeekStartForItemOutStart);</span>
	}

	protected void fixSAColl(ID empId, Date start, Date end, Collection&lt;ShiftAssignment&gt; saColl, ShiftAssignment[] saArray) throws Exception {
		// now iterate thru shift collection, remove current shift,
<span class="nc bnc" id="L366" title="All 2 branches missed.">		for (Iterator it = saColl.iterator(); it.hasNext();) {</span>
<span class="nc" id="L367">			ShiftAssignment sa = (ShiftAssignment) it.next();</span>
<span class="nc bnc" id="L368" title="All 4 branches missed.">			if (!sa.getStartTime().before(start) &amp;&amp; sa.getStartTime().before(end)) {</span>
<span class="nc" id="L369">				it.remove();</span>
<span class="nc" id="L370">				break;</span>
			}
<span class="nc" id="L372">		}</span>
		// add shift resulting from swap
<span class="nc bnc" id="L374" title="All 2 branches missed.">		for (ShiftAssignment sa : new HashSet&lt;ShiftAssignment&gt;(Arrays.asList(saArray))) {</span>
<span class="nc bnc" id="L375" title="All 4 branches missed.">			if (sa != null &amp;&amp; sa.getWorkResourceIDs().iterator().next().equals(empId)</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">					&amp;&amp; isValidShift(sa)</span>
<span class="nc bnc" id="L377" title="All 4 branches missed.">					&amp;&amp; !sa.getStartTime().before(start) &amp;&amp; sa.getStartTime().before(end)) {</span>
<span class="nc" id="L378">				saColl.add(sa);</span>
<span class="nc" id="L379">				break;</span>
			}
<span class="nc" id="L381">		}</span>
<span class="nc" id="L382">	}</span>

	@SuppressWarnings(&quot;unchecked&quot;)
	private boolean isValidShift(ShiftAssignment shift) throws Exception {
<span class="nc bnc" id="L386" title="All 4 branches missed.">		return shift != null &amp;&amp; !this.cache.getAllGaps(shift, Collections.emptyList()).equals(Arrays.asList(</span>
<span class="nc" id="L387">				new TimeRange(shift.getStartTime(), shift.getEndTime())));</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>