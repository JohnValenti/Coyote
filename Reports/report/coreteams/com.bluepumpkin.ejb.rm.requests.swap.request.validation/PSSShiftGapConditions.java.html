<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PSSShiftGapConditions.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.swap.request.validation</a> &gt; <span class="el_source">PSSShiftGapConditions.java</span></div><h1>PSSShiftGapConditions.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.swap.request.validation;

import java.util.Arrays;
import java.util.Collections;
import java.util.HashSet;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftEventAssignment;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.RmManagerFactory;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validatable;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationCache;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validator;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.setup.validation.ejb.ValidationRuleManager;
import com.bluepumpkin.ejb.rm.util.RmUtil;
import com.bluepumpkin.ejb.rm.util.ShiftSwapRequestUtil;

/**
 *
 * &lt;b&gt;Soft Validation: applies only for partial/full shift swap requests&lt;/b&gt;
 * &lt;p&gt;
 *    Validates the gap activity conditions
 *    - gap between RANGE_MIN_DURATION_VALUE and RANGE_MAX_DURATION_VALUE
 *    or
 *    - gap less than MIN_DURATION_VALUE
 * &lt;p&gt;
 *    Checks for both the shifts for a two way swap
 */
<span class="nc" id="L38">public class PSSShiftGapConditions  implements Validator</span>
{
<span class="nc" id="L40">	private static final String m_className = PSSShiftGapConditions.class.getName();</span>
<span class="nc" id="L41">	private static final Category m_cat = Log.initCategory(m_className);</span>

	public static final String RANGE_MIN_DURATION_VALUE = &quot;RANGE_MIN_DURATION_VALUE&quot;;
	public static final String RANGE_MAX_DURATION_VALUE = &quot;RANGE_MAX_DURATION_VALUE&quot;;
	public static final String MIN_GAP_DURATION_VALUE = &quot;MIN_GAP_DURATION_VALUE&quot;;
<span class="nc" id="L46">	public static final ID RULE_ID = new ID(-194036);</span>

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.rm.requests.common.validation.Validator#validate(com.bluepumpkin.ejb.rm.requests.common.validation.Validatable)
	 */
	@Override
	public ValidationResult validate(Validatable validatable) throws Exception
	{
<span class="nc" id="L54">		ValidationResult result = null;</span>

<span class="nc" id="L56">		String methodName = &quot;validate&quot;;</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L58">			m_cat.debug(RmUtil.dumpEnterMethod(methodName, validatable));</span>
		}

<span class="nc" id="L61">		ShiftSwapRequest ssr = (ShiftSwapRequest) validatable;</span>

<span class="nc" id="L63">		ShiftAssignment[] saArray = getShiftsAfterSwap(ssr);</span>

<span class="nc bnc" id="L65" title="All 2 branches missed.">		for (ShiftAssignment newShift : new HashSet&lt;ShiftAssignment&gt;(Arrays.asList(saArray))) {</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">			if (isValidShift(newShift)) {</span>
<span class="nc" id="L67">				ID orgID = (ID) getValidationCache(ssr).getEmpIDToOrgIDMap().get(newShift.getWorkResourceID());</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">				if (getValidationCache(ssr).isValidationRequiredForOrg(orgID, &quot;shift-swap&quot;, m_className)) {</span>
<span class="nc" id="L69">					ValidationResult val = verifyGapCondition(ssr, newShift, orgID);</span>
<span class="nc bnc" id="L70" title="All 4 branches missed.">					if (result == null &amp;&amp; val != null) {</span>
<span class="nc" id="L71">						result = val;</span>
					}
				}
			}
<span class="nc" id="L75">		}</span>

<span class="nc bnc" id="L77" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L78">			m_cat.debug(RmUtil.dumpExitMethod(methodName));</span>
		}
<span class="nc" id="L80">		return result;</span>
	}

	protected ShiftAssignment[] getShiftsAfterSwap(ShiftSwapRequest ssr) throws Exception {
<span class="nc" id="L84">		return ShiftSwapRequestUtil.getShiftsAfterSwap(ssr, ssr.isTentative());</span>
	}

	private boolean isValidShift(ShiftAssignment shift) throws Exception {
<span class="nc bnc" id="L88" title="All 4 branches missed.">		return shift != null &amp;&amp; !ValidationCache.getAllGaps(shift, Collections.emptyList()).equals(Arrays.asList(</span>
<span class="nc" id="L89">				new TimeRange(shift.getStartTime(), shift.getEndTime())));</span>
	}

	protected ShiftSwapValidationCache getValidationCache(ShiftSwapRequest ssr) {
<span class="nc" id="L93">		return (ShiftSwapValidationCache) ssr.getValidationCache();</span>
	}

	private ValidationResult verifyGapCondition(ShiftSwapRequest ssr, ShiftAssignment sa, ID orgID) throws Exception{

<span class="nc" id="L98">		ValidationResult result = null;</span>
<span class="nc" id="L99">		ValidationRuleManager valMan = RmManagerFactory.getInstance().getValidationRuleManager();</span>
<span class="nc" id="L100">		Map&lt;String, Integer&gt; ruleParams = valMan.getValidationRuleParams(orgID, RULE_ID);</span>
<span class="nc" id="L101">		int minDuration = ruleParams.get(RANGE_MIN_DURATION_VALUE).intValue();</span>
<span class="nc" id="L102">		int maxDuration = ruleParams.get(RANGE_MAX_DURATION_VALUE).intValue();</span>
<span class="nc" id="L103">		int minGap = ruleParams.get(MIN_GAP_DURATION_VALUE).intValue();</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">		for (ShiftEventAssignment shiftEventAssn : sa.getChildren()) {</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">			if (shiftEventAssn.getActivityID().equals(Activity.ACTIVITY_SHIFT_OVERTIME_GAP)){</span>
<span class="nc" id="L106">				ValidationResult val = evaluateConditions(minDuration, maxDuration, shiftEventAssn.getDuration(), minGap, ssr, sa);</span>
<span class="nc bnc" id="L107" title="All 4 branches missed.">				if (result == null &amp;&amp; val != null) {</span>
<span class="nc" id="L108">					result = val;</span>
				}
			}
<span class="nc" id="L111">		}</span>


<span class="nc" id="L114">		return result;</span>
	}

	private ValidationResult evaluateConditions(int minDuration, int maxDuration, int gap, int minGap,
			ShiftSwapRequest ssr, ShiftAssignment sa) throws Exception {
<span class="nc" id="L119">		ValidationResult result = null;</span>
<span class="nc" id="L120">		boolean failGapCondition = false;</span>
<span class="nc" id="L121">		boolean failMinCondition = false;</span>

<span class="nc" id="L123">		boolean addGapResult = false;</span>
<span class="nc" id="L124">		boolean addMinResult = false;</span>

<span class="nc bnc" id="L126" title="All 2 branches missed.">		if (gap &gt; 0 ){</span>
<span class="nc bnc" id="L127" title="All 4 branches missed.">			if (minDuration != -1 &amp;&amp; maxDuration != -1){</span>
<span class="nc bnc" id="L128" title="All 4 branches missed.">				if (gap &lt; minDuration || gap &gt; maxDuration){</span>
<span class="nc" id="L129">					failGapCondition = true;</span>
				}
<span class="nc bnc" id="L131" title="All 4 branches missed.">				if (minGap == -1 &amp;&amp; failGapCondition){</span>
<span class="nc" id="L132">					addGapResult = true;</span>
				}
			}
<span class="nc bnc" id="L135" title="All 2 branches missed.">			if (minGap != -1){</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">				if (gap &lt; minGap){</span>
<span class="nc" id="L137">					failMinCondition = true;</span>
<span class="nc bnc" id="L138" title="All 6 branches missed.">					if (minDuration == -1 &amp;&amp; maxDuration == -1 &amp;&amp; failMinCondition){</span>
<span class="nc" id="L139">						addMinResult = true;</span>
					}
				}
			}

<span class="nc bnc" id="L144" title="All 10 branches missed.">			if (minDuration != -1 &amp;&amp; maxDuration != -1 &amp;&amp;</span>
					minGap != -1 &amp;&amp;
					failGapCondition &amp;&amp; failMinCondition){
				//show both results
<span class="nc" id="L148">				addGapResult = true;</span>
<span class="nc" id="L149">				addMinResult = true;</span>
			}
		}
<span class="nc bnc" id="L152" title="All 2 branches missed.">		if (addGapResult)</span>
<span class="nc" id="L153">			result = ValidationUtil.setSoftValidationResult(ssr,</span>
					RmEjbBundleKey.PSS_SHIFT_GAP_RANGE,
<span class="nc" id="L155">					String.valueOf(gap),</span>
<span class="nc" id="L156">					String.valueOf(minDuration),</span>
<span class="nc" id="L157">					String.valueOf(maxDuration),</span>
<span class="nc" id="L158">					getValidationCache(ssr).getEmployeeNameByID(sa.getWorkResourceIDs().iterator().next()),</span>
					m_className);
<span class="nc bnc" id="L160" title="All 2 branches missed.">		if (addMinResult)</span>
<span class="nc" id="L161">			result = ValidationUtil.setSoftValidationResult(ssr,</span>
					RmEjbBundleKey.PSS_SHIFT_GAP_MINIMUM,
<span class="nc" id="L163">					String.valueOf(gap),</span>
<span class="nc" id="L164">					String.valueOf(minGap),</span>
<span class="nc" id="L165">					getValidationCache(ssr).getEmployeeNameByID(sa.getWorkResourceIDs().iterator().next()),</span>
					m_className);
<span class="nc" id="L167">		return result;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>