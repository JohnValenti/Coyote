<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ServiceGoalsMH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.servicegoals</a> &gt; <span class="el_source">ServiceGoalsMH.java</span></div><h1>ServiceGoalsMH.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.servicegoals;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.workload.ejb.WorkloadManager;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workload.model.QueueFieldInfo;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.verint.ejb.bbm.fterequirements.FteRequirementsUtil;
import com.verint.ejb.bbm.servicegoals.ejb.ServiceGoalsManager;
import com.verint.ejb.bbm.servicegoals.model.ASATimeSeriesDataItem;
import com.verint.ejb.bbm.servicegoals.model.MaxDialsTimeSeriesDataItem;
import com.verint.ejb.bbm.servicegoals.model.ServiceLevelPercentTimeSeriesDataItem;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.web.uif.base.ModelHandler;
import com.witness.web.uif.system.RequestContext;

import java.rmi.RemoteException;
import java.util.Collection;
import java.util.Collections;
import java.util.List;

<span class="nc" id="L30">public class ServiceGoalsMH extends ModelHandler {</span>

	public static void saveImmediateMediaModel(RequestContext context, List&lt;ServiceLevelPercentTimeSeriesDataItem&gt; timeSeries, SPQueue 
		spQueue) throws BbmEJBCreateException, BbmUpdateException, RemoteException, MultiUserException, BbmFinderException {
<span class="fc" id="L34">		ServiceGoalsManager serviceGoalsManager = WfmManagerFactory.getServiceGoalsManager(context.isInWhatIfMode());</span>

<span class="fc" id="L36">		saveChildDistributedQueues(context, timeSeries, null, null, spQueue, serviceGoalType.IMMEDIATE);</span>
<span class="fc" id="L37">		serviceGoalsManager.saveServiceLevelPercentTimeSeries(timeSeries, spQueue);</span>

<span class="fc" id="L39">		updateSPQueue(context, spQueue, serviceGoalType.IMMEDIATE);</span>
<span class="fc" id="L40">	}</span>

	public static void saveImmediateMediaModelWithASA(RequestContext context, List&lt;ASATimeSeriesDataItem&gt; timeSeries, SPQueue spQueue) 
		throws BbmEJBCreateException, BbmUpdateException, RemoteException, MultiUserException, BbmFinderException {
<span class="nc" id="L44">		ServiceGoalsManager serviceGoalsManager = WfmManagerFactory.getServiceGoalsManager(context.isInWhatIfMode());</span>

<span class="nc" id="L46">		saveChildDistributedQueues(context, null, timeSeries, null, spQueue, serviceGoalType.IMMEDIATEASA);</span>
<span class="nc" id="L47">		serviceGoalsManager.saveASATimeSeries(timeSeries, spQueue);</span>

<span class="nc" id="L49">		updateSPQueue(context, spQueue, serviceGoalType.IMMEDIATEASA);</span>
<span class="nc" id="L50">	}</span>

	public static void saveOutboundMediaModel(RequestContext context, List&lt;MaxDialsTimeSeriesDataItem&gt; timeSeries, SPQueue spQueue) throws
		BbmEJBCreateException, BbmUpdateException, BbmFinderException, RemoteException, MultiUserException {
<span class="fc" id="L54">		ServiceGoalsManager serviceGoalsManager = WfmManagerFactory.getServiceGoalsManager(context.isInWhatIfMode());</span>

<span class="fc" id="L56">		saveChildDistributedQueues(context, null, null, timeSeries, spQueue, serviceGoalType.OUTBOUND);</span>
<span class="fc" id="L57">		serviceGoalsManager.saveMaxDialsTimeSeries(timeSeries, spQueue);</span>

<span class="fc" id="L59">		updateSPQueue(context, spQueue, serviceGoalType.OUTBOUND);</span>
<span class="fc" id="L60">	}</span>

	/**
	 * Saves the service goals model for a deferred media queue.  Use this method when Service Level is selected as the
	 * service goal type for the queue.
	 */
	public static void saveDeferredMediaModel(RequestContext context, List&lt;ServiceLevelPercentTimeSeriesDataItem&gt; serviceLevelTimeSeries, 
		SPQueue spQueue) throws BbmEJBCreateException, BbmFinderException, BbmUpdateException, RemoteException, MultiUserException {
<span class="nc" id="L68">		ServiceGoalsManager serviceGoalsManager = WfmManagerFactory.getServiceGoalsManager(context.isInWhatIfMode());</span>

<span class="nc" id="L70">		saveChildDistributedQueues(context, serviceLevelTimeSeries, null, null, spQueue, serviceGoalType.DEFERRED);</span>
<span class="nc" id="L71">		serviceGoalsManager.saveServiceLevelPercentTimeSeries(serviceLevelTimeSeries, spQueue);</span>

<span class="nc" id="L73">		updateSPQueue(context, spQueue, serviceGoalType.DEFERRED);</span>
<span class="nc" id="L74">	}</span>

	/**
	 * Saves the service goals model for a deferred media queue.  Use this method when Deadline Goals is selected as the
	 * service goal type for the queue.  This method will save both the deadline goals and deadline time series data for the queue.
	 */
	public static void saveDeferredMediaModel(RequestContext context, List&lt;ServiceLevelPercentTimeSeriesDataItem&gt; deadlineGoalTimeSeries, 
		List&lt;ASATimeSeriesDataItem&gt; deadlineTimeTimeSeries, SPQueue spQueue) throws BbmEJBCreateException, BbmUpdateException, 
		BbmFinderException, RemoteException, MultiUserException {
<span class="nc" id="L83">		ServiceGoalsManager serviceGoalsManager = WfmManagerFactory.getServiceGoalsManager(context.isInWhatIfMode());</span>

<span class="nc" id="L85">		saveChildDistributedQueues(context, deadlineGoalTimeSeries, deadlineTimeTimeSeries, null, spQueue, serviceGoalType.DEFERREDASA);</span>
<span class="nc" id="L86">		serviceGoalsManager.saveDeadlineGoalsTimeSeries(deadlineGoalTimeSeries, deadlineTimeTimeSeries, spQueue);</span>

<span class="nc" id="L88">		updateSPQueue(context, spQueue, serviceGoalType.DEFERREDASA);</span>
<span class="nc" id="L89">	}</span>

	private static void updateSPQueue(RequestContext context, SPQueue spQueue, serviceGoalType sgType) throws BbmEJBCreateException, 
		BbmUpdateException, MultiUserException, RemoteException {
<span class="fc" id="L93">		CampaignManager campaignManager = WfmManagerFactory.getCampaignManager(context.isInWhatIfMode());</span>
<span class="fc" id="L94">		campaignManager.updateSPQueue(spQueue);</span>
<span class="fc" id="L95">		FteRequirementsUtil.recalculateFteRequirementsForSPQueues(Collections.singleton(spQueue.getID()), context.isInWhatIfMode());</span>
<span class="fc" id="L96">	}</span>

	private static void saveChildDistributedQueues(RequestContext context, List&lt;ServiceLevelPercentTimeSeriesDataItem&gt; slGoalTimeSeries, 
		List&lt;ASATimeSeriesDataItem&gt; deadlineTimeTimeSeries, List&lt;MaxDialsTimeSeriesDataItem&gt; maxDialsTimeSeries, SPQueue spQueue, 
		serviceGoalType sgType) throws BbmFinderException, RemoteException, BbmEJBCreateException, BbmUpdateException, MultiUserException {

		/* Steps to save the data to the Child Queues:
		 *
		 * 1. Fetch all the Child SP's to the given SP getSubSPIDsFromParentSPID
		 * 2. If there are Child SP's present it means its a distributed campaign
		 * 3. Iterate through the list of SP's fetch the Combined SP Queue getCombinedSPQueue
		 * 4. Repeat the same steps given below for the children too
		 *
		 * If the Campaign is skill based then the data needs to be stored for each individual queue rather then the combined queue
		 * 1. Fetch the Child SP's and Queues corresponding to the Child SP
		 * 2. Update only those Queues which are direct children of the Parent Distributed Queue being updated
		 * 3. There is a two point check
		 * 		a. Check whether the child queue being updated is child of the Parent Distributed Queue selected
		 * 		b. Update the data for the Individual SP Queue rather then to the Combined SP Queue
		 */

<span class="fc" id="L117">		ServiceGoalsManager serviceGoalsManager = WfmManagerFactory.getServiceGoalsManager(context.isInWhatIfMode());</span>
<span class="fc" id="L118">		CampaignManager campaignManager = WfmManagerFactory.getCampaignManager(context.isInWhatIfMode());</span>

<span class="fc" id="L120">		ID campaignID = campaignManager.getSchedulingPeriodByID(spQueue.getSpID()).getCampaignID();</span>
<span class="fc" id="L121">		Campaign campaignObj = campaignManager.getCampaignByID(campaignID);</span>
<span class="fc" id="L122">		Collection&lt;ID&gt; childSpIds = campaignManager.getSubSPIDsFromParentSPID(spQueue.getSpID());</span>

<span class="pc bpc" id="L124" title="2 of 4 branches missed.">		if (campaignObj != null &amp;&amp; campaignObj.getIsDistributed()) {</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">			for (ID spId : childSpIds) {</span>
<span class="nc" id="L126">				SchedulingPeriod childSp = campaignManager.getSchedulingPeriodByID(spId);</span>
<span class="nc" id="L127">				Collection&lt;SPQueue&gt; spQueues = campaignManager.getSPQueuesBySPID(childSp.getID());</span>

<span class="nc bnc" id="L129" title="All 2 branches missed.">				for (SPQueue childSpQueue : spQueues) {</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">					if (childSp.getSkillBased()) {</span>
<span class="nc" id="L131">						WorkloadManager workLoadManager = WfmManagerFactory.getWorkloadManager(context.isInWhatIfMode());</span>
<span class="nc" id="L132">						ID distributedQueueID = DAOUtil.mapIDToDEID(spQueue.getQueueID(), new QueueFieldInfo());</span>

<span class="nc" id="L134">						copySPQueueValuesToChild(spQueue, childSpQueue);</span>
<span class="nc" id="L135">						Queue childQueue = workLoadManager.getQueueByID(childSpQueue.getQueueID());</span>

<span class="nc bnc" id="L137" title="All 4 branches missed.">						if (childQueue.getParentQueueID() != null &amp;&amp; childQueue.getParentQueueID().equals(distributedQueueID.toString())) {</span>
<span class="nc" id="L138">							saveTimeSeries(deadlineTimeTimeSeries, slGoalTimeSeries, maxDialsTimeSeries, sgType, serviceGoalsManager, </span>
								childSpQueue);
<span class="nc" id="L140">							updateSPQueue(context, childSpQueue, sgType);</span>
						}
<span class="nc" id="L142">					} else {</span>
<span class="nc" id="L143">						SPQueue combinedSPQueue = campaignManager.getCombinedSPQueue(childSpQueue.getSpID(), childSpQueue.getMediaID());</span>
<span class="nc" id="L144">						copySPQueueValuesToChild(spQueue, combinedSPQueue);</span>

<span class="nc" id="L146">						saveTimeSeries(deadlineTimeTimeSeries, slGoalTimeSeries, maxDialsTimeSeries, sgType, serviceGoalsManager, </span>
							combinedSPQueue);
<span class="nc" id="L148">						updateSPQueue(context, combinedSPQueue, sgType);</span>
					}
<span class="nc" id="L150">				}</span>
<span class="nc" id="L151">			}</span>
		}
<span class="fc" id="L153">	}</span>

	private static void copySPQueueValuesToChild(SPQueue spQueue, SPQueue childSpQueue) {
<span class="nc" id="L156">		childSpQueue.setServiceLevelGoalType(spQueue.getServiceLevelGoalType());</span>
<span class="nc" id="L157">		childSpQueue.setSlAnswerWaitingTime(spQueue.getSlAnswerWaitingTime());</span>
<span class="nc" id="L158">		childSpQueue.setQualityGoalRequirement(spQueue.getQualityGoalRequirement());</span>
<span class="nc" id="L159">		childSpQueue.setMinimumQualityScore(spQueue.getMinimumQualityScore());</span>
<span class="nc" id="L160">		childSpQueue.setQueuePriorityGroup(spQueue.getQueuePriorityGroup());</span>
<span class="nc" id="L161">		childSpQueue.setPatience(spQueue.getPatience());</span>
<span class="nc" id="L162">		childSpQueue.setOverloadThreshold1(spQueue.getOverloadThreshold1());</span>
<span class="nc" id="L163">		childSpQueue.setOverloadThreshold2(spQueue.getOverloadThreshold2());</span>
<span class="nc" id="L164">		childSpQueue.setQPGThreshold(spQueue.getQPGThreshold());</span>
<span class="nc" id="L165">		childSpQueue.setMaxAbandonsPercent(spQueue.getMaxAbandonsPercent());</span>
<span class="nc" id="L166">		childSpQueue.setActualOrWorkingHour(spQueue.getActualOrWorkingHour());</span>
<span class="nc" id="L167">	}</span>


	protected static void saveTimeSeries(List&lt;ASATimeSeriesDataItem&gt; deadlineTimeTimeSeries, List&lt;ServiceLevelPercentTimeSeriesDataItem&gt; 
		slGoalTimeSeries, List&lt;MaxDialsTimeSeriesDataItem&gt; maxDialsTimeSeries, serviceGoalType sgType, ServiceGoalsManager 
		serviceGoalsManager, SPQueue childSpQueue) throws BbmUpdateException, RemoteException {
<span class="nc bnc" id="L173" title="All 5 branches missed.">		switch (sgType) {</span>
			case IMMEDIATE:
			case DEFERRED:
<span class="nc" id="L176">				serviceGoalsManager.saveServiceLevelPercentTimeSeries(slGoalTimeSeries, childSpQueue);</span>
<span class="nc" id="L177">				break;</span>
			case IMMEDIATEASA:
<span class="nc" id="L179">				serviceGoalsManager.saveASATimeSeries(deadlineTimeTimeSeries, childSpQueue);</span>
<span class="nc" id="L180">				break;</span>
			case DEFERREDASA:
<span class="nc" id="L182">				serviceGoalsManager.saveDeadlineGoalsTimeSeries(slGoalTimeSeries, deadlineTimeTimeSeries, childSpQueue);</span>
<span class="nc" id="L183">				break;</span>
			case OUTBOUND:
<span class="nc" id="L185">				serviceGoalsManager.saveMaxDialsTimeSeries(maxDialsTimeSeries, childSpQueue);</span>
				break;
		}
<span class="nc" id="L188">	}</span>

<span class="pc" id="L190">	protected enum serviceGoalType {IMMEDIATE, IMMEDIATEASA, DEFERRED, DEFERREDASA, OUTBOUND}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>