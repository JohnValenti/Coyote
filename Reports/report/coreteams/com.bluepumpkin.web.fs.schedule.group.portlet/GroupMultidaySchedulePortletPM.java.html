<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GroupMultidaySchedulePortletPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.fs.schedule.group.portlet</a> &gt; <span class="el_source">GroupMultidaySchedulePortletPM.java</span></div><h1>GroupMultidaySchedulePortletPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.fs.schedule.group.portlet;

import java.util.Calendar;
import java.util.Date;
import java.util.TimeZone;

import javax.portlet.PortletPreferences;

import weblogic.wsee.util.StringUtil;

import com.bluepumpkin.common.datatypes.CalendarRange;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.web.core.keys.CoreJavaScriptFileID;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.fs.schedule.ScheduleViewUtil;
import com.bluepumpkin.web.fs.schedule.group.GroupMultidaySchedulePM;
import com.verint.web.core.dashboard.pluto.PlutoPreferencesUtil;
import com.verint.web.core.dashboard.portlets.MultiIFramePortlet;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;

@SuppressWarnings(&quot;serial&quot;)
public class GroupMultidaySchedulePortletPM extends GroupMultidaySchedulePM {
	
	private static final String FN_TEMPLATE_ID = &quot;templateID&quot;;
	private static final String FN_INSTANCE_ID = &quot;instanceID&quot;;
	private static final String FORM_ACTION = &quot;mygroupscheduleportlet&quot;;
	
	private String m_instanceID, m_templateID;
<span class="nc" id="L37">	private boolean m_isConfigured = true;</span>
	private int m_numDays;

	public GroupMultidaySchedulePortletPM(RequestContext context) {
<span class="nc" id="L41">		super(context);</span>

<span class="nc" id="L43">		m_bodyStyle = &quot;margin: 0px; overflow: hidden;&quot;;</span>
<span class="nc" id="L44">		m_workPaneStyle = &quot;margin: 0px;&quot;;</span>
<span class="nc" id="L45">		m_workAreaStyle = &quot;height: expression(document.body.clientHeight-32); &quot;;</span>
<span class="nc" id="L46">		m_workContentStyle = &quot;margin: 0px; border: 0px;&quot;;</span>
		
<span class="nc" id="L48">		addRequiredJavaScriptFile(CoreJavaScriptFileID.PORTLET_POPUP_UTIL);</span>
<span class="nc" id="L49">	}</span>

	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static PageModel getInstance(RequestContext context) throws Exception {
<span class="nc" id="L55">		return getInstance(context, GroupMultidaySchedulePortletPM.class);</span>
	}

	public String getHtmlDisplay() {
<span class="nc" id="L59">		StringBuffer html = new StringBuffer();</span>
		
<span class="nc bnc" id="L61" title="All 2 branches missed.">		if (this.getPageMessageList().size() &gt; 0)  html.append(this.displayAllMessages(m_context));</span>

<span class="nc" id="L63">		html.append(HtmlUtil.makeHiddenInput(FN_TEMPLATE_ID, m_templateID));</span>
<span class="nc" id="L64">		html.append(HtmlUtil.makeHiddenInput(FN_INSTANCE_ID, m_instanceID));</span>
		
<span class="nc bnc" id="L66" title="All 2 branches missed.">		if (m_isConfigured) {</span>
<span class="nc" id="L67">			html.append(super.getHtmlDisplay());</span>
		} else {
<span class="nc" id="L69">			String url = &quot;javascript:&quot; + MultiIFramePortlet.getPortletModeSwitchJavacript(m_templateID, &quot;edit&quot;);</span>
<span class="nc" id="L70">			html.append(&quot;&lt;div style='width: 100%; height: 100%; padding: 0px; margin: 0px;'&gt;&quot;);</span>
<span class="nc" id="L71">			html.append(&quot;&lt;div class='portlet-msg-alert'&gt;&quot;);</span>
<span class="nc" id="L72">			html.append(m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, </span>
					CoreWebBundleKey.PORTLET_MUST_BE_EDITED, new Object[] {url}));
<span class="nc" id="L74">			html.append(&quot;&lt;/div&gt;&lt;/div&gt;&quot;);</span>
		}
<span class="nc" id="L76">		return html.toString();</span>
	}

<span class="nc" id="L79">	private boolean initialized = false;</span>
	public void initializeModel() {
<span class="nc bnc" id="L81" title="All 2 branches missed.">		if ( ! initialized ) {</span>
<span class="nc" id="L82">			initialized = true;</span>
			try {
<span class="nc" id="L84">				PortletPreferences prefs = PlutoPreferencesUtil.getPortletPreferences(m_context, m_templateID, m_instanceID);</span>
				
<span class="nc" id="L86">				String orgIDStr = prefs.getValue(GroupMultidaySchedulePortletRH.EDIT_PARAM_ORG_ID, null);</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">				if (StringUtil.isEmpty(orgIDStr) == false) {</span>
<span class="nc" id="L88">					m_groupSelectorPC.setOrgID(new ID(orgIDStr));</span>
				}
				
<span class="nc" id="L91">				String campaignIDStr = prefs.getValue(GroupMultidaySchedulePortletRH.EDIT_PARAM_CAMPAIGN_ID, null);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">				if (StringUtil.isEmpty(campaignIDStr) == false) {</span>
<span class="nc" id="L93">					m_groupSelectorPC.setCampaignID(new ID(campaignIDStr));</span>
				}
				
<span class="nc bnc" id="L96" title="All 4 branches missed.">				if (StringUtil.isEmpty(orgIDStr) &amp;&amp; StringUtil.isEmpty(campaignIDStr)) {</span>
					//We'll set either the org the dashboard was defined at (if employee has privileges),
					//or the employee's current org as a reasonable default if the edit mode has not been configured yet.
<span class="nc" id="L99">					Organization userOrg = PlutoPreferencesUtil.getUsersDefaultOrganizationForDashboard(m_context, m_instanceID,</span>
							PrivilegeKeys.FS_VIEWORGSCHEDULES_ID);
<span class="nc bnc" id="L101" title="All 2 branches missed.">					if (userOrg != null) {</span>
<span class="nc" id="L102">						m_groupSelectorPC.setOrgID(userOrg.getID());</span>
					} else {
<span class="nc" id="L104">						throw new Exception(&quot;Error retrieving organization for current employee.&quot;);</span>
					}					
				}

<span class="nc" id="L108">				String sortByStr = prefs.getValue(GroupMultidaySchedulePortletRH.EDIT_PARAM_SORT_BY, null);</span>
<span class="nc bnc" id="L109" title="All 4 branches missed.">				if (sortByStr != null &amp;&amp; sortByStr.length() &gt; 0) {</span>
<span class="nc" id="L110">					setSortBy(sortByStr);</span>
				} else {
					//We'll set sort by last name as a reasonable default if the edit mode has not been configured yet.
<span class="nc" id="L113">					setSortBy(GroupMultidaySchedulePortletEditPM.SORT_BY_LNAME);</span>
				}
<span class="nc" id="L115">				super.initializeModel();</span>
<span class="nc" id="L116">			} catch (Exception ex) {</span>
<span class="nc" id="L117">				m_isConfigured = false;</span>
<span class="nc" id="L118">				handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L119">			}</span>
		}
<span class="nc" id="L121">	}</span>
	
	/**
	 * Initialize start and end dates
	 */
	protected void initDateRange() {
		try {
<span class="nc" id="L128">			PortletPreferences prefs = PlutoPreferencesUtil.getPortletPreferences(m_context, m_templateID, m_instanceID);</span>
<span class="nc" id="L129">			String numDaysStr = prefs.getValue(GroupMultidaySchedulePortletRH.EDIT_PARAM_NUM_DAYS, null);</span>
<span class="nc bnc" id="L130" title="All 4 branches missed.">			if (numDaysStr != null &amp;&amp; numDaysStr.length() &gt; 0) {</span>
<span class="nc" id="L131">				m_numDays = Integer.parseInt(numDaysStr);</span>
			} else {
				//We'll set 7 days as a reasonable default if the edit mode has not been configured yet.
<span class="nc" id="L134">				m_numDays = GroupMultidaySchedulePortletEditPM.DEFAULT_NUM_OF_DAYS;</span>
			}
			
			//Set the start date to be midnight of the current day at the user's time zone
<span class="nc" id="L138">			LocalDate startLocalDate = new LocalDate(new Date(), m_context.getViewingTimeZone());</span>
<span class="nc" id="L139">			Calendar startCal = Calendar.getInstance(m_context.getViewingTimeZone());</span>
<span class="nc" id="L140">			startCal.setTime(startLocalDate.getTime(TimeZoneUtil.DEFAULT_TIMEZONE));</span>
<span class="nc" id="L141">			startCal.set(Calendar.HOUR, 0);</span>
<span class="nc" id="L142">			startCal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L143">			startCal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L144">			startCal.set(Calendar.MILLISECOND, 0);</span>
			
<span class="nc" id="L146">			m_timeRange = new TimeRange(startCal.getTime(), (m_numDays) * ScheduleViewUtil.DAY_IN_MSEC - 1);</span>
<span class="nc" id="L147">		} catch (Exception ex) {</span>
<span class="nc" id="L148">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L149">			m_isConfigured = false;</span>
<span class="nc" id="L150">		}		</span>
<span class="nc" id="L151">	}//initDateRange</span>
	
	public String getFormAction() {
<span class="nc" id="L154">		return FORM_ACTION;</span>
	}

	/**
	 * Creates a text label containing a localized date (e.g. Thu 08/22) for the
	 * given CalendarRange and TimeZone.  Unlike the method in the superclass,
	 * this method does not return a hyperlink.
	 */
	protected String getDateLabelForRowHeader(CalendarRange day, TimeZone tz) {
<span class="nc" id="L163">		String label = m_localizer.formatDate(day.getStartCalendar().getTime(),</span>
				tz,RegionalFormatBundleKey.DATE_NOYEAR_DAYINWEEKFULL_FORMAT); 
<span class="nc" id="L165">		return label;</span>
	}
	
	/////////////
	///Getters and Setters
	/////////////
<span class="nc" id="L171">	public String getInstanceID() { return m_instanceID; }</span>
<span class="nc" id="L172">	public void setInstanceID(String instanceID) { m_instanceID = instanceID; }</span>

<span class="nc" id="L174">	public String getTemplateID() { return m_templateID; }</span>
<span class="nc" id="L175">	public void setTemplateID(String templateID) { m_templateID = templateID; }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>