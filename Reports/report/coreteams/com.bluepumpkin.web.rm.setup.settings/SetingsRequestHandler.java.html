<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SetingsRequestHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.setup.settings</a> &gt; <span class="el_source">SetingsRequestHandler.java</span></div><h1>SetingsRequestHandler.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.setup.settings;

import java.text.ParseException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.rm.base.RmRuntimeException;
import com.bluepumpkin.ejb.rm.l10n.RmSettingKey;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.ejb.rm.util.RmUtil;
import com.bluepumpkin.web.bbm.organization.OrganizationRequestHandler;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.l10n.RmWebLogBundleKey;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.reflection.ParameterUtil;

/**
 * Title          SetingsRequestHandler
 * Description	  Handle request for the Settings page
 * Copyright      Copyright (c) 2002
 * Company        Blue Pumpkin Software, Inc
 * @author        Shubhangi Chavan
 * @version       1.0
 */
<span class="nc" id="L42">public class SetingsRequestHandler extends OrganizationRequestHandler {</span>
<span class="fc" id="L43">	private static final Category log = Log.initCategory(SetingsRequestHandler.class.getName());</span>

	private static final int TYPE_STRING = 0;
	private static final int TYPE_BOOLEAN = 1;
	private static final int TYPE_REAL = 2;
	private static final int TYPE_INTEGER = 3;
	private static final String GET_METHOD= &quot;GET&quot;;
	private static final String PAGE_ACTION_STR= &quot;pageAction&quot;;
	private static final String APPSCAN_ERROR_LOG = &quot;CSRF security constraint violated. Cannot GET with a pageAction parameter&quot;;
	/**
	 * Process Request for the User page
	 * @param   context   RequestContext
	 * @throws Exception
	 */
	@Override
	public void processRequest(RequestContext context) throws Exception {
		// Process requested action
		// Also invoked when user clicks on manager and agent activation/deactivation button
<span class="nc bnc" id="L61" title="All 2 branches missed.">		if (isAction(context, PageAction.SAVE)) {</span>
<span class="nc" id="L62">			processSave(context, true);</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">		} else if (isAction(context, PageAction.SAVE_AS)) {</span>
<span class="nc" id="L64">			processSave(context, false);</span>
		} else {
			//Fix Appscan issue &quot;Body Parameter Accepted in Query&quot;
<span class="nc" id="L67">			String method = context.getRequest().getMethod();</span>
<span class="nc" id="L68">			String queryString = context.getRequest().getQueryString();</span>
<span class="nc bnc" id="L69" title="All 6 branches missed.">			boolean inValid = GET_METHOD.equals(method) &amp;&amp; !StringUtil.isEmpty(queryString) &amp;&amp; queryString.indexOf(PAGE_ACTION_STR) &gt; -1;</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">			if (inValid) {</span>
<span class="nc" id="L71">				log.error(APPSCAN_ERROR_LOG);</span>
<span class="nc" id="L72">				throw new Exception(APPSCAN_ERROR_LOG);</span>
			}
		}
<span class="nc" id="L75">	}</span>

	private void validateIDParameter(HttpServletRequest httpServletRequest, String parameter) {
		// selectedID
<span class="nc" id="L79">		ParameterUtil.assertOptionalCommaSeparatedLongValues(httpServletRequest, parameter);</span>
<span class="nc" id="L80">	}</span>
	/**
	 * Processes the Save action
	 * Fetch the data submitted by the user and pass it to the backend as a Key,
	 * value pair in the backend.
	 *
	 * @param context RequestContext        The Request context object
     * @param shallow - true if you want to update only this org, false to update children too.
	 */

	private void processSave(RequestContext context, boolean shallow) throws Exception {
<span class="nc bnc" id="L91" title="All 2 branches missed.">		if (!isAuthorizedForOrg(context,</span>
				new String[] {
					PrivilegeKeys.TOM_ACTIVATETIMEOFFWORKFLOW,
					PrivilegeKeys.TOM_SETYEARFOREMPLOYEE,
					PrivilegeKeys.TOM_CONFIGURECALENDARCOLORS,
					PrivilegeKeys.TOM_CONFIGURETIMEOFFOPTIONS,
					PrivilegeKeys.TOM_SETPOLICIES,
					PrivilegeKeys.SS_SETTINGS,
					PrivilegeKeys.SS_SETPOLICIES,
					PrivilegeKeys.SB_SETTINGS,
					PrivilegeKeys.SB_SETPOLICIES,
					PrivilegeKeys.CS_SETTINGS,
					PrivilegeKeys.CS_SETPOLICIES,
					PrivilegeKeys.FT_SETTINGS,
					PrivilegeKeys.FT_SETPOLICIES,
				},
				true)) {
<span class="nc" id="L108">			return;</span>
		}

<span class="nc" id="L111">		SettingsPageModel model = new SettingsPageModel(context);</span>
<span class="nc" id="L112">		model.extractParameters(context.getRequest());</span>
<span class="nc" id="L113">		HttpServletRequest request = context.getRequest();</span>
<span class="nc" id="L114">		validateIDParameter(context.getRequest(), &quot;selectedID&quot;);</span>
<span class="nc" id="L115">		validateIDParameter(context.getRequest(), &quot;performActionOnID&quot;);</span>
<span class="nc" id="L116">		validateColorParameter(request);</span>
<span class="nc" id="L117">        ID orgID = model.getSelectedIDObject();</span>

<span class="nc bnc" id="L119" title="All 4 branches missed.">		if (model.validate() &amp;&amp; orgID != null) {</span>
<span class="nc" id="L120">			Localizer localizer = context.getLocalizer();</span>

			try {
<span class="nc" id="L123">				OrganizationSetting orgSetting = model.getConfiguration();</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">				if (orgSetting == null) {</span>
<span class="nc" id="L125">					orgSetting = new OrganizationSetting(new HashMap());</span>
				}
<span class="nc" id="L127">				Map&lt;String, Object&gt; map = orgSetting.getValues();</span>

				// Pass the HashMap that has the property list extracted from the request.
				// QA 95028: Disabled controls don't send values to back end. Ignore missing values

<span class="nc bnc" id="L132" title="All 2 branches missed.">				if (model.isAuthorizedToConfigureRequiredPayPeriodHours()) {</span>

<span class="nc" id="L134">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_REQUIRED_PAY_PERIOD_TRACK, TYPE_BOOLEAN, request, map);</span>

<span class="nc" id="L136">					saveRequiredPayPeriod(context, model, map);</span>

					// Store the date as yyyy-MM-dd
<span class="nc" id="L139">					String nameKey = SettingsPageModel.getNameKey(RmSettingKey.ORG_RM_SETTINGS_REQUIRED_PAY_PERIOD_STARTDATE);</span>
<span class="nc" id="L140">					String param = request.getParameter(nameKey);</span>
<span class="nc" id="L141">					String value = model.getStartDateString(param);</span>
<span class="nc" id="L142">					map.put(RmSettingKey.ORG_RM_SETTINGS_REQUIRED_PAY_PERIOD_STARTDATE, value);</span>

				}

                //Time Off Management Activation
				//This change is applicable to all fields. Right now doing only for boolean fields as part of ESR 4093766
				//QC-117407 ported from QC-115660
<span class="nc bnc" id="L149" title="All 2 branches missed.">				if (model.isAuthorizedToConfigureTOMWorkflow()) {</span>
<span class="nc" id="L150">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_PROCESS_VACATION_REQUEST, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L151">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_REQUEST_VACATION, TYPE_BOOLEAN, request, map);</span>
				}

				//Time Off Request Options
<span class="nc bnc" id="L155" title="All 2 branches missed.">				if (model.isAuthorizedToConfigureTORequestOptions()) {</span>
<span class="nc" id="L156">					saveTimeOffRequestOptions(context, model, map);</span>
				}
<span class="nc bnc" id="L158" title="All 2 branches missed.">				if (LicenseUtil.isAdvancedRMLicense()) {</span>
<span class="nc" id="L159">					putNonNullValueInMap(RmSettingKey.ORG_RM_ALLOW_COPY_TIME_OFF_BID_REQUEST, TYPE_BOOLEAN, request, map);</span>
				}
                //Agent Workflow Options
				//This change is applicable to all fields. Right now doing only for fields as part of ESR 4093766
				//QC-117407 ported from QC-115660
<span class="nc bnc" id="L164" title="All 2 branches missed.">				if (model.isAuthorizedToConfigureTOMWorkflow()) {</span>
<span class="nc" id="L165">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_ESCALATION, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L166">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_SHOW_AUTOPROCESSING_RULES, TYPE_BOOLEAN, request, map);</span>
				}
<span class="nc" id="L168">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_SHOW_SCHEDULED_TIMEOFF, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L169">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_SHOW_PENDING_TIMEOFF, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L170">				String value = &quot;&quot;;</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">				if (null != (value = model.getGroupViewOrgIDs())) {</span>
<span class="nc" id="L172">					map.put(RmSettingKey.ORG_RM_SETTINGS_GROUP_VIEW_ORG_LIST, value);</span>
				}

                //Time Off Accrual
<span class="nc" id="L176">                saveTimeOffAccrual(context, model, map);</span>

				//Flex Time
<span class="nc bnc" id="L179" title="All 2 branches missed.">				if (model.isAuthorizedToConfigureFlexTime()) {</span>
<span class="nc" id="L180">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_MAKEUP_BEFORE_SHIFT, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L181">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_MAKEUP_AFTER_SHIFT, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L182">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_MAKEUP_IN_GAP, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L183">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_LIMIT_FLEX_TIMEOFF_TO_START_SHIFT_BLOCK, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L184">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_CONSEC_FLEX, TYPE_BOOLEAN, request, map);</span>
				}

				//Shift Swap
				//This change is applicable to all fields. Right now doing only for boolean fields as part of ESR 4093766
				//QC-117407 ported from QC-115660
<span class="nc bnc" id="L190" title="All 2 branches missed.">				if (model.isAuthorizedToConfigureShiftSwap()) {</span>
<span class="nc" id="L191">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ENABLE_SHIFT_SWAP, TYPE_BOOLEAN, request, map);</span>
				}
<span class="nc" id="L193">				value = &quot;&quot;;</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">				if (null != (value = model.getShiftSwapOrgIDs())) {</span>
<span class="nc" id="L195">					map.put(RmSettingKey.ORG_RM_SETTINGS_SHIFT_SWAP_ORG_LIST, value);</span>
				}
					//This change is applicable to all fields. Right now doing only for boolean fields as part of ESR 4093766
					//QC-117407 ported from QC-115660
<span class="nc bnc" id="L199" title="All 2 branches missed.">				if (model.isAuthorizedToConfigureShiftSwap()) {</span>
<span class="nc" id="L200">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_DISABLE_ONE_WAY_SHIFT_SWAP, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L201">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_PARTIAL_SHIFT_SWAP, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L202">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_PARTIAL_SHIFT_PICKUP, TYPE_BOOLEAN, request, map);</span>
				}
<span class="nc" id="L204">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_MAX_SWAP_NEGOTIATIONS, TYPE_INTEGER, request, map);</span>

                //Shift Bidding
<span class="nc" id="L207">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_MAX_PREFERENCE_VALUE, TYPE_INTEGER, request, map);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">				if (LicenseUtil.isAdvancedRMLicense()) {</span>
<span class="nc" id="L209">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ENFORCE_UNIQUE_PREFERENCE, TYPE_BOOLEAN, request, map);</span>
				}
<span class="nc" id="L211">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_MAX_BIDS_PER_EMPLOYEE, TYPE_INTEGER, request, map);</span>
<span class="nc" id="L212">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_SENIORITY_FACTOR, TYPE_REAL, localizer, request, map);</span>
<span class="nc" id="L213">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_RANK_FACTOR, TYPE_REAL, localizer, request, map);</span>
<span class="nc" id="L214">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_BONUSPOINT_FACTOR, TYPE_REAL, localizer, request, map);</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">				if (LicenseUtil.isAdvancedRMLicense()) {</span>
<span class="nc" id="L216">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_FILTER_BID_OPTIONS_BY_EMPLOYEE_TYPE, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L217">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_DISPLAY_TEMPLATE_DESCRIPTION, TYPE_BOOLEAN, request, map);</span>
				}

				//Time Off Calendar Colors
<span class="nc" id="L221">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TO_AVAILABLE_COLOR, TYPE_STRING, request, map);</span>
<span class="nc" id="L222">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TO_WORKING_COLOR, TYPE_STRING, request, map);</span>
<span class="nc" id="L223">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TO_PENDING_COLOR, TYPE_STRING, request, map);</span>
<span class="nc" id="L224">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TO_SCHEDULED_COLOR, TYPE_STRING, request, map);</span>
<span class="nc" id="L225">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TO_NO_AVAILABLE_COLOR, TYPE_STRING, request, map);</span>
<span class="nc" id="L226">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TO_NON_OPERATION_COLOR, TYPE_STRING, request, map);</span>
<span class="nc" id="L227">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TO_BLACKOUT_COLOR, TYPE_STRING, request, map);</span>
<span class="nc" id="L228">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TO_NON_WORKING_COLOR, TYPE_STRING, request, map);</span>

				//Policies
<span class="nc" id="L231">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_TO_POLICY, TYPE_STRING, request, map);</span>
<span class="nc" id="L232">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_SS_POLICY, TYPE_STRING, request, map);</span>
<span class="nc" id="L233">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_SB_POLICY, TYPE_STRING, request, map);</span>
<span class="nc" id="L234">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_CS_POLICY, TYPE_STRING, request, map);</span>
<span class="nc" id="L235">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_FT_POLICY, TYPE_STRING, request, map);</span>

                //Custom Shift Requests
<span class="nc" id="L238">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ENABLE_CUSTOM_SHIFT_REQUESTS, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L239">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_OT_BEFORE_SHIFT, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L240">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_OT_AFTER_SHIFT, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L241">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_ENTIRE_OT_SHIFT, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L242">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_REGULAR_EXTENSION_BEFORE_SHIFT, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L243">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_REGULAR_EXTENSION_AFTER_SHIFT, TYPE_BOOLEAN, request, map);</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">				if (LicenseUtil.isAdvancedRMLicense()) {</span>
<span class="nc" id="L245">					putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_REGULAR_EXTENSION_DURING_GAP, TYPE_BOOLEAN, request, map);</span>
				}
<span class="nc" id="L247">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_ENTIRE_REGULAR_SHIFT, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L248">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_SHIFT_CHANGE_REQUESTS, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L249">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_EDIT_OT_REQUESTS_GAP, TYPE_BOOLEAN, request, map);</span>
<span class="nc" id="L250">				putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ALLOW_EDIT_OT_REQUESTS_DURATION, TYPE_BOOLEAN, request, map);</span>

				//Save each section that contains at least one changed item
<span class="nc" id="L253">				keepOnlyChangedSections(orgSetting, orgID);</span>
<span class="nc" id="L254">				SettingsModelHandler.setSettings(orgID, orgSetting, shallow);</span>

<span class="nc" id="L256">			} catch (IllegalArgumentException ex) {</span>
<span class="nc" id="L257">				throw new IllegalArgumentException(ex.getMessage());</span>
<span class="nc" id="L258">			} catch (Exception ex) {</span>
<span class="nc" id="L259">				log.l7dError(RmWebLogBundleKey.ORG_RM_SETTINGS_ERROR_SAVE, ex);</span>
<span class="nc" id="L260">				String msgID = RmWebBundleKey.ORG_RM_SETTINGS_ERROR_SAVE;</span>
<span class="nc" id="L261">				model.addPageMessage(Message.ERROR_TYPE, msgID, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L262">				context.setPageModel(model);</span>
<span class="nc" id="L263">			}</span>
		}
<span class="nc" id="L265">	}</span>

	// QA 95028: Disabled controls don't send values to back end. Ignore missing values
	private void putNonNullValueInMap(String key, int parmType, HttpServletRequest request, Map map) {
<span class="nc" id="L269">		putNonNullValueInMap(key, parmType, null, request, map);</span>
<span class="nc" id="L270">	}</span>

	private void putNonNullValueInMap(String key, int parmType, Localizer localizer, HttpServletRequest request, Map map) {
<span class="nc" id="L273">		String parm = null;</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">		if (parmType == TYPE_STRING) {</span>
<span class="nc" id="L275">			parm = getParameter(request, key);</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">		} else if (parmType == TYPE_BOOLEAN) {</span>
<span class="nc" id="L277">			parm = getBooleanParameter(request, key);</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">		} else if (parmType == TYPE_REAL) {</span>
<span class="nc" id="L279">			parm = getRealNumberParameter(request, key, localizer);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">		} else if (parmType == TYPE_INTEGER) {</span>
<span class="nc" id="L281">			parm = getIntegerParameter(request, key);</span>
		}
<span class="nc bnc" id="L283" title="All 2 branches missed.">		if (parm != null) {</span>
<span class="nc" id="L284">			map.put(key, parm);</span>
		}
<span class="nc" id="L286">	}</span>

	private void putNonNullValueInMap(RequestContext context, SettingsPageModel model, String settingKey, String bundleKey,
			Map&lt;String, Object&gt; map, List&lt;String&gt; validValues) {
<span class="nc" id="L290">		Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L291">		HttpServletRequest request = context.getRequest();</span>
<span class="nc" id="L292">		String sValue = getParameter(request, settingKey);</span>
		try {
<span class="nc bnc" id="L294" title="All 2 branches missed.">			if (!StringUtil.isEmptyOrWhiteSpace(sValue)) {</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">				if (!validValues.contains(sValue)) {</span>
<span class="nc" id="L296">					handleInvalidValuePageMessage(localizer, model, bundleKey, sValue);</span>
				}
<span class="nc" id="L298">				map.put(settingKey, sValue);</span>
			}
<span class="nc" id="L300">		} catch (NumberFormatException nfe) {</span>
<span class="nc" id="L301">			handleInvalidValuePageMessage(localizer, model, bundleKey, sValue);</span>
<span class="nc" id="L302">		}</span>
<span class="nc" id="L303">	}</span>

	private Integer putNonNullIntInMapValidateRange(RequestContext context, SettingsPageModel model, String settingKey, String bundleKey,
			Map&lt;String, Object&gt; map, int minValue, int maxValue) {
<span class="nc" id="L307">		Integer result = null;</span>
<span class="nc" id="L308">		Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L309">		HttpServletRequest request = context.getRequest();</span>
<span class="nc" id="L310">		String sValue = getParameter(request, settingKey);</span>
		try {
<span class="nc bnc" id="L312" title="All 2 branches missed.">			if (!StringUtil.isEmptyOrWhiteSpace(sValue)) {</span>
<span class="nc" id="L313">				int value = Integer.parseInt(sValue);</span>
<span class="nc" id="L314">				result = value;</span>
<span class="nc bnc" id="L315" title="All 4 branches missed.">				if (value &lt; minValue || maxValue &lt; value) {</span>
<span class="nc" id="L316">					handleInvalidValuePageMessage(localizer, model, bundleKey, value);</span>
				}
<span class="nc" id="L318">				map.put(settingKey, sValue);</span>
			}
<span class="nc" id="L320">		} catch (NumberFormatException nfe) {</span>
<span class="nc" id="L321">			handleInvalidValuePageMessage(localizer, model, bundleKey, sValue);</span>
<span class="nc" id="L322">		}</span>
<span class="nc" id="L323">		return result;</span>
	}

	private void putNonNullIntInMapValidateValues(RequestContext context, SettingsPageModel model, String settingKey, String bundleKey,
			Map&lt;String, Object&gt; map, Collection&lt;Integer&gt; values) {
<span class="nc" id="L328">		Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L329">		HttpServletRequest request = context.getRequest();</span>
<span class="nc" id="L330">		String sValue = getParameter(request, settingKey);</span>
		try {
<span class="nc bnc" id="L332" title="All 2 branches missed.">			if (!StringUtil.isEmptyOrWhiteSpace(sValue)) {</span>
<span class="nc" id="L333">				int value = Integer.parseInt(sValue);</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">				if (!values.contains(value)) {</span>
<span class="nc" id="L335">					handleInvalidValuePageMessage(localizer, model, bundleKey, value);</span>
				}
<span class="nc" id="L337">				map.put(settingKey, sValue);</span>
			}
<span class="nc" id="L339">		} catch (NumberFormatException nfe) {</span>
<span class="nc" id="L340">			handleInvalidValuePageMessage(localizer, model, bundleKey, sValue);</span>
<span class="nc" id="L341">		}</span>
<span class="nc" id="L342">	}</span>

	void saveRequiredPayPeriod(RequestContext context, SettingsPageModel model, Map&lt;String, Object&gt; map) {
<span class="nc" id="L345">		Localizer localizer = context.getLocalizer();</span>

<span class="nc" id="L347">		List&lt;String&gt; payPeriodValues = RmUtil.getKeys(SettingsPageModel.getRequiredPayPeriodOptions(localizer));</span>
<span class="nc" id="L348">		putNonNullValueInMap(context, model, RmSettingKey.ORG_RM_SETTINGS_REQUIRED_PAY_PERIOD_PERIOD,</span>
				RmWebBundleKey.REQUIRED_PAY_PERIOD_HOURS_PERIOD, map, payPeriodValues);
<span class="nc" id="L350">	}</span>

	void saveTimeOffAccrual(RequestContext context, SettingsPageModel model, Map&lt;String, Object&gt; map) {
<span class="nc" id="L353">		HttpServletRequest request = context.getRequest();</span>
<span class="nc" id="L354">		putNonNullValueInMap(RmSettingKey.ORG_RM_SETTINGS_ANIVERSARY_DATE, TYPE_STRING, request, map);</span>

<span class="nc" id="L356">		putNonNullIntInMapValidateRange(context, model, RmSettingKey.ORG_RM_SETTINGS_FIXED_DATE_MONTH,</span>
				RmWebBundleKey.ORG_RM_SETTINGS_FIXED_DATE, map, Calendar.JANUARY, Calendar.DECEMBER);

		// just use max days as 31 so we don't have to keep it in sync with foundation's dropdown.js
<span class="nc" id="L360">		putNonNullIntInMapValidateRange(context, model, RmSettingKey.ORG_RM_SETTINGS_FIXED_DATE_DAY,</span>
				RmWebBundleKey.ORG_RM_SETTINGS_FIXED_DATE, map, 1, 31);

<span class="nc" id="L363">		putNonNullIntInMapValidateRange(context, model, RmSettingKey.ORG_RM_SETTINGS_ACCRUAL_DAY_OF_MONTH,</span>
				RmWebBundleKey.ORG_RM_SETTINGS_ACCRUAL_DAY_OF_MONTH, map, 1, 31);

<span class="nc" id="L366">		putNonNullIntInMapValidateRange(context, model, RmSettingKey.ORG_RM_SETTINGS_ACCRUAL_DAY_OF_WEEK,</span>
				RmWebBundleKey.ORG_RM_SETTINGS_ACCRUAL_DAY_OF_WEEK, map, Calendar.SUNDAY, Calendar.SATURDAY);
<span class="nc" id="L368">	}</span>

	void saveTimeOffRequestOptions(RequestContext context, SettingsPageModel model, Map&lt;String, Object&gt; map) {
<span class="nc" id="L371">		Localizer localizer = context.getLocalizer();</span>

<span class="nc" id="L373">		List&lt;Integer&gt; roundingOptions = RmUtil.getKeysAsIntegers(SettingsPageModel.getTimeOffRoundingOptionPairs(localizer));</span>
<span class="nc" id="L374">		putNonNullIntInMapValidateValues(context, model, RmSettingKey.ORG_RM_TIME_OFF_TIME_INTERVAL,</span>
				RmWebBundleKey.TIMEOFF_ROUNDING_OPTIONS, map, roundingOptions);

<span class="nc" id="L377">		putNonNullIntInMapValidateRange(context, model, RmSettingKey.ORG_RM_SETTINGS_TIME_OFF_CHOICES_COUNT,</span>
				RmWebBundleKey.ORG_RM_SETTINGS_TIME_OFF_CHOICES_COUNT, map, 1, OrganizationSetting.MAX_TIME_OFF_CHOICES_COUNT);
<span class="nc" id="L379">	}</span>

	private void handleInvalidValuePageMessage(Localizer localizer, SettingsPageModel model, String bundleKey, Object value) {
<span class="nc" id="L382">		String displayName = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, bundleKey);</span>
<span class="nc" id="L383">		String msg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.INVALID_VALUE_OF_X_FOR_Y, value, displayName);</span>
<span class="nc" id="L384">		model.addPageMessage(Message.ERROR_TYPE, msg);</span>
<span class="nc" id="L385">		throw new RmRuntimeException(msg);</span>
	}

	/**
	 * Get a normal html paramater.
	 *
	 * @param request - request
	 * @param key - the parameter name.
	 *
	 * @return String - the html parameter or null.
	 */
	private String getParameter(HttpServletRequest request, String key) {
<span class="nc" id="L397">		key = SettingsPageModel.getNameKey(key);</span>
<span class="nc" id="L398">		return request.getParameter(key);</span>
	}

	/**
	 * Get a boolean html paramater.
	 *
	 * @param request - request
	 * @param key - the parameter name.
	 *
	 * @return String - &quot;true&quot; or &quot;false&quot;
	 */
	private String getBooleanParameter(HttpServletRequest request, String key) {
<span class="nc" id="L410">		key = SettingsPageModel.getNameKey(key);</span>
<span class="nc bnc" id="L411" title="All 4 branches missed.">		if (request.getParameter(key) == null || request.getParameter(key).equals(&quot;false&quot;)) {</span>
<span class="nc" id="L412">			return &quot;false&quot;;</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">		} else if (request.getParameter(key).equals(&quot;true&quot;)) {</span>
<span class="nc" id="L414">			return &quot;true&quot;;</span>
		} else {
<span class="nc" id="L416">			throw new IllegalArgumentException(&quot;Value &quot; + request.getParameter(key) + &quot; is not valid &quot;);</span>
		}

	}

	/**
	 * Get a real number html paramater.
	 *
	 * @param request - request
	 * @param key - the parameter name.
	 *
	 * @return String - &quot;true&quot; or &quot;false&quot;
	 */
	private String getRealNumberParameter(HttpServletRequest request, String key, Localizer localizer) {
<span class="nc" id="L430">		key = SettingsPageModel.getNameKey(key);</span>
<span class="nc" id="L431">		String value = getParameter(request, key);</span>
<span class="nc" id="L432">		double result = 0;</span>
		//similar to FormInputPC.convertLocalizedRealNumber but not ignore the exception for Appscan issues
		try {
			// NumberFormatter.parse() doesn't recognize lower case 'e' in scientific notation
			// while JavaScript logic on client side accepts both 'e' and 'E',
			// so use replace() here to workaround the issue with lowercase 'e'
<span class="nc" id="L438">			result = localizer.getNumberFormatter().parse(value.replace('e', 'E')).doubleValue();</span>
<span class="nc" id="L439">		} catch (ParseException e) {</span>
			try {
<span class="nc" id="L441">				result = Double.parseDouble(value);</span>
<span class="nc" id="L442">			} catch (NumberFormatException ex) {</span>
<span class="nc" id="L443">				throw new IllegalArgumentException(&quot;Value &quot; + request.getParameter(key) + &quot; is not valid &quot;);</span>
<span class="nc" id="L444">			}</span>
<span class="nc" id="L445">		}</span>
<span class="nc" id="L446">		return Double.toString(result);</span>

	}

	private String getIntegerParameter(HttpServletRequest request, String key) {
<span class="nc" id="L451">		key = SettingsPageModel.getNameKey(key);</span>
<span class="nc" id="L452">		String value = getParameter(request, key);</span>
<span class="nc" id="L453">		int result = 0;</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">		if (!StringUtil.isEmpty(value)) {</span>
			try {
<span class="nc" id="L456">				result = Integer.parseInt(value);</span>
<span class="nc" id="L457">			} catch (NumberFormatException ex) {</span>
<span class="nc" id="L458">				throw new IllegalArgumentException(&quot;The value has wrong format to parse to int:&quot; + ex.getLocalizedMessage());</span>
<span class="nc" id="L459">			}</span>
		} else {
<span class="nc" id="L461">			throw new IllegalArgumentException(&quot;Value &quot; + value + &quot; is not valid &quot;);</span>
		}

<span class="nc" id="L464">		return Integer.toString(result);</span>

	}

	/**
	 * Get a list of all of the keys that have different values between two maps.
	 * We assume both maps have the same keys.
	 * @return A List of all of the keys from the maps which have different values between the two.
	 */
	private List getDifferentValueKeys(Map map1, Map map2) {
<span class="nc" id="L474">		ArrayList diffValKeys = new ArrayList(20);</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">		for (Iterator it = map1.keySet().iterator(); it.hasNext();) {</span>
<span class="nc" id="L476">			String curKey = (String) it.next();</span>
<span class="nc" id="L477">			String val1 = (String) map1.get(curKey);</span>
<span class="nc" id="L478">			String val2 = (String) map2.get(curKey);</span>

<span class="nc bnc" id="L480" title="All 2 branches missed.">			if (!isSameValue(curKey, val1, val2)) {</span>
<span class="nc" id="L481">				diffValKeys.add(curKey);</span>
			}
<span class="nc" id="L483">        }</span>
<span class="nc" id="L484">        return diffValKeys;</span>
    }

    /**
     * Determines if two values are equal, depending on the type of key they represent.
     * @param key The RM property key.
     * @param val1 The first value.
     * @param val2 The second value.
     * @return true if the two values should be considered equal, false otherwise.
     */
    private boolean isSameValue(String key, String val1, String val2)
    {
<span class="nc" id="L496">        boolean areSame = false;</span>
<span class="nc bnc" id="L497" title="All 4 branches missed.">        if (val1==null &amp;&amp; val2==null)</span>
        {
<span class="nc" id="L499">            areSame = true;</span>
        }
<span class="nc bnc" id="L501" title="All 4 branches missed.">        else if (val1==null || val2==null)</span>
        {
<span class="nc" id="L503">            areSame = false;</span>
        }
<span class="nc bnc" id="L505" title="All 4 branches missed.">        else if (isListKey(key) &amp;&amp; listValuesAreEqual(val1, val2))</span>
        {
<span class="nc" id="L507">            areSame = true;</span>
        }
<span class="nc bnc" id="L509" title="All 2 branches missed.">        else if (val1.equals(val2))</span>
        {
<span class="nc" id="L511">            areSame = true;</span>
        }
<span class="nc" id="L513">        return areSame;</span>
    }

    /**
     * Given String, determine whether the value should be interpreted as a comma-delimitted list.
     * @param key The name of the key.
     * @return true the key represents a comma-separated list of values.
     */
    private boolean isListKey(String key)
    {
<span class="nc bnc" id="L523" title="All 2 branches missed.">		if (RmSettingKey.ORG_RM_SETTINGS_GROUP_VIEW_ORG_LIST.equals(key)) {</span>
<span class="nc" id="L524">			return true;</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">		} else if (RmWebBundleKey.ORG_RM_SETTINGS_SHIFT_SWAP_ORG_LIST.equals(key)) {</span>
<span class="nc" id="L526">			return true;</span>
		}

<span class="nc" id="L529">        return false;</span>
    }

    /**
     * Given two comma-delimitted strings, determine whether they both contain the same values (order doesn't matter).
     * @param list1 The first comma-delimitted string.
     * @param list2 The second comma-delimitted string.
     * @return true if both contain the same values, false otherwise.
     */
    private boolean listValuesAreEqual(String list1, String list2)
    {
<span class="nc bnc" id="L540" title="All 4 branches missed.">        if (list1==null &amp;&amp; list2==null) {</span>
<span class="nc" id="L541">			return true;</span>
<span class="nc bnc" id="L542" title="All 4 branches missed.">		} else if (list1 == null || list2 == null) {</span>
<span class="nc" id="L543">			return false;</span>
		}

<span class="nc" id="L546">        list1 = list1.trim();</span>
<span class="nc" id="L547">        list2 = list2.trim();</span>

<span class="nc" id="L549">        String[] result1 = list1.split(&quot;,&quot;);</span>
<span class="nc" id="L550">        String[] result2 = list2.split(&quot;,&quot;);</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">        if (result1.length != result2.length) {</span>
<span class="nc" id="L552">			return false;</span>
		}

<span class="nc" id="L555">        HashSet set1 = new HashSet(result1.length);</span>
<span class="nc" id="L556">        HashSet set2 = new HashSet(result2.length);</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">        for (int i=0; i&lt;result1.length; i++)</span>
        {
<span class="nc" id="L559">            set1.add(result1[i]);</span>
<span class="nc" id="L560">            set2.add(result2[i]);</span>
        }
<span class="nc" id="L562">        return (set1.containsAll(set2));</span>
    }

    /**
     * Given an OrganizationSetting object, remove keys from all sections which have not changed.
     * If even a single key has changed in a section, we keep all of the keys in that section.
     * @param newSettings An OrganizationSetting object which has a settings map in it.
     */
    private void keepOnlyChangedSections(OrganizationSetting newSettings, ID orgID) throws Exception
    {
        //The orgSetting's map has all of the new settings. Compare with the original settings to
        //decide which settings to actually save in the database.
<span class="nc" id="L574">        OrganizationSetting oldSettings = SettingsModelHandler.getSettings(orgID);</span>
<span class="nc" id="L575">        Map oldMap = oldSettings.getValues();</span>
<span class="nc" id="L576">        Map newMap = newSettings.getValues();</span>
<span class="nc" id="L577">        List differentValueKeys = getDifferentValueKeys(newMap, oldMap);</span>

        //System.out.println(&quot;\n\nThe following key\\value pairs will be saved:&quot;);
<span class="nc" id="L580">        HashMap reducedMap = new HashMap(differentValueKeys.size());</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">        if (differentValueKeys.size() &gt; 0)</span>
        {
<span class="nc bnc" id="L583" title="All 2 branches missed.">            for (Iterator it=differentValueKeys.iterator(); it.hasNext();)</span>
            {
<span class="nc" id="L585">                String key = (String)it.next();</span>

                //add all of the keys in this key's section to the reducedMap
<span class="nc" id="L588">                String[] sectionKeys = getSectionKeys(key);</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">                for (int i=0; i&lt;sectionKeys.length; i++)</span>
                {
<span class="nc" id="L591">                    String sectionKey = sectionKeys[i];</span>
<span class="nc" id="L592">                    String value = (String)newMap.get(sectionKey);</span>
<span class="nc" id="L593">                    reducedMap.put(sectionKey, value);</span>
                    //System.out.println(sectionKey + &quot; &gt;&gt;---&gt; &quot; + value);
                }
<span class="nc" id="L596">            }</span>
        }
        //even if the reducedMap is empty, we still need to use it
<span class="nc" id="L599">        newSettings.setValues(reducedMap);</span>
<span class="nc" id="L600">    }</span>

    /**
     * Given an RM property key, return all of the keys in its same section (including itself).
     * These are needed because all keys in a section are saved together.
     * @param key An RM property key
     * @return A String array of all of the keys in the keys's same section (including itself).
     */
    private String[] getSectionKeys(String key)
    {
<span class="nc bnc" id="L610" title="All 2 branches missed.">        if (key.equals(RmSettingKey.ORG_RM_SETTINGS_PROCESS_VACATION_REQUEST)</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">            || key.equals(RmSettingKey.ORG_RM_SETTINGS_REQUEST_VACATION))</span>
        {
<span class="nc" id="L613">            return new String[] {RmSettingKey.ORG_RM_SETTINGS_PROCESS_VACATION_REQUEST,</span>
                    RmSettingKey.ORG_RM_SETTINGS_REQUEST_VACATION};
        }
<span class="nc bnc" id="L616" title="All 2 branches missed.">        if (key.equals(RmSettingKey.ORG_RM_TIME_OFF_TIME_INTERVAL)</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_TIME_OFF_CHOICES_COUNT)</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_ALLOW_COPY_TIME_OFF_BID_REQUEST))</span>
            {
<span class="nc" id="L620">                return new String[] {RmSettingKey.ORG_RM_TIME_OFF_TIME_INTERVAL,</span>
                        RmSettingKey.ORG_RM_SETTINGS_TIME_OFF_CHOICES_COUNT,
                        RmSettingKey.ORG_RM_ALLOW_COPY_TIME_OFF_BID_REQUEST};
            }
<span class="nc bnc" id="L624" title="All 2 branches missed.">        else if (key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_ESCALATION)</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_SHOW_AUTOPROCESSING_RULES)</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_GROUP_VIEW_ORG_LIST))</span>
        {
<span class="nc" id="L628">            return new String[] {RmSettingKey.ORG_RM_SETTINGS_ALLOW_ESCALATION,</span>
                    RmSettingKey.ORG_RM_SETTINGS_SHOW_AUTOPROCESSING_RULES,
                    RmSettingKey.ORG_RM_SETTINGS_GROUP_VIEW_ORG_LIST};
        }
<span class="nc bnc" id="L632" title="All 2 branches missed.">        else if (key.equals(RmSettingKey.ORG_RM_SETTINGS_MAX_PREFERENCE_VALUE)</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_MAX_BIDS_PER_EMPLOYEE)</span>
<span class="nc bnc" id="L634" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_SENIORITY_FACTOR)</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_RANK_FACTOR)</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_BONUSPOINT_FACTOR)</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_FILTER_BID_OPTIONS_BY_EMPLOYEE_TYPE)</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_DISPLAY_TEMPLATE_DESCRIPTION))</span>
        {
<span class="nc" id="L640">            return new String[] {RmSettingKey.ORG_RM_SETTINGS_MAX_PREFERENCE_VALUE,</span>
                    RmSettingKey.ORG_RM_SETTINGS_MAX_BIDS_PER_EMPLOYEE,
                    RmSettingKey.ORG_RM_SETTINGS_SENIORITY_FACTOR,
                    RmSettingKey.ORG_RM_SETTINGS_RANK_FACTOR,
                    RmSettingKey.ORG_RM_SETTINGS_BONUSPOINT_FACTOR,
                    RmSettingKey.ORG_RM_SETTINGS_FILTER_BID_OPTIONS_BY_EMPLOYEE_TYPE,
                    RmSettingKey.ORG_RM_SETTINGS_DISPLAY_TEMPLATE_DESCRIPTION};
        }
<span class="nc bnc" id="L648" title="All 2 branches missed.">        else if (key.equals(RmSettingKey.ORG_RM_SETTINGS_ANIVERSARY_DATE)</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_FIXED_DATE_MONTH)</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_FIXED_DATE_DAY)</span>

<span class="nc bnc" id="L652" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ACCRUAL_DAY_OF_MONTH)</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ACCRUAL_DAY_OF_WEEK))</span>
        {
<span class="nc" id="L655">            return new String[] {RmSettingKey.ORG_RM_SETTINGS_ANIVERSARY_DATE,</span>
                    RmSettingKey.ORG_RM_SETTINGS_FIXED_DATE_MONTH,
                    RmSettingKey.ORG_RM_SETTINGS_FIXED_DATE_DAY,
                    RmSettingKey.ORG_RM_SETTINGS_ACCRUAL_DAY_OF_MONTH,
                    RmSettingKey.ORG_RM_SETTINGS_ACCRUAL_DAY_OF_WEEK};
        }
<span class="nc bnc" id="L661" title="All 2 branches missed.">        else if (key.equals(RmSettingKey.ORG_RM_SETTINGS_ENABLE_SHIFT_SWAP)</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_SHIFT_SWAP_ORG_LIST)</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_DISABLE_ONE_WAY_SHIFT_SWAP)</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_PARTIAL_SHIFT_SWAP)</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_PARTIAL_SHIFT_PICKUP)</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_MAX_SWAP_NEGOTIATIONS))</span>
        {
<span class="nc" id="L668">            return new String[] {RmSettingKey.ORG_RM_SETTINGS_ENABLE_SHIFT_SWAP,</span>
                    RmSettingKey.ORG_RM_SETTINGS_SHIFT_SWAP_ORG_LIST,
                    RmSettingKey.ORG_RM_SETTINGS_DISABLE_ONE_WAY_SHIFT_SWAP,
                    RmSettingKey.ORG_RM_SETTINGS_ALLOW_PARTIAL_SHIFT_SWAP,
                    RmSettingKey.ORG_RM_SETTINGS_ALLOW_PARTIAL_SHIFT_PICKUP,
                    RmSettingKey.ORG_RM_SETTINGS_MAX_SWAP_NEGOTIATIONS};
        }
<span class="nc bnc" id="L675" title="All 2 branches missed.">        else if (key.equals(RmSettingKey.ORG_RM_SETTINGS_TO_AVAILABLE_COLOR)</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_TO_BLACKOUT_COLOR)</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_TO_NON_OPERATION_COLOR)</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_TO_NON_WORKING_COLOR)</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_TO_NO_AVAILABLE_COLOR)</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_TO_WORKING_COLOR)</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_TO_PENDING_COLOR)</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_TO_SCHEDULED_COLOR))</span>
        {
<span class="nc" id="L684">            return new String[] {RmSettingKey.ORG_RM_SETTINGS_TO_AVAILABLE_COLOR,</span>
                    RmSettingKey.ORG_RM_SETTINGS_TO_BLACKOUT_COLOR,
                    RmSettingKey.ORG_RM_SETTINGS_TO_NON_OPERATION_COLOR,
                    RmSettingKey.ORG_RM_SETTINGS_TO_NON_WORKING_COLOR,
                    RmSettingKey.ORG_RM_SETTINGS_TO_NO_AVAILABLE_COLOR,
                    RmSettingKey.ORG_RM_SETTINGS_TO_WORKING_COLOR,
                    RmSettingKey.ORG_RM_SETTINGS_TO_PENDING_COLOR,
                    RmSettingKey.ORG_RM_SETTINGS_TO_SCHEDULED_COLOR};
        }

<span class="nc bnc" id="L694" title="All 2 branches missed.">        else if (key.equals(RmSettingKey.ORG_RM_SETTINGS_ENABLE_CUSTOM_SHIFT_REQUESTS)</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">        		|| key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_OT_BEFORE_SHIFT)</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_OT_AFTER_SHIFT)</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_ENTIRE_OT_SHIFT)</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_REGULAR_EXTENSION_BEFORE_SHIFT)</span>
<span class="nc bnc" id="L699" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_REGULAR_EXTENSION_AFTER_SHIFT)</span>
<span class="nc bnc" id="L700" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_REGULAR_EXTENSION_DURING_GAP)</span>
<span class="nc bnc" id="L701" title="All 2 branches missed.">                || key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_ENTIRE_REGULAR_SHIFT)</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">		        || key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_SHIFT_CHANGE_REQUESTS))</span>
        {
<span class="nc" id="L704">            return new String[] {RmSettingKey.ORG_RM_SETTINGS_ENABLE_CUSTOM_SHIFT_REQUESTS,</span>
            		RmSettingKey.ORG_RM_SETTINGS_ALLOW_OT_BEFORE_SHIFT,
                    RmSettingKey.ORG_RM_SETTINGS_ALLOW_OT_AFTER_SHIFT,
                    RmSettingKey.ORG_RM_SETTINGS_ALLOW_ENTIRE_OT_SHIFT,
                    RmSettingKey.ORG_RM_SETTINGS_ALLOW_REGULAR_EXTENSION_BEFORE_SHIFT,
                    RmSettingKey.ORG_RM_SETTINGS_ALLOW_REGULAR_EXTENSION_AFTER_SHIFT,
                    RmSettingKey.ORG_RM_SETTINGS_ALLOW_REGULAR_EXTENSION_DURING_GAP,
                    RmSettingKey.ORG_RM_SETTINGS_ALLOW_ENTIRE_REGULAR_SHIFT,
                    RmSettingKey.ORG_RM_SETTINGS_ALLOW_SHIFT_CHANGE_REQUESTS};
<span class="nc bnc" id="L713" title="All 2 branches missed.">		} else if (key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_MAKEUP_BEFORE_SHIFT)</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">				|| key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_MAKEUP_AFTER_SHIFT)</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">				|| key.equals(RmSettingKey.ORG_RM_SETTINGS_ALLOW_MAKEUP_IN_GAP)</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">				|| key.equals(RmSettingKey.ORG_RM_SETTINGS_LIMIT_FLEX_TIMEOFF_TO_START_SHIFT_BLOCK)) {</span>
<span class="nc" id="L717">			return new String[] { RmSettingKey.ORG_RM_SETTINGS_ALLOW_MAKEUP_BEFORE_SHIFT,</span>
					RmSettingKey.ORG_RM_SETTINGS_ALLOW_MAKEUP_AFTER_SHIFT,
					RmSettingKey.ORG_RM_SETTINGS_ALLOW_MAKEUP_IN_GAP,
					RmSettingKey.ORG_RM_SETTINGS_LIMIT_FLEX_TIMEOFF_TO_START_SHIFT_BLOCK };
		}

<span class="nc" id="L723">        return new String[]{key};</span>
    }
	private void validateColorParameter(HttpServletRequest httpServletRequest) {
<span class="nc" id="L726">		 String availableColor =getParameter(httpServletRequest, RmSettingKey.ORG_RM_SETTINGS_TO_AVAILABLE_COLOR);</span>
<span class="nc" id="L727">		 String workingColor =getParameter(httpServletRequest, RmSettingKey.ORG_RM_SETTINGS_TO_WORKING_COLOR);</span>
<span class="nc" id="L728">		 String pendingColor =getParameter(httpServletRequest, RmSettingKey.ORG_RM_SETTINGS_TO_PENDING_COLOR);</span>
<span class="nc" id="L729">		 String scheduledColor =getParameter(httpServletRequest, RmSettingKey.ORG_RM_SETTINGS_TO_SCHEDULED_COLOR);</span>
<span class="nc" id="L730">		 String noAvailableColor =getParameter(httpServletRequest, RmSettingKey.ORG_RM_SETTINGS_TO_NO_AVAILABLE_COLOR);</span>
<span class="nc" id="L731">		 String nonOperationColor =getParameter(httpServletRequest, RmSettingKey.ORG_RM_SETTINGS_TO_NON_OPERATION_COLOR);</span>
<span class="nc" id="L732">		 String backoutColor =getParameter(httpServletRequest, RmSettingKey.ORG_RM_SETTINGS_TO_BLACKOUT_COLOR);</span>
<span class="nc" id="L733">		 String nonworkingColor =getParameter(httpServletRequest, RmSettingKey.ORG_RM_SETTINGS_TO_NON_WORKING_COLOR);</span>

<span class="nc bnc" id="L735" title="All 2 branches missed.">		if (!isValidColor(availableColor)) {</span>
<span class="nc" id="L736">			throw new IllegalArgumentException(&quot;Color Parameter has value &quot; + availableColor + &quot; while it is expected to be alpha numeric value&quot;);</span>
		}
<span class="nc bnc" id="L738" title="All 2 branches missed.">		if (!isValidColor(workingColor)) {</span>
<span class="nc" id="L739">			throw new IllegalArgumentException(&quot;Color Parameter has value &quot; + workingColor +&quot; while it is expected to be alpha numeric value&quot;);</span>
		}
<span class="nc bnc" id="L741" title="All 2 branches missed.">		if (!isValidColor(pendingColor)) {</span>
<span class="nc" id="L742">			throw new IllegalArgumentException(&quot;Color Parameter has value &quot; + pendingColor +&quot; while it is expected to be alpha numeric value&quot;);</span>
		}
<span class="nc bnc" id="L744" title="All 2 branches missed.">		if (!isValidColor(scheduledColor)) {</span>
<span class="nc" id="L745">			throw new IllegalArgumentException(&quot;Color Parameter has value &quot; + scheduledColor +&quot; while it is expected to be alpha numeric value&quot;);</span>
		}
<span class="nc bnc" id="L747" title="All 2 branches missed.">		if (!isValidColor(noAvailableColor)) {</span>
<span class="nc" id="L748">			throw new IllegalArgumentException(&quot;Color Parameter has value &quot; + noAvailableColor +&quot; while it is expected to be alpha numeric value&quot;);</span>
		}
<span class="nc bnc" id="L750" title="All 2 branches missed.">		if (!isValidColor(nonOperationColor)) {</span>
<span class="nc" id="L751">			throw new IllegalArgumentException(&quot;Color Parameter has value &quot; + nonOperationColor +&quot; while it is expected to be alpha numeric value&quot;);</span>
		}
<span class="nc bnc" id="L753" title="All 2 branches missed.">		if (!isValidColor(backoutColor)) {</span>
<span class="nc" id="L754">			throw new IllegalArgumentException(&quot;Color Parameter has value &quot; + backoutColor +&quot; while it is expected to be alpha numeric value&quot;);</span>
		}
<span class="nc bnc" id="L756" title="All 2 branches missed.">		if (!isValidColor(nonworkingColor)) {</span>
<span class="nc" id="L757">			throw new IllegalArgumentException(&quot;Color Parameter has value &quot; + nonworkingColor +&quot; while it is expected to be alpha numeric value&quot;);</span>
		}
<span class="nc" id="L759">	}</span>

	private boolean isValidColor(String s) {
<span class="nc bnc" id="L762" title="All 4 branches missed.">		if (!StringUtil.isEmpty(s) &amp;&amp; s.startsWith(&quot;#&quot;)) {</span>
<span class="nc" id="L763">			String colorCode = s.substring(1);</span>
<span class="nc" id="L764">			String pattern = &quot;^[a-zA-Z0-9]*$&quot;;</span>
<span class="nc" id="L765">			return colorCode.matches(pattern);</span>
		} else {
<span class="nc" id="L767">			return false;</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>