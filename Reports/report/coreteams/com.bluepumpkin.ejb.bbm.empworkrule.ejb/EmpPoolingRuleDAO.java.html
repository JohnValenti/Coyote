<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>EmpPoolingRuleDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.empworkrule.ejb</a> &gt; <span class="el_source">EmpPoolingRuleDAO.java</span></div><h1>EmpPoolingRuleDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.empworkrule.ejb;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:  dao object to serialize WorkResourceMinMaxHour object
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author       lixin zhang
 * @version      1.0
 */

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.dao.DAOEffectivity;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.empworkrule.model.EmpPoolingRule;
import com.bluepumpkin.ejb.bbm.empworkrule.model.EmpPoolingRuleFieldInfo;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectEffectivity;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.verint.ejb.wfm.IEmpPoolingRuleDAO;

public class EmpPoolingRuleDAO extends DAOEffectivity implements IEmpPoolingRuleDAO {

<span class="fc" id="L43">	private static FieldInfo m_fieldInfo = new EmpPoolingRuleFieldInfo();</span>
<span class="fc" id="L44">	protected FieldInfo getFieldInfo() { return m_fieldInfo; }</span>

	public EmpPoolingRuleDAO() {
<span class="fc" id="L47">			 super();</span>
<span class="fc" id="L48">	}</span>

	public EmpPoolingRuleDAO(Jdmo dmo) {
<span class="fc" id="L51">			 super(dmo);</span>
<span class="fc" id="L52">	}</span>

	protected ValueObjectBase createValueObject()
	{
<span class="nc" id="L56">			return (new EmpPoolingRule());</span>
	}

 /**
	 *   get a given work Employee's pooling rule assignment
	 *
	 *   @idWorkResource employee id
	 *   @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 *   @return a collection of EmpPoolingRule objects which hold the assignment information
	 */
	public Collection getPoolingRuleAssignments(ID idWorkResource, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="nc" id="L68">		ArrayList&lt;ID&gt; ids = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L69">		ids.add(idWorkResource);</span>
<span class="nc" id="L70">		HashMap map = getPoolingRuleAssignments(ids, dtStart, dtEnd);</span>
<span class="nc" id="L71">		return (Collection)map.get(idWorkResource);		</span>
	}

	/**
	 *   get Pooling Rule assignments for a list of employees
	 *
	 *   @colWorkResourceIDs  a collection of work resource ids
	 *   @dtStart, @dtEnd: the time period, null date means a open period
	 *
	 *   @return a HashMap of following pairs
	 *            (idWorkResource, array list of EmpPoolingRule objects)
	 */
	public HashMap getPoolingRuleAssignments(Collection colWorkResourceIDs, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L84">		HashMap empPoolingRules = super.getEffectivityAssignments(colWorkResourceIDs,</span>
				EmpPoolingRuleFieldInfo.EMPPOOLINGRULE_EMPLOYEEID, dtStart, dtEnd);
		
		try {
<span class="fc" id="L88">			String query = &quot;select EMPLOYEEID, POOLINGRULEID, ORGANIZATIONID from EmployeePoolingRules A, empPoolingRulesOrganizations B &quot;; </span>
<span class="fc" id="L89">			query += &quot;where A.ID = B.POOLINGRULEID and A.EMPLOYEEID IN &quot;;</span>
<span class="fc" id="L90">			query += m_dmo.createInClause(colWorkResourceIDs);</span>
<span class="fc" id="L91">			JdmoRowset r = m_dmo.createRowset( query );</span>

			//-------------------------------------------------
			// get data and create templates
			//-------------------------------------------------
	
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">			while (r.next()) {</span>
				
<span class="nc" id="L99">				ID empID = r.getID(&quot;EMPLOYEEID&quot;);</span>
<span class="nc" id="L100">				ID orgID = r.getID(&quot;ORGANIZATIONID&quot;);</span>
<span class="nc" id="L101">				ID prID = r.getID(&quot;POOLINGRULEID&quot;);</span>
<span class="nc" id="L102">				Collection prs = (Collection)empPoolingRules.get(empID);</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">				if (prs == null) {</span>
<span class="nc" id="L104">					continue;</span>
				} else {
<span class="nc bnc" id="L106" title="All 2 branches missed.">					for(Object obj: prs) {</span>
<span class="nc" id="L107">						EmpPoolingRule pr = (EmpPoolingRule)obj;</span>
<span class="nc bnc" id="L108" title="All 4 branches missed.">						if (pr != null &amp;&amp; pr.getID().equals(prID)) {</span>
<span class="nc" id="L109">							pr.getSecondaryOgs().add(orgID);</span>
						}
<span class="nc" id="L111">					}</span>
				}

<span class="nc" id="L114">			}</span>
<span class="fc" id="L115">			r.close();</span>
<span class="nc" id="L116">		} catch(JdmoException ex) {</span>
<span class="nc" id="L117">			ex.printStackTrace();</span>
<span class="nc" id="L118">			throw new BbmFinderException(ex);</span>
<span class="fc" id="L119">		}</span>
		
<span class="fc" id="L121">		return empPoolingRules;</span>
	}

	/** create a Pooling Rule assignment */
	public ID createPoolingRuleAssignment(EmpPoolingRule objValue) throws BbmCreateException {
<span class="fc" id="L126">		ID newID = null;</span>
		try {
<span class="fc" id="L128">			 newID =  createNoOverlapAssignment(objValue,</span>
					EmpPoolingRuleFieldInfo.EMPPOOLINGRULE_EMPLOYEEID, -1);
			
<span class="fc" id="L131">				Collection&lt;ID&gt; orgs = objValue.getSecondaryOgs();</span>
<span class="pc bpc" id="L132" title="2 of 4 branches missed.">				if (orgs != null &amp;&amp; !orgs.isEmpty()) {</span>
<span class="fc" id="L133">					HashMap&lt;String, Object&gt; nameValuesSA = new HashMap&lt;String, Object&gt;(2);</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">					for (Iterator&lt;ID&gt; i = orgs.iterator(); i.hasNext(); ) {				</span>
<span class="fc" id="L135">						ID orgid = i.next();</span>
<span class="fc" id="L136">						nameValuesSA.put(&quot;POOLINGRULEID&quot;, newID.toString());</span>
<span class="fc" id="L137">						nameValuesSA.put(&quot;ORGANIZATIONID&quot;, orgid.toString());</span>

<span class="fc" id="L139">						m_dmo.addBatchInsert(&quot;EMPPOOLINGRULESORGANIZATIONS&quot;, nameValuesSA);</span>
<span class="fc" id="L140">					}</span>
<span class="fc" id="L141">					m_dmo.executeBatch();</span>
				}
<span class="nc" id="L143">		} catch (JdmoException ex) {</span>
<span class="nc" id="L144">			throw new BbmCreateException(ex);</span>
<span class="fc" id="L145">		}</span>
			
<span class="fc" id="L147">		return newID;</span>
	}
	
	@Override
	public ID createNoOverlapAssignment(ValueObjectEffectivity objValue, int iField, int iFieldAssignment) throws BbmCreateException {
		try {
<span class="fc" id="L153">			Date dtStart = objValue.getStartTime();</span>
<span class="fc" id="L154">			Date dtEnd = objValue.getEndTime();</span>

<span class="fc" id="L156">			String strFieldName = getFieldInfo().getFieldName(iField);</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">			String strAssignmentFieldName = (iFieldAssignment &lt; 0 ? null : getFieldInfo().getFieldName(iFieldAssignment));</span>
<span class="fc" id="L158">			ID idField = objValue.getFieldValueID(iField);</span>
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">			Object assignmentFieldValue = (iFieldAssignment &lt; 0 ? null : objValue.getFieldValue(iFieldAssignment));</span>
			//handle DEID
<span class="fc" id="L161">			assignmentFieldValue = getDBValue(assignmentFieldValue);</span>

<span class="fc" id="L163">			String strStart = &quot;'&quot; + JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(dtStart)) + &quot;'&quot;;</span>
<span class="fc" id="L164">			String strEnd = &quot;&quot;;</span>

<span class="pc bpc" id="L166" title="1 of 2 branches missed.">			if (dtEnd != null)</span>
<span class="nc" id="L167">			   strEnd = &quot;'&quot; + JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(dtEnd)) + &quot;'&quot;;</span>

<span class="fc" id="L169">			String strTableName = getFieldInfo().getTableName();</span>
			
            // step 1: delete effectivities in the time period
<span class="fc" id="L172">            StringBuffer strSQL = new StringBuffer(30);</span>
<span class="fc" id="L173">            strSQL.append(&quot;select distinct ID from &quot;).append(strTableName);</span>
<span class="fc" id="L174">            strSQL.append(&quot; where &quot;).append(strFieldName).append(&quot; = &quot;).append(idField);</span>
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">            if (iFieldAssignment &gt;= 0)</span>
<span class="nc" id="L176">                strSQL.append(&quot; and &quot;).append(strAssignmentFieldName).append(&quot; = &quot;).append(assignmentFieldValue);</span>
                               
<span class="fc" id="L178">            strSQL.append(&quot; and STARTTIME &gt;= &quot;).append(strStart);            </span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">            if (dtEnd != null)</span>
<span class="nc" id="L180">               strSQL.append(&quot; and ENDTIME &lt;= &quot;).append(strEnd);</span>

			//Deletes the existing EMPLOYEEPOOLINGRULES records (and EMPPOOLINGRULESORGANIZATIONS due to cascade delete)
<span class="fc" id="L183">			DAOUtil.deleteObjects(m_dmo, strTableName, strSQL.toString());</span>

			// step 2.1: cut effectivities overlapping with the time period
			//           period start falls in an existing period
<span class="fc" id="L187">			strSQL = new StringBuffer(30);</span>
<span class="fc" id="L188">			strSQL.append(&quot;update &quot;).append(strTableName);</span>
<span class="fc" id="L189">			strSQL.append(&quot; set ENDTIME = &quot;).append(strStart);</span>
<span class="fc" id="L190">			strSQL.append(&quot; where &quot;).append(strFieldName).append(&quot; = &quot;).append(idField);</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">			if (iFieldAssignment &gt;= 0)</span>
<span class="nc" id="L192">				strSQL.append(&quot; and &quot;).append(strAssignmentFieldName).append(&quot; = &quot;).append(assignmentFieldValue);</span>
<span class="fc" id="L193">			strSQL.append(&quot; and STARTTIME &lt; &quot;).append(strStart);</span>
<span class="fc" id="L194">			strSQL.append(&quot; and (ENDTIME IS NULL OR ENDTIME &gt; &quot;).append(strStart).append(&quot;)&quot;);</span>

<span class="pc bpc" id="L196" title="1 of 2 branches missed.">			if (dtEnd != null)</span>
<span class="nc" id="L197">			   strSQL.append(&quot; and ENDTIME IS NOT NULL AND ENDTIME &lt;= &quot;).append(strEnd);</span>

<span class="fc" id="L199">			m_dmo.executeCommand(new String(strSQL));</span>

			// step 2.2: cut effectivities overlapping with the time period
			//           period end falls in an existing period
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">			if (dtEnd != null)</span>
			{
<span class="nc" id="L205">				strSQL = new StringBuffer(30);</span>
<span class="nc" id="L206">				strSQL.append(&quot; update &quot;).append(strTableName);</span>
<span class="nc" id="L207">				strSQL.append(&quot; set STARTTIME = &quot;).append(strEnd);</span>
<span class="nc" id="L208">				strSQL.append(&quot; where &quot;).append(strFieldName).append(&quot; = &quot;).append(idField);</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">				if (iFieldAssignment &gt;= 0)</span>
<span class="nc" id="L210">				   strSQL.append(&quot; and &quot;).append(strAssignmentFieldName).append(&quot; = &quot;).append(assignmentFieldValue);</span>
<span class="nc" id="L211">				strSQL.append(&quot; and STARTTIME &gt;= &quot;).append(strStart);</span>
<span class="nc" id="L212">				strSQL.append(&quot; and STARTTIME &lt; &quot;).append(strEnd);</span>
<span class="nc" id="L213">				strSQL.append(&quot; and (ENDTIME IS NULL OR ENDTIME &gt; &quot;).append(strEnd).append(&quot;)&quot;);</span>

<span class="nc" id="L215">				m_dmo.executeCommand(new String(strSQL));</span>
			}

			// step 3: split effectivities cover the time period
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">			if (dtEnd != null)</span>
			{
<span class="nc" id="L221">				strSQL = new StringBuffer(30);</span>
<span class="nc" id="L222">				strSQL.append(&quot;A.&quot;).append(strFieldName).append(&quot; = &quot;).append(idField);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">				if (iFieldAssignment &gt;= 0)</span>
<span class="nc" id="L224">				   strSQL.append(&quot; and A.&quot;).append(strAssignmentFieldName).append(&quot; = &quot;).append(assignmentFieldValue);</span>
<span class="nc" id="L225">				strSQL.append(&quot; and A.STARTTIME &lt; &quot;).append(strStart);</span>
<span class="nc" id="L226">				strSQL.append(&quot; and (A.ENDTIME IS NULL OR A.ENDTIME &gt; &quot;).append(strEnd).append(&quot;)&quot;);</span>

<span class="nc" id="L228">				Collection col = this.getObjects(new String(strSQL));</span>

<span class="nc" id="L230">				Iterator it = col.iterator();</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">				while (it.hasNext())</span>
				{
<span class="nc" id="L233">					ValueObjectEffectivity item1 = (ValueObjectEffectivity) it.next();</span>
<span class="nc" id="L234">					ValueObjectEffectivity item2 = (ValueObjectEffectivity) item1.split(dtStart, dtEnd);</span>

                    // use a sql statement to update object            
<span class="nc" id="L237">                    strSQL = new StringBuffer(30);</span>
<span class="nc" id="L238">                    strSQL.append(&quot; update &quot;).append(strTableName);</span>
<span class="nc" id="L239">                    strSQL.append(&quot; set ENDTIME = &quot;).append(strStart);</span>
<span class="nc" id="L240">                    strSQL.append(&quot; where ID = &quot;).append(getDBValue(item1.getID()));</span>
                    
<span class="nc" id="L242">                    m_dmo.executeCommand(strSQL.toString());</span>
                    
<span class="nc bnc" id="L244" title="All 2 branches missed.">                    if (item1.getID().toString().indexOf(&quot;.&quot;) &gt; 0)</span>
<span class="nc" id="L245">                    	item2.setID(new ID(DAOUtil.getDEID(m_dmo)));	</span>
                    
<span class="nc" id="L247">					createObject(item2);</span>
<span class="nc" id="L248">				}</span>
			}

			// create the new assignment
<span class="fc" id="L252">			ID id = null;</span>
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">			if (objValue.isActive())</span>
<span class="fc" id="L254">				id = createObject(objValue);</span>
<span class="fc" id="L255">			return id;</span>
		}
<span class="nc" id="L257">		catch(BbmCreateException e)</span>
		{
<span class="nc" id="L259">			throw e;</span>
		}
<span class="nc" id="L261">		catch(Exception e)</span>
		{
<span class="nc" id="L263">			throw new BbmCreateException(e);</span>
		}
	}
	
	@Override
	public void updateNoOverlapAssignment(ValueObjectEffectivity objValue, int iField, int iFieldAssignment, boolean bSaveAsNew) throws MultiUserException, BbmUpdateException
	{
		try
		{
			// check if start or end time has been changed
<span class="nc" id="L273">			ID idOld = objValue.getID();</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">			if (objValue.hasMultiEditValue())</span>
			{
<span class="nc" id="L276">				ValueObjectEffectivity itemOld = null;</span>
				try
				{
<span class="nc" id="L279">					 itemOld = (ValueObjectEffectivity) super.getObjectByID(idOld);</span>
				}
<span class="nc" id="L281">				catch(BbmObjectNotFoundException e)</span>
				{
<span class="nc" id="L283">					 itemOld = null;</span>
<span class="nc" id="L284">				}</span>

<span class="nc bnc" id="L286" title="All 2 branches missed.">				if (itemOld != null)</span>
				{
					/** resolve the multi-edit attributes */
<span class="nc" id="L289">					ValueObjectUtil.resolveMultiEditValue(objValue, itemOld);</span>
				}
			}

<span class="nc" id="L293">			objValue.setID(null);</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">			if (!bSaveAsNew)  {// replace current one</span>
				//deleteObject(idOld);
<span class="nc" id="L296">				deletePoolingRuleAssignments(Arrays.asList(idOld));</span>
				
			}
			
<span class="nc" id="L300">			createNoOverlapAssignment(objValue, iField, iFieldAssignment);</span>
		}
<span class="nc" id="L302">		catch(Exception e)</span>
		{
<span class="nc" id="L304">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L305">		}</span>
<span class="nc" id="L306">	}</span>

	/**
	 *  save a Pooling Rule assignment
	 *  @param bSaveAsNew where save as new assignment or replace existing one
	 *
	 */
	public void updatePoolingRuleAssignment(EmpPoolingRule objValue, boolean bSaveAsNew) throws MultiUserException, BbmUpdateException
	{
		try {
<span class="nc" id="L316">			updateNoOverlapAssignment(objValue,</span>
					EmpPoolingRuleFieldInfo.EMPPOOLINGRULE_EMPLOYEEID, -1, bSaveAsNew);

<span class="nc" id="L319">			ID id = objValue.getID();</span>
<span class="nc" id="L320">			Collection&lt;ID&gt; orgs = objValue.getSecondaryOgs();</span>
<span class="nc bnc" id="L321" title="All 4 branches missed.">			if (orgs != null &amp;&amp; !orgs.isEmpty()) {</span>
<span class="nc" id="L322">				HashMap&lt;String, Object&gt; nameValuesSA = new HashMap&lt;String, Object&gt;(2);</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">				for (Iterator&lt;ID&gt; i = orgs.iterator(); i.hasNext(); ) {				</span>
<span class="nc" id="L324">					ID orgid = i.next();</span>
<span class="nc" id="L325">					nameValuesSA.put(&quot;POOLINGRULEID&quot;, id.toString());</span>
<span class="nc" id="L326">					nameValuesSA.put(&quot;ORGANIZATIONID&quot;, orgid.toString());</span>

<span class="nc" id="L328">					m_dmo.addBatchInsert(&quot;EMPPOOLINGRULESORGANIZATIONS&quot;, nameValuesSA);</span>
<span class="nc" id="L329">				}</span>
<span class="nc" id="L330">				m_dmo.executeBatch();</span>
			}
		}
<span class="nc" id="L333">		catch (JdmoException ex) {</span>
<span class="nc" id="L334">			throw new BbmUpdateException(ex);</span>
<span class="nc" id="L335">		}</span>
<span class="nc" id="L336">	}</span>

	/** delete skill assignments given their assignment ids */
	public void deletePoolingRuleAssignments(Collection colIDAssignments) throws BbmRemoveException {	
<span class="nc" id="L340">		deleteObjects(colIDAssignments);</span>
		try {
<span class="nc" id="L342">			String strSQL = &quot;delete from EMPPOOLINGRULESORGANIZATIONS where POOLINGRULEID IN &quot; + m_dmo.createInClause(colIDAssignments);</span>
<span class="nc" id="L343">			m_dmo.executeCommand(strSQL.toString());</span>
		}
<span class="nc" id="L345">		catch (JdmoException ex) {</span>
<span class="nc" id="L346">			throw new BbmRemoveException(ex);</span>
<span class="nc" id="L347">		}</span>
<span class="nc" id="L348">	}</span>

	public Collection getPoolingRuleAssignmentsByIDs(Collection colIDSAs) throws BbmFinderException {
<span class="nc" id="L351">		return this.getObjectsByIDs(colIDSAs);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>