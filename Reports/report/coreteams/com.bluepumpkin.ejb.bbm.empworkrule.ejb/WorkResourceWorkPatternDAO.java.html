<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WorkResourceWorkPatternDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.empworkrule.ejb</a> &gt; <span class="el_source">WorkResourceWorkPatternDAO.java</span></div><h1>WorkResourceWorkPatternDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.empworkrule.ejb;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:  dao object to serialize WorkResourceWorkPattern object
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 * @author       lixin zhang
 * @version      1.0
 */

import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoQuery;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.dao.DAOEffectivity;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceWorkPattern;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceWorkPatternFieldInfo;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectEffectivity;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.ejb.core.base.MultiUserException;

public class WorkResourceWorkPatternDAO extends DAOEffectivity {

<span class="fc" id="L40">    private static FieldInfo m_fieldInfo = new WorkResourceWorkPatternFieldInfo();</span>
<span class="fc" id="L41">    protected FieldInfo getFieldInfo() { return m_fieldInfo; }</span>

    public WorkResourceWorkPatternDAO() {
<span class="fc" id="L44">         super();</span>
<span class="fc" id="L45">    }</span>

    public WorkResourceWorkPatternDAO(Jdmo dmo) {
<span class="nc" id="L48">         super(dmo);</span>
<span class="nc" id="L49">    }</span>

    protected ValueObjectBase createValueObject()
    {
<span class="nc" id="L53">        return (new WorkResourceWorkPattern());</span>
    } 
    
   /**
     *   get a given work resource's work pattern assignments
     *   
     *   @idWorkResource work resource id
     *   @dtStart, @dtEnd: the time period, null date means a open period
     *   
     *   @return a collection of WorkResourceWorkPattern objects which hold the assignment information
     */
    public Collection&lt;WorkResourceWorkPattern&gt; getWorkPatternAssignments(ID idWorkResource, Date dtStart, Date dtEnd) throws BbmFinderException
    {
<span class="nc" id="L66">        return super.getEffectivityAssignments(idWorkResource, </span>
          WorkResourceWorkPatternFieldInfo.WRKRESWORKPATTERN_WORKRESOURCEID, dtStart, dtEnd);     
    }    
        
    /**
     *   get a given work resource's work pattern assignments
     *   
     *   @colWorkResourceIDs  a collection of work resource ids
     *   @dtStart, @dtEnd: the time period, null date means a open period
     *   
     *   @return a HashMap of following pairs 
     *            (idWorkResource, array list of workresource's workpattern assignments)
     */
    /*
    public HashMap getWorkPatternAssignments(Collection colWorkResourceIDs, Date dtStart, Date dtEnd) throws BbmFinderException
    {
        return super.getEffectivityAssignments(colWorkResourceIDs, 
          WorkResourceWorkPatternFieldInfo.WRKRESWORKPATTERN_WORKRESOURCEID, dtStart, dtEnd);
    } */
    
    public HashMap&lt;ID, Collection&lt;WorkResourceWorkPattern&gt;&gt; getWorkPatternAssignmentsInPeriodAndOnSpotOnly(Collection&lt;ID&gt; colWorkResourceIDs, Date dtStart, Date dtEnd, Date timeSpot) throws BbmFinderException {
<span class="nc" id="L87">    	return getWorkPatternAssignments(colWorkResourceIDs, dtStart, dtEnd, false, timeSpot); //on spot only</span>
    }
    
    public HashMap&lt;ID, Collection&lt;WorkResourceWorkPattern&gt;&gt; getWorkPatternAssignments(Collection&lt;ID&gt; colWorkResourceIDs, Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L91">    	return getWorkPatternAssignments(colWorkResourceIDs, dtStart, dtEnd, false, null);</span>
    }
    
    /**
     * Returns a map of work patterns assigned to the given employees within the given date range.  Excludes monthly work patterns from the results if excludeMonthlyPatterns is set to true.
     * @return a HashMap of employee IDs to collections of work patterns assigned to those employees.
     * @throws BbmFinderException
     */
	private HashMap&lt;ID, Collection&lt;WorkResourceWorkPattern&gt;&gt; getWorkPatternAssignments(Collection&lt;ID&gt; colWorkResourceIDs, Date dtStart, Date dtEnd, boolean isInPeriodOnly, Date timeSpot) throws BbmFinderException
	{
		try {
			//load all skills
<span class="fc" id="L103">			HashMap&lt;ID, Collection&lt;WorkResourceWorkPattern&gt;&gt; hWorkPatterns = new HashMap&lt;ID, Collection&lt;WorkResourceWorkPattern&gt;&gt;();</span>
<span class="fc" id="L104">			StringBuffer query = new StringBuffer(&quot;SELECT SHIFTPATTERN.SID,SHIFTPATTERNWORKRESOURCE.ID,WORKRESOURCEID,PREFERENCE,STARTTIME,ENDTIME FROM SHIFTPATTERNWORKRESOURCE,SHIFTPATTERN &quot;+</span>
			&quot;WHERE SHIFTPATTERN.ID = SHIFTPATTERNID AND SHIFTPATTERN.DELETEONDATE is NULL &quot; +
<span class="fc" id="L106">			&quot; AND WORKRESOURCEID IN &quot; + m_dmo.createInClause(colWorkResourceIDs));</span>

<span class="pc bpc" id="L108" title="1 of 2 branches missed.">			if (isInPeriodOnly) {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">				if( dtEnd != null ) {</span>
<span class="nc" id="L110">					query.append( &quot; AND '&quot;);</span>
<span class="nc" id="L111">					query.append( JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(dtEnd)) );</span>
<span class="nc" id="L112">					query.append( &quot;' &gt; ENDTIME &quot;);</span>
				}
				
<span class="nc bnc" id="L115" title="All 2 branches missed.">				if( dtStart != null ) {</span>
<span class="nc" id="L116">					query.append( &quot; AND ( '&quot;);</span>
<span class="nc" id="L117">					query.append( JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(dtStart)) );</span>
<span class="nc" id="L118">					query.append( &quot;' &lt; STARTTIME ) &quot;);</span>
				}				
			} else {
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">				if (timeSpot == null) {</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">					if( dtEnd != null ) {</span>
<span class="fc" id="L123">						query.append( &quot; AND '&quot;);</span>
<span class="fc" id="L124">						query.append( JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(dtEnd)) );</span>
<span class="fc" id="L125">						query.append( &quot;' &gt;= STARTTIME &quot;);</span>
					}
					
<span class="fc bfc" id="L128" title="All 2 branches covered.">					if( dtStart != null )	{</span>
<span class="fc" id="L129">						query.append( &quot; AND ( '&quot;);</span>
<span class="fc" id="L130">						query.append( JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(dtStart)) );</span>
<span class="fc" id="L131">						query.append( &quot;' &lt; ENDTIME OR ENDTIME is NULL ) &quot;);</span>
					}
				}
			}
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">			if (timeSpot != null) {</span>
<span class="nc" id="L136">				query.append( &quot; AND ( '&quot;);</span>
<span class="nc" id="L137">				query.append( JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(timeSpot)) );</span>
<span class="nc" id="L138">				query.append( &quot;' &gt;= STARTTIME ) &quot;);</span>
<span class="nc" id="L139">				query.append( &quot; AND ( '&quot;);</span>
<span class="nc" id="L140">				query.append( JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(timeSpot)) );</span>
<span class="nc" id="L141">				query.append( &quot;' &lt; ENDTIME ) &quot;);</span>
			}
<span class="fc" id="L143">			JdmoRowset r = m_dmo.createRowset( query.toString() );</span>
			
			//-------------------------------------------------
			// get data and create skills
			//-------------------------------------------------
			
<span class="fc bfc" id="L149" title="All 2 branches covered.">			while(r.next()) {</span>
				
<span class="fc" id="L151">				ID idWorkPattern = r.getID(&quot;SID&quot;);</span>
<span class="fc" id="L152">				ID idEmployee = r.getID(&quot;WORKRESOURCEID&quot;);</span>
<span class="fc" id="L153">				ID idWrwp = r.getID(&quot;ID&quot;);</span>
<span class="fc" id="L154">				int nPreference = r.getInt(&quot;PREFERENCE&quot;);</span>
<span class="fc" id="L155">				Date start = r.getTimestamp(&quot;STARTTIME&quot;);</span>
<span class="fc" id="L156">				Date end = r.getTimestamp(&quot;ENDTIME&quot;);</span>
				
<span class="fc" id="L158">				WorkResourceWorkPattern pWorkPattern = new WorkResourceWorkPattern();</span>
<span class="fc" id="L159">				pWorkPattern.setID(idWrwp);</span>
<span class="fc" id="L160">				pWorkPattern.setWorkPatternSID(idWorkPattern);</span>
<span class="fc" id="L161">				pWorkPattern.setWorkResourceID(idEmployee);</span>
<span class="fc" id="L162">				pWorkPattern.setPreference(nPreference);</span>
<span class="fc" id="L163">				pWorkPattern.setStartTime(start);</span>
<span class="fc" id="L164">				pWorkPattern.setEndTime(end);				</span>
				
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">				if (hWorkPatterns.get(idEmployee) == null)</span>
<span class="fc" id="L167">					hWorkPatterns.put(idEmployee, new ArrayList&lt;WorkResourceWorkPattern&gt;());</span>
				
<span class="fc" id="L169">				hWorkPatterns.get(idEmployee).add(pWorkPattern);</span>
<span class="fc" id="L170">			}</span>
						
<span class="fc" id="L172">			return hWorkPatterns;			</span>
<span class="nc" id="L173">		} catch(JdmoException e) {			</span>
<span class="nc" id="L174">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L176">			m_dmo.cleanUp();</span>
		}
	}
    
    /** create a work pattern assignment */
    public ID createWorkPatternAssignment(WorkResourceWorkPattern objValue) throws BbmCreateException
    {
    	try {
<span class="fc" id="L184">    		objValue.setID(new ID(DAOUtil.getDEID(m_dmo)));</span>
<span class="fc" id="L185">    		objValue = convertSIDtoDEID(objValue);</span>
    		//try to merge first
<span class="fc" id="L187">			super.merge(objValue);</span>
<span class="fc" id="L188">	        return super.createNoOverlapAssignment(objValue, </span>
	              WorkResourceWorkPatternFieldInfo.WRKRESWORKPATTERN_WORKRESOURCEID, 
	              WorkResourceWorkPatternFieldInfo.WRKRESWORKPATTERN_WORKPATTERNID);
<span class="nc" id="L191">    	} catch (Exception ex) {</span>
<span class="nc" id="L192">    		throw new BbmCreateException(ex);</span>
    	}
    }    
    	
    /** 
     *  update a work pattern assignment
     *  @param bSaveAsNew where save as new assignment or replace existing one
     * 
     */
    public void updateWorkPatternAssignment(WorkResourceWorkPattern objValue, boolean bSaveAsNew) throws MultiUserException, BbmUpdateException
    {
    	try {
<span class="nc" id="L204">    		objValue = convertSIDtoDEID(objValue);</span>
    		//try to merge first
<span class="nc" id="L206">			super.merge(objValue);</span>
			
<span class="nc" id="L208">    		super.updateNoOverlapAssignment(objValue, </span>
              WorkResourceWorkPatternFieldInfo.WRKRESWORKPATTERN_WORKRESOURCEID, 
              WorkResourceWorkPatternFieldInfo.WRKRESWORKPATTERN_WORKPATTERNID, 
              bSaveAsNew);
<span class="nc" id="L212">		} catch (BbmFinderException ex) {</span>
<span class="nc" id="L213">			throw new BbmUpdateException(ex);</span>
<span class="nc" id="L214">		}</span>
<span class="nc" id="L215">    }</span>
   
    /** delete work pattern assignments */
    public void deleteWorkPatternAssignments(Collection&lt;ID&gt; colIDAssignments) throws BbmRemoveException
    {
<span class="nc" id="L220">         deleteObjects(colIDAssignments);</span>
<span class="nc" id="L221">    }	</span>
    
    public Collection getWorkPatternAssignmentsByIDs(Collection colIDSAs) throws BbmFinderException
    {
<span class="nc" id="L225">        return this.getObjectsByIDs(colIDSAs);</span>
    }
    
    /**
    *  get WorkPatternAssignments where the WorkPattern's SHIFTWORKPATTERNSETID = idSet.  
    *  This method would be useful in scheduling with a Work Pattern Set filter and 
    *  for deleting and updated Work Pattern Sets.
    */
    public HashMap getWorkPatternAssignmentsBySet(Collection colIDs, Date dtStart, Date dtEnd, ID idWorkPatternSet)
        throws BbmFinderException
    {
<span class="nc bnc" id="L236" title="All 4 branches missed.">        if (colIDs == null || colIDs.size() &lt; 1) return new HashMap();</span>
        
<span class="nc" id="L238">        int iField = WorkResourceWorkPatternFieldInfo.WRKRESWORKPATTERN_WORKRESOURCEID;</span>
		try
		{
<span class="nc" id="L241">			StringBuffer strWhere = new StringBuffer(30);</span>
<span class="nc" id="L242">			String strFieldName = getFieldInfo().getFieldName(iField);</span>
<span class="nc" id="L243">			strWhere.append(&quot;A.&quot;).append(strFieldName);</span>
<span class="nc" id="L244">			strWhere.append(&quot; in &quot;).append(m_dmo.createInClause(colIDs));</span>
<span class="nc" id="L245">            strWhere.append(&quot; AND A.WORKPATTERNID in (select distinct ID from WORKPATTERN where SHIFTWORKPATTERNSETID = &quot;).append(idWorkPatternSet).append(&quot;)&quot;);</span>

<span class="nc bnc" id="L247" title="All 2 branches missed.">			if (dtStart != null)</span>
			{
<span class="nc" id="L249">				 String strStart = &quot;'&quot; + JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(dtStart)) + &quot;'&quot;;</span>
<span class="nc" id="L250">				 strWhere.append(&quot; AND (A.ENDTIME IS NULL OR A.ENDTIME &gt; &quot; + strStart + &quot;)&quot;);</span>
			}

<span class="nc bnc" id="L253" title="All 2 branches missed.">			if (dtEnd != null)</span>
			{
<span class="nc" id="L255">				String strEnd = &quot;'&quot; + JdmoUtil.formatDBString(TimeZoneUtil.toTimestamp(dtEnd)) + &quot;'&quot;;</span>
<span class="nc" id="L256">				strWhere.append(&quot; AND A.STARTTIME &lt;= &quot; + strEnd);</span>
			}

<span class="nc" id="L259">			strWhere.append(&quot; ORDER BY A.&quot;).append(strFieldName).append(&quot;, A.STARTTIME &quot;);</span>

<span class="nc" id="L261">			Collection items = getObjects(new String(strWhere));</span>
<span class="nc" id="L262">			return ValueObjectUtil.groupByField(iField, items);</span>
		}
<span class="nc" id="L264">		catch(JdmoException e)</span>
		{
<span class="nc" id="L266">			throw new BbmFinderException(e);</span>
		}
    }
    
    public Collection getWorkPatternIDNamePairs(Collection colOrgIDs) throws BbmFinderException {
    	try {
<span class="nc" id="L272">	    	String strQuery = &quot;select SID ID, NAME from SHIFTPATTERN WHERE DELETEONDATE IS NULL &quot;;</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">			if (!colOrgIDs.isEmpty()) {</span>
<span class="nc" id="L274">				colOrgIDs.addAll(DAOUtil.getParentOrganizationsCollection(colOrgIDs, m_dmo));</span>
<span class="nc" id="L275">				strQuery += &quot; AND ORGANIZATIONID IN &quot;	+ m_dmo.createInClause(colOrgIDs);</span>
			}
<span class="nc" id="L277">			return DAOUtil.getObjectIDNamePairs(m_dmo, strQuery);</span>
<span class="nc" id="L278">    	} catch (JdmoException ex) {</span>
<span class="nc" id="L279">    		throw new BbmFinderException(ex);</span>
    	}
    }
    
    public Collection getShiftIDNamePairs(Collection colOrgIDs) throws BbmFinderException {
    	try {
<span class="nc" id="L285">	    	String strQuery = &quot;select SID ID, NAME from SHIFT WHERE DELETEONDATE IS NULL AND ID != 'SHIFT_OFF' &quot;;</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">			if (!colOrgIDs.isEmpty()) {</span>
<span class="nc" id="L287">				colOrgIDs.addAll(DAOUtil.getParentOrganizationsCollection(colOrgIDs, m_dmo));</span>
<span class="nc" id="L288">				strQuery += &quot; AND ORGANIZATIONID IN &quot;	+ m_dmo.createInClause(colOrgIDs);</span>
			}
<span class="nc" id="L290">			return DAOUtil.getObjectIDNamePairs(m_dmo, strQuery);</span>
<span class="nc" id="L291">    	} catch (JdmoException ex) {</span>
<span class="nc" id="L292">    		throw new BbmFinderException(ex);</span>
    	}
    }
	
	private WorkResourceWorkPattern convertSIDtoDEID(WorkResourceWorkPattern obj) throws BbmFinderException{
		try {
			// Find SID to ID mapping
<span class="fc" id="L299">			StringBuffer pStmt = new StringBuffer(&quot;select ID from SHIFTPATTERN where SID=?&quot;);</span>
<span class="fc" id="L300">			JdmoQuery jq1 = m_dmo.createQuery(pStmt.toString(), Jdmo.PARAM_QUERY);</span>
<span class="fc" id="L301">			ID workPatternID = obj.getWorkPatternSID();		</span>
<span class="fc" id="L302">			jq1.setParString(1, workPatternID.toString());</span>
<span class="fc" id="L303">			JdmoRowset rs = m_dmo.createRowset(jq1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);		</span>
<span class="fc" id="L304">			String workPatternIDStr = &quot;&quot;;</span>
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">			if (rs.next()) {</span>
<span class="fc" id="L306">				workPatternIDStr = rs.getString(1);</span>
<span class="fc" id="L307">				obj.setWorkPatternID(new ID(workPatternIDStr));</span>
			}		
<span class="fc" id="L309">			return obj;</span>
<span class="nc" id="L310">		} catch (JdmoException ex) {</span>
<span class="nc" id="L311">			throw new BbmFinderException(ex);</span>
		}
	}
	
	protected boolean allowCreateWithId() {
<span class="fc" id="L316">		return true;</span>
	}
    
	
	public Collection getEffectiveAtTimeRange(ValueObjectEffectivity newObject, Date start, Date end) throws BbmFinderException {
<span class="fc" id="L321">		WorkResourceWorkPattern workPatternAssignment = (WorkResourceWorkPattern)newObject;</span>
<span class="fc" id="L322">		StringBuffer extraCriteria = new StringBuffer(200);</span>
<span class="fc" id="L323">		extraCriteria.append(getFieldInfo().getFieldName(WorkResourceWorkPatternFieldInfo.WRKRESWORKPATTERN_WORKPATTERNID));</span>
<span class="fc" id="L324">		extraCriteria.append(&quot;='&quot;).append(workPatternAssignment.getFieldValue(WorkResourceWorkPatternFieldInfo.WRKRESWORKPATTERN_WORKPATTERNID)).append(&quot;'&quot;);</span>
<span class="fc" id="L325">		extraCriteria.append(&quot; and &quot;);</span>
<span class="fc" id="L326">		extraCriteria.append(getFieldInfo().getFieldName(WorkResourceWorkPatternFieldInfo.WRKRESWORKPATTERN_PREFERENCE));</span>
<span class="fc" id="L327">		extraCriteria.append(&quot;='&quot;).append(workPatternAssignment.getPreference()).append(&quot;'&quot;);</span>
<span class="fc" id="L328">		return getEffectivityAssignments(newObject.getParentID(), WorkResourceWorkPatternFieldInfo.WRKRESWORKPATTERN_WORKRESOURCEID, start, end, extraCriteria.toString());		</span>
	 }
	
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>