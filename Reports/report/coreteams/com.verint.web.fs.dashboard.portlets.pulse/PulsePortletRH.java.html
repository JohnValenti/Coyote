<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PulsePortletRH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.dashboard.portlets.pulse</a> &gt; <span class="el_source">PulsePortletRH.java</span></div><h1>PulsePortletRH.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.dashboard.portlets.pulse;

import java.io.IOException;
import java.io.PrintWriter;
import java.io.UnsupportedEncodingException;
import java.net.URLEncoder;
import java.rmi.RemoteException;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.TimeZone;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import com.bluepumpkin.common.base.Log;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignHOO;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueueFieldInfo;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.timeseries.model.Trace;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.core.base.RequestHandler;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.verint.web.fs.dashboard.portlets.pulse.util.Constants;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.system.RequestContext;

<span class="nc" id="L52">public class PulsePortletRH extends RequestHandler {</span>
	private static final String dateStrParamFormat = &quot;EEEE, MMMM dd, yyyy h:mm:ss a z&quot;;
	private static final String selectedDateStrFormat = &quot;MMM dd, yyyy&quot;;
	
<span class="fc" id="L56">	private static Category log = Log.initCategory(PulsePortletRH.class.getName());</span>

<span class="nc" id="L58">	private ID campaignID = null;</span>
<span class="nc" id="L59">	private StatisticType statisticType = null;</span>
<span class="nc" id="L60">	private Date startDate = null;</span>
<span class="nc" id="L61">	private Date endDate = null;</span>
<span class="nc" id="L62">	private Date selectedDate = null;</span>
<span class="nc" id="L63">	private ID queueID = null;</span>
<span class="nc" id="L64">	private String campaignTitle = &quot;&quot;;</span>
<span class="nc" id="L65">	private String dateRangeTitle = &quot;&quot;;</span>
<span class="nc" id="L66">	private Integer maxYValue = null;</span>
<span class="nc" id="L67">	private Localizer localizer = null;</span>
<span class="nc" id="L68">	private HttpServletRequest request = null;</span>
<span class="nc" id="L69">	private Boolean trimToHOO = null;</span>
<span class="nc" id="L70">	private String errorProcessingRequest = null;</span>
<span class="nc" id="L71">	private RequestContext m_context = null;</span>
	
	/**
	 * This method is the entry point for pulse portlet requests. It will call
	 * for the params in the request to be processed and then channel the
	 * request to the appropriate helper method based on the &quot;action&quot; param.
	 *
	 * @param context the request context
	 * &lt;p/&gt;
	 * @throws Exception
	 */
	@Override
	public void processRequest(RequestContext context) throws Exception {
<span class="nc" id="L84">		JSONObject errorProcessingRequestMessage = new JSONObject();</span>
<span class="nc" id="L85">		HttpServletResponse response = context.getResponse();</span>
<span class="nc" id="L86">		request = context.getRequest();</span>
<span class="nc" id="L87">		localizer = context.getLocalizer();</span>
<span class="nc" id="L88">		m_context = context;</span>

<span class="nc" id="L90">		processArgs(context);</span>

<span class="nc bnc" id="L92" title="All 2 branches missed.">		if (errorProcessingRequest == null) {</span>

			// define the action
<span class="nc" id="L95">			String action = request.getParameter(&quot;action&quot;);</span>

			// process according to the requested action
<span class="nc bnc" id="L98" title="All 2 branches missed.">			if (action.equals(&quot;getCampaignQueuesData&quot;)) {</span>
<span class="nc" id="L99">				JSONObject campaignQueuesData = getCampaignQueuesData();</span>
<span class="nc" id="L100">				sendBackData(response, campaignQueuesData);</span>
<span class="nc" id="L101">			}</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">			else if (action.equals(&quot;getPortletTableData&quot;)) {</span>
<span class="nc" id="L103">				JSONObject pulseViewData = getPortletTableData(context);</span>
<span class="nc" id="L104">				sendBackData(response, pulseViewData);</span>
<span class="nc" id="L105">			}</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">			else if (action.equals(&quot;getPortletChartData&quot;)) {</span>
<span class="nc" id="L107">				JSONObject portletChartData = getPortletChartData(context);</span>
<span class="nc" id="L108">				sendBackData(response, portletChartData);</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">			} else if (action.equals(&quot;hasCalendarViewPrivilege&quot;)) {</span>
<span class="nc" id="L110">				boolean isAuthorized = context.getUser().isAuthorized(PrivilegeKeys.FS_VIEWCALENDAR);</span>
<span class="nc" id="L111">				response.setCharacterEncoding(&quot;UTF-8&quot;);</span>
<span class="nc" id="L112">				response.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);</span>

				// Get the print writer object from response to write the required json object to the output stream
<span class="nc" id="L115">				PrintWriter out = null;</span>
				try {
<span class="nc" id="L117">					out = response.getWriter();</span>
<span class="nc" id="L118">					out.print(isAuthorized);</span>
				}
				finally {
<span class="nc" id="L121">					out.close();</span>
<span class="nc" id="L122">				}</span>
			}
			
<span class="nc" id="L125">		} else {</span>
<span class="nc" id="L126">			errorProcessingRequestMessage.put(&quot;status&quot;, &quot;Fail&quot;);</span>
<span class="nc" id="L127">			errorProcessingRequestMessage.put(&quot;message&quot;, errorProcessingRequest);</span>
<span class="nc" id="L128">			sendBackData(response, errorProcessingRequestMessage);</span>
		}
<span class="nc" id="L130">	}</span>

	/**
	 * This method will process the params found in the request, and if any
	 * essential params are missing it will assign some default value so the
	 * user can begin using the portlet at a hopefully usable point.
	 *
	 * @param context a request context
	 * &lt;p/&gt;
	 * @throws Exception
	 */
	private void processArgs(RequestContext context)
		throws Exception
	{
<span class="nc" id="L144">		CampaignManager campaignManager = WfmManagerFactory.getCampaignManager();</span>

		// use these two calendar objects to build default values
<span class="nc" id="L147">		Calendar now = Calendar.getInstance();</span>
<span class="nc" id="L148">		Calendar weekFromNow = Calendar.getInstance();</span>
<span class="nc" id="L149">		weekFromNow.add(Calendar.DATE, 6);</span>

		// determine the campaign ID
<span class="nc" id="L152">		String campaignIDStr = request.getParameter(Constants.CAMPAIGN_ID);</span>
<span class="nc" id="L153">		TimeZone campaignTimeZone = null;</span>
		// set a default to use if one wasn't passed in
<span class="nc bnc" id="L155" title="All 2 branches missed.">		if (!isValidParameter(campaignIDStr)) {</span>
			// determine the default campaign for use in setting defaults
<span class="nc" id="L157">			Campaign defaultCampaign =</span>
<span class="nc" id="L158">				PulsePortletUtil.getDefualtCampaignForUser(context);</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">			if (defaultCampaign == null) {</span>
<span class="nc" id="L160">				errorProcessingRequest = localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.WARN_NO_CAMPAIGNS_FOUND_FOR_USER);</span>
<span class="nc" id="L161">				return;</span>
			}
<span class="nc" id="L163">			campaignID = defaultCampaign.getID();</span>
<span class="nc" id="L164">			campaignTitle = PulsePortletUtil.getCampaignName(campaignID);</span>
<span class="nc" id="L165">			campaignTimeZone = defaultCampaign.getTimeZone();</span>
<span class="nc" id="L166">		}</span>
		else {
<span class="nc" id="L168">			campaignID = new ID(campaignIDStr);</span>
<span class="nc" id="L169">			campaignTitle = PulsePortletUtil.getCampaignName(campaignID);</span>
<span class="nc" id="L170">			campaignTimeZone = campaignManager.getCampaignByID(campaignID).getTimeZone();</span>
		}

		// determine the date type
<span class="nc" id="L174">		String datetype = request.getParameter(Constants.DATE_PICKER_TYPE);</span>
		// set a default to use if no date type was passed
<span class="nc bnc" id="L176" title="All 2 branches missed.">		if (!isValidParameter(datetype)</span>
<span class="nc bnc" id="L177" title="All 4 branches missed.">			|| (!PulsePortletUtil.isDateRangeType(datetype) &amp;&amp; !PulsePortletUtil.isLastNPeriodsType(datetype))) {</span>
<span class="nc" id="L178">			datetype = LastNPeriodPickerPC.PICKER_TYPE_DATE_RANGE;</span>
		}

		// determine the start and end date string params
<span class="nc" id="L182">		String startDateStr = request.getParameter(Constants.START_DATE);</span>
<span class="nc" id="L183">		String endDateStr = request.getParameter(Constants.END_DATE);</span>
		// set the defaults for start and end for date range type
<span class="nc bnc" id="L185" title="All 2 branches missed.">		if (PulsePortletUtil.isDateRangeType(datetype)</span>
<span class="nc bnc" id="L186" title="All 4 branches missed.">			&amp;&amp; (!isValidParameter(startDateStr) || !isValidParameter(endDateStr))) {</span>
			// just setting these up with reference to GMT for now, and will redefine later
			// if we have a campaignTimeZone
<span class="nc" id="L189">			startDateStr = getDateStringAdjustedForTimeZone(now.getTime(), TimeZone.getTimeZone(&quot;GMT&quot;), dateStrParamFormat);</span>
<span class="nc" id="L190">			endDateStr = getDateStringAdjustedForTimeZone(weekFromNow.getTime(), TimeZone.getTimeZone(&quot;GMT&quot;), dateStrParamFormat);</span>
		}

		// determine the periodicity and periods
<span class="nc" id="L194">		String lastNPeriodicity = request.getParameter(Constants.DATE_LAST_N_PERIOD_TYPE);</span>
<span class="nc" id="L195">		String lastNPeriods = request.getParameter(Constants.DATE_LAST_N_PERIOD);</span>
		// set defaults to use if either wasn't passed in
<span class="nc bnc" id="L197" title="All 4 branches missed.">		if (!isValidParameter(lastNPeriodicity) || !isValidParameter(lastNPeriods)) {</span>
			// set defaults to: periods -1 (going forward 1 period), and periodicity 1 week, so from today, for 1 week
<span class="nc" id="L199">			lastNPeriods = &quot;-1&quot;;</span>
<span class="nc" id="L200">			lastNPeriodicity = String.valueOf(LastNPeriodPickerPC.PERIOD_TYPE_WEEKLY);</span>
		}

		// determine the start and end Dates for &quot;date range&quot; type
<span class="nc bnc" id="L204" title="All 2 branches missed.">		if (PulsePortletUtil.isDateRangeType(datetype)) {</span>
<span class="nc bnc" id="L205" title="All 4 branches missed.">			if (isValidParameter(startDateStr) &amp;&amp; isValidParameter(endDateStr)) {</span>
<span class="nc" id="L206">				startDate = DateFormat.getDateTimeInstance(DateFormat.FULL, DateFormat.FULL).parse(startDateStr);</span>
<span class="nc" id="L207">				endDate = DateFormat.getDateTimeInstance(DateFormat.FULL, DateFormat.FULL).parse(endDateStr);</span>
<span class="nc" id="L208">				dateRangeTitle = PulsePortletUtil.getDateRangeString(startDate, endDate, context.getLocaleContext().getLanguageLocale());</span>
			}

			// if we have a campaign time zone, set the start and end dates with it
			// we should have this for all users except those not assigned to a campaign
<span class="nc bnc" id="L213" title="All 2 branches missed.">			if (campaignTimeZone != null) {</span>
<span class="nc" id="L214">				DateFormat df = DateFormat.getDateTimeInstance(DateFormat.FULL, DateFormat.FULL);</span>
<span class="nc" id="L215">				df.setTimeZone(campaignTimeZone);</span>
<span class="nc" id="L216">				startDate = df.parse(startDateStr);</span>
<span class="nc" id="L217">				endDate = df.parse(endDateStr);</span>
<span class="nc" id="L218">				dateRangeTitle = PulsePortletUtil.getDateRangeString(startDate, endDate, context.getLocaleContext().getLanguageLocale(), campaignTimeZone);</span>
<span class="nc" id="L219">			}</span>
		}
		// determine the start and end Dates for &quot;last N periods&quot; type
<span class="nc bnc" id="L222" title="All 2 branches missed.">		else if (PulsePortletUtil.isLastNPeriodsType(datetype)) {</span>
<span class="nc" id="L223">			int periodicity = Integer.parseInt(lastNPeriodicity);</span>
<span class="nc" id="L224">			int numberOfPeriods = Integer.parseInt(lastNPeriods);</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">			if (numberOfPeriods &lt; 0) {</span>
<span class="nc" id="L226">				endDate = PulsePortletUtil.getStartDate(campaignID, periodicity, numberOfPeriods);</span>
<span class="nc" id="L227">				startDate = PulsePortletUtil.getTodayDate(campaignID);</span>
			}
			else {
<span class="nc" id="L230">				startDate = PulsePortletUtil.getStartDate(campaignID, periodicity, numberOfPeriods);</span>
<span class="nc" id="L231">				endDate = PulsePortletUtil.getTodayDate(campaignID);</span>
			}
<span class="nc" id="L233">			dateRangeTitle = PulsePortletUtil.getDatePeriodString(periodicity, numberOfPeriods, localizer);</span>
		}

		// determine the queue ID
<span class="nc" id="L237">		String queueIDStr = request.getParameter(Constants.QUEUE_ID);</span>
		// set a default to use if one wasn't passed in
<span class="nc bnc" id="L239" title="All 2 branches missed.">		if (!isValidParameter(queueIDStr)) {</span>
<span class="nc" id="L240">			List&lt;SPQueue&gt; queues = getSPQueuesForCampaign(campaignID, startDate, endDate);</span>
<span class="nc bnc" id="L241" title="All 4 branches missed.">			if (queues != null &amp;&amp; !queues.isEmpty()) {</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">				if (queues.get(0).getQueueID() == null) {</span>
<span class="nc" id="L243">					queueID = new ID(queues.get(0).getMediaID());</span>
				}
				else {
<span class="nc" id="L246">					queueID = new ID(queues.get(0).getQueueID());</span>
				}
			}
<span class="nc" id="L249">		}</span>
		else {
<span class="nc" id="L251">			queueID = new ID(Integer.parseInt(queueIDStr));</span>
		}

		// determine the StatisticType
<span class="nc" id="L255">		String statisticTypeStr = request.getParameter(Constants.STATISTIC_TYPE);</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">		if (!isValidParameter(statisticTypeStr)) {</span>
<span class="nc" id="L257">			statisticType = StatisticType.FTE;</span>
		}
		else {
<span class="nc" id="L260">			statisticType = StatisticType.getStatisticType(Integer.parseInt(statisticTypeStr));</span>
		}

		// determine the selected date (comes from selecting a row in the data table, so no default is needed)
<span class="nc" id="L264">		String selectedDateStr = request.getParameter(&quot;selectedDate&quot;);</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">		if (isValidParameter(selectedDateStr)) {</span>
<span class="nc" id="L266">			SimpleDateFormat sdf = new SimpleDateFormat(selectedDateStrFormat);</span>
<span class="nc" id="L267">			selectedDate = sdf.parse(selectedDateStr);</span>
		}

<span class="nc" id="L270">		String trimToHOOStr = request.getParameter(&quot;trimToHOO&quot;);</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">		if (!isValidParameter(trimToHOOStr)) {</span>
<span class="nc" id="L272">			trimToHOO = true;</span>
		}
		else {
<span class="nc" id="L275">			trimToHOO = Boolean.parseBoolean(trimToHOOStr);</span>
		}
<span class="nc" id="L277">	}</span>

	/**
	 * A simple parameter validity checker that will return true if the param
	 * isn't null, empty, or the string &quot;null&quot;.
	 *
	 * @param param a param to validate
	 * &lt;p/&gt;
	 * @return true if the param isn't null, empty, or the string &quot;null&quot;,
	 *		otherwise return false
	 */
	private boolean isValidParameter(String param)
	{
<span class="nc bnc" id="L290" title="All 6 branches missed.">		return !(param == null || &quot;&quot;.equals(param.trim()) || &quot;null&quot;.equals(param));</span>
	}

	/**
	 * This method will collect queue data for a given statistic type over a
	 * given time frame for a campaign and generate a json response to be passed
	 * back to the client.
	 *
	 * @param context a request context
	 * &lt;p/&gt;
	 * @return a json object holding the collected queue data for the given
	 *		statistic type, time frame and campaign
	 * &lt;p/&gt;
	 * @throws JSONException
	 * @throws UnsupportedEncodingException
	 * @throws RemoteException
	 * @throws BbmException
	 */
	private JSONObject getPortletTableData(RequestContext context)
		throws JSONException, UnsupportedEncodingException, RemoteException, BbmException
	{
<span class="nc" id="L311">		JSONObject tableData = new JSONObject();</span>
<span class="nc" id="L312">		JSONObject dataSection = new JSONObject();</span>

<span class="nc" id="L314">		JSONArray columns = new JSONArray();</span>
		// add the column headings
<span class="nc" id="L316">		JSONObject columnDate = new JSONObject();</span>
<span class="nc" id="L317">		columnDate.put(&quot;name&quot;, &quot;Date&quot;);</span>
<span class="nc" id="L318">		columnDate.put(&quot;color&quot;, &quot;#ffffff&quot;);</span>
<span class="nc" id="L319">		columns.put(columnDate);</span>

<span class="nc" id="L321">		JSONArray summaryData = new JSONArray();</span>

<span class="nc" id="L323">		JSONObject periodSummaryData = new JSONObject();</span>
<span class="nc" id="L324">		periodSummaryData.put(&quot;name&quot;, &quot;Period&quot;);</span>

<span class="nc bnc" id="L326" title="All 8 branches missed.">		if (campaignID != null &amp;&amp; startDate != null &amp;&amp; endDate != null &amp;&amp; statisticType != null) {</span>
			try {
<span class="nc" id="L328">				HashMap&lt;ID, TraceCube[]&gt; userTraceCubes = PulsePortletUtil.getUserTraceCubes(campaignID, queueID, startDate,</span>
						endDate, statisticType);
<span class="nc bnc" id="L330" title="All 4 branches missed.">				if (userTraceCubes != null &amp;&amp; userTraceCubes.size() &gt; 0) {</span>
<span class="nc" id="L331">					boolean hasForecast = statisticType.supportsForecast();</span>
<span class="nc" id="L332">					boolean hasRequired = statisticType.supportsRequired();</span>
<span class="nc" id="L333">					boolean hasActual = statisticType.supportsActual();</span>

<span class="nc" id="L335">					TimeZone campaignTimeZone = PulsePortletUtil.getCampaignTimeZone(campaignID);</span>
<span class="nc" id="L336">					SummaryData[] summaryRows = PulsePortletUtil.getSummaryData(userTraceCubes, queueID, startDate, endDate,</span>
							campaignTimeZone, statisticType);
<span class="nc bnc" id="L338" title="All 4 branches missed.">					if (summaryRows != null &amp;&amp; summaryRows.length &gt; 0) {</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">						if (hasActual) {</span>
<span class="nc" id="L340">							JSONObject columnActual = new JSONObject();</span>
<span class="nc" id="L341">							columnActual.put(&quot;name&quot;, &quot;Act&quot;);</span>
<span class="nc" id="L342">							columnActual.put(&quot;color&quot;, &quot;#ff0000&quot;);</span>
<span class="nc" id="L343">							columns.put(columnActual);</span>
						}

<span class="nc bnc" id="L346" title="All 2 branches missed.">						if (hasForecast) {</span>
<span class="nc" id="L347">							JSONObject columnForecasted = new JSONObject();</span>
<span class="nc" id="L348">							columnForecasted.put(&quot;name&quot;, &quot;For&quot;);</span>
<span class="nc" id="L349">							columnForecasted.put(&quot;color&quot;, &quot;#008000&quot;);</span>
<span class="nc" id="L350">							columns.put(columnForecasted);</span>
						}

<span class="nc bnc" id="L353" title="All 2 branches missed.">						if (hasRequired) {</span>
<span class="nc" id="L354">							JSONObject columnRequired = new JSONObject();</span>
<span class="nc" id="L355">							columnRequired.put(&quot;name&quot;, &quot;Req&quot;);</span>
<span class="nc" id="L356">							columnRequired.put(&quot;color&quot;, &quot;#0000ff&quot;);</span>
<span class="nc" id="L357">							columns.put(columnRequired);</span>
						}

<span class="nc bnc" id="L360" title="All 2 branches missed.">						for (int i = 0; i &lt; summaryRows.length; i++) {</span>
<span class="nc" id="L361">							SummaryData summaryRow = summaryRows[i];</span>
							// fill in the data for this date
<span class="nc" id="L363">							JSONObject dataRow = new JSONObject();</span>
<span class="nc" id="L364">							String spIdParam = null;</span>
<span class="nc" id="L365">							Calendar dayBegin = Calendar.getInstance();</span>
<span class="nc" id="L366">							dayBegin.setTime(summaryRow.getDate());</span>
<span class="nc" id="L367">							dayBegin.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L368">							short dayOfWeek = (short)dayBegin.get(Calendar.DAY_OF_WEEK);</span>
<span class="nc" id="L369">							CampaignHOO campaignHOO = getCampaignHOOForDay(context, campaignID, dayBegin.getTime());</span>
<span class="nc bnc" id="L370" title="All 4 branches missed.">							if (campaignHOO != null &amp;&amp; campaignHOO.isActive(dayOfWeek)) {</span>
<span class="nc" id="L371">								spIdParam = campaignHOO.getSPID().toString();</span>
							}
							// create the URL formatted date for the calendar drill link
<span class="nc" id="L374">							SimpleDateFormat format = new SimpleDateFormat(&quot;MM/dd/yyyy&quot;);</span>
<span class="nc" id="L375">							format.setTimeZone(campaignTimeZone);</span>
<span class="nc" id="L376">							String urlDate = URLEncoder.encode(format.format(summaryRow.getDate()), &quot;UTF-8&quot;);</span>
<span class="nc" id="L377">							String host = context.getContextPath();</span>

							// the no-link will be used for clean up in the client side code
<span class="nc" id="L380">							String linkURL = &quot;#no-link&quot;;</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">							if (spIdParam != null) {</span>
<span class="nc" id="L382">								linkURL = host + &quot;/control/opt_calendar?calendaraction=drilldown&amp;spid=&quot; + spIdParam + &quot;&amp;date=&quot; + urlDate;</span>
							}
<span class="nc" id="L384">							DateFormat df = DateFormat.getDateInstance();</span>
<span class="nc" id="L385">							df.setTimeZone(campaignTimeZone);</span>
<span class="nc" id="L386">							dataRow.put(&quot;displayDate&quot;, df.format(summaryRow.getDate()));</span>
<span class="nc" id="L387">							dataRow.put(&quot;linkURL&quot;, linkURL);</span>

<span class="nc" id="L389">							JSONArray dataColumns = new JSONArray();</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">							if (hasActual) {</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">								if (summaryRow.getActual() &gt; Trace.TRACEOFF) {</span>
<span class="nc" id="L392">									dataColumns.put(summaryRow.getActual());</span>
								}
								else {
<span class="nc" id="L395">									dataColumns.put(&quot;&quot;);</span>
								}
							}

<span class="nc bnc" id="L399" title="All 2 branches missed.">							if (hasForecast) {</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">								if (summaryRow.getForecasted() &gt; Trace.TRACEOFF) {</span>
<span class="nc" id="L401">									dataColumns.put(summaryRow.getForecasted());</span>
								}
								else {
<span class="nc" id="L404">									dataColumns.put(&quot;&quot;);</span>
								}
							}

<span class="nc bnc" id="L408" title="All 2 branches missed.">							if (hasRequired) {</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">								if (summaryRow.getRequired() &gt; Trace.TRACEOFF) {</span>
<span class="nc" id="L410">									dataColumns.put(summaryRow.getRequired());</span>
								}
								else {
<span class="nc" id="L413">									dataColumns.put(&quot;&quot;);</span>
								}
							}
<span class="nc" id="L416">							dataRow.put(&quot;cols&quot;, dataColumns);</span>
<span class="nc" id="L417">							summaryData.put(dataRow);</span>
						}

						// get the period summary and display it.
<span class="nc" id="L421">						SummaryData periodSummary = PulsePortletUtil.getPeriodSummaryData();</span>
<span class="nc" id="L422">						JSONArray summaryColumns = new JSONArray();</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">						if (periodSummary != null) {</span>

<span class="nc bnc" id="L425" title="All 2 branches missed.">							if (hasActual) {</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">								if (periodSummary.getActual() &gt; Trace.TRACEOFF) {</span>
<span class="nc" id="L427">									summaryColumns.put(periodSummary.getActual());</span>
								}
								else {
<span class="nc" id="L430">									summaryColumns.put(&quot;&quot;);</span>
								}
							}

<span class="nc bnc" id="L434" title="All 2 branches missed.">							if (hasForecast) {</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">								if (periodSummary.getForecasted() &gt; Trace.TRACEOFF) {</span>
<span class="nc" id="L436">									summaryColumns.put(periodSummary.getForecasted());</span>
								}
								else {
<span class="nc" id="L439">									summaryColumns.put(&quot;&quot;);</span>
								}
							}

<span class="nc bnc" id="L443" title="All 2 branches missed.">							if (hasRequired) {</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">								if (periodSummary.getRequired() &gt; Trace.TRACEOFF) {</span>
<span class="nc" id="L445">									summaryColumns.put(periodSummary.getRequired());</span>
								}
								else {
<span class="nc" id="L448">									summaryColumns.put(&quot;&quot;);</span>
								}
							}
						}
<span class="nc" id="L452">						periodSummaryData.put(&quot;cols&quot;, summaryColumns);</span>
					}
				}
<span class="nc" id="L455">				dataSection.put(&quot;campaignTitle&quot;, campaignTitle);</span>
<span class="nc" id="L456">				dataSection.put(&quot;dateRangeTitle&quot;, dateRangeTitle);</span>
<span class="nc" id="L457">				dataSection.put(&quot;columns&quot;, columns);</span>
<span class="nc" id="L458">				dataSection.put(&quot;summaryData&quot;, summaryData);</span>
<span class="nc" id="L459">				dataSection.put(&quot;periodSummaryData&quot;, periodSummaryData);</span>

<span class="nc" id="L461">				tableData.put(&quot;status&quot;, &quot;Pass&quot;);</span>
<span class="nc" id="L462">				tableData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.PASS_TABLE_DATA_GENERATED));</span>
<span class="nc" id="L463">				tableData.put(&quot;data&quot;, dataSection);</span>
			}
<span class="nc" id="L465">			catch (Exception ex) {</span>
<span class="nc" id="L466">				tableData.put(&quot;status&quot;, &quot;Fail&quot;);</span>
<span class="nc" id="L467">				tableData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.ERROR_TABLE_DATA_GENERATING) + ex.getClass().getSimpleName());</span>
<span class="nc" id="L468">				log.error(&quot;PulsePortletRH.getPortletTableData encountered an error!&quot;, ex);</span>
<span class="nc" id="L469">			}</span>
		}
		else {
<span class="nc" id="L472">			tableData.put(&quot;status&quot;, &quot;Fail&quot;);</span>
<span class="nc" id="L473">			tableData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.ERROR_TABLE_DATA_MISSING_PARAMS));</span>
		}

//		response = {
//			status: &quot;Pass&quot;,
//			message: &quot;All's well on the western front...&quot;,
//			data: {
//				campaignTitle: &quot;Some Campaign Title&quot;,
//				dateRangeTitle: &quot;Apr 1, 2004 - Apr 30, 2004&quot;,
//				columns: [
//					{ name: &quot;Date&quot;, color: &quot;#ffffff&quot; },
//					{ name: &quot;Actual&quot;, color: &quot;#FF0000&quot; },
//					{ name: &quot;Forecasted&quot;, color: &quot;#008000&quot; },
//					{ name: &quot;Required&quot;, color: &quot;#0000FF&quot; }
//				],
//				data: [
//					{ displayDate: &quot;le 01/01/2012&quot;, linkURL: &quot;http://...?calendaraction=drilldown&amp;spid=166&amp;date=01%2f01%2f2012&quot;, cols: [ 100, 110, 120 ] },
//					{ displayDate: &quot;le 01/02/2012&quot;, linkURL: &quot;http://...?calendaraction=drilldown&amp;spid=166&amp;date=01%2f02%2f2012&quot;, cols: [ 200, 210, 220 ] },
//					{ displayDate: &quot;le 01/03/2012&quot;, linkURL: &quot;http://...?calendaraction=drilldown&amp;spid=166&amp;date=01%2f03%2f2012&quot;, cols: [ 300, 310, 320 ] }
//				],
//				summary: { name: Period, cols: [ 300, 310, 320 ]  }
//			}
//		}
<span class="nc" id="L496">		return tableData;</span>
	}

	/**
	 * This method will collect queue data for a given statistic type for a
	 * given day of a campaign and generate a json response to be passed back to
	 * the client.
	 *
	 * @param context a request context
	 * &lt;p/&gt;
	 * @return a json object holding the queue data for a given statistic type
	 *		for a given day of a campaign
	 * &lt;p/&gt;
	 * @throws JSONException
	 * @throws RemoteException
	 * @throws BbmException
	 */
	private JSONObject getPortletChartData(RequestContext context)
		throws JSONException, RemoteException, BbmException
	{
<span class="nc" id="L516">		maxYValue = new Integer(1);</span>
<span class="nc" id="L517">		JSONObject chartData = new JSONObject();</span>

		// the time series is set to 15 minute intervals
<span class="nc" id="L520">		Integer[] times = new Integer[] {0, 15, 30, 45, 60, 75, 90, 105, 120, 135, 150, 165,</span>
<span class="nc" id="L521">			180, 195, 210, 225, 240, 255, 270, 285, 300, 315, 330, 345, 360, 375,</span>
<span class="nc" id="L522">			390, 405, 420, 435, 450, 465, 480, 495, 510, 525, 540, 555, 570, 585,</span>
<span class="nc" id="L523">			600, 615, 630, 645, 660, 675, 690, 705, 720, 735, 750, 765, 780, 795,</span>
<span class="nc" id="L524">			810, 825, 840, 855, 870, 885, 900, 915, 930, 945, 960, 975, 990, 1005,</span>
<span class="nc" id="L525">			1020, 1035, 1050, 1065, 1080, 1095, 1110, 1125, 1140, 1155, 1170, 1185,</span>
<span class="nc" id="L526">			1200, 1215, 1230, 1245, 1260, 1275, 1290, 1305, 1320, 1335, 1350, 1365,</span>
<span class="nc" id="L527">			1380, 1395, 1410, 1425};</span>

<span class="nc bnc" id="L529" title="All 12 branches missed.">		if (campaignID != null &amp;&amp; startDate != null &amp;&amp; endDate != null &amp;&amp; statisticType != null &amp;&amp; selectedDate != null &amp;&amp; trimToHOO != null) {</span>
			try {
<span class="nc" id="L531">				Date selectedDateStartDate = PulsePortletUtil.getCampaignStartOfDayForDate(campaignID, selectedDate);</span>
<span class="nc" id="L532">				Date selectedDateEndDate = PulsePortletUtil.getCampaignEndOfDayForDate(campaignID, selectedDate);</span>

<span class="nc" id="L534">				HashMap&lt;ID, TraceCube[]&gt; userTraceCubes = PulsePortletUtil.getUserTraceCubes(campaignID, queueID, selectedDateStartDate, selectedDateEndDate, statisticType);</span>

<span class="nc bnc" id="L536" title="All 2 branches missed.">				if (userTraceCubes != null) {</span>
<span class="nc" id="L537">					DayDetailData dayDetail = PulsePortletUtil.getDayDetail(userTraceCubes, queueID, selectedDateStartDate, selectedDateEndDate, statisticType);</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">					if (dayDetail != null) {</span>
						try {
<span class="nc" id="L540">							Integer[] forecastedDayDetail = dayDetail.getForecasted();</span>
<span class="nc" id="L541">							Integer[] requiredDayDetail = dayDetail.getRequired();</span>
<span class="nc" id="L542">							Integer[] actualDayDetail = dayDetail.getActual();</span>

							// adjusting the selected date for TZ
<span class="nc" id="L545">							Calendar day = Calendar.getInstance();</span>
<span class="nc" id="L546">							day.setTime(selectedDate);</span>
<span class="nc" id="L547">							short dayOfWeek = (short)day.get(Calendar.DAY_OF_WEEK);</span>

<span class="nc" id="L549">							CampaignHOO campaignHOO = getCampaignHOOForDay(context, campaignID, selectedDate);</span>
							// we do want to trim it, and it's trimmable
<span class="nc bnc" id="L551" title="All 6 branches missed.">							if (trimToHOO &amp;&amp; (campaignHOO != null &amp;&amp; campaignHOO.isActive(dayOfWeek))) {</span>
<span class="nc" id="L552">								int startOfDayIndex = campaignHOO.getDayOpen(dayOfWeek) / 15;</span>
<span class="nc" id="L553">								int endOfDayIndex = campaignHOO.getDayClose(dayOfWeek) / 15;</span>

<span class="nc" id="L555">								forecastedDayDetail = trimToHOO(forecastedDayDetail, startOfDayIndex, endOfDayIndex);</span>
<span class="nc" id="L556">								requiredDayDetail = trimToHOO(requiredDayDetail, startOfDayIndex, endOfDayIndex);</span>
<span class="nc" id="L557">								actualDayDetail = trimToHOO(actualDayDetail, startOfDayIndex, endOfDayIndex);</span>
<span class="nc" id="L558">								times = trimToHOO(times, startOfDayIndex, endOfDayIndex);</span>
<span class="nc" id="L559">								chartData.put(&quot;status&quot;, &quot;Pass&quot;);</span>
<span class="nc" id="L560">								chartData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.PASS_CHART_DATA_GENERATED));</span>
<span class="nc" id="L561">							}</span>
							// we do want to trim it, and it is not trimmable
<span class="nc bnc" id="L563" title="All 6 branches missed.">							else if (trimToHOO &amp;&amp; (campaignHOO == null || !campaignHOO.isActive(dayOfWeek))) {</span>
<span class="nc" id="L564">								chartData.put(&quot;status&quot;, &quot;Warn&quot;);</span>
<span class="nc" id="L565">								chartData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.WARN_CHART_DATA_NO_HOO));</span>
							}
							// we do not want to trim it
<span class="nc bnc" id="L568" title="All 2 branches missed.">							else if (!trimToHOO) {</span>
<span class="nc" id="L569">								chartData.put(&quot;status&quot;, &quot;Pass&quot;);</span>
<span class="nc" id="L570">								chartData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.PASS_CHART_DATA_GENERATED));</span>
							}
<span class="nc" id="L572">							setMaxYValue(forecastedDayDetail);</span>
<span class="nc" id="L573">							setMaxYValue(requiredDayDetail);</span>
<span class="nc" id="L574">							setMaxYValue(actualDayDetail);</span>
<span class="nc" id="L575">							chartData.put(&quot;title&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, statisticType.getName()));</span>
<span class="nc" id="L576">							chartData.put(&quot;forecasted&quot;, forecastedDayDetail);</span>
<span class="nc" id="L577">							chartData.put(&quot;required&quot;, requiredDayDetail);</span>
<span class="nc" id="L578">							chartData.put(&quot;actual&quot;, actualDayDetail);</span>
<span class="nc" id="L579">							chartData.put(&quot;time&quot;, times); // this defines the x axis</span>
<span class="nc" id="L580">							chartData.put(&quot;maxYvalue&quot;, maxYValue.intValue());</span>
						}
<span class="nc" id="L582">						catch(JSONException jse) {</span>
<span class="nc" id="L583">							log.error(&quot;PulsePortletRH.getPortletChartData encountered an error!&quot;, jse);</span>
<span class="nc" id="L584">						}</span>
					}
				}
			}
<span class="nc" id="L588">			catch (Exception ex) {</span>
<span class="nc" id="L589">				chartData.put(&quot;status&quot;, &quot;Fail&quot;);</span>
<span class="nc" id="L590">				chartData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.ERROR_CHART_DATA_GENERATING) + ex.getClass().getSimpleName());</span>
<span class="nc" id="L591">				log.error(&quot;PulsePortletRH.getPortletChartData encountered an error!&quot;, ex);</span>
<span class="nc" id="L592">			}</span>
		}
		else {
			try {
<span class="nc" id="L596">				chartData.put(&quot;status&quot;, &quot;Fail&quot;);</span>
<span class="nc" id="L597">				chartData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.ERROR_CHART_DATA_MISSING_PARAMS));</span>
			}
<span class="nc" id="L599">			catch(JSONException jse) {</span>
<span class="nc" id="L600">				log.error(&quot;PulsePortletRH.getPortletChartData encountered an error!&quot;, jse);</span>
<span class="nc" id="L601">			}</span>
		}
<span class="nc" id="L603">		return chartData;</span>
	}

	/**
	 * This method will trim a given data set to contain only those values
	 * bound within the hours of operation and return a new int array based on
	 * those values.
	 *
	 * @param intArray an Integer array to trim
	 * @param startIndex the index at which to start trimming
	 * @param endIndex the index at which to end trimming
	 * &lt;p/&gt;
	 * @return a new Integer array trimmed according to the given indices
	 */
	private Integer[] trimToHOO(Integer[] intArray, int startIndex, int endIndex)
	{
<span class="nc" id="L619">		Integer[] newValues = null;</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">		if (intArray != null) {</span>
<span class="nc" id="L621">			int size = endIndex - startIndex;</span>
<span class="nc" id="L622">			newValues = new Integer[size];</span>

<span class="nc" id="L624">			int index = 0;</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">			for (int i = startIndex; i &lt; endIndex; i++) {</span>
<span class="nc" id="L626">				newValues[index] = intArray[i];</span>
<span class="nc" id="L627">				index++;</span>
			}
		}
<span class="nc" id="L630">		return newValues;</span>
	}

	/**
	 * This method will set the &lt;code&gt;maxYValue&lt;/code&gt; to the largest value
	 * found in &lt;code&gt;intArray&lt;/code&gt;. This value will get passed back to the
	 * client code and can be used to set the size of the Y axis for charting.
	 *
	 * @param intArray an array of Integer values
	 */
	private void setMaxYValue(Integer[] intArray)
	{
<span class="nc bnc" id="L642" title="All 2 branches missed.">		if (intArray != null) {</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">			for (int i = 0; i &lt; intArray.length; i++) {</span>
<span class="nc bnc" id="L644" title="All 4 branches missed.">				if (intArray[i] != null &amp;&amp; intArray[i] &gt; maxYValue.intValue()) {</span>
<span class="nc" id="L645">					maxYValue = new Integer(intArray[i]);</span>
				}
			}
		}
<span class="nc" id="L649">	}</span>

	/**
	 * This method will collate queue information for a given campaign and
	 * generate a json object to be passed back to the client.
	 *
	 * @return a json object holding the collected queue information for the
	 *		given campaign
	 * &lt;p/&gt;
	 * @throws JSONException
	 */
	private JSONObject getCampaignQueuesData()
		throws JSONException
	{
<span class="nc" id="L663">		JSONObject campaignQueuesData = new JSONObject();</span>
<span class="nc" id="L664">		JSONArray queueArray = new JSONArray();</span>

//		response = {
//			queues: [
//				{ name: &quot;Phone Queue&quot;, id: &quot;22&quot; },
//				{ name: &quot;Email Queue&quot;, id: &quot;43&quot; }
//			]
//		}
<span class="nc bnc" id="L672" title="All 8 branches missed.">		if (campaignID != null &amp;&amp; startDate != null &amp;&amp; endDate != null &amp;&amp; localizer != null) {</span>
			try {
<span class="nc" id="L674">				List&lt;SPQueue&gt; spQueues = getSPQueuesForCampaign(campaignID, startDate, endDate);</span>

<span class="nc bnc" id="L676" title="All 4 branches missed.">				if (spQueues != null &amp;&amp; !spQueues.isEmpty()) {</span>
					ID id;
<span class="nc bnc" id="L678" title="All 2 branches missed.">					for (SPQueue spQueue : spQueues) {</span>
<span class="nc" id="L679">						String indent = &quot;&quot;;</span>
						// if it's a normal queue, its queue ID will not be null
<span class="nc bnc" id="L681" title="All 2 branches missed.">						if (spQueue.getQueueID() != null) {</span>
<span class="nc" id="L682">							id = spQueue.getQueueID();</span>
							// look for this queue's combined queue, and if there is one
							// indent this queue
<span class="nc bnc" id="L685" title="All 2 branches missed.">							for (int i = 0; i &lt; spQueues.size(); i++) {</span>
<span class="nc bnc" id="L686" title="All 4 branches missed.">								if (spQueues.get(i).getMediaID().equals(spQueue.getMediaID()) &amp;&amp; spQueues.get(i).getQueueID() == null) {</span>
<span class="nc" id="L687">									indent = &quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;;</span>
								}
							}
						}
						// if it's a combined queue, its media ID will be used as its ID
						else {
<span class="nc" id="L693">							id = spQueue.getMediaID();</span>
						}
<span class="nc" id="L695">						JSONObject queueRow = new JSONObject();</span>
<span class="nc" id="L696">						queueRow.put(&quot;name&quot;, indent + PulsePortletUtil.getQueueOrMediaName(id, localizer));</span>
<span class="nc" id="L697">						queueRow.put(&quot;id&quot;, id);</span>
<span class="nc" id="L698">						queueArray.put(queueRow);</span>
<span class="nc" id="L699">					}</span>
<span class="nc" id="L700">					campaignQueuesData.put(&quot;status&quot;, &quot;Pass&quot;);</span>
<span class="nc" id="L701">					campaignQueuesData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.PASS_QUEUE_DATA_GENERATED));</span>
<span class="nc" id="L702">					campaignQueuesData.put(&quot;queues&quot;, queueArray);</span>
				}
				else {
<span class="nc" id="L705">					campaignQueuesData.put(&quot;status&quot;, &quot;Warn&quot;);</span>
<span class="nc" id="L706">					campaignQueuesData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.WARN_QUEUE_DATA_NO_HOO));</span>
				}
			}
<span class="nc" id="L709">			catch (Exception ex) {</span>
<span class="nc" id="L710">				campaignQueuesData.put(&quot;status&quot;, &quot;Fail&quot;);</span>
<span class="nc" id="L711">				campaignQueuesData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.ERROR_QUEUE_DATA_GENERATING));</span>
<span class="nc" id="L712">				log.error(&quot;PulsePortletRH.getCampaignQueuesData encountered an error!&quot;, ex);</span>
<span class="nc" id="L713">			}</span>
		}
		else {
<span class="nc" id="L716">			campaignQueuesData.put(&quot;status&quot;, &quot;Fail&quot;);</span>
<span class="nc" id="L717">			campaignQueuesData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.ERROR_QUEUE_DATA_MISSING_PARAMS));</span>
		}
<span class="nc" id="L719">		return campaignQueuesData;</span>
	}

	/**
	 * This method will return a list of all campaign SP queues within a date
	 * range, including combined queues. The returned &lt;code&gt;Collection&lt;/code&gt;
	 * will have any combined queues grouped along with their constituent
	 * queues, at an index just below the first constituent (e.g. combined queue
	 * index = n, first constituent queue index = n + 1).
	 *
	 * @param campaignID a campaign ID
	 * @param startDate a start date
	 * @param endDate an end date
	 * &lt;p/&gt;
	 * @return a list of all campaign SP queues within a date range, including
	 *		combined queues
	 * &lt;p/&gt;
	 * @throws BbmEJBCreateException
	 * @throws BbmFinderException
	 * @throws RemoteException
	 */
	private List&lt;SPQueue&gt; getSPQueuesForCampaign(
		ID campaignID,
		Date startDate,
		Date endDate)
		throws BbmFinderException, RemoteException, BbmEJBCreateException
	{
<span class="nc" id="L746">		CampaignManager campaignManager = WfmManagerFactory.getCampaignManager();</span>
<span class="nc" id="L747">		List&lt;SPQueue&gt; spQueuesGrouped = new ArrayList&lt;SPQueue&gt;();</span>
<span class="nc bnc" id="L748" title="All 6 branches missed.">		if (campaignID != null &amp;&amp; startDate != null &amp;&amp; endDate != null) {</span>

<span class="nc" id="L750">			ArrayList&lt;SchedulingPeriod&gt; schedulingPeriods =</span>
<span class="nc" id="L751">				new ArrayList&lt;SchedulingPeriod&gt;(campaignManager.getSchedulingPeriods(campaignID, startDate, endDate));</span>
<span class="nc" id="L752">			ArrayList&lt;ID&gt; schedulingPeriodIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">			for (SchedulingPeriod schedulingPeriod : schedulingPeriods) {</span>
<span class="nc" id="L754">				schedulingPeriodIDs.add(schedulingPeriod.getID());</span>
<span class="nc" id="L755">			}</span>

<span class="nc" id="L757">			Collection&lt;SPQueue&gt; spQueues = new HashSet&lt;SPQueue&gt;(campaignManager.getSPQueuesBySPIDsFixed(schedulingPeriodIDs));</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">			if (spQueues.size() &gt; 1) {</span>
<span class="nc" id="L759">				spQueuesGrouped = getGroupedSpQueueList(spQueues);</span>
			} else {
<span class="nc" id="L761">				spQueuesGrouped = new ArrayList&lt;SPQueue&gt;(spQueues);</span>
			}
		}
<span class="nc" id="L764">		return spQueuesGrouped;</span>
	}
	
	private List&lt;SPQueue&gt; getGroupedSpQueueList(Collection&lt;SPQueue&gt; spQueues) throws BbmEJBCreateException, BbmFinderException, RemoteException {
<span class="nc" id="L768">		List&lt;SPQueue&gt; retVal = new ArrayList&lt;SPQueue&gt;();</span>
<span class="nc" id="L769">		CampaignManager campaignMgr = WfmManagerFactory.getCampaignManager(m_context.isInWhatIfMode());</span>
		//The given list of spQueues does not contain any combined queues, so find the combined queues associated to these queues
<span class="nc" id="L771">		Collection&lt;SPQueue&gt; spQueuesCombined = campaignMgr.getCombinedSPQueues(spQueues);</span>
		
		//Retrieve only one combined queue per media type, and group them along with the unique constituent queues for each media type.
<span class="nc" id="L774">		Map&lt;ID, Collection&lt;SPQueue&gt;&gt; mediaIdToCombinedSpQueues = ValueObjectUtil.groupByField(SPQueueFieldInfo.SPQUEUE_MEDIAID, spQueuesCombined);</span>
<span class="nc" id="L775">		Map&lt;ID, Collection&lt;SPQueue&gt;&gt; mediaIdToSpQueues = ValueObjectUtil.groupByField(SPQueueFieldInfo.SPQUEUE_MEDIAID, spQueues);</span>
<span class="nc bnc" id="L776" title="All 2 branches missed.">		for (ID mediaID : mediaIdToCombinedSpQueues.keySet()) {</span>
<span class="nc" id="L777">			Collection&lt;SPQueue&gt; combinedSpQueuesForMedia = mediaIdToCombinedSpQueues.get(mediaID);</span>
<span class="nc" id="L778">			SPQueue combinedSpQueue = combinedSpQueuesForMedia.iterator().next();</span>
<span class="nc" id="L779">			retVal.add(combinedSpQueue);</span>
<span class="nc" id="L780">			Collection&lt;SPQueue&gt; constituentQueues = mediaIdToSpQueues.get(combinedSpQueue.getMediaID());</span>

<span class="nc bnc" id="L782" title="All 4 branches missed.">			if (constituentQueues != null &amp;&amp; !constituentQueues.isEmpty()) {</span>
<span class="nc" id="L783">				Map&lt;ID, Collection&lt;SPQueue&gt;&gt; queueIdToSpQueues = ValueObjectUtil.groupByField(SPQueueFieldInfo.SPQUEUE_QUEUEID, constituentQueues);</span>
<span class="nc bnc" id="L784" title="All 2 branches missed.">				for (ID queueID : queueIdToSpQueues.keySet()) {</span>
<span class="nc" id="L785">					Collection&lt;SPQueue&gt; spQueuesByQueue = queueIdToSpQueues.get(queueID);</span>
<span class="nc" id="L786">					SPQueue spQueue = spQueuesByQueue.iterator().next();</span>
<span class="nc" id="L787">					retVal.add(spQueue);</span>
<span class="nc" id="L788">				}</span>
			}
<span class="nc" id="L790">		}</span>
		
<span class="nc" id="L792">		return retVal;</span>
	}

	/**
	 * Returns a &lt;code&gt;CampaignHOO&lt;/code&gt; object based on a specific date and
	 * the campaign ID, or &lt;code&gt;null&lt;/code&gt; if no match is found.
	 *
	 * @param context a request context
	 * @param campaignID a campaign ID
	 * @param startOfDay a date representing the start of a day (&lt;date&gt;
	 * 00:00:00)
	 *
	 * @return a &lt;code&gt;CampaignHOO&lt;/code&gt; based on the campaign's start and	end
	 *		dates, otherwise null
	 * &lt;p/&gt;
	 * @throws RemoteException
	 * @throws BbmException
	 */
	private CampaignHOO getCampaignHOOForDay(
		RequestContext context,
		ID campaignID,
		Date startOfDay)
		throws RemoteException, BbmException
	{
<span class="nc" id="L816">		Date adjustedDate = PulsePortletUtil.getCampaignStartOfDayForDate(campaignID, startOfDay);</span>

<span class="nc" id="L818">		Calendar incrementedDate = Calendar.getInstance();</span>
<span class="nc" id="L819">		incrementedDate.setTime(adjustedDate);</span>
<span class="nc" id="L820">		incrementedDate.add(Calendar.MINUTE, 15);</span>
<span class="nc" id="L821">		Collection&lt;CampaignHOO&gt; campaignHOOs = CampaignModelHandler.getCampaignHOOAssignments(context, campaignID, adjustedDate, incrementedDate.getTime());</span>

<span class="nc bnc" id="L823" title="All 2 branches missed.">		for (CampaignHOO campaignHOO : campaignHOOs) {</span>
<span class="nc bnc" id="L824" title="All 4 branches missed.">			if (campaignHOO.getStartTime().compareTo(adjustedDate) &lt;= 0 &amp;&amp; campaignHOO.getEndTime().compareTo(adjustedDate) &gt;= 0) {</span>
<span class="nc" id="L825">				return campaignHOO;</span>
			}
<span class="nc" id="L827">		}</span>
<span class="nc" id="L828">		return null;</span>
	}

	/**
	 * This method will return a string representation of the date with respect
	 * to the campaign time zone.
	 * &lt;p/&gt;
	 * @param date
	 * @param timezone
	 * @param format
	 * @return a string representation of the date with respect to the campaign
	 *		time zone
	 * &lt;p/&gt;
	 * @throws ParseException
	 */
	private String getDateStringAdjustedForTimeZone(
		Date date,
		TimeZone timezone,
		String format)
		throws ParseException
	{
		//&quot;yyyy-MM-dd'T'HH:mm:ss.SSS'Z'&quot; 2012-06-14T11:29:54.135Z
<span class="nc" id="L850">		SimpleDateFormat formatter = new SimpleDateFormat(format);</span>
<span class="nc" id="L851">		formatter.setTimeZone(timezone);</span>

<span class="nc" id="L853">		return formatter.format(date);</span>
	}

	/**
	 * This method will pass a JSON response data back to the client.
	 *
	 * @param response a response object that will handle the data transaction
	 * @param jsonData a response data payload
	 * &lt;p/&gt;
	 * @throws IOException
	 */
	private synchronized void sendBackData(HttpServletResponse response,
		JSONObject jsonData)
		throws IOException // TODO: add relevant error handling
	{
		// Configure response for json response
<span class="nc" id="L869">		response.setContentType(&quot;application/json&quot;);</span>
<span class="nc" id="L870">		response.setCharacterEncoding(&quot;UTF-8&quot;);</span>
<span class="nc" id="L871">		response.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);</span>

		// Get the print writer object from response to write the required json object to the output stream
<span class="nc" id="L874">		PrintWriter out = null;</span>
		try {
<span class="nc" id="L876">			out = response.getWriter();</span>
<span class="nc" id="L877">			out.print(jsonData.toString());</span>
		}
		finally {
<span class="nc" id="L880">			out.close();</span>
<span class="nc" id="L881">		}</span>
<span class="nc" id="L882">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>