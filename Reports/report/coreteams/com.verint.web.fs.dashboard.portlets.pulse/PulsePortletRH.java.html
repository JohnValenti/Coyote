<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PulsePortletRH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.dashboard.portlets.pulse</a> &gt; <span class="el_source">PulsePortletRH.java</span></div><h1>PulsePortletRH.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.dashboard.portlets.pulse;

import com.bluepumpkin.common.base.Log;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignHOO;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.SPQueueFieldInfo;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.timeseries.model.Trace;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectUtil;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.core.base.RequestHandler;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.verint.web.fs.dashboard.portlets.pulse.util.Constants;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.system.RequestContext;
import java.io.IOException;
import java.io.PrintWriter;
import java.io.UnsupportedEncodingException;
import java.net.URLEncoder;
import java.rmi.RemoteException;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.time.Duration;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.time.ZoneId;
import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.TimeZone;
import java.util.function.Function;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import static com.verint.ejb.wfm.WfmManagerFactory.getCampaignManager;

<span class="nc" id="L59">public class PulsePortletRH extends RequestHandler {</span>
	private static final String dateStrParamFormat = &quot;EEEE, MMMM dd, yyyy h:mm:ss a z&quot;;
	private static final String selectedDateStrFormat = &quot;MMM dd, yyyy&quot;;
	private static final int TIME_INCREMENT = 15;
	private static final int TWENTY_FOUR_HOURS = 1440;

<span class="fc" id="L65">	private static Category log = Log.initCategory(PulsePortletRH.class.getName());</span>

<span class="nc" id="L67">	private ID campaignID = null;</span>
<span class="nc" id="L68">	private StatisticType statisticType = null;</span>
<span class="nc" id="L69">	private Date startDate = null;</span>
<span class="nc" id="L70">	private Date endDate = null;</span>
<span class="nc" id="L71">	private Date selectedDate = null;</span>
<span class="nc" id="L72">	private ID queueID = null;</span>
<span class="nc" id="L73">	private String campaignTitle = &quot;&quot;;</span>
<span class="nc" id="L74">	private String dateRangeTitle = &quot;&quot;;</span>
<span class="nc" id="L75">	private Integer maxYValue = null;</span>
<span class="nc" id="L76">	private Localizer localizer = null;</span>
<span class="nc" id="L77">	private HttpServletRequest request = null;</span>
<span class="nc" id="L78">	private Boolean trimToHOO = null;</span>
<span class="nc" id="L79">	private String errorProcessingRequest = null;</span>
<span class="nc" id="L80">	private RequestContext m_context = null;</span>
	private String selectedDateStr;

	/**
	 * This method is the entry point for pulse portlet requests. It will call
	 * for the params in the request to be processed and then channel the
	 * request to the appropriate helper method based on the &quot;action&quot; param.
	 *
	 * @param context the request context
	 * &lt;p/&gt;
	 * @throws Exception
	 */
	@Override
	public void processRequest(RequestContext context) throws Exception {
<span class="nc" id="L94">		JSONObject errorProcessingRequestMessage = new JSONObject();</span>
<span class="nc" id="L95">		HttpServletResponse response = context.getResponse();</span>
<span class="nc" id="L96">		request = context.getRequest();</span>
<span class="nc" id="L97">		localizer = context.getLocalizer();</span>
<span class="nc" id="L98">		m_context = context;</span>

<span class="nc" id="L100">		processArgs(context);</span>

<span class="nc bnc" id="L102" title="All 2 branches missed.">		if (errorProcessingRequest == null) {</span>

			// define the action
<span class="nc" id="L105">			String action = request.getParameter(&quot;action&quot;);</span>

			// process according to the requested action
<span class="nc bnc" id="L108" title="All 2 branches missed.">			if (action.equals(&quot;getCampaignQueuesData&quot;)) {</span>
<span class="nc" id="L109">				JSONObject campaignQueuesData = getCampaignQueuesData();</span>
<span class="nc" id="L110">				sendBackData(response, campaignQueuesData);</span>
<span class="nc" id="L111">			}</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">			else if (action.equals(&quot;getPortletTableData&quot;)) {</span>
<span class="nc" id="L113">				JSONObject pulseViewData = getPortletTableData(context);</span>
<span class="nc" id="L114">				sendBackData(response, pulseViewData);</span>
<span class="nc" id="L115">			}</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">			else if (action.equals(&quot;getPortletChartData&quot;)) {</span>
<span class="nc" id="L117">				JSONObject portletChartData = getPortletChartData(context);</span>
<span class="nc" id="L118">				sendBackData(response, portletChartData);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">			} else if (action.equals(&quot;hasCalendarViewPrivilege&quot;)) {</span>
<span class="nc" id="L120">				boolean isAuthorized = context.getUser().isAuthorized(PrivilegeKeys.FS_VIEWCALENDAR);</span>
<span class="nc" id="L121">				response.setCharacterEncoding(&quot;UTF-8&quot;);</span>
<span class="nc" id="L122">				response.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);</span>

				// Get the print writer object from response to write the required json object to the output stream
<span class="nc" id="L125">				PrintWriter out = null;</span>
				try {
<span class="nc" id="L127">					out = response.getWriter();</span>
<span class="nc" id="L128">					out.print(isAuthorized);</span>
				}
				finally {
<span class="nc" id="L131">					out.close();</span>
<span class="nc" id="L132">				}</span>
			}
			
<span class="nc" id="L135">		} else {</span>
<span class="nc" id="L136">			errorProcessingRequestMessage.put(&quot;status&quot;, &quot;Fail&quot;);</span>
<span class="nc" id="L137">			errorProcessingRequestMessage.put(&quot;message&quot;, errorProcessingRequest);</span>
<span class="nc" id="L138">			sendBackData(response, errorProcessingRequestMessage);</span>
		}
<span class="nc" id="L140">	}</span>

	/**
	 * This method will process the params found in the request, and if any
	 * essential params are missing it will assign some default value so the
	 * user can begin using the portlet at a hopefully usable point.
	 *
	 * @param context a request context
	 * &lt;p/&gt;
	 * @throws Exception
	 */
	private void processArgs(RequestContext context)
		throws Exception
	{
<span class="nc" id="L154">		CampaignManager campaignManager = getCampaignManager();</span>

		// use these two calendar objects to build default values
<span class="nc" id="L157">		Calendar now = Calendar.getInstance();</span>
<span class="nc" id="L158">		Calendar weekFromNow = Calendar.getInstance();</span>
<span class="nc" id="L159">		weekFromNow.add(Calendar.DATE, 6);</span>

		// determine the campaign ID
<span class="nc" id="L162">		String campaignIDStr = request.getParameter(Constants.CAMPAIGN_ID);</span>
<span class="nc" id="L163">		TimeZone campaignTimeZone = null;</span>
		// set a default to use if one wasn't passed in
<span class="nc bnc" id="L165" title="All 2 branches missed.">		if (!isValidParameter(campaignIDStr)) {</span>
			// determine the default campaign for use in setting defaults
<span class="nc" id="L167">			Campaign defaultCampaign = PulsePortletUtil.getDefaultCampaignForUser(context);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">			if (defaultCampaign == null) {</span>
<span class="nc" id="L169">				errorProcessingRequest = localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.WARN_NO_CAMPAIGNS_FOUND_FOR_USER);</span>
<span class="nc" id="L170">				return;</span>
			}
<span class="nc" id="L172">			campaignID = defaultCampaign.getID();</span>
<span class="nc" id="L173">			campaignTitle = PulsePortletUtil.getCampaignName(campaignID);</span>
<span class="nc" id="L174">			campaignTimeZone = defaultCampaign.getTimeZone();</span>
<span class="nc" id="L175">		}</span>
		else {
<span class="nc" id="L177">			campaignID = new ID(campaignIDStr);</span>
<span class="nc" id="L178">			campaignTitle = PulsePortletUtil.getCampaignName(campaignID);</span>
<span class="nc" id="L179">			campaignTimeZone = campaignManager.getCampaignByID(campaignID).getTimeZone();</span>
		}

		// determine the date type
<span class="nc" id="L183">		String datetype = request.getParameter(Constants.DATE_PICKER_TYPE);</span>
		// set a default to use if no date type was passed
<span class="nc bnc" id="L185" title="All 2 branches missed.">		if (!isValidParameter(datetype)</span>
<span class="nc bnc" id="L186" title="All 4 branches missed.">			|| (!PulsePortletUtil.isDateRangeType(datetype) &amp;&amp; !PulsePortletUtil.isLastNPeriodsType(datetype))) {</span>
<span class="nc" id="L187">			datetype = LastNPeriodPickerPC.PICKER_TYPE_DATE_RANGE;</span>
		}

		// determine the start and end date string params
<span class="nc" id="L191">		String startDateStr = request.getParameter(Constants.START_DATE);</span>
<span class="nc" id="L192">		String endDateStr = request.getParameter(Constants.END_DATE);</span>
		// set the defaults for start and end for date range type
<span class="nc bnc" id="L194" title="All 2 branches missed.">		if (PulsePortletUtil.isDateRangeType(datetype)</span>
<span class="nc bnc" id="L195" title="All 4 branches missed.">			&amp;&amp; (!isValidParameter(startDateStr) || !isValidParameter(endDateStr))) {</span>
			// just setting these up with reference to GMT for now, and will redefine later
			// if we have a campaignTimeZone
<span class="nc" id="L198">			startDateStr = getDateStringAdjustedForTimeZone(now.getTime(), TimeZone.getTimeZone(&quot;GMT&quot;), dateStrParamFormat);</span>
<span class="nc" id="L199">			endDateStr = getDateStringAdjustedForTimeZone(weekFromNow.getTime(), TimeZone.getTimeZone(&quot;GMT&quot;), dateStrParamFormat);</span>
		}

		// determine the periodicity and periods
<span class="nc" id="L203">		String lastNPeriodicity = request.getParameter(Constants.DATE_LAST_N_PERIOD_TYPE);</span>
<span class="nc" id="L204">		String lastNPeriods = request.getParameter(Constants.DATE_LAST_N_PERIOD);</span>
		// set defaults to use if either wasn't passed in
<span class="nc bnc" id="L206" title="All 4 branches missed.">		if (!isValidParameter(lastNPeriodicity) || !isValidParameter(lastNPeriods)) {</span>
			// set defaults to: periods -1 (going forward 1 period), and periodicity 1 week, so from today, for 1 week
<span class="nc" id="L208">			lastNPeriods = &quot;-1&quot;;</span>
<span class="nc" id="L209">			lastNPeriodicity = String.valueOf(LastNPeriodPickerPC.PERIOD_TYPE_WEEKLY);</span>
		}

		// determine the start and end Dates for &quot;date range&quot; type
<span class="nc bnc" id="L213" title="All 2 branches missed.">		if (PulsePortletUtil.isDateRangeType(datetype)) {</span>
<span class="nc bnc" id="L214" title="All 4 branches missed.">			if (isValidParameter(startDateStr) &amp;&amp; isValidParameter(endDateStr)) {</span>
<span class="nc" id="L215">				startDate = DateFormat.getDateTimeInstance(DateFormat.FULL, DateFormat.FULL).parse(startDateStr);</span>
<span class="nc" id="L216">				endDate = DateFormat.getDateTimeInstance(DateFormat.FULL, DateFormat.FULL).parse(endDateStr);</span>
<span class="nc" id="L217">				dateRangeTitle = PulsePortletUtil.getDateRangeString(startDate, endDate, context.getLocaleContext().getLanguageLocale());</span>
			}

			// if we have a campaign time zone, set the start and end dates with it
			// we should have this for all users except those not assigned to a campaign
<span class="nc bnc" id="L222" title="All 2 branches missed.">			if (campaignTimeZone != null) {</span>
<span class="nc" id="L223">				DateFormat df = DateFormat.getDateTimeInstance(DateFormat.FULL, DateFormat.FULL);</span>
<span class="nc" id="L224">				df.setTimeZone(campaignTimeZone);</span>
<span class="nc" id="L225">				startDate = df.parse(startDateStr);</span>
<span class="nc" id="L226">				endDate = df.parse(endDateStr);</span>
<span class="nc" id="L227">				dateRangeTitle = PulsePortletUtil.getDateRangeString(startDate, endDate, context.getLocaleContext().getLanguageLocale(), campaignTimeZone);</span>
<span class="nc" id="L228">			}</span>
		}
		// determine the start and end Dates for &quot;last N periods&quot; type
<span class="nc bnc" id="L231" title="All 2 branches missed.">		else if (PulsePortletUtil.isLastNPeriodsType(datetype)) {</span>
<span class="nc" id="L232">			int periodicity = Integer.parseInt(lastNPeriodicity);</span>
<span class="nc" id="L233">			int numberOfPeriods = Integer.parseInt(lastNPeriods);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">			if (numberOfPeriods &lt; 0) {</span>
<span class="nc" id="L235">				endDate = PulsePortletUtil.getStartDate(campaignID, periodicity, numberOfPeriods);</span>
<span class="nc" id="L236">				startDate = PulsePortletUtil.getTodayDate(campaignID);</span>
			}
			else {
<span class="nc" id="L239">				startDate = PulsePortletUtil.getStartDate(campaignID, periodicity, numberOfPeriods);</span>
<span class="nc" id="L240">				endDate = PulsePortletUtil.getTodayDate(campaignID);</span>
			}
<span class="nc" id="L242">			dateRangeTitle = PulsePortletUtil.getDatePeriodString(periodicity, numberOfPeriods, localizer);</span>
		}

		// determine the queue ID
<span class="nc" id="L246">		String queueIDStr = request.getParameter(Constants.QUEUE_ID);</span>
		// set a default to use if one wasn't passed in
<span class="nc bnc" id="L248" title="All 2 branches missed.">		if (!isValidParameter(queueIDStr)) {</span>
<span class="nc" id="L249">			List&lt;SPQueue&gt; queues = getSPQueuesForCampaign(campaignID, startDate, endDate);</span>
<span class="nc bnc" id="L250" title="All 4 branches missed.">			if (queues != null &amp;&amp; !queues.isEmpty()) {</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">				if (queues.get(0).getQueueID() == null) {</span>
<span class="nc" id="L252">					queueID = new ID(queues.get(0).getMediaID());</span>
				}
				else {
<span class="nc" id="L255">					queueID = new ID(queues.get(0).getQueueID());</span>
				}
			}
<span class="nc" id="L258">		}</span>
		else {
<span class="nc" id="L260">			queueID = new ID(Integer.parseInt(queueIDStr));</span>
		}

		// determine the StatisticType
<span class="nc" id="L264">		String statisticTypeStr = request.getParameter(Constants.STATISTIC_TYPE);</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">		if (!isValidParameter(statisticTypeStr)) {</span>
<span class="nc" id="L266">			statisticType = StatisticType.FTE;</span>
		}
		else {
<span class="nc" id="L269">			statisticType = StatisticType.getStatisticType(Integer.parseInt(statisticTypeStr));</span>
		}

		// determine the selected date (comes from selecting a row in the data table, so no default is needed)
<span class="nc" id="L273">		selectedDateStr = request.getParameter(&quot;selectedDate&quot;);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">		if (isValidParameter(selectedDateStr)) {</span>
<span class="nc" id="L275">			SimpleDateFormat sdf = new SimpleDateFormat(selectedDateStrFormat);</span>
<span class="nc" id="L276">			selectedDate = sdf.parse(selectedDateStr);</span>
		}

<span class="nc" id="L279">		String trimToHOOStr = request.getParameter(&quot;trimToHOO&quot;);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">		if (!isValidParameter(trimToHOOStr)) {</span>
<span class="nc" id="L281">			trimToHOO = true;</span>
		}
		else {
<span class="nc" id="L284">			trimToHOO = Boolean.parseBoolean(trimToHOOStr);</span>
		}
<span class="nc" id="L286">	}</span>

	/**
	 * A simple parameter validity checker that will return true if the param
	 * isn't null, empty, or the string &quot;null&quot;.
	 *
	 * @param param a param to validate
	 * &lt;p/&gt;
	 * @return true if the param isn't null, empty, or the string &quot;null&quot;,
	 *		otherwise return false
	 */
	private boolean isValidParameter(String param)
	{
<span class="nc bnc" id="L299" title="All 6 branches missed.">		return !(param == null || &quot;&quot;.equals(param.trim()) || &quot;null&quot;.equals(param));</span>
	}

	/**
	 * This method will collect queue data for a given statistic type over a
	 * given time frame for a campaign and generate a json response to be passed
	 * back to the client.
	 *
	 * @param context a request context
	 * &lt;p/&gt;
	 * @return a json object holding the collected queue data for the given
	 *		statistic type, time frame and campaign
	 * &lt;p/&gt;
	 * @throws JSONException
	 * @throws UnsupportedEncodingException
	 * @throws RemoteException
	 * @throws BbmException
	 */
	private JSONObject getPortletTableData(RequestContext context)
		throws JSONException, UnsupportedEncodingException, RemoteException, BbmException {
<span class="nc" id="L319">		JSONObject tableData = new JSONObject();</span>
<span class="nc" id="L320">		JSONObject dataSection = new JSONObject();</span>

<span class="nc" id="L322">		JSONArray columns = new JSONArray();</span>
		// add the column headings
<span class="nc" id="L324">		JSONObject columnDate = new JSONObject();</span>
<span class="nc" id="L325">		columnDate.put(&quot;name&quot;, &quot;Date&quot;);</span>
<span class="nc" id="L326">		columnDate.put(&quot;color&quot;, &quot;#ffffff&quot;);</span>
<span class="nc" id="L327">		columns.put(columnDate);</span>

<span class="nc" id="L329">		JSONArray summaryData = new JSONArray();</span>

<span class="nc" id="L331">		JSONObject periodSummaryData = new JSONObject();</span>
<span class="nc" id="L332">		periodSummaryData.put(&quot;name&quot;, &quot;Period&quot;);</span>

<span class="nc bnc" id="L334" title="All 8 branches missed.">		if (campaignID != null &amp;&amp; startDate != null &amp;&amp; endDate != null &amp;&amp; statisticType != null) {</span>
			try {
<span class="nc" id="L336">				HashMap&lt;ID, TraceCube[]&gt; userTraceCubes = PulsePortletUtil.getUserTraceCubes(campaignID, queueID, startDate,</span>
						endDate, statisticType);
<span class="nc bnc" id="L338" title="All 4 branches missed.">				if (userTraceCubes != null &amp;&amp; userTraceCubes.size() &gt; 0) {</span>
<span class="nc" id="L339">					boolean hasForecast = statisticType.supportsForecast();</span>
<span class="nc" id="L340">					boolean hasRequired = statisticType.supportsRequired();</span>
<span class="nc" id="L341">					boolean hasActual = statisticType.supportsActual();</span>

<span class="nc" id="L343">					TimeZone campaignTimeZone = PulsePortletUtil.getCampaignTimeZone(campaignID);</span>
<span class="nc" id="L344">					SummaryData[] summaryRows = PulsePortletUtil.getSummaryData(userTraceCubes, queueID, startDate, endDate,</span>
							campaignTimeZone, statisticType);
<span class="nc bnc" id="L346" title="All 4 branches missed.">					if (summaryRows != null &amp;&amp; summaryRows.length &gt; 0) {</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">						if (hasActual) {</span>
<span class="nc" id="L348">							JSONObject columnActual = new JSONObject();</span>
<span class="nc" id="L349">							columnActual.put(&quot;name&quot;, &quot;Act&quot;);</span>
<span class="nc" id="L350">							columnActual.put(&quot;color&quot;, &quot;#ff0000&quot;);</span>
<span class="nc" id="L351">							columns.put(columnActual);</span>
						}

<span class="nc bnc" id="L354" title="All 2 branches missed.">						if (hasForecast) {</span>
<span class="nc" id="L355">							JSONObject columnForecasted = new JSONObject();</span>
<span class="nc" id="L356">							columnForecasted.put(&quot;name&quot;, &quot;For&quot;);</span>
<span class="nc" id="L357">							columnForecasted.put(&quot;color&quot;, &quot;#008000&quot;);</span>
<span class="nc" id="L358">							columns.put(columnForecasted);</span>
						}

<span class="nc bnc" id="L361" title="All 2 branches missed.">						if (hasRequired) {</span>
<span class="nc" id="L362">							JSONObject columnRequired = new JSONObject();</span>
<span class="nc" id="L363">							columnRequired.put(&quot;name&quot;, &quot;Req&quot;);</span>
<span class="nc" id="L364">							columnRequired.put(&quot;color&quot;, &quot;#0000ff&quot;);</span>
<span class="nc" id="L365">							columns.put(columnRequired);</span>
						}

<span class="nc bnc" id="L368" title="All 2 branches missed.">						for (int i = 0; i &lt; summaryRows.length; i++) {</span>
<span class="nc" id="L369">							SummaryData summaryRow = summaryRows[i];</span>
							// fill in the data for this date
<span class="nc" id="L371">							JSONObject dataRow = new JSONObject();</span>
<span class="nc" id="L372">							String spIdParam = null;</span>
<span class="nc" id="L373">							Calendar dayBegin = Calendar.getInstance();</span>
<span class="nc" id="L374">							dayBegin.setTime(summaryRow.getDate());</span>
<span class="nc" id="L375">							dayBegin.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L376">							short dayOfWeek = (short)dayBegin.get(Calendar.DAY_OF_WEEK);</span>
<span class="nc" id="L377">							CampaignHOO campaignHOO = getCampaignHOOForDay(context, campaignID, dayBegin.getTime());</span>
<span class="nc bnc" id="L378" title="All 4 branches missed.">							if (campaignHOO != null &amp;&amp; campaignHOO.isActive(dayOfWeek)) {</span>
<span class="nc" id="L379">								spIdParam = campaignHOO.getSPID().toString();</span>
							}
							// create the URL formatted date for the calendar drill link
<span class="nc" id="L382">							SimpleDateFormat format = new SimpleDateFormat(&quot;MM/dd/yyyy&quot;);</span>
<span class="nc" id="L383">							format.setTimeZone(campaignTimeZone);</span>
<span class="nc" id="L384">							String urlDate = URLEncoder.encode(format.format(summaryRow.getDate()), &quot;UTF-8&quot;);</span>
<span class="nc" id="L385">							String host = context.getContextPath();</span>

							// the no-link will be used for clean up in the client side code
<span class="nc" id="L388">							String linkURL = &quot;#no-link&quot;;</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">							if (spIdParam != null) {</span>
<span class="nc" id="L390">								linkURL = host + &quot;/control/opt_calendar?calendaraction=drilldown&amp;spid=&quot; + spIdParam + &quot;&amp;date=&quot; + urlDate;</span>
							}
<span class="nc" id="L392">							DateFormat df = DateFormat.getDateInstance();</span>
<span class="nc" id="L393">							df.setTimeZone(campaignTimeZone);</span>
<span class="nc" id="L394">							dataRow.put(&quot;displayDate&quot;, df.format(summaryRow.getDate()));</span>
<span class="nc" id="L395">							dataRow.put(&quot;linkURL&quot;, linkURL);</span>

<span class="nc" id="L397">							JSONArray dataColumns = new JSONArray();</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">							if (hasActual) {</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">								if (summaryRow.getActual() &gt; Trace.TRACEOFF) {</span>
<span class="nc" id="L400">									dataColumns.put(summaryRow.getActual());</span>
								}
								else {
<span class="nc" id="L403">									dataColumns.put(&quot;&quot;);</span>
								}
							}

<span class="nc bnc" id="L407" title="All 2 branches missed.">							if (hasForecast) {</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">								if (summaryRow.getForecasted() &gt; Trace.TRACEOFF) {</span>
<span class="nc" id="L409">									dataColumns.put(summaryRow.getForecasted());</span>
								}
								else {
<span class="nc" id="L412">									dataColumns.put(&quot;&quot;);</span>
								}
							}

<span class="nc bnc" id="L416" title="All 2 branches missed.">							if (hasRequired) {</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">								if (summaryRow.getRequired() &gt; Trace.TRACEOFF) {</span>
<span class="nc" id="L418">									dataColumns.put(summaryRow.getRequired());</span>
								}
								else {
<span class="nc" id="L421">									dataColumns.put(&quot;&quot;);</span>
								}
							}
<span class="nc" id="L424">							dataRow.put(&quot;cols&quot;, dataColumns);</span>
<span class="nc" id="L425">							summaryData.put(dataRow);</span>
						}

						// get the period summary and display it.
<span class="nc" id="L429">						SummaryData periodSummary = PulsePortletUtil.getPeriodSummaryData();</span>
<span class="nc" id="L430">						JSONArray summaryColumns = new JSONArray();</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">						if (periodSummary != null) {</span>

<span class="nc bnc" id="L433" title="All 2 branches missed.">							if (hasActual) {</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">								if (periodSummary.getActual() &gt; Trace.TRACEOFF) {</span>
<span class="nc" id="L435">									summaryColumns.put(periodSummary.getActual());</span>
								}
								else {
<span class="nc" id="L438">									summaryColumns.put(&quot;&quot;);</span>
								}
							}

<span class="nc bnc" id="L442" title="All 2 branches missed.">							if (hasForecast) {</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">								if (periodSummary.getForecasted() &gt; Trace.TRACEOFF) {</span>
<span class="nc" id="L444">									summaryColumns.put(periodSummary.getForecasted());</span>
								}
								else {
<span class="nc" id="L447">									summaryColumns.put(&quot;&quot;);</span>
								}
							}

<span class="nc bnc" id="L451" title="All 2 branches missed.">							if (hasRequired) {</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">								if (periodSummary.getRequired() &gt; Trace.TRACEOFF) {</span>
<span class="nc" id="L453">									summaryColumns.put(periodSummary.getRequired());</span>
								}
								else {
<span class="nc" id="L456">									summaryColumns.put(&quot;&quot;);</span>
								}
							}
						}
<span class="nc" id="L460">						periodSummaryData.put(&quot;cols&quot;, summaryColumns);</span>
					}
				}
<span class="nc" id="L463">				dataSection.put(&quot;campaignTitle&quot;, campaignTitle);</span>
<span class="nc" id="L464">				dataSection.put(&quot;dateRangeTitle&quot;, dateRangeTitle);</span>
<span class="nc" id="L465">				dataSection.put(&quot;columns&quot;, columns);</span>
<span class="nc" id="L466">				dataSection.put(&quot;summaryData&quot;, summaryData);</span>
<span class="nc" id="L467">				dataSection.put(&quot;periodSummaryData&quot;, periodSummaryData);</span>

<span class="nc" id="L469">				tableData.put(&quot;status&quot;, &quot;Pass&quot;);</span>
<span class="nc" id="L470">				tableData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.PASS_TABLE_DATA_GENERATED));</span>
<span class="nc" id="L471">				tableData.put(&quot;data&quot;, dataSection);</span>
			}
<span class="nc" id="L473">			catch (Exception ex) {</span>
<span class="nc" id="L474">				tableData.put(&quot;status&quot;, &quot;Fail&quot;);</span>
<span class="nc" id="L475">				tableData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.ERROR_TABLE_DATA_GENERATING) + ex.getClass().getSimpleName());</span>
<span class="nc" id="L476">				log.error(&quot;PulsePortletRH.getPortletTableData encountered an error!&quot;, ex);</span>
<span class="nc" id="L477">			}</span>
		}
		else {
<span class="nc" id="L480">			tableData.put(&quot;status&quot;, &quot;Fail&quot;);</span>
<span class="nc" id="L481">			tableData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.ERROR_TABLE_DATA_MISSING_PARAMS));</span>
		}

//		response = {
//			status: &quot;Pass&quot;,
//			message: &quot;All's well on the western front...&quot;,
//			data: {
//				campaignTitle: &quot;Some Campaign Title&quot;,
//				dateRangeTitle: &quot;Apr 1, 2004 - Apr 30, 2004&quot;,
//				columns: [
//					{ name: &quot;Date&quot;, color: &quot;#ffffff&quot; },
//					{ name: &quot;Actual&quot;, color: &quot;#FF0000&quot; },
//					{ name: &quot;Forecasted&quot;, color: &quot;#008000&quot; },
//					{ name: &quot;Required&quot;, color: &quot;#0000FF&quot; }
//				],
//				data: [
//					{ displayDate: &quot;le 01/01/2012&quot;, linkURL: &quot;http://...?calendaraction=drilldown&amp;spid=166&amp;date=01%2f01%2f2012&quot;, cols: [ 100, 110, 120 ] },
//					{ displayDate: &quot;le 01/02/2012&quot;, linkURL: &quot;http://...?calendaraction=drilldown&amp;spid=166&amp;date=01%2f02%2f2012&quot;, cols: [ 200, 210, 220 ] },
//					{ displayDate: &quot;le 01/03/2012&quot;, linkURL: &quot;http://...?calendaraction=drilldown&amp;spid=166&amp;date=01%2f03%2f2012&quot;, cols: [ 300, 310, 320 ] }
//				],
//				summary: { name: Period, cols: [ 300, 310, 320 ]  }
//			}
//		}
<span class="nc" id="L504">		return tableData;</span>
	}

	/**
	 * This method will collect queue data for a given statistic type for a
	 * given day of a campaign and generate a json response to be passed back to
	 * the client.
	 *
	 * @param context a request context
	 * &lt;p/&gt;
	 * @return a json object holding the queue data for a given statistic type
	 *		for a given day of a campaign
	 * &lt;p/&gt;
	 * @throws JSONException
	 * @throws RemoteException
	 * @throws BbmException
	 */
	private JSONObject getPortletChartData(RequestContext context)
		throws JSONException, RemoteException, BbmException
	{
<span class="nc" id="L524">		maxYValue = new Integer(1);</span>
<span class="nc" id="L525">		JSONObject chartData = new JSONObject();</span>

<span class="nc bnc" id="L527" title="All 12 branches missed.">		if (campaignID != null &amp;&amp; startDate != null &amp;&amp; endDate != null &amp;&amp; statisticType != null &amp;&amp; selectedDate != null &amp;&amp; trimToHOO != null) {</span>
			try {
<span class="nc" id="L529">				TimeZone campaignTimezone = getCampaignManager().getTimeZoneByCampaignID(campaignID);</span>
<span class="nc" id="L530">				List&lt;Integer&gt; xAxisIncrements = getXAxis(selectedDateStr, campaignTimezone);</span>
<span class="nc" id="L531">				Integer[] times = xAxisIncrements.toArray(new Integer[xAxisIncrements.size()]);</span>
<span class="nc" id="L532">				List&lt;String&gt; xAxisLabels = getXAxisLabels(selectedDateStr, campaignTimezone);</span>
<span class="nc" id="L533">				Date selectedDateStartDate = PulsePortletUtil.getCampaignStartOfDayForDate(campaignID, selectedDate);</span>
<span class="nc" id="L534">				Date selectedDateEndDate = PulsePortletUtil.getCampaignEndOfDayForDate(campaignID, selectedDate);</span>

<span class="nc" id="L536">				HashMap&lt;ID, TraceCube[]&gt; userTraceCubes = PulsePortletUtil.getUserTraceCubes(campaignID, queueID, selectedDateStartDate, selectedDateEndDate, statisticType);</span>

<span class="nc bnc" id="L538" title="All 2 branches missed.">				if (userTraceCubes != null) {</span>
<span class="nc" id="L539">					DayDetailData dayDetail = PulsePortletUtil.getDayDetail(userTraceCubes, queueID, selectedDateStartDate, selectedDateEndDate, statisticType);</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">					if (dayDetail != null) {</span>
						try {
<span class="nc" id="L542">							Integer[] forecastedDayDetail = trimIntArray(dayDetail.getForecasted(), 0, times.length);</span>
<span class="nc" id="L543">							Integer[] requiredDayDetail = trimIntArray(dayDetail.getRequired(), 0, times.length);</span>
<span class="nc" id="L544">							Integer[] actualDayDetail = trimIntArray(dayDetail.getActual(), 0, times.length);</span>

							// adjusting the selected date for TZ
<span class="nc" id="L547">							Calendar day = Calendar.getInstance();</span>
<span class="nc" id="L548">							day.setTime(selectedDate);</span>
<span class="nc" id="L549">							short dayOfWeek = (short)day.get(Calendar.DAY_OF_WEEK);</span>

<span class="nc" id="L551">							CampaignHOO campaignHOO = getCampaignHOOForDay(context, campaignID, selectedDate);</span>
							// we do want to trim it, and it's trimmable
<span class="nc bnc" id="L553" title="All 6 branches missed.">							if (trimToHOO &amp;&amp; (campaignHOO != null &amp;&amp; campaignHOO.isActive(dayOfWeek))) {</span>
<span class="nc" id="L554">								int startOfDayIndex = getIncrementForTimeOnDate(campaignHOO.getDayOpen(dayOfWeek), selectedDateStr, campaignTimezone);</span>
<span class="nc" id="L555">								short closeTime = campaignHOO.getDayClose(dayOfWeek);</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">								int endOfDayIndex = getIncrementForTimeOnDate(closeTime == 0 ? TWENTY_FOUR_HOURS : closeTime, </span>
									selectedDateStr, campaignTimezone);

<span class="nc" id="L559">								forecastedDayDetail = trimIntArray(forecastedDayDetail, startOfDayIndex, endOfDayIndex);</span>
<span class="nc" id="L560">								requiredDayDetail = trimIntArray(requiredDayDetail, startOfDayIndex, endOfDayIndex);</span>
<span class="nc" id="L561">								actualDayDetail = trimIntArray(actualDayDetail, startOfDayIndex, endOfDayIndex);</span>
<span class="nc" id="L562">								times = trimIntArray(times, startOfDayIndex, endOfDayIndex);</span>
<span class="nc" id="L563">								chartData.put(&quot;status&quot;, &quot;Pass&quot;);</span>
<span class="nc" id="L564">								chartData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.PASS_CHART_DATA_GENERATED));</span>
<span class="nc" id="L565">							}</span>
							// we do want to trim it, and it is not trimmable
<span class="nc bnc" id="L567" title="All 6 branches missed.">							else if (trimToHOO &amp;&amp; (campaignHOO == null || !campaignHOO.isActive(dayOfWeek))) {</span>
<span class="nc" id="L568">								chartData.put(&quot;status&quot;, &quot;Warn&quot;);</span>
<span class="nc" id="L569">								chartData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.WARN_CHART_DATA_NO_HOO));</span>
							}
							// we do not want to trim it
<span class="nc bnc" id="L572" title="All 2 branches missed.">							else if (!trimToHOO) {</span>
<span class="nc" id="L573">								chartData.put(&quot;status&quot;, &quot;Pass&quot;);</span>
<span class="nc" id="L574">								chartData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.PASS_CHART_DATA_GENERATED));</span>
							}
<span class="nc" id="L576">							setMaxYValue(forecastedDayDetail);</span>
<span class="nc" id="L577">							setMaxYValue(requiredDayDetail);</span>
<span class="nc" id="L578">							setMaxYValue(actualDayDetail);</span>
<span class="nc" id="L579">							chartData.put(&quot;title&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, statisticType.getName()));</span>
<span class="nc" id="L580">							chartData.put(&quot;forecasted&quot;, forecastedDayDetail);</span>
<span class="nc" id="L581">							chartData.put(&quot;required&quot;, requiredDayDetail);</span>
<span class="nc" id="L582">							chartData.put(&quot;actual&quot;, actualDayDetail);</span>
<span class="nc" id="L583">							chartData.put(&quot;time&quot;, times); // this defines the x axis</span>
<span class="nc" id="L584">							chartData.put(&quot;xAxisLabels&quot;, xAxisLabels);</span>
<span class="nc" id="L585">							chartData.put(&quot;maxYvalue&quot;, maxYValue.intValue());</span>
						}
<span class="nc" id="L587">						catch(JSONException jse) {</span>
<span class="nc" id="L588">							log.error(&quot;PulsePortletRH.getPortletChartData encountered an error!&quot;, jse);</span>
<span class="nc" id="L589">						}</span>
					}
				}
			}
<span class="nc" id="L593">			catch (Exception ex) {</span>
<span class="nc" id="L594">				chartData.put(&quot;status&quot;, &quot;Fail&quot;);</span>
<span class="nc" id="L595">				chartData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.ERROR_CHART_DATA_GENERATING) + ex.getClass().getSimpleName());</span>
<span class="nc" id="L596">				log.error(&quot;PulsePortletRH.getPortletChartData encountered an error!&quot;, ex);</span>
<span class="nc" id="L597">			}</span>
		}
		else {
			try {
<span class="nc" id="L601">				chartData.put(&quot;status&quot;, &quot;Fail&quot;);</span>
<span class="nc" id="L602">				chartData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.ERROR_CHART_DATA_MISSING_PARAMS));</span>
			}
<span class="nc" id="L604">			catch(JSONException jse) {</span>
<span class="nc" id="L605">				log.error(&quot;PulsePortletRH.getPortletChartData encountered an error!&quot;, jse);</span>
<span class="nc" id="L606">			}</span>
		}
<span class="nc" id="L608">		return chartData;</span>
	}

	/**
	 * This method will trim a given data set to contain only those values
	 * bound within the hours of operation and return a new int array based on
	 * those values.
	 *
	 * @param intArray an Integer array to trim
	 * @param startIndex the index at which to start trimming
	 * @param endIndex the index at which to end trimming
	 * &lt;p/&gt;
	 * @return a new Integer array trimmed according to the given indices
	 */
	private Integer[] trimIntArray(Integer[] intArray, int startIndex, int endIndex) {
<span class="nc" id="L623">		List&lt;Integer&gt; trimmedList = trimArray(intArray, startIndex, endIndex);</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">		return trimmedList == null ? null : trimmedList.toArray(new Integer[endIndex - startIndex]);</span>
	}

	@SuppressWarnings(&quot;unchecked&quot;)
	public &lt;T&gt; List&lt;T&gt; trimArray(T[] data, int startIndex, int endIndex) {
<span class="nc" id="L629">		List&lt;T&gt; trimmedArray = null;</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">		if (data != null) {</span>
<span class="nc" id="L631">			trimmedArray = Arrays.asList(data).subList(Math.min(startIndex, data.length), Math.min(endIndex, data.length));</span>
		}
<span class="nc" id="L633">		return trimmedArray;</span>
	}

	/**
	 * This method will set the &lt;code&gt;maxYValue&lt;/code&gt; to the largest value
	 * found in &lt;code&gt;intArray&lt;/code&gt;. This value will get passed back to the
	 * client code and can be used to set the size of the Y axis for charting.
	 *
	 * @param intArray an array of Integer values
	 */
	private void setMaxYValue(Integer[] intArray)
	{
<span class="nc bnc" id="L645" title="All 2 branches missed.">		if (intArray != null) {</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">			for (int i = 0; i &lt; intArray.length; i++) {</span>
<span class="nc bnc" id="L647" title="All 4 branches missed.">				if (intArray[i] != null &amp;&amp; intArray[i] &gt; maxYValue.intValue()) {</span>
<span class="nc" id="L648">					maxYValue = new Integer(intArray[i]);</span>
				}
			}
		}
<span class="nc" id="L652">	}</span>

	/**
	 * This method will collate queue information for a given campaign and
	 * generate a json object to be passed back to the client.
	 *
	 * @return a json object holding the collected queue information for the
	 *		given campaign
	 * &lt;p/&gt;
	 * @throws JSONException
	 */
	private JSONObject getCampaignQueuesData() throws JSONException {
<span class="nc" id="L664">		JSONObject campaignQueuesData = new JSONObject();</span>
<span class="nc" id="L665">		JSONArray queueArray = new JSONArray();</span>

//		response = {
//			queues: [
//				{ name: &quot;Phone Queue&quot;, id: &quot;22&quot; },
//				{ name: &quot;Email Queue&quot;, id: &quot;43&quot; }
//			]
//		}
<span class="nc bnc" id="L673" title="All 8 branches missed.">		if (campaignID != null &amp;&amp; startDate != null &amp;&amp; endDate != null &amp;&amp; localizer != null) {</span>
			try {
<span class="nc" id="L675">				List&lt;SPQueue&gt; spQueues = getSPQueuesForCampaign(campaignID, startDate, endDate);</span>

<span class="nc bnc" id="L677" title="All 4 branches missed.">				if (spQueues != null &amp;&amp; !spQueues.isEmpty()) {</span>
					ID id;
<span class="nc bnc" id="L679" title="All 2 branches missed.">					for (SPQueue spQueue : spQueues) {</span>
<span class="nc" id="L680">						String indent = &quot;&quot;;</span>
						// if it's a normal queue, its queue ID will not be null
<span class="nc bnc" id="L682" title="All 2 branches missed.">						if (spQueue.getQueueID() != null) {</span>
<span class="nc" id="L683">							id = spQueue.getQueueID();</span>
							// look for this queue's combined queue, and if there is one
							// indent this queue
<span class="nc bnc" id="L686" title="All 2 branches missed.">							for (int i = 0; i &lt; spQueues.size(); i++) {</span>
<span class="nc bnc" id="L687" title="All 4 branches missed.">								if (spQueues.get(i).getMediaID().equals(spQueue.getMediaID()) &amp;&amp; spQueues.get(i).getQueueID() == null) {</span>
<span class="nc" id="L688">									indent = &quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;;</span>
								}
							}
						}
						// if it's a combined queue, its media ID will be used as its ID
						else {
<span class="nc" id="L694">							id = spQueue.getMediaID();</span>
						}
<span class="nc" id="L696">						JSONObject queueRow = new JSONObject();</span>
<span class="nc" id="L697">						queueRow.put(&quot;name&quot;, indent + PulsePortletUtil.getQueueOrMediaName(id, localizer));</span>
<span class="nc" id="L698">						queueRow.put(&quot;id&quot;, id);</span>
<span class="nc" id="L699">						queueArray.put(queueRow);</span>
<span class="nc" id="L700">					}</span>
<span class="nc" id="L701">					campaignQueuesData.put(&quot;status&quot;, &quot;Pass&quot;);</span>
<span class="nc" id="L702">					campaignQueuesData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.PASS_QUEUE_DATA_GENERATED));</span>
<span class="nc" id="L703">					campaignQueuesData.put(&quot;queues&quot;, queueArray);</span>
				}
				else {
<span class="nc" id="L706">					campaignQueuesData.put(&quot;status&quot;, &quot;Warn&quot;);</span>
<span class="nc" id="L707">					campaignQueuesData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.WARN_QUEUE_DATA_NO_HOO));</span>
				}
			}
<span class="nc" id="L710">			catch (Exception ex) {</span>
<span class="nc" id="L711">				campaignQueuesData.put(&quot;status&quot;, &quot;Fail&quot;);</span>
<span class="nc" id="L712">				campaignQueuesData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.ERROR_QUEUE_DATA_GENERATING));</span>
<span class="nc" id="L713">				log.error(&quot;PulsePortletRH.getCampaignQueuesData encountered an error!&quot;, ex);</span>
<span class="nc" id="L714">			}</span>
		}
		else {
<span class="nc" id="L717">			campaignQueuesData.put(&quot;status&quot;, &quot;Fail&quot;);</span>
<span class="nc" id="L718">			campaignQueuesData.put(&quot;message&quot;, localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.ERROR_QUEUE_DATA_MISSING_PARAMS));</span>
		}
<span class="nc" id="L720">		return campaignQueuesData;</span>
	}

	/**
	 * This method will return a list of all campaign SP queues within a date
	 * range, including combined queues. The returned &lt;code&gt;Collection&lt;/code&gt;
	 * will have any combined queues grouped along with their constituent
	 * queues, at an index just below the first constituent (e.g. combined queue
	 * index = n, first constituent queue index = n + 1).
	 *
	 * @param campaignID a campaign ID
	 * @param startDate a start date
	 * @param endDate an end date
	 * &lt;p/&gt;
	 * @return a list of all campaign SP queues within a date range, including
	 *		combined queues
	 * &lt;p/&gt;
	 * @throws BbmEJBCreateException
	 * @throws BbmFinderException
	 * @throws RemoteException
	 */
	private List&lt;SPQueue&gt; getSPQueuesForCampaign(
		ID campaignID,
		Date startDate,
		Date endDate)
		throws BbmFinderException, RemoteException, BbmEJBCreateException
	{
<span class="nc" id="L747">		CampaignManager campaignManager = getCampaignManager();</span>
<span class="nc" id="L748">		List&lt;SPQueue&gt; spQueuesGrouped = new ArrayList&lt;SPQueue&gt;();</span>
<span class="nc bnc" id="L749" title="All 6 branches missed.">		if (campaignID != null &amp;&amp; startDate != null &amp;&amp; endDate != null) {</span>

<span class="nc" id="L751">			ArrayList&lt;SchedulingPeriod&gt; schedulingPeriods =</span>
<span class="nc" id="L752">				new ArrayList&lt;SchedulingPeriod&gt;(campaignManager.getSchedulingPeriods(campaignID, startDate, endDate));</span>
<span class="nc" id="L753">			ArrayList&lt;ID&gt; schedulingPeriodIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">			for (SchedulingPeriod schedulingPeriod : schedulingPeriods) {</span>
<span class="nc" id="L755">				schedulingPeriodIDs.add(schedulingPeriod.getID());</span>
<span class="nc" id="L756">			}</span>

<span class="nc" id="L758">			Collection&lt;SPQueue&gt; spQueues = new HashSet&lt;SPQueue&gt;(campaignManager.getSPQueuesBySPIDsFixed(schedulingPeriodIDs));</span>
<span class="nc bnc" id="L759" title="All 2 branches missed.">			if (spQueues.size() &gt; 1) {</span>
<span class="nc" id="L760">				spQueuesGrouped = getGroupedSpQueueList(spQueues);</span>
			} else {
<span class="nc" id="L762">				spQueuesGrouped = new ArrayList&lt;SPQueue&gt;(spQueues);</span>
			}
		}
<span class="nc" id="L765">		return spQueuesGrouped;</span>
	}
	
	private List&lt;SPQueue&gt; getGroupedSpQueueList(Collection&lt;SPQueue&gt; spQueues) throws BbmEJBCreateException, BbmFinderException, RemoteException {
<span class="nc" id="L769">		List&lt;SPQueue&gt; retVal = new ArrayList&lt;SPQueue&gt;();</span>
<span class="nc" id="L770">		CampaignManager campaignMgr = getCampaignManager(m_context.isInWhatIfMode());</span>
		//The given list of spQueues does not contain any combined queues, so find the combined queues associated to these queues
<span class="nc" id="L772">		Collection&lt;SPQueue&gt; spQueuesCombined = campaignMgr.getCombinedSPQueues(spQueues);</span>
		
		//Retrieve only one combined queue per media type, and group them along with the unique constituent queues for each media type.
<span class="nc" id="L775">		Map&lt;ID, Collection&lt;SPQueue&gt;&gt; mediaIdToCombinedSpQueues = ValueObjectUtil.groupByField(SPQueueFieldInfo.SPQUEUE_MEDIAID, spQueuesCombined);</span>
<span class="nc" id="L776">		Map&lt;ID, Collection&lt;SPQueue&gt;&gt; mediaIdToSpQueues = ValueObjectUtil.groupByField(SPQueueFieldInfo.SPQUEUE_MEDIAID, spQueues);</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">		for (ID mediaID : mediaIdToCombinedSpQueues.keySet()) {</span>
<span class="nc" id="L778">			Collection&lt;SPQueue&gt; combinedSpQueuesForMedia = mediaIdToCombinedSpQueues.get(mediaID);</span>
<span class="nc" id="L779">			SPQueue combinedSpQueue = combinedSpQueuesForMedia.iterator().next();</span>
<span class="nc" id="L780">			retVal.add(combinedSpQueue);</span>
<span class="nc" id="L781">			Collection&lt;SPQueue&gt; constituentQueues = mediaIdToSpQueues.get(combinedSpQueue.getMediaID());</span>

<span class="nc bnc" id="L783" title="All 4 branches missed.">			if (constituentQueues != null &amp;&amp; !constituentQueues.isEmpty()) {</span>
<span class="nc" id="L784">				Map&lt;ID, Collection&lt;SPQueue&gt;&gt; queueIdToSpQueues = ValueObjectUtil.groupByField(SPQueueFieldInfo.SPQUEUE_QUEUEID, constituentQueues);</span>
<span class="nc bnc" id="L785" title="All 2 branches missed.">				for (ID queueID : queueIdToSpQueues.keySet()) {</span>
<span class="nc" id="L786">					Collection&lt;SPQueue&gt; spQueuesByQueue = queueIdToSpQueues.get(queueID);</span>
<span class="nc" id="L787">					SPQueue spQueue = spQueuesByQueue.iterator().next();</span>
<span class="nc" id="L788">					retVal.add(spQueue);</span>
<span class="nc" id="L789">				}</span>
			}
<span class="nc" id="L791">		}</span>
		
<span class="nc" id="L793">		return retVal;</span>
	}

	/**
	 * Returns a &lt;code&gt;CampaignHOO&lt;/code&gt; object based on a specific date and
	 * the campaign ID, or &lt;code&gt;null&lt;/code&gt; if no match is found.
	 *
	 * @param context a request context
	 * @param campaignID a campaign ID
	 * @param startOfDay a date representing the start of a day (&lt;date&gt;
	 * 00:00:00)
	 *
	 * @return a &lt;code&gt;CampaignHOO&lt;/code&gt; based on the campaign's start and	end
	 *		dates, otherwise null
	 * &lt;p/&gt;
	 * @throws RemoteException
	 * @throws BbmException
	 */
	private CampaignHOO getCampaignHOOForDay(
		RequestContext context,
		ID campaignID,
		Date startOfDay)
		throws RemoteException, BbmException
	{
<span class="nc" id="L817">		Date adjustedDate = PulsePortletUtil.getCampaignStartOfDayForDate(campaignID, startOfDay);</span>

<span class="nc" id="L819">		Calendar incrementedDate = Calendar.getInstance();</span>
<span class="nc" id="L820">		incrementedDate.setTime(adjustedDate);</span>
<span class="nc" id="L821">		incrementedDate.add(Calendar.MINUTE, 15);</span>
<span class="nc" id="L822">		Collection&lt;CampaignHOO&gt; campaignHOOs = CampaignModelHandler.getCampaignHOOAssignments(context, campaignID, adjustedDate, incrementedDate.getTime());</span>

<span class="nc bnc" id="L824" title="All 2 branches missed.">		for (CampaignHOO campaignHOO : campaignHOOs) {</span>
<span class="nc bnc" id="L825" title="All 4 branches missed.">			if (campaignHOO.getStartTime().compareTo(adjustedDate) &lt;= 0 &amp;&amp; campaignHOO.getEndTime().compareTo(adjustedDate) &gt;= 0) {</span>
<span class="nc" id="L826">				return campaignHOO;</span>
			}
<span class="nc" id="L828">		}</span>
<span class="nc" id="L829">		return null;</span>
	}

	/**
	 * This method will return a string representation of the date with respect
	 * to the campaign time zone.
	 * &lt;p/&gt;
	 * @param date
	 * @param timezone
	 * @param format
	 * @return a string representation of the date with respect to the campaign
	 *		time zone
	 * &lt;p/&gt;
	 * @throws ParseException
	 */
	private String getDateStringAdjustedForTimeZone(
		Date date,
		TimeZone timezone,
		String format)
		throws ParseException
	{
		//&quot;yyyy-MM-dd'T'HH:mm:ss.SSS'Z'&quot; 2012-06-14T11:29:54.135Z
<span class="nc" id="L851">		SimpleDateFormat formatter = new SimpleDateFormat(format);</span>
<span class="nc" id="L852">		formatter.setTimeZone(timezone);</span>

<span class="nc" id="L854">		return formatter.format(date);</span>
	}

	/**
	 * This method will pass a JSON response data back to the client.
	 *
	 * @param response a response object that will handle the data transaction
	 * @param jsonData a response data payload
	 * &lt;p/&gt;
	 * @throws IOException
	 */
	private synchronized void sendBackData(HttpServletResponse response,
		JSONObject jsonData)
		throws IOException // TODO: add relevant error handling
	{
		// Configure response for json response
<span class="nc" id="L870">		response.setContentType(&quot;application/json&quot;);</span>
<span class="nc" id="L871">		response.setCharacterEncoding(&quot;UTF-8&quot;);</span>
<span class="nc" id="L872">		response.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);</span>

		// Get the print writer object from response to write the required json object to the output stream
<span class="nc" id="L875">		PrintWriter out = null;</span>
		try {
<span class="nc" id="L877">			out = response.getWriter();</span>
<span class="nc" id="L878">			out.print(jsonData.toString());</span>
		}
		finally {
<span class="nc" id="L881">			out.close();</span>
<span class="nc" id="L882">		}</span>
<span class="nc" id="L883">	}</span>

	public List&lt;Integer&gt; getXAxis(String selectedDate, TimeZone campaignTimezone) {
<span class="nc" id="L886">		return get15MinuteIncrements(selectedDate, campaignTimezone, currentTime -&gt; (int) Duration.between</span>
<span class="nc" id="L887">			(getZonedDateTime(selectedDate, campaignTimezone), currentTime).toMinutes());</span>
	}

	public List&lt;String&gt; getXAxisLabels(String selectedDate, TimeZone campaignTimezone) {
<span class="nc" id="L891">		List&lt;String&gt; xAxisLabels = get15MinuteIncrements(selectedDate, campaignTimezone, currentTime -&gt; currentTime.format</span>
<span class="nc" id="L892">			(DateTimeFormatter.ofPattern(&quot;h:mma&quot;)).toLowerCase());</span>
<span class="nc" id="L893">		xAxisLabels.add(&quot;12:00am&quot;);</span>
<span class="nc" id="L894">		return xAxisLabels;</span>
	}
	
	private &lt;T&gt; List&lt;T&gt; get15MinuteIncrements(String selectedDate, TimeZone campaignTimezone, Function&lt;ZonedDateTime, T&gt; timeConverter) {
<span class="nc" id="L898">		ZonedDateTime zonedSelectedDate = getZonedDateTime(selectedDate, campaignTimezone);</span>
<span class="nc" id="L899">		ZonedDateTime oneDayLater = zonedSelectedDate.plusDays(1);</span>

<span class="nc" id="L901">		List&lt;T&gt; xAxisLabels = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L902">		ZonedDateTime currentTime = zonedSelectedDate;</span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">		while(currentTime.isBefore(oneDayLater)) {</span>
<span class="nc" id="L904">			xAxisLabels.add(timeConverter.apply(currentTime));</span>
<span class="nc" id="L905">			currentTime = currentTime.plusMinutes(TIME_INCREMENT);</span>
		}
<span class="nc" id="L907">		return xAxisLabels;</span>
	}

	private ZonedDateTime getZonedDateTime(String selectedDate, TimeZone timezone) {
<span class="nc" id="L911">		LocalDate localSelectedDate = LocalDate.parse(selectedDate, DateTimeFormatter.ofPattern(&quot;MMM d, uuuu&quot;));</span>
<span class="nc" id="L912">		return ZonedDateTime.of(localSelectedDate, LocalTime.MIDNIGHT, ZoneId.of(timezone.getID()));</span>
	}

	public int getIncrementForTimeOnDate(int timeInMinutes, String dateString, TimeZone timezone) {
<span class="nc" id="L916">		ZonedDateTime zonedDateTime = getZonedDateTime(dateString, timezone);</span>
<span class="nc" id="L917">		LocalDateTime timeToFind = zonedDateTime.toLocalDateTime().plusMinutes(timeInMinutes);</span>
<span class="nc" id="L918">		int index = 0;</span>
<span class="nc bnc" id="L919" title="All 2 branches missed.">		while (zonedDateTime.toLocalDateTime().isBefore(timeToFind)) {</span>
<span class="nc" id="L920">			index++;</span>
<span class="nc" id="L921">			zonedDateTime = zonedDateTime.plusMinutes(TIME_INCREMENT);</span>
		}
<span class="nc" id="L923">		return index;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>