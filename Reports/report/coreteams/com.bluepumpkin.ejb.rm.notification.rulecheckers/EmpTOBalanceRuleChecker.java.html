<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>EmpTOBalanceRuleChecker.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.notification.rulecheckers</a> &gt; <span class="el_source">EmpTOBalanceRuleChecker.java</span></div><h1>EmpTOBalanceRuleChecker.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.notification.rulecheckers;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.TimeZone;

import org.w3c.dom.Element;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.localization.LocaleContext;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.cache.CacheUtilBBM;
import com.bluepumpkin.ejb.bbm.notifyrules.model.ActionDetail;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRule;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleTemplate;
import com.bluepumpkin.ejb.bbm.notifyrules.rulecheckers.AbstractRuleChecker;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTimeOffAccrued;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTimeOffAccruedFieldInfo;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.notification.model.EmpTOAccruedNotificationDetail;
import com.bluepumpkin.ejb.rm.requests.timeoff.ejb.TOAccrualCalculator;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOAccrual;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOAccrualDetailRow;
import com.bluepumpkin.ejb.rm.util.DAOUtil;

<span class="nc" id="L36">public class EmpTOBalanceRuleChecker extends AbstractRuleChecker {</span>
<span class="nc" id="L37">	private static final String m_className = EmpTOBalanceRuleChecker.class.getName();</span>

<span class="nc" id="L39">	private static final Category m_cat = Log.initCategory(m_className);</span>

	/**
	 * These are the parameters defined for the &quot;RequestStatusChange notification rule template&quot;.
	 * Each instance of this rule template has values assigned to these parameters.
	 * &lt;p/&gt;
	 * This rule checker checks the rule's (passed as an argument) parameters against
	 * the request status change details (passed as an argument) to determine if the rule must fire or not.
	 */
	protected static final String XML_ROOT = &quot;TOAccruedBal&quot;;
	protected static final String XML_NODE_ORGNAME = &quot;OrgName&quot;;
	protected static final String XML_NODE_EMPNAME = &quot;EmpName&quot;;
	protected static final String XML_NODE_ACTIVITYNAME = &quot;ActivityName&quot;;
	protected static final String XML_NODE_LASTUPDATEDDATE = &quot;LastUpdatedDate&quot;;
	protected static final String XML_NODE_BALANCE = &quot;Balance&quot;;
	protected static final String XML_NODE_MODIFIEDON = &quot;ModifiedOn&quot;;
	protected static final String XML_NODE_NEG_BAL_DATE = &quot;NegBalanceDate&quot;;

	/* (non-Javadoc)
	* @see com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleChecker#isRuleValid(com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRule, com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleTemplate)
	*/
	@Override
	public boolean isRuleValid(NotifyRule rule, NotifyRuleTemplate template) {
<span class="nc" id="L62">		return true;</span>
	}

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleChecker#getRuleViolation(com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRule, com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleTemplate, com.bluepumpkin.common.localization.LocaleContext)
	 */
	@Override
	public String getRuleViolation(NotifyRule rule, NotifyRuleTemplate template, LocaleContext context) {
<span class="nc" id="L70">		return null;</span>
	}

	@Override
	public ActionDetail testRule(NotifyRule notifyRule, Object notifDetail) throws Exception {
<span class="nc" id="L75">		ActionDetail actionDetail = null;</span>
<span class="nc" id="L76">		Date now = new Date();</span>
		// if notifyDetail is not a EmpTOAccruedNotificationDetail instance, then its not by the RM subsystem.
<span class="nc bnc" id="L78" title="All 2 branches missed.">		if (!(notifDetail instanceof EmpTOAccruedNotificationDetail)) {</span>
<span class="nc" id="L79">			return null;</span>
		}
<span class="nc bnc" id="L81" title="All 2 branches missed.">		if (notifyRule.getScopeType() != notifyRule.ORG_SCOPE) {</span>
<span class="nc" id="L82">			return null;</span>
		}
<span class="nc" id="L84">		ID ruleOrgID = notifyRule.getScopeID();</span>

<span class="nc" id="L86">		EmpTOAccruedNotificationDetail notifyDetail = (EmpTOAccruedNotificationDetail) notifDetail;</span>
<span class="nc" id="L87">		m_cat.debug(&quot;processing EmpTOAccrued notification detail: &quot; + notifyDetail);</span>

		// check rule's request type to see if it applies to this status change notification
<span class="nc" id="L90">		Map&lt;ID, List&lt;EmployeeTimeOffAccrued&gt;&gt; accruedMap = notifyDetail.getOrgTOAccrdMap();</span>
		// Now determine which orgs, associated with the request, the rule applies
		// to. Consider this scenario: emp1 is associated with org1; emp2 is assoc with org2;
		//notification rule defined in org1;.  In this scenario, notification must be sent all emps in org1 only

		// Verify if the rule is defined in the employee's orgID or one of its parent orgIDs
		// For each empID, verify if the emp's orgID or its parent orgIDs match the rule's orgID.
		// If match found, then save the matching employee ID(s).
<span class="nc" id="L98">		List&lt;EmployeeTimeOffAccrued&gt; toAccruedList = new ArrayList(accruedMap.size());</span>
<span class="nc" id="L99">		HashMap toAccruedMap = new HashMap(accruedMap.size());</span>

<span class="nc bnc" id="L101" title="All 2 branches missed.">		for (Iterator iter = accruedMap.keySet().iterator(); iter.hasNext();) {</span>
<span class="nc" id="L102">			ID orgID = (ID) iter.next();</span>
<span class="nc" id="L103">			Collection empOrgParentIDs = CacheUtilBBM.getParentOrgIDs(orgID, null);</span>
			// if ruleOrgID != orgID and ruleOrgID != any of parent orgIDs
<span class="nc bnc" id="L105" title="All 4 branches missed.">			if (!ruleOrgID.equals(orgID) &amp;&amp; !empOrgParentIDs.contains(ruleOrgID)) {</span>
<span class="nc" id="L106">				continue;</span>
			}
<span class="nc" id="L108">			Collection col = accruedMap.get(orgID);</span>
<span class="nc" id="L109">			toAccruedMap.put(orgID, col);</span>
			// add Accured to collection.
<span class="nc" id="L111">			toAccruedList.addAll(col);</span>
<span class="nc" id="L112">		}</span>

		// if no employee's in rule's organization or its children, then rule does not fire.
<span class="nc bnc" id="L115" title="All 4 branches missed.">		if (toAccruedList == null || toAccruedList.isEmpty()) {</span>
<span class="nc" id="L116">			m_cat.debug(&quot;No EMP TO Accrued is associated with rule's orgID or its children: &quot; + ruleOrgID);</span>
<span class="nc" id="L117">			return null;</span>
		}
<span class="nc" id="L119">		Map&lt;ID, List&lt;EmployeeTimeOffAccrued&gt;&gt; empTOAccrdMap = DAOUtil.groupByField(</span>
				EmployeeTimeOffAccruedFieldInfo.TMOFFACCRUED_EMPLOYEEID, toAccruedList);
<span class="nc" id="L121">		WorkResourceManager wrm = BbmManagerFactory.getWorkResourceManager();</span>
<span class="nc" id="L122">		Map empIDToEmpNameMap = wrm.getEmployeeNamesByIDs(empTOAccrdMap.keySet());</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">		for (Iterator iter = toAccruedMap.keySet().iterator(); iter.hasNext();) {</span>
<span class="nc" id="L124">			ID orgID = (ID) iter.next();</span>
<span class="nc" id="L125">			Organization org = wrm.getOrganizationByID(orgID);</span>
<span class="nc" id="L126">			Collection col = (Collection) toAccruedMap.get(orgID);</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">			for (Iterator iterator = col.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L128">				EmployeeTimeOffAccrued accrued = (EmployeeTimeOffAccrued) iterator.next();</span>
<span class="nc" id="L129">				String empName = EmployeeName.getDisplayName((EmployeeName) empIDToEmpNameMap.get(accrued.getEmployeeID()), m_localizer);</span>
<span class="nc" id="L130">				Element xmlRoot = checkForNegativeBalance(accrued, now, empName, org);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">				if (xmlRoot != null) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">					if (actionDetail == null) {</span>
<span class="nc" id="L133">						actionDetail = new ActionDetail();</span>
<span class="nc" id="L134">						actionDetail.setObjectType(ActionDetail.UNKNOWN);</span>
					}
<span class="nc" id="L136">					m_cat.debug(&quot;xmlRoot=: &quot; + xmlRoot);</span>
<span class="nc" id="L137">					actionDetail.setDetails(accrued.getEmployeeID()+accrued.getActivity_ActCategoryComb(), xmlRoot);</span>
				}
<span class="nc" id="L139">			}</span>
<span class="nc" id="L140">		}</span>
<span class="nc" id="L141">		m_cat.debug(&quot;Sending notification: &quot; + actionDetail);</span>
<span class="nc" id="L142">		return actionDetail;</span>
	}

	public String getActivityOrActCatName(EmployeeTimeOffAccrued accrued) throws Exception {
<span class="nc" id="L146">		String name = null;</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">		if (accrued.getActivityID() != null) {</span>
<span class="nc" id="L148">			name = TOAccrualCalculator.getActivity(accrued.getActivityID()).getName();</span>
		} else {
<span class="nc" id="L150">			name = TOAccrualCalculator.getActivityCategory(accrued.getActivityCategoryId()).getName();</span>
		}
<span class="nc" id="L152">		return name;</span>
	}

	public Element checkForNegativeBalance(EmployeeTimeOffAccrued accrued, Date maxDate, String empName, Organization org) throws Exception {
<span class="nc bnc" id="L156" title="All 2 branches missed.">		if (accrued.getOldAccruedHours() &lt; 0) {</span>
<span class="nc" id="L157">			return null;</span>
		}
<span class="nc bnc" id="L159" title="All 4 branches missed.">		if (accrued.getOldAccruedHours() &gt;= 0 &amp;&amp; accrued.getAccruedHours() &lt; 0) {</span>
<span class="nc" id="L160">			String actName = getActivityOrActCatName(accrued);</span>
<span class="nc" id="L161">			return getElement(accrued, actName, org, empName, accrued.getAccruedAtDate());</span>
		}
<span class="nc" id="L163">		TOAccrual toAccrual = TOAccrualCalculator.getTOAccruedForBalanceCheck(accrued, maxDate);</span>
<span class="nc" id="L164">		TOAccrualDetailRow violRow = toAccrual.getFirstViolation();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">		if (violRow != null) {</span>
<span class="nc" id="L166">			EmployeeTimeOffAccrued accruedOld = accrued.copy();</span>
<span class="nc" id="L167">			accruedOld.setAccruedHours(accrued.getOldAccruedHours());</span>
<span class="nc" id="L168">			accruedOld.setAccruedAtDate(accrued.getOldAccruedAtDate());</span>
<span class="nc" id="L169">			TOAccrual toAccrualOldBal = TOAccrualCalculator.getTOAccruedForBalanceCheck(accruedOld, maxDate);</span>
<span class="nc" id="L170">			TOAccrualDetailRow violRowOld = toAccrualOldBal.getFirstViolation();</span>
<span class="nc bnc" id="L171" title="All 4 branches missed.">			if (violRowOld == null || violRowOld.getTOHoursPerDay().getStartTime().after(violRow.getTOHoursPerDay().getStartTime())) {</span>
				//Should always have a Time Off event for balance to go negative
<span class="nc" id="L173">				String actName = toAccrual.getActivityOrActCatName();</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">				Date violDate = (violRowOld == null) ? violRow.getTOHoursPerDay().getStartTime() : violRowOld.getTOHoursPerDay().getStartTime();</span>
<span class="nc" id="L175">				return getElement(accrued, actName, org, empName, violDate);</span>
			}
		}
<span class="nc" id="L178">		return null;</span>
	}

	public Element getElement(EmployeeTimeOffAccrued accrued, String actName, Organization org, String empName, Date violDate) {
<span class="nc" id="L182">		TimeZone tz = TimeZone.getTimeZone(&quot;GMT&quot;); //org.getTimeZone();</span>
<span class="nc" id="L183">		Element empTOAccruedBal = createRootNode(XML_ROOT);</span>
<span class="nc" id="L184">		appendTextNode(empTOAccruedBal, XML_NODE_ORGNAME, org.getName());</span>
<span class="nc" id="L185">		appendTextNode(empTOAccruedBal, XML_NODE_EMPNAME, empName);</span>
<span class="nc" id="L186">		appendTextNode(empTOAccruedBal, XML_NODE_ACTIVITYNAME, actName);</span>
<span class="nc" id="L187">		appendTextNode(empTOAccruedBal, XML_NODE_LASTUPDATEDDATE,</span>
<span class="nc" id="L188">		        m_localizer.formatDate(accrued.getAccruedAtDate(), tz, RegionalFormatBundleKey.DATE_FORMAT));</span>
<span class="nc" id="L189">		appendTextNode(empTOAccruedBal, XML_NODE_BALANCE, m_localizer.formatNumber(accrued.getAccruedHours(), 2));</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">		Date dt = (accrued.getLastModifiedDate()!=null)?accrued.getLastModifiedDate():new Date();</span>
<span class="nc" id="L191">		appendTextNode(empTOAccruedBal, XML_NODE_MODIFIEDON,</span>
<span class="nc" id="L192">		        m_localizer.formatDate(dt, tz, RegionalFormatBundleKey.DATE_FORMAT, RegionalFormatBundleKey.TIME_SEC_FORMAT));</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">		String violDateStr =violDate != null ? m_localizer.formatDate(violDate, tz, RegionalFormatBundleKey.DATE_FORMAT) : &quot;&quot;;</span>
<span class="nc" id="L194">		appendTextNode(empTOAccruedBal, XML_NODE_NEG_BAL_DATE, violDateStr);</span>
<span class="nc" id="L195">		return empTOAccruedBal;</span>
	}


}

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>