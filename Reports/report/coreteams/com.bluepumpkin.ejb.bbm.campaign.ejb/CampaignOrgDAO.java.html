<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CampaignOrgDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.campaign.ejb</a> &gt; <span class="el_source">CampaignOrgDAO.java</span></div><h1>CampaignOrgDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.campaign.ejb;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:  dao object to serialize CampaignOrg object
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 *
 * @author lixin zhang
 * @version 1.0
 */

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.ejb.bbm.base.*;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignOrg;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignOrgFieldInfo;
import com.bluepumpkin.ejb.bbm.dao.DAOEffectivity;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.core.base.MultiUserException;

import java.util.*;

public class CampaignOrgDAO extends DAOEffectivity&lt;CampaignOrg&gt; {

<span class="fc" id="L29">	private static FieldInfo m_fieldInfo = new CampaignOrgFieldInfo();</span>

	@Override
	protected FieldInfo getFieldInfo() {
<span class="fc" id="L33">		return m_fieldInfo;</span>
	}

	public CampaignOrgDAO() {
<span class="fc" id="L37">		super();</span>
<span class="fc" id="L38">	}</span>

	public CampaignOrgDAO(Jdmo dmo) {
<span class="fc" id="L41">		super(dmo);</span>
<span class="fc" id="L42">	}</span>

	@Override
	protected CampaignOrg createValueObject() {
<span class="nc" id="L46">		return new CampaignOrg();</span>
	}

	/**
	 * get a given campaign's organization assignments
	 *
	 * @return a collection of CampaignOrg objects which hold the assignment
	 * information
	 * @idCampaign campaign id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	public Collection&lt;CampaignOrg&gt; getCampaignOrgAssignments(ID idCampaign, Date dtStart, Date dtEnd)
			throws BbmFinderException {
<span class="fc" id="L59">		return getCampaignOrgAssignments(idCampaign, dtStart, dtEnd, false);</span>
	}

	public Collection&lt;CampaignOrg&gt; getCampaignOrgAssignments(ID idCampaign, Date dtStart, Date dtEnd, boolean isDistributed)
			throws BbmFinderException {
		try {
			// load all campaigns
<span class="fc" id="L66">			ArrayList&lt;CampaignOrg&gt; aAssignments = new ArrayList&lt;CampaignOrg&gt;();</span>

<span class="fc" id="L68">			String query = &quot;SELECT ORGANIZATIONID,FROMDATE,TODATE FROM SPCALLCENTER,SP,CAMPAIGN &quot;;</span>
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">			if (!isDistributed) {</span>
<span class="fc" id="L70">				query = query + &quot; WHERE CAMPAIGN.SID = &quot; + idCampaign + &quot; AND SP.CAMPAIGNID = CAMPAIGN.ID  &quot;;</span>
			} else {
<span class="nc" id="L72">				query = query</span>
						+ &quot; where campaign.sid in (select campaign.sid from campaign where parentcampaignid in (select id from campaign where sid=&quot;
						+ idCampaign + &quot;))&quot; + &quot; AND SP.CAMPAIGNID = CAMPAIGN.ID  &quot;;
			}
<span class="fc" id="L76">			query = query + &quot; AND SPCALLCENTER.SPID = SP.ID AND SP.FROMDATE &lt; '&quot; + JdmoUtil.formatDBString(dtEnd)</span>
<span class="fc" id="L77">					+ &quot;' AND SP.TODATE &gt; '&quot; + JdmoUtil.formatDBString(dtStart) + &quot;'&quot;;</span>

<span class="fc" id="L79">			JdmoRowset r = m_dmo.createRowset(query);</span>

			// -------------------------------------------------
			// get data and create campaigns
			// -------------------------------------------------

<span class="fc bfc" id="L85" title="All 2 branches covered.">			while (r.next()) {</span>
<span class="fc" id="L86">				ID idOrg = r.getID(&quot;ORGANIZATIONID&quot;);</span>
<span class="fc" id="L87">				Date dtStart1 = r.getTimestamp(&quot;FROMDATE&quot;);</span>
<span class="fc" id="L88">				Date dtEnd1 = r.getTimestamp(&quot;TODATE&quot;);</span>

<span class="fc" id="L90">				CampaignOrg pAssignment = new CampaignOrg();</span>
<span class="fc" id="L91">				pAssignment.setCampaignID(idCampaign);</span>
<span class="fc" id="L92">				pAssignment.setOrganizationID(idOrg);</span>
<span class="fc" id="L93">				pAssignment.setStartTime(dtStart1);</span>
<span class="fc" id="L94">				pAssignment.setEndTime(dtEnd1);</span>

<span class="fc" id="L96">				aAssignments.add(pAssignment);</span>
<span class="fc" id="L97">			}</span>

<span class="fc" id="L99">			r.close();</span>
<span class="fc" id="L100">			return aAssignments;</span>

<span class="nc" id="L102">		} catch (JdmoException e) {</span>
<span class="nc" id="L103">			e.printStackTrace();</span>
<span class="nc" id="L104">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L106">			m_dmo.cleanUp();</span>
		}
	}

	/**
	 * get a given organization 's campaign assignments
	 *
	 * @return a collection of CampaignOrg objects which hold the assignment
	 * information
	 * @idOrg organization id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	public Collection&lt;CampaignOrg&gt; getOrgCampaignAssignments(ID idOrg, Date dtStart, Date dtEnd) throws BbmFinderException {
		try {
			// load all campaigns
<span class="fc" id="L121">			ArrayList&lt;CampaignOrg&gt; aAssignments = new ArrayList&lt;CampaignOrg&gt;();</span>

<span class="fc" id="L123">			StringBuffer query = new StringBuffer();</span>
<span class="fc" id="L124">			query.append(&quot; SELECT CAMPAIGN.SID AS SID,FROMDATE,TODATE&quot;);</span>
<span class="fc" id="L125">			query.append(&quot; FROM SPCALLCENTER,SP,CAMPAIGN&quot;);</span>
<span class="fc" id="L126">			query.append(&quot; WHERE ORGANIZATIONID = &quot;);</span>
<span class="fc" id="L127">			query.append(idOrg);</span>
<span class="fc" id="L128">			query.append(&quot; AND SP.CAMPAIGNID = CAMPAIGN.ID&quot;);</span>
<span class="fc" id="L129">			query.append(&quot; AND SPCALLCENTER.SPID = SP.ID&quot;);</span>
<span class="fc" id="L130">			query.append(&quot; AND SP.TODATE &gt; '&quot; + JdmoUtil.formatDBString(dtStart) + &quot;'&quot;);</span>
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">			if (dtEnd != null) {</span>
<span class="nc" id="L132">				query.append(&quot; AND SP.FROMDATE &lt; '&quot; + JdmoUtil.formatDBString(dtEnd) + &quot;'&quot;);</span>
			}

<span class="fc" id="L135">			JdmoRowset r = m_dmo.createRowset(query.toString());</span>

			// -------------------------------------------------
			// get data and create campaigns
			// -------------------------------------------------

<span class="fc bfc" id="L141" title="All 2 branches covered.">			while (r.next()) {</span>
<span class="fc" id="L142">				ID idCampaign = r.getID(&quot;SID&quot;);</span>
<span class="fc" id="L143">				Date dtStart1 = r.getTimestamp(&quot;FROMDATE&quot;);</span>
<span class="fc" id="L144">				Date dtEnd1 = r.getTimestamp(&quot;TODATE&quot;);</span>

<span class="fc" id="L146">				CampaignOrg pAssignment = new CampaignOrg();</span>
<span class="fc" id="L147">				pAssignment.setCampaignID(idCampaign);</span>
<span class="fc" id="L148">				pAssignment.setOrganizationID(idOrg);</span>
<span class="fc" id="L149">				pAssignment.setStartTime(dtStart1);</span>
<span class="fc" id="L150">				pAssignment.setEndTime(dtEnd1);</span>

<span class="fc" id="L152">				aAssignments.add(pAssignment);</span>
<span class="fc" id="L153">			}</span>

<span class="fc" id="L155">			r.close();</span>
<span class="fc" id="L156">			return aAssignments;</span>

<span class="nc" id="L158">		} catch (JdmoException e) {</span>
<span class="nc" id="L159">			e.printStackTrace();</span>
<span class="nc" id="L160">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L162">			m_dmo.cleanUp();</span>
		}
	}

	/**
	 * Given a collection of orgIDs, return all campaignIDs linked to any of
	 * those orgs, for any time period.
	 */
	public Collection&lt;ID&gt; getAllCampaignIDsLinkedToOrgs(Collection&lt;ID&gt; orgIDs) throws BbmFinderException {
		try {

<span class="pc bpc" id="L173" title="2 of 4 branches missed.">			if (orgIDs == null || orgIDs.size() == 0) {</span>
<span class="nc" id="L174">				return Collections.emptyList();</span>
			}

			// load all campaigns
<span class="fc" id="L178">			ArrayList&lt;ID&gt; campIDs = new ArrayList&lt;ID&gt;();</span>

<span class="fc" id="L180">			StringBuffer query = new StringBuffer();</span>
<span class="fc" id="L181">			query.append(&quot;SELECT DISTINCT C.SID AS SID&quot;);</span>
<span class="fc" id="L182">			query.append(&quot; FROM CAMPAIGN C INNER JOIN&quot;);</span>
<span class="fc" id="L183">			query.append(&quot; SP ON C.ID = SP.CAMPAIGNID&quot;);</span>
<span class="fc" id="L184">			query.append(&quot; INNER JOIN SPCALLCENTER SCC ON SCC.SPID = SP.ID&quot;);</span>
<span class="fc" id="L185">			query.append(&quot; WHERE SCC.ORGANIZATIONID in &quot;);</span>

<span class="fc" id="L187">			Iterator&lt;ID&gt; it = orgIDs.iterator();</span>
<span class="fc" id="L188">			StringBuilder sb = new StringBuilder(&quot;(&quot;);</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">			while (it.hasNext()) {</span>
<span class="fc" id="L190">				ID id = it.next();</span>
<span class="fc" id="L191">				sb.append(id);</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">				if (it.hasNext()) {</span>
<span class="fc" id="L193">					sb.append(&quot;,&quot;);</span>
				}
<span class="fc" id="L195">			}</span>
<span class="fc" id="L196">			sb.append(&quot;)&quot;);</span>
<span class="fc" id="L197">			query.append(sb.toString());</span>

<span class="fc" id="L199">			JdmoRowset r = m_dmo.createRowset(query.toString());</span>

			// -------------------------------------------------
			// get data and create campaigns
			// -------------------------------------------------

<span class="fc bfc" id="L205" title="All 2 branches covered.">			while (r.next()) {</span>
<span class="fc" id="L206">				ID idCampaign = r.getID(&quot;SID&quot;);</span>
<span class="fc" id="L207">				campIDs.add(idCampaign);</span>
<span class="fc" id="L208">			}</span>

<span class="fc" id="L210">			r.close();</span>
<span class="fc" id="L211">			return campIDs;</span>

<span class="nc" id="L213">		} catch (JdmoException e) {</span>
<span class="nc" id="L214">			e.printStackTrace();</span>
<span class="nc" id="L215">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L217">			m_dmo.cleanUp();</span>
		}
	}

	/**
	 * create a campaign's organization assignment
	 */
	public ID createCampaignOrgAssignment(CampaignOrg objValue) throws BbmCreateException {
<span class="nc" id="L225">		return super.createNoOverlapAssignment(objValue, CampaignOrgFieldInfo.CAMPAIGNORG_CAMPAIGNID,</span>
				CampaignOrgFieldInfo.CAMPAIGNORG_ORGANIZATIONID);
		/** @todo assign work resources ? */
	}

	/**
	 * save a campaign's organization assignment
	 */
	public void updateCampaignOrgAssignment(CampaignOrg objValue) throws MultiUserException, BbmUpdateException {
<span class="nc" id="L234">		super.updateNoOverlapAssignment(objValue, CampaignOrgFieldInfo.CAMPAIGNORG_CAMPAIGNID,</span>
				CampaignOrgFieldInfo.CAMPAIGNORG_ORGANIZATIONID, false); // bSaveAsNew = false
<span class="nc" id="L236">	}</span>

	/**
	 * delete a campaign's organization assignment given the assignment id
	 */
	public void deleteCampaignOrgAssignments(Collection&lt;ID&gt; colIDAssignments) throws BbmRemoveException {
<span class="nc" id="L242">		deleteObjects(colIDAssignments);</span>
		/** @todo unassign work resources ? */
<span class="nc" id="L244">	}</span>

	public CampaignOrg getCampaignOrgAssignmentByID(ID idAssignment) throws BbmObjectNotFoundException, BbmFinderException {
<span class="nc" id="L247">		return (CampaignOrg) getObjectByID(idAssignment);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>