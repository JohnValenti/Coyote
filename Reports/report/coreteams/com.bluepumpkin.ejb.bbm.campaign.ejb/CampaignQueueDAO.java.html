<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CampaignQueueDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.campaign.ejb</a> &gt; <span class="el_source">CampaignQueueDAO.java</span></div><h1>CampaignQueueDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.campaign.ejb;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:  dao object to serialize CampaignQueue object
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 *
 * @author lixin zhang
 * @version 1.0
 */

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.*;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignQueue;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignQueueFieldInfo;
import com.bluepumpkin.ejb.bbm.dao.DAOEffectivity;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;

import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;

public class CampaignQueueDAO extends DAOEffectivity&lt;CampaignQueue&gt; {

<span class="fc" id="L30">	private static FieldInfo m_fieldInfo = new CampaignQueueFieldInfo();</span>

	@Override
	protected FieldInfo getFieldInfo() {
<span class="fc" id="L34">		return m_fieldInfo;</span>
	}

	public CampaignQueueDAO() {
<span class="fc" id="L38">		super();</span>
<span class="fc" id="L39">	}</span>

	public CampaignQueueDAO(Jdmo dmo) {
<span class="nc" id="L42">		super(dmo);</span>
<span class="nc" id="L43">	}</span>

	@Override
	protected CampaignQueue createValueObject() {
<span class="nc" id="L47">		return new CampaignQueue();</span>
	}

	@Override
	protected StringBuffer getSelectStatement() {
<span class="nc" id="L52">		StringBuffer strSQL = new StringBuffer();</span>
<span class="nc" id="L53">		strSQL.append(&quot;SELECT A.ID, A.CAMPAIGNID, A.QUEUEID, A.STARTTIME, A.ENDTIME, &quot;);</span>
<span class="nc" id="L54">		strSQL.append(&quot; C.NAME CAMPAIGNNAME &quot;);</span>
<span class="nc" id="L55">		return strSQL;</span>
	}

	@Override
	protected boolean appendFromWhereStatement(StringBuffer strSQL) {
<span class="nc" id="L60">		strSQL.append(&quot; FROM QUEUECAMPAIGN A, QUEUE B, CAMPAIGN C &quot;);</span>
<span class="nc" id="L61">		strSQL.append(&quot;WHERE A.QUEUEID = B.ID AND A.CAMPAIGNID = C.ID &quot;);</span>
<span class="nc" id="L62">		return true;</span>
	}

	/**
	 * get a given campaign's queue assignments
	 *
	 * @return a collection of CampaignQueue objects which hold the assignment
	 * information
	 * @idCampaign campaign id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	public Collection&lt;CampaignQueue&gt; getCampaignQueueAssignments(ID idCampaign, ID idMedia, Date dtStart, Date dtEnd,
			boolean bIncludeCombined) throws BbmFinderException {
		try {
			// load all campaigns
<span class="fc" id="L77">			ArrayList&lt;CampaignQueue&gt; aAssignments = new ArrayList&lt;CampaignQueue&gt;();</span>

<span class="fc" id="L79">			String query = &quot;SELECT SP.SID SPID,QUEUE.SID QUEUEID,FROMDATE,TODATE FROM QUEUE,SPQUEUE,SP,CAMPAIGN&quot;;</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">			if (idMedia != null) {</span>
<span class="fc" id="L81">				query += &quot;,MEDIA&quot;;</span>
			}
<span class="fc" id="L83">			query += &quot; WHERE CAMPAIGN.SID = &quot; + JdmoUtil.asSqlLiteral(idCampaign) + &quot; AND SP.CAMPAIGNID = CAMPAIGN.ID  &quot;</span>
					+ &quot; AND SPQUEUE.SPID = SP.ID AND SPQUEUE.QUEUEID = QUEUE.ID &quot;;
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">			if (dtEnd != null) {</span>
<span class="fc" id="L86">				query += &quot; AND SP.FROMDATE &lt; '&quot; + JdmoUtil.formatDBString(dtEnd) + &quot;'&quot;;</span>
			}
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">			if (dtStart != null) {</span>
<span class="fc" id="L89">				query += &quot; AND SP.TODATE &gt; '&quot; + JdmoUtil.formatDBString(dtStart) + &quot;'&quot;;</span>
			}
<span class="fc bfc" id="L91" title="All 2 branches covered.">			if (idMedia != null) {</span>
<span class="fc" id="L92">				query += &quot; AND MEDIA.SID = &quot; + JdmoUtil.asSqlLiteral(idMedia) + &quot; AND QUEUE.MEDIAID = MEDIA.ID&quot;;</span>
			}

<span class="fc" id="L95">			JdmoRowset r = m_dmo.createRowset(query);</span>

			// -------------------------------------------------
			// get data and create campaigns
			// -------------------------------------------------

<span class="fc bfc" id="L101" title="All 2 branches covered.">			while (r.next()) {</span>

<span class="fc" id="L103">				ID idSP = r.getID(&quot;SPID&quot;);</span>
<span class="fc" id="L104">				ID idQueue = r.getID(&quot;QUEUEID&quot;);</span>
<span class="fc" id="L105">				Date dtStart1 = r.getTimestamp(&quot;FROMDATE&quot;);</span>
<span class="fc" id="L106">				Date dtEnd1 = r.getTimestamp(&quot;TODATE&quot;);</span>

<span class="fc" id="L108">				CampaignQueue pAssignment = new CampaignQueue();</span>
<span class="fc" id="L109">				pAssignment.setCampaignID(idCampaign);</span>
<span class="fc" id="L110">				pAssignment.setQueueID(idQueue);</span>
<span class="fc" id="L111">				pAssignment.setSPID(idSP);</span>
<span class="fc" id="L112">				pAssignment.setStartTime(dtStart1);</span>
<span class="fc" id="L113">				pAssignment.setEndTime(dtEnd1);</span>

<span class="fc" id="L115">				aAssignments.add(pAssignment);</span>
<span class="fc" id="L116">			}</span>

<span class="fc" id="L118">			r.close();</span>

<span class="fc bfc" id="L120" title="All 2 branches covered.">			if (bIncludeCombined) {</span>
<span class="fc" id="L121">				query = &quot;SELECT SP.SID SPID,MEDIA.SID MEDIAID, FROMDATE,TODATE FROM SPQUEUE,SP,CAMPAIGN,MEDIA&quot;;</span>
<span class="fc" id="L122">				query += &quot; WHERE CAMPAIGN.SID = &quot; + JdmoUtil.asSqlLiteral(idCampaign) + &quot; AND SP.CAMPAIGNID = CAMPAIGN.ID  &quot;</span>
						+ &quot; AND SPQUEUE.SPID = SP.ID AND QUEUEID IS NULL AND SPQUEUE.MEDIAID = MEDIA.ID &quot;;
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">				if (dtEnd != null) {</span>
<span class="fc" id="L125">					query += &quot; AND SP.FROMDATE &lt; '&quot; + JdmoUtil.formatDBString(dtEnd) + &quot;'&quot;;</span>
				}
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">				if (dtStart != null) {</span>
<span class="fc" id="L128">					query += &quot; AND SP.TODATE &gt; '&quot; + JdmoUtil.formatDBString(dtStart) + &quot;'&quot;;</span>
				}

<span class="fc" id="L131">				r = m_dmo.createRowset(query);</span>

				// -------------------------------------------------
				// get data and create campaigns
				// -------------------------------------------------

<span class="fc bfc" id="L137" title="All 2 branches covered.">				while (r.next()) {</span>

<span class="fc" id="L139">					ID idSP = r.getID(&quot;SPID&quot;);</span>
<span class="fc" id="L140">					ID idCombinedMedia = r.getID(&quot;MEDIAID&quot;);</span>
<span class="fc" id="L141">					Date dtStart1 = r.getTimestamp(&quot;FROMDATE&quot;);</span>
<span class="fc" id="L142">					Date dtEnd1 = r.getTimestamp(&quot;TODATE&quot;);</span>

<span class="fc" id="L144">					CampaignQueue pAssignment = new CampaignQueue();</span>
<span class="fc" id="L145">					pAssignment.setCampaignID(idCampaign);</span>
<span class="fc" id="L146">					pAssignment.setMediaID(idCombinedMedia);</span>
<span class="fc" id="L147">					pAssignment.setSPID(idSP);</span>
<span class="fc" id="L148">					pAssignment.setStartTime(dtStart1);</span>
<span class="fc" id="L149">					pAssignment.setEndTime(dtEnd1);</span>

<span class="fc" id="L151">					aAssignments.add(pAssignment);</span>
<span class="fc" id="L152">				}</span>

<span class="fc" id="L154">				r.close();</span>
			}
<span class="fc" id="L156">			return aAssignments;</span>

<span class="nc" id="L158">		} catch (JdmoException e) {</span>
<span class="nc" id="L159">			e.printStackTrace();</span>
<span class="nc" id="L160">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L162">			m_dmo.cleanUp();</span>
		}
	}

	public Collection&lt;CampaignQueue&gt; getCampaignQueueAndLinkedSubQueueAssignments(ID idCampaign, ID idMedia, Date dtStart,
			Date dtEnd) throws BbmFinderException {
		try {
			// load all campaigns
<span class="fc" id="L170">			Collection&lt;CampaignQueue&gt; aCampaignAssignments = getCampaignQueueAssignments(idCampaign, idMedia, dtStart,</span>
					dtEnd, false);
			// now load the assignments from the sub Campaigns
<span class="fc" id="L173">			ArrayList&lt;CampaignQueue&gt; aAssignments = new ArrayList&lt;CampaignQueue&gt;();</span>

<span class="fc" id="L175">			String query = &quot;SELECT SP.SID SPID,QUEUE.SID QUEUEID,FROMDATE,TODATE,CAMPAIGN.SID CID FROM QUEUE,SPQUEUE,SP,CAMPAIGN&quot;;</span>
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">			if (idMedia != null) {</span>
<span class="nc" id="L177">				query += &quot;,MEDIA&quot;;</span>
			}
<span class="fc" id="L179">			query += &quot; WHERE CAMPAIGN.SID IN (SELECT SID FROM CAMPAIGN WHERE PARENTCAMPAIGNID =(SELECT ID FROM CAMPAIGN WHERE SID=&quot;</span>
<span class="fc" id="L180">					+ JdmoUtil.asSqlLiteral(idCampaign)</span>
					+ &quot;)) AND SP.CAMPAIGNID = CAMPAIGN.ID  &quot;
					+ &quot; AND SPQUEUE.SPID = SP.ID AND SPQUEUE.QUEUEID = QUEUE.ID &quot;;
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">			if (dtEnd != null) {</span>
<span class="fc" id="L184">				query += &quot; AND SP.FROMDATE &lt; '&quot; + JdmoUtil.formatDBString(dtEnd) + &quot;'&quot;;</span>
			}
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">			if (dtStart != null) {</span>
<span class="fc" id="L187">				query += &quot; AND SP.TODATE &gt; '&quot; + JdmoUtil.formatDBString(dtStart) + &quot;'&quot;;</span>
			}
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">			if (idMedia != null) {</span>
<span class="nc" id="L190">				query += &quot; AND MEDIA.SID = &quot; + JdmoUtil.asSqlLiteral(idMedia) + &quot; AND QUEUE.MEDIAID = MEDIA.ID&quot;;</span>
			}

<span class="fc" id="L193">			JdmoRowset r = m_dmo.createRowset(query);</span>

			// -------------------------------------------------
			// get data and create campaigns
			// -------------------------------------------------

<span class="pc bpc" id="L199" title="1 of 2 branches missed.">			while (r.next()) {</span>

<span class="nc" id="L201">				ID idSP = r.getID(&quot;SPID&quot;);</span>
<span class="nc" id="L202">				ID idQueue = r.getID(&quot;QUEUEID&quot;);</span>
<span class="nc" id="L203">				Date dtStart1 = r.getTimestamp(&quot;FROMDATE&quot;);</span>
<span class="nc" id="L204">				Date dtEnd1 = r.getTimestamp(&quot;TODATE&quot;);</span>
<span class="nc" id="L205">				ID idCampaign1 = r.getID(&quot;CID&quot;);</span>

<span class="nc" id="L207">				CampaignQueue pAssignment = new CampaignQueue();</span>
<span class="nc" id="L208">				pAssignment.setCampaignID(idCampaign1);</span>
<span class="nc" id="L209">				pAssignment.setQueueID(idQueue);</span>
<span class="nc" id="L210">				pAssignment.setSPID(idSP);</span>
<span class="nc" id="L211">				pAssignment.setStartTime(dtStart1);</span>
<span class="nc" id="L212">				pAssignment.setEndTime(dtEnd1);</span>

<span class="nc" id="L214">				aAssignments.add(pAssignment);</span>
<span class="nc" id="L215">			}</span>

<span class="fc" id="L217">			r.close();</span>
<span class="fc" id="L218">			aCampaignAssignments.addAll(aAssignments);</span>
<span class="fc" id="L219">			return aCampaignAssignments;</span>

<span class="nc" id="L221">		} catch (JdmoException e) {</span>
<span class="nc" id="L222">			e.printStackTrace();</span>
<span class="nc" id="L223">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L225">			m_dmo.cleanUp();</span>
		}
	}

	public Collection&lt;CampaignQueue&gt; getQueueCampaignAssignments(ID idQueue, Date dtStart, Date dtEnd)
			throws BbmFinderException {
		try {
			// load all campaigns
<span class="fc" id="L233">			ArrayList&lt;CampaignQueue&gt; aAssignments = new ArrayList&lt;CampaignQueue&gt;();</span>

<span class="fc" id="L235">			JdmoConnection conn = m_dmo.getConnection();</span>
<span class="fc" id="L236">			String query = &quot;SELECT SP.SID SPID,CAMPAIGN.SID CAMPAIGNID,FROMDATE,TODATE FROM QUEUE,SPQUEUE,SP,CAMPAIGN&quot;;</span>
<span class="fc" id="L237">			query += &quot; WHERE QUEUE.SID = ?  AND SP.CAMPAIGNID = CAMPAIGN.ID  &quot;</span>
					+ &quot; AND SPQUEUE.SPID = SP.ID AND SPQUEUE.QUEUEID = QUEUE.ID &quot;;
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">			if (dtEnd != null) {</span>
<span class="fc" id="L240">				query += &quot; AND SP.FROMDATE &lt; ?&quot;;</span>
			}
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">			if (dtStart != null) {</span>
<span class="fc" id="L243">				query += &quot; AND SP.TODATE &gt; ?&quot;;</span>
			}

<span class="fc" id="L246">			PreparedStatement pstmt = conn.prepareStatement(query);</span>
<span class="fc" id="L247">			pstmt.setInt(1, idQueue.toInt());</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">			if (dtEnd != null) {</span>
<span class="fc" id="L249">				pstmt.setDate(2, new java.sql.Date(dtEnd.getTime()));</span>
			}
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">			if (dtStart != null) {</span>
<span class="fc" id="L252">				pstmt.setDate(3, new java.sql.Date(dtStart.getTime()));</span>
			}

<span class="fc" id="L255">			ResultSet r = pstmt.executeQuery();</span>

			// -------------------------------------------------
			// get data and create campaigns
			// -------------------------------------------------

<span class="pc bpc" id="L261" title="1 of 2 branches missed.">			while (r.next()) {</span>

<span class="nc" id="L263">				ID idSP = new ID(r.getInt(1)); // spid</span>
<span class="nc" id="L264">				ID idCampaign = new ID(r.getInt(2)); // &quot;CAMPAIGNID&quot;</span>
<span class="nc" id="L265">				Date dtStart1 = r.getTimestamp(3); // &quot;FROMDATE&quot;</span>
<span class="nc" id="L266">				Date dtEnd1 = r.getTimestamp(4); // &quot;TODATE&quot;</span>

<span class="nc" id="L268">				CampaignQueue pAssignment = new CampaignQueue();</span>
<span class="nc" id="L269">				pAssignment.setCampaignID(idCampaign);</span>
<span class="nc" id="L270">				pAssignment.setQueueID(idQueue);</span>
<span class="nc" id="L271">				pAssignment.setSPID(idSP);</span>
<span class="nc" id="L272">				pAssignment.setStartTime(dtStart1);</span>
<span class="nc" id="L273">				pAssignment.setEndTime(dtEnd1);</span>

<span class="nc" id="L275">				aAssignments.add(pAssignment);</span>
<span class="nc" id="L276">			}</span>

<span class="fc" id="L278">			r.close();</span>
<span class="fc" id="L279">			return aAssignments;</span>
<span class="nc" id="L280">		} catch (SQLException e) {</span>
<span class="nc" id="L281">			throw new BbmFinderException(e);</span>
<span class="nc" id="L282">		} catch (JdmoException e) {</span>
<span class="nc" id="L283">			e.printStackTrace();</span>
<span class="nc" id="L284">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L286">			m_dmo.cleanUp();</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>