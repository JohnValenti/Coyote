<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CampaignHOODAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.campaign.ejb</a> &gt; <span class="el_source">CampaignHOODAO.java</span></div><h1>CampaignHOODAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.campaign.ejb;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:  dao object to serialize CampaignHOO object
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, Inc
 *
 * @author lixin zhang
 * @version 1.0
 */

import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.List;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.util.NumberFactory;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignHOO;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignHOOFieldInfo;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignHOOPeriod;
import com.bluepumpkin.ejb.bbm.dao.DAOEffectivity;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.effectivity.TimePeriodUtil;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.HOOPeriod;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.OrganizationHOO;

public class CampaignHOODAO extends DAOEffectivity&lt;CampaignHOO&gt; {

<span class="fc" id="L47">	private static FieldInfo m_fieldInfo = new CampaignHOOFieldInfo();</span>

	protected FieldInfo getFieldInfo() {
<span class="fc" id="L50">		return m_fieldInfo;</span>
	}

	public CampaignHOODAO() {
<span class="fc" id="L54">		super();</span>
<span class="fc" id="L55">	}</span>

	public CampaignHOODAO(Jdmo dmo) {
<span class="nc" id="L58">		super(dmo);</span>
<span class="nc" id="L59">	}</span>

	protected CampaignHOO createValueObject() {
<span class="nc" id="L62">		return new CampaignHOO();</span>
	}

	/**
	 * get a given campaign's hour's of operations (used in v11)
	 *
	 * @return a collection of CampaignHOO objects which hold the assignment
	 * information
	 * &lt;p&gt;
	 * NOTE: If the given campaign is a distributed campaign, this
	 * method also returns CampaignHOO objects for its sub campaigns as
	 * well. The CampaignHOO objects that are returned are set with the
	 * campaign ID of the parent distributed campaign, even if the HOO
	 * belongs to the sub campaign. This seems like a bug but at the
	 * time of this comment it wasn't clear if changing that behavior
	 * was safe or could potentially introduce new bugs.
	 * @idCampaign campaign id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	public Collection&lt;CampaignHOO&gt; getCampaignHOOAssignments(ID idCampaign,
			Date dtStart, Date dtEnd) throws BbmFinderException {
<span class="fc" id="L83">		return getCampaignHOOAssignments(idCampaign, dtStart, dtEnd, true);</span>
	}

	/**
	 * get a given campaign's hour's of operations (used in v11)
	 *
	 * @param idCampaign      : campaign id
	 * @param dtStart         :
	 * @param dtEnd           : the time period, null date means a open period
	 * @param includeSubCamps : true if you want to include SPHOO's from sub-campaigns as
	 *                        well.
	 * @return a collection of CampaignHOO objects which hold the assignment
	 * information
	 * &lt;p&gt;
	 * NOTE: If the given campaign is a distributed campaign and
	 * includeSubCamps is true, then this method also returns
	 * CampaignHOO objects for its sub campaigns as well. The
	 * CampaignHOO objects that are returned are set with the campaign
	 * ID of the parent distributed campaign, even if the HOO belongs to
	 * the sub campaign. This seems like a bug but at the time of this
	 * comment it wasn't clear if changing that behavior was safe or
	 * could potentially introduce new bugs.
	 */
	public Collection&lt;CampaignHOO&gt; getCampaignHOOAssignments(ID idCampaign,
			Date dtStart, Date dtEnd, boolean includeSubCamps)
			throws BbmFinderException {
		try {
			// load all campaigns
<span class="fc" id="L111">			ArrayList&lt;CampaignHOO&gt; aAssignments = new ArrayList&lt;CampaignHOO&gt;();</span>

<span class="fc bfc" id="L113" title="All 2 branches covered.">			String query = includeSubCamps ? &quot;SELECT SPHOO.ID, DAY1STARTTIME,DAY1ENDTIME,DAY2STARTTIME,DAY2ENDTIME,DAY3STARTTIME,DAY3ENDTIME,DAY4STARTTIME,DAY4ENDTIME,DAY5STARTTIME,DAY5ENDTIME,DAY6STARTTIME,DAY6ENDTIME,DAY7STARTTIME,DAY7ENDTIME,&quot;</span>
					+ &quot;SPHOO.STARTDATE,SPHOO.ENDDATE,CAMPAIGN.WEEKSTART, B.SID SPID FROM SPHOO,SP A,SP B,CAMPAIGN&quot;
					+ &quot; WHERE CAMPAIGN.SID = &quot;
<span class="fc" id="L116">					+ JdmoUtil.asSqlLiteral(idCampaign)</span>
					+ &quot; AND A.CAMPAIGNID = CAMPAIGN.ID AND &quot;
					+ &quot; ( B.PARENTSPID = A.ID or B.ID = A.ID )&quot;
					+ &quot; AND SPHOO.SPID = B.ID AND B.FROMDATE &lt; '&quot;
<span class="fc" id="L120">					+ JdmoUtil.formatDBString(dtEnd)</span>
					+ &quot;' AND B.TODATE &gt; '&quot;
<span class="fc" id="L122">					+ JdmoUtil.formatDBString(dtStart)</span>
					+ &quot;' ORDER BY SPHOO.STARTDATE ASC&quot;
					: &quot;SELECT SPHOO.ID, DAY1STARTTIME,DAY1ENDTIME,DAY2STARTTIME,DAY2ENDTIME,DAY3STARTTIME,DAY3ENDTIME,DAY4STARTTIME,DAY4ENDTIME,DAY5STARTTIME,DAY5ENDTIME,DAY6STARTTIME,DAY6ENDTIME,DAY7STARTTIME,DAY7ENDTIME,&quot;
					+ &quot;SPHOO.STARTDATE,SPHOO.ENDDATE,CAMPAIGN.WEEKSTART, A.SID SPID FROM SPHOO,SP A,CAMPAIGN&quot;
					+ &quot; WHERE CAMPAIGN.SID = &quot;
<span class="fc" id="L127">					+ JdmoUtil.asSqlLiteral(idCampaign)</span>
					+ &quot; AND A.CAMPAIGNID = CAMPAIGN.ID &quot;
					+ &quot; AND SPHOO.SPID = A.ID AND A.FROMDATE &lt; '&quot;
<span class="fc" id="L130">					+ JdmoUtil.formatDBString(dtEnd)</span>
					+ &quot;' AND A.TODATE &gt; '&quot;
<span class="fc" id="L132">					+ JdmoUtil.formatDBString(dtStart)</span>
					+ &quot;' ORDER BY SPHOO.STARTDATE ASC&quot;;

<span class="fc" id="L135">			JdmoRowset r = m_dmo.createRowset(query);</span>

			// -------------------------------------------------
			// get data and create campaigns
			// -------------------------------------------------

<span class="fc bfc" id="L141" title="All 2 branches covered.">			while (r.next()) {</span>
<span class="fc" id="L142">				int[] nDayOpen = new int[8];</span>
<span class="fc" id="L143">				int[] nDayClose = new int[8];</span>

<span class="fc bfc" id="L145" title="All 2 branches covered.">				for (short n = 1; n &lt;= 7; n++) {</span>
<span class="fc" id="L146">					nDayOpen[n] = r.getInt(&quot;DAY&quot; + n + &quot;STARTTIME&quot;);</span>
<span class="fc" id="L147">					nDayClose[n] = r.getInt(&quot;DAY&quot; + n + &quot;ENDTIME&quot;);</span>
				}

<span class="fc" id="L150">				Date dtStart1 = r.getTimestamp(&quot;STARTDATE&quot;);</span>
<span class="fc" id="L151">				Date dtEnd1 = r.getTimestamp(&quot;ENDDATE&quot;);</span>
<span class="fc" id="L152">				ID idSP = r.getID(&quot;SPID&quot;);</span>
<span class="fc" id="L153">				ID id = r.getID(&quot;ID&quot;);</span>
<span class="fc" id="L154">				int nWeekBoundary = r.getInt(&quot;WEEKSTART&quot;);</span>

<span class="fc" id="L156">				CampaignHOO pAssignment = new CampaignHOO();</span>
<span class="fc" id="L157">				pAssignment.setID(id);</span>

				// WARNING: The SQL query above returns sub campaigns as well,
				// but we are setting the campaign ID as the parent campaign
				// ID. Could potentially cause bugs.
<span class="fc" id="L162">				pAssignment.setCampaignID(idCampaign);</span>

<span class="fc" id="L164">				pAssignment.setSPID(idSP);</span>
<span class="fc" id="L165">				pAssignment.setStartTime(dtStart1);</span>
<span class="fc" id="L166">				pAssignment.setEndTime(dtEnd1);</span>
<span class="fc" id="L167">				TimeZone tz = CampaignDAO.getTimeZoneByCampaignID(idCampaign);</span>
<span class="fc" id="L168">				pAssignment.setStartTimeLocal(new LocalDate(dtStart1, tz));</span>
<span class="fc" id="L169">				pAssignment.setEndTimeLocal(new LocalDate(dtEnd1, tz));</span>

<span class="fc" id="L171">				DAOUtil.HOODBtoHOOAssignment(nWeekBoundary, nDayOpen,</span>
						nDayClose, pAssignment);

<span class="fc" id="L174">				aAssignments.add(pAssignment);</span>
<span class="fc" id="L175">			}</span>

<span class="fc" id="L177">			r.close();</span>
<span class="fc" id="L178">			return aAssignments;</span>

<span class="nc" id="L180">		} catch (JdmoException e) {</span>
<span class="nc" id="L181">			e.printStackTrace();</span>
<span class="nc" id="L182">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L184">			m_dmo.cleanUp();</span>
		}
	}

	/**
	 * get a campaignHOO object by id
	 */
	public CampaignHOO getCampaignHOOAssignmentByID(ID idAssignment)
			throws BbmFinderException {
		try {
<span class="nc" id="L194">			String strWhere = &quot; SPHOO.ID = '&quot; + idAssignment + &quot;' &quot;;</span>
<span class="nc" id="L195">			Collection&lt;CampaignHOO&gt; col = getCampaignHOOAssignments(strWhere);</span>
			// expecting only one.
<span class="nc bnc" id="L197" title="All 2 branches missed.">			for (CampaignHOO ch : col) {</span>
<span class="nc" id="L198">				return ch;</span>
			}
<span class="nc" id="L200">			return (new CampaignHOO());</span>
<span class="nc" id="L201">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L202">			throw e;</span>
		}
	}

	public Collection&lt;CampaignHOO&gt; getCampaignHOOsByCampaignIDs(
			Collection&lt;ID&gt; campaignIDs, Date minDate, Date maxDate)
			throws BbmFinderException {

<span class="nc" id="L210">		List&lt;CampaignHOO&gt; result = new ArrayList&lt;CampaignHOO&gt;();</span>
<span class="nc bnc" id="L211" title="All 4 branches missed.">		if (campaignIDs == null || campaignIDs.isEmpty()) {</span>
<span class="nc" id="L212">			return result;</span>
		}

<span class="nc bnc" id="L215" title="All 2 branches missed.">		String minDateClause = (minDate != null) ? &quot; AND SPHOO.STARTDATE &lt;= '&quot;</span>
<span class="nc" id="L216">				+ JdmoUtil.formatDBString(maxDate) + &quot;'&quot; : &quot;&quot;;</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">		String maxDateClause = (maxDate != null) ? &quot; AND SPHOO.ENDDATE &gt;= '&quot;</span>
<span class="nc" id="L218">				+ JdmoUtil.formatDBString(minDate) + &quot;'&quot; : &quot;&quot;;</span>

		// build and run the query, and return the results
		try {
<span class="nc" id="L222">			String strWhere = &quot; CAMPAIGN.SID in &quot;</span>
<span class="nc" id="L223">					+ m_dmo.createInClause(campaignIDs) + minDateClause</span>
					+ maxDateClause + &quot; &quot;;
<span class="nc" id="L225">			return (getCampaignHOOAssignments(strWhere));</span>
<span class="nc" id="L226">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L227">			throw e;</span>
<span class="nc" id="L228">		} catch (JdmoException e) {</span>
<span class="nc" id="L229">			e.printStackTrace();</span>
<span class="nc" id="L230">			throw new BbmFinderException(e);</span>
		}
	}

	//ID can be either a string ID or an int ID
	public List&lt;CampaignHOO&gt; getCampaignHOOAssignmentsBySP(ID spId)
			throws BbmFinderException {
		try {
<span class="fc" id="L238">			return getCampaignHOOAssignments(getWhereClauseForSpId(spId));</span>
<span class="nc" id="L239">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L240">			throw e;</span>
		}
	}

	/**
	 * get a given Scheduling Period's hour's of operations (used in v11)
	 *
	 * @return a collection of Scheduling Period HOO objects which hold the
	 * assignment information
	 * @idCampaign campaign id
	 * @dtStart, @dtEnd: the time period, null date means a open period
	 */
	private List&lt;CampaignHOO&gt; getCampaignHOOAssignments(String strWhere)
			throws BbmFinderException {
		try {
			// load all campaigns
<span class="fc" id="L256">			ArrayList&lt;CampaignHOO&gt; aAssignments = new ArrayList&lt;CampaignHOO&gt;();</span>

<span class="fc" id="L258">			String query = &quot;SELECT SPHOO.ID, DAY1STARTTIME,DAY1ENDTIME,DAY2STARTTIME,DAY2ENDTIME,DAY3STARTTIME,DAY3ENDTIME,DAY4STARTTIME,DAY4ENDTIME,DAY5STARTTIME,DAY5ENDTIME,DAY6STARTTIME,DAY6ENDTIME,DAY7STARTTIME,DAY7ENDTIME,&quot;</span>
					+ &quot;SPHOO.STARTDATE,SPHOO.ENDDATE,CAMPAIGN.SID CSID, CAMPAIGN.WEEKSTART, SP.SID SPID FROM SPHOO,SP,CAMPAIGN&quot;
					+ &quot; WHERE &quot;
					+ strWhere
					+ &quot; AND SP.CAMPAIGNID = CAMPAIGN.ID &quot;
					+ &quot; AND SPHOO.SPID = SP.ID ORDER BY SPHOO.STARTDATE ASC&quot;;

<span class="fc" id="L265">			JdmoRowset r = m_dmo.createRowset(query);</span>

			// -------------------------------------------------
			// Convert rowsets to HOOs
			// -------------------------------------------------

<span class="fc bfc" id="L271" title="All 2 branches covered.">			while (r.next()) {</span>
<span class="fc" id="L272">				int[] nDayOpen = new int[8];</span>
<span class="fc" id="L273">				int[] nDayClose = new int[8];</span>

<span class="fc bfc" id="L275" title="All 2 branches covered.">				for (short n = 1; n &lt;= 7; n++) {</span>
<span class="fc" id="L276">					nDayOpen[n] = r.getInt(&quot;DAY&quot; + n + &quot;STARTTIME&quot;);</span>
<span class="fc" id="L277">					nDayClose[n] = r.getInt(&quot;DAY&quot; + n + &quot;ENDTIME&quot;);</span>
				}

<span class="fc" id="L280">				Date dtStart1 = r.getTimestamp(&quot;STARTDATE&quot;);</span>
<span class="fc" id="L281">				Date dtEnd1 = r.getTimestamp(&quot;ENDDATE&quot;);</span>
<span class="fc" id="L282">				ID id = r.getID(&quot;ID&quot;);</span>
<span class="fc" id="L283">				ID idSP = r.getID(&quot;SPID&quot;);</span>
<span class="fc" id="L284">				ID idCampaign = r.getID(&quot;CSID&quot;);</span>
<span class="fc" id="L285">				int nWeekBoundary = r.getInt(&quot;WEEKSTART&quot;);</span>

<span class="fc" id="L287">				CampaignHOO pAssignment = new CampaignHOO();</span>
<span class="fc" id="L288">				pAssignment.setID(id);</span>
<span class="fc" id="L289">				pAssignment.setCampaignID(idCampaign);</span>
<span class="fc" id="L290">				pAssignment.setSPID(idSP);</span>
<span class="fc" id="L291">				pAssignment.setStartTime(dtStart1);</span>
<span class="fc" id="L292">				pAssignment.setEndTime(dtEnd1);</span>
<span class="fc" id="L293">				TimeZone tz = CampaignDAO.getTimeZoneByCampaignID(idCampaign);</span>
<span class="fc" id="L294">				pAssignment.setStartTimeLocal(new LocalDate(dtStart1, tz));</span>
<span class="fc" id="L295">				pAssignment.setEndTimeLocal(new LocalDate(dtEnd1, tz));</span>

<span class="fc" id="L297">				int dayIndex /* 1-Sun... */ = nWeekBoundary / 1440 + 1;</span>
<span class="fc" id="L298">				int dayOffset = nWeekBoundary % 1440;</span>
				// int firstDayIndex /*1-Sun...*/ = dayIndex;
<span class="fc bfc" id="L300" title="All 2 branches covered.">				for (short n = 1; n &lt;= 7; n++) {</span>

<span class="fc bfc" id="L302" title="All 2 branches covered.">					if (dayIndex &gt; 7) {</span>
<span class="fc" id="L303">						dayIndex = 1;</span>
					}
<span class="fc bfc" id="L305" title="All 2 branches covered.">					if (nDayOpen[n] == -1) {</span>
<span class="fc" id="L306">						pAssignment.setActive((short) dayIndex, false);</span>
					} else {
<span class="fc bfc" id="L308" title="All 2 branches covered.">						short open = (short) (((nDayOpen[n] == 0) ? 0</span>
								: nDayOpen[n] % 1440) + dayOffset);
<span class="fc bfc" id="L310" title="All 2 branches covered.">						short close = (short) (((nDayClose[n] % 1440 == 0) ? 1440</span>
								: nDayClose[n] % 1440) + dayOffset);

<span class="fc" id="L313">						pAssignment.setDayOpen((short) dayIndex, open);</span>
<span class="fc" id="L314">						pAssignment.setDayClose((short) dayIndex, close);</span>
					}
<span class="fc" id="L316">					++dayIndex;</span>
				}
<span class="fc" id="L318">				aAssignments.add(pAssignment);</span>
<span class="fc" id="L319">			}</span>

<span class="fc" id="L321">			r.close();</span>
<span class="fc" id="L322">			return aAssignments;</span>

<span class="nc" id="L324">		} catch (JdmoException e) {</span>
<span class="nc" id="L325">			e.printStackTrace();</span>
<span class="nc" id="L326">			throw new BbmFinderException(e);</span>
		} finally {
<span class="pc" id="L328">			m_dmo.cleanUp();</span>
		}
	}

	public ID createCampaignHOOAssignment(CampaignHOO campaignHOO)
			throws BbmCreateException {
		// convert CampaignHOO to SPHOO - campaign hoo are
<span class="fc" id="L335">		short spDayOpen[] = new short[8];</span>
<span class="fc" id="L336">		short spDayClose[] = new short[8];</span>
		short sspDayOpen, sspDayClose;
		int spWeekDay, spWeekDayMinsOffset;
<span class="fc" id="L339">		int weekStart = 0;</span>
<span class="fc" id="L340">		int dayBoundaryOffset = 0;</span>
		try {
<span class="fc" id="L342">			CampaignDAO campDAO = new CampaignDAO(m_dmo);</span>
<span class="fc" id="L343">			Campaign camp = campDAO.getCampaignByID(</span>
<span class="fc" id="L344">					campaignHOO.getCampaignID(), false);</span>
<span class="fc" id="L345">			TimeZone tz = CampaignDAO.getTimeZoneByCampaignID(campaignHOO</span>
<span class="fc" id="L346">					.getCampaignID());</span>

<span class="fc" id="L348">			Date startGMTDt = TimePeriodUtil</span>
<span class="fc" id="L349">					.convertToGMTFromLocalDateTimeInTimeZone(</span>
<span class="fc" id="L350">							campaignHOO.getStartTimeLocal(), tz);</span>
<span class="fc" id="L351">			Date endGMTDt = TimePeriodUtil</span>
<span class="fc" id="L352">					.convertToGMTFromLocalDateTimeInTimeZone(</span>
<span class="fc" id="L353">							campaignHOO.getEndTimeLocal(), tz);</span>

<span class="fc" id="L355">			weekStart = (camp.getWeekStart() / 1440) + 1;</span>
<span class="fc" id="L356">			dayBoundaryOffset = camp.getWeekStart() % 1440;</span>
<span class="fc bfc" id="L357" title="All 2 branches covered.">			for (short i = 1; i &lt; 8; i++) {</span>
<span class="fc" id="L358">				sspDayOpen = campaignHOO.getDayOpen(i);</span>
<span class="fc" id="L359">				sspDayClose = campaignHOO.getDayClose(i);</span>

<span class="fc" id="L361">				spWeekDay = (i + 8 - weekStart) % 7;</span>
<span class="fc bfc" id="L362" title="All 2 branches covered.">				if (spWeekDay == 0) {</span>
<span class="fc" id="L363">					spWeekDay = 7;</span>
				}
<span class="pc bpc" id="L365" title="1 of 2 branches missed.">				if (sspDayOpen == -1) {</span>
<span class="fc" id="L366">					spDayOpen[spWeekDay] = -1;</span>
<span class="fc" id="L367">					spDayClose[spWeekDay] = -1;</span>
				} else {
<span class="nc" id="L369">					spWeekDayMinsOffset = (spWeekDay - 1) * 1440</span>
							- dayBoundaryOffset;
<span class="nc" id="L371">					spDayOpen[spWeekDay] = (short) (spWeekDayMinsOffset + sspDayOpen);</span>
<span class="nc" id="L372">					spDayClose[spWeekDay] = (short) (spWeekDayMinsOffset + sspDayClose);</span>
				}
			} // end of for loop for setting days start and end values.

			// get ID from DE
<span class="fc" id="L377">			String idStr = DAOUtil.getDEID(m_dmo);</span>

<span class="fc" id="L379">			String pStmt1 = &quot;insert into SPHOO &quot;</span>
					+ &quot;(ID,SPID,STARTDATE,ENDDATE,&quot;
					+ &quot;DAY1STARTTIME,DAY1ENDTIME,&quot;
					+ &quot;DAY2STARTTIME,DAY2ENDTIME,&quot;
					+ &quot;DAY3STARTTIME,DAY3ENDTIME,&quot;
					+ &quot;DAY4STARTTIME,DAY4ENDTIME,&quot;
					+ &quot;DAY5STARTTIME,DAY5ENDTIME,&quot;
					+ &quot;DAY6STARTTIME,DAY6ENDTIME,&quot;
					+ &quot;DAY7STARTTIME,DAY7ENDTIME) &quot;
					+ &quot;values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;;

<span class="fc" id="L390">			Object[] param = new Object[18];</span>
<span class="fc" id="L391">			param[0] = idStr;</span>
<span class="fc" id="L392">			param[1] = getDEIDFromSID(&quot;SP&quot;, campaignHOO.getSPID());</span>
<span class="fc" id="L393">			param[2] = JdmoUtil.formatDBString(startGMTDt);</span>
<span class="fc" id="L394">			param[3] = JdmoUtil.formatDBString(endGMTDt);</span>
<span class="fc bfc" id="L395" title="All 2 branches covered.">			for (int j = 1; j &lt; 8; j++) {</span>
<span class="fc" id="L396">				param[(j * 2) + 2] = NumberFactory.newInteger(spDayOpen[j]);</span>
<span class="fc" id="L397">				param[(j * 2) + 3] = NumberFactory.newInteger(spDayClose[j]);</span>
			}

<span class="fc" id="L400">			m_dmo.executePCommand(pStmt1, param);</span>

<span class="fc" id="L402">			ID DESubSPID = null;</span>
<span class="fc" id="L403">			ID parentID = getDEIDFromSID(&quot;SP&quot;, campaignHOO.getSPID());</span>
<span class="fc" id="L404">			String stmtSubCamps = &quot;SELECT SP.ID, CAMPAIGN.SID FROM SP, CAMPAIGN WHERE campaign.id = sp.campaignid AND PARENTSPID = '&quot;</span>
					+ parentID + &quot;'&quot;;
<span class="fc" id="L406">			JdmoRowset rsSubSPs = m_dmo.createRowset(stmtSubCamps);</span>
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">			while (rsSubSPs.next()) {</span>
<span class="nc" id="L408">				DESubSPID = rsSubSPs.getID(1);</span>
<span class="nc" id="L409">				ID subCampID = rsSubSPs.getID(2);</span>
<span class="nc" id="L410">				tz = CampaignDAO.getTimeZoneByCampaignID(subCampID);</span>
<span class="nc" id="L411">				startGMTDt = TimePeriodUtil</span>
<span class="nc" id="L412">						.convertToGMTFromLocalDateTimeInTimeZone(</span>
<span class="nc" id="L413">								campaignHOO.getStartTimeLocal(), tz);</span>
<span class="nc" id="L414">				endGMTDt = TimePeriodUtil</span>
<span class="nc" id="L415">						.convertToGMTFromLocalDateTimeInTimeZone(</span>
<span class="nc" id="L416">								campaignHOO.getEndTimeLocal(), tz);</span>

<span class="nc" id="L418">				String hooIDStr = DAOUtil.getDEID(m_dmo);</span>

<span class="nc" id="L420">				String pStmt2 = &quot;insert into SPHOO &quot;</span>
						+ &quot;(ID,SPID,STARTDATE,ENDDATE,&quot;
						+ &quot;DAY1STARTTIME,DAY1ENDTIME,&quot;
						+ &quot;DAY2STARTTIME,DAY2ENDTIME,&quot;
						+ &quot;DAY3STARTTIME,DAY3ENDTIME,&quot;
						+ &quot;DAY4STARTTIME,DAY4ENDTIME,&quot;
						+ &quot;DAY5STARTTIME,DAY5ENDTIME,&quot;
						+ &quot;DAY6STARTTIME,DAY6ENDTIME,&quot;
						+ &quot;DAY7STARTTIME,DAY7ENDTIME) &quot;
						+ &quot;values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;;

<span class="nc" id="L431">				Object[] param2 = new Object[18];</span>
<span class="nc" id="L432">				param2[0] = hooIDStr;</span>
<span class="nc" id="L433">				param2[1] = DESubSPID;</span>
<span class="nc" id="L434">				param2[2] = JdmoUtil.formatDBString(startGMTDt);</span>
<span class="nc" id="L435">				param2[3] = JdmoUtil.formatDBString(endGMTDt);</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">				for (int j = 1; j &lt; 8; j++) {</span>
<span class="nc" id="L437">					param2[(j * 2) + 2] = NumberFactory</span>
<span class="nc" id="L438">							.newInteger(spDayOpen[j]);</span>
<span class="nc" id="L439">					param2[(j * 2) + 3] = NumberFactory</span>
<span class="nc" id="L440">							.newInteger(spDayClose[j]);</span>
				}
<span class="nc" id="L442">				int test = 3;</span>
<span class="nc" id="L443">				test++;</span>
<span class="nc" id="L444">				System.out.print(test);</span>
<span class="nc" id="L445">				m_dmo.executePCommand(pStmt2, param2);</span>
<span class="nc" id="L446">			}</span>

<span class="fc" id="L448">			return new ID(idStr);</span>

<span class="nc" id="L450">		} catch (BbmObjectNotFoundException e) {</span>
<span class="nc" id="L451">			throw new BbmCreateException(e);</span>
<span class="nc" id="L452">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L453">			throw new BbmCreateException(e);</span>
<span class="nc" id="L454">		} catch (JdmoException e) {</span>
<span class="nc" id="L455">			throw new BbmCreateException(e);</span>
		} finally {
<span class="pc" id="L457">			m_dmo.cleanUp();</span>
		}
	}

	private ID getDEIDFromSID(String TableName, ID sidValue)
			throws JdmoException {

<span class="fc" id="L464">		ID DEID = null;</span>
<span class="fc" id="L465">		String stmt = &quot;SELECT ID FROM &quot; + TableName + &quot; WHERE SID='&quot; + sidValue</span>
				+ &quot;'&quot;;
<span class="fc" id="L467">		JdmoRowset rs = m_dmo.createRowset(stmt);</span>
<span class="pc bpc" id="L468" title="1 of 2 branches missed.">		if (rs.next()) {</span>
<span class="fc" id="L469">			DEID = rs.getID(1);</span>
		}
<span class="fc" id="L471">		return DEID;</span>
	}

	/**
	 * update a campaign's HOO assignment
	 */
	public void updateCampaignHOOAssignment(CampaignHOO campaignHOO)
			throws BbmUpdateException {
<span class="fc" id="L479">		short spDayOpen[] = new short[8];</span>
<span class="fc" id="L480">		short spDayClose[] = new short[8];</span>
		short sspDayOpen, sspDayClose;
		int spWeekDay, spWeekDayMinsOffset;
<span class="fc" id="L483">		int weekStart = 0;</span>
<span class="fc" id="L484">		int dayBoundaryOffset = 0;</span>
		try {
<span class="fc" id="L486">			CampaignDAO campDAO = new CampaignDAO(m_dmo);</span>
<span class="fc" id="L487">			Campaign camp = campDAO.getCampaignByID(</span>
<span class="fc" id="L488">					campaignHOO.getCampaignID(), false);</span>

<span class="fc" id="L490">			weekStart = (camp.getWeekStart() / 1440) + 1;</span>
<span class="fc" id="L491">			dayBoundaryOffset = camp.getWeekStart() % 1440;</span>
<span class="fc bfc" id="L492" title="All 2 branches covered.">			for (short i = 1; i &lt; 8; i++) {</span>
<span class="fc" id="L493">				sspDayOpen = campaignHOO.getDayOpen(i);</span>
<span class="fc" id="L494">				sspDayClose = campaignHOO.getDayClose(i);</span>

<span class="fc" id="L496">				spWeekDay = (i + 8 - weekStart) % 7;</span>
<span class="fc bfc" id="L497" title="All 2 branches covered.">				if (spWeekDay == 0) {</span>
<span class="fc" id="L498">					spWeekDay = 7;</span>
				}
<span class="fc bfc" id="L500" title="All 2 branches covered.">				if (sspDayOpen == -1) {</span>
<span class="fc" id="L501">					spDayOpen[spWeekDay] = -1;</span>
<span class="fc" id="L502">					spDayClose[spWeekDay] = -1;</span>
				} else {
<span class="fc" id="L504">					spWeekDayMinsOffset = (spWeekDay - 1) * 1440</span>
							- dayBoundaryOffset;
<span class="fc" id="L506">					spDayOpen[spWeekDay] = (short) (spWeekDayMinsOffset + sspDayOpen);</span>
<span class="fc" id="L507">					spDayClose[spWeekDay] = (short) (spWeekDayMinsOffset + sspDayClose);</span>
				}
			} // end of for loop for setting days start and end values.
			String strUpdate;
<span class="fc" id="L511">			strUpdate = &quot;update SPHOO set  &quot; + &quot; DAY1STARTTIME= &quot;</span>
					+ spDayOpen[1] + &quot;, DAY1ENDTIME= &quot; + spDayClose[1]
					+ &quot;, DAY2STARTTIME= &quot; + spDayOpen[2] + &quot;, DAY2ENDTIME= &quot;
					+ spDayClose[2] + &quot;, DAY3STARTTIME= &quot; + spDayOpen[3]
					+ &quot;, DAY3ENDTIME= &quot; + spDayClose[3] + &quot;, DAY4STARTTIME= &quot;
					+ spDayOpen[4] + &quot;, DAY4ENDTIME= &quot; + spDayClose[4]
					+ &quot;, DAY5STARTTIME= &quot; + spDayOpen[5] + &quot;, DAY5ENDTIME= &quot;
					+ spDayClose[5] + &quot;, DAY6STARTTIME= &quot; + spDayOpen[6]
					+ &quot;, DAY6ENDTIME= &quot; + spDayClose[6] + &quot;, DAY7STARTTIME= &quot;
					+ spDayOpen[7] + &quot;, DAY7ENDTIME= &quot; + spDayClose[7]
<span class="fc" id="L521">					+ &quot; WHERE ID = '&quot; + campaignHOO.getID().toString() + &quot;'&quot;;</span>
<span class="fc" id="L522">			m_dmo.executeCommand(strUpdate);</span>
<span class="nc" id="L523">		} catch (Exception e) {</span>
<span class="nc" id="L524">			throw new BbmUpdateException(e);</span>
<span class="fc" id="L525">		}</span>
<span class="fc" id="L526">	}</span>

	/**
	 * delete a campaign's HOO assignment given the assignment ids
	 */
	public void deleteCampaignHOOAssignments(Collection&lt;ID&gt; colIDAssignments)
			throws BbmRemoveException {
<span class="nc" id="L533">		deleteObjects(colIDAssignments);</span>
<span class="nc" id="L534">	}</span>

	/**
	 * create campaign HOO based on its linked organization HOO.
	 * &lt;p&gt;
	 * 1. do not create any campaignHOO if the campaign already has an hours of
	 * operation. 2. set campaign HOO to be the same as the organization HOO if
	 * they have the same time zone.
	 *
	 * @return the campaignHOO ID if created successfully
	 */
	public ID createCampaignHOOFromOrg(ID idCampaign, ID idOrg)
			throws Exception {
		// 1. do not create any campaignHOO if the campaign already has
		// an hours of operation.
<span class="nc" id="L549">		Collection col = getCampaignHOOAssignments(idCampaign, null, null);</span>
<span class="nc bnc" id="L550" title="All 4 branches missed.">		if (col != null &amp;&amp; (!col.isEmpty())) {</span>
<span class="nc" id="L551">			return null;</span>
		}

		// 2. check if the time zone are the same
<span class="nc" id="L555">		CampaignDAO daoCampaign = new CampaignDAO(m_dmo);</span>
<span class="nc" id="L556">		Campaign cp = daoCampaign.getCampaignByID(idCampaign, false);</span>

<span class="nc" id="L558">		WorkResourceManager wrMgr = BbmManagerFactory.getWorkResourceManager();</span>
<span class="nc" id="L559">		Organization org = wrMgr.getOrganizationByID(idOrg);</span>

<span class="nc bnc" id="L561" title="All 2 branches missed.">		if (!cp.getTimeZone().equals(org.getTimeZone())) {</span>
<span class="nc" id="L562">			return null;</span>
		}

		// 3. get Organization HOO
<span class="nc" id="L566">		Date dtValue = cp.getStartTime();</span>
<span class="nc" id="L567">		col = wrMgr</span>
<span class="nc" id="L568">				.getOrganizationHOOAssignments(org.getID(), dtValue, dtValue);</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">		if (col.isEmpty()) {</span>
<span class="nc" id="L570">			return null;</span>
		}

<span class="nc" id="L573">		OrganizationHOO orgHOO = (OrganizationHOO) col.iterator().next();</span>
<span class="nc" id="L574">		CampaignHOO cpHOO = new CampaignHOO();</span>

<span class="nc" id="L576">		cpHOO.setCampaignID(idCampaign);</span>
<span class="nc" id="L577">		cpHOO.setStartTime(dtValue);</span>

<span class="nc bnc" id="L579" title="All 2 branches missed.">		for (short iDay = 1; iDay &lt;= 7; iDay++) {</span>
<span class="nc" id="L580">			cpHOO.setDayOpen(iDay, orgHOO.getDayOpen(iDay));</span>
<span class="nc" id="L581">			cpHOO.setDayClose(iDay, orgHOO.getDayClose(iDay));</span>
		}

<span class="nc" id="L584">		return createObject(cpHOO);</span>
	}

	/**
	 * fetch a collection of HOO for the given campaign and using campaign TZ to
	 * prepare the HOOPeriod object. HOOPeriod differ from HOO since it is not a
	 * template but a daily definition of HOO in the given period.
	 */
	public HOOPeriod getHOOPeriod(ID idCampaign, Date dtStart, Date dtEnd)
			throws BbmFinderException {
		// get campaign, need the campaign time zone
<span class="fc" id="L595">		CampaignDAO cpDAO = new CampaignDAO(m_dmo);</span>
<span class="fc" id="L596">		Campaign cp = cpDAO.getCampaignByID(idCampaign, false);</span>

<span class="fc" id="L598">		Collection&lt;CampaignHOO&gt; colAssignments = this.getCampaignHOOAssignments(idCampaign,</span>
				dtStart, dtEnd);
<span class="fc" id="L600">		return new CampaignHOOPeriod(dtStart, dtEnd, cp.getTimeZone(),</span>
				colAssignments);
	}


	static String getWhereClauseForSpId(ID spId) {
<span class="fc" id="L606">		String strWhere = &quot;&quot;;</span>
<span class="pc bpc" id="L607" title="1 of 2 branches missed.">		if (spId.isInt()) {</span>
<span class="fc" id="L608">			strWhere = &quot; SP.SID = &quot; + JdmoUtil.asSqlLiteral(spId) + &quot; &quot;;</span>
		} else {
<span class="nc" id="L610">			strWhere = &quot; SP.ID = &quot; + JdmoUtil.asSqlLiteral(spId) + &quot; &quot;;</span>
		}
<span class="fc" id="L612">		return strWhere;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>