<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>QueueSelectorPopupPageModel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.bbm.workload.queue</a> &gt; <span class="el_source">QueueSelectorPopupPageModel.java</span></div><h1>QueueSelectorPopupPageModel.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.bbm.workload.queue;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.workload.WorkloadModelHandler;
import com.verint.web.wfm.keys.WfmJavaScriptFileID;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultNodeData;
import com.witness.web.uif.pagecomponent.assignmentbox.AssignmentBoxPC;
import com.witness.web.uif.pagemodel.PopupWindowPM;
import com.witness.web.uif.system.RequestContext;

/**
 * Title:        Queue Selector Popup Page Model
 * Description:  A page model for a Queue selector popup
 * Copyright:    Copyright (c) 2010
 * Company:      Verint Systems, Inc
 * @author       Gonzalo Quintanar
 */
@SuppressWarnings(&quot;serial&quot;)
public class QueueSelectorPopupPageModel  extends PopupWindowPM {
	public static final String QUEUE_SELECTOR_POPUP_ACTION = &quot;POPUP_QUEUE_SELECTOR&quot;;
	public static final String QUEUE_SELECTOR_POPUP_URL = &quot;queue_selector_asglist_popup&quot;;
	public static final String QUEUE_SELECTOR_POPUP_SIZE_POSITION = &quot;470,450,ctr,ctr&quot;;
	
	protected ResourceBundle m_bbmBundle;
	private AssignmentBoxPC m_assignmentBox;
<span class="fc" id="L39">	private boolean m_isInitiated = false;</span>
	
	private ID m_orgId; //The ID of the organization where the activity is defined
	private Collection&lt;ID&gt; m_mediaIds; //We will need to load all of the queues for these media types only
	private ID[] m_assignedQueueIds; //these are queue IDs that have already been assigned (in the right list)
	private Map&lt;ID, Queue&gt; m_allQueuesMap; //a map of queueID to queue for all the queues in this dialog

	/**
	 * Constructor
	 */
	public QueueSelectorPopupPageModel(RequestContext context) {
<span class="fc" id="L50">		super(context);</span>
<span class="fc" id="L51">		m_bbmBundle = m_localizer.getBundle(BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L52">		setJSMediator(WfmJavaScriptFileID.MEDIATOR_QUEUE_SELECTOR_POPUP);</span>
<span class="fc" id="L53">	}</span>

	 public void initForDisplay() {
<span class="pc bpc" id="L56" title="1 of 2 branches missed.">		if (m_isInitializedForDisplay) return;</span>
		else {
<span class="fc" id="L58">			super.initForDisplay();</span>
<span class="fc" id="L59">			setName(&quot;QueueSelectorPopup&quot;);</span>
			
<span class="fc" id="L61">			initToolbar();</span>
<span class="fc" id="L62">			initTitle();</span>
<span class="fc" id="L63">			initAssignmentBox();</span>
		}
<span class="fc" id="L65">	 }</span>

	 /**
	 * Prepare toolbar for rendering
	 */
	protected void initToolbar() {
<span class="fc" id="L71">		String setLabel = i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_SET);</span>

<span class="fc" id="L73">		String setBtnOnClickJS = &quot;window.pageMediator.handleSaveAction();&quot;;</span>
<span class="fc" id="L74">		m_toolbar.addJSTextButton(PageAction.SET, setLabel, true, setBtnOnClickJS);</span>

<span class="fc" id="L76">		m_toolbar.addCloseWindowTextButton(</span>
				PageAction.CANCEL,
<span class="fc" id="L78">				i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_CANCEL),</span>
				true);

<span class="fc" id="L81">	}</span>

	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static QueueSelectorPopupPageModel getInstance(RequestContext context) {
<span class="fc" id="L87">		QueueSelectorPopupPageModel model = (QueueSelectorPopupPageModel) context.getPageModel();</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">		if (model==null){</span>
<span class="fc" id="L89">			model = new QueueSelectorPopupPageModel(context);</span>
<span class="fc" id="L90">			model.extractParameters(context.getRequest());</span>
<span class="fc" id="L91">			context.setPageModel(model);</span>
		}
<span class="fc" id="L93">		model.populateModel();</span>
<span class="fc" id="L94">		return model;</span>
	}


	private void populateModel() {
<span class="fc bfc" id="L99" title="All 2 branches covered.">		if ( m_isInitiated ) return; else m_isInitiated = true;</span>
		try {
<span class="fc" id="L101">			m_allQueuesMap = WorkloadModelHandler.getQueuesMapByRecursedOrgID(m_context, m_orgId, m_mediaIds);</span>
			
			//It is possible that we could have a queue that is already assigned but not in the map that is
			//returned from getQueuesMapByRecursedOrgID (for example, if a queue defined at a parent org is
			//assigned to an activity (also defined at that parent org) and then that queue is
			//moved to a child org, the queue will still be associated to that activity even
			//though that queue is no longer visible to the parent org).  In these cases we need to load
			//the queue objects for the queues that are already assigned but not yet in the map.
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">			if (m_assignedQueueIds != null) {</span>
<span class="nc" id="L110">				ArrayList&lt;ID&gt; assignedQueueIDsToLoad = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">				for (ID queueID : m_assignedQueueIds) {</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">					if (m_allQueuesMap.containsKey(queueID) == false) {</span>
<span class="nc" id="L113">						assignedQueueIDsToLoad.add(queueID);</span>
					}
				}
<span class="nc bnc" id="L116" title="All 2 branches missed.">				if (assignedQueueIDsToLoad.isEmpty() == false) {</span>
<span class="nc" id="L117">					Collection&lt;Queue&gt; queues = WorkloadModelHandler.getQueuesByIDs(m_context, assignedQueueIDsToLoad);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">					for (Queue queue : queues) {</span>
<span class="nc" id="L119">						m_allQueuesMap.put(queue.getID(), queue);</span>
<span class="nc" id="L120">					}</span>
				}
			}		
<span class="nc" id="L123">		} catch (Exception ex) {</span>
<span class="nc" id="L124">			handleUnableToLoadDataError(log, ex);</span>
<span class="fc" id="L125">		}</span>
<span class="fc" id="L126">	}</span>

	private void initTitle(){
<span class="fc" id="L129">		m_contentTitlePC.setPageTitle(i18n(m_bbmBundle, BbmWebBundleKey.QUEUES_TITLE));</span>
<span class="fc" id="L130">	 }</span>

	 private void initAssignmentBox() {
<span class="fc" id="L133">		m_assignmentBox = new AssignmentBoxPC(m_context);</span>
<span class="fc" id="L134">		addChildComponent(m_assignmentBox);</span>
<span class="fc" id="L135">		m_assignmentBox.setName(getName() + &quot;_assignmentbox&quot;);</span>
<span class="fc" id="L136">		m_assignmentBox.setHeaderTitle(&quot;&quot;);</span>
<span class="fc" id="L137">		m_assignmentBox.setLeftTitle(i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_LABEL_AVAILABLE));</span>
<span class="fc" id="L138">		m_assignmentBox.setRightTitle(i18n(m_bbmBundle, BbmWebBundleKey.QUEUE_LABEL_ASSIGNED));</span>
<span class="fc" id="L139">		m_assignmentBox.setItemCount(10);</span>

		// Get the assigned/available media nodes
<span class="pc bpc" id="L142" title="2 of 4 branches missed.">		if(m_allQueuesMap == null || m_allQueuesMap.isEmpty()) { //no queues are defined for this organization/media combo</span>
<span class="nc" id="L143">			return;</span>
		}
		
<span class="fc" id="L146">		Collection sortedQueueIds = getSortedQueueIds(m_allQueuesMap); //.keySet();</span>
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">		int assignedQueuesSize = (m_assignedQueueIds == null)? 0: m_assignedQueueIds.length;</span>
<span class="fc" id="L148">		int availableQueuesSize = sortedQueueIds.size() - assignedQueuesSize;</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">		if (availableQueuesSize &lt; 0) {</span>
<span class="nc" id="L150">			availableQueuesSize = 0;</span>
		}
<span class="fc" id="L152">		List&lt;DefaultNodeData&gt; assignedQueueNodes = new ArrayList&lt;DefaultNodeData&gt;(assignedQueuesSize);</span>
<span class="fc" id="L153">		List&lt;DefaultNodeData&gt; availableQueueNodes = new ArrayList&lt;DefaultNodeData&gt;(availableQueuesSize);</span>
<span class="fc" id="L154">		Queue queue = null;</span>
<span class="fc" id="L155">		ID id = null;</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">		for(Iterator it =  sortedQueueIds.iterator(); it.hasNext();) {</span>
<span class="fc" id="L157">			id = (ID)it.next();</span>
<span class="fc" id="L158">			queue = (Queue)m_allQueuesMap.get(id);</span>
			
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">			if(isAssigned(id)) </span>
			{
<span class="nc" id="L162">				assignedQueueNodes.add(new DefaultNodeData(queue.getID().toString(), queue.getName(),</span>
<span class="nc" id="L163">					StringUtil.convertEmptyStringToNBSP(queue.getDescription())));</span>
			}
			else 
			{
<span class="fc" id="L167">				availableQueueNodes.add(new DefaultNodeData(queue.getID().toString(), queue.getName(),</span>
<span class="fc" id="L168">					StringUtil.convertEmptyStringToNBSP(queue.getDescription())));</span>
			}
		}
<span class="fc" id="L171">		m_assignmentBox.getLeftListPC().setData(availableQueueNodes);</span>
<span class="fc" id="L172">		m_assignmentBox.getRightListPC().setData(assignedQueueNodes);</span>
<span class="fc" id="L173">	 }</span>

	private List&lt;ID&gt; getSortedQueueIds(Map allQueuesMap){
<span class="fc" id="L176">		 Collection unsortedIds = allQueuesMap.keySet();</span>
<span class="fc" id="L177">		 List&lt;SortableQueueNameIdPair&gt; sortablePairs =</span>
<span class="fc" id="L178">				new ArrayList&lt;SortableQueueNameIdPair&gt;(unsortedIds.size());</span>
		 
		 //create a list of unsorted SortableQueueNameIdPair's
<span class="fc bfc" id="L181" title="All 2 branches covered.">		 for (Iterator it=unsortedIds.iterator(); it.hasNext();)</span>
		 {
<span class="fc" id="L183">			 ID queueId = (ID) it.next();</span>
<span class="fc" id="L184">			 Queue queue = (Queue) allQueuesMap.get(queueId);</span>
<span class="fc" id="L185">			 sortablePairs.add(new SortableQueueNameIdPair(queue.getName(), queue.getID()));</span>
<span class="fc" id="L186">		 }</span>
		 
		 //sort the list
<span class="fc" id="L189">		 Collections.sort(sortablePairs);</span>
		 
		 //extract the sorted IDs from the list
<span class="fc" id="L192">		 ArrayList sortedIds = new ArrayList();</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">		 for (Iterator it=sortablePairs.iterator(); it.hasNext();)</span>
		 {
<span class="fc" id="L195">			 SortableQueueNameIdPair pair = (SortableQueueNameIdPair) it.next();</span>
<span class="fc" id="L196">			 sortedIds.add(pair.m_id);</span>
<span class="fc" id="L197">		 }</span>
		 
<span class="fc" id="L199">		 return sortedIds;</span>
	 }
	 
	private class SortableQueueNameIdPair implements Comparable
	{
		public String m_name;
		public ID m_id;
		
		public SortableQueueNameIdPair(String name, ID id)
<span class="fc" id="L208">		{</span>
<span class="fc" id="L209">			m_name = name;</span>
<span class="fc" id="L210">			m_id = id;</span>
<span class="fc" id="L211">		}</span>
		
		public int compareTo(Object other)
		{
<span class="fc" id="L215">			return m_name.compareTo(((SortableQueueNameIdPair)other).m_name);</span>
		}
	}


	public Collection getMedia() {
<span class="nc" id="L221">		return m_mediaIds;</span>
	}

	public void setMedia(String mediaString) {
<span class="nc bnc" id="L225" title="All 2 branches missed.">		if (!StringUtil.isEmpty(mediaString)) {</span>
<span class="nc" id="L226">			m_mediaIds = StringUtil.parseIDStringToCollection(mediaString, &quot;,&quot;);</span>
		} else {
<span class="nc" id="L228">			m_mediaIds = Collections.emptyList();</span>
		}
<span class="nc" id="L230">	}</span>

	public ID[] getQueues() {
<span class="nc" id="L233">		return m_assignedQueueIds;</span>
	}
	
	public void setQueues(String queueString) {
<span class="nc bnc" id="L237" title="All 2 branches missed.">		if (!StringUtil.isEmpty(queueString)) {</span>
<span class="nc" id="L238">			m_assignedQueueIds = StringUtil.parseIDString(queueString, &quot;,&quot;);</span>
		} else {
<span class="nc" id="L240">			m_assignedQueueIds = new ID[]{};</span>
		}
<span class="nc" id="L242">	}</span>
	
	public ID getOrganizationId() {
<span class="nc" id="L245">		return m_orgId;</span>
	}
	
	public void setOrganizationId(String orgId) {
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">		if (!StringUtil.isEmptyOrWhiteSpace(orgId)) {</span>
<span class="fc" id="L250">			m_orgId = ID.fromInt(Integer.parseInt(orgId));</span>
		}
<span class="fc" id="L252">	}</span>

	/**
	 * Return URL for HTML Form Action
	 */
	public String getFormAction() {
<span class="fc" id="L258">		return &quot;queue_selector&quot;;</span>
	}

	public String getHtmlDisplay() {
<span class="fc" id="L262">		return m_assignmentBox.getHtmlDisplay();</span>
	}

	private boolean isAssigned(ID id)
	{
<span class="pc bpc" id="L267" title="3 of 4 branches missed.">		if(m_assignedQueueIds == null || m_assignedQueueIds.length == 0) </span>
<span class="fc" id="L268">			return false;</span>
		
<span class="nc bnc" id="L270" title="All 2 branches missed.">		for(short i = 0; i &lt; m_assignedQueueIds.length; i++) </span>
		{
<span class="nc bnc" id="L272" title="All 2 branches missed.">			if(id.equals(m_assignedQueueIds[i])) </span>
<span class="nc" id="L273">				return true;</span>
		}
<span class="nc" id="L275">		return false;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>