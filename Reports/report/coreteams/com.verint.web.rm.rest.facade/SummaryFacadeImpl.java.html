<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SummaryFacadeImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.rm.rest.facade</a> &gt; <span class="el_source">SummaryFacadeImpl.java</span></div><h1>SummaryFacadeImpl.java</h1><pre class="source lang-java linenums">package com.verint.web.rm.rest.facade;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.ws.rs.core.Response;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TimeOffActivitySummary;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.web.fs.keys.FsKeys;
import com.bluepumpkin.web.fs.schedule.summary.FlexTimeSummaryData;
import com.bluepumpkin.web.fs.schedule.summary.OneWayShiftSwapSummaryData;
import com.bluepumpkin.web.fs.schedule.summary.ScheduleSummaryMH;
import com.bluepumpkin.web.fs.schedule.summary.ShiftBidSummaryData;
import com.bluepumpkin.web.fs.schedule.summary.ShiftSwapSummaryData;
import com.bluepumpkin.web.fs.schedule.summary.TimeOffSummaryPC;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.verint.web.rest.exception.checked.BusinessWFOException;
import com.verint.web.rest.exception.checked.WFOException;
import com.verint.web.rest.util.FormatUtils;
import com.verint.web.rm.rest.entity.summary.FlexTimeSummaryEntity;
import com.verint.web.rm.rest.entity.summary.OneWayShiftSwapSummaryEntity;
import com.verint.web.rm.rest.entity.summary.ShiftBiddingSummaryEntity;
import com.verint.web.rm.rest.entity.summary.ShiftSwapSummaryEntity;
import com.verint.web.rm.rest.entity.summary.SummaryEntity;
import com.verint.web.rm.rest.entity.timeoff.TimeOffSummaryActivityEntity;
import com.verint.web.rm.rest.entity.timeoff.TimeOffSummaryEntity;
import com.verint.web.rm.rest.util.RmUtils;
import com.witness.web.uif.system.RequestContext;

public class SummaryFacadeImpl implements ISummaryFacade {
<span class="fc" id="L42">	private static final Category LOG = Log.initCategory(SummaryFacadeImpl.class.getName());</span>

<span class="nc" id="L44">	enum ViewType {</span>
<span class="nc" id="L45">		ALL(Request.REQUESTTYPE_ALL),</span>
<span class="nc" id="L46">		FLEXTIME(Request.REQUESTTYPE_FLEXTIME),</span>
<span class="nc" id="L47">		SHIFTSWAP(Request.REQUESTTYPE_SHIFTSWAP),</span>
<span class="nc" id="L48">		SHIFTBID(Request.REQUESTTYPE_SHIFTBID),</span>
<span class="nc" id="L49">		TIMEOFF(Request.REQUESTTYPE_TIMEOFF);</span>

		private String viewType;

<span class="nc" id="L53">		ViewType(String viewType) {</span>
<span class="nc" id="L54">			this.viewType = viewType;</span>
<span class="nc" id="L55">		}</span>

		public String getViewType() {
<span class="nc" id="L58">			return viewType;</span>
		}
	}

<span class="fc" id="L62">	public SummaryFacadeImpl() { // NOSONAR</span>
<span class="fc" id="L63">	}</span>

	/**
	 * Gets the current user's summary.
	 */
	@Override
	public SummaryEntity getSummaryForEmployee(RequestContext context, String view, String toYear) throws WFOException {
		try {
<span class="nc" id="L71">			SummaryEntity summary = new SummaryEntity();</span>
<span class="nc" id="L72">			summary.setId(context.getUser().getEmployeeID().toString());</span>
<span class="nc" id="L73">			String[] views = getViews(view);</span>

<span class="nc bnc" id="L75" title="All 2 branches missed.">			if (includeView(views, ViewType.FLEXTIME)) {</span>
<span class="nc" id="L76">				summary.setFlex(getFlexSummaryForEmployee(context));</span>
			}

<span class="nc bnc" id="L79" title="All 4 branches missed.">			if (includeView(views, ViewType.SHIFTBID) &amp;&amp; LicenseUtil.hasShiftBiddingLicense()) {</span>
<span class="nc" id="L80">				summary.setShiftBidding(getShiftBiddingSummaryForEmployee(context));</span>
			}

<span class="nc bnc" id="L83" title="All 4 branches missed.">			if (includeView(views, ViewType.SHIFTSWAP) &amp;&amp; LicenseUtil.hasShiftSwapLicense()) {</span>
<span class="nc" id="L84">				summary.setShiftSwap(getShiftSwapSummaryForEmployee(context));</span>
			}

<span class="nc bnc" id="L87" title="All 4 branches missed.">			if (includeView(views, ViewType.TIMEOFF) &amp;&amp; LicenseUtil.hasTimeOffManagerLicense()) {</span>
<span class="nc" id="L88">				summary.setTimeOff(getTimeOffSummaryForEmployee(context, toYear));</span>
			}

<span class="nc" id="L91">			return summary;</span>
<span class="nc" id="L92">		} catch (Exception ex) {</span>
<span class="nc" id="L93">			throw RmUtils.handleFacadeException(context, ex, LOG);</span>
		}
	}

	/**
	 * Gets the current user's flex summary.
	 */
	private FlexTimeSummaryEntity getFlexSummaryForEmployee(RequestContext context)
			throws Exception { // NOSONAR
<span class="nc" id="L102">		FlexTimeSummaryEntity entity = null;</span>
<span class="nc" id="L103">		Map&lt;String, Object&gt; theData = new HashMap&lt;&gt;();</span>

<span class="nc" id="L105">		ScheduleSummaryMH.getFlexTimeSummary(context, theData);</span>
<span class="nc" id="L106">		Boolean showFlexTimeSummary = (Boolean) theData.get(ScheduleSummaryMH.SHOW_TO_FLEX_TIME_SUMMARY);</span>
<span class="nc bnc" id="L107" title="All 4 branches missed.">		if (showFlexTimeSummary != null &amp;&amp; showFlexTimeSummary.booleanValue()) {</span>
<span class="nc" id="L108">			FlexTimeSummaryData flexData = (FlexTimeSummaryData) theData.get(ScheduleSummaryMH.FLEX_TIME_DATA_KEY);</span>
<span class="nc" id="L109">			entity = new FlexTimeSummaryEntity();</span>
<span class="nc" id="L110">			entity.setApproved(flexData.getApproved());</span>
<span class="nc" id="L111">			entity.setEndDate(FormatUtils.dateToISO8601SecPrecisionString(flexData.getEndDate()));</span>
<span class="nc" id="L112">			entity.setLimit(flexData.getLimit());</span>
<span class="nc" id="L113">			entity.setPeriod(flexData.getPeriod());</span>
<span class="nc" id="L114">			entity.setRemaining(flexData.getRemaining());</span>
<span class="nc" id="L115">			entity.setStartDate(FormatUtils.dateToISO8601SecPrecisionString(flexData.getStartDate()));</span>
		}
<span class="nc" id="L117">		return entity;</span>
	}

	/**
	 * Gets the current user's shift bidding summary.
	 */
	private ShiftBiddingSummaryEntity getShiftBiddingSummaryForEmployee(RequestContext context)
			throws Exception { // NOSONAR
<span class="nc" id="L125">		ShiftBiddingSummaryEntity entity = null;</span>
<span class="nc" id="L126">		Map&lt;String, Object&gt; theData = new HashMap&lt;&gt;();</span>

<span class="nc" id="L128">		ScheduleSummaryMH.getShiftBiddingSummary(context, theData);</span>
<span class="nc" id="L129">		Boolean showSummary = (Boolean) theData.get(ScheduleSummaryMH.SHOW_SB_SUMMARY);</span>
<span class="nc bnc" id="L130" title="All 4 branches missed.">		if (showSummary != null &amp;&amp; showSummary.booleanValue()) {</span>
<span class="nc" id="L131">			ShiftBidSummaryData sData = (ShiftBidSummaryData) theData.get(ScheduleSummaryMH.SB_SUMMARY_DATA_KEY);</span>
<span class="nc" id="L132">			entity = new ShiftBiddingSummaryEntity();</span>
<span class="nc" id="L133">			entity.setAuctions(sData.getAuctions());</span>
<span class="nc" id="L134">			entity.setRequestsApproved(sData.getRequestsApproved());</span>
<span class="nc" id="L135">			entity.setRequestsDenied(sData.getRequestsDenied());</span>
<span class="nc" id="L136">			entity.setRequestsExpired(sData.getRequestsExpired());</span>
<span class="nc" id="L137">			entity.setRequestsInvalid(sData.getRequestsInvalid());</span>
<span class="nc" id="L138">			entity.setRequestsPending(sData.getRequestsPending());</span>
<span class="nc" id="L139">			entity.setRequestsTotal(sData.getRequestsTotal());</span>
		}
<span class="nc" id="L141">		return entity;</span>
	}

	/**
	 * Gets the current user's shift swap summary.
	 */
	private ShiftSwapSummaryEntity getShiftSwapSummaryForEmployee(RequestContext context)
			throws Exception { // NOSONAR
<span class="nc" id="L149">		ShiftSwapSummaryEntity entity = null;</span>
<span class="nc" id="L150">		Map&lt;String, Object&gt; theData = new HashMap&lt;&gt;();</span>

<span class="nc" id="L152">		ScheduleSummaryMH.getShiftSwapSummary(context, theData);</span>
<span class="nc" id="L153">		Boolean showShiftSwapSummary = (Boolean) theData.get(ScheduleSummaryMH.SHOW_SS_SUMMARY);</span>
<span class="nc bnc" id="L154" title="All 4 branches missed.">		if (showShiftSwapSummary != null &amp;&amp; showShiftSwapSummary.booleanValue()) {</span>
<span class="nc" id="L155">			ShiftSwapSummaryData sData = (ShiftSwapSummaryData) theData.get(ScheduleSummaryMH.SS_SUMMARY_DATA_KEY);</span>
<span class="nc" id="L156">			entity = new ShiftSwapSummaryEntity();</span>
<span class="nc" id="L157">			entity.setPostings(sData.getPostings());</span>
<span class="nc" id="L158">			entity.setRequestsApproved(sData.getRequestsApproved());</span>
<span class="nc" id="L159">			entity.setRequestsDenied(sData.getRequestsDenied());</span>
<span class="nc" id="L160">			entity.setRequestsExpired(sData.getRequestsExpired());</span>
<span class="nc" id="L161">			entity.setRequestsInvalid(sData.getRequestsInvalid());</span>
<span class="nc" id="L162">			entity.setRequestsNegotiation(sData.getRequestsNegotiation());</span>
<span class="nc" id="L163">			entity.setRequestsPending(sData.getRequestsPending());</span>
<span class="nc" id="L164">			entity.setRequestsTotal(sData.getRequestsTotal());</span>
		}

<span class="nc" id="L167">		ScheduleSummaryMH.getOneWayShiftSwapSummary(context, theData);</span>
<span class="nc" id="L168">		Boolean showOneWaySummary = (Boolean) theData.get(ScheduleSummaryMH.SHOW_ONE_WAY_SS_SUMMARY);</span>
<span class="nc bnc" id="L169" title="All 4 branches missed.">		if (showOneWaySummary != null &amp;&amp; showOneWaySummary.booleanValue()) {</span>
<span class="nc" id="L170">			OneWayShiftSwapSummaryData oneData = (OneWayShiftSwapSummaryData) theData.get(ScheduleSummaryMH.ONE_WAY_SS_SUMMARY_DATA_KEY);</span>
<span class="nc" id="L171">			OneWayShiftSwapSummaryEntity oneEntity = new OneWayShiftSwapSummaryEntity();</span>
<span class="nc" id="L172">			entity.setOneWaySummary(oneEntity);</span>
<span class="nc" id="L173">			oneEntity.setApproved(oneData.getApproved());</span>
<span class="nc" id="L174">			oneEntity.setEndDate(FormatUtils.dateToISO8601SecPrecisionString(oneData.getEndDate()));</span>
<span class="nc" id="L175">			oneEntity.setLimit(oneData.getLimit());</span>
<span class="nc" id="L176">			oneEntity.setPeriod(oneData.getPeriod());</span>
<span class="nc" id="L177">			oneEntity.setRemaining(oneData.getRemaining());</span>
<span class="nc" id="L178">			oneEntity.setStartDate(FormatUtils.dateToISO8601SecPrecisionString(oneData.getStartDate()));</span>
		}
<span class="nc" id="L180">		return entity;</span>
	}

	/**
	 * Gets the current user's time off summary.
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	private TimeOffSummaryEntity getTimeOffSummaryForEmployee(RequestContext context, String toYear)
			throws Exception {
<span class="nc" id="L189">		TimeOffSummaryEntity entity = null;</span>
<span class="nc" id="L190">		Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L191">		Map&lt;String, Object&gt; theData = new HashMap&lt;&gt;();</span>
<span class="nc" id="L192">		toYear = getTimeOffYear(localizer, toYear); // NOSONAR</span>

<span class="nc" id="L194">		ID employeeID = context.getUser().getEmployeeID();</span>
<span class="nc" id="L195">		ScheduleSummaryMH.getTimeOffSummary(context, employeeID, null, toYear, theData, true);</span>
<span class="nc" id="L196">		Boolean showSummary = (Boolean) theData.get(ScheduleSummaryMH.SHOW_TO_SUMMARY);</span>
<span class="nc bnc" id="L197" title="All 4 branches missed.">		if (showSummary != null &amp;&amp; showSummary.booleanValue()) {</span>
<span class="nc" id="L198">			Date startOfYear = ((Calendar) theData.get(ScheduleSummaryMH.TO_YEAR_KEY)).getTime();</span>
<span class="nc" id="L199">			List&lt;TimeOffActivitySummary&gt; summaries = (List&lt;TimeOffActivitySummary&gt;) theData.get(ScheduleSummaryMH.TO_SUMMARY_DATA_KEY);</span>
<span class="nc" id="L200">			boolean isTimeOffSummaryColumnChanged = TimeOffSummaryPC.isTimeOffSummaryColumnChanged();</span>

<span class="nc" id="L202">			entity = new TimeOffSummaryEntity();</span>
<span class="nc" id="L203">			entity.setShowingBalance(isTimeOffSummaryColumnChanged);</span>
<span class="nc" id="L204">			entity.setStartOfYear(FormatUtils.dateToISO8601SecPrecisionString(startOfYear));</span>
<span class="nc" id="L205">			List&lt;TimeOffSummaryActivityEntity&gt; summaryEntities = new ArrayList&lt;TimeOffSummaryActivityEntity&gt;(summaries.size());</span>
<span class="nc" id="L206">			entity.setSummaries(summaryEntities);</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">			for (TimeOffActivitySummary activitySummary : summaries) {</span>
<span class="nc" id="L208">				summaryEntities.add(new TimeOffSummaryActivityEntity(activitySummary, isTimeOffSummaryColumnChanged));</span>
<span class="nc" id="L209">			}</span>
		}
<span class="nc" id="L211">		return entity;</span>
	}

	private String getTimeOffYear(Localizer localizer, String toYear) throws BusinessWFOException {
<span class="nc bnc" id="L215" title="All 2 branches missed.">		if (StringUtil.isEmptyOrWhiteSpace(toYear)) {</span>
<span class="nc" id="L216">			return FsKeys.TO_YEAR_CURRENT;</span>
		}
<span class="nc bnc" id="L218" title="All 4 branches missed.">		if (!FsKeys.TO_YEAR_CURRENT.equals(toYear) &amp;&amp; !FsKeys.TO_YEAR_NEXT.equals(toYear) &amp;&amp;</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">				!FsKeys.TO_YEAR_PREVIOUS.equals(toYear)) {</span>
<span class="nc" id="L220">			String msg = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.INVALID_PARAMETER, RmUtils.TO_YEAR_FN);</span>
<span class="nc" id="L221">			throw new BusinessWFOException(msg, Response.Status.BAD_REQUEST);</span>
		}
<span class="nc" id="L223">		return toYear;</span>
	}

	String[] getViews(String view) {
<span class="nc" id="L227">		String[] views = new String[] { ViewType.ALL.getViewType() };</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">		if (!StringUtil.isEmptyOrWhiteSpace(view)) {</span>
<span class="nc" id="L229">			views = view.split(&quot;,&quot;);</span>
		}
<span class="nc" id="L231">		return views;</span>
	}

	boolean includeView(String[] views, ViewType type) {
<span class="nc" id="L235">		String all = ViewType.ALL.getViewType();</span>
<span class="nc" id="L236">		String viewType = type.getViewType();</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">		for (String view : views) {</span>
<span class="nc bnc" id="L238" title="All 4 branches missed.">			if (viewType.equalsIgnoreCase(view) || all.equalsIgnoreCase(view)) {</span>
<span class="nc" id="L239">				return true;</span>
			}
		}
<span class="nc" id="L242">		return false;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>