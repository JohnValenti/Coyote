<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CustomShiftRequestFormPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.custshift</a> &gt; <span class="el_source">CustomShiftRequestFormPopupPM.java</span></div><h1>CustomShiftRequestFormPopupPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.custshift;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.Duration;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.LocalDate;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.util.PersonNameUtil;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.Shift;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftOTExtension;
import com.bluepumpkin.ejb.rm.base.RmBaseException;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.custshift.model.CustShiftReq;
import com.bluepumpkin.ejb.rm.requests.custshift.model.CustShiftReqFieldInfo;
import com.bluepumpkin.ejb.rm.requests.custshift.model.CustShiftReqGap;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.rm.keys.RmJavaScriptFileID;
import com.bluepumpkin.web.rm.keys.RmKeys;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.RequestFormPopupPM;
import com.bluepumpkin.web.rm.requests.RequestUtil;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.container.Collapsible2ColFormPC;
import com.witness.web.uif.pagecomponent.container.MultiColCollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.message.MessagePC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.picker.time.DurationSpinnerPC;
import com.witness.web.uif.pagecomponent.picker.time.TimePickerPC;
import com.witness.web.uif.pagemodel.ContainersInRowsPM;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.system.manager.impl.DefaultVerticalizationManager;
import com.witness.web.uif.util.ContainerList;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.witness.web.uif.util.js.JSUtil;

/**
 * Title: CustomShiftRequestFormPopupPM Description: Custom Shift Request Form
 * allows user to request a New Shift or a Shift Change. Copyright: Copyright
 * (c) 2011 Company: Verint Systems, Inc.
 *
 * @author Gonzalo Quintanar
 */

public class CustomShiftRequestFormPopupPM extends RequestFormPopupPM implements ContainersInRowsPM {
	private static final int TIME_INTERVAL = 15;
	private static final String DATE_PICKER_HIDDEN_SPAN_ID = &quot;startdatepickerid&quot;;
	private static final String ONCHANGE_PAGE_REFRESH = &quot;var refreshPage = true;&quot;;

	// field name constants
	private static final String REQUESTED_FOR_FN = &quot;requestedFor&quot;;
	private static final String REQUEST_STATUS_FN = &quot;requestStatus&quot;;
	private static final String RELOAD_ACTION_FN = &quot;reloadAction&quot;;
	private static final String REQUEST_SUB_TYPE = &quot;requestSubType&quot;;

	private static final String SHIFT_START_DATE = &quot;shiftStartDate&quot;;
	private static final String SHIFT_START_TIME = &quot;shiftStartTime&quot;;
	private static final String SHIFTID = &quot;shiftID&quot;;
	private static final String ACTIVITYID = &quot;activityID&quot;;
	private static final String OVERTIME = &quot;overtime&quot;;
	private static final String EXT_BEFORE_ID = &quot;extBeforeID&quot;;
	private static final String EXT_BEFORE_ACTIVITY_ID = &quot;extBeforeActivityID&quot;;
	private static final String EXT_BEFORE_DURATION = &quot;extBeforeDuration&quot;;
	private static final String EXT_BEFORE_GAP = &quot;extBeforeGap&quot;;
	private static final String EXT_BEFORE_OVERTIME = &quot;extBeforeOvertime&quot;;

	private static final String EXT_AFTER_ID = &quot;extAfterID&quot;;
	private static final String EXT_AFTER_ACTIVITY_ID = &quot;extAfterActivityID&quot;;
	private static final String EXT_AFTER_DURATION = &quot;extAfterDuration&quot;;
	private static final String EXT_AFTER_GAP = &quot;extAfterGap&quot;;
	private static final String EXT_AFTER_OVERTIME = &quot;extAfterOvertime&quot;;

	private static final String DURING_GAP_GAP_ID = &quot;duringGapGapID&quot;;
	private static final String DURING_GAP_TYPE_ID = &quot;duringGapTypeID&quot;;
	private static final String DURING_GAP_ACTIVITY_ID = &quot;duringGapActivityID&quot;;
	private static final String DURING_GAP_DURATION = &quot;duringGapDuration&quot;;
	private static final String DURING_GAP_GAP = &quot;duringGapGap&quot;;

	private static final int MAX_GAP_IN_MINUTES = 720;

	// field value constants

	// indicates form was refreshed due to a date change
	public static final String RELOAD_ACTION_DATE = &quot;DATE&quot;;

	// indicates form was refreshed due to a time change
	public static final String RELOAD_ACTION_TIME = &quot;TIME&quot;;

	// indicates form was refreshed due to an employee selection change
	public static final String RELOAD_ACTION_EMPLOYEE = &quot;EMPLOYEE&quot;;

	// indicates form was refreshed due to a shift selection change
	public static final String RELOAD_ACTION_SHIFT = &quot;SHIFT&quot;;

	// indicates form was refreshed due to an Extension Before Type selection
	// change
	public static final String RELOAD_ACTION_EXT_BEFORE = &quot;EXT_BEFORE&quot;;

	// indicates form was refreshed due to an Extension After Type selection
	// change
	public static final String RELOAD_ACTION_EXT_AFTER = &quot;EXT_AFTER&quot;;

	public static final String RELOAD_ACTION_DURING_GAP = &quot;DURING_GAP&quot;;



	// could be a validation error, or the request was saved successfully
	public static final String RELOAD_ACTION_SAVE = &quot;SAVE&quot;;

	// indicates form has just loaded due to a user selection in the Net
	// Staffing ribbon (schedule page).
	public static final String RELOAD_ACTION_RIBBON = &quot;RIBBON&quot;;

	// indicates form has just loaded due to editing/creating new request from
	// My Requests/Agent Requests page.
	public static final String RELOAD_ACTION_NONE = &quot;&quot;;

	// JavaScript Constants
	private static final String JS_FUNC_RELOAD_WITH_ACTION = &quot;reloadWithAction&quot;;
	private static final String JS_FUNC_TOGGLE_SHIFT_OT = &quot;toggleShiftOTCheckbox(this); &quot; + JSUtil.ON_CHANGE;

	// Other constants
<span class="fc" id="L150">	public static final ID CUSTOM_ID = new ID(-1);</span>
<span class="fc" id="L151">	public static final ID NONE_ID = new ID(-2);</span>
	private static final int NO_MINUTES_IN_HOUR = 60;

	// Member variables
	protected CustShiftReq m_customShiftRequest;
<span class="nc" id="L156">	private Collection m_empNames = Collections.emptyList();</span>

	// When the form reloads due to a user change in date, time, etc, we store
	// the type here (Ex: &quot;DATE&quot;, &quot;TIME&quot;).
<span class="nc" id="L160">	private String m_reloadAction = RELOAD_ACTION_NONE;</span>

	// the employee's scheduling period ID (if any) on the selected day
	protected ID m_spID;

	/**
	 * To Handle cases where the Shift Change request is overlapping multiple SP's
	 */
	private Map&lt;ID, Pair&lt;Date, Date&gt;&gt; spIDMap;


	// Request Management Settings per organization
	protected OrganizationSetting m_orgSetting;
<span class="nc" id="L173">	protected boolean m_allowNewShifts = true;</span>
<span class="nc" id="L174">	protected boolean m_allowShiftChanges = true;</span>
<span class="nc" id="L175">	protected boolean m_allowRegularShifts = true;</span>
<span class="nc" id="L176">	protected boolean m_allowOTShifts = true;</span>
<span class="nc" id="L177">	protected boolean m_allowRegularExtBeforeShifts = true;</span>
<span class="nc" id="L178">	protected boolean m_allowRegularExtAfterShifts = true;</span>
<span class="nc" id="L179">	private boolean m_allowRegularDuringGapShifts = true;</span>
<span class="nc" id="L180">	protected boolean m_allowOTExtBeforeShifts = true;</span>
<span class="nc" id="L181">	protected boolean m_allowOTExtAfterShifts = true;</span>
<span class="nc" id="L182">	private boolean m_allowOTGapEdit = false;</span>
<span class="nc" id="L183">	private boolean denyOTDurationEdit = false;</span>

	// These variables store information about the employee's scheduled shift
	// assignment (if any) on the selected day

	// the employee's scheduled shift assignment (if any) on the selected day
<span class="nc" id="L189">	protected ShiftAssignment m_shiftAssignment = null;</span>
	// the employee's scheduled main shift start time (excluding the gap before
	// shift)
	protected Date m_saMainShiftStartTime;
	// the employee's scheduled main shift end time (excluding the gap after
	// shift)
	protected Date m_saMainShiftEndTime;
	// the employee's scheduled OT Before gap duration (if any) on the selected
	// day
<span class="nc" id="L198">	protected int m_saGapBeforeDuration = 0;</span>
	// the employee's scheduled OT After gap duration (if any) on the selected
	// day
<span class="nc" id="L201">	protected int m_saGapAfterDuration = 0;</span>
	// the employee's schedule OT Before duration (if an) on the selected day
<span class="nc" id="L203">	private int m_saDurationBeforeDuration = 0;</span>
	// the employee's schedule OT After duration (if an) on the selected day
<span class="nc" id="L205">	private int m_saDurationAfterDuration = 0;</span>

	// These variables will be used to populate the dropdown selectors on the
	// form
<span class="nc" id="L209">	protected List&lt;Shift&gt; m_shifts = Collections.emptyList();</span>
<span class="nc" id="L210">	protected List&lt;Activity&gt; m_activities = Collections.emptyList();</span>
<span class="nc" id="L211">	protected List&lt;ShiftOTExtension&gt; m_extBeforeTypes = Collections.emptyList();</span>
<span class="nc" id="L212">	protected List&lt;Activity&gt; m_extBeforeActivities = Collections.emptyList();</span>
<span class="nc" id="L213">	protected List&lt;ShiftOTExtension&gt; m_extAfterTypes = Collections.emptyList();</span>
<span class="nc" id="L214">	protected List&lt;Activity&gt; m_extAfterActivities = Collections.emptyList();</span>
<span class="nc" id="L215">	protected List&lt;ShiftOTExtension&gt; duringGapTypes = Collections.emptyList();</span>
<span class="nc" id="L216">	protected List&lt;Activity&gt; duringGapActivities = Collections.emptyList();</span>
<span class="nc" id="L217">	protected List&lt;TimeRange&gt; duringGaps = Collections.emptyList();</span>

	// these variables will be used to store the details of the form's current
	// selections
<span class="nc" id="L221">	protected Shift m_shift = null;</span>
<span class="nc" id="L222">	private ShiftOTExtension m_extBeforeType = null;</span>
<span class="nc" id="L223">	private ShiftOTExtension m_extAfterType = null;</span>
<span class="nc" id="L224">	private ShiftOTExtension duringGapType = null;</span>

	// variables for the duration spinners
	DurationSpinnerPC gapBeforeDurationPC;
	DurationSpinnerPC gapAfterDurationPC;
	DurationSpinnerPC gapDuringGapPC;
	DurationSpinnerPC durationBeforeDurationPC;
	DurationSpinnerPC durationAfterDurationPC;
	DurationSpinnerPC durationDuringGapPC;

	// These variables store whether or not the user expanded/collapsed the four
	// collapsible containers in the dialog.
	// If null, that means we will determine the appropriate state ourselves. If
	// not null, we will keep the user's states.
<span class="nc" id="L238">	private String m_shiftSectionCollapsed = null;</span>
<span class="nc" id="L239">	private String m_extBeforeSectionCollapsed = null;</span>
<span class="nc" id="L240">	private String m_extAfterSectionCollapsed = null;</span>
<span class="nc" id="L241">	private String m_extDuringGapSectionCollapsed = null;</span>
<span class="nc" id="L242">	private String m_alertsSectionCollapsed = null;</span>

	// Container Page Components
	private final ContainerList m_containerList;
	private Collapsible2ColFormPC m_shiftContainerPC;

	private Collapsible2ColFormPC m_extBeforeContainerPC;
	private Collapsible2ColFormPC m_extAfterContainerPC;
	private Collapsible2ColFormPC m_duringGapContainerPC;

	// Page Components
	protected DatePickerPC m_datePickerPC;
	protected TimePickerPC m_timePickerPC;

<span class="nc" id="L256">	private boolean m_isAuthorized = true;</span>
<span class="nc" id="L257">	private boolean m_isRequestSaved = false;</span>

	// From the Net Staffing Ribbon Selection
	private Date m_ribbonStartDate;
	private Date m_ribbonEndDate;
<span class="nc" id="L262">	private boolean m_selectedDayIncludesRibbonSelection = false;</span>
<span class="nc" id="L263">	private boolean m_selectedAgentIsForRibbonSelection = false;</span>
<span class="nc" id="L264">	private ID m_origReuestedFor = null; // the agent whose net staffing ribbon</span>
	// was selected, if any.

<span class="nc" id="L267">	private boolean m_selectedDateIsForSavedRequest = false;</span>

	/**
	 * If we came from the Net Staffing Ribbon, then this will store the
	 * activity with the lowest Net Staffing value during the ribbon selection
	 * time range. If the ribbon selection includes time before the scheduled
	 * shift and time after, then this is the deficient activity for the
	 * selected time before the shift only.
	 */
<span class="nc" id="L276">	protected Activity m_mostDeficientActivity1 = null;</span>

	/**
	 * If we came from the Net Staffing Ribbon, then this will store the
	 * activity with the lowest Net Staffing value during the ribbon selection
	 * time range. If the ribbon selection includes time before the scheduled
	 * shift and time after, then this is the deficient activity for the
	 * selected time after the shift only.
	 */
<span class="nc" id="L285">	protected Activity m_mostDeficientActivity2 = null;</span>
	/* 6 variables and logic added for Language Line ESR
	 * Before: When drawing extension from Net Staffing ,either the drawn duration equals or not equals to closet shift extension,
	 *  there is always an information message &quot;The closest matching shift extension to your selection is shown below&quot;
	 * After change: When drawing extension from Net Staffing , if the drawn duration equals to closet shift extension,
	 * it shows the current message &quot;The closest matching shift extension to your selection is shown below&quot;.
	 * if the drawn duration  does not equals to closest shift extension, the warning message displays
	 * &quot;Your shift extension was changed from x hours to y hours to match the closest shift extension rule&quot;
	 * */
<span class="nc" id="L294">	boolean beforeDurationMatchShiftDuration= false;</span>
<span class="nc" id="L295">	boolean afterDurationMatchShiftDuration= false;</span>
<span class="nc" id="L296">	boolean highlightBeforeDuration= false;</span>
<span class="nc" id="L297">	boolean highlightAfterDuration= false;</span>
<span class="nc" id="L298">	String strDesiredDuration =&quot;&quot;;</span>
<span class="nc" id="L299">	String strShiftDuration= &quot;&quot;;</span>

	private GapAndDurationCalculator gapDurationCalculator;

	// Used to save the current values of the Duration and Gap
	// When in ReadOnly mode
<span class="nc" id="L305">	private final String SAVED_AFTER_DURATION = &quot;SAVED_AFTER_DURATION&quot;;</span>
<span class="nc" id="L306">	private final String SAVED_BEFORE_DURATION = &quot;SAVED_BEFORE_DURATION&quot;;</span>
<span class="nc" id="L307">	private final String SAVED_DURING_GAP_DURATION = &quot;SAVED_DURING_GAP_DURATION&quot;;</span>
<span class="nc" id="L308">	private final String SAVED_OT_BEFORE_AFTER_STATE = &quot;SAVED_OT_BEFORE_AFTER_STATE&quot;;</span>

	// Used to save the current values of the Duration and Gap
	// When in ReadOnly mode
<span class="nc" id="L312">	private int m_savedBeforeDuration = 0;</span>
<span class="nc" id="L313">	private int m_savedAfterDuration = 0;</span>
<span class="nc" id="L314">	private int m_savedDuringGapDuration = 0;</span>
<span class="nc" id="L315">	private int m_savedBeforeAfterState = 0;</span>

	/**
	 * Constructor
	 */
	public CustomShiftRequestFormPopupPM(RequestContext context) {
<span class="nc" id="L321">		super(context, RmKeys.RH_CUSTSHIFT_FORM);</span>

<span class="nc" id="L323">		m_containerList = new ContainerList(this, 3);</span>
<span class="nc" id="L324">		setCustomShiftRequest(new CustShiftReq(CustShiftReq.DL_BASIC | CustShiftReq.DL_AUDIT_TRAIL));</span>
<span class="nc" id="L325">		initDateAndTimePickers();</span>

<span class="nc" id="L327">		gapBeforeDurationPC = new DurationSpinnerPC(m_context, EXT_BEFORE_GAP);</span>
<span class="nc" id="L328">		this.addChildComponent(gapBeforeDurationPC);</span>
<span class="nc" id="L329">		gapAfterDurationPC = new DurationSpinnerPC(m_context, EXT_AFTER_GAP);</span>
<span class="nc" id="L330">		this.addChildComponent(gapAfterDurationPC);</span>
<span class="nc" id="L331">		gapDuringGapPC = new DurationSpinnerPC(m_context, DURING_GAP_GAP);</span>
<span class="nc" id="L332">		this.addChildComponent(gapDuringGapPC);</span>

<span class="nc" id="L334">		durationBeforeDurationPC = new DurationSpinnerPC(m_context, EXT_BEFORE_DURATION);</span>
<span class="nc" id="L335">		this.addChildComponent(durationBeforeDurationPC);</span>
<span class="nc" id="L336">		durationAfterDurationPC = new DurationSpinnerPC(m_context, EXT_AFTER_DURATION);</span>
<span class="nc" id="L337">		this.addChildComponent(durationAfterDurationPC);</span>
<span class="nc" id="L338">		durationDuringGapPC = new DurationSpinnerPC(m_context, DURING_GAP_DURATION);</span>
<span class="nc" id="L339">		this.addChildComponent(durationDuringGapPC);</span>


<span class="nc" id="L342">		addRequiredJavaScriptFile(RmJavaScriptFileID.CUSTOM_SHIFT_REQUEST_DIALOG_JS);</span>
<span class="nc" id="L343">		addJSVariableAsString(&quot;INVALID_COMBINATION_FOR_EXT_BEFORE&quot;,</span>
<span class="nc" id="L344">				i18n(m_bundle, RmWebBundleKey.INVALID_COMBINATION_FOR_EXT_BEFORE));</span>
<span class="nc" id="L345">		addJSVariableAsString(&quot;INVALID_COMBINATION_FOR_EXT_AFTER&quot;,</span>
<span class="nc" id="L346">				i18n(m_bundle, RmWebBundleKey.INVALID_COMBINATION_FOR_EXT_AFTER));</span>
<span class="nc" id="L347">		addJSVariableAsString(&quot;INVALID_COMBINATION_FOR_DURING_GAP&quot;,</span>
<span class="nc" id="L348">				i18n(m_bundle, RmWebBundleKey.INVALID_COMBINATION_FOR_DURING_GAP));</span>

<span class="nc" id="L350">		addJSVariableAsString(&quot;ZERO_DURATION_VALUE&quot;, CustomShiftUtil.getDurationString(m_localizer, 0));</span>

<span class="nc" id="L352">		String none = &quot;&lt;&quot; + context.getLocalizer().i18n(m_bundle, RmWebBundleKey.CSR_NONE) + &quot;&gt;&quot;;</span>
<span class="nc" id="L353">		addJSVariableAsString(&quot;NONE_VALUE&quot;, none);</span>
<span class="nc" id="L354">	}</span>

	/**
	 * Return an instance of the model that is ready for rendering
	 */
	public static PageModel getInstance(RequestContext context) throws Exception {
<span class="nc" id="L360">		return getInstance(context, CustomShiftRequestFormPopupPM.class);</span>
	}

	/**
	 * Extract the parameter values from the request.
	 */
	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L368">		boolean success = super.extractParameters(request);</span>

		// QC 45654: Save button doesn't resubmit after request has been denied
<span class="nc bnc" id="L371" title="All 2 branches missed.">		if (m_customShiftRequest.getRequestStatus().equals(RequestAuditTrail.STATUS_DENIED)) {</span>
<span class="nc" id="L372">			m_customShiftRequest.setRequestStatus(RequestAuditTrail.STATUS_PENDING);</span>
		}

		// Saves the Gap and Duration Edit State
<span class="nc" id="L376">		String value = request.getParameter(SAVED_OT_BEFORE_AFTER_STATE);</span>
<span class="nc" id="L377">		setGapDurationEditState(value);</span>

		// Store the gaps from the request. These could be overridden later when
		// initializeModel() is called.
<span class="nc bnc" id="L381" title="All 2 branches missed.">		if (!denyOTDurationEdit) {</span>
<span class="nc" id="L382">			setExtBeforeGap(gapBeforeDurationPC.getDuration().getDurationInMinutes());</span>
<span class="nc" id="L383">			setExtAfterGap(gapAfterDurationPC.getDuration().getDurationInMinutes());</span>
<span class="nc" id="L384">			setDuringGapGap(gapDuringGapPC.getDuration().getDurationInMinutes());</span>
<span class="nc" id="L385">			setExtBeforeDuration(durationBeforeDurationPC.getDuration().getDurationInMinutes());</span>
<span class="nc" id="L386">			setExtAfterDuration(durationAfterDurationPC.getDuration().getDurationInMinutes());</span>
<span class="nc" id="L387">			setDuringGapDuration(durationDuringGapPC.getDuration().getDurationInMinutes());</span>
		} else {
			// Get data for Gap Spinners
<span class="nc" id="L390">			setExtBeforeGap(gapBeforeDurationPC.getDuration().getDurationInMinutes());</span>
<span class="nc" id="L391">			setExtAfterGap(gapAfterDurationPC.getDuration().getDurationInMinutes());</span>
<span class="nc" id="L392">			setDuringGapGap(gapDuringGapPC.getDuration().getDurationInMinutes());</span>

			// Get data for Duration Readonly Display
<span class="nc" id="L395">			value = request.getParameter(SAVED_BEFORE_DURATION);</span>
<span class="nc" id="L396">			setSavedBeforeDuration(value);</span>

<span class="nc" id="L398">			value = request.getParameter(SAVED_AFTER_DURATION);</span>
<span class="nc" id="L399">			setSavedAfterDuration(value);</span>

<span class="nc" id="L401">			value = request.getParameter(SAVED_DURING_GAP_DURATION);</span>
<span class="nc" id="L402">			setSavedDuringGapDuration(value);</span>
		}

<span class="nc" id="L405">		updateDurationGap();</span>

<span class="nc" id="L407">		return success;</span>
	}

	/**
	 * Saves the current Before Shift Starts OT Extension Duration.
	 *
	 * @param value
	 *            OT Extension in minutes
	 */
	private void setSavedBeforeDuration(String value) {
		try {
<span class="nc" id="L418">			m_savedBeforeDuration = Integer.valueOf(value).intValue();</span>
<span class="nc" id="L419">		} catch (NumberFormatException e) {</span>
<span class="nc" id="L420">			m_savedBeforeDuration = 0;</span>
<span class="nc" id="L421">		}</span>
<span class="nc" id="L422">	}</span>

	/**
	 * Saves the current After Shift Ends OT Extension Duration.
	 *
	 * @param value
	 *            OT Extension in minutes
	 */
	private void setSavedAfterDuration(String value) {
		try {
<span class="nc" id="L432">			m_savedAfterDuration = Integer.valueOf(value).intValue();</span>
<span class="nc" id="L433">		} catch (NumberFormatException e) {</span>
<span class="nc" id="L434">			m_savedAfterDuration = 0;</span>
<span class="nc" id="L435">		}</span>
<span class="nc" id="L436">	}</span>

	private void setSavedDuringGapDuration(String value) {
		try {
<span class="nc" id="L440">			m_savedDuringGapDuration = Integer.valueOf(value).intValue();</span>
<span class="nc" id="L441">		} catch (NumberFormatException e) {</span>
<span class="nc" id="L442">			m_savedDuringGapDuration = 0;</span>
<span class="nc" id="L443">		}</span>
<span class="nc" id="L444">	}</span>

	/**
	 * Saves the state of the Gap and Duration Org Settings
	 */
	private void setSavedState() {
<span class="nc" id="L450">		m_savedBeforeAfterState = 0;</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">		if (denyOTDurationEdit) {</span>
<span class="nc" id="L452">			m_savedBeforeAfterState |= 1;</span>
		}

<span class="nc bnc" id="L455" title="All 2 branches missed.">		if (m_allowOTGapEdit) {</span>
<span class="nc" id="L456">			m_savedBeforeAfterState |= 2;</span>
		}
<span class="nc" id="L458">	}</span>

	/**
	 * Sets the state of the Gap and Duration Org Settings
	 *
	 * @param value
	 *            state of the Gap and Duration Org Settings
	 *            O = Bother are false, 1 = Duration is true,
	 *            2 = Gap is true, 3 = Both are true.
	 */
	private void setGapDurationEditState(String value) {
<span class="nc" id="L469">		int state = 0;</span>

		// Convert state to integer
		try {
<span class="nc" id="L473">			state = Integer.valueOf(value).intValue();</span>
<span class="nc" id="L474">		} catch (NumberFormatException e) {</span>
<span class="nc" id="L475">			state = 0;</span>
<span class="nc" id="L476">		}</span>

		// Set the edit states based on the value of the state
<span class="nc bnc" id="L479" title="All 2 branches missed.">		if (state == 0) {</span>
<span class="nc" id="L480">			denyOTDurationEdit = false;</span>
<span class="nc" id="L481">			m_allowOTGapEdit = false;</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">		} else if (state == 1) {</span>
<span class="nc" id="L483">			denyOTDurationEdit = true;</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">		} else if (state == 2) {</span>
<span class="nc" id="L485">			m_allowOTGapEdit = true;</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">		} else if (state == 3) {</span>
<span class="nc" id="L487">			denyOTDurationEdit = true;</span>
<span class="nc" id="L488">			m_allowOTGapEdit = true;</span>
		} else {
<span class="nc" id="L490">			denyOTDurationEdit = false;</span>
<span class="nc" id="L491">			m_allowOTGapEdit = false;</span>
		}
<span class="nc" id="L493">	}</span>

	/**
	 * Sets the Duration to the default after a page reload.
	 */
	private void updateDurationGap() {
<span class="nc bnc" id="L499" title="All 2 branches missed.">		if (m_reloadAction.equals(RELOAD_ACTION_EXT_AFTER)) {</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">			if (denyOTDurationEdit) {</span>
<span class="nc" id="L501">				m_customShiftRequest.setExtBeforeDuration(m_savedBeforeDuration);</span>
<span class="nc" id="L502">				setDuringGapDuration(m_savedDuringGapDuration);</span>
			}
		}

<span class="nc bnc" id="L506" title="All 2 branches missed.">		if (m_reloadAction.equals(RELOAD_ACTION_EXT_BEFORE)) {</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">			if (denyOTDurationEdit) {</span>
<span class="nc" id="L508">				m_customShiftRequest.setExtAfterDuration(m_savedAfterDuration);</span>
<span class="nc" id="L509">				setDuringGapDuration(m_savedDuringGapDuration);</span>
			}
		}

<span class="nc bnc" id="L513" title="All 2 branches missed.">		if (m_reloadAction.equals(RELOAD_ACTION_DURING_GAP)) {</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">			if (denyOTDurationEdit) {</span>
<span class="nc" id="L515">				m_customShiftRequest.setExtBeforeDuration(m_savedBeforeDuration);</span>
<span class="nc" id="L516">				m_customShiftRequest.setExtAfterDuration(m_savedAfterDuration);</span>
			}
		}
<span class="nc" id="L519">	}</span>

	/**
	 * Sets the Duration to the default during a save operation.
	 */
	private void updateDurationGapDuringSave() {
<span class="nc bnc" id="L525" title="All 4 branches missed.">		if (denyOTDurationEdit &amp;&amp; m_reloadAction.equals(RELOAD_ACTION_SAVE)) {</span>
<span class="nc" id="L526">			m_customShiftRequest.setExtBeforeDuration(m_savedBeforeDuration);</span>
<span class="nc" id="L527">			m_customShiftRequest.setExtAfterDuration(m_savedAfterDuration);</span>
<span class="nc" id="L528">			setDuringGapDuration(m_savedDuringGapDuration);</span>
		}
<span class="nc" id="L530">	}</span>

	protected void storeCSDataInMemberVars(CustomShiftRequestsMH.CSDetailData csData) throws Exception {
<span class="nc" id="L533">		m_empNames = csData.getEmployeeNames();</span>
<span class="nc" id="L534">		m_orgSetting = csData.getOrgSetting();</span>
<span class="nc" id="L535">		m_empID = csData.getEmpID();</span>
<span class="nc" id="L536">		m_shiftAssignment = csData.getShiftAssignment();</span>
<span class="nc" id="L537">		m_saGapBeforeDuration = csData.getGapBeforeDuration();</span>
<span class="nc" id="L538">		m_saGapAfterDuration = csData.getGapAfterDuration();</span>
<span class="nc" id="L539">		m_saDurationBeforeDuration = csData.getDurationBeforeDuration();</span>
<span class="nc" id="L540">		m_saDurationAfterDuration = csData.getDurationAfterDuration();</span>
<span class="nc" id="L541">		m_saMainShiftStartTime = csData.getMainShiftStartTime();</span>
<span class="nc" id="L542">		m_saMainShiftEndTime = csData.getMainShiftEndTime();</span>
<span class="nc" id="L543">		m_spID = csData.getSPID();</span>
<span class="nc" id="L544">		spIDMap = csData.getSPIDMap();</span>

		// Set this vars to empty list if CS Detail Data contains nulls
<span class="nc bnc" id="L547" title="All 2 branches missed.">		m_shifts = (csData.getShifts() != null) ? new ArrayList(csData.getShifts()) : Collections.emptyList();</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">		m_activities = (csData.getActivities() != null) ? new ArrayList(csData.getActivities()) : Collections.emptyList();</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">		m_extBeforeTypes = (csData.getExtBeforeTypes() != null) ? new ArrayList(csData.getExtBeforeTypes()) : Collections.emptyList();</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">		m_extBeforeActivities = (csData.getExtBeforeActivities() != null) ? new ArrayList(csData.getExtBeforeActivities())</span>
<span class="nc" id="L551">				: Collections.emptyList();</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">		m_extAfterTypes = (csData.getExtAfterTypes() != null) ? new ArrayList(csData.getExtAfterTypes()) : Collections.emptyList();</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">		m_extAfterActivities = (csData.getExtAfterActivities() != null) ? new ArrayList(csData.getExtAfterActivities())</span>
<span class="nc" id="L554">				: Collections.emptyList();</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">		duringGapTypes = (csData.getDuringGapTypes() != null) ? new ArrayList(csData.getDuringGapTypes()) : Collections.emptyList();</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">		duringGapActivities = (csData.getDuringGapActivities() != null) ? new ArrayList(csData.getDuringGapActivities())</span>
<span class="nc" id="L557">				: Collections.emptyList();</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">		if (m_shiftAssignment != null) {</span>
			// Second param sends empty list of calendar events
<span class="nc" id="L560">			duringGaps = m_customShiftRequest.getValidationCache().getAllGaps(m_shiftAssignment, Collections.emptyList());</span>
		}
		// Add missing gap option for displaying auto-approved confirmation QC#186565 (selected gap becomes &lt;None&gt; after auto-approved)
<span class="nc bnc" id="L563" title="All 4 branches missed.">		if (csData.getCSRequest() != null &amp;&amp; RequestAuditTrail.STATUS_APPROVED.equals(csData.getCSRequest().getRequestStatus())) {</span>
			// when displaying confirmation for auto approved requests, add the old (selected) gap to the dropdown list so it can be
			// displayed as selected
<span class="nc" id="L566">			Collection&lt;CustShiftReqGap&gt; gaps = csData.getCSRequest().getChildObjects(CustShiftReqFieldInfo.CUSTREQGAP_CHILD_TYPE);</span>
<span class="nc" id="L567">			duringGaps = new ArrayList&lt;TimeRange&gt;(duringGaps);</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">			for (CustShiftReqGap gap : gaps) {</span>
<span class="nc" id="L569">				TimeRange gapTime = new TimeRange(gap.getExtGapStartTime(), gap.getExtGapEndTime());</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">				if (!duringGaps.contains(gapTime)) {</span>
<span class="nc" id="L571">					duringGaps.add(gapTime);</span>
				}
<span class="nc" id="L573">			}</span>
		}

<span class="nc" id="L576">		m_mostDeficientActivity1 = csData.getMostDeficientActivity1();</span>
<span class="nc" id="L577">		m_mostDeficientActivity2 = csData.getMostDeficientActivity2();</span>

<span class="nc bnc" id="L579" title="All 2 branches missed.">		if (m_orgSetting != null) {</span>
<span class="nc" id="L580">			readOrgSettings();</span>
<span class="nc" id="L581">			setDatePickerWeekStarts(new ID(m_orgSetting.getCurrentOrgId()));</span>
		}
<span class="nc" id="L583">	}</span>

	/**
	 * Read the RM settings for the organization and store settings in our
	 * boolean member variables.
	 */
	protected void readOrgSettings() {
		// The two main settings. If both of these are disabled, nothing is
		// editable in the dialog.

		// allow new shift requests
<span class="nc" id="L594">		m_allowNewShifts = m_orgSetting.getEnableCustomShiftRequests();</span>
		// allow shift change requests
<span class="nc" id="L596">		m_allowShiftChanges = m_orgSetting.getAllowShiftChangeRequests();</span>

<span class="nc" id="L598">		m_allowRegularShifts = m_orgSetting.getAllowEntireRegularShift();</span>
<span class="nc" id="L599">		m_allowOTShifts = m_orgSetting.getAllowEntireOTShift();</span>
<span class="nc" id="L600">		m_allowRegularExtBeforeShifts = m_orgSetting.getAllowRegularExtensionBeforeShift();</span>
<span class="nc" id="L601">		m_allowRegularExtAfterShifts = m_orgSetting.getAllowRegularExtensionAfterShift();</span>
<span class="nc" id="L602">		m_allowRegularDuringGapShifts = m_orgSetting.getAllowRegularExtensionDuringGap();</span>
<span class="nc" id="L603">		m_allowOTExtBeforeShifts = m_orgSetting.getAllowOTBeforeShift();</span>
<span class="nc" id="L604">		m_allowOTExtAfterShifts = m_orgSetting.getAllowOTAfterShift();</span>
<span class="nc" id="L605">		m_allowOTGapEdit = m_orgSetting.getAllowEditOvertimeGap();</span>
<span class="nc" id="L606">		denyOTDurationEdit = m_orgSetting.getAllowEditOvertimeDuration();</span>

<span class="nc bnc" id="L608" title="All 4 branches missed.">		if (!m_allowRegularShifts &amp;&amp; !m_allowOTShifts) {</span>
<span class="nc" id="L609">			m_allowNewShifts = false;</span>
		}

<span class="nc bnc" id="L612" title="All 14 branches missed.">		if (!m_allowRegularShifts &amp;&amp; !m_allowOTShifts &amp;&amp; !m_allowRegularExtBeforeShifts &amp;&amp; !m_allowRegularExtAfterShifts</span>
				&amp;&amp; !m_allowOTExtBeforeShifts &amp;&amp; !m_allowOTExtAfterShifts &amp;&amp; !m_allowRegularDuringGapShifts) {
<span class="nc" id="L614">			m_allowShiftChanges = false;</span>
		}

		// Saves the Gap and Duration Edit State
<span class="nc" id="L618">		setSavedState();</span>
<span class="nc" id="L619">	}</span>

	public void setInitialized(boolean isInitialized) {
<span class="nc" id="L622">		m_isInitialized = isInitialized;</span>
<span class="nc" id="L623">	}</span>

	/**
	 * Initialize Model with Data. This method is called AFTER
	 * extractParameters().
	 */
	@Override
	protected void initializeModel() {
<span class="nc bnc" id="L631" title="All 2 branches missed.">		if (m_isInitialized) {</span>
<span class="nc" id="L632">			return;</span>
		} else {
<span class="nc" id="L634">			m_isInitialized = true;</span>
		}

<span class="nc" id="L637">		boolean sumtingWong = false;</span>
		try {
<span class="nc" id="L639">			ID empID = getRequestedFor();</span>

<span class="nc" id="L641">			CustomShiftRequestsMH.CSDetailData csData = null;</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">			CustShiftReq existingRequest = (getRequestID() == null) ? null</span>
<span class="nc" id="L643">					: CustomShiftRequestsMH.getCSRequest(getRequestID());</span>

			// make sure request has not been deleted
<span class="nc bnc" id="L646" title="All 4 branches missed.">			if (existingRequest == null &amp;&amp; !isNew()) {</span>
<span class="nc" id="L647">				sumtingWong = true;</span>
<span class="nc" id="L648">				addPageMessage(Message.ERROR_TYPE, i18n(m_bundle, RmWebBundleKey.REQUEST_NOT_FOUND_ERROR));</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">			} else if (!getCanCreateCustomShiftRequest(m_context, isManagerMode())) {</span>
<span class="nc" id="L650">				sumtingWong = true;</span>
<span class="nc" id="L651">				m_isAuthorized = false;</span>
<span class="nc" id="L652">				addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INFO_UNAUTHORIZED_TO_CREATE_CS_REQUEST,</span>
						RmWebBundleKey.BUNDLE_NAME);
			} else {
				// the first time the dialog loads, we get day range from the
				// existingRequest (if any). After, get it from date picker.
<span class="nc" id="L657">				boolean getFromToDatesFromExistingRequest = false;</span>
<span class="nc bnc" id="L658" title="All 4 branches missed.">				if (existingRequest != null &amp;&amp; m_reloadAction.equals(RELOAD_ACTION_NONE)) {</span>
					// CustomShiftUtil.setShiftStartTimeInExistingRequest(existingRequest,
					// m_view_tz);
<span class="nc" id="L661">					getFromToDatesFromExistingRequest = true;</span>
				}

<span class="nc bnc" id="L664" title="All 2 branches missed.">				Pair entireDayDates = getFromToDates(getFromToDatesFromExistingRequest ? existingRequest : null);</span>
<span class="nc" id="L665">				Date dayStart = (Date) entireDayDates.getFirst();</span>
<span class="nc" id="L666">				Date dayEnd = (Date) entireDayDates.getSecond();</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">				m_selectedDayIncludesRibbonSelection = m_ribbonStartDate != null</span>
<span class="nc bnc" id="L668" title="All 4 branches missed.">						&amp;&amp; !(m_ribbonStartDate.before(dayStart) || m_ribbonStartDate.after(dayEnd));</span>
<span class="nc bnc" id="L669" title="All 4 branches missed.">				m_selectedAgentIsForRibbonSelection = m_ribbonStartDate != null &amp;&amp; getRequestedFor() != null</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">						&amp;&amp; getRequestedFor().equals(getOrigRequestedFor());</span>
<span class="nc bnc" id="L671" title="All 4 branches missed.">				m_selectedDateIsForSavedRequest = existingRequest != null &amp;&amp; existingRequest.getShiftStartTime() != null</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">						&amp;&amp; !(existingRequest.getShiftStartTime().before(dayStart)</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">								|| existingRequest.getShiftStartTime().after(dayEnd));</span>

<span class="nc bnc" id="L675" title="All 2 branches missed.">				if (isManagerMode()) {</span>
<span class="nc" id="L676">					csData = CustomShiftRequestsMH.getCSDetailDataForManager(m_context, m_context.getUser(), empID,</span>
<span class="nc" id="L677">							isNew(), existingRequest, dayStart, dayEnd, m_ribbonStartDate, m_ribbonEndDate,</span>
<span class="nc" id="L678">							isRibbonApplicable(), m_bundle, m_view_tz);</span>
				} else {
<span class="nc" id="L680">					csData = CustomShiftRequestsMH.getCSDetailData(m_context, empID, existingRequest, dayStart, dayEnd,</span>
<span class="nc" id="L681">							m_ribbonStartDate, m_ribbonEndDate, isRibbonApplicable(), m_bundle, m_view_tz);</span>
				}

<span class="nc" id="L684">				storeCSDataInMemberVars(csData);</span>

				// if this is the first time showing the dialog, or if the
				// dialog was reloaded due to a change in
				// date/employee selection, then we need to clear the extracted
				// form values and get the request details anew.
				// (This is not needed for the Revert action, which is a
				// JavaScript-only action)
<span class="nc bnc" id="L692" title="All 4 branches missed.">				if (m_reloadAction.equals(RELOAD_ACTION_NONE) || m_reloadAction.equals(RELOAD_ACTION_DATE)</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">						|| m_reloadAction.equals(RELOAD_ACTION_EMPLOYEE)</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">						|| m_reloadAction.equals(RELOAD_ACTION_RIBBON)) {</span>
					// First clear the extracted form values
<span class="nc" id="L696">					resetCustomShiftRequest();</span>

<span class="nc" id="L698">					if (// (!isNew() &amp;&amp;</span>
					// !m_reloadAction.equals(RELOAD_ACTION_DATE) &amp;&amp;
					// !m_reloadAction.equals(RELOAD_ACTION_EMPLOYEE)) ||
<span class="nc bnc" id="L701" title="All 2 branches missed.">					isRequestDefaultMode()) {</span>
						// User is editing an existing request (this is the
						// first time dialog is opened)

<span class="nc" id="L705">						m_isAuthorized = RequestUtil.isAuthToUpdate(m_context, existingRequest);</span>

						// Try to keep extracted value in case of error
<span class="nc bnc" id="L708" title="All 2 branches missed.">						if (hasError()) {</span>
<span class="nc" id="L709">							m_customShiftRequest.setAuditTrailList(existingRequest.getAuditTrail());</span>
						} else {
<span class="nc bnc" id="L711" title="All 4 branches missed.">							if (existingRequest != null &amp;&amp; isShiftChangeRequest()) {</span>
								// Since Shift Change requests only store
								// deltas, we get the shift assignment, then
								// merge the deltas into it.
<span class="nc bnc" id="L715" title="All 4 branches missed.">								if (!denyOTDurationEdit || m_allowOTGapEdit) {</span>
<span class="nc" id="L716">									CustomShiftUtil.convertShiftAssignmentToRequest(m_shiftAssignment, m_customShiftRequest,</span>
											m_saMainShiftStartTime, m_saMainShiftEndTime, m_saGapBeforeDuration,
											m_saGapAfterDuration, m_saDurationBeforeDuration, m_saDurationAfterDuration, true);
								} else {
<span class="nc" id="L720">									CustomShiftUtil.convertShiftAssignmentToRequest(m_shiftAssignment, m_customShiftRequest,</span>
											m_saMainShiftStartTime, m_saMainShiftEndTime, m_saGapBeforeDuration,
											m_saGapAfterDuration, true);
								}
<span class="nc" id="L724">								CustomShiftUtil.mergeExistingRequestDeltasIntoRequest(existingRequest,</span>
										m_customShiftRequest);
<span class="nc" id="L726">								setCustomShiftRequest(m_customShiftRequest);</span>
							} else {
								// New Shift requests store all the data, so we
								// can use it as-is.
<span class="nc" id="L730">								setCustomShiftRequest(existingRequest);</span>
							}
						}
					} else {
						// User is either creating a new request (Shift
						// Change/New Shift), or
						// he is editing an existing request (Shift Change/New
						// Shift) and has changed the date from the original
						// request.
						// If there is a shift on this day, then we must get the
						// details and pre-fill the form (m_customShiftRequest)
						// with this shift information.
<span class="nc bnc" id="L742" title="All 2 branches missed.">						if (isShiftChangeRequest()) {</span>
<span class="nc" id="L743">							CustomShiftUtil.convertShiftAssignmentToRequest(m_shiftAssignment, m_customShiftRequest,</span>
									m_saMainShiftStartTime, m_saMainShiftEndTime, m_saGapBeforeDuration,
									m_saGapAfterDuration, true);
						}

<span class="nc bnc" id="L748" title="All 2 branches missed.">						if (isRibbonDefaultMode()) {</span>
<span class="nc" id="L749">							optimizeRequestForRibbonSelection();</span>
						}
					}

<span class="nc" id="L753">					setStartTimePickerBasedOnRequest();</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">				} else if (isShiftChangeRequest()) {</span>
					// The gap shift request change needs to be merged from the existing shift if it exists
<span class="nc bnc" id="L756" title="All 2 branches missed.">					if (existingRequest != null) {</span>
<span class="nc" id="L757">						CustomShiftUtil.mergeOnlyGapSectionIntoRequest(existingRequest,</span>
								m_customShiftRequest);
					}

					// The Gap duration spinners do not submit their values when
					// they are readonly. Because of this,
					// we must reload their original values rather than use
					// their extracted values which aren't available.
<span class="nc bnc" id="L765" title="All 2 branches missed.">					if (!isExtBeforeEditable()) {</span>
<span class="nc" id="L766">						m_customShiftRequest.setExtBeforeGap(m_saGapBeforeDuration);</span>
<span class="nc" id="L767">						m_customShiftRequest.setExtBeforeDuration(m_saDurationBeforeDuration);</span>
					}
<span class="nc bnc" id="L769" title="All 2 branches missed.">					if (!isExtAfterEditable()) {</span>
<span class="nc" id="L770">						m_customShiftRequest.setExtAfterGap(m_saGapAfterDuration);</span>
<span class="nc" id="L771">						m_customShiftRequest.setExtAfterDuration(m_saDurationAfterDuration);</span>
					}
<span class="nc bnc" id="L773" title="All 2 branches missed.">					if (!isExtDuringGapEditable()) {</span>
<span class="nc" id="L774">						setDuringGapDuration(m_savedDuringGapDuration);</span>
					}

				}

<span class="nc bnc" id="L779" title="All 4 branches missed.">				if (m_isAuthorized &amp;&amp; existingRequest != null) {</span>
<span class="nc" id="L780">					m_valResults = existingRequest.getValidationResults(true);</span>
				}

<span class="nc" id="L783">				determineCollapsedSections(existingRequest);</span>

				// make sure m_customShiftRequest contains the existingRequest's
				// general request data
<span class="nc" id="L787">				synchRequestWithExistingRequest(existingRequest);</span>

				// We know that m_customShiftRequest now has the right values.
				// They were originally read from extractParameters(), but
				// they could have been overridden above. We also know that we
				// have populated the lists of objects for the day. Now we
				// must get the objects that we need from the lists.
<span class="nc" id="L794">				setCurrentObjects();</span>
<span class="nc" id="L795">				setRequestStartEndBasedOnShiftAndDatePicker();</span>
			}
<span class="nc" id="L797">		} catch (RmBaseException ex) {</span>
<span class="nc" id="L798">			log.l7dError(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L799">			addPageMessage(Message.ERROR_TYPE, ex);</span>
<span class="nc" id="L800">			sumtingWong = true;</span>
<span class="nc" id="L801">		} catch (Exception ex) {</span>
<span class="nc" id="L802">			handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L803">			sumtingWong = true;</span>
		} finally {
<span class="nc" id="L805">			initContentTitle();</span>

<span class="nc bnc" id="L807" title="All 8 branches missed.">			if (!sumtingWong) {</span>
<span class="nc" id="L808">				initContent();</span>
			} else {
<span class="nc" id="L810">				handleError();</span>
			}
<span class="nc" id="L812">		}</span>
<span class="nc" id="L813">	}</span>

	protected void handleError() {
<span class="nc" id="L816">		initToolbar(false);</span>
<span class="nc" id="L817">		setCollapsedSections(true, true, true, true, true);</span>
<span class="nc" id="L818">	}</span>

	/**
	 * Optimize the m_customShiftRequest for the user's ribbon selection. In
	 * other words, we will find the best matching shift and extensions for the
	 * ribbon selection, and set them in our m_customShiftRequest member
	 * variable.
	 */
	protected void optimizeRequestForRibbonSelection() {
<span class="nc bnc" id="L827" title="All 4 branches missed.">		if (m_mostDeficientActivity1 == null &amp;&amp; m_mostDeficientActivity2 == null) {</span>
<span class="nc" id="L828">			return; // nothing to optimize</span>
		} else {
<span class="nc" id="L830">			boolean showNoMatchWarning = false;</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">			if (isNewShiftRequest()) {</span>
				// we will try to find the main Shift that best matches the
				// ribbon interval (we won't try to find an Extension)

<span class="nc bnc" id="L835" title="All 2 branches missed.">				if (!isShiftOptimizable()) {</span>
<span class="nc" id="L836">					showNoMatchWarning = true;</span>
				} else {
<span class="nc" id="L838">					int desiredDuration = (int) ((m_ribbonEndDate.getTime() - m_ribbonStartDate.getTime()) / 1000.0</span>
							/ 60.0);
					// iterate through the available shifts and find one with a
					// length closest to the ribbon range
<span class="nc" id="L842">					Shift closestShift = null;</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">					for (Iterator it = m_shifts.iterator(); it.hasNext();) {</span>
<span class="nc" id="L844">						Shift shift = (Shift) it.next();</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">						if (closestShift == null || (Math.abs(shift.getDuration() - desiredDuration) &lt; Math</span>
<span class="nc bnc" id="L846" title="All 2 branches missed.">								.abs(closestShift.getDuration() - desiredDuration))) {</span>
<span class="nc" id="L847">							closestShift = shift;</span>
						}
<span class="nc" id="L849">					}</span>

<span class="nc bnc" id="L851" title="All 2 branches missed.">					if (closestShift != null) {</span>
<span class="nc" id="L852">						m_customShiftRequest.setShiftID(closestShift.getID());</span>
<span class="nc" id="L853">						m_customShiftRequest.setActivityID(m_mostDeficientActivity1.getID());</span>
<span class="nc" id="L854">						m_customShiftRequest.setShiftStartTime(m_ribbonStartDate);</span>
						// &quot;The closest matching shift to your net staffing
						// selection has been pre-selected.&quot;
<span class="nc" id="L857">						addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INFO_CLOSEST_MATCH_SELECTED,</span>
								RmWebBundleKey.BUNDLE_NAME);
					} else {
<span class="nc" id="L860">						showNoMatchWarning = true;</span>
					}
<span class="nc" id="L862">				}</span>
			} else // shift change request
			{
				// we will try to find the Extension that best matches the
				// ribbon interval (we won't try to modify the main Shift)

<span class="nc bnc" id="L868" title="All 4 branches missed.">				if (!isExtBeforeOptimizable() &amp;&amp; !isExtAfterOptimizable()) {</span>
<span class="nc" id="L869">					showNoMatchWarning = true;</span>
				} else {

<span class="nc" id="L872">					boolean foundOptimalBefore = false;</span>
<span class="nc" id="L873">					boolean foundOptimalAfter = false;</span>
<span class="nc" id="L874">					long desiredDuration = 0;</span>
<span class="nc" id="L875">					ShiftOTExtension closestExt = null;</span>
<span class="nc bnc" id="L876" title="All 4 branches missed.">					if (m_mostDeficientActivity1 != null &amp;&amp; isExtBeforeOptimizable()</span>
<span class="nc bnc" id="L877" title="All 2 branches missed.">							&amp;&amp; m_ribbonStartDate.before(m_shiftAssignment.getStartTime())) {</span>
<span class="nc" id="L878">						Date desiredStartDateBefore = m_ribbonStartDate;</span>
<span class="nc bnc" id="L879" title="All 2 branches missed.">						Date desiredEndDateBefore = m_ribbonEndDate.before(m_shiftAssignment.getStartTime())</span>
<span class="nc" id="L880">								? m_ribbonEndDate : m_shiftAssignment.getStartTime();</span>
<span class="nc" id="L881">						desiredDuration = (int) ((desiredEndDateBefore.getTime()</span>
<span class="nc" id="L882">								- desiredStartDateBefore.getTime()) / 1000.0 / 60.0);</span>
						// iterate through the available extBefore's and find
						// one with a length closest to the ribbon range

<span class="nc bnc" id="L886" title="All 2 branches missed.">						for (Iterator it = m_extBeforeTypes.iterator(); it.hasNext();) {</span>
<span class="nc" id="L887">							ShiftOTExtension ext = (ShiftOTExtension) it.next();</span>
<span class="nc bnc" id="L888" title="All 4 branches missed.">							if ((!ext.getID().equals(NONE_ID))</span>
<span class="nc" id="L889">									&amp;&amp; (closestExt == null || (Math.abs(ext.getDuration() - desiredDuration) &lt; Math</span>
<span class="nc bnc" id="L890" title="All 2 branches missed.">											.abs(closestExt.getDuration() - desiredDuration)))) {</span>
<span class="nc" id="L891">								closestExt = ext;</span>
							}
<span class="nc bnc" id="L893" title="All 4 branches missed.">							if (!beforeDurationMatchShiftDuration &amp;&amp; ext.getDuration() == desiredDuration) {</span>
<span class="nc" id="L894">								beforeDurationMatchShiftDuration = true;</span>
							}
<span class="nc" id="L896">						}</span>

<span class="nc bnc" id="L898" title="All 4 branches missed.">						if (closestExt != null &amp;&amp; areDurationsClose(desiredDuration, closestExt.getDuration())) {</span>
<span class="nc" id="L899">							long desiredGapBefore = 0;</span>
<span class="nc bnc" id="L900" title="All 2 branches missed.">							if (desiredEndDateBefore.before(m_shiftAssignment.getStartTime())) {</span>
<span class="nc" id="L901">								desiredGapBefore = m_shiftAssignment.getStartTime().getTime()</span>
<span class="nc" id="L902">										- desiredEndDateBefore.getTime();</span>
							}

<span class="nc" id="L905">							m_customShiftRequest.setExtBeforeID(closestExt.getID());</span>
<span class="nc" id="L906">							m_customShiftRequest.setExtBeforeDuration(closestExt.getDuration());</span>
<span class="nc" id="L907">							m_customShiftRequest.setExtBeforeActivityID(m_mostDeficientActivity1.getID());</span>
<span class="nc" id="L908">							m_customShiftRequest.setExtBeforeGap((int) (desiredGapBefore / 1000.0 / 60.0));</span>
<span class="nc" id="L909">							m_extBeforeType = closestExt;</span>
<span class="nc" id="L910">							foundOptimalBefore = true;</span>
						}
					}

<span class="nc bnc" id="L914" title="All 4 branches missed.">					if (m_mostDeficientActivity2 != null &amp;&amp; isExtAfterOptimizable()</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">							&amp;&amp; m_ribbonEndDate.after(m_shiftAssignment.getEndTime())) {</span>
<span class="nc bnc" id="L916" title="All 2 branches missed.">						Date desiredStartDateAfter = m_ribbonStartDate.after(m_shiftAssignment.getEndTime())</span>
<span class="nc" id="L917">								? m_ribbonStartDate : m_shiftAssignment.getEndTime();</span>
<span class="nc" id="L918">						Date desiredEndDateAfter = m_ribbonEndDate;</span>
<span class="nc" id="L919">						desiredDuration = (int) ((desiredEndDateAfter.getTime() - desiredStartDateAfter.getTime())</span>
								/ 1000.0 / 60.0);

						// iterate through the available extAfter's and find one
						// with a length closest to the ribbon range
<span class="nc bnc" id="L924" title="All 2 branches missed.">						for (Iterator it = m_extAfterTypes.iterator(); it.hasNext();) {</span>
<span class="nc" id="L925">							ShiftOTExtension ext = (ShiftOTExtension) it.next();</span>
<span class="nc bnc" id="L926" title="All 4 branches missed.">							if ((!ext.getID().equals(NONE_ID))</span>
<span class="nc" id="L927">									&amp;&amp; (closestExt == null || (Math.abs(ext.getDuration() - desiredDuration) &lt; Math</span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">											.abs(closestExt.getDuration() - desiredDuration)))) {</span>
<span class="nc" id="L929">								closestExt = ext;</span>
							}
<span class="nc bnc" id="L931" title="All 4 branches missed.">							if (!afterDurationMatchShiftDuration &amp;&amp; ext.getDuration() == desiredDuration) {</span>
<span class="nc" id="L932">								afterDurationMatchShiftDuration = true;</span>
							}
<span class="nc" id="L934">						}</span>

<span class="nc bnc" id="L936" title="All 4 branches missed.">						if (closestExt != null &amp;&amp; areDurationsClose(desiredDuration, closestExt.getDuration())) {</span>
<span class="nc" id="L937">							long desiredGapAfter = 0;</span>
<span class="nc bnc" id="L938" title="All 2 branches missed.">							if (desiredStartDateAfter.after(m_shiftAssignment.getEndTime())) {</span>
<span class="nc" id="L939">								desiredGapAfter = desiredStartDateAfter.getTime()</span>
<span class="nc" id="L940">										- m_shiftAssignment.getEndTime().getTime();</span>
							}

<span class="nc" id="L943">							m_customShiftRequest.setExtAfterID(closestExt.getID());</span>
<span class="nc" id="L944">							m_customShiftRequest.setExtAfterDuration(closestExt.getDuration());</span>
<span class="nc" id="L945">							m_customShiftRequest.setExtAfterActivityID(m_mostDeficientActivity2.getID());</span>
<span class="nc" id="L946">							m_customShiftRequest.setExtAfterGap((int) (desiredGapAfter / 1000.0 / 60.0));</span>
<span class="nc" id="L947">							m_extAfterType = closestExt;</span>
<span class="nc" id="L948">							foundOptimalAfter = true;</span>
						}
					}

<span class="nc bnc" id="L952" title="All 2 branches missed.">					if (beforeDurationMatchShiftDuration) {</span>
						// &quot;The closest matching extensions to your net staffing
						// selection are shown below.&quot;
<span class="nc" id="L955">						addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INFO_ADDED_EXTENSIONS,</span>
								RmWebBundleKey.BUNDLE_NAME);

<span class="nc bnc" id="L958" title="All 2 branches missed.">					} else if (afterDurationMatchShiftDuration) {</span>
						// &quot;The closest matching extension to your net staffing
						// selection is shown below.&quot;
<span class="nc" id="L961">						addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INFO_ADDED_EXTENSION,</span>
								RmWebBundleKey.BUNDLE_NAME);
<span class="nc bnc" id="L963" title="All 4 branches missed.">					} else if ((foundOptimalBefore || foundOptimalAfter)) {</span>
						// if the Before or After duration drawn on Net Staffing does not with Shift Duration, it shows warning message
						// And highlight the shift duration and add a warning icon next to duration
<span class="nc bnc" id="L966" title="All 2 branches missed.">						if (denyOTDurationEdit) {</span>
							// Only highlight If the setting &quot;Enforce the duration for overtime extension requests &quot; is checked
<span class="nc" id="L968">							strDesiredDuration = CustomShiftUtil.getDurationString(m_context.getLocalizer(), (int) desiredDuration);</span>
<span class="nc" id="L969">							strShiftDuration = CustomShiftUtil.getDurationString(m_context.getLocalizer(), closestExt.getDuration());</span>
<span class="nc" id="L970">							addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.CSR_WARNING_ADDED_EXTENSION_DETAIL,</span>
									RmWebBundleKey.BUNDLE_NAME, new String[] { strDesiredDuration, strShiftDuration });
<span class="nc" id="L972">							highlightBeforeDuration = foundOptimalBefore;</span>
<span class="nc" id="L973">							highlightAfterDuration = foundOptimalAfter;</span>
						}
					} else {
<span class="nc" id="L976">						showNoMatchWarning = true;</span>
					}
				}
			}
<span class="nc bnc" id="L980" title="All 4 branches missed.">			if (!nothingIsEditable() &amp;&amp; showNoMatchWarning) {</span>
				// &quot;A best match for your net staffing selection could not be
				// automatically determined.&quot;
<span class="nc" id="L983">				addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.CSR_WARNING_BEST_MATCH_NOT_FOUND,</span>
						RmWebBundleKey.BUNDLE_NAME);
			}
		}
<span class="nc" id="L987">	}</span>

	/**
	 * Determines whether the first duration is at least half of the second
	 * duration.
	 */
	private static boolean areDurationsClose(long d1, long d2) {
<span class="nc" id="L994">		return true; // d1 &gt;= ((double)(d2 / 2.0));</span>
	}

	/**
	 * Initialize Model with Data. No UI components should be initialized here
	 * except for any required to initialize data values properly. This method
	 * is called AFTER extractParameters() in the Request Handler for when the
	 * Save button is clicked.
	 */
	protected void initializeModelForSaving() throws Exception {
<span class="nc" id="L1004">		ID empID = getRequestedFor();</span>

<span class="nc" id="L1006">		CustomShiftRequestsMH.CSDetailData csData = null;</span>
<span class="nc bnc" id="L1007" title="All 2 branches missed.">		CustShiftReq existingRequest = (getRequestID() == null) ? null</span>
<span class="nc" id="L1008">				: CustomShiftRequestsMH.getCSRequest(getRequestID());</span>

		{
<span class="nc" id="L1011">			Pair entireDayDates = getFromToDates(null);</span>
<span class="nc" id="L1012">			Date dayStart = (Date) entireDayDates.getFirst();</span>
<span class="nc" id="L1013">			Date dayEnd = (Date) entireDayDates.getSecond();</span>

<span class="nc bnc" id="L1015" title="All 2 branches missed.">			if (isManagerMode()) {</span>
<span class="nc" id="L1016">				csData = CustomShiftRequestsMH.getCSDetailDataForManager(m_context, m_context.getUser(), empID, isNew(),</span>
						existingRequest, dayStart, dayEnd, m_ribbonStartDate, m_ribbonEndDate, false, m_bundle,
						m_view_tz);
			} else {
<span class="nc" id="L1020">				csData = CustomShiftRequestsMH.getCSDetailData(m_context, empID, existingRequest, dayStart, dayEnd,</span>
						m_ribbonStartDate, m_ribbonEndDate, false, m_bundle, m_view_tz);
			}

<span class="nc" id="L1024">			storeCSDataInMemberVars(csData);</span>

<span class="nc" id="L1026">			afterLoadCSDataIninitializeModelForSaving();</span>

			// The Gap duration spinners do not submit their values when they
			// are readonly. Because of this,
			// we must reload their original values rather than use their
			// extracted values which aren't available.
<span class="nc bnc" id="L1032" title="All 2 branches missed.">			if (!isExtBeforeEditable()) {</span>
<span class="nc" id="L1033">				m_customShiftRequest.setExtBeforeGap(m_saGapBeforeDuration);</span>
<span class="nc" id="L1034">				m_customShiftRequest.setExtBeforeDuration(m_saDurationBeforeDuration);</span>
			}
<span class="nc bnc" id="L1036" title="All 2 branches missed.">			if (!isExtAfterEditable()) {</span>
<span class="nc" id="L1037">				m_customShiftRequest.setExtAfterGap(m_saGapAfterDuration);</span>
<span class="nc" id="L1038">				m_customShiftRequest.setExtAfterDuration(m_saDurationAfterDuration);</span>
			}
<span class="nc bnc" id="L1040" title="All 2 branches missed.">			if (!isExtDuringGapEditable()) {</span>
<span class="nc" id="L1041">				setDuringGapDuration(m_savedDuringGapDuration);</span>
			}

			// make sure m_customShiftRequest contains the existingRequest's
			// general request data
<span class="nc" id="L1046">			synchRequestWithExistingRequest(existingRequest);</span>

			// We know that m_customShiftRequest now has the right values. They
			// were originally read from extractParameters(), but
			// they could have been overridden above. We also know that we have
			// populated the lists of objects for the day. Now we
			// must get the objects that we need from the lists.
<span class="nc" id="L1053">			setCurrentObjects();</span>
<span class="nc" id="L1054">			setRequestStartEndBasedOnShiftAndDatePicker();</span>
<span class="nc" id="L1055">			updateDurationGapDuringSave();</span>
			// m_customShiftRequest.setSubType(determineRequestSubType());
		}
<span class="nc" id="L1058">	}</span>

	/**
	 * Method used for extra logic for REST services. This is required because certain logic needs to happen after csData is loaded
	 * but before synchRequestWithExistingRequest and setCurrentObjects.
	 */
	protected void afterLoadCSDataIninitializeModelForSaving() throws Exception {

<span class="nc" id="L1066">	}</span>

	/**
	 * If we are editing an existing CustShiftReq, we need to use it as our
	 * member variable, since it contains the general request information from
	 * the db (such as expirationDate) that was not included in our extracted
	 * params. This extra info is required when saving the request.
	 */
	public void synchRequestWithExistingRequest(CustShiftReq existingRequest) {
<span class="nc bnc" id="L1075" title="All 2 branches missed.">		if (existingRequest != null) {</span>
<span class="nc" id="L1076">			existingRequest.setShiftID(m_customShiftRequest.getShiftID());</span>
<span class="nc" id="L1077">			existingRequest.setActivityID(m_customShiftRequest.getActivityID());</span>
<span class="nc" id="L1078">			existingRequest.setShiftStartTime(m_customShiftRequest.getShiftStartTime());</span>
<span class="nc" id="L1079">			existingRequest.setShiftEndTime(m_customShiftRequest.getShiftEndTime());</span>
<span class="nc" id="L1080">			existingRequest.setIsOT(m_customShiftRequest.isOT());</span>
<span class="nc" id="L1081">			existingRequest.setExtBeforeID(m_customShiftRequest.getExtBeforeID());</span>
<span class="nc" id="L1082">			existingRequest.setExtBeforeActivityID(m_customShiftRequest.getExtBeforeActivityID());</span>
<span class="nc" id="L1083">			existingRequest.setExtBeforeIsOT(m_customShiftRequest.getExtBeforeIsOT());</span>
<span class="nc" id="L1084">			existingRequest.setExtBeforeGap(m_customShiftRequest.getExtBeforeGap());</span>
<span class="nc" id="L1085">			existingRequest.setExtAfterID(m_customShiftRequest.getExtAfterID());</span>
<span class="nc" id="L1086">			existingRequest.setExtAfterActivityID(m_customShiftRequest.getExtAfterActivityID());</span>
<span class="nc" id="L1087">			existingRequest.setExtAfterIsOT(m_customShiftRequest.getExtAfterIsOT());</span>
<span class="nc" id="L1088">			existingRequest.setExtAfterGap(m_customShiftRequest.getExtAfterGap());</span>
<span class="nc" id="L1089">			existingRequest.setExtBeforeDuration(m_customShiftRequest.getExtBeforeDuration());</span>
<span class="nc" id="L1090">			existingRequest.setExtAfterDuration(m_customShiftRequest.getExtAfterDuration());</span>
<span class="nc" id="L1091">			existingRequest.setShiftAssignmentID(m_customShiftRequest.getShiftAssignmentID());</span>

<span class="nc" id="L1093">			Collection&lt;CustShiftReqGap&gt; existingGaps = existingRequest.getChildObjects(CustShiftReqFieldInfo.CUSTREQGAP_CHILD_TYPE);</span>
<span class="nc bnc" id="L1094" title="All 4 branches missed.">			if (getCustShiftReqGap() != null &amp;&amp; getCustShiftReqGap().getExtGapStartTime() != null) {</span>
<span class="nc" id="L1095">				CustShiftReqGap customGap = getCustShiftReqGap();</span>
<span class="nc bnc" id="L1096" title="All 2 branches missed.">				if (!existingGaps.isEmpty()) {</span>
<span class="nc" id="L1097">					CustShiftReqGap existingGap = existingGaps.iterator().next();</span>
<span class="nc" id="L1098">					existingGap.setExtGapStartTime(customGap.getExtGapStartTime());</span>
<span class="nc" id="L1099">					existingGap.setExtGapEndTime(customGap.getExtGapEndTime());</span>
<span class="nc" id="L1100">					existingGap.setExtGapDuration(customGap.getExtGapDuration());</span>
<span class="nc" id="L1101">					existingGap.setExtGapGap(customGap.getExtGapGap());</span>
<span class="nc" id="L1102">					existingGap.setExtGapActivityID(customGap.getExtGapActivityID());</span>
<span class="nc" id="L1103">					existingGap.setShiftOtGapID(customGap.getShiftOTGapID());</span>
<span class="nc" id="L1104">					existingRequest.updateChildObject(CustShiftReqFieldInfo.CUSTREQGAP_CHILD_TYPE, existingGap);</span>
<span class="nc" id="L1105">				} else {</span>
<span class="nc" id="L1106">					existingRequest.createChildObject(CustShiftReqFieldInfo.CUSTREQGAP_CHILD_TYPE, customGap);</span>
				}
<span class="nc" id="L1108">			} else {</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">				if (!existingGaps.isEmpty()) {</span>
<span class="nc" id="L1110">					existingRequest.deleteAllChildren(CustShiftReqFieldInfo.CUSTREQGAP_CHILD_TYPE);</span>
				}
			}

<span class="nc" id="L1114">			setCustomShiftRequest(existingRequest);</span>
		}
<span class="nc" id="L1116">	}</span>

	/**
	 * Reset the m_customShiftRequest so that all extracted params are wiped-out
	 * except startDate.
	 */
	private void resetCustomShiftRequest() {
<span class="nc" id="L1123">		m_customShiftRequest.setShiftID(null);</span>
<span class="nc" id="L1124">		m_customShiftRequest.setActivityID(null);</span>

<span class="nc" id="L1126">		m_customShiftRequest.setShiftStartTime(m_datePickerPC.getDate());</span>
<span class="nc" id="L1127">		m_customShiftRequest.setShiftEndTime(m_datePickerPC.getDate());</span>

<span class="nc" id="L1129">		m_customShiftRequest.setIsOT(false);</span>

<span class="nc" id="L1131">		m_customShiftRequest.setExtBeforeID(null);</span>
<span class="nc" id="L1132">		m_customShiftRequest.setExtBeforeActivityID(null);</span>
<span class="nc" id="L1133">		m_customShiftRequest.setExtBeforeIsOT(false);</span>
<span class="nc" id="L1134">		m_customShiftRequest.setExtBeforeGap(0);</span>

<span class="nc" id="L1136">		m_customShiftRequest.setExtAfterID(null);</span>
<span class="nc" id="L1137">		m_customShiftRequest.setExtAfterActivityID(null);</span>
<span class="nc" id="L1138">		m_customShiftRequest.setExtAfterIsOT(false);</span>
<span class="nc" id="L1139">		m_customShiftRequest.setExtAfterGap(0);</span>

<span class="nc" id="L1141">		m_customShiftRequest.setExtBeforeDuration(0);</span>
<span class="nc" id="L1142">		m_customShiftRequest.setExtAfterDuration(0);</span>
<span class="nc" id="L1143">		m_customShiftRequest.setShiftAssignmentID(null);</span>

<span class="nc" id="L1145">		m_customShiftRequest.deleteAllChildren(CustShiftReqFieldInfo.CUSTREQGAP_CHILD_TYPE);</span>

<span class="nc" id="L1147">	}</span>

	/**
	 * Return true if the currently selected day contains a shift assignment for
	 * the employee. If so, this means that any Custom Shift request on this day
	 * must be a Shift Change request rather than a New Shift request.
	 */
	public boolean isShiftChangeRequest() {
<span class="nc bnc" id="L1155" title="All 2 branches missed.">		return (m_shiftAssignment != null);</span>
	}

	/**
	 * Return true if the currently selected day does NOT contain a shift
	 * assignment for the employee. This means that any Custom Shift request on
	 * this day must be a New Shift request rather than a Shift Change request.
	 */
	public boolean isNewShiftRequest() {
<span class="nc bnc" id="L1164" title="All 2 branches missed.">		return (m_shiftAssignment == null);</span>
	}

	public ShiftAssignment getShiftAssignment() {
<span class="nc" id="L1168">		return m_shiftAssignment;</span>
	}

	/**
	 * Use the ID's set in the m_customShiftRequest, and the lists of objects
	 * (Shifts, Activities, etc) for the selected day to set the current object
	 * member variables (m_shift, etc).
	 */
	private void setCurrentObjects() {
<span class="nc bnc" id="L1177" title="All 2 branches missed.">		if (m_customShiftRequest != null) {</span>
<span class="nc bnc" id="L1178" title="All 4 branches missed.">			if (m_customShiftRequest.getShiftID() != null &amp;&amp; m_shifts != null) {</span>
<span class="nc bnc" id="L1179" title="All 2 branches missed.">				for (Iterator it = m_shifts.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1180">					Shift shift = (Shift) it.next();</span>
<span class="nc bnc" id="L1181" title="All 2 branches missed.">					if (shift.getID().equals(m_customShiftRequest.getShiftID())) {</span>
<span class="nc" id="L1182">						m_shift = shift;</span>

<span class="nc bnc" id="L1184" title="All 2 branches missed.">						if (m_reloadAction.equals(RELOAD_ACTION_SHIFT)) {</span>
							// The page was reloaded due to the user changing
							// the Shift selection. We must update the default
							// selected activity accordingly.
<span class="nc bnc" id="L1188" title="All 4 branches missed.">							if (m_selectedDayIncludesRibbonSelection &amp;&amp; m_mostDeficientActivity1 != null) {</span>
<span class="nc" id="L1189">								m_customShiftRequest.setActivityID(m_mostDeficientActivity1.getID());</span>
							} else {
<span class="nc" id="L1191">								m_customShiftRequest.setActivityID(m_shift.getActivityID());</span>
							}
						}
						break;
					}
<span class="nc" id="L1196">				}</span>
			}

<span class="nc bnc" id="L1199" title="All 4 branches missed.">			if (m_customShiftRequest.getShiftID() == null &amp;&amp; m_shifts != null) {</span>
				// since no shift is selected, we'll select the first one by
				// default, and store the Shift and activityID
<span class="nc bnc" id="L1202" title="All 2 branches missed.">				for (Iterator it = m_shifts.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1203">					m_shift = (Shift) it.next();</span>
<span class="nc" id="L1204">					m_customShiftRequest.setShiftID(m_shift.getID());</span>
<span class="nc" id="L1205">					ID activityID = m_shift.getActivityID();</span>
<span class="nc bnc" id="L1206" title="All 4 branches missed.">					if (activityID != null &amp;&amp; m_activities != null) {</span>
<span class="nc bnc" id="L1207" title="All 2 branches missed.">						for (Iterator actIt = m_activities.iterator(); actIt.hasNext();) {</span>
<span class="nc" id="L1208">							Activity activity = (Activity) actIt.next();</span>
<span class="nc bnc" id="L1209" title="All 2 branches missed.">							if (activity.getID().equals(activityID)) {</span>
<span class="nc" id="L1210">								m_customShiftRequest.setActivityID(activityID);</span>
<span class="nc" id="L1211">								break;</span>
							}
<span class="nc" id="L1213">						}</span>
					}
					break; // we only want the first one
				}
			}

<span class="nc bnc" id="L1219" title="All 4 branches missed.">			if (m_customShiftRequest.getExtBeforeID() != null &amp;&amp; m_extBeforeTypes != null) {</span>
<span class="nc bnc" id="L1220" title="All 2 branches missed.">				for (Iterator it = m_extBeforeTypes.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1221">					ShiftOTExtension ext = (ShiftOTExtension) it.next();</span>
<span class="nc bnc" id="L1222" title="All 2 branches missed.">					if (ext.getID().equals(m_customShiftRequest.getExtBeforeID())) {</span>
<span class="nc" id="L1223">						m_extBeforeType = ext;</span>

						// If the selected extension is the one originally
						// assigned, get the duration/activity from the
						// ShiftAssignment,
						// since it may be a custom duration/activity.
						// Otherwise, get the duration/activity from the
						// selected extension's template.
<span class="nc bnc" id="L1231" title="All 2 branches missed.">						ID assignedExtID = (m_shiftAssignment == null) ? null</span>
<span class="nc" id="L1232">								: m_shiftAssignment.getOTExtensionBeforeID();</span>
<span class="nc bnc" id="L1233" title="All 2 branches missed.">						assignedExtID = (assignedExtID == null) ? CUSTOM_ID : assignedExtID;</span>
<span class="nc bnc" id="L1234" title="All 4 branches missed.">						if (m_shiftAssignment != null &amp;&amp; ext.getID().equals(assignedExtID)) {</span>
<span class="nc bnc" id="L1235" title="All 2 branches missed.">							if (useOTExtensionBeforeDuration()) {</span>
<span class="nc" id="L1236">								m_customShiftRequest.setExtBeforeDuration(</span>
<span class="nc" id="L1237">										m_shiftAssignment.getExtensionBefore() - m_saGapBeforeDuration);</span>
							}
							// only update activity when changing extType,
							// otherwise, keep extracted value
<span class="nc bnc" id="L1241" title="All 2 branches missed.">							if (m_reloadAction.equals(RELOAD_ACTION_EXT_BEFORE)) {</span>
<span class="nc bnc" id="L1242" title="All 4 branches missed.">								if (m_selectedDayIncludesRibbonSelection &amp;&amp; m_mostDeficientActivity1 != null) {</span>
<span class="nc" id="L1243">									m_customShiftRequest.setExtBeforeActivityID(m_mostDeficientActivity1.getID());</span>
								} else {
<span class="nc" id="L1245">									m_customShiftRequest</span>
<span class="nc" id="L1246">											.setExtBeforeActivityID(m_shiftAssignment.getOTExtensionBeforeActivityID());</span>
								}
<span class="nc" id="L1248">								m_customShiftRequest.setExtBeforeGap(m_extBeforeType.getMinGap());</span>
							}
						} else {
<span class="nc bnc" id="L1251" title="All 2 branches missed.">							if (useOTExtensionBeforeDuration()) {</span>
<span class="nc" id="L1252">								m_customShiftRequest.setExtBeforeDuration(m_extBeforeType.getDuration());</span>
							}

							// only update activity when changing extType,
							// otherwise, keep extracted value
<span class="nc bnc" id="L1257" title="All 2 branches missed.">							if (m_reloadAction.equals(RELOAD_ACTION_EXT_BEFORE)) {</span>
<span class="nc bnc" id="L1258" title="All 4 branches missed.">								if (m_selectedDayIncludesRibbonSelection &amp;&amp; m_mostDeficientActivity1 != null</span>
<span class="nc bnc" id="L1259" title="All 2 branches missed.">										&amp;&amp; !ext.getID().equals(NONE_ID)) {</span>
<span class="nc" id="L1260">									m_customShiftRequest.setExtBeforeActivityID(m_mostDeficientActivity1.getID());</span>
								} else {
<span class="nc" id="L1262">									m_customShiftRequest.setExtBeforeActivityID(m_extBeforeType.getActivityID());</span>
								}
<span class="nc" id="L1264">								m_customShiftRequest.setExtBeforeGap(m_extBeforeType.getMinGap());</span>
							}
						}

						break;
					}
<span class="nc" id="L1270">				}</span>
			}

<span class="nc bnc" id="L1273" title="All 4 branches missed.">			if (m_customShiftRequest.getExtAfterID() != null &amp;&amp; m_extAfterTypes != null) {</span>
<span class="nc bnc" id="L1274" title="All 2 branches missed.">				for (Iterator it = m_extAfterTypes.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1275">					ShiftOTExtension ext = (ShiftOTExtension) it.next();</span>
<span class="nc bnc" id="L1276" title="All 2 branches missed.">					if (ext.getID().equals(m_customShiftRequest.getExtAfterID())) {</span>
<span class="nc" id="L1277">						m_extAfterType = ext;</span>

						// If the selected extension is the one originally
						// assigned, get the duration/activity from the
						// ShiftAssignment,
						// since it may be a custom duration/activity.
						// Otherwise, get the duration/activity from the
						// selected extension's template.

<span class="nc bnc" id="L1286" title="All 2 branches missed.">						Activity mostDeficientActivity = isNewShiftRequest() ? m_mostDeficientActivity1</span>
								: m_mostDeficientActivity2;

<span class="nc bnc" id="L1289" title="All 2 branches missed.">						ID assignedExtID = (m_shiftAssignment == null) ? null</span>
<span class="nc" id="L1290">								: m_shiftAssignment.getOTExtensionAfterID();</span>
<span class="nc bnc" id="L1291" title="All 2 branches missed.">						assignedExtID = (assignedExtID == null) ? CUSTOM_ID : assignedExtID;</span>
<span class="nc bnc" id="L1292" title="All 4 branches missed.">						if (m_shiftAssignment != null &amp;&amp; ext.getID().equals(assignedExtID)) {</span>
<span class="nc bnc" id="L1293" title="All 2 branches missed.">							if (useOTExtensionAfterDuration()) {</span>
<span class="nc" id="L1294">								m_customShiftRequest</span>
<span class="nc" id="L1295">										.setExtAfterDuration(m_shiftAssignment.getExtensionAfter() - m_saGapAfterDuration);</span>
							}
							// only update activity when changing extType,
							// otherwise, keep extracted value
<span class="nc bnc" id="L1299" title="All 2 branches missed.">							if (m_reloadAction.equals(RELOAD_ACTION_EXT_AFTER)) {</span>
<span class="nc bnc" id="L1300" title="All 4 branches missed.">								if (m_selectedDayIncludesRibbonSelection &amp;&amp; mostDeficientActivity != null) {</span>
<span class="nc" id="L1301">									m_customShiftRequest.setExtAfterActivityID(mostDeficientActivity.getID());</span>
								} else {
<span class="nc" id="L1303">									m_customShiftRequest</span>
<span class="nc" id="L1304">											.setExtAfterActivityID(m_shiftAssignment.getOTExtensionAfterActivityID());</span>
								}
<span class="nc" id="L1306">								m_customShiftRequest.setExtAfterGap(m_extAfterType.getMinGap());</span>
							}
						} else {
<span class="nc bnc" id="L1309" title="All 2 branches missed.">							if (useOTExtensionAfterDuration()) {</span>
<span class="nc" id="L1310">								m_customShiftRequest.setExtAfterDuration(m_extAfterType.getDuration());</span>
							}

							// only update activity when changing extType,
							// otherwise, keep extracted value
<span class="nc bnc" id="L1315" title="All 2 branches missed.">							if (m_reloadAction.equals(RELOAD_ACTION_EXT_AFTER)) {</span>
<span class="nc bnc" id="L1316" title="All 4 branches missed.">								if (m_selectedDayIncludesRibbonSelection &amp;&amp; mostDeficientActivity != null</span>
<span class="nc bnc" id="L1317" title="All 2 branches missed.">										&amp;&amp; !ext.getID().equals(NONE_ID)) {</span>
<span class="nc" id="L1318">									m_customShiftRequest.setExtAfterActivityID(mostDeficientActivity.getID());</span>
								} else {
<span class="nc" id="L1320">									m_customShiftRequest.setExtAfterActivityID(m_extAfterType.getActivityID());</span>
								}
<span class="nc" id="L1322">								m_customShiftRequest.setExtAfterGap(m_extAfterType.getMinGap());</span>
							}
						}

						break;
					}
<span class="nc" id="L1328">				}</span>
			}

<span class="nc bnc" id="L1331" title="All 4 branches missed.">			if (getDuringGapGapID() != null &amp;&amp; duringGapTypes != null) {</span>
<span class="nc bnc" id="L1332" title="All 2 branches missed.">				for (ShiftOTExtension ext : duringGapTypes) {</span>
<span class="nc bnc" id="L1333" title="All 2 branches missed.">					if (ext.getID().equals(getDuringGapTypeID())) {</span>
<span class="nc" id="L1334">						duringGapType = ext;</span>

						// If the selected extension is the one originally
						// assigned, get the duration/activity from the
						// ShiftAssignment,
						// since it may be a custom duration/activity.
						// Otherwise, get the duration/activity from the
						// selected extension's template.

<span class="nc bnc" id="L1343" title="All 2 branches missed.">						Activity mostDeficientActivity = isNewShiftRequest() ? m_mostDeficientActivity1</span>
								: m_mostDeficientActivity2;

<span class="nc bnc" id="L1346" title="All 2 branches missed.">						ID assignedExtID = (m_shiftAssignment == null) ? null</span>
<span class="nc" id="L1347">								: ext.getID();</span>
<span class="nc bnc" id="L1348" title="All 2 branches missed.">						assignedExtID = (assignedExtID == null) ? CUSTOM_ID : assignedExtID;</span>
<span class="nc bnc" id="L1349" title="All 4 branches missed.">						if (m_shiftAssignment != null &amp;&amp; ext.getID().equals(assignedExtID)) {</span>
<span class="nc bnc" id="L1350" title="All 2 branches missed.">							if (useOTExtensionDuringGapDuration()) {</span>
<span class="nc" id="L1351">								setDuringGapDuration(duringGapType.getDuration());</span>
							}
							// only update activity when changing extType,
							// otherwise, keep extracted value
<span class="nc bnc" id="L1355" title="All 2 branches missed.">							if (m_reloadAction.equals(RELOAD_ACTION_DURING_GAP)) {</span>
<span class="nc bnc" id="L1356" title="All 4 branches missed.">								if (m_selectedDayIncludesRibbonSelection &amp;&amp; mostDeficientActivity != null) {</span>
<span class="nc" id="L1357">									setDuringGapActivityID(mostDeficientActivity.getID());</span>
								} else {
<span class="nc" id="L1359">									setDuringGapActivityID(ext.getActivityID());</span>
								}
<span class="nc" id="L1361">								setDuringGapGap(duringGapType.getMinGap());</span>
							}
						} else {
<span class="nc bnc" id="L1364" title="All 2 branches missed.">							if (useOTExtensionDuringGapDuration()) {</span>
<span class="nc" id="L1365">								setDuringGapDuration(duringGapType.getDuration());</span>
							}
							// only update activity when changing extType,
							// otherwise, keep extracted value
<span class="nc bnc" id="L1369" title="All 2 branches missed.">							if (m_reloadAction.equals(RELOAD_ACTION_DURING_GAP)) {</span>
<span class="nc bnc" id="L1370" title="All 4 branches missed.">								if (m_selectedDayIncludesRibbonSelection &amp;&amp; mostDeficientActivity != null</span>
<span class="nc bnc" id="L1371" title="All 2 branches missed.">										&amp;&amp; !ext.getID().equals(NONE_ID)) {</span>
<span class="nc" id="L1372">									setDuringGapActivityID(mostDeficientActivity.getID());</span>
								} else {
<span class="nc" id="L1374">									setDuringGapActivityID(ext.getActivityID());</span>
								}
<span class="nc" id="L1376">								setDuringGapGap(duringGapType.getMinGap());</span>
							}
						}

						break;
					}
<span class="nc" id="L1382">				}</span>
			}
		}
<span class="nc" id="L1385">	}</span>

	/**
	 * Calculates the ShiftAssignment's duration, not counting the extensions.
	 * If there is no ShiftAssignment for the employee on the selected
	 * startDate, then we just return 0.
	 */
	protected int getShiftAssignmentDurationMinusExtensions() {
<span class="nc bnc" id="L1393" title="All 2 branches missed.">		if (m_shiftAssignment != null) {</span>
<span class="nc" id="L1394">			return (int) ((m_saMainShiftEndTime.getTime() - m_saMainShiftStartTime.getTime())</span>
					/ ShiftAssignment.MILLIS_IN_ONE_MIN);
		}

<span class="nc" id="L1398">		return 0;</span>
	}

	protected void setRequestStartEndBasedOnShiftAndDatePicker() {
<span class="nc bnc" id="L1402" title="All 2 branches missed.">		if (m_shift != null) // Even the &quot;&lt;Custom Shift&gt;&quot; has a Shift object</span>
		// representation
		{
			// set the shift start/end in the request object
<span class="nc" id="L1406">			Calendar cal = Calendar.getInstance(m_view_tz);</span>
<span class="nc bnc" id="L1407" title="All 6 branches missed.">			if (isRibbonMode() &amp;&amp; m_reloadAction.equals(RELOAD_ACTION_RIBBON) &amp;&amp; m_saMainShiftStartTime != null) {</span>
<span class="nc" id="L1408">				cal.setTime(m_saMainShiftStartTime);</span>
<span class="nc" id="L1409">				m_datePickerPC.setDate(cal.getTime());</span>
			} else {
<span class="nc" id="L1411">				cal.setTime(m_datePickerPC.getDate());</span>
<span class="nc" id="L1412">				cal.set(Calendar.HOUR_OF_DAY, m_timePickerPC.getTimeInMinutes() / NO_MINUTES_IN_HOUR);</span>
<span class="nc" id="L1413">				cal.set(Calendar.MINUTE, m_timePickerPC.getTimeInMinutes() % NO_MINUTES_IN_HOUR);</span>
<span class="nc" id="L1414">				m_customShiftRequest.setShiftStartTime(cal.getTime());</span>

				int duration;
<span class="nc bnc" id="L1417" title="All 2 branches missed.">				ID assignedShiftID = (m_shiftAssignment == null) ? new ID(&quot;xxx&quot;)</span>
<span class="nc bnc" id="L1418" title="All 2 branches missed.">						: (m_shiftAssignment.getShiftID() == null ? CUSTOM_ID : m_shiftAssignment.getShiftID());</span>

<span class="nc bnc" id="L1420" title="All 4 branches missed.">				if ((m_shiftAssignment != null) &amp;&amp; (assignedShiftID.equals(m_shift.getID()))) {</span>
					// ShiftAssignment takes precedence over Shift template when the
					// originally assigned Shift is selected
<span class="nc" id="L1423">					duration = getShiftAssignmentDurationMinusExtensions();</span>
				} else {
<span class="nc" id="L1425">					duration = m_shift.getDuration(); // get the duration from the</span>
					// currently selected Shift
					// template
				}

<span class="nc" id="L1430">				cal.add(Calendar.MINUTE, duration);</span>
<span class="nc" id="L1431">				m_customShiftRequest.setShiftEndTime(cal.getTime());</span>
			}

			// make sure the shift start/end are set
<span class="nc bnc" id="L1435" title="All 2 branches missed.">			if (m_customShiftRequest.getShiftStartTime() == null) {</span>
<span class="nc" id="L1436">				m_customShiftRequest.setShiftStartTime(m_datePickerPC.getDate());</span>
			}

<span class="nc bnc" id="L1439" title="All 2 branches missed.">			if (m_customShiftRequest.getShiftEndTime() == null) {</span>
<span class="nc" id="L1440">				m_customShiftRequest.setShiftEndTime(m_datePickerPC.getDate());</span>
			}
		}
<span class="nc" id="L1443">	}</span>

	protected void setStartTimePickerBasedOnRequest() {
<span class="nc" id="L1446">		Calendar cal = Calendar.getInstance(m_view_tz);</span>
<span class="nc" id="L1447">		cal.setTime(m_customShiftRequest.getShiftStartTime());</span>
<span class="nc" id="L1448">		int hours = cal.get(Calendar.HOUR_OF_DAY);</span>
<span class="nc" id="L1449">		int minutes = cal.get(Calendar.MINUTE);</span>
<span class="nc" id="L1450">		m_timePickerPC.setTime((hours * 60 + minutes) * 60); // set the number</span>
		// of seconds since
		// midnight
<span class="nc" id="L1453">	}</span>

	/**
	 * Reset a TimePickerPC page component
	 */
	private void resetTimePickerPC(TimePickerPC picker, String name) {
<span class="nc" id="L1459">		picker.reset();</span>
<span class="nc" id="L1460">		picker.setTimeInterval(TIME_INTERVAL);</span>
		// m_timePickerPC.setIsInputValueOptional(true);
<span class="nc" id="L1462">		picker.setOnChangeJS(reloadWithAction(RELOAD_ACTION_TIME));</span>
<span class="nc" id="L1463">		picker.setInputFieldName(name);</span>
<span class="nc" id="L1464">		picker.setTitle(i18n(m_bundle, RmWebBundleKey.CSR_START_TIME));</span>
<span class="nc" id="L1465">	}</span>

	/**
	 * Create and add Date Range Picker as Child Component
	 */
	private void initDateAndTimePickers() {
<span class="nc" id="L1471">		Calendar cal = Calendar.getInstance(m_view_tz);</span>
<span class="nc" id="L1472">		cal.add(Calendar.DATE, -1); // yesterday's date</span>

<span class="nc" id="L1474">		m_datePickerPC = new DatePickerPC(m_context, SHIFT_START_DATE, m_view_tz, false);</span>
		// PSR for American Airline: with Advanced RM license, allow to request
		// a customer shift which could even happen in the past
<span class="nc bnc" id="L1477" title="All 2 branches missed.">		if (!LicenseUtil.isAdvancedRMLicense()) {</span>
<span class="nc" id="L1478">			m_datePickerPC.setLowerLimit(cal.getTime()); // lower limit is yesterday</span>
		}

		// to allow user to extend
		// shift that crosses day
		// boundary into today.
<span class="nc" id="L1484">		m_datePickerPC.setIsTimeEnabled(false);</span>

		// set upper date limit to 12/31/2078
<span class="nc" id="L1487">		cal.set(2078, 11, 31, 23, 59, 59);</span>
<span class="nc" id="L1488">		m_datePickerPC.setUpperLimit(cal.getTime());</span>
<span class="nc" id="L1489">		m_datePickerPC.setOnChangeJS(reloadWithAction(RELOAD_ACTION_DATE));</span>
<span class="nc" id="L1490">		addChildComponent(m_datePickerPC);</span>

<span class="nc" id="L1492">		m_timePickerPC = new TimePickerPC(m_context);</span>
<span class="nc" id="L1493">		resetTimePickerPC(m_timePickerPC, SHIFT_START_TIME);</span>
<span class="nc" id="L1494">		addChildComponent(m_timePickerPC);</span>
<span class="nc" id="L1495">	}</span>

	/**
	 * Get a Pair of Dates, where the first one is the start of the currently
	 * selected day, and the second one is the end of the currently selected
	 * day. This range does NOT take the selected startTime into consideration.
	 * Like the schedule view pages, this range is NOT aligned with org day
	 * boundary.
	 *
	 * @param existingRequest
	 *            - if null, we will get the current day set in the
	 *            m_datePickerPC. If not null, we will get the day from the
	 *            existingRequest. However, if we are in RIBBON mode, we
	 *            determine the date from m_ribbonStartDate.
	 */
	public Pair getFromToDates(CustShiftReq existingRequest) {
		Date date;

<span class="nc bnc" id="L1513" title="All 4 branches missed.">		if ((isRibbonMode()) &amp;&amp; (m_reloadAction.equals(RELOAD_ACTION_RIBBON))) {</span>
<span class="nc" id="L1514">			date = m_ribbonStartDate; // first time from ribbon selection</span>
<span class="nc bnc" id="L1515" title="All 2 branches missed.">		} else if (existingRequest == null) {</span>
<span class="nc" id="L1516">			date = m_datePickerPC.getDate();</span>
		} else {
<span class="nc" id="L1518">			date = existingRequest.getShiftStartTime(); // getShiftStartTimeFromExistingRequest(existingRequest);</span>
		}

<span class="nc" id="L1521">		Pair dates = CustomShiftUtil.getFullDayRange(date, m_view_tz);</span>
<span class="nc" id="L1522">		m_datePickerPC.setDate((Date) dates.getFirst());</span>
<span class="nc" id="L1523">		return dates;</span>
	}

	/**
	 *
	 * @param existingRequest
	 * @param sa
	 *            - the ShiftAssignment (if any) on this day
	 * @return
	 *
	 * 		public static Date
	 *         getShiftStartTimeFromExistingRequest(CustShiftReq
	 *         existingRequest) //, ShiftAssignment sa) { Date date = null; if
	 *         (existingRequest.getShiftStartTime() != null) { //This is either
	 *         a New Shift request, or a Shift Change request where something in
	 *         the main shift //has changed (either strartTime or ShiftID).
	 *         Either way, the shiftStartTime is known. date =
	 *         existingRequest.getShiftStartTime(); } else if
	 *         (existingRequest.getExtBeforeID() != null) { //This is a Shift
	 *         Change request where they are adding a new extension before. //we
	 *         need to add the extBefore duration+gap to the startTime to get
	 *         the shiftStartTime date = existingRequest.getStartTime(); //this
	 *         should never be null since it is the &quot;delta&quot; start time ... }
	 *         else if (existingRequest.getExtAfterID() != null) { //This is a
	 *         Shift Change request where they are only adding a new extension
	 *         after. //We need to get the ShiftAssignment.getStartTime() date.
	 *         }
	 *
	 *         return date; }
	 */

	/**
	 * Set first day of week using org week start
	 */
	private void setDatePickerWeekStarts(ID orgID) throws Exception {
<span class="nc" id="L1558">		Organization org = OrganizationModelHandler.getOrganization(m_context, orgID);</span>

<span class="nc" id="L1560">		m_datePickerPC.setFirstDayOfWeek(org.getWeekStartDate());</span>

<span class="nc" id="L1562">		Calendar startCal = Calendar.getInstance(m_view_tz);</span>

		/*
		 * set the default time to use organization day boundary int
		 * dayBoundaryOffset = org.getDayBoundaryOffset(); startCal.setTime(new
		 * Date()); startCal.set(Calendar.HOUR_OF_DAY, dayBoundaryOffset/60);
		 * startCal.set(Calendar.MINUTE, dayBoundaryOffset%60); if
		 * (startCal.getTime().before(new Date())) startCal.add(Calendar.DATE,
		 * 1);
		 */
<span class="nc" id="L1572">		CustomShiftUtil.setTimeToMidnight(startCal);</span>

<span class="nc" id="L1574">		m_datePickerPC.setDefaultDisplayDate(startCal.getTime(), m_view_tz);</span>
<span class="nc bnc" id="L1575" title="All 2 branches missed.">		if (m_datePickerPC.getDate() == null) {</span>
<span class="nc" id="L1576">			m_datePickerPC.setDate(startCal.getTime());</span>
		}
<span class="nc" id="L1578">	}</span>

	/**
	 * Disable Date Picker to Read Only
	 */
	private void disableDatePickerPC() {
<span class="nc" id="L1584">		m_datePickerPC.setIsPickerEnabled(false);</span>
<span class="nc" id="L1585">		m_datePickerPC.setInputType(DatePickerPC.INPUT_TYPE_READONLY);</span>
<span class="nc" id="L1586">	}</span>

	/**
	 * Disable Time Picker to Read Only
	 */
	private void disableTimePickerPC() {
<span class="nc" id="L1592">		m_timePickerPC.setIsPickerEnabled(false);</span>
<span class="nc" id="L1593">		m_timePickerPC.setInputType(DatePickerPC.INPUT_TYPE_READONLY);</span>
<span class="nc" id="L1594">	}</span>

	/**
	 * Prepare content title for rendering
	 */
	protected void initContentTitle() {
<span class="nc bnc" id="L1600" title="All 2 branches missed.">		String rbKey = isNew() ? RmWebBundleKey.CREATE_NEW_REQUEST : RmWebBundleKey.EDIT_REQUEST;</span>
<span class="nc" id="L1601">		String pageTitle = i18n(m_bundle, rbKey);</span>

<span class="nc" id="L1603">		String itemName = i18n(m_bundle, RmWebBundleKey.REQUEST_TYPE_CUSTOM_SHIFT);</span>
<span class="nc" id="L1604">		m_contentTitlePC.setPageTitle(pageTitle);</span>
<span class="nc" id="L1605">		m_contentTitlePC.setItemName(itemName);</span>
<span class="nc" id="L1606">	}</span>

	/**
	 * Initialize Content
	 */
	private void initContent() {
<span class="nc bnc" id="L1612" title="All 2 branches missed.">		if (m_isRequestSaved) {</span>
<span class="nc" id="L1613">			RequestUtil.addSavedRequestMsg(m_customShiftRequest, this);</span>
		}

<span class="nc bnc" id="L1616" title="All 4 branches missed.">		if (isManagerMode() &amp;&amp; m_empNames.isEmpty()) {</span>
<span class="nc" id="L1617">			String[] args = new String[1];</span>
<span class="nc" id="L1618">			args[0] = m_context.getSystemManagerFactory().getVerticalizationManager().getVerticalizedString(m_context,</span>
					DefaultVerticalizationManager.WORKERS);

<span class="nc" id="L1621">			addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.CSR_WARNING_NO_PRIV_FOR_REQ_CREATION,</span>
					RmWebBundleKey.BUNDLE_NAME, args);
<span class="nc" id="L1623">			handleError();</span>
<span class="nc" id="L1624">		} else {</span>
<span class="nc" id="L1625">			boolean enableToolbar = initContentAnalyzeState();</span>

<span class="nc bnc" id="L1627" title="All 2 branches missed.">			if (m_isAuthorized) {</span>
<span class="nc" id="L1628">				initMainList();</span>
<span class="nc" id="L1629">				initExtBeforeList();</span>
<span class="nc" id="L1630">				initExtAfterList();</span>
<span class="nc" id="L1631">				initDuringGapList();</span>
<span class="nc" id="L1632">				initAlertList();</span>
			}

<span class="nc bnc" id="L1635" title="All 2 branches missed.">			if (enableToolbar) {</span>
<span class="nc" id="L1636">				initToolbar(true);</span>
			} else {
<span class="nc" id="L1638">				addCancelButton();</span>
			}
		}
<span class="nc" id="L1641">	}</span>

	/**
	 * Goes over the various configurations and settings for the form and sets page messages.
	 * This was abstracted out of initContent so it could be shared by the REST services until we have time to refactor this logic.
	 *
	 * @return
	 * 		Returns whether the toolbar should be enabled/it can be saved.
	 */
	protected boolean initContentAnalyzeState() {
<span class="nc" id="L1651">		boolean enableToolbar = true;</span>

<span class="nc bnc" id="L1653" title="All 4 branches missed.">		if (!m_allowShiftChanges &amp;&amp; !m_allowNewShifts) {</span>
<span class="nc" id="L1654">			addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.CSR_CUSTOM_SHIFT_NOT_ENABLED,</span>
					RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1656">			enableToolbar = false;</span>
<span class="nc bnc" id="L1657" title="All 2 branches missed.">		} else if (m_spID == null) {</span>
<span class="nc" id="L1658">			addPageMessage(Message.WARNING_TYPE,</span>
<span class="nc bnc" id="L1659" title="All 2 branches missed.">					isManagerMode() ? RmWebBundleKey.CSR_WARNING_NO_SCHEDULING_PERIOD</span>
							: RmWebBundleKey.CSR_WARNING_NO_SCHEDULING_PERIOD_FOR_AGENT,
					RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1662">			enableToolbar = false;</span>
<span class="nc bnc" id="L1663" title="All 2 branches missed.">		} else if (m_shifts.isEmpty()) {</span>
<span class="nc bnc" id="L1664" title="All 2 branches missed.">			addPageMessage(Message.WARNING_TYPE, isManagerMode() ? RmWebBundleKey.CSR_WARNING_NO_SHIFTS</span>
					: RmWebBundleKey.CSR_WARNING_NO_SHIFTS_FOR_AGENT, RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1666">			enableToolbar = false;</span>
<span class="nc bnc" id="L1667" title="All 4 branches missed.">		} else if (isNewShiftRequest() &amp;&amp; !m_allowNewShifts) {</span>
<span class="nc" id="L1668">			addPageMessage(Message.WARNING_TYPE,</span>
<span class="nc bnc" id="L1669" title="All 2 branches missed.">					(isManagerMode() ? RmWebBundleKey.CSR_WARNING_NEW_SHIFTS_NOT_ALLOWED</span>
							: RmWebBundleKey.CSR_WARNING_NEW_SHIFTS_NOT_ALLOWED_FOR_AGENT),
					RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1672">			enableToolbar = false;</span>
<span class="nc bnc" id="L1673" title="All 4 branches missed.">		} else if (isShiftChangeRequest() &amp;&amp; !m_allowShiftChanges) {</span>
<span class="nc" id="L1674">			addPageMessage(Message.WARNING_TYPE,</span>
<span class="nc bnc" id="L1675" title="All 2 branches missed.">					(isManagerMode() ? RmWebBundleKey.CSR_WARNING_SHIFT_CHANGES_NOT_ALLOWED</span>
							: RmWebBundleKey.CSR_WARNING_SHIFT_CHANGES_NOT_ALLOWED_FOR_AGENT),
					RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1678">			enableToolbar = false;</span>
<span class="nc bnc" id="L1679" title="All 4 branches missed.">		} else if (nothingIsEditableDueToNoDeficientActivities() &amp;&amp; (m_reloadAction != RELOAD_ACTION_SAVE)) // QC94735</span>
		{
<span class="nc bnc" id="L1681" title="All 2 branches missed.">			if (isNewShiftRequest()) {</span>
<span class="nc" id="L1682">				addPageMessage(Message.WARNING_TYPE,</span>
						RmWebBundleKey.CSR_WARNING_NO_DEFICIENT_ACTIVITIES_FOR_NEW_SHIFT,
						RmWebBundleKey.BUNDLE_NAME);
				// Empty out the list of shifts. The activities list will
				// already be empty. The extensions lists will already be
				// set to None.
<span class="nc" id="L1688">				m_shifts.clear();</span>
			} else {
<span class="nc" id="L1690">				addPageMessage(Message.WARNING_TYPE,</span>
<span class="nc bnc" id="L1691" title="All 2 branches missed.">						isManagerMode() ? RmWebBundleKey.CSR_WARNING_NO_DEFICIENT_ACTIVITIES_FOR_SHIFT_CHANGE</span>
								: RmWebBundleKey.CSR_WARNING_NO_DEFICIENT_ACTIVITIES_FOR_SHIFT_CHANGE_FOR_AGENT,
						RmWebBundleKey.BUNDLE_NAME);
			}
<span class="nc" id="L1695">			enableToolbar = false;</span>
<span class="nc bnc" id="L1696" title="All 4 branches missed.">		} else if (nothingIsEditable() &amp;&amp; (m_reloadAction != RELOAD_ACTION_SAVE)) // QC94735</span>
		{
<span class="nc" id="L1698">			addPageMessage(Message.WARNING_TYPE, RmWebBundleKey.CSR_WARNING_NOTHING_EDITABLE,</span>
					RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1700">			enableToolbar = false;</span>
<span class="nc bnc" id="L1701" title="All 4 branches missed.">		} else if (!isExtBeforeEditable() &amp;&amp; isExtAfterEditable()) {</span>
<span class="nc bnc" id="L1702" title="All 2 branches missed.">			if (!isShiftEditable()) {</span>
<span class="nc" id="L1703">				addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INFO_EXT_AFTER_EDITABLE,</span>
						RmWebBundleKey.BUNDLE_NAME);
			} else {
<span class="nc" id="L1706">				addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INFO_SHIFT_AND_EXT_AFTER_EDITABLE,</span>
						RmWebBundleKey.BUNDLE_NAME);
			}
<span class="nc bnc" id="L1709" title="All 2 branches missed.">			if (isExtDuringGapEditable()) {</span>
<span class="nc" id="L1710">				addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INTO_GAP,</span>
						RmWebBundleKey.BUNDLE_NAME);
			}
<span class="nc bnc" id="L1713" title="All 4 branches missed.">		} else if (isExtBeforeEditable() &amp;&amp; !isExtAfterEditable()) {</span>
<span class="nc bnc" id="L1714" title="All 2 branches missed.">			if (!isShiftEditable()) {</span>
<span class="nc" id="L1715">				addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INFO_EXT_BEFORE_EDITABLE,</span>
						RmWebBundleKey.BUNDLE_NAME);
			} else {
<span class="nc" id="L1718">				addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INFO_SHIFT_AND_EXT_BEFORE_EDITABLE,</span>
						RmWebBundleKey.BUNDLE_NAME);
			}
<span class="nc bnc" id="L1721" title="All 2 branches missed.">			if (isExtDuringGapEditable()) {</span>
<span class="nc" id="L1722">				addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INTO_GAP,</span>
						RmWebBundleKey.BUNDLE_NAME);
			}
<span class="nc bnc" id="L1725" title="All 4 branches missed.">		} else if (!isExtBeforeEditable() &amp;&amp; !isExtAfterEditable()) {</span>
<span class="nc bnc" id="L1726" title="All 2 branches missed.">			if (isExtDuringGapEditable()) {</span>
<span class="nc" id="L1727">				addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INTO_GAP,</span>
						RmWebBundleKey.BUNDLE_NAME);
			}
		}

<span class="nc bnc" id="L1732" title="All 2 branches missed.">		if (!m_isAuthorized) {</span>
<span class="nc" id="L1733">			addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_INFO_UNAUTHORIZED_TO_CREATE_CS_REQUEST,</span>
					RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L1735">			enableToolbar = false;</span>
		}

<span class="nc" id="L1738">		return enableToolbar;</span>
	}

	/**
	 * Return Employee Name Drop Down
	 */
	private String createEmpNameDD() {
<span class="nc bnc" id="L1745" title="All 2 branches missed.">		if (m_empNames.isEmpty()) {</span>
<span class="nc" id="L1746">			return &quot;&quot;;</span>
		}

<span class="nc" id="L1749">		ID selectedID = getRequestedFor();</span>

		// If there is only a single employee name or request has Escalated
		// Status, then just return it as text
<span class="nc bnc" id="L1753" title="All 4 branches missed.">		if (m_empNames.size() == 1 || isEscalatedRequest()) {</span>
<span class="nc" id="L1754">			EmployeeName eName = findEmpNameByID(selectedID);</span>
<span class="nc" id="L1755">			return m_localizer.formatName(eName) + HtmlUtil.makeHiddenInput(REQUESTED_FOR_FN, eName.getID().toString());</span>
		}

		// Create Employee Name Drop Down
<span class="nc" id="L1759">		List sortedENames = new ArrayList(m_empNames);</span>
<span class="nc" id="L1760">		PersonNameUtil.sort(sortedENames, true, m_localeContext);</span>
<span class="nc" id="L1761">		int listSize = sortedENames.size();</span>
<span class="nc" id="L1762">		ArrayList options = new ArrayList(listSize);</span>
<span class="nc bnc" id="L1763" title="All 2 branches missed.">		for (Iterator it = sortedENames.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1764">			EmployeeName eName = (EmployeeName) it.next();</span>
<span class="nc" id="L1765">			String id = eName.getID().toString();</span>
<span class="nc" id="L1766">			String display = m_localizer.formatName(eName);</span>
<span class="nc" id="L1767">			StringsPair option = new StringsPair(id, display);</span>
<span class="nc" id="L1768">			options.add(option);</span>
<span class="nc" id="L1769">		}</span>

<span class="nc bnc" id="L1771" title="All 2 branches missed.">		String selectedValue = (selectedID == null) ? &quot;&quot; : selectedID.toString();</span>
<span class="nc" id="L1772">		return HtmlUtil.makeSelectInput(REQUESTED_FOR_FN, selectedValue, reloadWithAction(RELOAD_ACTION_EMPLOYEE),</span>
				options, false);
	}

	/**
	 * Return Shift Drop Down
	 */
	private String createShiftDD() {
<span class="nc" id="L1780">		ID selectedID = getShiftID();</span>

<span class="nc" id="L1782">		CustomShiftUtil.sort(m_shifts, true, m_localeContext);</span>
<span class="nc" id="L1783">		int listSize = m_shifts.size();</span>
<span class="nc" id="L1784">		ArrayList options = new ArrayList(listSize);</span>
<span class="nc bnc" id="L1785" title="All 2 branches missed.">		for (Iterator it = m_shifts.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1786">			Shift shift = (Shift) it.next();</span>
<span class="nc" id="L1787">			StringsPair option = new StringsPair(shift.getID().toString(), shift.getName());</span>
<span class="nc" id="L1788">			options.add(option);</span>
<span class="nc" id="L1789">		}</span>

<span class="nc bnc" id="L1791" title="All 2 branches missed.">		String selectedValue = (selectedID == null) ? &quot;&quot; : selectedID.toString();</span>
<span class="nc" id="L1792">		String onChange = reloadWithAction(RELOAD_ACTION_SHIFT);</span>
<span class="nc bnc" id="L1793" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L1794">			onChange = onChange + &quot; &quot; + ONCHANGE_PAGE_REFRESH;</span>
		}
<span class="nc" id="L1796">		return HtmlUtil.makeSelectInput(SHIFTID, new String[] { selectedValue }, onChange, options, false, isShiftEditable());</span>
	}

	/**
	 * Return Activity Drop Down
	 */
	private String createActivityDD() {
<span class="nc" id="L1803">		ID selectedID = getActivityID();</span>

<span class="nc" id="L1805">		CustomShiftUtil.sort(m_activities, true, m_localeContext);</span>
<span class="nc" id="L1806">		int listSize = m_activities.size();</span>
<span class="nc" id="L1807">		ArrayList options = new ArrayList(listSize);</span>
<span class="nc bnc" id="L1808" title="All 2 branches missed.">		for (Iterator it = m_activities.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1809">			Activity activity = (Activity) it.next();</span>
<span class="nc" id="L1810">			StringsPair option = new StringsPair(activity.getID().toString(), activity.getName());</span>
<span class="nc" id="L1811">			options.add(option);</span>
<span class="nc" id="L1812">		}</span>

<span class="nc bnc" id="L1814" title="All 2 branches missed.">		String selectedValue = (selectedID == null) ? &quot;&quot; : selectedID.toString();</span>

<span class="nc" id="L1816">		return HtmlUtil.makeSelectInput(ACTIVITYID, new String[] { selectedValue }, JSUtil.ON_CHANGE, options, false,</span>
<span class="nc" id="L1817">				isActivityEditable());</span>
	}

	/**
	 * Return Extension Before Type Drop Down. Do we need to enforce MINGAP,
	 * MAXGAP? This would only be enforced when his current gap duration is not
	 * customized to break the template rules. If it is customized, then we
	 * should disable Gap validation?
	 *
	 * Regardless, we probably need a JavaScript map of
	 * shiftOTExtensionID-&gt;[ActivityID, Duration, MinGap?, MaxGap?]. This would
	 * be used to update Activity, Duration whenever shiftOTExtension selection
	 * changes. The user could then override the default Activity.
	 */
	private String createExtBeforeTypeDD() {
<span class="nc" id="L1832">		ID selectedID = getExtBeforeID();</span>

<span class="nc" id="L1834">		CustomShiftUtil.sort(m_extBeforeTypes, true, m_localeContext);</span>
<span class="nc" id="L1835">		int listSize = m_extBeforeTypes.size();</span>
<span class="nc" id="L1836">		ArrayList options = new ArrayList(listSize);</span>
<span class="nc bnc" id="L1837" title="All 2 branches missed.">		for (Iterator it = m_extBeforeTypes.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1838">			ShiftOTExtension ext = (ShiftOTExtension) it.next();</span>
<span class="nc" id="L1839">			StringsPair option = new StringsPair(ext.getID().toString(), ext.getName());</span>
<span class="nc" id="L1840">			options.add(option);</span>
<span class="nc" id="L1841">		}</span>

<span class="nc bnc" id="L1843" title="All 2 branches missed.">		String selectedValue = (selectedID == null) ? &quot;&quot; : selectedID.toString();</span>

		// this is for javascript validation
<span class="nc bnc" id="L1846" title="All 2 branches missed.">		addJSVariableAsString(&quot;saHasExtBefore&quot;, doesShiftAssignmentHaveAnExtBefore() ? &quot;true&quot; : &quot;false&quot;);</span>
<span class="nc bnc" id="L1847" title="All 2 branches missed.">		addJSVariableAsString(&quot;isExtBeforeEnablable&quot;, isExtBeforeEnablable() ? &quot;true&quot; : &quot;false&quot;);</span>

<span class="nc bnc" id="L1849" title="All 2 branches missed.">		String onChangeValue = isAccessibilityComplianceMode() ? getOnChangeWRefreshAttrVal(RELOAD_ACTION_EXT_BEFORE)</span>
<span class="nc" id="L1850">				: reloadWithAction(RELOAD_ACTION_EXT_BEFORE);</span>

<span class="nc" id="L1852">		return HtmlUtil.makeSelectInput(EXT_BEFORE_ID, new String[] { selectedValue }, onChangeValue, options, false,</span>
<span class="nc" id="L1853">				isExtBeforeEditable());</span>
	}

	/**
	 * Return Extension Before Activity Drop Down
	 */
	private String createExtBeforeActivityDD() {
<span class="nc" id="L1860">		ID selectedID = getExtBeforeActivityID();</span>

<span class="nc" id="L1862">		CustomShiftUtil.sort(m_extBeforeActivities, true, m_localeContext);</span>
<span class="nc" id="L1863">		int listSize = m_extBeforeActivities.size();</span>
<span class="nc" id="L1864">		ArrayList options = new ArrayList(listSize);</span>
<span class="nc bnc" id="L1865" title="All 2 branches missed.">		for (Iterator it = m_extBeforeActivities.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1866">			Activity act = (Activity) it.next();</span>
<span class="nc" id="L1867">			StringsPair option = new StringsPair(act.getID().toString(), act.getName());</span>
<span class="nc" id="L1868">			options.add(option);</span>
<span class="nc" id="L1869">		}</span>

<span class="nc bnc" id="L1871" title="All 2 branches missed.">		String selectedValue = (selectedID == null) ? NONE_ID.toString() : selectedID.toString();</span>

<span class="nc" id="L1873">		return HtmlUtil.makeSelectInput(EXT_BEFORE_ACTIVITY_ID, new String[] { selectedValue }, JSUtil.ON_CHANGE,</span>
<span class="nc" id="L1874">				options, false, isExtBeforeEditableAndNotSetToNone());</span>
	}

	private boolean isExtBeforeEditableAndNotSetToNone() {
<span class="nc bnc" id="L1878" title="All 4 branches missed.">		return isExtBeforeEditable() &amp;&amp; !isExtBeforeSetToNone();</span>
	}

	private boolean isExtBeforeSetToNone() {
<span class="nc bnc" id="L1882" title="All 4 branches missed.">		return m_customShiftRequest.getExtBeforeID() == null || m_customShiftRequest.getExtBeforeID().equals(NONE_ID);</span>
	}

	private boolean isExtAfterEditableAndNotSetToNone() {
<span class="nc bnc" id="L1886" title="All 4 branches missed.">		return isExtAfterEditable() &amp;&amp; !isExtAfterSetToNone();</span>
	}

	private boolean isExtAfterSetToNone() {
<span class="nc bnc" id="L1890" title="All 4 branches missed.">		return m_customShiftRequest.getExtAfterID() == null || m_customShiftRequest.getExtAfterID().equals(NONE_ID);</span>
	}

	private boolean isDuringGapGapSetToNone() {
<span class="nc" id="L1894">		String v = getDuringGapGapID();</span>
<span class="nc bnc" id="L1895" title="All 4 branches missed.">		return v == null || v.equals(NONE_ID.toString());</span>
	}

	private boolean isDuringGapTypeSetToNone() {
<span class="nc" id="L1899">		ID v = getDuringGapTypeID();</span>
<span class="nc bnc" id="L1900" title="All 4 branches missed.">		return v == null || v.equals(NONE_ID.toString());</span>
	}

	private boolean isDuringGapEditableAndNotSetToNone() {
<span class="nc bnc" id="L1904" title="All 4 branches missed.">		return isExtDuringGapEditable() &amp;&amp; !isDuringGapGapSetToNone();</span>
	}

	private boolean isDuringGapTypeEditableAndNotSetToNone() {
<span class="nc bnc" id="L1908" title="All 4 branches missed.">		return isExtDuringGapEditable() &amp;&amp; !isDuringGapTypeSetToNone();</span>
	}

	/**
	 * Return Extension After Type Drop Down
	 */
	private String createExtAfterTypeDD() {
<span class="nc" id="L1915">		ID selectedID = getExtAfterID();</span>

<span class="nc" id="L1917">		CustomShiftUtil.sort(m_extAfterTypes, true, m_localeContext);</span>
<span class="nc" id="L1918">		int listSize = m_extAfterTypes.size();</span>
<span class="nc" id="L1919">		ArrayList options = new ArrayList(listSize);</span>
<span class="nc bnc" id="L1920" title="All 2 branches missed.">		for (Iterator it = m_extAfterTypes.iterator(); it.hasNext();) {</span>
<span class="nc" id="L1921">			ShiftOTExtension ext = (ShiftOTExtension) it.next();</span>
<span class="nc" id="L1922">			StringsPair option = new StringsPair(ext.getID().toString(), ext.getName());</span>
<span class="nc" id="L1923">			options.add(option);</span>
<span class="nc" id="L1924">		}</span>

<span class="nc bnc" id="L1926" title="All 2 branches missed.">		String selectedValue = (selectedID == null) ? &quot;&quot; : selectedID.toString();</span>

		// this is for javascript validation
<span class="nc bnc" id="L1929" title="All 2 branches missed.">		addJSVariableAsString(&quot;saHasExtAfter&quot;, doesShiftAssignmentHaveAnExtAfter() ? &quot;true&quot; : &quot;false&quot;);</span>
<span class="nc bnc" id="L1930" title="All 2 branches missed.">		addJSVariableAsString(&quot;isExtAfterEnablable&quot;, isExtAfterEnablable() ? &quot;true&quot; : &quot;false&quot;);</span>

<span class="nc bnc" id="L1932" title="All 2 branches missed.">		String onChangeValue = isAccessibilityComplianceMode() ? getOnChangeWRefreshAttrVal(RELOAD_ACTION_EXT_AFTER)</span>
<span class="nc" id="L1933">				: reloadWithAction(RELOAD_ACTION_EXT_AFTER);</span>

<span class="nc" id="L1935">		return HtmlUtil.makeSelectInput(EXT_AFTER_ID, new String[] { selectedValue }, onChangeValue, options, false,</span>
<span class="nc" id="L1936">				isExtAfterEditable());</span>
	}

	private String createDuringGapGapDD() {
<span class="nc" id="L1940">		String selectedID = getDuringGapGapID();</span>
<span class="nc" id="L1941">		List&lt;StringsPair&gt; options = new ArrayList&lt;StringsPair&gt;();</span>
		List&lt;TimeRange&gt; gaps;
		try {

<span class="nc bnc" id="L1945" title="All 2 branches missed.">			for (TimeRange gap : duringGaps) {</span>
<span class="nc" id="L1946">				String start = m_context.getLocalizer().formatDate(new LocalDate(gap.getStartDate(),m_context.getViewingTimeZone()), RegionalFormatBundleKey.TIME_FORMAT);</span>
<span class="nc" id="L1947">				String end = m_context.getLocalizer().formatDate(new LocalDate(gap.getEndDate(),m_context.getViewingTimeZone()), RegionalFormatBundleKey.TIME_FORMAT);</span>
<span class="nc" id="L1948">				String optionGapID = gap.getStartDate().getTime() + &quot;_&quot; + gap.getEndDate().getTime();</span>
<span class="nc" id="L1949">				options.add(</span>
<span class="nc" id="L1950">						new StringsPair(optionGapID, m_context.getLocalizer().i18n(m_context.getLocalizer().getBundle(RmWebBundleKey.BUNDLE_NAME), RmWebBundleKey.CSR_IN_GAP, start, end)));</span>
<span class="nc" id="L1951">			}</span>

<span class="nc bnc" id="L1953" title="All 2 branches missed.">			addJSVariableAsString(&quot;saHasDuringGap&quot;, doesShiftAssignmentHaveGaps() ? &quot;true&quot; : &quot;false&quot;);</span>
<span class="nc bnc" id="L1954" title="All 2 branches missed.">			addJSVariableAsString(&quot;isExtDuringGapEnablable&quot;, isExtDuringGapEnablable() ? &quot;true&quot; : &quot;false&quot;);</span>

			// Add none option
<span class="nc" id="L1957">			String none = &quot;&lt;&quot; + m_context.getLocalizer().i18n(m_bundle, RmWebBundleKey.CSR_NONE) + &quot;&gt;&quot;;</span>
<span class="nc" id="L1958">			StringsPair ext = new StringsPair(CustomShiftRequestFormPopupPM.NONE_ID.toString(), none);</span>
<span class="nc" id="L1959">			options.add(0, ext);</span>

<span class="nc" id="L1961">		} catch (Exception e) {</span>
<span class="nc" id="L1962">			log.error(&quot;Exception when loading gap(s) in CustShiftRequestFormPopup component&quot;, e);</span>
<span class="nc" id="L1963">		}</span>

<span class="nc bnc" id="L1965" title="All 2 branches missed.">		String selectedValue = (selectedID == null) ? &quot;&quot; : selectedID;</span>

<span class="nc" id="L1967">		return HtmlUtil.makeSelectInput(DURING_GAP_GAP_ID, String.valueOf(0), new String[] { selectedValue },</span>
<span class="nc bnc" id="L1968" title="All 4 branches missed.">				reloadWithAction(RELOAD_ACTION_DURING_GAP), options, null, false, false, (isExtDuringGapEditable() &amp;&amp; options.size() &gt; 1));</span>
	}

	/**
	 * Return Extension After Type Drop Down
	 */
	private String createDuringGapTypeDD() {
<span class="nc" id="L1975">		ID selectedID = getDuringGapTypeID();</span>
<span class="nc" id="L1976">		CustomShiftUtil.sort(duringGapTypes, true, m_localeContext);</span>
<span class="nc" id="L1977">		ArrayList&lt;StringsPair&gt; options = new ArrayList&lt;StringsPair&gt;(duringGapTypes.size());</span>
<span class="nc" id="L1978">		boolean isSelectedInOptions = false;</span>
<span class="nc bnc" id="L1979" title="All 2 branches missed.">		for (ShiftOTExtension ext : duringGapTypes) {</span>
<span class="nc bnc" id="L1980" title="All 2 branches missed.">			if (ext.getID().compareTo(CUSTOM_ID) == 0) {</span>
<span class="nc" id="L1981">				continue;</span>
			}
<span class="nc bnc" id="L1983" title="All 4 branches missed.">			if (selectedID != null &amp;&amp; selectedID.compareTo(ext.getID()) == 0) {</span>
<span class="nc" id="L1984">				isSelectedInOptions = true;</span>
			}
<span class="nc" id="L1986">			StringsPair option = new StringsPair(ext.getID().toString(), ext.getName());</span>
<span class="nc" id="L1987">			options.add(option);</span>
<span class="nc" id="L1988">		}</span>
<span class="nc bnc" id="L1989" title="All 2 branches missed.">		if (!isSelectedInOptions) {</span>
<span class="nc" id="L1990">			setDuringGapTypeID(null);</span>
		}

<span class="nc bnc" id="L1993" title="All 4 branches missed.">		String selectedValue = (selectedID == null || !isSelectedInOptions) ? &quot;&quot; : selectedID.toString();</span>

<span class="nc" id="L1995">		return HtmlUtil.makeSelectInput(DURING_GAP_TYPE_ID, new String[] { selectedValue },</span>
<span class="nc" id="L1996">				reloadWithAction(RELOAD_ACTION_DURING_GAP), options, false, isDuringGapEditableAndNotSetToNone());</span>
	}

	private String createDuringGapActivityDD() {
<span class="nc" id="L2000">		ID selectedID = getDuringGapActivityID();</span>

<span class="nc" id="L2002">		CustomShiftUtil.sort(duringGapActivities, true, m_localeContext);</span>
<span class="nc" id="L2003">		int listSize = duringGapActivities.size();</span>
<span class="nc" id="L2004">		ArrayList options = new ArrayList(listSize);</span>
<span class="nc bnc" id="L2005" title="All 2 branches missed.">		for (Activity act : duringGapActivities) {</span>
<span class="nc" id="L2006">			StringsPair option = new StringsPair(act.getID().toString(), act.getName());</span>
<span class="nc" id="L2007">			options.add(option);</span>
<span class="nc" id="L2008">		}</span>

<span class="nc bnc" id="L2010" title="All 2 branches missed.">		String selectedValue = (selectedID == null) ? NONE_ID.toString() : selectedID.toString();</span>

<span class="nc" id="L2012">		return HtmlUtil.makeSelectInput(DURING_GAP_ACTIVITY_ID, new String[] { selectedValue }, JSUtil.ON_CHANGE,</span>
<span class="nc" id="L2013">				options, false, isDuringGapTypeEditableAndNotSetToNone());</span>
	}

	/**
	 * Return Extension After Activity Drop Down
	 */
	private String createExtAfterActivityDD() {
<span class="nc" id="L2020">		ID selectedID = getExtAfterActivityID();</span>

<span class="nc" id="L2022">		CustomShiftUtil.sort(m_extAfterActivities, true, m_localeContext);</span>
<span class="nc" id="L2023">		int listSize = m_extAfterActivities.size();</span>
<span class="nc" id="L2024">		ArrayList options = new ArrayList(listSize);</span>
<span class="nc bnc" id="L2025" title="All 2 branches missed.">		for (Iterator it = m_extAfterActivities.iterator(); it.hasNext();) {</span>
<span class="nc" id="L2026">			Activity act = (Activity) it.next();</span>
<span class="nc" id="L2027">			StringsPair option = new StringsPair(act.getID().toString(), act.getName());</span>
<span class="nc" id="L2028">			options.add(option);</span>
<span class="nc" id="L2029">		}</span>

<span class="nc bnc" id="L2031" title="All 2 branches missed.">		String selectedValue = (selectedID == null) ? NONE_ID.toString() : selectedID.toString();</span>

<span class="nc" id="L2033">		return HtmlUtil.makeSelectInput(EXT_AFTER_ACTIVITY_ID, new String[] { selectedValue }, JSUtil.ON_CHANGE,</span>
<span class="nc" id="L2034">				options, false, isExtAfterEditableAndNotSetToNone());</span>
	}

	protected boolean doesShiftAssignmentHaveAnExtBefore() {
<span class="nc bnc" id="L2038" title="All 4 branches missed.">		return m_shiftAssignment != null &amp;&amp; m_shiftAssignment.getExtensionBefore() &gt; 0</span>
<span class="nc bnc" id="L2039" title="All 2 branches missed.">				&amp;&amp; m_shiftAssignment.getOTExtensionBeforeActivityID() != null;</span>
	}

	protected boolean doesShiftAssignmentHaveAnExtAfter() {
<span class="nc bnc" id="L2043" title="All 4 branches missed.">		return m_shiftAssignment != null &amp;&amp; m_shiftAssignment.getExtensionAfter() &gt; 0</span>
<span class="nc bnc" id="L2044" title="All 2 branches missed.">				&amp;&amp; m_shiftAssignment.getOTExtensionAfterActivityID() != null;</span>
	}

	protected boolean doesShiftAssignmentHaveGaps() {
<span class="nc bnc" id="L2048" title="All 4 branches missed.">		return m_shiftAssignment != null &amp;&amp; duringGaps.size() &gt; 0;</span>
	}

	/**
	 * Create Comment History Page Component
	 */
	private MessagePC createCommentHistoryPC() {
<span class="nc" id="L2055">		MessagePC msgPC = RequestUtil.createCmntMsgPC(m_context, &quot;510px&quot;, &quot;50px&quot;, &quot;&quot;);</span>
<span class="nc" id="L2056">		Collection msgs = RequestUtil.getCommentsAsMessages(m_customShiftRequest);</span>
<span class="nc" id="L2057">		msgPC.addMessage(msgs);</span>
<span class="nc" id="L2058">		return msgPC;</span>
	}

	/**
	 * Initialize Main list container
	 */
	private void initMainList() {
<span class="nc" id="L2065">		m_shiftContainerPC = new Collapsible2ColFormPC(m_context);</span>
<span class="nc" id="L2066">		m_shiftContainerPC.setTitle(i18n(m_bundle, RmWebBundleKey.SHIFTTYPE_SHIFT));</span>
<span class="nc" id="L2067">		m_shiftContainerPC.setName(RmWebBundleKey.SHIFTTYPE_SHIFT);</span>
<span class="nc" id="L2068">		m_shiftContainerPC.setCollapsed(getShiftSectionCollapsed());</span>
<span class="nc" id="L2069">		m_shiftContainerPC.setTableSummary(i18n(m_bundle, RmWebBundleKey.SHIFT_DETAILS_TABLE));</span>

<span class="nc bnc" id="L2071" title="All 2 branches missed.">		if (isManagerMode()) {</span>
<span class="nc" id="L2072">			String empNameLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.EMPLOYEE_NAME_LABEL),</span>
					REQUESTED_FOR_FN);
<span class="nc" id="L2074">			m_shiftContainerPC.addRow(empNameLabel, createEmpNameDD());</span>
		}

		// Add the Start Date row
<span class="nc" id="L2078">		createAndAddDatePickerRow();</span>

		// Add the Start Time row
<span class="nc" id="L2081">		createAndAddTimePickerRow();</span>

		// Add the Shift selector row
<span class="nc" id="L2084">		String shiftLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.RM_SA_FILTER_SHIFT), SHIFTID);</span>
<span class="nc" id="L2085">		m_shiftContainerPC.addRow(shiftLabel, createShiftDD());</span>

		// Add the Duration row
<span class="nc bnc" id="L2088" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L2089">			addLabelValueRow508(m_shiftContainerPC, i18n(m_bundle, RmWebBundleKey.CSR_DURATION),</span>
<span class="nc" id="L2090">					CustomShiftUtil.getDurationString(m_customShiftRequest, m_localizer));</span>
		} else {
<span class="nc" id="L2092">			m_shiftContainerPC.addRow(i18n(m_bundle, RmWebBundleKey.CSR_DURATION),</span>
<span class="nc" id="L2093">					CustomShiftUtil.getDurationString(m_customShiftRequest, m_localizer));</span>
		}

		// Add the End Date row
<span class="nc bnc" id="L2097" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L2098">			addLabelValueRow508(m_shiftContainerPC, i18n(m_bundle, RmWebBundleKey.CSR_END_DATE),</span>
<span class="nc" id="L2099">					CustomShiftUtil.getShiftEndDateString(m_customShiftRequest, m_localizer, m_view_tz));</span>
		} else {
<span class="nc" id="L2101">			m_shiftContainerPC.addRow(i18n(m_bundle, RmWebBundleKey.CSR_END_DATE),</span>
<span class="nc" id="L2102">					CustomShiftUtil.getShiftEndDateString(m_customShiftRequest, m_localizer, m_view_tz));</span>
		}

		// Add the Activity selector row
<span class="nc" id="L2106">		String activityLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.RM_SA_FILTER_ACTIVITY), ACTIVITYID);</span>
<span class="nc" id="L2107">		m_shiftContainerPC.addRow(activityLabel, createActivityDD());</span>

		// Add the OT/Regular shift checkbox row
<span class="nc" id="L2110">		createAndAddOvertimeRow();</span>

		// Add the Comment History row
<span class="nc bnc" id="L2113" title="All 2 branches missed.">		if (!isNew()) {</span>
<span class="nc bnc" id="L2114" title="All 2 branches missed.">			if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L2115">				addLabelValueRow508(m_shiftContainerPC, i18n(m_common_bundle, UIFWebBundleKey.COMMENT_HISTORY), createCommentHistoryPC().toString());</span>
			} else {
<span class="nc" id="L2117">				m_shiftContainerPC.addRow(i18n(m_common_bundle, UIFWebBundleKey.COMMENT_HISTORY), createCommentHistoryPC());</span>
			}
		}

		// Add the Comment row
<span class="nc" id="L2122">		String commentUI = RequestUtil.createCommentUI(COMMENT_FN, getComment(), 100, 3, this, nothingIsEditable(),</span>
<span class="nc" id="L2123">				i18n(m_common_bundle, UIFWebBundleKey.ADD_COMMENT));</span>
<span class="nc" id="L2124">		m_shiftContainerPC.addRow(i18n(m_common_bundle, UIFWebBundleKey.ADD_COMMENT), commentUI);</span>

<span class="nc" id="L2126">		m_containerList.add(m_shiftContainerPC);</span>
<span class="nc" id="L2127">	}</span>

	/**
	 * Initialize the Extension Before list container
	 */
	private void initExtBeforeList() {
<span class="nc" id="L2133">		String firstTitle = i18n(m_bundle, RmWebBundleKey.CSR_EXTENSION_BEFORE_SHIFT);</span>
		// String secondTitle = i18n(m_bundle,
		// RmWebBundleKey.CSR_EXTENSION_AFTER_SHIFT);
<span class="nc" id="L2136">		m_extBeforeContainerPC = new Collapsible2ColFormPC(m_context);</span>
<span class="nc" id="L2137">		m_extBeforeContainerPC.setTitle(firstTitle);</span>
<span class="nc" id="L2138">		m_extBeforeContainerPC.setName(RmWebBundleKey.CSR_EXTENSION_BEFORE_SHIFT);</span>
<span class="nc" id="L2139">		m_extBeforeContainerPC.setCollapsed(getExtBeforeSectionCollapsed());</span>
<span class="nc" id="L2140">		m_extBeforeContainerPC.setTableSummary(i18n(m_bundle, RmWebBundleKey.EXTENSION_BEFORE_SHIFT_TABLE));</span>

		// Before Type selector
<span class="nc" id="L2143">		String typeLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.CSR_TYPE), EXT_BEFORE_ID);</span>
<span class="nc" id="L2144">		m_extBeforeContainerPC.addRow(typeLabel, createExtBeforeTypeDD());</span>

		// Before Activity selector
<span class="nc" id="L2147">		String activityLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.RM_SA_FILTER_ACTIVITY),</span>
				EXT_BEFORE_ACTIVITY_ID);
<span class="nc" id="L2149">		m_extBeforeContainerPC.addRow(activityLabel, createExtBeforeActivityDD());</span>

		// Before Duration string or spinner base on RM Organization Settings
<span class="nc bnc" id="L2152" title="All 2 branches missed.">		int durationBeforeMins = isExtBeforeSetToNone() ? 0 : getOteBeforeDurationInMinutes();</span>
<span class="nc" id="L2153">		m_savedBeforeDuration = durationBeforeMins;</span>
<span class="nc bnc" id="L2154" title="All 2 branches missed.">		if (!denyOTDurationEdit) {</span>
<span class="nc" id="L2155">			durationBeforeDurationPC.setMinutesIncrement(1);</span>
<span class="nc" id="L2156">			durationBeforeDurationPC.setValue(Duration.fromMinutes(durationBeforeMins));</span>
<span class="nc" id="L2157">			durationBeforeDurationPC.setEnabled(this.isExtBeforeEditableAndNotSetToNone());</span>
<span class="nc bnc" id="L2158" title="All 4 branches missed.">			if (m_extBeforeType != null &amp;&amp; m_extBeforeType.getDuration() &gt; 0) {</span>
<span class="nc" id="L2159">				durationBeforeDurationPC.setMinTime(0, 1, 0);</span>
			} else {
<span class="nc" id="L2161">				durationBeforeDurationPC.setMinTime(0, 0, 0);</span>
			}
<span class="nc" id="L2163">			m_extBeforeContainerPC.addRow(m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_DURATION), durationBeforeDurationPC);</span>
		} else {
<span class="nc bnc" id="L2165" title="All 2 branches missed.">			if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L2166">				addLabelValueRow508(m_extBeforeContainerPC, m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_DURATION),</span>
<span class="nc" id="L2167">						getExtBeforeDurationString());</span>
			} else {
<span class="nc" id="L2169">				m_extBeforeContainerPC.addRow(m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_DURATION),</span>
<span class="nc" id="L2170">						getExtBeforeDurationString());</span>
			}
		}

		// Before Gap string or spinner base on RM Organization Settings
<span class="nc" id="L2175">		int gapBeforeMins = getExtBeforeGapDisplayValue();</span>
<span class="nc" id="L2176">		gapBeforeDurationPC.setMinutesIncrement(1);</span>
<span class="nc" id="L2177">		gapBeforeDurationPC.setValue(Duration.fromMinutes(gapBeforeMins));</span>
<span class="nc" id="L2178">		gapBeforeDurationPC.setInputTitle(getGapLabel());</span>
<span class="nc" id="L2179">		gapBeforeDurationPC.setEnabled(isExtBeforeEditableAndNotSetToNone());</span>
<span class="nc bnc" id="L2180" title="All 4 branches missed.">		if (m_allowOTGapEdit &amp;&amp; m_extBeforeType != null) {</span>
<span class="nc" id="L2181">			int minGap = getMinimumGapMinutes(m_extBeforeType);</span>
<span class="nc" id="L2182">			int maxGap = getMaximumGapMinutes(m_extBeforeType);</span>
<span class="nc" id="L2183">			gapBeforeDurationPC.setMinTime(0, minGap, 0);</span>
<span class="nc" id="L2184">			gapBeforeDurationPC.setMaxTime(0, maxGap, 0);</span>
<span class="nc bnc" id="L2185" title="All 2 branches missed.">		} else if (!m_allowOTGapEdit) {</span>
<span class="nc" id="L2186">			gapBeforeDurationPC.setMinTime(0, 0, 0);</span>
<span class="nc" id="L2187">			gapBeforeDurationPC.setMaxTime(0, MAX_GAP_IN_MINUTES, 0);</span>
		}
<span class="nc" id="L2189">		m_extBeforeContainerPC.addRow(getGapLabel(), gapBeforeDurationPC);</span>

		// Before OT Checkbox
<span class="nc" id="L2192">		StringBuffer sb1 = new StringBuffer(100);</span>
<span class="nc bnc" id="L2193" title="All 2 branches missed.">		boolean isDisabled = !isExtBeforeOTEditable();</span>
<span class="nc" id="L2194">		boolean isChecked = isExtBeforeOTChecked();</span>
<span class="nc" id="L2195">		String label = i18n(m_bundle, RmWebBundleKey.ORG_RM_FILING_RULE_OVERTIME);</span>
<span class="nc" id="L2196">		HtmlChoiceInput checkbox1 = new HtmlChoiceInput();</span>
<span class="nc" id="L2197">		sb1.append(</span>
<span class="nc" id="L2198">				getChkBoxInput(checkbox1, EXT_BEFORE_OVERTIME, &quot;true&quot;, label, isChecked, isDisabled, JSUtil.ON_CHANGE));</span>
<span class="nc" id="L2199">		m_extBeforeContainerPC.addRow(label, sb1.toString());</span>

<span class="nc" id="L2201">		m_containerList.add(m_extBeforeContainerPC);</span>
<span class="nc" id="L2202">	}</span>

	/**
	 * Initialize the Extension After list container
	 */
	private void initExtAfterList() {
<span class="nc" id="L2208">		String firstTitle = i18n(m_bundle, RmWebBundleKey.CSR_EXTENSION_AFTER_SHIFT);</span>
<span class="nc" id="L2209">		m_extAfterContainerPC = new Collapsible2ColFormPC(m_context);</span>
<span class="nc" id="L2210">		m_extAfterContainerPC.setTitle(firstTitle);</span>
<span class="nc" id="L2211">		m_extAfterContainerPC.setName(RmWebBundleKey.CSR_EXTENSION_AFTER_SHIFT);</span>
<span class="nc" id="L2212">		m_extAfterContainerPC.setCollapsed(getExtAfterSectionCollapsed());</span>
<span class="nc" id="L2213">		m_extAfterContainerPC.setTableSummary(i18n(m_bundle, RmWebBundleKey.EXTENSION_AFTER_SHIFT_TABLE));</span>

		// After Type selector
<span class="nc" id="L2216">		String typeLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.CSR_TYPE), EXT_AFTER_ID);</span>
<span class="nc" id="L2217">		m_extAfterContainerPC.addRow(typeLabel, createExtAfterTypeDD());</span>

		// After Activity selector
<span class="nc" id="L2220">		String activityLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.RM_SA_FILTER_ACTIVITY),</span>
				EXT_AFTER_ACTIVITY_ID);
<span class="nc" id="L2222">		m_extAfterContainerPC.addRow(activityLabel, createExtAfterActivityDD());</span>

		// After Duration string or spinner base on RM Organization Settings
<span class="nc bnc" id="L2225" title="All 2 branches missed.">		int durationAfterMins = isExtAfterSetToNone() ? 0 : getOteAfterDurationInMinutes();</span>
<span class="nc" id="L2226">		m_savedAfterDuration = durationAfterMins;</span>
<span class="nc bnc" id="L2227" title="All 2 branches missed.">		if (!denyOTDurationEdit) {</span>
<span class="nc" id="L2228">			durationAfterDurationPC.setMinutesIncrement(1);</span>
<span class="nc" id="L2229">			durationAfterDurationPC.setValue(Duration.fromMinutes(durationAfterMins));</span>
<span class="nc" id="L2230">			durationAfterDurationPC.setEnabled(isExtAfterEditableAndNotSetToNone());</span>
<span class="nc bnc" id="L2231" title="All 4 branches missed.">			if (m_extAfterType != null &amp;&amp; m_extAfterType.getDuration() &gt; 0) {</span>
<span class="nc" id="L2232">				durationAfterDurationPC.setMinTime(0, 1, 0);</span>
			} else {
<span class="nc" id="L2234">				durationAfterDurationPC.setMinTime(0, 0, 0);</span>
			}
<span class="nc" id="L2236">			m_extAfterContainerPC.addRow(m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_DURATION), durationAfterDurationPC);</span>
		} else {
<span class="nc bnc" id="L2238" title="All 2 branches missed.">			if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L2239">				addLabelValueRow508(m_extAfterContainerPC, m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_DURATION), getExtAfterDurationString());</span>
			} else {
<span class="nc" id="L2241">				m_extAfterContainerPC.addRow(m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_DURATION), getExtAfterDurationString());</span>
			}
		}

		// After Gap spinner
<span class="nc" id="L2246">		int gapAfterMins = getExtAfterGapDisplayValue();</span>
<span class="nc" id="L2247">		gapAfterDurationPC.setMinutesIncrement(1);</span>
<span class="nc" id="L2248">		gapAfterDurationPC.setValue(Duration.fromMinutes(gapAfterMins));</span>
<span class="nc" id="L2249">		gapAfterDurationPC.setInputTitle(getGapLabel());</span>
<span class="nc" id="L2250">		gapAfterDurationPC.setEnabled(isExtAfterEditableAndNotSetToNone());</span>
<span class="nc bnc" id="L2251" title="All 4 branches missed.">		if (m_allowOTGapEdit &amp;&amp; m_extAfterType != null) {</span>
<span class="nc" id="L2252">			int minGap = getMinimumGapMinutes(m_extAfterType);</span>
<span class="nc" id="L2253">			int maxGap = getMaximumGapMinutes(m_extAfterType);</span>
<span class="nc" id="L2254">			gapAfterDurationPC.setMinTime(0, minGap, 0);</span>
<span class="nc" id="L2255">			gapAfterDurationPC.setMaxTime(0, maxGap, 0);</span>
<span class="nc bnc" id="L2256" title="All 2 branches missed.">		} else if (!m_allowOTGapEdit) {</span>
<span class="nc" id="L2257">			gapAfterDurationPC.setMinTime(0, 0, 0);</span>
<span class="nc" id="L2258">			gapAfterDurationPC.setMaxTime(0, MAX_GAP_IN_MINUTES, 0);</span>
		}
<span class="nc" id="L2260">		m_extAfterContainerPC.addRow(getGapLabel(), gapAfterDurationPC);</span>

		// After OT Checkbox
<span class="nc" id="L2263">		StringBuffer sb1 = new StringBuffer(100);</span>
<span class="nc bnc" id="L2264" title="All 2 branches missed.">		boolean isDisabled = !isExtAfterOTEditable();</span>
<span class="nc" id="L2265">		boolean isChecked = isExtAfterOTChecked();</span>
<span class="nc" id="L2266">		HtmlChoiceInput checkbox1 = new HtmlChoiceInput();</span>
<span class="nc" id="L2267">		String labelLocalized = i18n(m_bundle, RmWebBundleKey.ORG_RM_FILING_RULE_OVERTIME);</span>
<span class="nc" id="L2268">		sb1.append(getChkBoxInput(checkbox1, EXT_AFTER_OVERTIME, &quot;true&quot;, labelLocalized, isChecked, isDisabled,</span>
				JSUtil.ON_CHANGE));
<span class="nc" id="L2270">		m_extAfterContainerPC.addRow(labelLocalized, sb1.toString());</span>

<span class="nc" id="L2272">		m_containerList.add(m_extAfterContainerPC);</span>
<span class="nc" id="L2273">	}</span>

	private String getGapLabel() {
<span class="nc" id="L2276">		return m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_GAP);</span>
	}

	private int getExtBeforeGapDisplayValue() {
<span class="nc" id="L2280">		return getExtGapDisplayValue(m_customShiftRequest.getExtBeforeID(), m_customShiftRequest.getExtBeforeGap());</span>
	}

	private int getExtAfterGapDisplayValue() {
<span class="nc" id="L2284">		return getExtGapDisplayValue(m_customShiftRequest.getExtAfterID(), m_customShiftRequest.getExtAfterGap());</span>
	}

	private static int getExtGapDisplayValue(ID id, int gap) {
		// Custom Extensions will have a null Ext*ID. Make sure non-zero gaps are displayed.
<span class="nc bnc" id="L2289" title="All 2 branches missed.">		if (NONE_ID.equals(id)) {</span>
			// when the type is set back to None, set the gap back to 0.
<span class="nc" id="L2291">			return 0;</span>
		}
<span class="nc" id="L2293">		return gap;</span>
	}

	/**
	 * Initialize the Extension After list container
	 */
	private void initDuringGapList() {
<span class="nc bnc" id="L2300" title="All 2 branches missed.">		if (!LicenseUtil.isAdvancedRMLicense()) {</span>
<span class="nc" id="L2301">			addJSVariableAsString(&quot;saHasDuringGap&quot;, &quot;false&quot;);</span>
<span class="nc" id="L2302">			addJSVariableAsString(&quot;isExtDuringGapEnablable&quot;, &quot;false&quot;);</span>
<span class="nc" id="L2303">			return;</span>
		}

<span class="nc" id="L2306">		String firstTitle = i18n(m_bundle, RmWebBundleKey.CSR_EXTENSION_DURING_GAP);</span>
<span class="nc" id="L2307">		m_duringGapContainerPC = new Collapsible2ColFormPC(m_context);</span>
<span class="nc" id="L2308">		m_duringGapContainerPC.setTitle(firstTitle);</span>
<span class="nc" id="L2309">		m_duringGapContainerPC.setName(RmWebBundleKey.CSR_EXTENSION_DURING_GAP);</span>
<span class="nc" id="L2310">		m_duringGapContainerPC.setCollapsed(getExtDuringGapSectionCollapsed());</span>
<span class="nc" id="L2311">		m_duringGapContainerPC.setTableSummary(i18n(m_bundle, RmWebBundleKey.EXTENSION_DURING_GAP_TABLE));</span>

		// Gap selector
<span class="nc" id="L2314">		String gapLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.CSR_GAP), DURING_GAP_GAP_ID);</span>
<span class="nc" id="L2315">		m_duringGapContainerPC.addRow(gapLabel, createDuringGapGapDD());</span>

		// Type selector
<span class="nc" id="L2318">		String typeLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.CSR_TYPE), DURING_GAP_TYPE_ID);</span>
<span class="nc" id="L2319">		m_duringGapContainerPC.addRow(typeLabel, createDuringGapTypeDD());</span>

		// Activity selector
<span class="nc" id="L2322">		String activityLabel = HtmlUtil.createLabel(i18n(m_bundle, RmWebBundleKey.RM_SA_FILTER_ACTIVITY),</span>
				DURING_GAP_ACTIVITY_ID);
<span class="nc" id="L2324">		m_duringGapContainerPC.addRow(activityLabel, createDuringGapActivityDD());</span>

		// Duration string or spinner base on RM Organization Settings
<span class="nc bnc" id="L2327" title="All 2 branches missed.">		int durationGapMins = !isDuringGapTypeEditableAndNotSetToNone() ? 0 : getOteDuringGapDurationInMinutes();</span>
<span class="nc" id="L2328">		m_savedDuringGapDuration = durationGapMins;</span>
<span class="nc bnc" id="L2329" title="All 2 branches missed.">		if (!denyOTDurationEdit) {</span>
<span class="nc" id="L2330">			durationDuringGapPC.setMinutesIncrement(1);</span>
<span class="nc" id="L2331">			durationDuringGapPC.setValue(Duration.fromMinutes(durationGapMins));</span>
<span class="nc" id="L2332">			durationDuringGapPC.setEnabled(isDuringGapTypeEditableAndNotSetToNone());</span>
<span class="nc bnc" id="L2333" title="All 4 branches missed.">			if (duringGapType != null &amp;&amp; duringGapType.getDuration() &gt; 0) {</span>
<span class="nc" id="L2334">				durationDuringGapPC.setMinTime(0, 1, 0);</span>
			} else {
<span class="nc" id="L2336">				durationDuringGapPC.setMinTime(0, 0, 0);</span>
			}
<span class="nc" id="L2338">			m_duringGapContainerPC.addRow(HtmlUtil.createLabel(m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_DURATION),DURING_GAP_DURATION), durationDuringGapPC);</span>
		} else {
<span class="nc" id="L2340">			m_duringGapContainerPC.addRow(HtmlUtil.createLabel(m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_DURATION),DURING_GAP_DURATION), getDuringGapDurationString());</span>
		}

		// Gap Gap spinner
<span class="nc bnc" id="L2344" title="All 2 branches missed.">		int duringGapMins = !isDuringGapTypeEditableAndNotSetToNone() ? 0 : getDuringGapGap();</span>
<span class="nc" id="L2345">		gapDuringGapPC.setMinutesIncrement(1);</span>
<span class="nc" id="L2346">		gapDuringGapPC.setValue(Duration.fromMinutes(duringGapMins));</span>
<span class="nc" id="L2347">		gapDuringGapPC.setEnabled(isDuringGapTypeEditableAndNotSetToNone());</span>
<span class="nc bnc" id="L2348" title="All 4 branches missed.">		if (m_allowOTGapEdit &amp;&amp; duringGapType != null) {</span>
<span class="nc" id="L2349">			int minGap = getMinimumGapMinutes(duringGapType);</span>
<span class="nc" id="L2350">			int maxGap = getMaximumGapMinutes(duringGapType);</span>
<span class="nc" id="L2351">			gapDuringGapPC.setMinTime(0, minGap, 0);</span>
<span class="nc" id="L2352">			gapDuringGapPC.setMaxTime(0, maxGap, 0);</span>
<span class="nc bnc" id="L2353" title="All 2 branches missed.">		} else if (!m_allowOTGapEdit) {</span>
<span class="nc" id="L2354">			gapDuringGapPC.setMinTime(0, 0, 0);</span>
<span class="nc" id="L2355">			gapDuringGapPC.setMaxTime(0, MAX_GAP_IN_MINUTES, 0);</span>
		}
<span class="nc" id="L2357">		m_duringGapContainerPC.addRow(HtmlUtil.createLabel(m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_EXTENSION_GAP),DURING_GAP_GAP), gapDuringGapPC);</span>

<span class="nc" id="L2359">		m_containerList.add(m_duringGapContainerPC);</span>
<span class="nc" id="L2360">	}</span>

	protected int getMinimumGapMinutes(ShiftOTExtension ote) {
<span class="nc bnc" id="L2363" title="All 2 branches missed.">		if (ote == null) {</span>
<span class="nc" id="L2364">			return 0;</span>
		}
<span class="nc" id="L2366">		int minGap = ote.getMinGap();</span>
<span class="nc bnc" id="L2367" title="All 2 branches missed.">		return minGap &gt; MAX_GAP_IN_MINUTES ? MAX_GAP_IN_MINUTES : minGap;</span>
	}

	protected int getMaximumGapMinutes(ShiftOTExtension ote) {
<span class="nc bnc" id="L2371" title="All 2 branches missed.">		if (ote == null) {</span>
<span class="nc" id="L2372">			return MAX_GAP_IN_MINUTES;</span>
		}
<span class="nc" id="L2374">		int maxGap = ote.getMaxGap();</span>
<span class="nc bnc" id="L2375" title="All 2 branches missed.">		return maxGap &gt; MAX_GAP_IN_MINUTES ? MAX_GAP_IN_MINUTES : maxGap;</span>
	}

	int getGapBeforeInMinutes() {
<span class="nc" id="L2379">		ensureGapDurationCalculator();</span>
<span class="nc" id="L2380">		return gapDurationCalculator.getGapBeforeInMinutes(m_customShiftRequest.getExtBeforeGap());</span>
	}

	int getGapAfterInMinutes() {
<span class="nc" id="L2384">		ensureGapDurationCalculator();</span>
<span class="nc" id="L2385">		return gapDurationCalculator.getGapAfterInMinutes(m_customShiftRequest.getExtAfterGap());</span>
	}

	int getOteAfterDurationInMinutes() {
<span class="nc" id="L2389">		ensureGapDurationCalculator();</span>
<span class="nc" id="L2390">		return gapDurationCalculator.getDurationAfterInMinutes(m_customShiftRequest.getExtAfterDuration());</span>
	}

	int getOteBeforeDurationInMinutes() {
<span class="nc" id="L2394">		ensureGapDurationCalculator();</span>
<span class="nc" id="L2395">		return gapDurationCalculator.getDurationBeforeInMinutes(m_customShiftRequest.getExtBeforeDuration());</span>
	}

	int getOteDuringGapDurationInMinutes() {
<span class="nc" id="L2399">		ensureGapDurationCalculator();</span>
		// TODO - update calculator
		// return gapDurationCalculator.getDurationAfterInMinutes(getDuringGapDuration());
<span class="nc" id="L2402">		return getDuringGapDuration();</span>
	}

	private void ensureGapDurationCalculator() {
<span class="nc bnc" id="L2406" title="All 2 branches missed.">		if (gapDurationCalculator == null) {</span>
<span class="nc" id="L2407">			gapDurationCalculator = GapAndDurationCalculator.fromShiftRequest(m_customShiftRequest,</span>
					this.m_ribbonStartDate,
					this.m_ribbonEndDate);

			// If this is not an initial load from the ribbon we do not calculate the gaps and duration from the ribbon
			// we just use the values that were in the spinner controls.
<span class="nc bnc" id="L2413" title="All 2 branches missed.">			boolean forceDefaults = !isInitialLoadFromRibbon();</span>
<span class="nc" id="L2414">			boolean beforeEditable = isExtBeforeEditableAndNotSetToNone();</span>
<span class="nc" id="L2415">			boolean afterEditable = isExtAfterEditableAndNotSetToNone();</span>
<span class="nc bnc" id="L2416" title="All 2 branches missed.">			boolean allowDurationEdit = !denyOTDurationEdit;</span>
<span class="nc" id="L2417">			gapDurationCalculator.setDefaultHandling(forceDefaults);</span>
<span class="nc bnc" id="L2418" title="All 8 branches missed.">			gapDurationCalculator.setAllowDurationEdit(beforeEditable &amp;&amp; allowDurationEdit, afterEditable &amp;&amp; allowDurationEdit);</span>
<span class="nc bnc" id="L2419" title="All 8 branches missed.">			gapDurationCalculator.setLimitGapEnable(beforeEditable &amp;&amp; this.m_allowOTGapEdit, afterEditable &amp;&amp; this.m_allowOTGapEdit);</span>
<span class="nc" id="L2420">			gapDurationCalculator.setMinMaxGapBefore(getMinimumGapMinutes(m_extBeforeType), getMaximumGapMinutes(m_extBeforeType));</span>
<span class="nc" id="L2421">			gapDurationCalculator.setMinMaxGapAfter(getMinimumGapMinutes(m_extAfterType), getMaximumGapMinutes(m_extAfterType));</span>

		}
<span class="nc" id="L2424">	}</span>

	private boolean isInitialLoadFromRibbon() {
<span class="nc" id="L2427">		return m_reloadAction.equals(RELOAD_ACTION_RIBBON);</span>
	}

	private String getOnChangeWRefreshAttrVal(String actionReload) {
<span class="nc" id="L2431">		return reloadWithAction(actionReload) + &quot; &quot; + ONCHANGE_PAGE_REFRESH;</span>
	}

	/**
	 * Return the ext before duration string, wrapped in a span, such as
	 * &quot;&lt;span id='extBeforeDuration'&gt;8:30&lt;/span&gt;&quot;.
	 * If the drawn duration does not match with the defined extension rule, there is an warning icon next to duration
	 */
	private String getExtBeforeDurationString() {
<span class="nc" id="L2440">		String hhmm = CustomShiftUtil.getExtBeforeDurationString(m_customShiftRequest, m_localizer);</span>
<span class="nc" id="L2441">		String durationDisplay = &quot;&lt;span id='&quot; + EXT_BEFORE_DURATION + &quot;'&gt;&quot; + hhmm + &quot;&lt;/span&gt;&quot;;</span>
<span class="nc bnc" id="L2442" title="All 2 branches missed.">		if (highlightBeforeDuration) {</span>
<span class="nc" id="L2443">			String imgSrc = ImageFileID.ALERT_YELLOW;</span>
<span class="nc" id="L2444">			String imgAlt= m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_WARNING_ADDED_EXTENSION_DETAIL,new Object[] { strDesiredDuration, strShiftDuration} );</span>
<span class="nc" id="L2445">			durationDisplay=&quot;&lt;span id='&quot; + EXT_BEFORE_DURATION + &quot;' style=\&quot;color:orange\&quot;&gt;&quot; + hhmm + &quot;&lt;/span&gt;&lt;span class=\&quot;itemAlert\&quot;&gt;&quot; + HtmlUtil.imageTag(imgSrc, imgAlt) + &quot;&lt;/span&gt;&quot;;</span>
<span class="nc" id="L2446">			highlightBeforeDuration= false;</span>
		}
<span class="nc" id="L2448">		return durationDisplay;</span>
	}

	/**
	 * Return the ext after duration string, wrapped in a span, such as
	 * &quot;&lt;span id='extAfterDuration'&gt;8:30&lt;/span&gt;&quot;.
	 * If the drawn duration does not match with the defined extension rule, there is an warning icon next to duration
	 */
	private String getExtAfterDurationString() {
<span class="nc" id="L2457">		String hhmm = CustomShiftUtil.getExtAfterDurationString(m_customShiftRequest, m_localizer);</span>
<span class="nc" id="L2458">		String durationDisplay = &quot;&lt;span id='&quot; + EXT_AFTER_DURATION + &quot;'&gt;&quot; + hhmm + &quot;&lt;/span&gt;&quot;;</span>
<span class="nc bnc" id="L2459" title="All 2 branches missed.">		if (highlightAfterDuration) {</span>
<span class="nc" id="L2460">			String imgSrc = ImageFileID.ALERT_YELLOW;</span>
<span class="nc" id="L2461">			String imgAlt= m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_WARNING_ADDED_EXTENSION_DETAIL,new Object[] { strDesiredDuration, strShiftDuration} );</span>
<span class="nc" id="L2462">			durationDisplay=&quot;&lt;span id='&quot; + EXT_AFTER_DURATION + &quot;' style=\&quot;color:orange\&quot;&gt;&quot; + hhmm + &quot;&lt;/span&gt;&lt;span class=\&quot;itemAlert\&quot;&gt;&quot; + HtmlUtil.imageTag(imgSrc, imgAlt) + &quot;&lt;/span&gt;&quot;;</span>
<span class="nc" id="L2463">			highlightAfterDuration= false;</span>
		}
<span class="nc" id="L2465">		return durationDisplay;</span>

	}

	private String getDuringGapDurationString() {
<span class="nc" id="L2470">		String hhmm = &quot;&quot;;</span>
<span class="nc" id="L2471">		hhmm = m_localizer.formatDurationInMins(getDuringGapDuration());</span>
<span class="nc" id="L2472">		return &quot;&lt;span id='&quot; + DURING_GAP_DURATION + &quot;'&gt;&quot; + hhmm + &quot;&lt;/span&gt;&quot;;</span>
	}

	/**
	 * Return true if User is authorized to waitlist a Request.
	 */
	protected boolean isAuthToWaitlist() {
<span class="nc" id="L2479">		return m_context.getUser().isAuthorized(PrivilegeKeys.TOM_ADDREQUESTTOWAITLIST_ID);</span>
	}

	private String getChkBoxInput(HtmlChoiceInput checkbox, String name, String value, String label, boolean isChecked,
			boolean isDisabled, String onClickJS) {
<span class="nc" id="L2484">		checkbox.reset();</span>
<span class="nc" id="L2485">		checkbox.setIsValueSubmittedWhenDisabled(true);</span>
<span class="nc" id="L2486">		checkbox.setIsMultiSelect(true);</span>
<span class="nc" id="L2487">		checkbox.setInputName(name);</span>
<span class="nc" id="L2488">		checkbox.setValue(value);</span>
<span class="nc" id="L2489">		checkbox.setLabel(label);</span>
<span class="nc" id="L2490">		checkbox.setIsChecked(isChecked);</span>
<span class="nc" id="L2491">		checkbox.setIsDisabled(isDisabled);</span>
<span class="nc" id="L2492">		checkbox.setOnClickJS(onClickJS);</span>
<span class="nc" id="L2493">		checkbox.setIsHiddenLabel(true);</span>
<span class="nc" id="L2494">		return checkbox.getHtmlDisplay();</span>
	}

	/**
	 * Create the OT checkbox row.
	 *
	 * @return The HTML for the OT checkbox row.
	 */
	private void createAndAddOvertimeRow() {
<span class="nc" id="L2503">		String checkboxLabel = i18n(m_bundle, RmWebBundleKey.ORG_RM_ENTIRE_SHIFT_OVERTIME);</span>
<span class="nc" id="L2504">		StringBuffer sb = new StringBuffer(100);</span>
<span class="nc" id="L2505">		HtmlChoiceInput checkbox = new HtmlChoiceInput();</span>
<span class="nc bnc" id="L2506" title="All 2 branches missed.">		sb.append(getChkBoxInput(checkbox, OVERTIME, &quot;true&quot;, checkboxLabel, isOvertimeChecked(), !isOvertimeEditable(),</span>
				JS_FUNC_TOGGLE_SHIFT_OT));
<span class="nc" id="L2508">		m_shiftContainerPC.addRow(checkboxLabel, sb.toString());</span>
<span class="nc" id="L2509">	}</span>

	/**
	 * Returns true if the main shift's Overtime checkbox should be editable or
	 * not.
	 */
	protected boolean isOvertimeEditable() {
<span class="nc bnc" id="L2516" title="All 4 branches missed.">		boolean isEditable = isNewShiftRequest() &amp;&amp; isShiftEditable();</span>

<span class="nc bnc" id="L2518" title="All 2 branches missed.">		if (isNewShiftRequest()) {</span>
<span class="nc bnc" id="L2519" title="All 4 branches missed.">			if (!m_allowRegularShifts || !m_allowOTShifts) {</span>
<span class="nc" id="L2520">				isEditable = false;</span>
			}
		}

<span class="nc" id="L2524">		return isEditable;</span>
	}

	/**
	 * Returns true if the main shift's Overtime checkbox should be checked or
	 * not.
	 */
	protected boolean isOvertimeChecked() {
<span class="nc" id="L2532">		boolean isChecked = m_customShiftRequest.isOT();</span>

		// Check org setting allowances. we only care about new shifts because
		// shift changes do not allow editing of OT, so we leave those as they
		// are.
<span class="nc bnc" id="L2537" title="All 2 branches missed.">		if (isNewShiftRequest()) {</span>
<span class="nc bnc" id="L2538" title="All 4 branches missed.">			if (!m_allowOTShifts || !m_allowNewShifts) {</span>
				// only non-OT shifts are allowed for new shifts
<span class="nc" id="L2540">				isChecked = false;</span>
<span class="nc bnc" id="L2541" title="All 2 branches missed.">			} else if (!m_allowRegularShifts) {</span>
				// only OT shifts are allowed for new shifts
<span class="nc" id="L2543">				isChecked = true;</span>
			}
		}

<span class="nc" id="L2547">		m_customShiftRequest.setIsOT(isChecked); // Should we move this code</span>
		// somewhere outside of this UI
		// component code?
<span class="nc" id="L2550">		return isChecked;</span>
	}

	private boolean isExtBeforeOTEditable() {
<span class="nc bnc" id="L2554" title="All 4 branches missed.">		boolean isEnabled = isExtBeforeEditableAndNotSetToNone() &amp;&amp; !getOvertime();</span>

<span class="nc bnc" id="L2556" title="All 4 branches missed.">		if (m_allowOTExtBeforeShifts &amp;&amp; !m_allowRegularExtBeforeShifts) {</span>
			// we must disable and check it if we only allowOTExtBeforeShifts
<span class="nc" id="L2558">			isEnabled = false;</span>
<span class="nc bnc" id="L2559" title="All 4 branches missed.">		} else if (!m_allowOTExtBeforeShifts &amp;&amp; m_allowRegularExtBeforeShifts) {</span>
			// we must disable and uncheck it if we only
			// allowRegularExtBeforeShifts
<span class="nc" id="L2562">			isEnabled = false;</span>
		}

<span class="nc" id="L2565">		return isEnabled;</span>
	}

	private boolean isExtBeforeOTChecked() {
<span class="nc bnc" id="L2569" title="All 4 branches missed.">		if (isShiftChangeRequest() &amp;&amp; CustomShiftUtil.saHasExtBefore(m_shiftAssignment)) {</span>
<span class="nc" id="L2570">			return m_customShiftRequest.getExtBeforeIsOT();</span>
		}

<span class="nc bnc" id="L2573" title="All 6 branches missed.">		boolean isChecked = !isExtBeforeSetToNone() &amp;&amp; (m_customShiftRequest.getExtBeforeIsOT() || getOvertime());</span>

<span class="nc bnc" id="L2575" title="All 4 branches missed.">		if (m_allowOTExtBeforeShifts &amp;&amp; !m_allowRegularExtBeforeShifts) {</span>
			// we must disable and check it if we only allowOTExtBeforeShifts
<span class="nc" id="L2577">			isChecked = true;</span>
<span class="nc bnc" id="L2578" title="All 4 branches missed.">		} else if (!m_allowOTExtBeforeShifts &amp;&amp; m_allowRegularExtBeforeShifts) {</span>
			// we must disable and uncheck it if we only
			// allowRegularExtBeforeShifts
<span class="nc" id="L2581">			isChecked = false; // What happens if this is inconsistent with</span>
			// m_customShiftRequest.getExtBeforeIsOT() ||
			// getOvertime() ?
		}

<span class="nc" id="L2586">		m_customShiftRequest.setExtBeforeIsOT(isChecked); // Should we move this</span>
		// code somewhere
		// outside of this UI
		// component code?

<span class="nc" id="L2591">		return isChecked;</span>
	}

	private boolean isExtAfterOTChecked() {
<span class="nc bnc" id="L2595" title="All 4 branches missed.">		if (isShiftChangeRequest() &amp;&amp; CustomShiftUtil.saHasExtAfter(m_shiftAssignment)) {</span>
<span class="nc" id="L2596">			return m_customShiftRequest.getExtAfterIsOT();</span>
		}

<span class="nc bnc" id="L2599" title="All 6 branches missed.">		boolean isChecked = !isExtAfterSetToNone() &amp;&amp; (m_customShiftRequest.getExtAfterIsOT() || getOvertime());</span>

<span class="nc bnc" id="L2601" title="All 4 branches missed.">		if (m_allowOTExtAfterShifts &amp;&amp; !m_allowRegularExtAfterShifts) {</span>
			// we must disable and check it if we only allowOTExtAfterShifts
<span class="nc" id="L2603">			isChecked = true;</span>
<span class="nc bnc" id="L2604" title="All 4 branches missed.">		} else if (!m_allowOTExtAfterShifts &amp;&amp; m_allowRegularExtAfterShifts) {</span>
			// we must disable and uncheck it if we only
			// allowRegularExtAfterShifts
<span class="nc" id="L2607">			isChecked = false; // What happens if this is inconsistent with</span>
			// m_customShiftRequest.getExtAfterIsOT() ||
			// getOvertime() ?
		}

<span class="nc" id="L2612">		m_customShiftRequest.setExtAfterIsOT(isChecked); // Should we move this</span>
		// code somewhere
		// outside of this UI
		// component code?

<span class="nc" id="L2617">		return isChecked;</span>
	}

	private boolean isExtAfterOTEditable() {
<span class="nc bnc" id="L2621" title="All 4 branches missed.">		boolean isEnabled = isExtAfterEditableAndNotSetToNone() &amp;&amp; !getOvertime();</span>

		// we must disable and check it if we only allowOTExtAfterShifts
<span class="nc bnc" id="L2624" title="All 4 branches missed.">		if (m_allowOTExtAfterShifts &amp;&amp; !m_allowRegularExtAfterShifts) {</span>
<span class="nc" id="L2625">			isEnabled = false;</span>
		}

		// we must disable and uncheck it if we only allowRegularExtAfterShifts
<span class="nc bnc" id="L2629" title="All 4 branches missed.">		if (!m_allowOTExtAfterShifts &amp;&amp; m_allowRegularExtAfterShifts) {</span>
<span class="nc" id="L2630">			isEnabled = false;</span>
		}

<span class="nc" id="L2633">		return isEnabled;</span>
	}

	/**
	 * Create the date picker row.
	 *
	 * @return The HTML for the start date row.
	 */
	private void createAndAddDatePickerRow() {
<span class="nc" id="L2642">		String label = i18n(m_bundle, RmWebBundleKey.CSR_START_DATE);</span>

		String description;
<span class="nc bnc" id="L2645" title="All 2 branches missed.">		if (nothingIsEditable()) {</span>
<span class="nc" id="L2646">			description = m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_SELECT_A_DIFFERENT_DATE);</span>
		} else {
<span class="nc bnc" id="L2648" title="All 2 branches missed.">			description = (m_shiftAssignment == null) ? m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_REQUEST_NEW_SHIFT)</span>
<span class="nc bnc" id="L2649" title="All 2 branches missed.">					: (isManagerMode() ? m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_REQUEST_SHIFT_CHANGE)</span>
<span class="nc" id="L2650">							: m_localizer.i18n(m_bundle, RmWebBundleKey.CSR_REQUEST_SHIFT_CHANGE_FOR_AGENT));</span>
		}

<span class="nc" id="L2653">		String inputTitle = m_datePickerPC.getInputTitle();</span>
<span class="nc bnc" id="L2654" title="All 2 branches missed.">		if (StringUtil.isEmpty(inputTitle)) {</span>
<span class="nc" id="L2655">			m_datePickerPC.setInputTitle(label);</span>
		}
<span class="nc bnc" id="L2657" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L2658">			String dateFormat = m_datePickerPC.getDateFormat().toPattern();</span>
<span class="nc" id="L2659">			String fullDescription = m_localizer.i18n(BbmWebBundleKey.BUNDLE_NAME, BbmWebBundleKey.DATE_RANGE_NEW_DATE_CAUTION_MESSAGE,</span>
					dateFormat) + &quot; &quot; + description;
<span class="nc" id="L2661">			m_datePickerPC.setDateRangeAriaDescription(fullDescription, DATE_PICKER_HIDDEN_SPAN_ID);</span>
<span class="nc" id="L2662">			addRequiredJavaScriptFile(JavaScriptFileID.MODULE_TREE_TABLE);</span>
<span class="nc" id="L2663">			addRequiredJavaScriptFile(JavaScriptFileID.MODULE_TREE_BASE);</span>
		}

<span class="nc bnc" id="L2666" title="All 2 branches missed.">		if (getRequestID() != null) {</span>
			// Do not allow to change date for editing existing request.
<span class="nc" id="L2668">			disableDatePickerPC();</span>
		}
<span class="nc" id="L2670">		m_shiftContainerPC.addRow(label, m_datePickerPC + &quot; &amp;nbsp; &quot; + description);</span>
<span class="nc" id="L2671">	}</span>

	/**
	 * Create the time picker row.
	 *
	 * @return The HTML for the start time row.
	 */
	private void createAndAddTimePickerRow() {
<span class="nc bnc" id="L2679" title="All 2 branches missed.">		if (!isShiftEditable()) {</span>
<span class="nc" id="L2680">			disableTimePickerPC();</span>
		}

<span class="nc" id="L2683">		String label = i18n(m_bundle, RmWebBundleKey.CSR_START_TIME);</span>
<span class="nc bnc" id="L2684" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L2685">			String onChangeValue = m_timePickerPC.getOnChangeJS();</span>
<span class="nc" id="L2686">			m_timePickerPC.setOnChangeJS(onChangeValue + &quot; &quot; + ONCHANGE_PAGE_REFRESH);</span>
		}
<span class="nc" id="L2688">		m_shiftContainerPC.addRow(label, m_timePickerPC);</span>
<span class="nc" id="L2689">	}</span>

	/**
	 * Return List of Containers NOTE: Items in the Collection will be treated
	 * either as Page Components or just a basic Object.
	 */
	@Override
	public Collection getContainers() {
<span class="nc" id="L2697">		return m_containerList;</span>
	}

	/**
	 * Create the collapsible Alert List PC. Overrides parent class.
	 */
	@Override
	protected MultiColCollapsibleContainerPC createAlertsList() {
<span class="nc" id="L2705">		MultiColCollapsibleContainerPC listPC = super.createAlertsList();</span>
<span class="nc" id="L2706">		listPC.getMultiColListPC().setRowSelectable(false);</span>
<span class="nc" id="L2707">		listPC.setCollapsed(getAlertsSectionCollapsed());</span>
<span class="nc" id="L2708">		m_containerList.add(listPC);</span>
<span class="nc" id="L2709">		return listPC;</span>
	}

	@Override
	protected boolean isSaveButtonEnabled() {
<span class="nc" id="L2714">		return RequestUtil.isRequestFormSaveBtnEnabled(m_request);</span>
	}

	/**
	 * Validate Data to be valid
	 */
	@Override
	public boolean validate() {
<span class="nc" id="L2722">		boolean success = super.validate();</span>
<span class="nc bnc" id="L2723" title="All 4 branches missed.">		if (getCustShiftReqGap() != null &amp;&amp; getCustShiftReqGap().getExtGapStartTime() != null) {</span>
<span class="nc" id="L2724">			CustShiftReqGap g = getCustShiftReqGap();</span>
<span class="nc" id="L2725">			int gapDuration = (int) ((g.getExtGapEndTime().getTime() - g.getExtGapStartTime().getTime()) / 60000);</span>
<span class="nc bnc" id="L2726" title="All 2 branches missed.">			if ((g.getExtGapDuration() + g.getExtGapGap()) &gt; gapDuration) {</span>
<span class="nc" id="L2727">				addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.CSR_EXT_GREATER_THAN_GAP, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L2728">				success = false;</span>
			}
<span class="nc bnc" id="L2730" title="All 2 branches missed.">			if (g.getExtGapActivityID() == null) {</span>
<span class="nc" id="L2731">				addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.CSR_EXT_GAP_MUST_DEF_ACTIVITY, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L2732">				success = false;</span>
			}
<span class="nc bnc" id="L2734" title="All 2 branches missed.">			if (g.getShiftOTGapID() == null) {</span>
<span class="nc" id="L2735">				addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.CSR_EXT_GAP_MUST_DEF_OT, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L2736">				success = false;</span>
			}
<span class="nc bnc" id="L2738" title="All 2 branches missed.">			if (g.getExtGapDuration() == 0) {</span>
<span class="nc" id="L2739">				addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.CSR_EXT_GAP_MUST_DEF_DURATION, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L2740">				success = false;</span>
			}
		}
<span class="nc" id="L2743">		return success;</span>
	}

	/**
	 * Specify Employee which Request is for
	 */
	public void setRequestedFor(ID empID) {
<span class="nc" id="L2750">		m_customShiftRequest.setEmployeeID(empID);</span>
<span class="nc" id="L2751">	}</span>

	/**
	 * Return Employee which Request is for
	 */
	public ID getRequestedFor() {
<span class="nc" id="L2757">		ID id = m_customShiftRequest.getEmployeeID();</span>

<span class="nc bnc" id="L2759" title="All 4 branches missed.">		if (!isManagerMode() &amp;&amp; id == null) {</span>
<span class="nc" id="L2760">			id = m_context.getUser().getEmployeeID();</span>
		}

<span class="nc" id="L2763">		return id;</span>
	}

	/**
	 * Specify Employee which Request was originally for, used when coming from
	 * the net staffing ribbon.
	 */
	public void setOrigRequestedFor(ID empID) {
<span class="nc" id="L2771">		m_origReuestedFor = empID;</span>
<span class="nc" id="L2772">	}</span>

	/**
	 * Return Employee which Request was originally for, used when coming from
	 * the net staffing ribbon.
	 */
	public ID getOrigRequestedFor() {
<span class="nc bnc" id="L2779" title="All 2 branches missed.">		return m_origReuestedFor == null ? getRequestedFor() : m_origReuestedFor;</span>
	}

	/**
	 * Set the Custom Shift Request to be used
	 */
	public void setCustomShiftRequest(CustShiftReq request) {
<span class="nc" id="L2786">		m_customShiftRequest = request;</span>
<span class="nc" id="L2787">		m_request = request;</span>
<span class="nc" id="L2788">	}</span>

	/**
	 * Return the Custom Shift Request
	 */
	public CustShiftReq getCustShiftRequest() {
<span class="nc" id="L2794">		return m_customShiftRequest;</span>
	}

	/**
	 * Set Main Shift ID
	 */
	public void setShiftID(ID id) {
<span class="nc" id="L2801">		m_customShiftRequest.setShiftID(id);</span>
<span class="nc" id="L2802">	}</span>

	/**
	 * Return Main Shift ID
	 */
	public ID getShiftID() {
<span class="nc" id="L2808">		return m_customShiftRequest.getShiftID();</span>
	}

	/**
	 * Set Main Activity ID
	 */
	public void setActivityID(String type) {
<span class="nc" id="L2815">		m_customShiftRequest.setActivityID(new ID(type));</span>
<span class="nc" id="L2816">	}</span>

	/**
	 * Return Main Activity ID
	 */
	public ID getActivityID() {
<span class="nc" id="L2822">		return m_customShiftRequest.getActivityID();</span>
	}

	/**
	 * Set Request Status
	 */
	public void setRequestStatus(String status) {
<span class="nc" id="L2829">		m_customShiftRequest.setRequestStatus(status);</span>
<span class="nc" id="L2830">	}</span>

	/**
	 * Return Request Status
	 */
	public String getRequestStatus() {
<span class="nc" id="L2836">		return m_customShiftRequest.getRequestStatus();</span>
	}

	/**
	 * Set Reload Action
	 */
	public void setReloadAction(String action) {
<span class="nc" id="L2843">		m_reloadAction = action;</span>
<span class="nc" id="L2844">	}</span>

	/**
	 * Get Reload Action
	 */
	public String getReloadAction() {
<span class="nc" id="L2850">		return m_reloadAction;</span>
	}

	/**
	 * Determine the Request Sub Type. - Regular New Shift: Request for a new
	 * (non-OT) shift. It may have Regular extensions only. - Regular Shift
	 * Change: Request for an extension before or after the shift or change in
	 * shift. No OT Shift/Extensions allowed. - Overtime New Shift: Request for
	 * a new OT shift (any extensions will be OT) - Overtime Shift Change:
	 * Request for an OT extension before or after the (OT or Regular) shift, or
	 * other change in an OT shift
	 */
	protected int determineRequestSubType(CustShiftReq request) {
<span class="nc bnc" id="L2863" title="All 6 branches missed.">		if (request.isOT() || request.getExtBeforeIsOT() || request.getExtAfterIsOT()) {</span>
<span class="nc bnc" id="L2864" title="All 2 branches missed.">			if (isShiftChangeRequest()) {</span>
<span class="nc" id="L2865">				return CustShiftReq.REQUEST_SUB_TYPE_OT_SHIFT_CHANGE.toInt();</span>
			} else {
<span class="nc" id="L2867">				return CustShiftReq.REQUEST_SUB_TYPE_OT_NEW_SHIFT.toInt();</span>
			}
		} else {
<span class="nc bnc" id="L2870" title="All 2 branches missed.">			if (isShiftChangeRequest()) {</span>
<span class="nc" id="L2871">				return CustShiftReq.REQUEST_SUB_TYPE_REG_SHIFT_CHANGE.toInt();</span>
			} else {
<span class="nc" id="L2873">				return CustShiftReq.REQUEST_SUB_TYPE_REG_NEW_SHIFT.toInt();</span>
			}
		}
	}

	/**
	 * Set Overtime checkbox setting for main shift
	 */
	public void setOvertime(boolean isOT) {
<span class="nc" id="L2882">		m_customShiftRequest.setIsOT(isOT);</span>

<span class="nc bnc" id="L2884" title="All 2 branches missed.">		if (isOT) {</span>
			// Whenever the main shift is for OT, the extensions must also be.
<span class="nc" id="L2886">			setExtBeforeOvertime(true);</span>
<span class="nc" id="L2887">			setExtAfterOvertime(true);</span>
		}
<span class="nc" id="L2889">	}</span>

	/**
	 * Return Overtime checkbox setting for main shift
	 */
	public boolean getOvertime() {
<span class="nc" id="L2895">		return m_customShiftRequest.isOT();</span>
	}

	/**
	 * Set Overtime Before checkbox setting
	 */
	public void setExtBeforeOvertime(boolean isOT) {
<span class="nc" id="L2902">		m_customShiftRequest.setExtBeforeIsOT(isOT);</span>
<span class="nc" id="L2903">	}</span>

	/**
	 * Return Overtime Before checkbox setting
	 */
	public boolean getExtBeforeOvertime() {
<span class="nc" id="L2909">		return m_customShiftRequest.getExtBeforeIsOT();</span>
	}

	/**
	 * Set Overtime After checkbox setting
	 */
	public void setExtAfterOvertime(boolean isOT) {
<span class="nc" id="L2916">		m_customShiftRequest.setExtAfterIsOT(isOT);</span>
<span class="nc" id="L2917">	}</span>

	/**
	 * Return Overtime After checkbox setting
	 */
	public boolean getExtAfterOvertime() {
<span class="nc" id="L2923">		return m_customShiftRequest.getExtAfterIsOT();</span>
	}

	/**
	 * Set Gap Before duration setting
	 */
	public void setExtBeforeGap(int gap) {
<span class="nc" id="L2930">		m_customShiftRequest.setExtBeforeGap(gap);</span>
<span class="nc" id="L2931">	}</span>

	/**
	 * Return Gap Before duration setting
	 */
	public int getExtBeforeGap() {
<span class="nc" id="L2937">		return m_customShiftRequest.getExtBeforeGap();</span>
	}

	/**
	 * Set Gap After duration setting
	 */
	public void setExtAfterGap(int gap) {
<span class="nc" id="L2944">		m_customShiftRequest.setExtAfterGap(gap);</span>
<span class="nc" id="L2945">	}</span>

	/**
	 * Return Gap After duration setting
	 */
	public int getExtAfterGap() {
<span class="nc" id="L2951">		return m_customShiftRequest.getExtAfterGap();</span>
	}

	/**
	 * Set Duration Before duration setting
	 */
	public void setExtBeforeDuration(int duration) {
<span class="nc" id="L2958">		m_customShiftRequest.setExtBeforeDuration(duration);</span>
<span class="nc" id="L2959">	}</span>

	/**
	 * Return Duration Before duration setting
	 */
	public int getExtBeforeDuration() {
<span class="nc" id="L2965">		return m_customShiftRequest.getExtBeforeDuration();</span>
	}

	/**
	 * Set Duration After duration setting
	 */
	public void setExtAfterDuration(int duration) {
<span class="nc" id="L2972">		m_customShiftRequest.setExtAfterDuration(duration);</span>
<span class="nc" id="L2973">	}</span>

	/**
	 * Return Duration After duration setting
	 */
	public int getExtAfterDuration() {
<span class="nc" id="L2979">		return m_customShiftRequest.getExtAfterDuration();</span>
	}

	/**
	 * Set the ID of the Extension before the shift
	 */
	public void setExtBeforeID(ID id) {
<span class="nc" id="L2986">		m_customShiftRequest.setExtBeforeID(id);</span>
<span class="nc" id="L2987">	}</span>

	/**
	 * Get the ID of the Extension before the shift
	 */
	public ID getExtBeforeID() {
<span class="nc" id="L2993">		return m_customShiftRequest.getExtBeforeID();</span>
	}

	/**
	 * Set the ID of the Extension after the shift
	 */
	public void setExtAfterID(ID id) {
<span class="nc" id="L3000">		m_customShiftRequest.setExtAfterID(id);</span>
<span class="nc" id="L3001">	}</span>

	/**
	 * Get the ID of the Extension after the shift
	 */
	public ID getExtAfterID() {
<span class="nc" id="L3007">		return m_customShiftRequest.getExtAfterID();</span>
	}

	/**
	 * Set the activityID of the Extension before the shift
	 */
	public void setExtBeforeActivityID(ID id) {
<span class="nc" id="L3014">		m_customShiftRequest.setExtBeforeActivityID(id);</span>
<span class="nc" id="L3015">	}</span>

	/**
	 * Get the activityID of the Extension before the shift
	 */
	public ID getExtBeforeActivityID() {
<span class="nc" id="L3021">		return m_customShiftRequest.getExtBeforeActivityID();</span>
	}

	/**
	 * Set the activityID of the Extension after the shift
	 */
	public void setExtAfterActivityID(ID id) {
<span class="nc" id="L3028">		m_customShiftRequest.setExtAfterActivityID(id);</span>
<span class="nc" id="L3029">	}</span>

	/**
	 * Get the activityID of the Extension after the shift
	 */
	public ID getExtAfterActivityID() {
<span class="nc" id="L3035">		return m_customShiftRequest.getExtAfterActivityID();</span>
	}

	public CustShiftReqGap getCustShiftReqGap() {
<span class="nc" id="L3039">		Collection&lt;CustShiftReqGap&gt; c = m_customShiftRequest.getChildObjects(CustShiftReqFieldInfo.CUSTREQGAP_CHILD_TYPE);</span>
<span class="nc bnc" id="L3040" title="All 4 branches missed.">		if (c != null &amp;&amp; !c.isEmpty()) {</span>
<span class="nc" id="L3041">			return c.iterator().next();</span>
		}
<span class="nc" id="L3043">		return null;</span>
	}

	public CustShiftReqGap getOrCreateCustShiftReqGap() {
<span class="nc" id="L3047">		CustShiftReqGap g = getCustShiftReqGap();</span>
<span class="nc bnc" id="L3048" title="All 2 branches missed.">		if (g == null) {</span>
<span class="nc" id="L3049">			g = new CustShiftReqGap();</span>
			// Init new gap object
<span class="nc" id="L3051">			g.setExtGapDuration(0);</span>
<span class="nc" id="L3052">			g.setExtGapGap(0);</span>
<span class="nc" id="L3053">			m_customShiftRequest.createChildObject(CustShiftReqFieldInfo.CUSTREQGAP_CHILD_TYPE, g);</span>
		}
<span class="nc" id="L3055">		return g;</span>
	}

	public String getDuringGapGapID() {
<span class="nc" id="L3059">		CustShiftReqGap g = getCustShiftReqGap();</span>
<span class="nc bnc" id="L3060" title="All 4 branches missed.">		if (g != null &amp;&amp; g.getExtGapStartTime() != null) {</span>
<span class="nc" id="L3061">			return g.getExtGapStartTime().getTime() + &quot;_&quot; + g.getExtGapEndTime().getTime();</span>
		} else {
<span class="nc" id="L3063">			return null;</span>
		}
	}

	public void setDuringGapGapID(String gapID) throws Exception {
<span class="nc bnc" id="L3068" title="All 6 branches missed.">		if (gapID != null &amp;&amp; !gapID.isEmpty() &amp;&amp; gapID.compareTo(NONE_ID.toString()) != 0) {</span>
<span class="nc" id="L3069">			CustShiftReqGap g = getOrCreateCustShiftReqGap();</span>
<span class="nc" id="L3070">			g.setExtGapStartTime(new Date(Long.valueOf(gapID.substring(0, gapID.indexOf(&quot;_&quot;)))));</span>
<span class="nc" id="L3071">			g.setExtGapEndTime(new Date(Long.valueOf(gapID.substring(gapID.indexOf(&quot;_&quot;) + 1, gapID.length()))));</span>
<span class="nc bnc" id="L3072" title="All 2 branches missed.">		} else if (getCustShiftReqGap() != null) {</span>
<span class="nc" id="L3073">			CustShiftReqGap g = getCustShiftReqGap();</span>
<span class="nc" id="L3074">			g.setExtGapStartTime(null);</span>
<span class="nc" id="L3075">			g.setExtGapEndTime(null);</span>
		}
<span class="nc" id="L3077">	}</span>

	public ID getDuringGapTypeID() {
<span class="nc" id="L3080">		CustShiftReqGap g = getCustShiftReqGap();</span>
<span class="nc bnc" id="L3081" title="All 6 branches missed.">		if (g != null &amp;&amp; g.getExtGapStartTime() != null &amp;&amp; isDuringGapEditableAndNotSetToNone()) {</span>
<span class="nc" id="L3082">			return g.getShiftOTGapID();</span>
		} else {
<span class="nc" id="L3084">			return null;</span>
		}
	}

	public void setDuringGapTypeID(ID otId) {
<span class="nc bnc" id="L3089" title="All 4 branches missed.">		if (otId != null &amp;&amp; otId.compareTo(NONE_ID) != 0) {</span>
<span class="nc" id="L3090">			CustShiftReqGap g = getOrCreateCustShiftReqGap();</span>
<span class="nc" id="L3091">			g.setShiftOtGapID(otId);</span>
<span class="nc" id="L3092">		} else {</span>
<span class="nc" id="L3093">			CustShiftReqGap g = getCustShiftReqGap();</span>
<span class="nc bnc" id="L3094" title="All 2 branches missed.">			if (g != null) {</span>
<span class="nc" id="L3095">				g.setShiftOtGapID(null);</span>
			}
		}

<span class="nc" id="L3099">	}</span>

	public ID getDuringGapActivityID() {
<span class="nc" id="L3102">		CustShiftReqGap g = getCustShiftReqGap();</span>
<span class="nc bnc" id="L3103" title="All 6 branches missed.">		if (g != null &amp;&amp; g.getExtGapStartTime() != null &amp;&amp; isDuringGapTypeEditableAndNotSetToNone()) {</span>
<span class="nc" id="L3104">			return g.getExtGapActivityID();</span>
		} else {
<span class="nc" id="L3106">			return null;</span>
		}
	}

	public void setDuringGapActivityID(ID activityId) {
<span class="nc bnc" id="L3111" title="All 4 branches missed.">		if (activityId != null &amp;&amp; activityId.compareTo(NONE_ID) != 0) {</span>
<span class="nc" id="L3112">			CustShiftReqGap g = getOrCreateCustShiftReqGap();</span>
<span class="nc" id="L3113">			g.setExtGapActivityID(activityId);</span>
		}
<span class="nc" id="L3115">	}</span>

	public int getDuringGapDuration() {
<span class="nc" id="L3118">		CustShiftReqGap g = getCustShiftReqGap();</span>
<span class="nc bnc" id="L3119" title="All 6 branches missed.">		if (g != null &amp;&amp; g.getExtGapStartTime() != null &amp;&amp; isDuringGapTypeEditableAndNotSetToNone()) {</span>
<span class="nc" id="L3120">			return g.getExtGapDuration();</span>
		} else {
<span class="nc" id="L3122">			return 0;</span>
		}
	}

	public void setDuringGapDuration(int val) {
<span class="nc bnc" id="L3127" title="All 2 branches missed.">		if (val != 0) {</span>
<span class="nc" id="L3128">			CustShiftReqGap g = getOrCreateCustShiftReqGap();</span>
<span class="nc" id="L3129">			g.setExtGapDuration(val);</span>
		}
<span class="nc" id="L3131">	}</span>

	public int getDuringGapGap() {
<span class="nc" id="L3134">		CustShiftReqGap g = getCustShiftReqGap();</span>
<span class="nc bnc" id="L3135" title="All 6 branches missed.">		if (g != null &amp;&amp; g.getExtGapStartTime() != null &amp;&amp; isDuringGapTypeEditableAndNotSetToNone()) {</span>
<span class="nc" id="L3136">			return g.getExtGapGap();</span>
		} else {
<span class="nc" id="L3138">			return 0;</span>
		}
	}

	public void setDuringGapGap(int val) {
<span class="nc bnc" id="L3143" title="All 2 branches missed.">		if (val != 0) {</span>
<span class="nc" id="L3144">			CustShiftReqGap g = getOrCreateCustShiftReqGap();</span>
<span class="nc" id="L3145">			g.setExtGapGap(val);</span>
		}
<span class="nc" id="L3147">	}</span>

	/**
	 * Set the date at which the user's selection starts on the graph schedule
	 * view's Net Staffing ribbon.
	 *
	 * @param date
	 */
	public void setRibbonStartDate(String date) {
<span class="nc" id="L3156">		m_ribbonStartDate = new Date(Long.parseLong(date));</span>
<span class="nc" id="L3157">	}</span>

	/**
	 * Get the date at which the user's selection starts on the graph schedule
	 * view's Net Staffing ribbon.
	 */
	public Date getRibbonStartDate() {
<span class="nc" id="L3164">		return m_ribbonStartDate;</span>
	}

	/**
	 * Set the date at which the user's selection ends on the graph schedule
	 * view's Net Staffing ribbon.
	 *
	 * @param date
	 */
	public void setRibbonEndDate(String date) {
<span class="nc" id="L3174">		m_ribbonEndDate = new Date(Long.parseLong(date));</span>
<span class="nc" id="L3175">	}</span>

	/**
	 * Get the date at which the user's selection ends on the graph schedule
	 * view's Net Staffing ribbon.
	 */
	public Date getRibbonEndDate() {
<span class="nc" id="L3182">		return m_ribbonEndDate;</span>
	}

	/**
	 * Return true if Request is Escalated
	 */
	private boolean isEscalatedRequest() {
<span class="nc" id="L3189">		return RequestAuditTrail.STATUS_ESCALATED.equals(getRequestStatus());</span>
	}

	/**
	 * Set whether or not the Shift section is collapsed.
	 *
	 * @param collapsed
	 *            - &quot;true&quot; if it is collapsed, &quot;false&quot; if it is expanded.
	 */
	public void setShiftSectionCollapsed(String collapsed) {
<span class="nc" id="L3199">		m_shiftSectionCollapsed = collapsed;</span>
<span class="nc" id="L3200">	}</span>

	/**
	 * Set whether or not the Extension Before Shift section is collapsed.
	 *
	 * @param collapsed
	 *            - &quot;true&quot; if it is collapsed, &quot;false&quot; if it is expanded.
	 */
	public void setExtBeforeSectionCollapsed(String collapsed) {
<span class="nc" id="L3209">		m_extBeforeSectionCollapsed = collapsed;</span>
<span class="nc" id="L3210">	}</span>

	/**
	 * Set whether or not the Extension After Shift section is collapsed.
	 *
	 * @param collapsed
	 *            - &quot;true&quot; if it is collapsed, &quot;false&quot; if it is expanded.
	 */
	public void setExtAfterSectionCollapsed(String collapsed) {
<span class="nc" id="L3219">		m_extAfterSectionCollapsed = collapsed;</span>
<span class="nc" id="L3220">	}</span>

	public void setExtDuringSectionCollapsed(String collapsed) {
<span class="nc" id="L3223">		m_extDuringGapSectionCollapsed = collapsed;</span>
<span class="nc" id="L3224">	}</span>

	/**
	 * Set whether or not the Alerts section is collapsed.
	 *
	 * @param collapsed
	 *            - &quot;true&quot; if it is collapsed, &quot;false&quot; if it is expanded.
	 */
	public void setAlertsSectionCollapsed(String collapsed) {
<span class="nc" id="L3233">		m_alertsSectionCollapsed = collapsed;</span>
<span class="nc" id="L3234">	}</span>

	public boolean getShiftSectionCollapsed() {
<span class="nc bnc" id="L3237" title="All 4 branches missed.">		if (m_shiftSectionCollapsed == null || m_shiftSectionCollapsed.equals(&quot;false&quot;)) {</span>
<span class="nc" id="L3238">			return false;</span>
		}
<span class="nc" id="L3240">		return true;</span>
	}

	public boolean getExtBeforeSectionCollapsed() {
<span class="nc bnc" id="L3244" title="All 4 branches missed.">		if (m_extBeforeSectionCollapsed == null || m_extBeforeSectionCollapsed.equals(&quot;false&quot;)) {</span>
<span class="nc" id="L3245">			return false;</span>
		}
<span class="nc" id="L3247">		return true;</span>
	}

	public boolean getExtAfterSectionCollapsed() {
<span class="nc bnc" id="L3251" title="All 4 branches missed.">		if (m_extAfterSectionCollapsed == null || m_extAfterSectionCollapsed.equals(&quot;false&quot;)) {</span>
<span class="nc" id="L3252">			return false;</span>
		}
<span class="nc" id="L3254">		return true;</span>
	}

	public boolean getExtDuringGapSectionCollapsed() {
<span class="nc bnc" id="L3258" title="All 4 branches missed.">		if (m_extDuringGapSectionCollapsed == null || m_extDuringGapSectionCollapsed.equals(&quot;false&quot;)) {</span>
<span class="nc" id="L3259">			return false;</span>
		}
<span class="nc" id="L3261">		return true;</span>
	}

	public boolean getAlertsSectionCollapsed() {
<span class="nc bnc" id="L3265" title="All 4 branches missed.">		if (m_alertsSectionCollapsed == null || m_alertsSectionCollapsed.equals(&quot;false&quot;)) {</span>
<span class="nc" id="L3266">			return false;</span>
		}
<span class="nc" id="L3268">		return true;</span>
	}

	/**
	 * Determines the collapsed state of each of the four main sections of the
	 * dialog (Shift, extBefore, extAfter, and Alerts). We will determine the
	 * state based on the user's net staffing selection (when coming from the
	 * ribbon), or the saved request object (when viewing a saved request), or
	 * the user's schedule (if user changed Date or Agent selection, or the
	 * dialog was just opened). If the dialog was refreshed due to the agent
	 * making other changes (time, shift, extension), we will keep the previous
	 * state of collapsed sections.
	 *
	 * @param existingRequest
	 *            - If we are editing a saved request, this should contain the
	 *            request from the db.
	 */
	public void determineCollapsedSections(CustShiftReq existingRequest) {
<span class="nc bnc" id="L3286" title="All 2 branches missed.">		if (isRibbonDefaultMode()) {</span>
			// as a default, show the Shift section only
<span class="nc" id="L3288">			setCollapsedSections(false, true, true, true, true);</span>
<span class="nc bnc" id="L3289" title="All 2 branches missed.">			if (isShiftChangeRequest()) {</span>
<span class="nc bnc" id="L3290" title="All 4 branches missed.">				if (isExtBeforeOptimizable() &amp;&amp; isExtAfterOptimizable()) {</span>
<span class="nc bnc" id="L3291" title="All 2 branches missed.">					if (m_ribbonStartDate.before(m_shiftAssignment.getStartTime())</span>
<span class="nc bnc" id="L3292" title="All 2 branches missed.">							&amp;&amp; m_ribbonEndDate.after(m_shiftAssignment.getEndTime())) {</span>
<span class="nc" id="L3293">						setCollapsedSections(true, false, false, true, true);</span>
<span class="nc bnc" id="L3294" title="All 2 branches missed.">					} else if (m_ribbonStartDate.before(m_shiftAssignment.getStartTime())) {</span>
<span class="nc" id="L3295">						setCollapsedSections(true, false, true, true, true);</span>
<span class="nc bnc" id="L3296" title="All 2 branches missed.">					} else if (m_ribbonEndDate.after(m_shiftAssignment.getEndTime())) {</span>
<span class="nc" id="L3297">						setCollapsedSections(true, true, false, true, true);</span>
					}
<span class="nc bnc" id="L3299" title="All 4 branches missed.">				} else if (isExtBeforeOptimizable() || isExtAfterOptimizable()) {</span>
<span class="nc bnc" id="L3300" title="All 4 branches missed.">					setCollapsedSections(true, !isExtBeforeOptimizable(), !isExtAfterOptimizable(), true, true);</span>
				}
			}
<span class="nc bnc" id="L3303" title="All 4 branches missed.">		} else if (m_reloadAction.equals(RELOAD_ACTION_EMPLOYEE) || m_reloadAction.equals(RELOAD_ACTION_DATE)</span>
<span class="nc bnc" id="L3304" title="All 2 branches missed.">				|| m_reloadAction.equals(RELOAD_ACTION_NONE)) {</span>
<span class="nc bnc" id="L3305" title="All 2 branches missed.">			if (isRequestDefaultMode()) {</span>
				// expand all sections that have been requested, plus Alerts (if
				// any)
<span class="nc bnc" id="L3308" title="All 4 branches missed.">				setCollapsedSections(existingRequest.getShiftID() == null, existingRequest.getExtBeforeID() == null,</span>
<span class="nc bnc" id="L3309" title="All 4 branches missed.">						existingRequest.getExtAfterID() == null, (existingRequest.getChildObjects(CustShiftReqFieldInfo.CUSTREQGAP_CHILD_TYPE)==null ||</span>
<span class="nc bnc" id="L3310" title="All 4 branches missed.">								existingRequest.getChildObjects(CustShiftReqFieldInfo.CUSTREQGAP_CHILD_TYPE).size()==0), !hasValidationAlert());</span>
<span class="nc bnc" id="L3311" title="All 2 branches missed.">			} else if (isNewShiftRequest()) {</span>
				// as a default, show the Shift section only
<span class="nc" id="L3313">				setCollapsedSections(false, true, true, true, true);</span>
			} else { // shift change request
<span class="nc bnc" id="L3315" title="All 4 branches missed.">				if (isShiftEditable() || nothingIsEditable()) {</span>
					// as a default, show the Shift section only
<span class="nc" id="L3317">					setCollapsedSections(false, true, true, true, true);</span>
				} else {
					// Expand the Shift section, and any editable extension.
					// The reason why we expand the Shift section is because the
					// user won't have any other way of knowing
					// what the shift is or what needs to be done. Contrast this
					// with what happens when coming from the ribbon.
					// In that case, the user already knows what the shift looks
					// like, since he just saw it in the schedule view.
<span class="nc bnc" id="L3326" title="All 6 branches missed.">					setCollapsedSections(false, !isExtBeforeEditable(), !isExtAfterEditable(), !isExtDuringGapEnablable(), true);</span>
				}
			}

<span class="nc bnc" id="L3330" title="All 4 branches missed.">			if (m_reloadAction.equals(RELOAD_ACTION_EMPLOYEE) || m_reloadAction.equals(RELOAD_ACTION_DATE)) {</span>
<span class="nc" id="L3331">				m_shiftSectionCollapsed = &quot;false&quot;; // expand the Shift section</span>
				// since it was previously
				// expanded
			}

<span class="nc bnc" id="L3336" title="All 2 branches missed.">		} else if (m_reloadAction.equals(RELOAD_ACTION_SAVE)) {</span>
<span class="nc bnc" id="L3337" title="All 2 branches missed.">			m_alertsSectionCollapsed = hasValidationAlert() ? &quot;false&quot; : &quot;true&quot;;</span>
		}
<span class="nc" id="L3339">	}</span>

	/**
	 * Returns true if there are one or more validation rule alerts for the
	 * saved request, false otherwise.
	 */
	public boolean hasValidationAlert() {
<span class="nc bnc" id="L3346" title="All 2 branches missed.">		return !m_valResults.isEmpty();</span>
	}

	public void setCollapsedSections(boolean shiftCollapsed, boolean extBeforeCollapsed, boolean extAfterCollapsed,
			boolean gapCollapesd, boolean alertsCollapsed) {
<span class="nc bnc" id="L3351" title="All 2 branches missed.">		m_shiftSectionCollapsed = shiftCollapsed ? &quot;true&quot; : &quot;false&quot;;</span>
<span class="nc bnc" id="L3352" title="All 2 branches missed.">		m_extBeforeSectionCollapsed = extBeforeCollapsed ? &quot;true&quot; : &quot;false&quot;;</span>
<span class="nc bnc" id="L3353" title="All 2 branches missed.">		m_extAfterSectionCollapsed = extAfterCollapsed ? &quot;true&quot; : &quot;false&quot;;</span>
<span class="nc bnc" id="L3354" title="All 2 branches missed.">		m_alertsSectionCollapsed = alertsCollapsed ? &quot;true&quot; : &quot;false&quot;;</span>
<span class="nc bnc" id="L3355" title="All 2 branches missed.">		m_extDuringGapSectionCollapsed = gapCollapesd ? &quot;true&quot; : &quot;false&quot;;</span>
<span class="nc" id="L3356">	}</span>

	/**
	 * Return the JavaScript init code required to initialize this component
	 */
	@Override
	public String getJavaScriptInitCode() {
<span class="nc bnc" id="L3363" title="All 2 branches missed.">		if (m_customShiftRequest.getRequestStatus().equals(RequestAuditTrail.STATUS_APPROVED)) {</span>
<span class="nc" id="L3364">			setIsRefreshOpenerOnClose(true);</span>
		}

<span class="nc" id="L3367">		return super.getJavaScriptInitCode();</span>
	}

	/**
	 * Return Required Html
	 */
	@Override
	public String getRequiredHTML() {
<span class="nc" id="L3375">		StringBuffer sb = new StringBuffer(100);</span>
<span class="nc" id="L3376">		sb.append(super.getRequiredHTML());</span>

<span class="nc bnc" id="L3378" title="All 2 branches missed.">		if (!isManagerMode()) {</span>
<span class="nc" id="L3379">			ID empID = m_context.getUser().getEmployeeID();</span>
<span class="nc" id="L3380">			String requestFor = HtmlUtil.makeHiddenInput(REQUESTED_FOR_FN, empID.toString());</span>
<span class="nc" id="L3381">			sb.append(requestFor);</span>
		}

<span class="nc" id="L3384">		String requestStatus = HtmlUtil.makeHiddenInput(REQUEST_STATUS_FN, m_customShiftRequest.getRequestStatus());</span>
<span class="nc" id="L3385">		sb.append(requestStatus);</span>

<span class="nc" id="L3387">		String reloadAction = HtmlUtil.makeHiddenInput(RELOAD_ACTION_FN, m_reloadAction);</span>
<span class="nc" id="L3388">		sb.append(reloadAction);</span>

<span class="nc bnc" id="L3390" title="All 2 branches missed.">		if (isRibbonMode()) {</span>
<span class="nc" id="L3391">			sb.append(HtmlUtil.makeHiddenInput(&quot;ribbonStartDate&quot;, (&quot;&quot; + m_ribbonStartDate.getTime())));</span>
<span class="nc" id="L3392">			sb.append(HtmlUtil.makeHiddenInput(&quot;ribbonEndDate&quot;, (&quot;&quot; + m_ribbonEndDate.getTime())));</span>
<span class="nc" id="L3393">			sb.append(HtmlUtil.makeHiddenInput(&quot;origRequestedFor&quot;, getOrigRequestedFor()));</span>
		}

<span class="nc" id="L3396">		sb.append(HtmlUtil.makeHiddenInput(&quot;shiftSectionCollapsed&quot;, m_shiftSectionCollapsed));</span>
<span class="nc" id="L3397">		sb.append(HtmlUtil.makeHiddenInput(&quot;extBeforeSectionCollapsed&quot;, m_extBeforeSectionCollapsed));</span>
<span class="nc" id="L3398">		sb.append(HtmlUtil.makeHiddenInput(&quot;extAfterSectionCollapsed&quot;, m_extAfterSectionCollapsed));</span>
<span class="nc" id="L3399">		sb.append(HtmlUtil.makeHiddenInput(&quot;extDuringGapSectionCollapsed&quot;, m_extDuringGapSectionCollapsed));</span>
<span class="nc" id="L3400">		sb.append(HtmlUtil.makeHiddenInput(&quot;alertsSectionCollapsed&quot;, m_alertsSectionCollapsed));</span>
<span class="nc" id="L3401">		sb.append(HtmlUtil.makeHiddenInput(SAVED_BEFORE_DURATION, m_savedBeforeDuration));</span>
<span class="nc" id="L3402">		sb.append(HtmlUtil.makeHiddenInput(SAVED_AFTER_DURATION, m_savedAfterDuration));</span>
<span class="nc" id="L3403">		sb.append(HtmlUtil.makeHiddenInput(SAVED_DURING_GAP_DURATION, m_savedDuringGapDuration));</span>
<span class="nc" id="L3404">		sb.append(HtmlUtil.makeHiddenInput(SAVED_OT_BEFORE_AFTER_STATE, m_savedBeforeAfterState));</span>

<span class="nc" id="L3406">		return sb.toString();</span>
	}

	/**
	 * Overrides the one in RequestFormPopupPM.
	 */
	@Override
	public void setSavedRequestID(ID requsetID) {
<span class="nc" id="L3414">		m_isRequestSaved = true;</span>
<span class="nc" id="L3415">		super.setSavedRequestID(requsetID);</span>

<span class="nc bnc" id="L3417" title="All 2 branches missed.">		if (isRibbonMode()) {</span>
<span class="nc" id="L3418">			setIsRefreshOpenerOnClose(false);</span>
		}
<span class="nc" id="L3420">	}</span>

	/**
	 * Returns true if this request dialog was originally launched from a net
	 * staffing ribbon selection.
	 *
	 * @return
	 */
	public boolean isRibbonMode() {
<span class="nc bnc" id="L3429" title="All 2 branches missed.">		return (m_ribbonStartDate != null);</span>
	}

	/**
	 * Returns true if this request dialog was originally launched from a net
	 * staffing ribbon selection, AND the selected user and selected date are
	 * the same ones that were selected in the net staffing ribbon. If so, that
	 * means that we will filter the activity dropdowns by keeping only those
	 * with a net staffing deficiency (as well as any the user is currently
	 * scheduled for). We will NOT change the values currently selected in the
	 * dropdowns to the ribbon defaults.
	 */
	public boolean isRibbonApplicable() {
<span class="nc bnc" id="L3442" title="All 6 branches missed.">		return isRibbonMode() &amp;&amp; m_selectedDayIncludesRibbonSelection &amp;&amp; m_selectedAgentIsForRibbonSelection;</span>
	}

	/**
	 * Returns true if this request dialog was originally launched from a net
	 * staffing ribbon selection, AND the selected user and selected date are
	 * the same ones that were selected in the net staffing ribbon, AND either
	 * the dialog was just launched from the ribbon, of the user just changed
	 * the employee/date selection back to the original values for the ribbon
	 * selection. If so, that means that we will filter the activity dropdowns
	 * by keeping only those with a net staffing deficiency (as well as any the
	 * user is currently scheduled for). In addition, we will set the
	 * shift/extension/activity dropdowns with the default to best match the
	 * ribbon selection (including selecting the most deficient activity).
	 */
	public boolean isRibbonDefaultMode() {
<span class="nc bnc" id="L3458" title="All 4 branches missed.">		return m_selectedDayIncludesRibbonSelection &amp;&amp; m_selectedAgentIsForRibbonSelection</span>
<span class="nc bnc" id="L3459" title="All 4 branches missed.">				&amp;&amp; (m_reloadAction.equals(RELOAD_ACTION_EMPLOYEE) || m_reloadAction.equals(RELOAD_ACTION_DATE)</span>
<span class="nc bnc" id="L3460" title="All 2 branches missed.">						|| m_reloadAction.equals(RELOAD_ACTION_RIBBON));</span>
	}

	/**
	 * Returns true if the user is editing an existing request, and the popup
	 * has just launched, or the user has just changed the date back to the
	 * original date for the request. In this case, we should reload the saved
	 * request settings rather than reset the form.
	 */
	public boolean isRequestDefaultMode() {
<span class="nc bnc" id="L3470" title="All 4 branches missed.">		return !isNew() &amp;&amp; m_selectedDateIsForSavedRequest</span>
<span class="nc bnc" id="L3471" title="All 4 branches missed.">				&amp;&amp; (m_reloadAction.equals(RELOAD_ACTION_DATE) || m_reloadAction.equals(RELOAD_ACTION_NONE));</span>
	}

	/**
	 * Return Employee Name By ID or the First One
	 */
	private EmployeeName findEmpNameByID(ID empID) {
<span class="nc" id="L3478">		EmployeeName eName = null;</span>

<span class="nc bnc" id="L3480" title="All 2 branches missed.">		for (Iterator it = m_empNames.iterator(); it.hasNext();) {</span>
<span class="nc" id="L3481">			EmployeeName tmpEName = (EmployeeName) it.next();</span>
			// Keep track of First Employee Name
<span class="nc bnc" id="L3483" title="All 2 branches missed.">			if (eName == null) {</span>
<span class="nc" id="L3484">				eName = tmpEName;</span>
			}

<span class="nc bnc" id="L3487" title="All 2 branches missed.">			if (tmpEName.getID().equals(empID)) {</span>
<span class="nc" id="L3488">				eName = tmpEName;</span>
<span class="nc" id="L3489">				break;</span>
			}
<span class="nc" id="L3491">		}</span>

<span class="nc" id="L3493">		return eName;</span>
	}

	private String reloadWithAction(String reloadAction) {
<span class="nc" id="L3497">		return JS_FUNC_RELOAD_WITH_ACTION + &quot;('&quot; + reloadAction + &quot;');&quot;;</span>
	}

	/**
	 * Prepare the request for saving to the database.
	 *
	 * @param request
	 *            - The request object. We will modify it as necessary.
	 */
	protected void prepareRequestForSaving(CustShiftReq request) {
<span class="nc" id="L3507">		request.setSPID(m_spID);</span>
<span class="nc" id="L3508">		request.setSubmittedOn(new Date());</span>

		// Replace NONE_ID or CUSTOM_ID with null ( custom shifts have SHIFT ID
		// =null in shift assignment)
<span class="nc bnc" id="L3512" title="All 2 branches missed.">		if (request.getShiftID() != null</span>
<span class="nc bnc" id="L3513" title="All 4 branches missed.">				&amp;&amp; (request.getShiftID().equals(NONE_ID) || request.getShiftID().equals(CUSTOM_ID))) {</span>
<span class="nc" id="L3514">			request.setShiftID(null);</span>
		}
<span class="nc bnc" id="L3516" title="All 4 branches missed.">		if (request.getExtBeforeID() != null &amp;&amp; request.getExtBeforeID().equals(NONE_ID)) {</span>
<span class="nc" id="L3517">			request.setExtBeforeID(null);</span>
		}

<span class="nc bnc" id="L3520" title="All 4 branches missed.">		if (request.getExtBeforeActivityID() != null &amp;&amp; request.getExtBeforeActivityID().equals(NONE_ID)) {</span>
<span class="nc" id="L3521">			request.setExtBeforeActivityID(null);</span>
		}

<span class="nc bnc" id="L3524" title="All 4 branches missed.">		if (request.getExtAfterActivityID() != null &amp;&amp; request.getExtAfterActivityID().equals(NONE_ID)) {</span>
<span class="nc" id="L3525">			request.setExtAfterActivityID(null);</span>
		}

<span class="nc bnc" id="L3528" title="All 4 branches missed.">		if (request.getExtAfterID() != null &amp;&amp; request.getExtAfterID().equals(NONE_ID)) {</span>
<span class="nc" id="L3529">			request.setExtAfterID(null);</span>
		}

<span class="nc bnc" id="L3532" title="All 4 branches missed.">		if (getCustShiftReqGap() != null &amp;&amp; getCustShiftReqGap().getExtGapStartTime() == null) {</span>
<span class="nc" id="L3533">			setDuringGapActivityID(null);</span>
<span class="nc" id="L3534">			setDuringGapGap(0);</span>
<span class="nc" id="L3535">			setDuringGapTypeID(null);</span>
<span class="nc" id="L3536">			setDuringGapDuration(0);</span>
		}

<span class="nc" id="L3539">		keepOnlyRequestDeltas(request);</span>

<span class="nc" id="L3541">		ID spID = findSPIdPostAdjustingRequestDates(request.getStartTime(), request.getEndTime());</span>

<span class="nc bnc" id="L3543" title="All 2 branches missed.">		if (spID != null) {</span>
<span class="nc" id="L3544">			request.setSPID(spID);</span>
		} else {
<span class="nc" id="L3546">			request.setSPID(m_spID);</span>
		}

<span class="nc" id="L3549">		request.setExpirationDate(request.getStartTime());</span>

<span class="nc bnc" id="L3551" title="All 2 branches missed.">		request.setHashCodeForUndrlyngShift(m_shiftAssignment == null ? null : m_shiftAssignment.hashCode() + &quot;&quot;);</span>

<span class="nc bnc" id="L3553" title="All 2 branches missed.">		request.setShiftAssignmentID(m_shiftAssignment == null ? null : m_shiftAssignment.getID());</span>
<span class="nc" id="L3554">	}</span>

	/**
	 * If we are saving a new/existing &quot;New Shift&quot; request, keep everything in
	 * the request object. If we are saving a new/existing &quot;Shift Change&quot;
	 * request, keep only the differences (deltas) between the request object
	 * and the ShiftAssignment. Either way, the request start and end time will
	 * be set so that they cover only the changed intervals (shift change
	 * request), or the entire shift+extensions (new shift request).
	 *
	 * @param request
	 *            - The request object. We will modify it if necessary so as to
	 *            keep only the &quot;delta&quot; data.
	 */
	protected void keepOnlyRequestDeltas(CustShiftReq request) {
<span class="nc" id="L3569">		boolean changedSomethingForShift = true; // this is always true for New</span>
		// Shift requests

<span class="nc bnc" id="L3572" title="All 2 branches missed.">		if (isShiftChangeRequest()) {</span>
<span class="nc bnc" id="L3573" title="All 2 branches missed.">			boolean changedShift = !areValuesEqual(request.getShiftID(), m_shiftAssignment.getShiftID());</span>
<span class="nc bnc" id="L3574" title="All 2 branches missed.">			boolean changedShiftStart = !areValuesEqual(request.getShiftStartTime(), m_saMainShiftStartTime);</span>
<span class="nc bnc" id="L3575" title="All 2 branches missed.">			boolean changedShiftEnd = !areValuesEqual(request.getShiftEndTime(), m_saMainShiftEndTime);</span>
<span class="nc bnc" id="L3576" title="All 6 branches missed.">			changedSomethingForShift = changedShift || changedShiftStart || changedShiftEnd;</span>

<span class="nc bnc" id="L3578" title="All 2 branches missed.">			if (!changedSomethingForShift) {</span>
<span class="nc" id="L3579">				request.setShiftID(null);</span>
<span class="nc" id="L3580">				request.setActivityID(null);</span>
			}

			// the following field can never be changed, but we still set it to
			// null to make it clear
<span class="nc bnc" id="L3585" title="All 2 branches missed.">			if (areValuesEqual(request.getExtBeforeID(), m_shiftAssignment.getOTExtensionBeforeID())) {</span>
<span class="nc" id="L3586">				request.setExtBeforeID(null);</span>
			}

			// the following field can never be changed, but we still set it to
			// null to make it clear
<span class="nc bnc" id="L3591" title="All 2 branches missed.">			if (areValuesEqual(request.getExtBeforeActivityID(), m_shiftAssignment.getOTExtensionBeforeActivityID())) {</span>
<span class="nc" id="L3592">				request.setExtBeforeActivityID(null);</span>
			}

			// the following field can never be changed, but we still set it to
			// null to make it clear
<span class="nc bnc" id="L3597" title="All 2 branches missed.">			if (areValuesEqual(request.getExtAfterID(), m_shiftAssignment.getOTExtensionAfterID())) {</span>
<span class="nc" id="L3598">				request.setExtAfterID(null);</span>
			}

			// the following field can never be changed, but we still set it to
			// null to make it clear
<span class="nc bnc" id="L3603" title="All 2 branches missed.">			if (areValuesEqual(request.getExtAfterActivityID(), m_shiftAssignment.getOTExtensionAfterActivityID())) {</span>
<span class="nc" id="L3604">				request.setExtAfterActivityID(null);</span>
			}

			// Since we now only store the deltas, this shouldn't be needed,
			// since you cannot change durations.
<span class="nc bnc" id="L3609" title="All 2 branches missed.">			if (areValuesEqual(request.getExtBeforeDuration(),</span>
<span class="nc" id="L3610">					new ID(m_shiftAssignment.getExtensionBefore() - m_saGapBeforeDuration))) {</span>
<span class="nc" id="L3611">				request.setExtBeforeDuration(0); // null);</span>
			}

<span class="nc bnc" id="L3614" title="All 2 branches missed.">			if (areValuesEqual(request.getExtAfterDuration(),</span>
<span class="nc" id="L3615">					new ID(m_shiftAssignment.getExtensionAfter() - m_saGapAfterDuration))) {</span>
<span class="nc" id="L3616">				request.setExtAfterDuration(0); // null);</span>
			}
		}

<span class="nc bnc" id="L3620" title="All 2 branches missed.">		if (request.getExtBeforeID() == null) {</span>
<span class="nc" id="L3621">			request.setExtBeforeIsOT(false);</span>
<span class="nc" id="L3622">			request.setExtBeforeGap(0);</span>
<span class="nc" id="L3623">			request.setExtBeforeDuration(0);</span>
<span class="nc" id="L3624">			request.setExtBeforeActivityID(null);</span>
		}

<span class="nc bnc" id="L3627" title="All 2 branches missed.">		if (request.getExtAfterID() == null) {</span>
<span class="nc" id="L3628">			request.setExtAfterIsOT(false);</span>
<span class="nc" id="L3629">			request.setExtAfterGap(0);</span>
<span class="nc" id="L3630">			request.setExtAfterDuration(0);</span>
<span class="nc" id="L3631">			request.setExtAfterActivityID(null);</span>
		}

		// this will make sure value in db is not null since the getter cannot
		// return null
<span class="nc" id="L3636">		request.setExtBeforeIsOT(request.getExtBeforeIsOT());</span>
<span class="nc" id="L3637">		request.setExtAfterIsOT(request.getExtAfterIsOT());</span>

		// set request subtype
<span class="nc" id="L3640">		request.setSubType(determineRequestSubType(request));</span>

		// the request start and end time should cover only the changed
		// intervals
<span class="nc" id="L3644">		Calendar cal = Calendar.getInstance(m_view_tz);</span>
<span class="nc" id="L3645">		Date beforeStartTime = null, shiftStartTime = null, afterStartTime = null, gapStartTime = null;</span>
<span class="nc" id="L3646">		Date beforeEndTime = null, shiftEndTime = null, afterEndTime = null, gapEndTime = null;</span>

<span class="nc bnc" id="L3648" title="All 2 branches missed.">		if (request.getExtBeforeID() != null) {</span>
			// an extension before shift is being added. Use its start time as
			// the request start time.
<span class="nc" id="L3651">			cal.setTime(m_customShiftRequest.getShiftStartTime());</span>

<span class="nc bnc" id="L3653" title="All 2 branches missed.">			if (m_extBeforeType != null) {</span>
				// subtract ext before from main shift start time
<span class="nc bnc" id="L3655" title="All 2 branches missed.">				int buffer = !denyOTDurationEdit ?</span>
<span class="nc" id="L3656">						getExtBeforeDuration() + getExtBeforeGap() : m_extBeforeType.getDuration() + getExtBeforeGap();</span>
<span class="nc" id="L3657">				cal.add(Calendar.MINUTE, -buffer);</span>
			}

<span class="nc" id="L3660">			beforeStartTime = cal.getTime();</span>
<span class="nc" id="L3661">			beforeEndTime = m_customShiftRequest.getShiftStartTime();</span>
		}

<span class="nc bnc" id="L3664" title="All 2 branches missed.">		if (changedSomethingForShift) {</span>
			// something in the shift is being changed. Use its start time as
			// the request start time.
<span class="nc" id="L3667">			shiftStartTime = m_customShiftRequest.getShiftStartTime();</span>
<span class="nc" id="L3668">			shiftEndTime = m_customShiftRequest.getShiftEndTime();</span>
		}

<span class="nc bnc" id="L3671" title="All 2 branches missed.">		if (request.getExtAfterID() != null) {</span>
			// an extension after shift is being added. Use its end time as the
			// request end time.
<span class="nc" id="L3674">			afterStartTime = m_customShiftRequest.getShiftEndTime();</span>
<span class="nc" id="L3675">			cal.setTime(m_customShiftRequest.getShiftEndTime());</span>

<span class="nc bnc" id="L3677" title="All 2 branches missed.">			if (m_extAfterType != null) {</span>
				// add ext after to main shift end time
<span class="nc bnc" id="L3679" title="All 2 branches missed.">				int buffer = !denyOTDurationEdit ?</span>
<span class="nc" id="L3680">						getExtAfterDuration() + getExtAfterGap() : m_extAfterType.getDuration() + getExtAfterGap();</span>
<span class="nc" id="L3681">				cal.add(Calendar.MINUTE, buffer);</span>
			}

<span class="nc" id="L3684">			afterEndTime = cal.getTime();</span>
		}

<span class="nc bnc" id="L3687" title="All 4 branches missed.">		if (getCustShiftReqGap() != null &amp;&amp; getCustShiftReqGap().getExtGapStartTime() != null) {</span>
<span class="nc" id="L3688">			gapStartTime = getCustShiftReqGap().getExtGapStartTime();</span>
<span class="nc" id="L3689">			gapEndTime = getCustShiftReqGap().getExtGapEndTime();</span>
		}

		// Finally, set the delta starttime and endtime for the entire request
<span class="nc" id="L3693">		request.setStartTime(minOfThreeDates(beforeStartTime, shiftStartTime, minOfTwoDates(afterStartTime, gapStartTime)));</span>
<span class="nc" id="L3694">		request.setEndTime(maxOfThreeDates(beforeEndTime, shiftEndTime, maxOfTwoDates(afterEndTime, gapEndTime)));</span>
<span class="nc" id="L3695">	}</span>

	/**
	 * This method finds the SP to which this request belongs to after the deltas have been adjusted for the request
	 * 
	 * @param startTime
	 * @param endTime
	 * @return
	 */
	protected ID findSPIdPostAdjustingRequestDates(Date startTime, Date endTime) {
<span class="nc" id="L3705">		TimeRange spTimeRange = null;</span>
<span class="nc" id="L3706">		List&lt;ID&gt; retColl = null;</span>
		// startTime will be null when the request didn't change, prevent error in TimeRange.include(date)
<span class="nc bnc" id="L3708" title="All 6 branches missed.">		if (spIDMap != null &amp;&amp; !spIDMap.isEmpty() &amp;&amp; startTime != null) {</span>

<span class="nc" id="L3710">			ID loopSpId = null;</span>
<span class="nc" id="L3711">			retColl = new ArrayList&lt;ID&gt;();</span>

<span class="nc" id="L3713">			Iterator it = spIDMap.entrySet().iterator();</span>
<span class="nc bnc" id="L3714" title="All 2 branches missed.">			while (it.hasNext()) {</span>
<span class="nc" id="L3715">				Map.Entry&lt;ID, Pair&lt;Date, Date&gt;&gt; mapEntry = (Map.Entry&lt;ID, Pair&lt;Date, Date&gt;&gt;) it.next();</span>
<span class="nc" id="L3716">				spTimeRange = new TimeRange(mapEntry.getValue().getFirst(), mapEntry.getValue().getSecond());</span>

<span class="nc bnc" id="L3718" title="All 2 branches missed.">				if (spTimeRange.includes(startTime)) {</span>
<span class="nc" id="L3719">					retColl.add(mapEntry.getKey());</span>
				}
<span class="nc" id="L3721">			}</span>
			// As the CUSTOM Shift Request table has 1 to 1 mapping to SPID , we return only one SPID.
		}

<span class="nc bnc" id="L3725" title="All 4 branches missed.">		return (retColl != null &amp;&amp; !retColl.isEmpty()) ? retColl.get(0) : null;</span>
	}

	/**
	 * Return the minimum non-null Date.
	 */

	protected Date minOfThreeDates(Date d1, Date d2, Date d3) {
<span class="nc" id="L3733">		return minOfTwoDates(minOfTwoDates(d1, d2), d3);</span>
	}

	/**
	 * Return the minimum non-null Date.
	 */
	protected Date minOfTwoDates(Date d1, Date d2) {
<span class="nc bnc" id="L3740" title="All 4 branches missed.">		if (d1 == null &amp;&amp; d2 == null) {</span>
<span class="nc" id="L3741">			return null;</span>
		}

<span class="nc bnc" id="L3744" title="All 2 branches missed.">		if (d1 == null) {</span>
<span class="nc" id="L3745">			return d2;</span>
		}

<span class="nc bnc" id="L3748" title="All 2 branches missed.">		if (d2 == null) {</span>
<span class="nc" id="L3749">			return d1;</span>
		}

<span class="nc bnc" id="L3752" title="All 2 branches missed.">		if (d1.before(d2)) {</span>
<span class="nc" id="L3753">			return d1;</span>
		}

<span class="nc" id="L3756">		return d2;</span>
	}

	/**
	 * Return the maximum non-null Date.
	 */

	protected Date maxOfThreeDates(Date d1, Date d2, Date d3) {
<span class="nc" id="L3764">		return maxOfTwoDates(maxOfTwoDates(d1, d2), d3);</span>
	}

	/**
	 * Return the maximum non-null Date.
	 */
	protected Date maxOfTwoDates(Date d1, Date d2) {
<span class="nc bnc" id="L3771" title="All 4 branches missed.">		if (d1 == null &amp;&amp; d2 == null) {</span>
<span class="nc" id="L3772">			return null;</span>
		}

<span class="nc bnc" id="L3775" title="All 2 branches missed.">		if (d1 == null) {</span>
<span class="nc" id="L3776">			return d2;</span>
		}

<span class="nc bnc" id="L3779" title="All 2 branches missed.">		if (d2 == null) {</span>
<span class="nc" id="L3780">			return d1;</span>
		}

<span class="nc bnc" id="L3783" title="All 2 branches missed.">		if (d1.after(d2)) {</span>
<span class="nc" id="L3784">			return d1;</span>
		}

<span class="nc" id="L3787">		return d2;</span>
	}

	protected boolean isNull(Object o1) {
<span class="nc bnc" id="L3791" title="All 6 branches missed.">		return o1 == null || o1.equals(NONE_ID) || o1.equals(CUSTOM_ID);</span>
	}

	protected boolean areValuesEqual(Object o1, Object o2) {
<span class="nc bnc" id="L3795" title="All 4 branches missed.">		if (isNull(o1) &amp;&amp; isNull(o2)) {</span>
<span class="nc" id="L3796">			return true;</span>
		}

<span class="nc bnc" id="L3799" title="All 4 branches missed.">		if (isNull(o1) || isNull(o2)) {</span>
<span class="nc" id="L3800">			return false;</span>
		}

<span class="nc" id="L3803">		return o1.equals(o2);</span>
	}

	/**
	 * Return the Custom Shift Request
	 */
	public CustShiftReq getCustShiftRequestForSaving() throws Exception {
		// we need to clone the CustShiftReq because we are going to modify it
		// for saving,
		// but we still need the original object for when the page reloads.
<span class="nc" id="L3813">		CustShiftReq requestForSaving = (CustShiftReq) m_customShiftRequest.clone();</span>
<span class="nc" id="L3814">		prepareRequestForSaving(requestForSaving);</span>

<span class="nc bnc" id="L3816" title="All 2 branches missed.">		if (!validateRequestIsDifferentThanShiftAssignment(requestForSaving)</span>
<span class="nc bnc" id="L3817" title="All 2 branches missed.">				|| !validateRequestIsInTheFuture(requestForSaving)</span>
<span class="nc bnc" id="L3818" title="All 4 branches missed.">				|| (!LicenseUtil.isAdvancedRMLicense() &amp;&amp; !validateRequestShiftStartTimeNotAfterExistingShiftStartTime(requestForSaving))) {</span>
<span class="nc" id="L3819">			return null;</span>
		}

<span class="nc" id="L3822">		return requestForSaving;</span>
	}

	/**
	 * Validation for saving a request: Return true if request is different than
	 * what is already scheduled, false if they are the same. If false, then the
	 * request should not be allowed.
	 */
	protected boolean validateRequestIsDifferentThanShiftAssignment(CustShiftReq requestForSaving) {
<span class="nc bnc" id="L3831" title="All 4 branches missed.">		if (requestForSaving.getStartTime() != null &amp;&amp; requestForSaving.getEndTime() != null) {</span>
<span class="nc" id="L3832">			return true;</span>
		}

<span class="nc bnc" id="L3835" title="All 2 branches missed.">		if (isManagerMode()) {</span>
<span class="nc" id="L3836">			addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.CSR_ERROR_NO_CHANGE, RmWebBundleKey.BUNDLE_NAME);</span>
		} else {
<span class="nc" id="L3838">			addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.CSR_ERROR_NO_CHANGE_FOR_AGENT,</span>
					RmWebBundleKey.BUNDLE_NAME);
		}

<span class="nc bnc" id="L3842" title="All 2 branches missed.">		if (!isNew()) {</span>
<span class="nc" id="L3843">			addPageMessage(Message.INFO_TYPE, RmWebBundleKey.CSR_ERROR_YOU_CAN_WITHDRAW_REQUEST,</span>
					RmWebBundleKey.BUNDLE_NAME);
		}

<span class="nc" id="L3847">		return false;</span>
	}

	/**
	 * Validation for saving a request: Return true if request starts in the
	 * future, false if it starts in the past. If false, then the request should
	 * not be allowed.
	 */
	protected boolean validateRequestIsInTheFuture(CustShiftReq requestForSaving) {
<span class="nc bnc" id="L3856" title="All 2 branches missed.">		if (requestForSaving.getStartTime().after(new Date())) {</span>
<span class="nc" id="L3857">			return true;</span>
		}

<span class="nc" id="L3860">		addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.CSR_ERROR_EXPIRED, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L3861">		return false;</span>
	}

	/**
	 * Validation for saving a request: Return false if the existing shift has already started AND
	 * the shift start time of the change request is different from the start time of the existing shift
	 * 
	 * @param requestForSaving
	 * @return
	 */
	protected boolean validateRequestShiftStartTimeNotAfterExistingShiftStartTime(CustShiftReq requestForSaving) {
<span class="nc" id="L3872">		boolean rtnVal = true;</span>
<span class="nc" id="L3873">		Date curTime = new Date();</span>
<span class="nc bnc" id="L3874" title="All 4 branches missed.">		if (isShiftChangeRequest() &amp;&amp; m_shiftAssignment.getStartTime().before(curTime)</span>
<span class="nc bnc" id="L3875" title="All 2 branches missed.">				&amp;&amp; !requestForSaving.getShiftStartTime().equals(m_shiftAssignment.getStartTime())) {</span>
<span class="nc" id="L3876">			addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.CSR_INVALID_CHANGED_SHIFT_START, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L3877">			rtnVal = false;</span>
		}

<span class="nc" id="L3880">		return rtnVal;</span>
	}

	/**
	 * Returns true if the main Shift dropdown and Start Time Picker should be
	 * editable.
	 */
	protected boolean isShiftEditable() {
<span class="nc bnc" id="L3888" title="All 2 branches missed.">		return !nothingIsEditableWithoutAskingComponents()</span>
<span class="nc bnc" id="L3889" title="All 4 branches missed.">				&amp;&amp; (isNewShiftRequest() || (!CustomShiftUtil.saHasExtBefore(m_shiftAssignment)</span>
<span class="nc bnc" id="L3890" title="All 10 branches missed.">						&amp;&amp; !CustomShiftUtil.saHasExtAfter(m_shiftAssignment)))</span>
				&amp;&amp; (m_allowNewShifts || m_allowShiftChanges) &amp;&amp; (m_allowRegularShifts || m_allowOTShifts);
	}

	/**
	 * Returns true if the main shift should be optimized for the user's net
	 * staffing ribbon selection.
	 */
	protected boolean isShiftOptimizable() {
<span class="nc bnc" id="L3899" title="All 4 branches missed.">		return (m_ribbonStartDate != null) &amp;&amp; isShiftEditable();</span>
	}

	/**
	 * Returns true if the main Activity dropdown should be editable.
	 */
	protected boolean isActivityEditable() {
		// cannot change activity when making a &quot;Shift Change&quot; request
<span class="nc bnc" id="L3907" title="All 4 branches missed.">		return !nothingIsEditableWithoutAskingComponents() &amp;&amp; isNewShiftRequest();</span>
	}

	/**
	 * Returns true if the extension before the shift should be editable.
	 */
	protected boolean isExtBeforeEditable() {
<span class="nc bnc" id="L3914" title="All 2 branches missed.">		return !nothingIsEditableWithoutAskingComponents()</span>
<span class="nc bnc" id="L3915" title="All 8 branches missed.">				&amp;&amp; (isNewShiftRequest() || !CustomShiftUtil.saHasExtBefore(m_shiftAssignment))</span>
				&amp;&amp; (m_allowRegularExtBeforeShifts || m_allowOTExtBeforeShifts) &amp;&amp;
				// new shift requests must have a shift, so we make sure they
				// can request a shift, else we disable whole page.
<span class="nc bnc" id="L3919" title="All 10 branches missed.">				(isNewShiftRequest() ? m_allowNewShifts &amp;&amp; (m_allowRegularShifts || m_allowOTShifts)</span>
						: m_allowShiftChanges)
				&amp;&amp;
				// Adding/changing extensions to the request should not be
				// allowed when the main shift is marked as Overtime.
<span class="nc bnc" id="L3924" title="All 2 branches missed.">				!isOvertimeChecked();</span>
	}

	/**
	 * Returns true if the extension before the shift should be enablable (able
	 * to be enabled) from JavaScript, by unchecking the main shift's IsOT
	 * setting.
	 */
	protected boolean isExtBeforeEnablable() {
<span class="nc bnc" id="L3933" title="All 2 branches missed.">		return !nothingIsEditableWithoutAskingComponents()</span>
<span class="nc bnc" id="L3934" title="All 8 branches missed.">				&amp;&amp; (isNewShiftRequest() || !CustomShiftUtil.saHasExtBefore(m_shiftAssignment))</span>
				&amp;&amp; (m_allowRegularExtBeforeShifts || m_allowOTExtBeforeShifts) &amp;&amp;
				// new shift requests must have a shift, so we make sure they
				// can request a shift, else we disable whole page.
<span class="nc bnc" id="L3938" title="All 10 branches missed.">				(isNewShiftRequest() ? m_allowNewShifts &amp;&amp; (m_allowRegularShifts || m_allowOTShifts)</span>
						: m_allowShiftChanges);
	}

	/**
	 * Returns true if the extension before the shift should be optimized for
	 * the user's net staffing ribbon selection.
	 */
	protected boolean isExtBeforeOptimizable() {
<span class="nc bnc" id="L3947" title="All 4 branches missed.">		return (m_ribbonStartDate != null) &amp;&amp; isExtBeforeEditable()</span>
<span class="nc bnc" id="L3948" title="All 2 branches missed.">				&amp;&amp; !CustomShiftUtil.saHasExtBefore(m_shiftAssignment);</span>
	}

	/**
	 * Returns true if the extension after the shift should be editable.
	 */
	protected boolean isExtAfterEditable() {
<span class="nc bnc" id="L3955" title="All 2 branches missed.">		return !nothingIsEditableWithoutAskingComponents()</span>
<span class="nc bnc" id="L3956" title="All 8 branches missed.">				&amp;&amp; (isNewShiftRequest() || !CustomShiftUtil.saHasExtAfter(m_shiftAssignment))</span>
				&amp;&amp; (m_allowRegularExtAfterShifts || m_allowOTExtAfterShifts) &amp;&amp;
				// new shift requests must have a shift, so we make sure they
				// can request a shift, else we disable whole page.
<span class="nc bnc" id="L3960" title="All 10 branches missed.">				(isNewShiftRequest() ? m_allowNewShifts &amp;&amp; (m_allowRegularShifts || m_allowOTShifts)</span>
						: m_allowShiftChanges)
				&amp;&amp;
				// Adding/changing extensions to the request should not be
				// allowed when the main shift is marked as Overtime.
<span class="nc bnc" id="L3965" title="All 2 branches missed.">				!isOvertimeChecked();</span>
	}

	/**
	 * Returns true if the extension after the shift should be enablable (able
	 * to be enabled) from JavaScript, by unchecking the main shift's IsOT
	 * setting.
	 */
	protected boolean isExtAfterEnablable() {
<span class="nc bnc" id="L3974" title="All 2 branches missed.">		return !nothingIsEditableWithoutAskingComponents()</span>
<span class="nc bnc" id="L3975" title="All 8 branches missed.">				&amp;&amp; (isNewShiftRequest() || !CustomShiftUtil.saHasExtAfter(m_shiftAssignment))</span>
				&amp;&amp; (m_allowRegularExtAfterShifts || m_allowOTExtAfterShifts) &amp;&amp;
				// new shift requests must have a shift, so we make sure they
				// can request a shift, else we disable whole page.
<span class="nc bnc" id="L3979" title="All 10 branches missed.">				(isNewShiftRequest() ? m_allowNewShifts &amp;&amp; (m_allowRegularShifts || m_allowOTShifts)</span>
						: m_allowShiftChanges);
	}

	protected boolean isExtDuringGapEditable() {
<span class="nc bnc" id="L3984" title="All 2 branches missed.">		return !nothingIsEditableWithoutAskingComponents()</span>
<span class="nc bnc" id="L3985" title="All 6 branches missed.">				&amp;&amp; (isNewShiftRequest() || !duringGaps.isEmpty())</span>
				&amp;&amp; m_allowRegularDuringGapShifts &amp;&amp;
				// new shift requests must have a shift, so we make sure they
				// can request a shift, else we disable whole page.
<span class="nc bnc" id="L3989" title="All 10 branches missed.">				(isNewShiftRequest() ? m_allowNewShifts &amp;&amp; (m_allowRegularShifts || m_allowOTShifts)</span>
						: m_allowShiftChanges);
	}

	protected boolean isExtDuringGapEnablable() {
<span class="nc bnc" id="L3994" title="All 2 branches missed.">		return !nothingIsEditableWithoutAskingComponents()</span>
<span class="nc bnc" id="L3995" title="All 6 branches missed.">				&amp;&amp; (isNewShiftRequest() || !duringGaps.isEmpty())</span>
				&amp;&amp; m_allowRegularDuringGapShifts &amp;&amp;
				// new shift requests must have a shift, so we make sure they
				// can request a shift, else we disable whole page.
<span class="nc bnc" id="L3999" title="All 8 branches missed.">				(isNewShiftRequest() ? m_allowNewShifts &amp;&amp; m_allowRegularShifts</span>
						: m_allowShiftChanges);
	}

	/**
	 * Returns true if the extension After the shift should be optimized for the
	 * user's net staffing ribbon selection.
	 */
	protected boolean isExtAfterOptimizable() {
<span class="nc bnc" id="L4008" title="All 6 branches missed.">		return (m_ribbonStartDate != null) &amp;&amp; isExtAfterEditable() &amp;&amp; !CustomShiftUtil.saHasExtAfter(m_shiftAssignment);</span>
	}

	/**
	 * Returns true if the shift, extension before, and extension after are NOT
	 * editable.
	 */
	protected boolean nothingIsEditable() {
<span class="nc bnc" id="L4016" title="All 4 branches missed.">		return nothingIsEditableDueToNoData() || nothingIsEditableDueToOrgSettings()</span>
<span class="nc bnc" id="L4017" title="All 4 branches missed.">				|| nothingIsEditableAccordingToComponents() || nothingIsEditableDueToNoDeficientActivities();</span>
	}

	/**
	 * Returns true if the shift, extension before, and extension after are NOT
	 * editable due to either No data, Org settings, or No deficient activities.
	 */
	protected boolean nothingIsEditableWithoutAskingComponents() {
<span class="nc bnc" id="L4025" title="All 4 branches missed.">		return nothingIsEditableDueToNoData() || nothingIsEditableDueToOrgSettings()</span>
<span class="nc bnc" id="L4026" title="All 2 branches missed.">				|| nothingIsEditableDueToNoDeficientActivities();</span>
	}

	/**
	 * Returns true if the shift, extension before, and extension after are NOT
	 * editable.
	 */
	protected boolean nothingIsEditableAccordingToComponents() {
<span class="nc bnc" id="L4034" title="All 8 branches missed.">		return (!isShiftEditable() &amp;&amp; !isExtBeforeEditable() &amp;&amp; !isExtAfterEditable() &amp;&amp; !isExtDuringGapEditable());</span>
	}

	/**
	 * Returns true if the shift, extension before, and extension after are NOT
	 * editable due to the fact that the user is not eligible for any Shifts on
	 * the selected day.
	 */
	protected boolean nothingIsEditableDueToNoData() {
<span class="nc bnc" id="L4043" title="All 6 branches missed.">		return m_spID == null || m_shifts == null || m_shifts.isEmpty();</span>
	}

	/**
	 * Returns true if nothing is editable due to the fact that we're in
	 * optimize ribbon mode, yet there are no deficient activities.
	 *
	 * @return
	 */
	protected boolean nothingIsEditableDueToNoDeficientActivities() {
<span class="nc bnc" id="L4053" title="All 6 branches missed.">		return (isRibbonApplicable() &amp;&amp; m_mostDeficientActivity1 == null &amp;&amp; m_mostDeficientActivity2 == null);</span>
	}

	/**
	 * Returns true if the shift, extension before, and extension after are NOT
	 * editable due to the fact that the organization's RM Settings (Custom
	 * Shift Requests section) are disabled.
	 */
	protected boolean nothingIsEditableDueToOrgSettings() {
<span class="nc bnc" id="L4062" title="All 8 branches missed.">		return (isNewShiftRequest() &amp;&amp; !m_allowNewShifts) || (isShiftChangeRequest() &amp;&amp; !m_allowShiftChanges)</span>
<span class="nc bnc" id="L4063" title="All 6 branches missed.">				|| (isNewShiftRequest() &amp;&amp; !m_allowRegularShifts &amp;&amp; !m_allowOTShifts)</span>
<span class="nc bnc" id="L4064" title="All 4 branches missed.">				|| (isShiftChangeRequest() &amp;&amp; !CustomShiftUtil.saHasExtBefore(m_shiftAssignment)</span>
<span class="nc bnc" id="L4065" title="All 4 branches missed.">						&amp;&amp; CustomShiftUtil.saHasExtAfter(m_shiftAssignment) &amp;&amp; doesNotAllowExtensionsBefore())</span>
<span class="nc bnc" id="L4066" title="All 4 branches missed.">				|| (isShiftChangeRequest() &amp;&amp; CustomShiftUtil.saHasExtBefore(m_shiftAssignment)</span>
<span class="nc bnc" id="L4067" title="All 4 branches missed.">						&amp;&amp; !CustomShiftUtil.saHasExtAfter(m_shiftAssignment) &amp;&amp; doesNotAllowExtensionsAfter());</span>

	}

	private boolean doesNotAllowExtensionsBefore() {
<span class="nc bnc" id="L4072" title="All 4 branches missed.">		return (!m_allowRegularExtBeforeShifts &amp;&amp; !m_allowOTExtBeforeShifts);</span>
	}

	private boolean doesNotAllowExtensionsAfter() {
<span class="nc bnc" id="L4076" title="All 4 branches missed.">		return (!m_allowRegularExtAfterShifts &amp;&amp; !m_allowOTExtAfterShifts);</span>
	}

	/**
	 * Determines when to use the duration from the OT Extension before a shift.
	 *
	 * @return True is OT Before Extension change or not using 1-Minute granularity, false otherwise
	 */
	private boolean useOTExtensionBeforeDuration() {
<span class="nc bnc" id="L4085" title="All 2 branches missed.">		if (m_reloadAction.equals(RELOAD_ACTION_EXT_BEFORE)) {</span>
<span class="nc" id="L4086">			return true;</span>
<span class="nc bnc" id="L4087" title="All 4 branches missed.">		} else if (denyOTDurationEdit &amp;&amp; m_reloadAction.equals(RELOAD_ACTION_TIME)) {</span>
<span class="nc" id="L4088">			return true;</span>
<span class="nc bnc" id="L4089" title="All 4 branches missed.">		} else if (denyOTDurationEdit &amp;&amp; m_reloadAction.equals(&quot;&quot;)) {</span>
<span class="nc" id="L4090">			return false;</span>
		} else {
<span class="nc" id="L4092">			return false;</span>
		}
	}

	/**
	 * Determines when to use the duration from the OT Extension after a shift.
	 *
	 * @return True is OT Before Extension change or not using 1-Minute granularity, false otherwise
	 */
	private boolean useOTExtensionAfterDuration() {
<span class="nc bnc" id="L4102" title="All 2 branches missed.">		if (m_reloadAction.equals(RELOAD_ACTION_EXT_AFTER)) {</span>
<span class="nc" id="L4103">			return true;</span>
<span class="nc bnc" id="L4104" title="All 4 branches missed.">		} else if (denyOTDurationEdit &amp;&amp; m_reloadAction.equals(RELOAD_ACTION_TIME)) {</span>
<span class="nc" id="L4105">			return true;</span>
<span class="nc bnc" id="L4106" title="All 4 branches missed.">		} else if (denyOTDurationEdit &amp;&amp; m_reloadAction.equals(&quot;&quot;)) {</span>
<span class="nc" id="L4107">			return false;</span>
		} else {
<span class="nc" id="L4109">			return false;</span>
		}
	}

	/**
	 * Determines when to use the duration from the OT Extension during a gap.
	 *
	 * @return True is OT Before Extension change or not using 1-Minute granularity, false otherwise
	 */
	private boolean useOTExtensionDuringGapDuration() {
<span class="nc bnc" id="L4119" title="All 2 branches missed.">		if (m_reloadAction.equals(RELOAD_ACTION_DURING_GAP)) {</span>
<span class="nc" id="L4120">			return true;</span>
<span class="nc bnc" id="L4121" title="All 4 branches missed.">		} else if (denyOTDurationEdit &amp;&amp; m_reloadAction.equals(RELOAD_ACTION_TIME)) {</span>
<span class="nc" id="L4122">			return true;</span>
<span class="nc bnc" id="L4123" title="All 4 branches missed.">		} else if (denyOTDurationEdit &amp;&amp; m_reloadAction.equals(&quot;&quot;)) {</span>
<span class="nc" id="L4124">			return false;</span>
		} else {
<span class="nc" id="L4126">			return false;</span>
		}
	}

	/**
	 * Determine whether this user has the privilege to create a custom shift
	 * request.
	 *
	 * @param isManagerPage
	 *            - pass true if the is the manager page (Tracking\Schedules).
	 *            Pass false for the agent page (My Home\My Schedule).
	 */
	public static boolean getCanCreateCustomShiftRequest(RequestContext context, boolean isManagerPage) {
<span class="nc" id="L4139">		boolean returnValue = false;</span>

<span class="nc bnc" id="L4141" title="All 2 branches missed.">		if (isManagerPage) {</span>
<span class="nc" id="L4142">			returnValue = context.getUser().isAuthorized(PrivilegeKeys.CS_MODIFYREQUESTSFOREMPLOYEE);</span>
		} else {
<span class="nc" id="L4144">			returnValue = context.getUser().isAuthorized(PrivilegeKeys.CS_MODIFYPERSONALREQUESTS);</span>
		}

<span class="nc" id="L4147">		log.debug(&quot; getCanCreateCustomShiftRequest boolFlag=&quot; + returnValue);</span>
<span class="nc" id="L4148">		return returnValue;</span>
	}

	private void addLabelValueRow508(Collapsible2ColFormPC container, String label, String value) {
<span class="nc" id="L4152">		String labelID = &quot;label&quot; + label.hashCode() + &quot;_ID&quot;;</span>
<span class="nc" id="L4153">		String valueID = &quot;value&quot; + value.hashCode() + &quot;_ID&quot;;</span>
<span class="nc" id="L4154">		String labelWithID = HtmlUtil.makeSpanWithId(label, labelID);</span>
<span class="nc" id="L4155">		String valueWithLabel = HtmlUtil.getTabbableLabel(HtmlUtil.makeSpanWithId(value, valueID), Arrays.asList(labelID, valueID));</span>
<span class="nc" id="L4156">		container.addRow(labelWithID, valueWithLabel);</span>
<span class="nc" id="L4157">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>