<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftPatternDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.workrules.ejb</a> &gt; <span class="el_source">ShiftPatternDAO.java</span></div><h1>ShiftPatternDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.workrules.ejb;

import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.PaginationPair;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.localization.LocaleContext;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignFieldInfo;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.dao.DAOUtil;
import com.bluepumpkin.ejb.bbm.dao.JunctionTableRelationship;
import com.bluepumpkin.ejb.bbm.dao.OneToManyRelationship;
import com.bluepumpkin.ejb.bbm.dao.RichObjectDAO;
import com.bluepumpkin.ejb.bbm.vo.DBSortField;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTypeFieldInfo;
import com.bluepumpkin.ejb.bbm.workresource.model.OrganizationFieldInfo;
import com.bluepumpkin.ejb.bbm.workrules.model.Shift;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftGroup;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftGroupFieldInfo;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftGroupShift;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftOTExtension;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPatternFieldInfo;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPatternOTExtension;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPatternShift;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPatternShiftAttributes;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPatternSortField;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPatternVTOEvent;
import com.bluepumpkin.ejb.bbm.workrules.model.VTOEvent;
import com.bluepumpkin.ejb.bbm.workrules.model.WorkRuleUtil;
import com.witness.ejb.bbm.copy.ejb.CopyDAO;

public class ShiftPatternDAO extends RichObjectDAO&lt;ShiftPattern&gt; {
	
	private ShiftPatternVTOEventDAO shiftPatternVTODAO;
	private VTOEventDAO vtoDAO;
	private ShiftPatternOTExtensionDAO shiftPatternOTDAO;
	private ShiftOTExtensionDAO shiftOTDAO;
	private ShiftPatternShiftDAO shiftPatternShiftDAO;
	private ShiftDAO shiftDAO;
	private ShiftGroupDAO shiftGroupDAO;
	
	////
	private ID ownerID;
	private boolean isByOrg;
	private LocaleContext localeContext;
	////

	// meta data information
<span class="fc" id="L68">	private static FieldInfo m_fieldInfo = new ShiftPatternFieldInfo();</span>
<span class="fc" id="L69">	protected FieldInfo getFieldInfo() { return m_fieldInfo; }</span>
<span class="fc" id="L70">	private EmployeeTypeFieldInfo etfi = new EmployeeTypeFieldInfo();</span>
<span class="fc" id="L71">	private OrganizationFieldInfo ofi = new OrganizationFieldInfo();</span>
	
<span class="fc" id="L73">	private final String organizationSortFieldKey = ofi.getTableName() + &quot;_&quot; + ofi.getFieldName(OrganizationFieldInfo.ORGANIZATION_NAME);</span>

	protected ShiftPattern createValueObject() {
<span class="fc" id="L76">		return new ShiftPattern();</span>
	}

	public ShiftPatternDAO() {
<span class="fc" id="L80">		super();</span>
<span class="fc" id="L81">	}</span>

	public ShiftPatternDAO(Jdmo dmo) {
<span class="fc" id="L84">		super(dmo);</span>
<span class="fc" id="L85">	}</span>
	
	@Override
	protected void buildDBRelationships() {
<span class="fc" id="L89">		shiftPatternVTODAO = new ShiftPatternVTOEventDAO(m_dmo);</span>
<span class="fc" id="L90">		vtoDAO = new VTOEventDAO(m_dmo);</span>
<span class="fc" id="L91">		shiftPatternOTDAO = new ShiftPatternOTExtensionDAO(m_dmo);</span>
<span class="fc" id="L92">		shiftOTDAO = new ShiftOTExtensionDAO(m_dmo);</span>
		
<span class="fc" id="L94">		shiftPatternShiftDAO = new ShiftPatternShiftDAO(m_dmo);</span>
<span class="fc" id="L95">		shiftDAO = new ShiftDAO(m_dmo);</span>
<span class="fc" id="L96">		shiftGroupDAO = new ShiftGroupDAO(m_dmo);</span>
		
<span class="fc" id="L98">		addRelationship(new JunctionTableRelationship(this, vtoDAO, shiftPatternVTODAO,</span>
<span class="fc" id="L99">				getFieldInfo().getFieldIndexByName(&quot;ID&quot;),</span>
<span class="fc" id="L100">				shiftPatternVTODAO.getFieldInfo().getFieldIndexByName(&quot;SHIFTPATTERNID&quot;),</span>
<span class="fc" id="L101">				shiftPatternVTODAO.getFieldInfo().getFieldIndexByName(&quot;VTOEVENTID&quot;), </span>
<span class="fc" id="L102">				vtoDAO.getFieldInfo().getFieldIndexByName(&quot;ID&quot;), ShiftPattern.VTO_EVENT_RELATIONSHIP_KEY));	</span>
<span class="fc" id="L103">		addRelationship(new JunctionTableRelationship(this, shiftOTDAO, shiftPatternOTDAO,</span>
<span class="fc" id="L104">				getFieldInfo().getFieldIndexByName(&quot;ID&quot;),</span>
<span class="fc" id="L105">				shiftPatternOTDAO.getFieldInfo().getFieldIndexByName(&quot;SHIFTPATTERNID&quot;),</span>
<span class="fc" id="L106">				shiftPatternOTDAO.getFieldInfo().getFieldIndexByName(&quot;SHIFTOTEXTENSIONID&quot;), </span>
<span class="fc" id="L107">				shiftOTDAO.getFieldInfo().getFieldIndexByName(&quot;ID&quot;),</span>
				ShiftPattern.SHIFT_OT_EXTENSION_RELATIONSHIP_KEY));	
<span class="fc" id="L109">		addRelationship(new JunctionTableRelationship(this, shiftDAO, shiftPatternShiftDAO,</span>
<span class="fc" id="L110">				getFieldInfo().getFieldIndexByName(&quot;ID&quot;),</span>
<span class="fc" id="L111">				shiftPatternShiftDAO.getFieldInfo().getFieldIndexByName(&quot;SHIFTPATTERNID&quot;),</span>
<span class="fc" id="L112">				shiftPatternShiftDAO.getFieldInfo().getFieldIndexByName(&quot;SHIFTID&quot;), </span>
<span class="fc" id="L113">				shiftDAO.getFieldInfo().getFieldIndexByName(&quot;ID&quot;), ShiftPattern.SHIFT_RELATIONSHIP_KEY));</span>
<span class="fc" id="L114">		addRelationship(new OneToManyRelationship(this, shiftGroupDAO, getFieldInfo().getFieldIndexByName(&quot;ID&quot;),</span>
<span class="fc" id="L115">				shiftGroupDAO.getFieldInfo().getFieldIndexByName(&quot;SHIFTPATTERNID&quot;),</span>
				ShiftPattern.SHIFTGROUP_RELATIONSHIP_KEY));
<span class="fc" id="L117">	}</span>
	
	
	/**
	 * Returns a complete list of IDs and the first chunk of data to be displayed
	 * @param orgID
	 * @param isAscendingSort
	 * @param pageIDSize
	 * @param pageIndex
	 * @param sortFieldMap
	 * @param filteredIDs
	 * @param filterByName
	 * @return
	 * @throws BbmFinderException
	 */
	public PaginationPair&lt;ShiftPattern&gt; getCompletePaginationDataSetForOrg(ID orgID, boolean isAscendingSort, int pageIDSize,
			int pageIndex, LinkedHashMap&lt;DBSortField, Comparator&gt; sortFieldMap,
			Collection&lt;ID&gt; filteredIDs, String filterByName) throws BbmFinderException {
<span class="fc" id="L135">		StringBuffer whereClause = new StringBuffer();</span>
<span class="fc" id="L136">		whereClause.append(DAOUtil.getCurrentObjectsByOrgHierarchySQLString(orgID));</span>
<span class="pc bpc" id="L137" title="3 of 4 branches missed.">		if (filterByName != null &amp;&amp; filterByName.length() &gt; 0) {</span>
<span class="nc" id="L138">			whereClause.append(&quot; AND A.&quot; + getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_NAME) + &quot; LIKE '%&quot;).</span>
<span class="nc" id="L139">			append(filterByName.replaceAll(&quot;'&quot;, &quot;''&quot;)).append(&quot;%'&quot;);</span>
		}
<span class="fc" id="L141">		return getCompletePaginationDataSet(whereClause.toString(),</span>
				isAscendingSort, pageIDSize, pageIndex, sortFieldMap, filteredIDs);
	}
	
	public PaginationPair&lt;ShiftPattern&gt; getCompleteWeeklyPaginationDataSetForOrg(ID orgID, boolean isAscendingSort, int pageIDSize,
			int pageIndex, LinkedHashMap&lt;DBSortField, Comparator&gt; sortFieldMap,
			Collection&lt;ID&gt; filteredIDs,String filterByName) throws BbmFinderException {
<span class="nc" id="L148">		StringBuffer whereClause = new StringBuffer();</span>
<span class="nc" id="L149">		whereClause.append(DAOUtil.getCurrentObjectsByOrgHierarchySQLString(orgID) + &quot; AND &quot; +</span>
<span class="nc" id="L150">				getMonthlyWorkPatternFilterClause());</span>
<span class="nc bnc" id="L151" title="All 4 branches missed.">		if (filterByName != null &amp;&amp; filterByName.length() &gt; 0) {</span>
<span class="nc" id="L152">			whereClause.append(&quot; AND A.&quot; + getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_NAME) + &quot; LIKE '%&quot;).</span>
<span class="nc" id="L153">			append(filterByName.replaceAll(&quot;'&quot;, &quot;''&quot;)).append(&quot;%'&quot;);</span>
		}
<span class="nc" id="L155">		return getCompletePaginationDataSet(whereClause.toString(), isAscendingSort, pageIDSize, pageIndex, sortFieldMap, filteredIDs);</span>
	}
	/**
	 * 
	 * Returns a complete list of IDs and the first chunk of data to be displayed
	 * @param orgID
	 * @param sortFieldIndices
	 * @param isAscendingSort
	 * @return
	 * @throws BbmFinderException
	 */
	
	
	public PaginationPair&lt;ShiftPattern&gt; getCompletePaginationDataSetForSchedulingPeriod(SchedulingPeriod sp,
			boolean isAscendingSort, int pageIDSize, int pageIndex,
			LinkedHashMap&lt;DBSortField, Comparator&gt; sortFieldMap, Collection&lt;ID&gt; filteredIDs,String filterByName)
			throws BbmFinderException {
<span class="nc" id="L172">		StringBuffer whereClause = new StringBuffer();</span>
<span class="nc" id="L173">		whereClause.append(DAOUtil.getCurrentObjectsBySchedulingPeriodSQLString(sp));</span>
<span class="nc bnc" id="L174" title="All 4 branches missed.">		if (filterByName != null &amp;&amp; filterByName.length() &gt; 0) {</span>
<span class="nc" id="L175">			whereClause.append(&quot; AND A.&quot; + getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_NAME) + &quot; LIKE '%&quot;).</span>
<span class="nc" id="L176">			append(filterByName.replaceAll(&quot;'&quot;, &quot;''&quot;)).append(&quot;%'&quot;);</span>
		}
<span class="nc" id="L178">		return getCompletePaginationDataSet(whereClause.toString(),</span>
				isAscendingSort, pageIDSize, pageIndex, sortFieldMap, filteredIDs);
	}

	
	public PaginationPair&lt;ShiftPattern&gt; getCompleteWeeklyPaginationDataSetForSchedulingPeriod(SchedulingPeriod sp,
			boolean isAscendingSort, int pageIDSize, int pageIndex,
			LinkedHashMap&lt;DBSortField, Comparator&gt; sortFieldMap, Collection&lt;ID&gt; filteredIDs)
			throws BbmFinderException {
<span class="nc" id="L187">		return getCompletePaginationDataSet(DAOUtil.getCurrentObjectsBySchedulingPeriodSQLString(sp) + &quot; AND &quot; +</span>
<span class="nc" id="L188">				getMonthlyWorkPatternFilterClause(),</span>
				isAscendingSort, pageIDSize, pageIndex, sortFieldMap, filteredIDs);
	}
	
	/**
	 * Returns the shift patterns defined at a scheduling period (excluding organizationally defined patterns).
	 * @param sp Scheduling period.
	 * @return Collection of shift patterns
	 * @throws BbmFinderException
	 */
	public Collection&lt;ShiftPattern&gt; getShiftPatternsBySchedulingPeriodCampaignOnly(SchedulingPeriod sp) throws BbmFinderException {
<span class="nc" id="L199">		return getObjects(DAOUtil.getCurrentObjectsBySchedulingPeriodCampaignOnlySQLString(sp));</span>
	}

	public PaginationPair&lt;ShiftPattern&gt; getAvailableShiftPatternsForEmployees(Collection&lt;ID&gt; orgIDsAndParents,
			Collection&lt;ID&gt; spOrgsAndParents,
			Collection&lt;ID&gt; workResourceIDs,
			Date startDate,
			Date endDate,
			ID employeeTypeID,
			SchedulingPeriod selectedSchedulingPeriod,
			boolean isAscendingSort,
			int pageIDSize,
			int pageIndex,
			LinkedHashMap&lt;DBSortField, Comparator&gt; sortFieldMap,
			Collection&lt;ID&gt; filteredIDs,
			String filterByName) throws BbmFinderException {
		try {
<span class="fc" id="L216">			StringBuffer where = new StringBuffer(&quot;A.DELETEONDATE IS NULL AND (A.ORGANIZATIONID IN &quot;);</span>
			
<span class="pc bpc" id="L218" title="3 of 6 branches missed.">			if (selectedSchedulingPeriod == null &amp;&amp; orgIDsAndParents != null &amp;&amp; orgIDsAndParents.size() &gt; 0) {</span>
<span class="fc" id="L219">				where.append(getDMO().createInClause(orgIDsAndParents));</span>
			} else {
<span class="nc" id="L221">				where.append(getDMO().createInClause(spOrgsAndParents));</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">				if (selectedSchedulingPeriod.getCampaignID() != null) {</span>
<span class="nc" id="L223">			 		where.append(&quot; OR A.CAMPAIGNID = &quot; + JdmoUtil.asSqlLiteral(DAOUtil.mapIDToDEID(selectedSchedulingPeriod.getCampaignID(), new CampaignFieldInfo())));</span>
			 	}
			}

<span class="fc" id="L227">			where.append(&quot;)&quot;);</span>
			
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">			if (employeeTypeID != null) {</span>
<span class="fc" id="L230">				where.append(&quot; AND EMPLOYEETYPEID = (SELECT ID FROM EMPLOYEETYPE WHERE SID = &quot; + employeeTypeID + &quot;) &quot;);</span>
			}
			
<span class="pc bpc" id="L233" title="3 of 4 branches missed.">			if (filterByName != null &amp;&amp; filterByName.length() &gt; 0) {</span>
<span class="nc" id="L234">				where.append(&quot; AND A.&quot; + getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_NAME) + &quot; LIKE '%&quot;).</span>
<span class="nc" id="L235">				append(filterByName.replaceAll(&quot;'&quot;, &quot;''&quot;)).append(&quot;%'&quot;);</span>
			}
			
<span class="fc" id="L238">			return getCompletePaginationDataSet(where.toString(),</span>
					isAscendingSort, pageIDSize, pageIndex, sortFieldMap, filteredIDs);
<span class="nc" id="L240">		} catch (JdmoException ex) {</span>
<span class="nc" id="L241">			throw new BbmFinderException(ex);</span>
		}
	}

	public void copyObjects(Collection&lt;ShiftPattern&gt; shiftPatterns) throws BbmFinderException, BbmCreateException {
<span class="nc" id="L246">		super.copyObjects(shiftPatterns);</span>
<span class="nc" id="L247">	}</span>
	
	public void prepObjectsForCopy(Collection&lt;ShiftPattern&gt; shiftPatterns)
	throws BbmFinderException
	{
<span class="nc" id="L252">		super.prepObjectsForCopy(shiftPatterns);</span>
		
<span class="nc" id="L254">		CopyDAO copyDAO = new CopyDAO();</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">		for (ShiftPattern sp : shiftPatterns) {</span>
<span class="nc" id="L256">			sp.setID(null);</span>
<span class="nc" id="L257">			sp.setDEID(null);</span>
<span class="nc" id="L258">			String newName = copyDAO.getNewNameForCopiedValueObjectWithLengthLimitation(sp.getName(),</span>
<span class="nc" id="L259">					getFieldInfo().getTableName(), localeContext, ShiftPatternFieldInfo.SHIFTPATTERN_MAX_NAME_SIZE);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">			if (newName.length() &gt; ShiftPatternFieldInfo.SHIFTPATTERN_MAX_NAME_SIZE) {</span>
<span class="nc" id="L261">				throw new WorkRuleExcessiveNameLengthException(sp.getName());</span>
			}
<span class="nc" id="L263">			sp.setName(newName);</span>
<span class="nc" id="L264">			sp.setCreatedBy(getCallerPrincipal());</span>
<span class="nc" id="L265">			sp.setCreatedDate(new Date());</span>
<span class="nc" id="L266">			sp.setModifiedBy(null);</span>
<span class="nc" id="L267">			sp.setModifiedDate(null);</span>
			
<span class="nc bnc" id="L269" title="All 2 branches missed.">			if (isByOrg) {</span>
<span class="nc" id="L270">				sp.setCampaignID(null);</span>
<span class="nc" id="L271">				sp.setOrganizationID(ownerID);</span>
			} else {
<span class="nc" id="L273">				sp.setOrganizationID(null);</span>
<span class="nc" id="L274">				sp.setCampaignID(ownerID);</span>
			}
<span class="nc" id="L276">		}</span>
<span class="nc" id="L277">	}</span>
	
	public void prepObjectsForCreate(Collection&lt;ShiftPattern&gt; shiftPatterns) {
<span class="fc bfc" id="L280" title="All 2 branches covered.">		for (ShiftPattern shiftPattern : shiftPatterns) {</span>
<span class="fc" id="L281">			shiftPattern.setCreatedBy(getCallerPrincipal());</span>
<span class="fc" id="L282">			shiftPattern.setCreatedDate(new Date());</span>
<span class="fc" id="L283">			ShiftGroup consistencySG = new ShiftGroup();</span>
<span class="fc" id="L284">			consistencySG.setBlocksize(1);			//BlockSize is currently unused and is always set to 1</span>
<span class="fc" id="L285">			consistencySG.setShiftGroupTypeID(ID.fromString(ShiftGroupFieldInfo.SHIFT_GROUP_TYPE_ID_CONSISTENT_START));</span>
<span class="fc" id="L286">			consistencySG.setName(ShiftGroupFieldInfo.SHIFT_GROUP_TYPE_NAME_CONSISTENT_START);</span>
<span class="fc" id="L287">			consistencySG.setCreatedBy(getCallerPrincipal());</span>
<span class="fc" id="L288">			consistencySG.setCreatedDate(new Date());</span>
<span class="fc" id="L289">			shiftPattern.addShiftGroups(Collections.singleton(consistencySG));</span>
<span class="fc" id="L290">			ShiftGroup workDaysSG = new ShiftGroup();</span>
<span class="fc" id="L291">			workDaysSG.setBlocksize(1);</span>
<span class="fc" id="L292">			workDaysSG.setShiftGroupTypeID(ID.fromString(ShiftGroupFieldInfo.SHIFT_GROUP_TYPE_ID_ON));</span>
<span class="fc" id="L293">			workDaysSG.setName(ShiftGroupFieldInfo.SHIFT_GROUP_TYPE_NAME_ON);</span>
<span class="fc" id="L294">			workDaysSG.setCreatedBy(getCallerPrincipal());</span>
<span class="fc" id="L295">			workDaysSG.setCreatedDate(new Date());</span>
<span class="fc" id="L296">			shiftPattern.addShiftGroups(Collections.singleton(workDaysSG));</span>
<span class="fc" id="L297">		}</span>
		
<span class="fc" id="L299">		prepObjectsForUpdate(shiftPatterns);</span>
<span class="fc" id="L300">	}</span>
	
	//We need to set the values in the shiftpattern vo relatedObjectData map before updating
	public void prepObjectsForUpdate(Collection&lt;ShiftPattern&gt; shiftPatterns) {
<span class="fc bfc" id="L304" title="All 2 branches covered.">		for (ShiftPattern shiftPattern : shiftPatterns) {</span>
<span class="fc" id="L305">			shiftPattern.setModifiedBy(getCallerPrincipal());</span>
<span class="fc" id="L306">			shiftPattern.setModifiedDate(new Date());</span>
<span class="fc" id="L307">			HashSet&lt;ShiftGroupShift&gt; consistentShiftGroupShifts = new HashSet&lt;ShiftGroupShift&gt;();</span>
<span class="fc" id="L308">			HashSet&lt;ShiftGroupShift&gt; workDaysShiftGroupShifts = new HashSet&lt;ShiftGroupShift&gt;();</span>

			//SHIFTS
			
			//remove shifts that are no longer in the shiftShiftAttributes map
<span class="fc" id="L313">			HashSet&lt;Shift&gt; shiftsToRemove = new HashSet&lt;Shift&gt;();</span>
<span class="fc bfc" id="L314" title="All 2 branches covered.">			for (Iterator&lt;Shift&gt; iter = shiftPattern.getRelatedObjects(ShiftPattern.SHIFT_RELATIONSHIP_KEY).iterator(); iter.hasNext();) {</span>
<span class="fc" id="L315">				Shift shift = iter.next();</span>
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">				if (shiftPattern.getShiftPatternShiftAttributes().keySet().contains(shift) == false) {</span>
<span class="nc" id="L317">					shiftsToRemove.add(shift);</span>
				}
<span class="fc" id="L319">			}</span>
<span class="fc" id="L320">			shiftPattern.removeRelatedObjects(ShiftPattern.SHIFT_RELATIONSHIP_KEY, shiftsToRemove);</span>
			//Then add the shifts that are in the map but not in related object data.  We also need to construct the ShiftGroup/ShiftGroupShifts
			// from the ShiftPatternShiftAttributes and add those to the related object data as well
<span class="fc bfc" id="L323" title="All 2 branches covered.">			for(Shift shift : shiftPattern.getShiftPatternShiftAttributes().keySet()) {</span>
<span class="fc bfc" id="L324" title="All 2 branches covered.">				if (shiftPattern.getRelatedObjects(ShiftPattern.SHIFT_RELATIONSHIP_KEY).contains(shift) == false) {</span>
<span class="fc" id="L325">					shiftPattern.addRelatedObjects(ShiftPattern.SHIFT_RELATIONSHIP_KEY, Collections.singleton(shift));</span>
				}
<span class="fc" id="L327">				ShiftPatternShiftAttributes attributes = shiftPattern.getShiftPatternShiftAttributes().get(shift);</span>
				//Min consecutive day
<span class="fc" id="L329">				ShiftGroupShift minConsecutiveSgs = new ShiftGroupShift();</span>
<span class="fc" id="L330">				minConsecutiveSgs.setShiftID(shift.getDEID());</span>
<span class="fc" id="L331">				minConsecutiveSgs.setDaySequence(1000);</span>
<span class="fc" id="L332">				minConsecutiveSgs.setValue(attributes.getMinConsecutiveDay());</span>
<span class="fc" id="L333">				workDaysShiftGroupShifts.add(minConsecutiveSgs);</span>
				//Max consecutive day
<span class="fc" id="L335">				ShiftGroupShift maxConsecutiveSgs = new ShiftGroupShift();</span>
<span class="fc" id="L336">				maxConsecutiveSgs.setShiftID(shift.getDEID());</span>
<span class="fc" id="L337">				maxConsecutiveSgs.setDaySequence(1001);</span>
<span class="fc" id="L338">				maxConsecutiveSgs.setValue(attributes.getMaxConsecutiveDay());</span>
<span class="fc" id="L339">				workDaysShiftGroupShifts.add(maxConsecutiveSgs);</span>
				//Is consistent
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">				if (attributes.isConsistentShiftActivities()) {</span>
<span class="nc" id="L342">					ShiftGroupShift isConsistentSgs = new ShiftGroupShift();</span>
<span class="nc" id="L343">					isConsistentSgs.setShiftID(shift.getDEID());</span>
<span class="nc" id="L344">					isConsistentSgs.setDaySequence(1000);</span>
<span class="nc" id="L345">					isConsistentSgs.setValue(1);</span>
<span class="nc" id="L346">					consistentShiftGroupShifts.add(isConsistentSgs);</span>
				}		
				//Work days on/off
<span class="fc bfc" id="L349" title="All 2 branches covered.">				for (Integer day : attributes.getOccurrenceDays()) {</span>
<span class="fc" id="L350">					ShiftGroupShift sgs = new ShiftGroupShift();</span>
<span class="fc" id="L351">					sgs.setShiftID(shift.getDEID());</span>
<span class="fc" id="L352">					sgs.setDaySequence(day);</span>
<span class="fc" id="L353">					sgs.setValue(1);</span>
<span class="fc" id="L354">					workDaysShiftGroupShifts.add(sgs);</span>
<span class="fc" id="L355">				}</span>
				//Shift group
<span class="pc bpc" id="L357" title="1 of 2 branches missed.">				for (Integer day : attributes.getConsistentShiftGroupMap().keySet()) {</span>
<span class="nc" id="L358">					ShiftGroupShift sgs = new ShiftGroupShift();</span>
<span class="nc" id="L359">					sgs.setShiftID(shift.getDEID());</span>
<span class="nc" id="L360">					sgs.setDaySequence(day);</span>
<span class="nc" id="L361">					sgs.setValue(attributes.getConsistentShiftGroupMap().get(day));</span>
<span class="nc" id="L362">					consistentShiftGroupShifts.add(sgs);</span>
<span class="nc" id="L363">				}</span>
<span class="fc" id="L364">			}</span>
<span class="fc" id="L365">			ShiftGroup consistencyShiftGroup = shiftPattern.getConsistencyShiftGroup();</span>
<span class="fc" id="L366">			consistencyShiftGroup.setShiftGroupShifts(consistentShiftGroupShifts);</span>
<span class="fc" id="L367">			shiftPattern.setConsistencyShiftGroup(consistencyShiftGroup);</span>
<span class="fc" id="L368">			ShiftGroup workDaysShiftGroup = shiftPattern.getWorkDaysShiftGroup();</span>
<span class="fc" id="L369">			workDaysShiftGroup.setShiftGroupShifts(workDaysShiftGroupShifts);</span>
<span class="fc" id="L370">			shiftPattern.setWorkDaysShiftGroup(workDaysShiftGroup);</span>
			
			//OT Extensions
			
			//remove ot extensions that are no longer in the ot extensions map
<span class="fc" id="L375">			HashSet&lt;ShiftOTExtension&gt; otExtensionsToRemove = new HashSet&lt;ShiftOTExtension&gt;();</span>
<span class="fc bfc" id="L376" title="All 2 branches covered.">			for (Iterator&lt;ShiftOTExtension&gt; iter = shiftPattern.getRelatedObjects(ShiftPattern.SHIFT_OT_EXTENSION_RELATIONSHIP_KEY).iterator(); iter.hasNext();) {</span>
<span class="fc" id="L377">				ShiftOTExtension otExtension = iter.next();</span>
<span class="pc bpc" id="L378" title="1 of 2 branches missed.">				if (shiftPattern.getShiftPatternShiftAttributes().keySet().contains(otExtension) == false) {</span>
<span class="fc" id="L379">					otExtensionsToRemove.add(otExtension);</span>
				}
<span class="fc" id="L381">			}</span>
<span class="fc" id="L382">			shiftPattern.removeRelatedObjects(ShiftPattern.SHIFT_OT_EXTENSION_RELATIONSHIP_KEY, otExtensionsToRemove);</span>
			//Then add the shift ot extensions that are in the map but not in related object data
<span class="fc bfc" id="L384" title="All 2 branches covered.">			for (ShiftOTExtension sote : shiftPattern.getOTExtensionStartTimes().keySet()) {</span>
<span class="pc bpc" id="L385" title="1 of 2 branches missed.">				if (shiftPattern.getRelatedObjects(ShiftPattern.SHIFT_OT_EXTENSION_RELATIONSHIP_KEY).contains(sote) == false) {</span>
<span class="fc" id="L386">					shiftPattern.addRelatedObjects(ShiftPattern.SHIFT_OT_EXTENSION_RELATIONSHIP_KEY, Collections.singleton(sote));</span>
				}			
<span class="fc" id="L388">			}</span>
			
			//VTO Events
			
			//remove vto events that are no longer in the vto events map
<span class="fc" id="L393">			HashSet&lt;VTOEvent&gt; vtoEventsToRemove = new HashSet&lt;VTOEvent&gt;();</span>
<span class="pc bpc" id="L394" title="1 of 2 branches missed.">			for (Iterator&lt;VTOEvent&gt; iter = shiftPattern.getRelatedObjects(ShiftPattern.VTO_EVENT_RELATIONSHIP_KEY).iterator(); iter.hasNext();) {</span>
<span class="nc" id="L395">				VTOEvent vtoEvent = iter.next();</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">				if (shiftPattern.getShiftPatternShiftAttributes().keySet().contains(vtoEvent) == false) {</span>
<span class="nc" id="L397">					vtoEventsToRemove.add(vtoEvent);</span>
				}
<span class="nc" id="L399">			}</span>
<span class="fc" id="L400">			shiftPattern.removeRelatedObjects(ShiftPattern.VTO_EVENT_RELATIONSHIP_KEY, vtoEventsToRemove);</span>
			//Then add the vto events that are in the map but not in related object data
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">			for (VTOEvent event : shiftPattern.getVTOEventStartTimes().keySet()) {			</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">				if (shiftPattern.getRelatedObjects(ShiftPattern.VTO_EVENT_RELATIONSHIP_KEY).contains(event) == false) {</span>
<span class="nc" id="L404">					shiftPattern.addRelatedObjects(ShiftPattern.VTO_EVENT_RELATIONSHIP_KEY, Collections.singleton(event));</span>
				}	
<span class="nc" id="L406">			}</span>
<span class="fc" id="L407">		}</span>
<span class="fc" id="L408">	}</span>
	
	public void setOwnerID(ID ownerID) {
<span class="nc" id="L411">		this.ownerID = ownerID;</span>
<span class="nc" id="L412">	}</span>
	public void setIsByOrg(boolean isByOrg) {
<span class="nc" id="L414">		this.isByOrg = isByOrg;</span>
<span class="nc" id="L415">	}</span>
	public void setLocaleContext(LocaleContext localeContext) {
<span class="nc" id="L417">		this.localeContext = localeContext;</span>
<span class="nc" id="L418">	}</span>

	@Override
	public void setJunctionFieldsOnCreate(String relationshipKey, ShiftPattern shiftPattern, ValueObjectBase junctionObject,
			ValueObjectBase relatedObject, int index) 
	{
<span class="pc bpc" id="L424" title="1 of 2 branches missed.">		if (relationshipKey.equals(ShiftPattern.VTO_EVENT_RELATIONSHIP_KEY)) {</span>
<span class="nc" id="L425">			ShiftPatternVTOEvent spvtoe = (ShiftPatternVTOEvent)junctionObject;</span>
<span class="nc" id="L426">			VTOEvent vtoEvent = (VTOEvent)relatedObject;</span>
<span class="nc" id="L427">			spvtoe.setCreatedBy(getCallerPrincipal());</span>
<span class="nc" id="L428">			spvtoe.setCreatedDate(new Date(System.currentTimeMillis()));</span>
<span class="nc" id="L429">			spvtoe.setVTOStartTime(shiftPattern.getVTOEventStartTime(vtoEvent));</span>
<span class="nc" id="L430">			spvtoe.setModifiedBy(null);</span>
<span class="nc" id="L431">			spvtoe.setModifiedDate(null);</span>
<span class="pc bfc" id="L432" title="All 2 branches covered.">		} else if (relationshipKey.equals(ShiftPattern.SHIFT_OT_EXTENSION_RELATIONSHIP_KEY)) {</span>
<span class="fc" id="L433">			ShiftPatternOTExtension spote = (ShiftPatternOTExtension)junctionObject;</span>
<span class="fc" id="L434">			ShiftOTExtension sote = (ShiftOTExtension)relatedObject;</span>
<span class="fc" id="L435">			spote.setCreatedBy(getCallerPrincipal());</span>
<span class="fc" id="L436">			spote.setCreatedDate(new Date(System.currentTimeMillis()));</span>
<span class="fc" id="L437">			spote.setOTExtensionStartTime(shiftPattern.getOTExtensionStartTime(sote));</span>
<span class="fc" id="L438">			spote.setModifiedBy(null);</span>
<span class="fc" id="L439">			spote.setModifiedDate(null);</span>
<span class="pc bpc" id="L440" title="1 of 2 branches missed.">		} else if (relationshipKey.equals(ShiftPattern.SHIFT_RELATIONSHIP_KEY)) {</span>
<span class="fc" id="L441">			ShiftPatternShift sps = (ShiftPatternShift)junctionObject;</span>
<span class="fc" id="L442">			sps.setCreatedBy(getCallerPrincipal());</span>
<span class="fc" id="L443">			sps.setCreatedDate(new Date(System.currentTimeMillis()));</span>
<span class="fc" id="L444">			sps.setModifiedBy(null);</span>
<span class="fc" id="L445">			sps.setModifiedDate(null);</span>
		}
<span class="fc" id="L447">	}</span>
	
	public void setChildFieldsOnCreate(String relationshipKey, ShiftPattern shiftPattern, ValueObjectBase childObject) {
<span class="fc" id="L450">		ShiftGroup sg = (ShiftGroup)childObject;</span>
<span class="fc" id="L451">		sg.setCreatedBy(getCallerPrincipal());</span>
<span class="fc" id="L452">		sg.setCreatedDate(new Date(System.currentTimeMillis()));</span>
<span class="fc" id="L453">		sg.setModifiedBy(null);</span>
<span class="fc" id="L454">		sg.setModifiedDate(null);</span>
<span class="fc" id="L455">	}</span>
	
	public void setJunctionFieldsOnUpdate(String relationshipKey, ShiftPattern shiftPattern,
			ValueObjectBase junctionObject, ValueObjectBase relatedObject) {
<span class="nc bnc" id="L459" title="All 2 branches missed.">		if (relationshipKey.equals(ShiftPattern.VTO_EVENT_RELATIONSHIP_KEY)) {</span>
<span class="nc" id="L460">			ShiftPatternVTOEvent spvtoe = (ShiftPatternVTOEvent)junctionObject;</span>
<span class="nc" id="L461">			VTOEvent vtoEvent = (VTOEvent)relatedObject;</span>
<span class="nc" id="L462">			spvtoe.setVTOStartTime(shiftPattern.getVTOEventStartTime(vtoEvent));</span>
<span class="nc" id="L463">			spvtoe.setModifiedBy(getCallerPrincipal());</span>
<span class="nc" id="L464">			spvtoe.setModifiedDate(new Date(System.currentTimeMillis()));</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">		} else if (relationshipKey.equals(ShiftPattern.SHIFT_OT_EXTENSION_RELATIONSHIP_KEY)) {</span>
<span class="nc" id="L466">			ShiftPatternOTExtension spote = (ShiftPatternOTExtension)junctionObject;</span>
<span class="nc" id="L467">			ShiftOTExtension sote = (ShiftOTExtension)relatedObject;</span>
<span class="nc" id="L468">			spote.setOTExtensionStartTime(shiftPattern.getOTExtensionStartTime(sote));</span>
<span class="nc" id="L469">			spote.setModifiedBy(getCallerPrincipal());</span>
<span class="nc" id="L470">			spote.setModifiedDate(new Date(System.currentTimeMillis()));</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">		} else if (relationshipKey.equals(ShiftPattern.SHIFT_RELATIONSHIP_KEY)) {</span>
<span class="nc" id="L472">			ShiftPatternShift sps = (ShiftPatternShift)junctionObject;</span>
<span class="nc" id="L473">			sps.setModifiedBy(getCallerPrincipal());</span>
<span class="nc" id="L474">			sps.setModifiedDate(new Date(System.currentTimeMillis()));</span>
		}		
<span class="nc" id="L476">	}</span>
	
	public void setChildFieldsOnUpdate(String relationshipKey, ShiftPattern shiftPattern, ValueObjectBase childObject) {
<span class="fc" id="L479">		ShiftGroup sg = (ShiftGroup)childObject;</span>
<span class="fc" id="L480">		sg.setModifiedBy(getCallerPrincipal());</span>
<span class="fc" id="L481">		sg.setModifiedDate(new Date());</span>
<span class="fc" id="L482">	}</span>
	
	@Override
	protected void buildSortQuery(List&lt;DBSortField&gt; sortFields, StringBuffer selectQuery, StringBuffer fromQuery,
			StringBuffer whereQuery, StringBuffer groupByQuery, StringBuffer orderByQuery) {
<span class="fc bfc" id="L487" title="All 2 branches covered.">		for (DBSortField sortField : sortFields) {</span>
<span class="pc bpc" id="L488" title="6 of 7 branches missed.">			switch((ShiftPatternSortField)sortField) {</span>
				case ID:
<span class="fc" id="L490">					WorkRuleUtil.appendCommaIfPassStringIsNotEmpty(orderByQuery).append(getFieldInfo().getIDFieldName());</span>
<span class="fc" id="L491">					break;</span>
				case NAME:
<span class="nc" id="L493">					selectQuery.append(&quot;, &quot;).append(getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_NAME));</span>
<span class="nc" id="L494">					WorkRuleUtil.appendCommaIfPassStringIsNotEmpty(orderByQuery).append(getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_NAME));</span>
<span class="nc" id="L495">					break;</span>
				case CONSISTENCY_TOLERANCE:
<span class="nc" id="L497">					selectQuery.append(&quot;, &quot;).append(getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_CONSISTENTSTARTSTOLERANCE));</span>
<span class="nc" id="L498">					WorkRuleUtil.appendCommaIfPassStringIsNotEmpty(orderByQuery).append(getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_CONSISTENTSTARTSTOLERANCE));</span>
<span class="nc" id="L499">					break;</span>
				case EMPLOYEE_TYPE:
<span class="nc" id="L501">					selectQuery.append(&quot;, B.&quot;).append(etfi.getFieldName(EmployeeTypeFieldInfo.EMPLOYEETYPE_DESCRIPTION));</span>
<span class="nc" id="L502">					fromQuery.append(&quot;, &quot; + etfi.getTableName() + &quot; B&quot;);</span>
<span class="nc" id="L503">					whereQuery.append(&quot; AND B.&quot; + etfi.getFieldName(EmployeeTypeFieldInfo.EMPLOYEETYPE_ID) +</span>
<span class="nc" id="L504">							&quot; = A.&quot; + getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_EMPLOYEETYPEID));</span>
<span class="nc" id="L505">					WorkRuleUtil.appendCommaIfPassStringIsNotEmpty(orderByQuery).append(&quot;B.&quot; + etfi.getFieldName(EmployeeTypeFieldInfo.EMPLOYEETYPE_DESCRIPTION));					</span>
<span class="nc" id="L506">					break;</span>
				case ORGANIZATION:
<span class="nc" id="L508">					selectQuery.append(&quot;, (SELECT C.&quot;).append(ofi.getFieldName(OrganizationFieldInfo.ORGANIZATION_NAME)).append(</span>
<span class="nc" id="L509">						&quot; FROM &quot;).append(ofi.getTableName()).append(&quot; C WHERE C.&quot;).append(ofi.getIDFieldName()).append(</span>
<span class="nc" id="L510">						&quot; = A.&quot;).append(getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_ORGANIZATIONID)).append(</span>
<span class="nc" id="L511">						&quot;) AS &quot;).append(organizationSortFieldKey);</span>
<span class="nc" id="L512">					WorkRuleUtil.appendCommaIfPassStringIsNotEmpty(orderByQuery).append(organizationSortFieldKey);				</span>
<span class="nc" id="L513">				break;</span>
				case DESCRIPTION:
<span class="nc" id="L515">					selectQuery.append(&quot;, &quot;).append(getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_DESCRIPTION));</span>
<span class="nc" id="L516">					WorkRuleUtil.appendCommaIfPassStringIsNotEmpty(orderByQuery).append(getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_DESCRIPTION));						</span>
<span class="nc" id="L517">					break;</span>
				default: break;
			}
<span class="fc" id="L520">		}</span>
<span class="fc" id="L521">	}</span>
	
	protected Object getPaginationDataFieldValue(JdmoRowset rowData, DBSortField sortField) throws JdmoException {
<span class="nc" id="L524">		ShiftPatternSortField spsf = (ShiftPatternSortField)sortField;</span>
<span class="nc bnc" id="L525" title="All 6 branches missed.">		switch(spsf) {</span>
			case NAME:
<span class="nc" id="L527">				return rowData.getString(getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_NAME));</span>
			case CONSISTENCY_TOLERANCE:
<span class="nc" id="L529">				return rowData.getString(getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_CONSISTENTSTARTSTOLERANCE));</span>
			case EMPLOYEE_TYPE:
<span class="nc" id="L531">				return rowData.getString(etfi.getFieldName(EmployeeTypeFieldInfo.EMPLOYEETYPE_DESCRIPTION));</span>
			case ORGANIZATION:
<span class="nc" id="L533">				return rowData.getString(organizationSortFieldKey);</span>
			case DESCRIPTION:
<span class="nc" id="L535">				return rowData.getString(getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_DESCRIPTION));</span>
<span class="nc" id="L536">			default: return null;</span>
		}
	}
	
	public Collection&lt;ShiftPattern&gt; getCurrentShiftPatternsByOrgHierarchy(ID orgID) throws BbmFinderException {
<span class="nc" id="L541">		return getObjects(DAOUtil.getCurrentObjectsByOrgHierarchySQLString(orgID));</span>
	}
	
	public LinkedHashMap&lt;ID, String&gt; getCurrentShiftPatternsIDNameByOrgHierarchyOrderByName(ID orgID) throws Exception {
<span class="nc" id="L545">		StringBuffer sb = new StringBuffer(&quot;SELECT SID, NAME FROM SHIFTPATTERN A WHERE &quot;);</span>
<span class="nc" id="L546">		sb.append(DAOUtil.getCurrentObjectsByOrgHierarchySQLString(orgID));</span>
<span class="nc" id="L547">		sb.append(&quot; ORDER BY NAME &quot;);</span>
		
<span class="nc" id="L549">		JdmoRowset rs = m_dmo.createRowset(sb.toString());</span>
<span class="nc" id="L550">		LinkedHashMap &lt;ID, String&gt; returnMap = new LinkedHashMap();</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L552">			returnMap.put(rs.getID(1), rs.getString(2));</span>
		}
		
<span class="nc" id="L555">		return returnMap;</span>
	}
	
	/**
	 * Returns the shift patterns defined for a specific organization (excluding hierarchy org scoped items).
	 * 
	 * @param orgID Organization ID
	 * @return Collection collection of shift patterns 
	 * @see ShiftPattern
	 * @throws BbmFinderException If the organization cannot be found
	 */
	public Collection&lt;ShiftPattern&gt; getCurrentShiftPatternsByOrg(ID orgID) throws BbmFinderException {
<span class="nc" id="L567">		return getObjects(DAOUtil.getCurrentObjectsByOrgSQLString(orgID));</span>
	}
	
	@Override
	protected Map&lt;Integer, ? extends FieldInfo&gt; getForeignKeyFieldInfo() {
<span class="fc" id="L572">		Map&lt;Integer, FieldInfo&gt; retVal = new HashMap&lt;Integer, FieldInfo&gt;();</span>
<span class="fc" id="L573">		retVal.put(ShiftPatternFieldInfo.SHIFTPATTERN_CAMPAIGNID, new CampaignFieldInfo());</span>
<span class="fc" id="L574">		return retVal;</span>
	}
	
	/**
	 * Checks whether a shift pattern name is in use within the organization scope of IDs
	 * @param name
	 * @param organizationScope null or empty collection will search system wide for conflict.
	 * @return true/false
	 * @throws BbmException
	 */
	public boolean isShiftPatternNameUsed(ShiftPattern shiftPattern, Collection&lt;ID&gt; organizationScope) throws BbmException {
<span class="fc" id="L585">		StringBuffer sb = new StringBuffer(200);</span>
		
<span class="pc bpc" id="L587" title="2 of 4 branches missed.">		if(organizationScope != null &amp;&amp; organizationScope.size() &gt; 0) {			</span>
<span class="fc" id="L588">			sb.append(&quot; &quot;).append(getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_NAME))</span>
<span class="fc" id="L589">				.append(&quot; = &quot;).append(JdmoUtil.asSqlLiteral(shiftPattern.getName())).append(&quot; AND &quot;);</span>
<span class="fc" id="L590">			sb.append(getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_DELETEONDATE) + &quot; IS NULL AND &quot;);</span>
<span class="fc bfc" id="L591" title="All 2 branches covered.">			if(shiftPattern.getID() != null) {</span>
<span class="fc" id="L592">				sb.append(getFieldInfo().getIDFieldName())</span>
<span class="fc" id="L593">					.append(&quot; != &quot;).append(JdmoUtil.asSqlLiteral(shiftPattern.getID())).append(&quot; AND &quot;);</span>
			}


			// If the list has NULL in it, then you need to consider locally defined patterns, i.e. org = null but has campaign id.
			// SQL in clause having null, like ORGANIZATIONID IN (NULL) doesn't actually match a column value of null.
<span class="pc bpc" id="L599" title="1 of 2 branches missed.">			if (organizationScope.contains(null)) {</span>
				// (ORGANIZATIONID IN (..., ..., ...) OR (CAMPAIGNID = ... AND ORGANIZATIONID IS NULL))
<span class="nc" id="L601">				sb.append(&quot;(&quot;);</span>
<span class="nc" id="L602">				sb.append(getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_ORGANIZATIONID))</span>
<span class="nc" id="L603">						.append(&quot; IN (&quot;).append(JdmoUtil.createIDList(organizationScope)).append(&quot;)&quot;);</span>
<span class="nc" id="L604">				sb.append(&quot; OR (&quot;);</span>
<span class="nc" id="L605">				sb.append(getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_CAMPAIGNID));</span>
<span class="nc" id="L606">				sb.append(&quot; = &quot;);</span>
<span class="nc" id="L607">				sb.append(JdmoUtil.asSqlLiteral(shiftPattern.getCampaignID()));</span>
<span class="nc" id="L608">				sb.append(&quot; AND &quot;);</span>
<span class="nc" id="L609">				sb.append(getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_ORGANIZATIONID));</span>
<span class="nc" id="L610">				sb.append(&quot; IS NULL&quot;);</span>
<span class="nc" id="L611">				sb.append(&quot;)&quot;);</span>
<span class="nc" id="L612">				sb.append(&quot;)&quot;);</span>
			} else {
				// ORGANIZATIONID IN (..., ..., ...)
<span class="fc" id="L615">				sb.append(getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_ORGANIZATIONID))</span>
<span class="fc" id="L616">						.append(&quot; IN (&quot;).append(JdmoUtil.createIDList(organizationScope)).append(&quot;)&quot;);</span>
			}
		}
		
<span class="fc" id="L620">		Collection&lt;ShiftPattern&gt; shiftPatterns = getObjects(sb.toString());</span>
<span class="pc bpc" id="L621" title="1 of 2 branches missed.">		return (shiftPatterns.size() &gt; 0);</span>
	}
	
	private String getMonthlyWorkPatternFilterClause() {
<span class="nc" id="L625">		return getFieldInfo().getFieldName(ShiftPatternFieldInfo.SHIFTPATTERN_NUMOFWEEKS) + &quot; &lt;= 7&quot;;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>