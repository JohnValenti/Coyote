<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftSwapPostingManagerEJB.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.swap.posting.ejb</a> &gt; <span class="el_source">ShiftSwapPostingManagerEJB.java</span></div><h1>ShiftSwapPostingManagerEJB.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.swap.posting.ejb;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.Iterator;
import java.util.List;

import org.apache.log4j.Priority;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.workresource.model.WorkResourceAssignment;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.core.base.SessionEJBBase;
import com.bluepumpkin.ejb.core.base.SupportNavigation;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.base.PaginationInfo;
import com.bluepumpkin.ejb.rm.base.RmException;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.l10n.RmEjbLogBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validator;
import com.bluepumpkin.ejb.rm.requests.swap.posting.model.SSPostingCollection;
import com.bluepumpkin.ejb.rm.requests.swap.posting.model.ShiftSwapPosting;
import com.bluepumpkin.ejb.rm.requests.swap.posting.model.ShiftSwapPostingFieldInfo;
import com.bluepumpkin.ejb.rm.requests.swap.posting.model.ShiftSwapPostingSortField;
import com.bluepumpkin.ejb.rm.requests.swap.posting.validation.AgentGoodStandingValidationRule;
import com.bluepumpkin.ejb.rm.requests.swap.posting.validation.PostedShiftContainsFlexTOHV;
import com.bluepumpkin.ejb.rm.requests.swap.posting.validation.SameShiftNotAlreadyPostedHV;
import com.bluepumpkin.ejb.rm.requests.swap.posting.validation.ShiftExistValidationRule;
import com.bluepumpkin.ejb.rm.requests.swap.shiftitem.model.ShiftSwapItem;
import com.bluepumpkin.ejb.rm.util.RmUtil;
import com.bluepumpkin.ejb.rm.util.ShiftSwapRequestUtil;


/**
 * Title:        ShiftSwapPostingManagerEJB
 * Description:  EJB for ShiftSwapPosting
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc.
 * @author       Zhibo Wang
 * @version 1.0
 */
<span class="nc" id="L58">public class ShiftSwapPostingManagerEJB extends SessionEJBBase implements IShiftSwapPostingManager //OUTSIDE_CONTAINER</span>
//public class ShiftSwapPostingManagerEJB extends SessionEjbBaseForTest implements ShiftSwapPostingManager //OUTSIDE_CONTAINER
{
<span class="nc" id="L61">    private static Category m_cat = Log.initCategory(ShiftSwapPostingManagerEJB.class.getName());</span>

    protected static final int FETCHMODE_ALLPOSTINGS = 1;
    protected static final int FETCHMODE_MYORGPOSTINGS = 2;

<span class="nc" id="L66">    private final Validator m_agentGoodStandingValidationRule = new AgentGoodStandingValidationRule();</span>
<span class="nc" id="L67">    private final Validator m_shiftExistValidationRule = new ShiftExistValidationRule();</span>
<span class="nc" id="L68">    private final Validator m_sameShiftNotAlreadyPostedHV = new SameShiftNotAlreadyPostedHV();</span>
<span class="nc" id="L69">    private final Validator m_postedShiftContainsFlexTOHV = new PostedShiftContainsFlexTOHV();</span>

    /**
     * validators run on a call to {@link #validateShiftSwapPosting(Collection, boolean) validateShiftSwapPosting}
     * method.
     */
<span class="nc" id="L75">    private final Validator[] m_validatorsForPickup = new Validator[] {</span>
            m_agentGoodStandingValidationRule, m_shiftExistValidationRule, m_postedShiftContainsFlexTOHV };

<span class="nc" id="L78">    private final Validator[] m_validatorsForUpdate = new Validator[] {</span>
        m_agentGoodStandingValidationRule, m_shiftExistValidationRule, m_postedShiftContainsFlexTOHV};

<span class="nc" id="L81">    private final Validator[] m_validatorsForCreate = new Validator[] {</span>
        m_agentGoodStandingValidationRule, m_shiftExistValidationRule, m_sameShiftNotAlreadyPostedHV, m_postedShiftContainsFlexTOHV};

    {
<span class="nc" id="L85">        super.init(ShiftSwapPostingManagerEJB.class.getName());</span>
<span class="nc" id="L86">    }</span>

    /** override the base class to provide the appropriate logging category */
    @Override
	protected Category getCategory() {
<span class="nc" id="L91">        return m_cat;</span>
    }

    /**
     * Creates a persistent ShiftSwapPosting in the DB, with a child ShiftSwapItem.
     * @param objValue  A ShiftSwapPosting object
     * @return the ID of the created object
     * @throws BbmCreateException
     */
    @Override
	public ID createShiftSwapPosting(ShiftSwapPosting ssPosting)
        throws BbmCreateException, RmHardValidationException {
<span class="nc" id="L103">        String _method_ = &quot;createShiftSwapPosting&quot;;</span>
<span class="nc" id="L104">        methodStart(_method_, ssPosting);</span>

        ID postingId;

        // make sure the posting contains a ShiftSwapItem
<span class="nc" id="L109">        ShiftSwapItem item = ssPosting.getShiftSwapItem();</span>

<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (item == null) {</span>
<span class="nc" id="L112">            throw RequestUtil.createRmHardValidationException(RmEjbBundleKey.SSP_NO_ITEM, m_cat);</span>
        }

<span class="nc" id="L115">        ShiftSwapPostingDAO sspDAO = null;</span>
        try {
            //Hard Validation for posting creation
<span class="nc" id="L118">            runHardValidatorsRaiseException(ssPosting, m_validatorsForCreate );</span>
            
            //Get ShiftID and add to ShiftSwapItem
<span class="nc" id="L121">    		ScheduleAccessManager sam = RequestUtil.getScheduleAccessManager();</span>
<span class="nc" id="L122">    		ShiftSwapItem ssi = ssPosting.getShiftSwapItem();</span>
<span class="nc" id="L123">    		Collection shiftAssign = sam.getPublishedEventsForWorkResourceByType(Event.EVENT_TYPE_SHIFT_ASSIGNMENT, ssi.getEmployeeID(),</span>
<span class="nc" id="L124">    				                                                             ssi.getStartDate(), ssi.getEndDate());</span>
<span class="nc" id="L125">    		Iterator it = shiftAssign.iterator();</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">    		if (it.hasNext()) {</span>
<span class="nc" id="L127">    			ShiftAssignment sa = (ShiftAssignment)it.next();</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">    			if (sa.getShiftID() != null) {</span>
<span class="nc" id="L129">    				ssi.setShiftID(sa.getShiftID());</span>
    			}
    		}

            //create ShiftSwapPosting object in DB
<span class="nc" id="L134">            sspDAO = new ShiftSwapPostingDAO(ShiftSwapPosting.DL_BASIC);</span>
<span class="nc" id="L135">            postingId = sspDAO.createObject(ssPosting, false);</span>
<span class="nc" id="L136">        } catch (BbmCreateException e) {</span>
<span class="nc" id="L137">            m_cat.l7dError(RmEjbLogBundleKey.CREATE_FAILURE, new String[] { &quot;SHIFTSWAPPOSTING&quot; });</span>
<span class="nc" id="L138">            handleException(e);</span>
<span class="nc" id="L139">            throw e;</span>
<span class="nc" id="L140">        } catch (RmHardValidationException e) {</span>
			// RM exceptions are always logged before they are thrown.
			//m_cat.l7dError(RmEjbLogBundleKey.CREATE_FAILURE, new String[] { &quot;SHIFTSWAPPOSTING&quot; });

            // Logged with priority 'debug' since this exception is generated by RM during validations or
            // workflow processing and happens often during normal operation.  If logged with a different
            // priority level (like info), it may pollute the log files with unwanted messages.
<span class="nc" id="L147">            handleException(Priority.DEBUG, e);</span>
<span class="nc" id="L148">			throw e;</span>
<span class="nc" id="L149">		} catch (Exception e) {</span>
<span class="nc" id="L150">        	handleException(_method_, e, true);</span>
<span class="nc" id="L151">        	throw RequestUtil.createBbmCreateExceptionWrapper(e, m_cat);</span>
        } finally {
<span class="nc bnc" id="L153" title="All 4 branches missed.">            if (sspDAO != null) sspDAO.cleanUp();</span>
<span class="nc" id="L154">            methodFinish();</span>
<span class="nc" id="L155">        }</span>

<span class="nc" id="L157">        return postingId;</span>
    }

    private void runHardValidatorsRaiseException(ShiftSwapPosting ssPosting, Validator[] validators)
        throws Exception {

<span class="nc" id="L163">        ValidationResult vr = runHardValidators(ssPosting, validators);</span>

<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (vr != null) {</span>
<span class="nc" id="L166">            throw RequestUtil.createRmHardValidationException(vr, m_cat);</span>
        }
<span class="nc" id="L168">    }</span>

    /**
     * @param ssPosting
     * @param validators
     */
    private ValidationResult runHardValidators(ShiftSwapPosting ssPosting, Validator[] validators) throws Exception {
<span class="nc" id="L175">        ValidationResult vr = null;</span>

        // for each validator
<span class="nc bnc" id="L178" title="All 2 branches missed.">        for (int i = 0; i &lt; validators.length; i++) {</span>
            // run validation
<span class="nc" id="L180">            vr = validators[i].validate(ssPosting);</span>

            // stop on first validation error.
<span class="nc bnc" id="L183" title="All 2 branches missed.">            if (vr != null) {</span>
<span class="nc" id="L184">                break;</span>
            }
        }

<span class="nc" id="L188">        return vr;</span>
    }


    /**
     * Updates a ShiftSwapPosting object including its child ShiftSwapItem object
     * in the database.
     *
     * @param objValue  the object to be updated
     * @throws MultiUserException
     * @throws BbmUpdateException
     */
    @Override
	public void updateShiftSwapPosting(ShiftSwapPosting ssPosting)
        throws MultiUserException, BbmUpdateException, RmHardValidationException {
<span class="nc" id="L203">        String _method_ = &quot;updateShiftSwapPosting&quot;;</span>
<span class="nc" id="L204">        methodStart(_method_, ssPosting);</span>

<span class="nc" id="L206">        ShiftSwapPostingDAO sspDAO = null;</span>
        try {
            //Hard Validation for posting update
<span class="nc" id="L209">            runHardValidatorsRaiseException(ssPosting, m_validatorsForUpdate );</span>

<span class="nc" id="L211">            sspDAO = new ShiftSwapPostingDAO(ShiftSwapPosting.DL_BASIC);</span>
<span class="nc" id="L212">            sspDAO.updateSSPosting(ssPosting);</span>
<span class="nc" id="L213">        } catch (RmHardValidationException e) {</span>
			// RM exceptions are always logged before they are thrown.
			//m_cat.l7dError(RmEjbLogBundleKey.CREATE_FAILURE, new String[] { &quot;SHIFTSWAPPOSTING&quot; });

            // Logged with priority 'debug' since this exception is generated by RM during validations or
            // workflow processing and happens often during normal operation.  If logged with a different
            // priority level (like info), it may pollute the log files with unwanted messages.
<span class="nc" id="L220">            handleException(Priority.DEBUG, e);</span>
<span class="nc" id="L221">			throw e;</span>
<span class="nc" id="L222">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L223">            m_cat.l7dError(RmEjbLogBundleKey.UPDATE_FAILURE, new String[] { &quot;SHIFTSWAPPOSTING&quot; });</span>
<span class="nc" id="L224">            handleException(e);</span>
<span class="nc" id="L225">            throw e;</span>
<span class="nc" id="L226">        } catch (MultiUserException e) {</span>
<span class="nc" id="L227">            m_cat.l7dError(RmEjbLogBundleKey.UPDATE_FAILURE, new String[] { &quot;SHIFTSWAPPOSTING&quot; });</span>
<span class="nc" id="L228">            handleException(e);</span>
<span class="nc" id="L229">            throw e;</span>
<span class="nc" id="L230">        } catch (Exception e) {</span>
<span class="nc" id="L231">        	handleException(e);</span>
<span class="nc" id="L232">        	throw RequestUtil.createBbmUpdateExceptionWrapper(e, m_cat);</span>
        } finally {
<span class="nc bnc" id="L234" title="All 4 branches missed.">            if (sspDAO != null) sspDAO.cleanUp();</span>
<span class="nc" id="L235">            methodFinish();</span>
<span class="nc" id="L236">        }</span>
<span class="nc" id="L237">    }</span>

    /**
     * Deletes ShiftSwapPosting objects including child ShiftSwapItems
     * from the database.
     *
     * @param colIDs collection of IDs representing ShiftSwapPosting objects
     * in the database
     * @throws BbmRemoveException
     * @throws BbmFinderException
     */
    @Override
	public void deleteShiftSwapPostings(Collection&lt;ID&gt; colIDs)
        throws BbmRemoveException, BbmFinderException, RmHardValidationException {
<span class="nc" id="L251">        String _method_ = &quot;deleteShiftSwapPostings&quot;;</span>
<span class="nc" id="L252">        methodStart(_method_, colIDs);</span>

<span class="nc" id="L254">		Collection&lt;ID&gt; itemIds = new ArrayList&lt;&gt;(colIDs.size());</span>
<span class="nc" id="L255">		Collection&lt;ShiftSwapPosting&gt; postings = new ArrayList&lt;&gt;(colIDs.size());</span>
<span class="nc" id="L256">        ShiftSwapPostingDAO sspDAO = null;</span>
<span class="nc" id="L257">        DAOBase ssItemDAO = null;</span>
        try {
            // method getObjectsByIDs is in DAOBase.
            // consequently it shallow reads the objects without retrieving
            // children. this is fine, since we only want to access the
            // ShiftSwapItemId field.
<span class="nc" id="L263">            long detailLevel = ShiftSwapPosting.DL_BASIC | ShiftSwapPosting.DL_SHIFTSWAP_ITEMS;</span>
<span class="nc" id="L264">            sspDAO = new ShiftSwapPostingDAO(detailLevel);</span>
<span class="nc" id="L265">            postings = sspDAO.findSSPostingsByIDs(colIDs, detailLevel);</span>

<span class="nc" id="L267">			Iterator&lt;ShiftSwapPosting&gt; itr = postings.iterator();</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">            while (itr.hasNext()) {</span>
<span class="nc" id="L269">				itemIds.add((ID) itr.next().getFieldValue(</span>
                        ShiftSwapPostingFieldInfo.SHIFTSWAPPOSTING_I_SHIFTSWAPITEMID));
            }

            // delete the child ShiftSwapItem objects which will
            // cascade delete the parent ShiftSwapPosting objects
<span class="nc" id="L275">            ssItemDAO = sspDAO.createChildDAO(ShiftSwapPostingFieldInfo.ITEM_CHILD_TYPE);</span>
<span class="nc" id="L276">            ssItemDAO.deleteObjects(itemIds);</span>
<span class="nc" id="L277">		} catch (RmHardValidationException e) {</span>
			// RM exceptions are always logged before they are thrown.
			//m_cat.error(e,e);

            // Logged with priority 'debug' since this exception is generated by RM during validations or
            // workflow processing and happens often during normal operation.  If logged with a different
            // priority level (like info), it may pollute the log files with unwanted messages.
<span class="nc" id="L284">            handleException(Priority.DEBUG, e);</span>
<span class="nc" id="L285">			throw e;</span>
<span class="nc" id="L286">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L287">            m_cat.error(e, e);</span>
<span class="nc" id="L288">        	handleException(e);</span>
<span class="nc" id="L289">            throw e;</span>
<span class="nc" id="L290">        } catch (BbmRemoveException e) {</span>
<span class="nc" id="L291">        	m_cat.error(e,e);</span>
<span class="nc" id="L292">        	handleException(e);</span>
<span class="nc" id="L293">        	throw e;</span>
<span class="nc" id="L294">        } catch (Exception e) {</span>
<span class="nc" id="L295">        	handleException(e);</span>
<span class="nc" id="L296">        	throw RequestUtil.createBbmRemoveExceptionWrapper(e, m_cat);</span>
        } finally {
<span class="nc bnc" id="L298" title="All 4 branches missed.">            if (sspDAO != null) sspDAO.cleanUp();</span>
<span class="nc bnc" id="L299" title="All 4 branches missed.">            if (ssItemDAO != null) ssItemDAO.cleanUp();</span>
<span class="nc" id="L300">            methodFinish();</span>
<span class="nc" id="L301">        }</span>
<span class="nc" id="L302">    }</span>

    /**
     * Deletes ShiftSwapPosting object from database.
     *
     * @param id the ID representing the ShiftSwapPosting object in the database.
     * @throws BbmRemoveException
     * @throws BbmFinderException
     */
    @Override
	public void deleteShiftSwapPosting(ID id)
    	throws BbmRemoveException, BbmFinderException, RmHardValidationException {
<span class="nc" id="L314">        String _method_ = &quot;deleteShiftSwapPosting&quot;;</span>
<span class="nc" id="L315">        methodStart(_method_, id);</span>

<span class="nc" id="L317">        ShiftSwapPostingDAO dao = null;</span>

        try {
<span class="nc" id="L320">            dao = new ShiftSwapPostingDAO(ShiftSwapPosting.DL_BASIC);</span>
<span class="nc" id="L321">            dao.deleteSSPosting(id);</span>
<span class="nc" id="L322">		} catch (RmHardValidationException e) {</span>
			// RM exceptions are always logged before they are thrown.
			//m_cat.error(e,e);

            // Logged with priority 'debug' since this exception is generated by RM during validations or
            // workflow processing and happens often during normal operation.  If logged with a different
            // priority level (like info), it may pollute the log files with unwanted messages.
<span class="nc" id="L329">            handleException(Priority.DEBUG, e);</span>
<span class="nc" id="L330">			throw e;</span>
<span class="nc" id="L331">        } catch (BbmRemoveException e) {</span>
<span class="nc" id="L332">        	m_cat.error(e,e);</span>
<span class="nc" id="L333">        	handleException(e);</span>
<span class="nc" id="L334">        	throw e;</span>
<span class="nc" id="L335">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L336">        	m_cat.error(e,e);</span>
<span class="nc" id="L337">        	handleException(e);</span>
<span class="nc" id="L338">        	throw e;</span>
<span class="nc" id="L339">        } catch (Exception e) {</span>
<span class="nc" id="L340">            handleException(e);</span>
<span class="nc" id="L341">            throw RequestUtil.createBbmRemoveExceptionWrapper(e, m_cat);</span>
        } finally {
<span class="nc bnc" id="L343" title="All 4 branches missed.">            if (dao != null) dao.cleanUp();</span>
<span class="nc" id="L344">            methodFinish();</span>
<span class="nc" id="L345">        }</span>
<span class="nc" id="L346">    }</span>

    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.rm.requests.swap.posting.ejb.IShiftSwapPostingManager#validateShiftSwapPosting(java.util.Collection, boolean)
     */
    @Override
	public Collection&lt;ShiftSwapPosting&gt; validateShiftSwapPostings(Collection&lt;ShiftSwapPosting&gt; ssPostings, boolean deleteIfHardValFails)
        throws RmHardValidationException, RmException {

<span class="nc" id="L355">        String _method_ = &quot;validateShiftSwapPostings&quot;;</span>
<span class="nc" id="L356">        methodStart(_method_, RmUtil.dumpIDsFromVOCollection(ssPostings));</span>

        try {
<span class="nc" id="L359">            return _validateShiftSwapPostings(ssPostings, deleteIfHardValFails, null);</span>
<span class="nc" id="L360">        } catch (RmHardValidationException e) {</span>
            //RM exceptions are always logged at the point where they are thrown.
            //m_cat.error(e, e);

            // Logged with priority 'debug' since this exception is generated by RM during validations or
            // workflow processing and happens often during normal operation.  If logged with a different
            // priority level (like info), it may pollute the log files with unwanted messages.
<span class="nc" id="L367">            handleException(Priority.DEBUG, e);</span>
<span class="nc" id="L368">            throw e;</span>
<span class="nc" id="L369">        } catch (RmException e) {</span>
<span class="nc" id="L370">            m_cat.error(e, e);</span>
<span class="nc" id="L371">            handleException(e);</span>
<span class="nc" id="L372">            throw e;</span>
<span class="nc" id="L373">        } catch (Exception e) {</span>
<span class="nc" id="L374">            handleException(e);</span>
<span class="nc" id="L375">            throw RequestUtil.createRmExceptionWrapper(e, m_cat);</span>
        }
    }

    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.rm.requests.swap.posting.ejb.IShiftSwapPostingManager#validateShiftSwapPostingsByIDs(java.util.Collection, boolean)
     */
    @Override
	public Collection validateShiftSwapPostingsByIDs(Collection&lt;ID&gt; ssPostingIDs, boolean deleteIfHardValFails)
        throws RmHardValidationException, RmException {

<span class="nc" id="L386">            String _method_ = &quot;validateShiftSwapPostingsByIDs&quot;;</span>
<span class="nc" id="L387">            methodStart(_method_, RmUtil.dumpCommaSeparated(ssPostingIDs, new Boolean(deleteIfHardValFails)));</span>

<span class="nc" id="L389">            ShiftSwapPostingDAO sspDAO = null;</span>
            try {
<span class="nc" id="L391">                long detailLevel = ShiftSwapPosting.DL_BASIC | ShiftSwapPosting.DL_SHIFTSWAP_ITEMS;</span>
<span class="nc" id="L392">                sspDAO = new ShiftSwapPostingDAO(detailLevel);</span>
<span class="nc" id="L393">			Collection&lt;ShiftSwapPosting&gt; ssPostings = sspDAO.findSSPostingsByIDs(ssPostingIDs, detailLevel);</span>

<span class="nc" id="L395">                return _validateShiftSwapPostings(ssPostings, deleteIfHardValFails, sspDAO);</span>
<span class="nc" id="L396">            } catch (RmHardValidationException e) {</span>
                //RM exceptions are always logged at the point where they are thrown.
                //m_cat.error(e, e);

                // Logged with priority 'debug' since this exception is generated by RM during validations or
                // workflow processing and happens often during normal operation.  If logged with a different
                // priority level (like info), it may pollute the log files with unwanted messages.
<span class="nc" id="L403">                handleException(Priority.DEBUG, e);</span>
<span class="nc" id="L404">                throw e;</span>
<span class="nc" id="L405">            } catch (RmException e) {</span>
<span class="nc" id="L406">                m_cat.error(e, e);</span>
<span class="nc" id="L407">                handleException(e);</span>
<span class="nc" id="L408">                throw e;</span>
<span class="nc" id="L409">            } catch (Exception e) {</span>
<span class="nc" id="L410">                handleException(e);</span>
<span class="nc" id="L411">                throw RequestUtil.createRmExceptionWrapper(e, m_cat);</span>
            }
    }

	private Collection&lt;ShiftSwapPosting&gt; _validateShiftSwapPostings(Collection&lt;ShiftSwapPosting&gt; ssPostings, boolean deleteIfHardValFails,
        ShiftSwapPostingDAO sspDAO) throws Exception {

<span class="nc bnc" id="L418" title="All 2 branches missed.">        boolean sspDAONeedsCreate = (sspDAO == null);</span>
        try {
<span class="nc" id="L420">			Collection&lt;ID&gt; ssPostingIDsForDel = new ArrayList&lt;&gt;(ssPostings.size());</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">			for (Iterator&lt;ShiftSwapPosting&gt; iter = ssPostings.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L422">                ShiftSwapPosting ssPosting = iter.next();</span>

                // run hard validators.  Stops at the first hard validation failure.
<span class="nc" id="L425">                ValidationResult hardValResult = runHardValidators(ssPosting, m_validatorsForPickup);</span>

                // if hard validatoin fails, posting is a candidate for deletion.
<span class="nc bnc" id="L428" title="All 2 branches missed.">                if (hardValResult != null ) {</span>
<span class="nc" id="L429">                    ssPostingIDsForDel.add(ssPosting.getID());</span>
                }
<span class="nc" id="L431">            }</span>

            // if ssPostings need to be deleted and a 'delete' operation is requested.
<span class="nc bnc" id="L434" title="All 4 branches missed.">            if ( !ssPostingIDsForDel.isEmpty() &amp;&amp; deleteIfHardValFails ) {</span>
                // instantiate DAO only if necessary.
<span class="nc bnc" id="L436" title="All 2 branches missed.">                sspDAO = (sspDAO == null)?new ShiftSwapPostingDAO(ShiftSwapPosting.DL_BASIC):sspDAO;</span>
<span class="nc" id="L437">                sspDAO.deleteObjects(ssPostingIDsForDel);</span>
            }

            // these might have validation results attached.
<span class="nc" id="L441">            return ssPostings;</span>
        } finally {
<span class="nc bnc" id="L443" title="All 8 branches missed.">            if (sspDAONeedsCreate &amp;&amp; sspDAO != null) sspDAO.cleanUp();</span>
        }

    }
    /**
     * &lt;B&gt;findShiftSwapPostingByID&lt;/B&gt;
     * &lt;P&gt;Params  ID
     * returns ShiftSwapPosting Object
     * &lt;P&gt;
     *  @return   ShiftSwapPosting Object
     *
     */
    @Override
	public ShiftSwapPosting findShiftSwapPostingById(ID postingID, long detailLevel)
        throws BbmFinderException, RmHardValidationException {
<span class="nc" id="L458">        String _method_ = &quot;findShiftSwapPostingById&quot;;</span>
<span class="nc" id="L459">        methodStart(_method_, postingID);</span>

<span class="nc" id="L461">        ShiftSwapPostingDAO dao = null;</span>

        try {
<span class="nc" id="L464">            dao = new ShiftSwapPostingDAO(detailLevel);</span>
<span class="nc" id="L465">            ShiftSwapPosting posting = (ShiftSwapPosting) dao.getObjectByID(postingID);</span>

<span class="nc" id="L467">            return posting;</span>
<span class="nc" id="L468">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L469">        	m_cat.error(e,e);</span>
<span class="nc" id="L470">        	handleException(e);</span>
<span class="nc" id="L471">        	throw e;</span>
<span class="nc" id="L472">        } catch (Exception e) {</span>
<span class="nc" id="L473">            handleException(e);</span>
<span class="nc" id="L474">            throw RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
        } finally {
<span class="nc bnc" id="L476" title="All 4 branches missed.">            if (dao != null) dao.cleanUp();</span>
<span class="nc" id="L477">            methodFinish();</span>
        }
    }

    /**
     * &lt;B&gt;findShiftSwapPostingsByEmployee&lt;/B&gt;
     * &lt;P&gt;Params  ID
     * returns ShiftSwapPosting Object
     * &lt;P&gt;
     *  @return   ShiftSwapPosting Object
     *
     */
    @Override
	public SSPostingCollection findShiftSwapPostingsByEmployee(ID empId, long detailLevel, int chunkSize, boolean fetchPartial)
			throws BbmFinderException, RmHardValidationException {
<span class="nc" id="L492">        String _method_ = &quot;findShiftSwapPostingsByEmployee&quot;;</span>
<span class="nc" id="L493">        methodStart(_method_, empId, new Integer(chunkSize));</span>

<span class="nc" id="L495">        ShiftSwapPostingDAO ssPostingDAO = null;</span>

        try {
<span class="nc" id="L498">            List&lt;ID&gt; postingIDs = Collections.emptyList();</span>
<span class="nc" id="L499">            Collection&lt;ShiftSwapPosting&gt; postings = Collections.emptyList();</span>
<span class="nc" id="L500">            ssPostingDAO = new ShiftSwapPostingDAO(detailLevel);</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">            boolean paginationEnabled = chunkSize != SupportNavigation.CHUNKSIZE_ALL;</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">			if (paginationEnabled) {</span>
                // first fetch posting IDs
<span class="nc" id="L504">                postingIDs = ssPostingDAO.findSSPostingIDsByEmployee(empId, fetchPartial);</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">                if (!postingIDs.isEmpty()) {</span>
					// fetch minimum(postingIDs.size(), chunkSize);
<span class="nc bnc" id="L507" title="All 2 branches missed.">					int numOfPostings = (postingIDs.size() &lt; chunkSize)?postingIDs.size():chunkSize;</span>
					// fetch the chunk of requested postings
<span class="nc" id="L509">	                postings = ssPostingDAO.findSSPostingsByIDs(postingIDs.subList(0, numOfPostings), detailLevel);</span>
<span class="nc" id="L510">                }</span>
            } else {
				// pagination not enabled, so fetch all postings (bypass fetching of posting IDs).
<span class="nc" id="L513">                postings = ssPostingDAO.findSSPostingsByEmployee(empId, detailLevel, fetchPartial);</span>
            }

<span class="nc" id="L516">            return new SSPostingCollection(postingIDs, postings, chunkSize);</span>
<span class="nc" id="L517">		} catch (RmHardValidationException e) {</span>
			// RM exceptions are always logged before they are thrown.
			//m_cat.error(e,e);

            // Logged with priority 'debug' since this exception is generated by RM during validations or
            // workflow processing and happens often during normal operation.  If logged with a different
            // priority level (like info), it may pollute the log files with unwanted messages.
<span class="nc" id="L524">            handleException(Priority.DEBUG, e);</span>
<span class="nc" id="L525">			throw e;</span>
<span class="nc" id="L526">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L527">        	m_cat.error(e,e);</span>
<span class="nc" id="L528">        	handleException(e);</span>
<span class="nc" id="L529">        	throw e;</span>
<span class="nc" id="L530">        } catch (Exception e) {</span>
<span class="nc" id="L531">            handleException(e);</span>
<span class="nc" id="L532">            throw RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
        } finally {
<span class="nc bnc" id="L534" title="All 4 branches missed.">            if (ssPostingDAO != null) ssPostingDAO.cleanUp();</span>
<span class="nc" id="L535">            methodFinish();</span>
        }
    }

    /**
     * &lt;B&gt;findShiftSwapPostingIDsByEmployee&lt;/B&gt;
     * &lt;P&gt;Params  ID
     * returns ShiftSwapPosting Object
     * &lt;P&gt;
     *  @return   ShiftSwapPosting Object
     *
     */
    @Override
	public Collection&lt;ID&gt; findShiftSwapPostingIDsByEmployee(ID empId, boolean fetchPartial)
			throws BbmFinderException, RmHardValidationException {
<span class="nc" id="L550">        String _method_ = &quot;findShiftSwapPostingIDsByEmployee&quot;;</span>
<span class="nc" id="L551">        methodStart(_method_, empId);</span>

<span class="nc" id="L553">        ShiftSwapPostingDAO sspDAO = null;</span>

        try {
<span class="nc" id="L556">            sspDAO = new ShiftSwapPostingDAO(ShiftSwapPosting.DL_BASIC);</span>
<span class="nc" id="L557">            Collection&lt;ID&gt; postingIDs = sspDAO.findSSPostingIDsByEmployee(empId, fetchPartial);</span>

<span class="nc" id="L559">            return postingIDs;</span>
<span class="nc" id="L560">		} catch (RmHardValidationException e) {</span>
			// RM exceptions are always logged before they are thrown.
			//m_cat.error(e,e);

            // Logged with priority 'debug' since this exception is generated by RM during validations or
            // workflow processing and happens often during normal operation.  If logged with a different
            // priority level (like info), it may pollute the log files with unwanted messages.
<span class="nc" id="L567">            handleException(Priority.DEBUG, e);</span>
<span class="nc" id="L568">			throw e;</span>
<span class="nc" id="L569">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L570">        	m_cat.error(e,e);</span>
<span class="nc" id="L571">        	handleException(e);</span>
<span class="nc" id="L572">        	throw e;</span>
<span class="nc" id="L573">        } catch (Exception e) {</span>
<span class="nc" id="L574">            handleException(e);</span>
<span class="nc" id="L575">            throw RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
        } finally {
<span class="nc bnc" id="L577" title="All 4 branches missed.">            if (sspDAO != null) sspDAO.cleanUp();</span>
<span class="nc" id="L578">            methodFinish();</span>
        }
    }

    /**
     * &lt;B&gt;findShiftSwapPostingsByOrg&lt;/B&gt;
     * &lt;P&gt;Params  ID
     * returns ShiftSwapPosting Object
     * &lt;P&gt;
     *  @return   ShiftSwapPosting Object
     *
     */
    @Override
	public SSPostingCollection findShiftSwapPostingsByOrg(ID orgId, long detailLevel, int chunkSize)
			throws BbmFinderException, RmHardValidationException {
<span class="nc" id="L593">        String _method_ = &quot;findShiftSwapPostingsByOrg&quot;;</span>
<span class="nc" id="L594">        methodStart(_method_, orgId, new Integer(chunkSize));</span>

<span class="nc" id="L596">        ShiftSwapPostingDAO sspDAO = null;</span>

        try {
<span class="nc" id="L599">            List&lt;ID&gt; postingIDs = Collections.emptyList();</span>
<span class="nc" id="L600">            Collection&lt;ShiftSwapPosting&gt; postings = Collections.emptyList();</span>
<span class="nc" id="L601">            sspDAO = new ShiftSwapPostingDAO(detailLevel);</span>

            // if pagination is enabled
<span class="nc bnc" id="L604" title="All 2 branches missed.">            if (chunkSize != SupportNavigation.CHUNKSIZE_ALL) {</span>
                // first fetch posting ids
<span class="nc" id="L606">                postingIDs = sspDAO.findSSPostingIDsByOrg(orgId);</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">				if (!postingIDs.isEmpty()) {</span>
					// fetch minimum(postingIDs.size(), chunkSize);
<span class="nc bnc" id="L609" title="All 2 branches missed.">					int numOfPostings = (postingIDs.size() &lt; chunkSize)?postingIDs.size():chunkSize;</span>
					// fetch the chunk of requested postings
<span class="nc" id="L611">                	postings = sspDAO.findSSPostingsByIDs(postingIDs.subList(0, numOfPostings), detailLevel);</span>
<span class="nc" id="L612">				}</span>
            } else {
				// pagination not enabled, so fetch all postings (bypass fetching of posting IDs).
<span class="nc" id="L615">                postings = sspDAO.findSSPostingsByOrg(orgId, detailLevel);</span>
            }

<span class="nc" id="L618">            return new SSPostingCollection(postingIDs, postings, chunkSize);</span>
<span class="nc" id="L619">		} catch (RmHardValidationException e) {</span>
			// RM exceptions are always logged before they are thrown.
			//m_cat.error(e,e);

            // Logged with priority 'debug' since this exception is generated by RM during validations or
            // workflow processing and happens often during normal operation.  If logged with a different
            // priority level (like info), it may pollute the log files with unwanted messages.
<span class="nc" id="L626">            handleException(Priority.DEBUG, e);</span>
<span class="nc" id="L627">			throw e;</span>
<span class="nc" id="L628">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L629">        	m_cat.error(e,e);</span>
<span class="nc" id="L630">        	handleException(e);</span>
<span class="nc" id="L631">        	throw e;</span>
<span class="nc" id="L632">        } catch (Exception e) {</span>
<span class="nc" id="L633">            handleException(e);</span>
<span class="nc" id="L634">            throw RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
        } finally {
<span class="nc bnc" id="L636" title="All 4 branches missed.">            if (sspDAO != null) sspDAO.cleanUp();</span>
<span class="nc" id="L637">            methodFinish();</span>
        }
    }

    /**
     * &lt;B&gt;findShiftSwapPostingIDsByOrg&lt;/B&gt;
     * &lt;P&gt;Params  ID
     * returns ShiftSwapPosting Object
     * &lt;P&gt;
     *  @return   ShiftSwapPosting Object
     *
     */
    @Override
	public Collection&lt;ID&gt; findShiftSwapPostingIDsByOrg(ID orgID)
			throws BbmFinderException, RmHardValidationException {
<span class="nc" id="L652">        String _method_ = &quot;findShiftSwapPostingIDsByOrg&quot;;</span>
<span class="nc" id="L653">        methodStart(_method_, orgID);</span>

<span class="nc" id="L655">        ShiftSwapPostingDAO sspDAO = null;</span>

        try {
<span class="nc" id="L658">            sspDAO = new ShiftSwapPostingDAO(ShiftSwapPosting.DL_BASIC);</span>
<span class="nc" id="L659">            Collection&lt;ID&gt; postings = sspDAO.findSSPostingIDsByOrg(orgID);</span>

<span class="nc" id="L661">            return postings;</span>
<span class="nc" id="L662">		} catch (RmHardValidationException e) {</span>
			// RM exceptions are always logged before they are thrown.
			//m_cat.error(e,e);

            // Logged with priority 'debug' since this exception is generated by RM during validations or
            // workflow processing and happens often during normal operation.  If logged with a different
            // priority level (like info), it may pollute the log files with unwanted messages.
<span class="nc" id="L669">            handleException(Priority.DEBUG, e);</span>
<span class="nc" id="L670">			throw e;</span>
<span class="nc" id="L671">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L672">        	m_cat.error(e,e);</span>
<span class="nc" id="L673">        	handleException(e);</span>
<span class="nc" id="L674">        	throw e;</span>
<span class="nc" id="L675">        } catch (Exception e) {</span>
<span class="nc" id="L676">            handleException(e);</span>
<span class="nc" id="L677">            throw RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
        } finally {
<span class="nc bnc" id="L679" title="All 4 branches missed.">            if (sspDAO != null) sspDAO.cleanUp();</span>
<span class="nc" id="L680">            methodFinish();</span>
        }
    }

    /**
     * &lt;B&gt;findShiftSwapPostingsByCampaign&lt;/B&gt;
     * &lt;P&gt;Params  ID
     * returns ShiftSwapPosting Object
     * &lt;P&gt;
     *  @return   ShiftSwapPosting Object
     *
     */
    @Override
	public SSPostingCollection findShiftSwapPostingsByCampaign(ID campaignID, long detailLevel, int chunkSize)
			throws BbmFinderException, RmHardValidationException {
<span class="nc" id="L695">        String _method_ = &quot;findShiftSwapPostingsByCampaign&quot;;</span>
<span class="nc" id="L696">        methodStart(_method_, campaignID, new Integer(chunkSize));</span>

<span class="nc" id="L698">        ShiftSwapPostingDAO sspDAO = null;</span>

        try {
<span class="nc" id="L701">            List&lt;ID&gt; postingIDs = Collections.emptyList();</span>
<span class="nc" id="L702">            Collection&lt;ShiftSwapPosting&gt; postings = Collections.emptyList();</span>
<span class="nc" id="L703">            sspDAO = new ShiftSwapPostingDAO(detailLevel);</span>

			// if pagination is enabled
<span class="nc bnc" id="L706" title="All 2 branches missed.">            if (chunkSize != SupportNavigation.CHUNKSIZE_ALL) {</span>
				// first fetch posting IDs
<span class="nc" id="L708">                postingIDs = sspDAO.findSSPostingIDsByCampaign(campaignID);</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">				if (!postingIDs.isEmpty()) {</span>
					// fetch minimum(postingIDs.size(), chunkSize);
<span class="nc bnc" id="L711" title="All 2 branches missed.">					int numOfPostings = (postingIDs.size() &lt; chunkSize)?postingIDs.size():chunkSize;</span>
					// fetch the chunk of requested postings
<span class="nc" id="L713">	                postings = sspDAO.findSSPostingsByIDs(postingIDs.subList(0, numOfPostings), detailLevel);</span>
<span class="nc" id="L714">				}</span>
            } else {
				// pagination not enabled, so fetch all postings (bypass fetching of posting IDs).
<span class="nc" id="L717">                postings = sspDAO.findSSPostingsByCampaign(campaignID, detailLevel);</span>
            }

<span class="nc" id="L720">            return new SSPostingCollection(postingIDs, postings, chunkSize);</span>
<span class="nc" id="L721">		} catch (RmHardValidationException e) {</span>
			// RM exceptions are always logged before they are thrown.
			//m_cat.error(e,e);

            // Logged with priority 'debug' since this exception is generated by RM during validations or
            // workflow processing and happens often during normal operation.  If logged with a different
            // priority level (like info), it may pollute the log files with unwanted messages.
<span class="nc" id="L728">            handleException(Priority.DEBUG, e);</span>
<span class="nc" id="L729">			throw e;</span>
<span class="nc" id="L730">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L731">        	m_cat.error(e,e);</span>
<span class="nc" id="L732">        	handleException(e);</span>
<span class="nc" id="L733">        	throw e;</span>
<span class="nc" id="L734">        } catch (Exception e) {</span>
<span class="nc" id="L735">            handleException(e);</span>
<span class="nc" id="L736">            throw RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
        } finally {
<span class="nc bnc" id="L738" title="All 4 branches missed.">            if (sspDAO != null) sspDAO.cleanUp();</span>
<span class="nc" id="L739">            methodFinish();</span>
        }
    }

    /**
     * &lt;B&gt;findShiftSwapPostingIDsByCampaign&lt;/B&gt;
     * &lt;P&gt;Params  ID
     * returns ShiftSwapPosting Object
     * &lt;P&gt;
     *  @return   ShiftSwapPosting Object
     *
     */
    @Override
	public Collection&lt;ID&gt; findShiftSwapPostingIDsByCampaign(ID campaignID)
			throws BbmFinderException, RmHardValidationException {
<span class="nc" id="L754">        String _method_ = &quot;findShiftSwapPostingIDsByCampaign&quot;;</span>
<span class="nc" id="L755">        methodStart(_method_, campaignID);</span>

<span class="nc" id="L757">        ShiftSwapPostingDAO sspDAO = null;</span>

        try {
<span class="nc" id="L760">            sspDAO = new ShiftSwapPostingDAO(ShiftSwapPosting.DL_BASIC);</span>
<span class="nc" id="L761">            Collection&lt;ID&gt; postings = sspDAO.findSSPostingIDsByCampaign(campaignID);</span>

<span class="nc" id="L763">            return postings;</span>
<span class="nc" id="L764">		} catch (RmHardValidationException e) {</span>
			// RM exceptions are always logged before they are thrown.
			//m_cat.error(e,e);

            // Logged with priority 'debug' since this exception is generated by RM during validations or
            // workflow processing and happens often during normal operation.  If logged with a different
            // priority level (like info), it may pollute the log files with unwanted messages.
<span class="nc" id="L771">            handleException(Priority.DEBUG, e);</span>
<span class="nc" id="L772">			throw e;</span>
<span class="nc" id="L773">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L774">        	m_cat.error(e,e);</span>
<span class="nc" id="L775">        	handleException(e);</span>
<span class="nc" id="L776">        	throw e;</span>
<span class="nc" id="L777">        } catch (Exception e) {</span>
<span class="nc" id="L778">            handleException(e);</span>
<span class="nc" id="L779">            throw RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
        } finally {
<span class="nc bnc" id="L781" title="All 4 branches missed.">            if (sspDAO != null) sspDAO.cleanUp();</span>
<span class="nc" id="L782">            methodFinish();</span>
        }
    }

    /**
     * Finds postings which belong to the specified employee's org between now and into the future.
     * Note that the employee's organization association may change with time.
     * Postings are fetched from employees in each org that the specified employee belongs to.
     *
     * @param empID
     * @param detailLevel
     * @param chunkSize
     * @param fetchMode {@link #FETCHMODE_ALLPOSTINGS FETCHMODE_ALLPOSTINGS} or {@link #FETCHMODE_MYORGPOSTINGS FETCHMODE_MYORGPOSTINGS}
     * @return
     * @throws Exception
     */
    protected SSPostingCollection findShiftSwapPostingsForEmpOrgByMode(ID empID, long detailLevel,
        int chunkSize, int fetchMode, boolean fetchPartial) throws Exception {

<span class="nc" id="L801">        ShiftSwapPostingDAO ssPostingDAO = null;</span>

        try {
<span class="nc" id="L804">            List&lt;ID&gt; postingIDs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L805">            Collection&lt;ShiftSwapPosting&gt; postings = new ArrayList&lt;&gt;();</span>

            // Get employee-organization associations for this employee for the time interval 'now' to max time.
//            WorkResourceManager wrm = BbmManagerFactory.getWorkResourceManager();
//            Collection wrAssignments = wrm.getWorkResourceAssignments(empID, new Date(), null, false);
<span class="nc" id="L810">            Collection wrAssignments = ValidationUtil.getWorkResAssnWithTZForWRID(empID, new Date(), null);</span>

<span class="nc" id="L812">            ssPostingDAO = new ShiftSwapPostingDAO(detailLevel);</span>
			// if pagination is enabled
<span class="nc bnc" id="L814" title="All 2 branches missed.">            boolean paginationEnabled = chunkSize != SupportNavigation.CHUNKSIZE_ALL;</span>
            // for each workresource assignment.
<span class="nc bnc" id="L816" title="All 2 branches missed.">			for (Iterator wrAssnsIter = wrAssignments.iterator(); wrAssnsIter.hasNext();) {</span>
<span class="nc" id="L817">                WorkResourceAssignment wrAssn = (WorkResourceAssignment) wrAssnsIter.next();</span>

                // get orgID for employee.
<span class="nc" id="L820">                ID empOrgID = wrAssn.getOrganizationID();</span>

<span class="nc" id="L822">                Collection&lt;ID&gt; swappableOrgIDs = null;</span>
<span class="nc bnc" id="L823" title="All 2 branches missed.">                if ( fetchMode == FETCHMODE_ALLPOSTINGS ) {</span>
					// get orgs this org can swap with.
<span class="nc" id="L825">                    swappableOrgIDs = ShiftSwapRequestUtil.getSwappableOrgIDsForOrg(empOrgID);</span>

                    // if this org cannot swap with any org, then continue with next emp-org association
<span class="nc bnc" id="L828" title="All 2 branches missed.">                    if ( swappableOrgIDs.isEmpty() ) continue;</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">                } else if (fetchMode == FETCHMODE_MYORGPOSTINGS) {</span>
                    // check if the organization can swap with self (fetching postings for myorg).
<span class="nc bnc" id="L831" title="All 2 branches missed.">                    if (!ShiftSwapRequestUtil.canOrg1SwapWithOrg2(empOrgID, empOrgID, null))</span>
<span class="nc" id="L832">                        continue;</span>
                } else {
<span class="nc" id="L834">                    throw new IllegalArgumentException(&quot;fetchMode = &quot;  + fetchMode);</span>
                }

                // if pagination enabled, then first fetch posting IDs
<span class="nc bnc" id="L838" title="All 2 branches missed.">                if (paginationEnabled) {</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">                    if (fetchMode == FETCHMODE_ALLPOSTINGS) {</span>
						// first fetch posting IDs
<span class="nc" id="L841">                        postingIDs.addAll(ssPostingDAO.findAllSSPostingIDsForEmp(empID, swappableOrgIDs,</span>
<span class="nc" id="L842">                            wrAssn.getStartTime(), wrAssn.getEndTime(), fetchPartial));</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">                    } else if (fetchMode == FETCHMODE_MYORGPOSTINGS) {</span>
						// first fetch posting IDs
<span class="nc" id="L845">                        postingIDs.addAll(ssPostingDAO.findSSPostingIDsForMyOrg(empID,</span>
<span class="nc" id="L846">                            empOrgID, wrAssn.getStartTime(), wrAssn.getEndTime(), fetchPartial));</span>
                    }
                } else { // if pagination not enabled, then fetch the postings (do not have to fetch the IDs).
<span class="nc bnc" id="L849" title="All 2 branches missed.">                    if (fetchMode == FETCHMODE_ALLPOSTINGS) {</span>
						// pagination not enabled, so fetch all postings (bypass fetching of posting IDs).
<span class="nc" id="L851">                        postings.addAll(ssPostingDAO.findAllSSPostingsForEmp(empID, swappableOrgIDs,</span>
<span class="nc" id="L852">                            wrAssn.getStartTime(), wrAssn.getEndTime(), detailLevel, fetchPartial));</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">                    } else if (fetchMode == FETCHMODE_MYORGPOSTINGS) {</span>
						// pagination not enabled, so fetch all postings (bypass fetching of posting IDs).
<span class="nc" id="L855">                        postings.addAll(ssPostingDAO.findSSPostingsForMyOrg(empID,</span>
<span class="nc" id="L856">                            empOrgID, wrAssn.getStartTime(), wrAssn.getEndTime(), detailLevel, fetchPartial));</span>
                    }
                }
<span class="nc" id="L859">            }</span>

            // if pagination is enabled, then fetch the specified chunk of requests using the IDs fetched earlier.
<span class="nc bnc" id="L862" title="All 4 branches missed.">            if (paginationEnabled &amp;&amp; !postingIDs.isEmpty()) {</span>
<span class="nc bnc" id="L863" title="All 4 branches missed.">                if (fetchMode == FETCHMODE_ALLPOSTINGS || fetchMode == FETCHMODE_MYORGPOSTINGS) {</span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">					if (!postingIDs.isEmpty()) {</span>
						// fetch minimum(postingIDs.size(), chunkSize);
<span class="nc bnc" id="L866" title="All 2 branches missed.">						int numOfPostings = (postingIDs.size() &lt; chunkSize)?postingIDs.size():chunkSize;</span>
						// fetch the chunk of requested postings
<span class="nc" id="L868">	                    postings = ssPostingDAO.findSSPostingsByIDs(postingIDs.subList(0, numOfPostings), detailLevel);</span>
					}
                }
            }

<span class="nc" id="L873">            return new SSPostingCollection(postingIDs, postings, chunkSize);</span>
        } finally {
<span class="nc bnc" id="L875" title="All 4 branches missed.">            if (ssPostingDAO != null) ssPostingDAO.cleanUp();</span>
        }
    }

    /*
     * See {@link ShiftSwapPostingManager#findAllShiftSwapPostings(ID, int) findAllShiftSwapPostings(ID, int)}
     *
     * @param empID
     * @param chunkSize
     * @return
     * @throws BbmFinderException
     * @throws
     */
    @Override
	public SSPostingCollection findAllShiftSwapPostings(ID empID, long detailLevel, int chunkSize, boolean fetchPartial)
			throws BbmFinderException, RmHardValidationException {
<span class="nc" id="L891">        String _method_ = &quot;findAllShiftSwapPostings&quot;;</span>
<span class="nc" id="L892">        methodStart(_method_, empID, new Integer(chunkSize));</span>

        try {
<span class="nc" id="L895">            return findShiftSwapPostingsForEmpOrgByMode(empID, detailLevel, chunkSize, FETCHMODE_ALLPOSTINGS, fetchPartial);</span>
<span class="nc" id="L896">		} catch (RmHardValidationException e) {</span>
			// RM exceptions are always logged before they are thrown.
			//m_cat.error(e,e);

            // Logged with priority 'debug' since this exception is generated by RM during validations or
            // workflow processing and happens often during normal operation.  If logged with a different
            // priority level (like info), it may pollute the log files with unwanted messages.
<span class="nc" id="L903">            handleException(Priority.DEBUG, e);</span>
<span class="nc" id="L904">			throw e;</span>
<span class="nc" id="L905">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L906">        	m_cat.error(e,e);</span>
<span class="nc" id="L907">        	handleException(e);</span>
<span class="nc" id="L908">        	throw e;</span>
<span class="nc" id="L909">        } catch (Exception e) {</span>
<span class="nc" id="L910">            handleException(e);</span>
<span class="nc" id="L911">            throw RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
        } finally {
<span class="nc" id="L913">            methodFinish();</span>
        }
    }

    /*public Collection findShiftSwapPostingsForMyCampaign(ID empID) throws Exception
    {
    	Date now = new Date();

    	// get all campaign work resource assignments (and their effectivity periods) for the
    	// given employee starting now
    	Collection campWorkResAssnsForEmp = RequestUtil.getCampaignAssnsForWorkResDuringPeriod(
    		empID, now, null);

    	// Note: CA == campaign assocication; WR == Work resource.
    	// for each campaign
    	//    get my CA time range.
    	//    get all WRs if their CA time range overlaps my CA time range
    	//
		//    get all shift swap postings by the WRs during my CA time range.
    	//
		//    for each posting
		//       if posting time range falls within WR's CA time range, posting accepted.
		//    end for
    	// end
		for (Iterator itr = campWorkResAssnsForEmp.iterator(); itr.hasNext(); ) {
			CampaignWorkResource myCampWorkResAssn = (CampaignWorkResource) itr.next();

			TimeRange myCampAssocTR = new TimeRange(myCampWorkResAssn.getStartTime(),
				myCampWorkResAssn.getEndTime());

			Collection campWorkResAssns = getCampWorkResAssnsForCampaignDuringInterval(
				myCampWorkResAssn.getCampaignID(), myCampAssocTR);

			Collection orgWorkResAssns = getOrgWorkResAssnsForWorkResesDuringInterval(
				campWorkResAssns, myCampAssocTR);

			Collection SSPostings = findShiftSwapPostingsForEmpsDuringPeriod(
				campWorkResAssns, myCampAssocTR);
		}



    	/*
    	Set swappableEmpIDSet = (Set) RequestUtil.getEmployeesOneCanSwapWith(empID).getFirst();

    	// for ( each campaign )
    	//    get employees associated with the campaign
    	//    obtain employees which belong to both the campaign and list of employees this agent can swap with (using shift swap org setting).
    	//    obtain postings for these employees during the campaign assignment period.
    	// end for
    	for (Iterator itr = campWorkResAssnsForEmp.iterator(); itr.hasNext(); ) {
    		CampaignWorkResource campWorkRes = (CampaignWorkResource) itr.next();
    		Date campAssnStart = campWorkRes.getStartTime();
    		Date campAssnEnd = campWorkRes.getEndTime();

    		Date start = campAssnStart.after(now)?campAssnStart:now;
    		Date end = campAssnEnd.before(start)?start:campAssnEnd;

    		Collection campWorkResAssnsForCamp = RequestUtil.geWorkResAssnsForCampaignDuringPeriod(
    			campWorkRes.getCampaignID(), start, end );

			HashSet empSet = new HashSet(10);
			for (Iterator iter = campWorkResAssnsForCamp.iterator(); iter.hasNext(); ) {
                CampaignWorkResource campWorkResAssn = (CampaignWorkResource) iter.next();
				empSet.add(campWorkResAssn.getWorkResourceID());
            }

			empSet.retainAll(swappableEmpIDSet);

			findShiftSwapPostingsForEmpsDuringPeriod(empSet, start, end);
    	}* /
    }*/

	@Override
	public SSPostingCollection findShiftSwapPostingsForMyOrg(ID workResID, long detailLevel, int chunkSize, boolean fetchPartial)
			throws BbmFinderException, RmHardValidationException {
<span class="nc" id="L989">        String _method_ = &quot;findShiftSwapPostingsForMyOrg&quot;;</span>
<span class="nc" id="L990">        methodStart(_method_, workResID, new Integer(chunkSize));</span>

        try {
<span class="nc" id="L993">            return findShiftSwapPostingsForEmpOrgByMode(workResID, detailLevel, chunkSize, FETCHMODE_MYORGPOSTINGS, fetchPartial);</span>
<span class="nc" id="L994">		} catch (RmHardValidationException e) {</span>
			// RM exceptions are always logged before they are thrown.
			//m_cat.error(e,e);

            // Logged with priority 'debug' since this exception is generated by RM during validations or
            // workflow processing and happens often during normal operation.  If logged with a different
            // priority level (like info), it may pollute the log files with unwanted messages.
<span class="nc" id="L1001">            handleException(Priority.DEBUG, e);</span>
<span class="nc" id="L1002">			throw e;</span>
<span class="nc" id="L1003">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1004">        	m_cat.error(e,e);</span>
<span class="nc" id="L1005">        	handleException(_method_, e);</span>
<span class="nc" id="L1006">        	throw e;</span>
<span class="nc" id="L1007">        } catch (Exception e) {</span>
<span class="nc" id="L1008">            handleException(e);</span>
<span class="nc" id="L1009">            throw RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
        } finally {
<span class="nc" id="L1011">            methodFinish();</span>
        }
	}

    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.rm.requests.swap.posting.ejb.IShiftSwapPostingManager#findShiftSwapPostingsForMyCampaign(com.bluepumpkin.common.datatypes.ID, long, int)
     */
    @Override
	public SSPostingCollection findShiftSwapPostingsForMyCampaign(ID empID, boolean isIncludePartial,
			PaginationInfo&lt;ShiftSwapPostingSortField&gt; pagination)
			throws BbmFinderException {
<span class="nc" id="L1022">		methodStartHelper(&quot;findShiftSwapPostingsForMyCampaign&quot;, new Object[] { empID, isIncludePartial, pagination });</span>

<span class="nc" id="L1024">		ShiftSwapPostingDAO ssPostingDAO = null;</span>
		try {
<span class="nc" id="L1026">			Date currDate = new Date();</span>

			// QC-94774 fix : passed current date to fetch the workResourceAss on current date only .
<span class="nc" id="L1029">			Collection&lt;WorkResourceAssignment&gt; wrAssns = ValidationUtil.getWorkResAssnWithTZForWRID(empID, currDate, currDate);</span>

			// In London, an employee must have exactly one work resource assignment. This code relies on this fact.
<span class="nc bnc" id="L1032" title="All 2 branches missed.">			if (wrAssns.size() != 1) {</span>
<span class="nc" id="L1033">				throw new IllegalStateException(&quot;wrAssns.size() != 1 for workRes.  size, workResID = : &quot; +</span>
<span class="nc" id="L1034">						wrAssns.size() + ',' + empID);</span>
			}

<span class="nc" id="L1037">			ID empOrgID = wrAssns.iterator().next().getOrganizationID();</span>
<span class="nc" id="L1038">			Collection&lt;ID&gt; swappableOrgIDs = ShiftSwapRequestUtil.getSwappableOrgIDsForOrg(empOrgID);</span>

<span class="nc bnc" id="L1040" title="All 2 branches missed.">			if (swappableOrgIDs.isEmpty()) {</span>
<span class="nc" id="L1041">				return new SSPostingCollection(Collections.emptyList(), Collections.emptyList(), pagination.getPageSize());</span>
			}

<span class="nc" id="L1044">			ssPostingDAO = new ShiftSwapPostingDAO(ShiftSwapPosting.DL_ALL);</span>

<span class="nc" id="L1046">			return ssPostingDAO.findSSPostingsForMyCampaign(empID, isIncludePartial, swappableOrgIDs, pagination);</span>
<span class="nc" id="L1047">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L1048">			m_cat.error(e, e);</span>
<span class="nc" id="L1049">			handleException(e);</span>
<span class="nc" id="L1050">			throw e;</span>
<span class="nc" id="L1051">		} catch (Exception e) {</span>
<span class="nc" id="L1052">			handleException(e);</span>
<span class="nc" id="L1053">			throw RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>

		} finally {
<span class="nc bnc" id="L1056" title="All 6 branches missed.">			if (ssPostingDAO != null)</span>
<span class="nc" id="L1057">				ssPostingDAO.cleanUp();</span>
<span class="nc" id="L1058">			methodFinish();</span>
		}
	}

    @Override
	public List&lt;ID&gt; findShiftSwapPostingIDsFromEmps(ID empID, Collection&lt;ID&gt; postingsFromEmpIDs,
			Date start, Date end) throws BbmFinderException, RmHardValidationException {
<span class="nc" id="L1065">        String _method_ = &quot;findShiftSwapPostingIDsFromEmps&quot;;</span>
<span class="nc" id="L1066">        methodStart(_method_, empID, postingsFromEmpIDs, start, end);</span>

<span class="nc" id="L1068">        ShiftSwapPostingDAO sspDAO = null;</span>
        try {
<span class="nc" id="L1070">            sspDAO = new ShiftSwapPostingDAO(ShiftSwapPosting.DL_BASIC);</span>

<span class="nc" id="L1072">            Collection&lt;WorkResourceAssignment&gt; wrAssns = ValidationUtil.getWorkResAssnWithTZForWRID(empID, start, end);</span>

<span class="nc" id="L1074">            List&lt;ID&gt; sspIDs = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1075" title="All 2 branches missed.">            for (Iterator&lt;WorkResourceAssignment&gt; wrAssnsIter = wrAssns.iterator(); wrAssnsIter.hasNext();) {</span>
<span class="nc" id="L1076">                WorkResourceAssignment wrAssn = wrAssnsIter.next();</span>

<span class="nc" id="L1078">                Collection&lt;ID&gt; swappableOrgIDs =</span>
<span class="nc" id="L1079">                    ShiftSwapRequestUtil.getSwappableOrgIDsForOrg(wrAssn.getOrganizationID());</span>

<span class="nc bnc" id="L1081" title="All 2 branches missed.">                if (swappableOrgIDs.size() == 0) continue;</span>

<span class="nc" id="L1083">                Date effectStart = wrAssn.getStartTime();</span>
<span class="nc" id="L1084">                Date effectEnd = wrAssn.getEndTime();</span>
<span class="nc" id="L1085">                sspIDs.addAll(sspDAO.findSSPostingIDsFromSwappableEmps(empID, swappableOrgIDs,</span>
<span class="nc bnc" id="L1086" title="All 2 branches missed.">                    postingsFromEmpIDs, effectStart.after(start)?effectStart:start,</span>
<span class="nc bnc" id="L1087" title="All 2 branches missed.">                    effectEnd.before(end)?effectEnd:end));</span>
<span class="nc" id="L1088">            }</span>

<span class="nc" id="L1090">            return sspIDs;</span>
<span class="nc" id="L1091">		} catch (RmHardValidationException e) {</span>
			// RM exceptions are always logged before they are thrown.
			//m_cat.error(e,e);

            // Logged with priority 'debug' since this exception is generated by RM during validations or
            // workflow processing and happens often during normal operation.  If logged with a different
            // priority level (like info), it may pollute the log files with unwanted messages.
<span class="nc" id="L1098">            handleException(Priority.DEBUG, e);</span>
<span class="nc" id="L1099">			throw e;</span>
<span class="nc" id="L1100">        } catch (BbmFinderException e) {</span>
<span class="nc" id="L1101">        	m_cat.error(e,e);</span>
<span class="nc" id="L1102">        	handleException(e);</span>
<span class="nc" id="L1103">        	throw e;</span>
<span class="nc" id="L1104">        } catch (Exception e) {</span>
<span class="nc" id="L1105">            handleException(e);</span>
<span class="nc" id="L1106">            throw RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
        } finally {
<span class="nc bnc" id="L1108" title="All 4 branches missed.">            if (sspDAO != null) sspDAO.cleanUp();</span>
<span class="nc" id="L1109">            methodFinish();</span>
        }
    }

    @Override
	public Collection&lt;ShiftSwapPosting&gt; findNextShiftSwapPostings(List ssPostingIDs, long detailLevel)
			throws BbmFinderException, RmHardValidationException {
<span class="nc" id="L1116">        String _method_ = &quot;findNextShiftSwapPosting&quot;;</span>
<span class="nc" id="L1117">        methodStart(_method_, ssPostingIDs);</span>

<span class="nc" id="L1119">        ShiftSwapPostingDAO ssPostingDAO = null;</span>
        try {
<span class="nc" id="L1121">            ssPostingDAO = new ShiftSwapPostingDAO(detailLevel);</span>
<span class="nc" id="L1122">            return ssPostingDAO.findSSPostingsByIDs(ssPostingIDs, detailLevel);</span>
<span class="nc" id="L1123">		} catch (RmHardValidationException e) {</span>
			// RM exceptions are always logged before they are thrown.
			//m_cat.error(e,e);

            // Logged with priority 'debug' since this exception is generated by RM during validations or
            // workflow processing and happens often during normal operation.  If logged with a different
            // priority level (like info), it may pollute the log files with unwanted messages.
<span class="nc" id="L1130">            handleException(Priority.DEBUG, e);</span>
<span class="nc" id="L1131">			throw e;</span>
<span class="nc" id="L1132">        }  catch (BbmFinderException e) {</span>
<span class="nc" id="L1133">        	m_cat.error(e,e);</span>
<span class="nc" id="L1134">        	handleException(e);</span>
<span class="nc" id="L1135">        	throw e;</span>
<span class="nc" id="L1136">        } catch (Exception e) {</span>
<span class="nc" id="L1137">            handleException(e);</span>
<span class="nc" id="L1138">            throw RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
        } finally {
<span class="nc bnc" id="L1140" title="All 4 branches missed.">            if (ssPostingDAO != null) ssPostingDAO.cleanUp();</span>
<span class="nc" id="L1141">            methodFinish();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>