<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeSeriesReportFacadeManagerEJB.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.timeseries.ejb</a> &gt; <span class="el_source">TimeSeriesReportFacadeManagerEJB.java</span></div><h1>TimeSeriesReportFacadeManagerEJB.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.timeseries.ejb;

import java.text.SimpleDateFormat;
import java.util.Map;
import com.bluepumpkin.common.config.ConfigManager;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.audit.model.AuditTrailEntry;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignQueue;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.config.ejb.DBConfigManager;
import com.bluepumpkin.ejb.bbm.l10n.BbmEjbLogBundleKey;
import com.bluepumpkin.ejb.bbm.workload.ejb.WorkloadManager;
import com.bluepumpkin.ejb.bbm.workload.model.Media;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.core.base.SessionEJBBase;
import com.verint.ejb.wfm.WfmManagerFactory;

import javax.naming.Context;
import javax.naming.InitialContext;
import java.rmi.RemoteException;
import java.util.*;

/**
 * Title:        TimeSeriesReportFacadeManagerEJB
 * Description:  TimeSeriesReportFacadeManagerEJB EJB implementation
 * Copyright:    Copyright (c) 2002 - 2016
 * Company:      Verint Systems, inc
 */

<span class="nc" id="L40">public class TimeSeriesReportFacadeManagerEJB extends SessionEJBBase {</span>
	/**
	 *
	 */
	private static final long serialVersionUID = 1L;

<span class="nc" id="L46">	private static Category m_cat = Log.initCategory(TimeSeriesReportFacadeManagerEJB.class.getName());</span>

	private TimeSeriesReportDumpManager m_TimeSeriesReportDumpManager;
	private WorkloadManager m_WorkloadManager;
	private CampaignManager m_CampaignManager;
	private DBConfigManager m_dbConfigManager;

<span class="nc" id="L53">	private static int LOOKBACKMONTH = 2;</span>
<span class="nc" id="L54">	private static int LOOKFORWARDMONTH = 2;</span>


	// override the base class to provide the appropriate logging category
	protected Category getCategory() {
<span class="nc" id="L59">		return m_cat;</span>
	}

	{
<span class="nc" id="L63">		super.init(TimeSeriesReportFacadeManagerEJB.class.getName());</span>
	}

<span class="nc" id="L66">	private boolean WhatIfMode = false;</span>

	public void ejbCreate() {
		try {
			// First query environment to get WIF setting from DD
<span class="nc" id="L71">			Context initialContext = new InitialContext();</span>
<span class="nc" id="L72">			Boolean WIF = (Boolean) initialContext.lookup(&quot;java:comp/env/WIF&quot;);</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">			if (WIF != null) {</span>
<span class="nc" id="L74">				WhatIfMode = WIF.booleanValue();</span>
			}
<span class="nc" id="L76">			m_TimeSeriesReportDumpManager = BbmManagerFactory.getTimeSeriesReportManager(WhatIfMode);</span>
<span class="nc" id="L77">			m_WorkloadManager = WfmManagerFactory.getWorkloadManager(WhatIfMode);</span>
<span class="nc" id="L78">			m_CampaignManager = WfmManagerFactory.getCampaignManager(WhatIfMode);</span>
<span class="nc" id="L79">			m_dbConfigManager = BbmManagerFactory.getDBConfigManager(WhatIfMode);</span>
<span class="nc" id="L80">			String lookBack = BbmManagerFactory.getDBConfigManager(WhatIfMode).getValue(&quot;PERFREPORTLOOKBACK&quot;);</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">			if (lookBack != null) {</span>
				try {
<span class="nc" id="L83">					LOOKBACKMONTH = Integer.parseInt(lookBack);</span>
<span class="nc" id="L84">				} catch (Exception e) {</span>
<span class="nc" id="L85">					m_cat.info(&quot;Invalid value set for LookBackMonth, &quot; + lookBack);</span>
<span class="nc" id="L86">				}</span>
			}
<span class="nc" id="L88">		} catch (Exception e) {</span>
<span class="nc" id="L89">			handleException(&quot;ejbCreate&quot;, e);</span>
<span class="nc" id="L90">		}</span>
<span class="nc" id="L91">	}</span>

	private boolean isMultiVQCampaign(ID cpgID, ID mediaID, Date start, Date end) throws BbmFinderException, RemoteException {
<span class="nc" id="L94">		Collection subCpg = m_CampaignManager.getSubCampaignIDs(cpgID);</span>
<span class="nc" id="L95">		ID realMediaID = null;</span>
<span class="nc bnc" id="L96" title="All 4 branches missed.">		if (mediaID != null &amp;&amp; mediaID.equals(new ID(-10))) {</span>
<span class="nc" id="L97">			realMediaID = null;</span>
		}
<span class="nc bnc" id="L99" title="All 2 branches missed.">		if (subCpg.isEmpty()) {</span>
			// if the Campaign has DQ/VQ, still a multi-site case
<span class="nc" id="L101">			boolean hasDistributedQueue = false;</span>
<span class="nc" id="L102">			Collection queueAssignment = m_CampaignManager.getCampaignQueueAssignments(cpgID, realMediaID, start, end);</span>
<span class="nc" id="L103">			HashSet queueSet = new HashSet();</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">			for (Iterator it = queueAssignment.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L105">				CampaignQueue cq = (CampaignQueue) it.next();</span>
<span class="nc" id="L106">				ID qID = cq.getQueueID();</span>
<span class="nc" id="L107">				queueSet.add(qID);</span>
<span class="nc" id="L108">			}</span>
<span class="nc" id="L109">			Collection qs = m_WorkloadManager.getQueuesByIDs(queueSet);</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">			for (Iterator it = qs.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L111">				Queue q = (Queue) it.next();</span>
<span class="nc bnc" id="L112" title="All 4 branches missed.">				if (q.getQueueType() == Queue.QUEUE_TYPE_DISTRIBUTED || q.getQueueType() == Queue.QUEUE_TYPE_VIRTUAL) {</span>
<span class="nc" id="L113">					hasDistributedQueue = true;</span>
<span class="nc" id="L114">					break;</span>
				}
<span class="nc" id="L116">			}</span>
<span class="nc" id="L117">			return hasDistributedQueue;</span>
		}
<span class="nc" id="L119">		return true;</span>
	}

	/**
	 * Dump a Queue's TimeSeries into different schema for report
	 * It will dump all statistics, each 15 minutes per row
	 */
	public void dumpTimeSeries() throws BbmCreateException {
<span class="nc" id="L127">		methodStart(&quot;dumpTimeSeries&quot;);</span>
		// Determine the dump window as current date's 2 months back, and 2 month into future
		//Changes start for QA100626 starts
<span class="nc" id="L130">		int iLookForwardMonth = ConfigManager.NOVALUE;</span>
		try {
<span class="nc" id="L132">			iLookForwardMonth = BbmManagerFactory.getDBConfigManager().getIntValue(ConfigKey.CRYSTAL_REPORTS_TIMSERIES_LOOKFORWARD_MONTH);</span>
<span class="nc" id="L133">		} catch (Exception e) {</span>
<span class="nc" id="L134">			m_cat.debug(&quot;Exception while getting value for CRYSTAL_REPORTS_TIMSERIES_LOOKFORWARD_MONTH:&quot; + e);</span>
<span class="nc" id="L135">		}</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">		if (iLookForwardMonth != ConfigManager.NOVALUE) {</span>
<span class="nc" id="L137">			LOOKFORWARDMONTH = iLookForwardMonth;</span>
		}
<span class="nc" id="L139">		Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L140">		cal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L141">		cal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L142">		cal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L143">		cal.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L144">		cal.set(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L145">		cal.add(Calendar.MONTH, LOOKFORWARDMONTH);//QA100626</span>
<span class="nc" id="L146">		cal.add(Calendar.DAY_OF_MONTH, 2);</span>
<span class="nc" id="L147">		Date end = cal.getTime();</span>
<span class="nc" id="L148">		cal.add(Calendar.MONTH, -(LOOKFORWARDMONTH + LOOKBACKMONTH));//QA100626</span>
<span class="nc" id="L149">		cal.add(Calendar.DAY_OF_MONTH, -4);</span>
<span class="nc" id="L150">		Date start = cal.getTime();</span>
<span class="nc" id="L151">		dumpTimeSeries(start, end, true);</span>
<span class="nc" id="L152">	}</span>

	public void dumpTimeSeries(Date start, Date end) throws BbmCreateException {
<span class="nc" id="L155">		dumpTimeSeries(start, end, false);</span>
<span class="nc" id="L156">	}</span>

	private void dumpTimeSeries(Date start, Date end, boolean alwaysUpdateDumpLog) throws BbmCreateException {
<span class="nc" id="L159">		m_cat.info(&quot;start: dumpTimeSeries from &quot; + start + &quot; up to &quot; + end);</span>
<span class="nc" id="L160">		long timeSinceStart = new java.util.Date().getTime();</span>
<span class="nc" id="L161">		long maxDumpRangeInMilliSecs = (long) (TimeZoneUtil.DAY_IN_MILLISECONDS * getMaxRefreshDays());</span>
<span class="nc bnc" id="L162" title="All 4 branches missed.">		if (start == null &amp;&amp; end == null) {</span>
<span class="nc" id="L163">			return;</span>
		}
<span class="nc bnc" id="L165" title="All 2 branches missed.">		if (end == null) {</span>
<span class="nc" id="L166">			end = new Date(start.getTime() + maxDumpRangeInMilliSecs - 1);</span>
		}
<span class="nc bnc" id="L168" title="All 2 branches missed.">		if (start == null) {</span>
<span class="nc" id="L169">			start = new Date(end.getTime() - maxDumpRangeInMilliSecs + 1);</span>
		}
<span class="nc" id="L171">		Date chunkDumpTimeStart = new Date(start.getTime());</span>
<span class="nc" id="L172">		int count = 0;</span>
<span class="nc" id="L173">		HashMap queMediaMap = new HashMap();</span>
<span class="nc" id="L174">		HashMap mediaMap = new HashMap();</span>
<span class="nc" id="L175">		ArrayList exceptions = new ArrayList();</span>
		while (true) {
<span class="nc" id="L177">			Date chunkDumpTimeEnd = new Date(chunkDumpTimeStart.getTime() + maxDumpRangeInMilliSecs - 1);</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">			if (chunkDumpTimeEnd.getTime() &gt; end.getTime()) {</span>
<span class="nc" id="L179">				chunkDumpTimeEnd = end;</span>
			}
<span class="nc" id="L181">			m_cat.info(&quot;Dumping  dumpSingleQueueTimeSeries chunk from:&quot; + chunkDumpTimeStart + &quot; up to &quot; + chunkDumpTimeEnd + &quot;;count=&quot; + (++count));</span>
<span class="nc" id="L182">			dumpSingleQueueTimeSeriesInChunk(chunkDumpTimeStart, chunkDumpTimeEnd, alwaysUpdateDumpLog, queMediaMap, mediaMap, exceptions, count);</span>
<span class="nc" id="L183">			chunkDumpTimeStart = new Date(chunkDumpTimeStart.getTime() + maxDumpRangeInMilliSecs);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">			if (chunkDumpTimeStart.getTime() &gt; end.getTime()) {</span>
<span class="nc" id="L185">				break;</span>
			}
<span class="nc" id="L187">		}</span>
		
		//default value
<span class="nc" id="L190">		long combinedQChunkSize = getCombinedQChunkSize(maxDumpRangeInMilliSecs);</span>
<span class="nc" id="L191">		chunkDumpTimeStart = new Date(start.getTime());</span>
<span class="nc" id="L192">		count = 0;</span>
		while (true) {
<span class="nc" id="L194">			Date chunkDumpTimeEnd = new Date(chunkDumpTimeStart.getTime() + combinedQChunkSize - 1);</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">			if (chunkDumpTimeEnd.getTime() &gt; end.getTime()) {</span>
<span class="nc" id="L196">				chunkDumpTimeEnd = end;</span>
			}
<span class="nc" id="L198">			m_cat.info(&quot;Dumping  dumpCombinedQueueTimeSeries chunk from:&quot; + chunkDumpTimeStart + &quot; up to &quot; + chunkDumpTimeEnd + &quot;;count=&quot; + (++count));</span>
<span class="nc" id="L199">			dumpCombinedQueueTimeSeriesInChunk(chunkDumpTimeStart, chunkDumpTimeEnd, alwaysUpdateDumpLog, queMediaMap, mediaMap, exceptions, count);</span>
<span class="nc" id="L200">			chunkDumpTimeStart = new Date(chunkDumpTimeStart.getTime() + combinedQChunkSize);</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">			if (chunkDumpTimeStart.getTime() &gt; end.getTime()) {</span>
<span class="nc" id="L202">				break;</span>
			}
<span class="nc" id="L204">		}</span>
		
<span class="nc" id="L206">		m_cat.info(&quot;Exit: dumpTimeSeries from &quot; + start + &quot; up to &quot; + end + &quot; , time reqd=&quot; + (new java.util.Date().getTime() - timeSinceStart) / 60000 + &quot; Mins In &quot; + (count - 1) + &quot;chunk(s)&quot;);</span>
		
<span class="nc bnc" id="L208" title="All 2 branches missed.">		if (!exceptions.isEmpty()) {</span>
<span class="nc" id="L209">			BbmCreateException bce = new BbmCreateException(BbmEjbLogBundleKey.TIMESERIES_DUMP_FAIL);</span>
<span class="nc" id="L210">			bce.setContent(exceptions);</span>
<span class="nc" id="L211">			throw bce;</span>
		}
<span class="nc" id="L213">	}</span>

	private long getMaxRefreshDays() {
<span class="nc" id="L216">		int nReportMaxDataRefreshDays = 130;</span>
		try {
<span class="nc" id="L218">			nReportMaxDataRefreshDays = m_dbConfigManager.getIntValue(ConfigKey.REPORTS_TIMESERIES_MAX_REFRESH_DAYS);</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">			if (nReportMaxDataRefreshDays &lt; 0) {</span>
<span class="nc" id="L220">				nReportMaxDataRefreshDays = 130;</span>
			}
<span class="nc" id="L222">		} catch (Exception e) {</span>
<span class="nc" id="L223">			m_cat.debug(e);</span>
<span class="nc" id="L224">		}</span>
<span class="nc" id="L225">		return nReportMaxDataRefreshDays;</span>
	}

	private long getCombinedQChunkSize(long defaultValue) {
<span class="nc" id="L229">		long chunkSize = defaultValue;</span>
		try {
<span class="nc" id="L231">			int chunkInDays = m_dbConfigManager.getIntValue(ConfigKey.REPORTS_TIMESERIES_DUMP_COMBINEDQ_CHUNK_IN_DAYS);</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">			if (chunkInDays &gt; 0) </span>
<span class="nc" id="L233">				chunkSize = (long) (TimeZoneUtil.DAY_IN_MILLISECONDS * chunkInDays);</span>
<span class="nc" id="L234">		} catch (Exception e) {</span>
<span class="nc" id="L235">			m_cat.debug(e);</span>
<span class="nc" id="L236">		}</span>
<span class="nc" id="L237">		return chunkSize;</span>
	}

	private boolean isForceDump24Hours() throws RemoteException {
<span class="nc" id="L241">		return m_dbConfigManager.getBooleanValue(ConfigKey.REPORTS_TIMESERIES_DUMP_24_HOURS); //&quot;bluepumpkin/report/TimeSeriesDump24Hours&quot;</span>
	}

	private void dumpSingleQueueTimeSeriesInChunk(Date start, Date end, boolean alwaysUpdateDumpLog, HashMap queMediaMap, HashMap mediaMap, ArrayList exceptions,int chunkCount) throws BbmCreateException {
<span class="nc" id="L245">		m_cat.info(&quot;ENTER: dumpSingleQueueTimeSeriesInChunk for &quot; + start + &quot; till &quot; + end);</span>
<span class="nc" id="L246">		long timeSinceStart = new java.util.Date().getTime();</span>
<span class="nc" id="L247">		int numberOfQueues = 0;</span>
<span class="nc" id="L248">		Date endTime = new Date();</span>
<span class="nc" id="L249">		String state = &quot;&quot;;</span>
		try {
			// Dump real queue first
<span class="nc" id="L252">			boolean forceDump24Hours = isForceDump24Hours();</span>
<span class="nc" id="L253">			Collection queCol = m_WorkloadManager.getAllQueues();</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">			for (Iterator it = queCol.iterator(); it.hasNext(); ) {</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">				if (m_dbConfigManager.isTemporarilyStopReportDump()) {</span>
					//stop report dump as is if this flag is set; tuser wants to suspend and start again.
<span class="nc" id="L257">					return;</span>
				}
<span class="nc" id="L259">				long timeAtLastRun = new java.util.Date().getTime();</span>
<span class="nc" id="L260">				Queue queue = (Queue) it.next();</span>
<span class="nc" id="L261">				queMediaMap.put(queue.getID(), queue.getMediaID());</span>
				// check the media of queue, if not email should consider HOO
<span class="nc" id="L263">				Media media = (Media) mediaMap.get(queue.getMediaID());</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">				if (media == null) {</span>
<span class="nc" id="L265">					media = m_WorkloadManager.getMediaByID(queue.getMediaID());</span>
<span class="nc" id="L266">					mediaMap.put(queue.getMediaID(), media);</span>
				}

<span class="nc" id="L269">				boolean fixHOO = false;</span>
<span class="nc bnc" id="L270" title="All 4 branches missed.">				if (media.getType() &amp;&amp; !forceDump24Hours) {</span>
<span class="nc" id="L271">					m_cat.debug(&quot;Queue &quot; + queue + &quot; is Immediate queue, with media id &quot; + queue.getMediaName());</span>
<span class="nc" id="L272">					fixHOO = true;</span>
				}
<span class="nc" id="L274">				m_cat.debug(&quot;Start: Dumping individual queue: &quot; + queue.getID() + &quot;, fixHOO is &quot; + fixHOO);</span>
				try {
<span class="nc" id="L276">					m_TimeSeriesReportDumpManager.dumpTimeSeriesFromLastDump(null, null, queue.getID(), start, end, alwaysUpdateDumpLog, fixHOO);</span>
<span class="nc" id="L277">				} catch (Exception e) {</span>
<span class="nc" id="L278">					Pair pair = new Pair();</span>
<span class="nc" id="L279">					pair.setFirst(queue.getID());</span>
<span class="nc" id="L280">					pair.setSecond(e);</span>
<span class="nc" id="L281">					exceptions.add(pair);</span>
<span class="nc" id="L282">					m_cat.info(&quot;Fail: Dumping individual queue: &quot; + queue.getID() + &quot;, exception is &quot; + e);</span>
<span class="nc" id="L283">					continue;</span>
<span class="nc" id="L284">				}</span>
<span class="nc" id="L285">				m_cat.info(&quot;Complete: Dumping indvl queue: &quot; + queue.getID() + &quot;, fixHOO is &quot; + fixHOO + &quot; , time=&quot; + (new java.util.Date().getTime() - timeAtLastRun));</span>
<span class="nc" id="L286">				numberOfQueues++;</span>
<span class="nc" id="L287">			}</span>
<span class="nc" id="L288">			endTime = new java.util.Date();</span>
<span class="nc" id="L289">			m_cat.info(&quot;Complete: Dumping all queues: , time reqd=&quot; + (endTime.getTime() - timeSinceStart) / 60000 + &quot; Mins&quot;);</span>
<span class="nc" id="L290">			state = &quot;Succeeded&quot;;</span>
<span class="nc" id="L291">		} catch (Exception e) {</span>
<span class="nc" id="L292">			handleException(e);</span>
<span class="nc" id="L293">			state = &quot;Failed&quot;;</span>
<span class="nc" id="L294">			throw new BbmCreateException(e);</span>
		} finally {
			//Jdmo.enablePrintlog(false,false);
<span class="nc" id="L297">			m_cat.info(&quot;Exit: dumpSingleQueueTimeSeriesInChunk for &quot; + start + &quot; till &quot; + end + &quot; , time reqd=&quot; + (endTime.getTime() - timeSinceStart) / 60000 + &quot; Mins&quot;);</span>
<span class="nc" id="L298">			Map&lt;String, Object&gt; statsMap = new HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L299">			statsMap.put(&quot;jobStart&quot;, new Date(timeSinceStart));</span>
<span class="nc" id="L300">			statsMap.put(&quot;jobEnd&quot;, endTime);</span>
<span class="nc" id="L301">			statsMap.put(&quot;numberOfSomething&quot;, numberOfQueues);</span>
<span class="nc" id="L302">			statsMap.put(&quot;duration&quot;, (endTime.getTime() - timeSinceStart) / 60000);</span>
<span class="nc" id="L303">			statsMap.put(&quot;dumpWindowStart&quot;, start);</span>
<span class="nc" id="L304">			statsMap.put(&quot;dumpWindowEnd&quot;, end);</span>
<span class="nc" id="L305">			statsMap.put(&quot;chunkCount&quot;, chunkCount);</span>
<span class="nc" id="L306">			statsMap.put(&quot;state&quot;, state);</span>
<span class="nc" id="L307">			dumpStatsToAuditTable(AuditTrailEntry.ACTION_TS_QUEUE_DUMP, &quot;Time Series Dump: Queues&quot;, statsMap);</span>
<span class="nc" id="L308">			methodFinish();</span>
<span class="nc" id="L309">		}</span>
<span class="nc" id="L310">	}</span>
	
	protected void dumpStatsToAuditTable(short actionID, String primaryObjectName, Map statsMap)
	{
<span class="nc" id="L314">		Date jobStart = (Date)statsMap.get(&quot;jobStart&quot;);</span>
<span class="nc" id="L315">		Date jobEnd = (Date)statsMap.get(&quot;jobEnd&quot;);</span>
<span class="nc" id="L316">		int numberOfSomething = (Integer)statsMap.get(&quot;numberOfSomething&quot;);</span>
<span class="nc" id="L317">		long duration = (Long)statsMap.get(&quot;duration&quot;);</span>
<span class="nc" id="L318">		Date dumpWindowStart = (Date)statsMap.get(&quot;dumpWindowStart&quot;);</span>
<span class="nc" id="L319">		Date dumpWindowEnd = (Date)statsMap.get(&quot;dumpWindowEnd&quot;);</span>
<span class="nc" id="L320">		int numberOfChunks = (Integer)statsMap.get(&quot;chunkCount&quot;);</span>
<span class="nc" id="L321">		String jobStatus = (String)statsMap.get(&quot;state&quot;);</span>
<span class="nc" id="L322">		AuditTrailEntry entry = new AuditTrailEntry(</span>
				AuditTrailEntry.MODULE_ADAPTER,
				actionID,
				new ID(0),
				primaryObjectName,
				jobStart, jobEnd);
<span class="nc" id="L328">		SimpleDateFormat sdf = new SimpleDateFormat(&quot;MM/dd/yyyy HH:mm:ss&quot;);</span>
<span class="nc" id="L329">		entry.addProperty(&quot;Job Status&quot;, jobStatus, &quot;string&quot;, false);</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">		if(actionID == AuditTrailEntry.ACTION_TS_QUEUE_DUMP) {</span>
<span class="nc" id="L331">			entry.addProperty(&quot;Number of Queues Dumped&quot;, &quot;&quot;+numberOfSomething, &quot;int&quot;, false);</span>
		}
<span class="nc bnc" id="L333" title="All 2 branches missed.">		if(actionID == AuditTrailEntry.ACTION_TS_CAMPAIGN_DUMP) {</span>
<span class="nc" id="L334">			entry.addProperty(&quot;Number of Campaigns&quot;, &quot;&quot;+numberOfSomething, &quot;int&quot;, false);</span>
		}
<span class="nc" id="L336">		entry.addProperty(&quot;Duration&quot;, &quot;&quot;+duration, &quot;minutes&quot;, false);</span>
<span class="nc" id="L337">		entry.addProperty(&quot;Timeframe&quot;, sdf.format(dumpWindowStart) + &quot; to &quot; + sdf.format(dumpWindowEnd), &quot;string&quot;, false);</span>
<span class="nc" id="L338">		entry.addProperty(&quot;Number of Chunks&quot;, &quot;&quot;+numberOfChunks, &quot;int&quot;, false);</span>
		try {
<span class="nc" id="L340">			BbmManagerFactory.getEventAuditTrailManager().createAuditEntry(entry);</span>
		}
<span class="nc" id="L342">		catch (Exception e) {</span>
<span class="nc" id="L343">			m_cat.warn(&quot;Exception occurred during Time Series Dump audit.&quot;);</span>
<span class="nc" id="L344">		}</span>
<span class="nc" id="L345">	}</span>
	private void dumpCombinedQueueTimeSeriesInChunk(Date start, Date end, boolean alwaysUpdateDumpLog, HashMap queMediaMap, HashMap mediaMap, ArrayList exceptions, int chunkCount)  throws BbmCreateException {
<span class="nc" id="L347">		m_cat.info(&quot;ENTER: dumpCombinedQueueTimeSeriesInChunk for &quot; + start + &quot; till &quot; + end);</span>
<span class="nc" id="L348">		long timeSinceStart = new java.util.Date().getTime();</span>
<span class="nc" id="L349">		int numberOfCampaigns = 0;</span>
<span class="nc" id="L350">		String state = &quot;&quot;;</span>
		try {
			// Dump Combined Queue
<span class="nc" id="L353">			boolean forceDump24Hours = isForceDump24Hours();</span>
<span class="nc" id="L354">			Collection cpgCol = m_CampaignManager.getCampaigns();</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">			for (Iterator it = cpgCol.iterator(); it.hasNext(); ) {</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">				if (m_dbConfigManager.isTemporarilyStopReportDump()) {</span>
					//stop report dump as is if this flag is set; tuser wants to suspend and start again.
<span class="nc" id="L358">					return;</span>
				}
<span class="nc" id="L360">				long timeAtLastRun = new java.util.Date().getTime();</span>
<span class="nc" id="L361">				Campaign cpg = (Campaign) it.next();</span>
				try {
<span class="nc" id="L363">					Collection queueAssignment = m_CampaignManager.getCampaignQueueAssignments(cpg.getID(), start, end);</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">					if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L365">						m_cat.debug(queueAssignment);</span>
					}
<span class="nc bnc" id="L367" title="All 2 branches missed.">					if (queueAssignment.isEmpty()) {</span>
<span class="nc" id="L368">						continue;</span>
					}
<span class="nc" id="L370">					HashMap spQMap = new HashMap();</span>
<span class="nc" id="L371">					HashMap spTimeRangeMap = new HashMap();</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">					for (Iterator qaIT = queueAssignment.iterator(); qaIT.hasNext(); ) {</span>
<span class="nc" id="L373">						CampaignQueue cq = (CampaignQueue) qaIT.next();</span>
<span class="nc" id="L374">						ID qID = cq.getQueueID();</span>
<span class="nc" id="L375">						ID spID = cq.getSPID();</span>
<span class="nc" id="L376">						ArrayList qCol = (ArrayList) spQMap.get(spID);</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">						if (qCol == null) {</span>
<span class="nc" id="L378">							qCol = new ArrayList();</span>
						}
<span class="nc" id="L380">						qCol.add(qID);</span>
<span class="nc" id="L381">						spQMap.put(spID, qCol);</span>
<span class="nc" id="L382">						Date[] timeRange = (Date[]) spTimeRangeMap.get(spID);</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">						if (timeRange == null) {</span>
<span class="nc" id="L384">							timeRange = new Date[2];</span>
<span class="nc" id="L385">							timeRange[0] = cq.getStartTime();</span>
<span class="nc" id="L386">							timeRange[1] = cq.getEndTime();</span>
<span class="nc" id="L387">							spTimeRangeMap.put(spID, timeRange);</span>
						}
<span class="nc" id="L389">					}</span>
<span class="nc" id="L390">					HashSet mediaSet = new HashSet();</span>
<span class="nc" id="L391">					HashSet allMediaSet = new HashSet();</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">					if (!spQMap.isEmpty()) {</span>
<span class="nc" id="L393">						Iterator spIT = spQMap.keySet().iterator();</span>
<span class="nc" id="L394">						ID spID = (ID) spIT.next();</span>
<span class="nc" id="L395">						ArrayList qCol = (ArrayList) spQMap.get(spID);</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">						for (Iterator qIT = qCol.iterator(); qIT.hasNext(); ) {</span>
<span class="nc" id="L397">							mediaSet.add(queMediaMap.get(qIT.next()));</span>
						}
<span class="nc" id="L399">						allMediaSet.addAll(mediaSet);</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">						while (spIT.hasNext()) {</span>
<span class="nc" id="L401">							spID = (ID) spIT.next();</span>
<span class="nc" id="L402">							qCol = (ArrayList) spQMap.get(spID);</span>
<span class="nc" id="L403">							HashSet nextMediaSet = new HashSet();</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">							for (Iterator qIT = qCol.iterator(); qIT.hasNext(); ) {</span>
<span class="nc" id="L405">								nextMediaSet.add(queMediaMap.get(qIT.next()));</span>
							}
	
<span class="nc" id="L408">							allMediaSet.addAll(nextMediaSet);</span>
<span class="nc" id="L409">						}</span>
					}
					// if no media change, dump for whole window, no need to do it per sp
<span class="nc bnc" id="L412" title="All 2 branches missed.">					if (allMediaSet.size() == 1) {</span>
<span class="nc" id="L413">						ID dumpMediaID = (ID) allMediaSet.iterator().next();</span>
<span class="nc" id="L414">						Media media = (Media) mediaMap.get(dumpMediaID);</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">						if (media == null) {</span>
<span class="nc" id="L416">							media = m_WorkloadManager.getMediaByID(dumpMediaID);</span>
<span class="nc" id="L417">							mediaMap.put(dumpMediaID, media);</span>
						}
<span class="nc" id="L419">						boolean fixHOO = false;</span>
<span class="nc bnc" id="L420" title="All 4 branches missed.">						if (media.getType() &amp;&amp; !forceDump24Hours) {</span>
<span class="nc" id="L421">							m_cat.debug(&quot;Campaign &quot; + cpg.getID() + &quot; has only Immediate queue, with media id &quot; + dumpMediaID);</span>
	
<span class="nc" id="L423">							fixHOO = true;</span>
						}
<span class="nc" id="L425">						boolean multiSite = isMultiVQCampaign(cpg.getID(), dumpMediaID, start, end);</span>
<span class="nc" id="L426">						m_cat.info(&quot;Start: Dumping campaign: &quot; + cpg.getID() + &quot;, has SubCampaigns or VQ&quot; + multiSite + &quot;, for media: &quot; + dumpMediaID);</span>
						// if only one media, no need for combined combined queue
<span class="nc bnc" id="L428" title="All 2 branches missed.">						if (multiSite) {</span>
<span class="nc" id="L429">							m_TimeSeriesReportDumpManager.dumpMultiSiteTimeSeriesFromLastDump(cpg.getID(), dumpMediaID, start, end, fixHOO);//QC77534 dumping Subqueue and VQ as well</span>
						} else {
<span class="nc" id="L431">							m_TimeSeriesReportDumpManager.dumpTimeSeriesFromLastDump(cpg.getID(), dumpMediaID, null, start, end, alwaysUpdateDumpLog, fixHOO);</span>
						}
<span class="nc" id="L433">					} else {</span>
<span class="nc" id="L434">						boolean fixHOO = false;</span>
						// if different media immediate type found in campaign, won't fixHOO
<span class="nc" id="L436">						boolean immediateQueue = false;</span>
<span class="nc" id="L437">						boolean nonImmQueue = false;</span>
						// if more than one media, dump each media, and combine combine, this may be optimized later by caching each media combine result
<span class="nc bnc" id="L439" title="All 2 branches missed.">						for (Iterator medIT = allMediaSet.iterator(); medIT.hasNext(); ) {</span>
<span class="nc" id="L440">							ID dumpMediaID = (ID) medIT.next();</span>
<span class="nc" id="L441">							Media media = (Media) mediaMap.get(dumpMediaID);</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">							if (media == null) {</span>
<span class="nc" id="L443">								media = m_WorkloadManager.getMediaByID(dumpMediaID);</span>
<span class="nc" id="L444">								mediaMap.put(dumpMediaID, media);</span>
							}
<span class="nc bnc" id="L446" title="All 4 branches missed.">							if (media.getType() &amp;&amp; !forceDump24Hours) {</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">								if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L448">									m_cat.debug(&quot;Campaign &quot; + cpg.getID() + &quot; has only Immediate queue, with media id &quot; + dumpMediaID);</span>
								}
<span class="nc" id="L450">								fixHOO = true;</span>
<span class="nc" id="L451">								immediateQueue = true;</span>
							} else {
<span class="nc" id="L453">								nonImmQueue = true;</span>
							}
<span class="nc" id="L455">							boolean multiSite = isMultiVQCampaign(cpg.getID(), dumpMediaID, start, end);</span>
<span class="nc" id="L456">							m_cat.info(&quot;Start: Dumping campaign: &quot; + cpg.getID() + &quot;, has SubCampaigns or VQ&quot; + multiSite + &quot;, for media: &quot; + dumpMediaID);</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">							if (multiSite) {</span>
<span class="nc" id="L458">								m_TimeSeriesReportDumpManager.dumpMultiSiteTimeSeriesFromLastDump(cpg.getID(), dumpMediaID, start, end, fixHOO);//QC77534 dumping Subqueue and VQ as well</span>
							} else {
<span class="nc" id="L460">								m_TimeSeriesReportDumpManager.dumpTimeSeriesFromLastDump(cpg.getID(), dumpMediaID, null, start, end, alwaysUpdateDumpLog, fixHOO);</span>
							}
<span class="nc" id="L462">						}</span>
<span class="nc bnc" id="L463" title="All 4 branches missed.">						if (immediateQueue &amp;&amp; nonImmQueue) {</span>
<span class="nc" id="L464">							fixHOO = false;</span>
						}
<span class="nc" id="L466">						boolean multiSite = isMultiVQCampaign(cpg.getID(), null, start, end);</span>
<span class="nc" id="L467">						m_cat.info(&quot;Start: Dumping campaign: &quot; + cpg.getID() + &quot;, has SubCampaigns or VQ&quot; + multiSite + &quot;, for Combine All.&quot;);</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">						if (multiSite) {</span>
<span class="nc" id="L469">							m_TimeSeriesReportDumpManager.dumpMultiSiteTimeSeriesFromLastDump(cpg.getID(), null, start, end, fixHOO);//QC77534 dumping Subqueue and VQ as well</span>
						} else {
<span class="nc" id="L471">							m_TimeSeriesReportDumpManager.dumpTimeSeriesFromLastDump(cpg.getID(), null, null, start, end, alwaysUpdateDumpLog, fixHOO);</span>
						}
					}
<span class="nc" id="L474">				} catch (Exception e) {</span>
<span class="nc" id="L475">					Pair pair = new Pair();</span>
<span class="nc" id="L476">					pair.setFirst(cpg.getID());</span>
<span class="nc" id="L477">					pair.setSecond(e);</span>
<span class="nc" id="L478">					exceptions.add(pair);</span>
<span class="nc" id="L479">					m_cat.info(&quot;Fail: Dumping campaign queue: &quot; + cpg.getID() + &quot;, with exception &quot; + e);</span>
<span class="nc" id="L480">					continue;</span>
<span class="nc" id="L481">				}</span>
<span class="nc" id="L482">				m_cat.info(&quot;Complete: Dumping campaign queue: &quot; + cpg.getID() + &quot; , time=&quot; + (new java.util.Date().getTime() - timeAtLastRun));</span>
<span class="nc" id="L483">				numberOfCampaigns++;</span>
<span class="nc" id="L484">			}</span>
<span class="nc" id="L485">			state = &quot;Succeeded&quot;;</span>
<span class="nc" id="L486">		} catch (Exception e) {</span>
<span class="nc" id="L487">			state = &quot;Failed&quot;;</span>
<span class="nc" id="L488">			handleException(e);</span>
<span class="nc" id="L489">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L491">			Date endTime = new java.util.Date();</span>
<span class="nc" id="L492">			m_cat.info(&quot;Complete: Dumping all queues: , time reqd=&quot; + (endTime.getTime() - timeSinceStart) / 60000 + &quot; Mins&quot;);</span>
<span class="nc" id="L493">			Map&lt;String, Object&gt; statsMap = new HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L494">			statsMap.put(&quot;jobStart&quot;, new Date(timeSinceStart));</span>
<span class="nc" id="L495">			statsMap.put(&quot;jobEnd&quot;, endTime);</span>
<span class="nc" id="L496">			statsMap.put(&quot;numberOfSomething&quot;, numberOfCampaigns);</span>
<span class="nc" id="L497">			statsMap.put(&quot;duration&quot;, (endTime.getTime() - timeSinceStart) / 60000);</span>
<span class="nc" id="L498">			statsMap.put(&quot;dumpWindowStart&quot;, start);</span>
<span class="nc" id="L499">			statsMap.put(&quot;dumpWindowEnd&quot;, end);</span>
<span class="nc" id="L500">			statsMap.put(&quot;chunkCount&quot;, chunkCount);</span>
<span class="nc" id="L501">			statsMap.put(&quot;state&quot;, state);</span>
<span class="nc" id="L502">			dumpStatsToAuditTable(AuditTrailEntry.ACTION_TS_CAMPAIGN_DUMP, &quot;Time Series Dump: Campaigns&quot;, statsMap);</span>
			//Jdmo.enablePrintlog(false,false);
<span class="nc" id="L504">			m_cat.info(&quot;Exit: dumpCombinedQueueTimeSeriesInChunk for &quot; + start + &quot; till &quot; + end + &quot; , time reqd=&quot; + (new java.util.Date().getTime() - timeSinceStart) / 60000 + &quot; Mins&quot;);</span>
<span class="nc" id="L505">			methodFinish();</span>
<span class="nc" id="L506">		}</span>
<span class="nc" id="L507">	}</span>

	/**
	 * Dump a Queue's TimeSeries into different schema for report
	 * It will dump all statistics, each 15 minutes per row
	 * for a given queue ID collection, for a given period(can be ambiguous)
	 * Mostly used by Ad-Hoc report dump
	 *
	 * @param ID          campaignID
	 * @param ID          mediaID
	 * @param Collection, ID collection
	 * @param Date,       start
	 * @param Date,       end
	 */
	public void dumpTimeSeries(ID campaignID, ID mediaID, Collection queueIDCol, Date start, Date end) throws BbmCreateException {
<span class="nc" id="L522">		methodStart(&quot;dumpTimeSeries&quot;, campaignID, mediaID, queueIDCol, start, end);</span>
		try {
<span class="nc" id="L524">			boolean forceDump24Hours = isForceDump24Hours();</span>
<span class="nc bnc" id="L525" title="All 4 branches missed.">			if (queueIDCol != null &amp;&amp; !queueIDCol.isEmpty()) {</span>
<span class="nc" id="L526">				HashMap mediaMap = new HashMap();</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">				for (Iterator it = queueIDCol.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L528">					ID id = (ID) it.next();</span>
<span class="nc" id="L529">					Queue queue = m_WorkloadManager.getQueueByID(id);</span>
<span class="nc" id="L530">					Media media = (Media) mediaMap.get(queue.getMediaID());</span>
<span class="nc" id="L531">					boolean fixHOO = false;</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">					if (media == null) {</span>
<span class="nc" id="L533">						media = m_WorkloadManager.getMediaByID(queue.getMediaID());</span>
<span class="nc" id="L534">						mediaMap.put(queue.getMediaID(), media);</span>
					}
<span class="nc bnc" id="L536" title="All 4 branches missed.">					if (media.getType() &amp;&amp; !forceDump24Hours) {</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">						if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L538">							m_cat.debug(&quot;Queue &quot; + id + &quot; is Immediate queue, with media id &quot; + queue.getMediaID());</span>
						}
<span class="nc" id="L540">						fixHOO = true;</span>
					}
<span class="nc" id="L542">					m_TimeSeriesReportDumpManager.dumpTimeSeriesFromLastDump(null, null, id, new Date(start.getTime() - TimeZoneUtil.HOUR_IN_MILLISECONDS_LONG), end, false, fixHOO);</span>
<span class="nc" id="L543">				}</span>
<span class="nc" id="L544">			} else {</span>
<span class="nc" id="L545">				boolean fixHOO = false;</span>
<span class="nc" id="L546">				boolean multiSite = isMultiVQCampaign(campaignID, mediaID, start, end);</span>
<span class="nc bnc" id="L547" title="All 4 branches missed.">				if (mediaID != null &amp;&amp; !mediaID.equals(new ID(-10))) {</span>
<span class="nc" id="L548">					Media media = m_WorkloadManager.getMediaByID(mediaID);</span>
<span class="nc bnc" id="L549" title="All 4 branches missed.">					if (media.getType() &amp;&amp; !forceDump24Hours) {</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">						if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L551">							m_cat.debug(&quot;CampaignID &quot; + campaignID + &quot; has immediate media id &quot; + mediaID);</span>
						}
<span class="nc" id="L553">						fixHOO = true;</span>
					}
<span class="nc" id="L555">				} else {</span>
					// it is for combined combined queue, which implies different medias queues under one campaign
					// need check each media's type
<span class="nc" id="L558">					Collection queueAssignment = m_CampaignManager.getCampaignQueueAssignments(campaignID, start, end);</span>
<span class="nc" id="L559">					HashSet queueSet = new HashSet();</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">					for (Iterator qaIT = queueAssignment.iterator(); qaIT.hasNext(); ) {</span>
<span class="nc" id="L561">						CampaignQueue cq = (CampaignQueue) qaIT.next();</span>
<span class="nc" id="L562">						ID qID = cq.getQueueID();</span>
<span class="nc" id="L563">						queueSet.add(qID);</span>
<span class="nc" id="L564">					}</span>
<span class="nc" id="L565">					HashMap mediaMap = new HashMap();</span>
<span class="nc" id="L566">					boolean immediateQueue = false;</span>
<span class="nc" id="L567">					boolean nonImmQueue = false;</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">					for (Iterator qIT = queueSet.iterator(); qIT.hasNext(); ) {</span>
<span class="nc" id="L569">						Queue queue = m_WorkloadManager.getQueueByID((ID) qIT.next());</span>
<span class="nc" id="L570">						Media media = (Media) mediaMap.get(queue.getMediaID());</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">						if (media == null) {</span>
<span class="nc" id="L572">							media = m_WorkloadManager.getMediaByID(queue.getMediaID());</span>
<span class="nc" id="L573">							mediaMap.put(queue.getMediaID(), media);</span>
						}
<span class="nc bnc" id="L575" title="All 4 branches missed.">						if (media.getType() &amp;&amp; !forceDump24Hours) {</span>
<span class="nc" id="L576">							immediateQueue = true;</span>
<span class="nc" id="L577">							fixHOO = true;</span>
						} else {
<span class="nc" id="L579">							nonImmQueue = true;</span>
						}
<span class="nc" id="L581">					}</span>
<span class="nc bnc" id="L582" title="All 4 branches missed.">					if (immediateQueue &amp;&amp; nonImmQueue) {</span>
<span class="nc" id="L583">						fixHOO = false;</span>
					}
				}
<span class="nc bnc" id="L586" title="All 2 branches missed.">				if (m_cat.isDebugEnabled()) {</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">					m_cat.debug(&quot;Dump CampaignID &quot; + campaignID + &quot; with Media ID: &quot; + mediaID == null ? &quot;null&quot; : mediaID + &quot;, with has SubCampaigns or VQ: &quot; + multiSite + &quot;, has immediate media id &quot; + mediaID);</span>
				}
<span class="nc bnc" id="L589" title="All 2 branches missed.">				if (multiSite) {</span>
<span class="nc" id="L590">					m_TimeSeriesReportDumpManager.dumpMultiSiteTimeSeriesFromLastDump(campaignID, mediaID, new Date(start.getTime() - TimeZoneUtil.HOUR_IN_MILLISECONDS_LONG), end, fixHOO);</span>
				} else {
<span class="nc" id="L592">					m_TimeSeriesReportDumpManager.dumpTimeSeriesFromLastDump(campaignID, mediaID, null, new Date(start.getTime() - TimeZoneUtil.HOUR_IN_MILLISECONDS_LONG), end, false, fixHOO);</span>
				}
			}
<span class="nc" id="L595">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L596">			handleException(e);</span>
<span class="nc" id="L597">			throw new BbmCreateException(e);</span>
<span class="nc" id="L598">		} catch (Exception e) {</span>
<span class="nc" id="L599">			handleException(e);</span>
<span class="nc" id="L600">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L602">			methodFinish();</span>
<span class="nc" id="L603">		}</span>
<span class="nc" id="L604">	}</span>

	/**
	 * Dump a Queue's TimeSeries into different schema for report
	 * It will dump given window, minus one month, and minus one year
	 * for a given queue ID collection, for a given period(can be ambiguous)
	 * Mostly used by Ad-Hoc report dump
	 *
	 * @param ID          campaignID
	 * @param ID          mediaID
	 * @param Collection, ID collection
	 * @param Date,       start
	 * @param Date,       end
	 */
	public void dumpMonthlyTimeSeries(ID campaignID, ID mediaID, Collection queueIDCol, Date start, Date end) throws BbmCreateException {
<span class="nc" id="L619">		methodStart(&quot;dumpMonthlyTimeSeries&quot;, campaignID, mediaID, queueIDCol, start, end);</span>
		try {
<span class="nc" id="L621">			boolean forceDump24Hours = isForceDump24Hours();</span>
<span class="nc" id="L622">			Date[] starts = new Date[]{start, null};</span>
<span class="nc" id="L623">			Date[] ends = new Date[]{end, null};</span>
			// the first dump window is the selected monthly plus previous monthly merged together
<span class="nc" id="L625">			starts[0] = new Date(start.getTime() - 32l * TimeZoneUtil.DAY_IN_MILLISECONDS);</span>
<span class="nc" id="L626">			starts[1] = new Date(start.getTime() - 367l * TimeZoneUtil.DAY_IN_MILLISECONDS);</span>
<span class="nc" id="L627">			ends[1] = new Date(end.getTime() - 363l * TimeZoneUtil.DAY_IN_MILLISECONDS);</span>
<span class="nc" id="L628">			HashMap mediaMap = new HashMap();</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">			for (int i = 0; i &lt; starts.length; i++) {</span>
<span class="nc bnc" id="L630" title="All 4 branches missed.">				if (queueIDCol != null &amp;&amp; !queueIDCol.isEmpty()) {</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">					for (Iterator it = queueIDCol.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L632">						ID id = (ID) it.next();</span>
<span class="nc" id="L633">						Queue queue = m_WorkloadManager.getQueueByID(id);</span>
<span class="nc" id="L634">						Media media = (Media) mediaMap.get(queue.getMediaID());</span>
<span class="nc" id="L635">						boolean fixHOO = false;</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">						if (media == null) {</span>
<span class="nc" id="L637">							media = m_WorkloadManager.getMediaByID(queue.getMediaID());</span>
<span class="nc" id="L638">							mediaMap.put(queue.getMediaID(), media);</span>
						}
<span class="nc bnc" id="L640" title="All 4 branches missed.">						if (media.getType() &amp;&amp; !forceDump24Hours) {</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">							if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L642">								m_cat.debug(&quot;Queue &quot; + id + &quot; is Immediate queue, with media id &quot; + queue.getMediaID());</span>
							}
<span class="nc" id="L644">							fixHOO = true;</span>
						}
<span class="nc" id="L646">						m_TimeSeriesReportDumpManager.dumpTimeSeriesFromLastDump(null, null, id, starts[i], ends[i], false, fixHOO);</span>
<span class="nc" id="L647">					}</span>
				} else {
<span class="nc" id="L649">					boolean fixHOO = false;</span>
<span class="nc" id="L650">					boolean multiSite = isMultiVQCampaign(campaignID, mediaID, starts[i], ends[i]);</span>
<span class="nc bnc" id="L651" title="All 4 branches missed.">					if (mediaID != null &amp;&amp; !mediaID.equals(new ID(-10))) {</span>
<span class="nc" id="L652">						Media media = m_WorkloadManager.getMediaByID(mediaID);</span>
<span class="nc bnc" id="L653" title="All 4 branches missed.">						if (media.getType() &amp;&amp; !forceDump24Hours) {</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">							if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L655">								m_cat.debug(&quot;CampaignID &quot; + campaignID + &quot; has immediate media id &quot; + mediaID);</span>
							}
<span class="nc" id="L657">							fixHOO = true;</span>
						}
<span class="nc" id="L659">					} else {</span>
						// it is for combined combined queue, which implies different medias queues under one campaign
						// need check each media's type
<span class="nc" id="L662">						Collection queueAssignment = m_CampaignManager.getCampaignQueueAssignments(campaignID, starts[i], ends[i]);</span>
<span class="nc" id="L663">						HashSet queueSet = new HashSet();</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">						for (Iterator qaIT = queueAssignment.iterator(); qaIT.hasNext(); ) {</span>
<span class="nc" id="L665">							CampaignQueue cq = (CampaignQueue) qaIT.next();</span>
<span class="nc" id="L666">							ID qID = cq.getQueueID();</span>
<span class="nc" id="L667">							queueSet.add(qID);</span>
<span class="nc" id="L668">						}</span>
<span class="nc" id="L669">						boolean immediateQueue = false;</span>
<span class="nc" id="L670">						boolean nonImmQueue = false;</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">						for (Iterator qIT = queueSet.iterator(); qIT.hasNext(); ) {</span>
<span class="nc" id="L672">							Queue queue = m_WorkloadManager.getQueueByID((ID) qIT.next());</span>
<span class="nc" id="L673">							Media media = (Media) mediaMap.get(queue.getMediaID());</span>
<span class="nc bnc" id="L674" title="All 2 branches missed.">							if (media == null) {</span>
<span class="nc" id="L675">								media = m_WorkloadManager.getMediaByID(queue.getMediaID());</span>
<span class="nc" id="L676">								mediaMap.put(queue.getMediaID(), media);</span>
							}
<span class="nc bnc" id="L678" title="All 4 branches missed.">							if (media.getType() &amp;&amp; !forceDump24Hours) {</span>
<span class="nc" id="L679">								immediateQueue = true;</span>
<span class="nc" id="L680">								fixHOO = true;</span>
							} else {
<span class="nc" id="L682">								nonImmQueue = true;</span>
							}
<span class="nc" id="L684">						}</span>
<span class="nc bnc" id="L685" title="All 4 branches missed.">						if (immediateQueue &amp;&amp; nonImmQueue) {</span>
<span class="nc" id="L686">							fixHOO = false;</span>
						}
					}
<span class="nc bnc" id="L689" title="All 2 branches missed.">					if (m_cat.isDebugEnabled()) {</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">						m_cat.debug(&quot;Dump CampaignID &quot; + campaignID + &quot; with Media ID: &quot; + mediaID == null ? &quot;null&quot; : mediaID + &quot;, with has SubCampaigns or VQ: &quot; + multiSite + &quot;, has immediate media id &quot; + mediaID);</span>
					}
<span class="nc bnc" id="L692" title="All 2 branches missed.">					if (multiSite) {</span>
<span class="nc" id="L693">						m_TimeSeriesReportDumpManager.dumpMultiSiteTimeSeriesFromLastDump(campaignID, mediaID, starts[i], ends[i], fixHOO);</span>
					} else {
<span class="nc" id="L695">						m_TimeSeriesReportDumpManager.dumpTimeSeriesFromLastDump(campaignID, mediaID, null, starts[i], ends[i], false, fixHOO);</span>
					}
				}
			}
<span class="nc" id="L699">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L700">			handleException(e);</span>
<span class="nc" id="L701">			throw new BbmCreateException(e);</span>
<span class="nc" id="L702">		} catch (Exception e) {</span>
<span class="nc" id="L703">			handleException(e);</span>
<span class="nc" id="L704">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L706">			methodFinish();</span>
<span class="nc" id="L707">		}</span>
<span class="nc" id="L708">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>