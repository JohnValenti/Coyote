<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AutoProcessingRuleDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.setup.autoprocessing.ejb</a> &gt; <span class="el_source">AutoProcessingRuleDAO.java</span></div><h1>AutoProcessingRuleDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.setup.autoprocessing.ejb;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoQuery;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.cache.CacheUtilBBM;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.setup.autoprocessing.model.AutoProcessingRule;
import com.bluepumpkin.ejb.rm.setup.autoprocessing.model.AutoProcessingRuleFieldInfo;
import com.bluepumpkin.ejb.rm.util.ThreadLocalCache;

/**
 * Title:        AutoProcessingRuleDAO
 * Description:  DAO class for AutoProcessingRule
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc.
 * @author       Howard Mullings
 * @version 1.0
 *
 * This class is DAO class for the AutoProcessingRule.
 */

public class AutoProcessingRuleDAO extends DAOBase {


    //Field info object array.
<span class="fc" id="L45">    private static FieldInfo m_fieldInfo = new AutoProcessingRuleFieldInfo();</span>

    @Override
	protected FieldInfo getFieldInfo() {
<span class="fc" id="L49">        return m_fieldInfo;</span>
    }


<span class="fc" id="L53">    private static Category m_cat = Log.initCategory( AppliedAutoProcessingRuleDAO.class.getName());</span>

    protected Category getCategory() {
<span class="nc" id="L56">        return m_cat;</span>
    }

    /* Default constructor for the class.
     **/
    public AutoProcessingRuleDAO() {
<span class="fc" id="L62">        super();</span>
<span class="fc" id="L63">    }</span>

    /* Constructor for the class with the Jdmo instance passed as argument.
     * @param Jdmo - Jdmo class instance.
     **/
    public AutoProcessingRuleDAO(Jdmo dmo) {
<span class="nc" id="L69">        super(dmo);</span>
<span class="nc" id="L70">    }</span>

    /* Create AutoProcessingRule object and return it as ValueObjectBase object .
     * @return ValueObjectBase - ValueObjectBase Object.
     **/
    @Override
	protected ValueObjectBase createValueObject() {
<span class="fc" id="L77">        return(new AutoProcessingRule());</span>
    }
    
    /**
     * Find the AutoProcessingRules for the OrganizationId and request type
     * passed as argument and returns a collection of AutoProcessingRule
     * Objects if found.
     * @param pOrganizationId - Organisation ID object.
     * @param pRequestType - RequestType.
     * @param pActivityId - optional activity id, can be null.
     * @param onlyIfApplied true=&gt; only return if rule if enabled (applied) to org.
     * @return Collection A collection of AutoProcessingRule Object
     */
	public Collection findAutoProcessingRuleByOrgId(ID pOrganizationId, String pRequestType, boolean onlyIfApplied, ID pActivityId)
			throws Exception {
    	
<span class="fc bfc" id="L93" title="All 2 branches covered.">		if (!ThreadLocalCache.isEnabled()) {</span>
<span class="fc" id="L94">    		return findAutoProcessingRuleByOrgIdDB(pOrganizationId, pRequestType, onlyIfApplied, pActivityId);</span>
    	}
    	
<span class="fc" id="L97">    	String key = String.format(&quot;[%s][%s][%s][%s]&quot;, pOrganizationId,pRequestType,onlyIfApplied,pActivityId);</span>
    	
<span class="fc" id="L99">    	Map&lt;String, Collection&lt;AutoProcessingRule&gt;&gt; cache = ThreadLocalCache.getMap(&quot;AutoProcessingRuleDAO.findAutoProcessingRuleByOrgId&quot;);</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">		if (cache.containsKey(key)) {</span>
<span class="fc" id="L101">			return cache.get(key);</span>
		}

<span class="fc" id="L104">		Collection&lt;AutoProcessingRule&gt; result = findAutoProcessingRuleByOrgIdDB(pOrganizationId,pRequestType,onlyIfApplied,pActivityId);</span>
<span class="fc" id="L105">		cache.put(key, result);</span>
<span class="fc" id="L106">		return result;</span>
	}
    	
		



	private Collection&lt;AutoProcessingRule&gt; findAutoProcessingRuleByOrgIdDB(ID pOrganizationId,
                                      String pRequestType,
                                      boolean onlyIfApplied,
                                      ID pActivityId)
    throws Exception   
    {
        //Get all Autoprocessing Rules defined for the given Organizationid and its parents.  If param
        // onlyIfApplied is true, then returns only the 'applied' rules.  Otherwise returns both 'applied'
        // and 'not-applied' rules.
<span class="fc" id="L122">        List&lt;AutoProcessingRule&gt; autoProcessingRules = new ArrayList&lt;AutoProcessingRule&gt;(10);</span>

        // First, get the list of parent organizations. returned list is ordered by the closest
        // to the farthest parent org for the given orgID.
<span class="fc" id="L126">        List selfAndParentOrgIDs = CacheUtilBBM.getParentOrgIDs(pOrganizationId, getDMO());</span>
<span class="fc" id="L127">        selfAndParentOrgIDs.add(0, pOrganizationId); //include itself</span>

        //these are the ids of rules we found
<span class="fc" id="L130">        Collection foundRuleIDs = new ArrayList(10);</span>
<span class="fc" id="L131">        StringBuffer strQuery = null;</span>
<span class="fc" id="L132">        JdmoQuery jQuery1 = null;</span>

        // for each orgID, starting with self and then the closest parent, determine the list of
        // autoprocessing rules that 'apply' or 'do-not-apply' to the orgID.
<span class="fc bfc" id="L136" title="All 2 branches covered.">        for (Iterator orgIt=selfAndParentOrgIDs.iterator(); orgIt.hasNext();)    </span>
        {
<span class="fc" id="L138">            ID curOrgId = (ID)orgIt.next();</span>

<span class="fc bfc" id="L140" title="All 2 branches covered.">            if (strQuery == null) </span>
            {
<span class="fc" id="L142">                strQuery = getSelectStatement();</span>
<span class="fc" id="L143">                strQuery.append(&quot;, B.ISAPPLIED &quot;);</span>
<span class="fc" id="L144">                strQuery.append(&quot; FROM AUTOPROCESSINGRULE A, APPLIEDAUTOPROCESSINGRULE B &quot;);</span>
<span class="fc" id="L145">                strQuery.append(&quot; WHERE B.ORGANIZATIONID = ? &quot;);</span>
<span class="fc" id="L146">                strQuery.append(&quot; AND A.ID = B.AutoProcessingRuleID &quot;);</span>

<span class="pc bpc" id="L148" title="1 of 2 branches missed.">                boolean lUseRequstType = pRequestType != null &amp;&amp;</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">                    !pRequestType.equalsIgnoreCase(Request.REQUESTTYPE_ALL);</span>

<span class="fc bfc" id="L151" title="All 2 branches covered.">                if (lUseRequstType) </span>
                {
<span class="fc" id="L153">                    strQuery.append(&quot; AND REQUESTTYPE = '&quot;);</span>
<span class="fc" id="L154">                    strQuery.append(pRequestType);</span>
<span class="fc" id="L155">                    strQuery.append(&quot;'&quot;);</span>
                }
<span class="fc bfc" id="L157" title="All 2 branches covered.">                if (pActivityId != null) </span>
                {
<span class="fc" id="L159">                    strQuery.append(&quot; AND A.ACTIVITYID = &quot;);</span>
<span class="fc" id="L160">                    strQuery.append(pActivityId);</span>
                }

                // ignore rules that were already processed earlier at a child org level.
<span class="fc bfc" id="L164" title="All 2 branches covered.">                if (foundRuleIDs.size() != 0) </span>
                {
<span class="fc" id="L166">                    strQuery.append(&quot; AND A.ID NOT IN &quot;);</span>
<span class="fc" id="L167">                    strQuery.append(m_dmo.createInClause(foundRuleIDs));</span>
                }

<span class="fc" id="L170">                strQuery.append(&quot; ORDER BY REQUESTTYPE &quot;);</span>

<span class="fc" id="L172">                jQuery1 = m_dmo.createQuery(strQuery.toString(), Jdmo.PARAM_QUERY);</span>
            }

<span class="fc" id="L175">            jQuery1.setParID(1, curOrgId);</span>
<span class="fc" id="L176">            JdmoRowset rs = m_dmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>

<span class="fc bfc" id="L178" title="All 2 branches covered.">            while (rs.next()) </span>
            {
<span class="fc" id="L180">                AutoProcessingRule autoProcessingRule = (AutoProcessingRule) readObjectFromDB(rs);</span>

<span class="fc" id="L182">                autoProcessingRule.setApplied(rs.getBoolean(&quot;ISAPPLIED&quot;));</span>
                
                //If rule's org scope is thisOrgOnly, then child orgs must have isApplied=false  
<span class="pc bpc" id="L185" title="3 of 4 branches missed.">                if (autoProcessingRule.getOrgScope().equals(AutoProcessingRule.SCOPE_THIS_ORG_ONLY) &amp;&amp; (!curOrgId.equals(pOrganizationId)))</span>
<span class="nc" id="L186">                    autoProcessingRule.setApplied(false);</span>

<span class="pc bpc" id="L188" title="1 of 2 branches missed.">                if (autoProcessingRule.getOrgScope().equals(AutoProcessingRule.SCOPE_SUB_ORGS_ALLOW_OVERRIDE))</span>
<span class="fc" id="L189">                    autoProcessingRule.setCanChangeApply(true);</span>
                else
<span class="nc" id="L191">                    autoProcessingRule.setCanChangeApply(false);</span>

<span class="pc bpc" id="L193" title="1 of 4 branches missed.">                if (onlyIfApplied &amp;&amp; autoProcessingRule.getApplied())</span>
<span class="fc" id="L194">                    autoProcessingRules.add(autoProcessingRule);</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">                else if (!onlyIfApplied)</span>
<span class="fc" id="L196">                    autoProcessingRules.add(autoProcessingRule);</span>

<span class="fc" id="L198">                foundRuleIDs.add(autoProcessingRule.getID());</span>
                // we will need to rebuild the query if we continue up the tree.
<span class="fc" id="L200">                strQuery = null;</span>
<span class="fc" id="L201">            }</span>
<span class="fc" id="L202">            rs.close();</span>
            
<span class="fc" id="L204">        }//end parent orgs loop</span>

        // fetch associated AutoProcessingValidations and assocaite them with the apRule.
<span class="fc bfc" id="L207" title="All 2 branches covered.">        if (autoProcessingRules.size() != 0) </span>
        {
<span class="fc" id="L209">            AutoProcessingValidationDAO apValDAO = new AutoProcessingValidationDAO(m_dmo);</span>
<span class="fc" id="L210">            List fetchedAPRuleIDs = RequestUtil.getListOfIDsFromVOBases(autoProcessingRules);</span>
<span class="fc" id="L211">            Map ruleIDToAPValMap = apValDAO.findByAutoProcessingIds(fetchedAPRuleIDs);</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">            for (int i = 0; i &lt; autoProcessingRules.size(); i++) </span>
            {
<span class="fc" id="L214">                AutoProcessingRule apRule = autoProcessingRules.get(i);</span>
<span class="fc" id="L215">                Collection APValidations = (Collection) ruleIDToAPValMap.get(apRule.getID());</span>
<span class="fc" id="L216">                apRule.setAutoProcessingValidations(APValidations);</span>
            }
        }
        
<span class="fc" id="L220">        return autoProcessingRules;</span>
    }

    /**
     * Find the AutoProcessingRules for the AutoProcessingRuleId passed as argument
     * and returns a AutoProcessingRule Object if found.
     * @param ruleId -  ID for AutoProcessingRule object.
     * @return AutoProcessingRule - A AutoProcessingRule Object
     * @throws BbmFinderException if there is an error.
     * Note: Although the AutoProcessingRule's getApplied and canChangeApplied properties will be set, they 
     *       are only referring to the APPLIEDAUTOPROCESSINGRULE for the org where the AutoProcessingRule was defined.
     */
    public AutoProcessingRule findAutoProcessingRuleById( ID ruleId )
    throws Exception 
    {
<span class="fc" id="L235">        AutoProcessingRule lAutoProcessingRule = null;</span>

<span class="fc" id="L237">        StringBuffer strQuery = getSelectStatement();</span>
        
<span class="fc" id="L239">        strQuery.append(&quot;, B.ISAPPLIED &quot;);</span>
<span class="fc" id="L240">        strQuery.append(&quot; FROM AUTOPROCESSINGRULE A, APPLIEDAUTOPROCESSINGRULE B  &quot;);</span>
<span class="fc" id="L241">        strQuery.append(&quot; WHERE B.AUTOPROCESSINGRULEID = ?&quot;);</span>
<span class="fc" id="L242">        strQuery.append(&quot; AND A.ID = B.AUTOPROCESSINGRULEID &quot;);</span>
<span class="fc" id="L243">        strQuery.append(&quot; AND A.ORGANIZATIONID = B.ORGANIZATIONID &quot;); //only look at the APPLIEDAUTOPROCESSINGRULE for the org where the rule was defined</span>

<span class="fc" id="L245">        JdmoQuery jQuery1 = m_dmo.createQuery(strQuery.toString(), Jdmo.PARAM_QUERY);</span>
<span class="fc" id="L246">        jQuery1.setParString(1, ruleId.toString());</span>
<span class="fc" id="L247">        JdmoRowset rs = m_dmo.createRowset(jQuery1, Jdmo.FORWARD_ONLY, Jdmo.READ_ONLY);</span>

<span class="pc bpc" id="L249" title="1 of 2 branches missed.">        if(rs.next()) {</span>
<span class="fc" id="L250">            lAutoProcessingRule = (AutoProcessingRule) readObjectFromDB(rs);</span>
<span class="fc" id="L251">            lAutoProcessingRule.setApplied(rs.getBoolean(&quot;ISAPPLIED&quot;));</span>
            
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">            if (lAutoProcessingRule.getOrgScope().equals(AutoProcessingRule.SCOPE_SUB_ORGS_ALLOW_OVERRIDE))</span>
<span class="fc" id="L254">                lAutoProcessingRule.setCanChangeApply(true);</span>
            else
<span class="nc" id="L256">                lAutoProcessingRule.setCanChangeApply(false);</span>
        }
<span class="fc" id="L258">        rs.close();</span>

        // Fetch AutoProcessingValidations and store them in the value objects
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">        if (lAutoProcessingRule != null) </span>
        {
<span class="fc" id="L263">            AutoProcessingValidationDAO valDAO = new AutoProcessingValidationDAO(m_dmo);</span>
<span class="fc" id="L264">            Collection results = valDAO.findByAutoProcessingId(ruleId);</span>
<span class="fc" id="L265">            lAutoProcessingRule.setAutoProcessingValidations(results);</span>
        }
        
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">        if (lAutoProcessingRule == null) {</span>
<span class="nc" id="L269">            throw new BbmObjectNotFoundException(ruleId.toString());</span>
        }

<span class="fc" id="L272">        return lAutoProcessingRule;</span>
    }
 

    /**
     * Creates a new AutoProcessingRule.
     * @param rule - the rule to create
     * @throws BbmCreateException for low level database errors
     */
    public ID createObject(AutoProcessingRule rule)
    throws Exception 
    {
<span class="fc" id="L284">        ID ruleId = super.createObject(rule);</span>
<span class="fc" id="L285">        rule.setID(ruleId);</span>

<span class="fc" id="L287">        AppliedAutoProcessingRuleDAO appliedDAO =</span>
        new AppliedAutoProcessingRuleDAO(m_dmo);
<span class="fc" id="L289">        appliedDAO.createObjects(rule);</span>

<span class="fc" id="L291">        AutoProcessingValidationDAO valDAO =</span>
        new AutoProcessingValidationDAO(m_dmo);
<span class="fc" id="L293">        valDAO.createObjects(rule);</span>

<span class="fc" id="L295">        return ruleId;</span>
    }

    /**
     * Update the  AutoProcessingRule database with the AutoProcessingRule object
     * values passed as argument.
     * @param rule - AutoProcessingRule object.
     * @throws BbmUpdateException if there is an error.
     */
    public void updateObject(AutoProcessingRule rule)
    throws Exception 
    {
        //The applied is updated first because applied query needs to see if orgScope is being changed from original
<span class="nc" id="L308">        AppliedAutoProcessingRuleDAO appliedDAO = new AppliedAutoProcessingRuleDAO(m_dmo);</span>
<span class="nc" id="L309">        appliedDAO.updateObjects(rule);</span>

<span class="nc" id="L311">        super.updateObject(rule);</span>

<span class="nc" id="L313">        AutoProcessingValidationDAO valDAO = new AutoProcessingValidationDAO(m_dmo);</span>
<span class="nc" id="L314">        valDAO.updateObjects(rule);</span>
<span class="nc" id="L315">    }</span>

    @Override
	public void deleteObject(ID ruleId)
    throws BbmRemoveException 
    {
        try 
        {
<span class="fc" id="L323">            AutoProcessingValidationDAO valDAO =</span>
            new AutoProcessingValidationDAO(m_dmo);
<span class="fc" id="L325">            valDAO.deleteByAutoProcessingRuleID(ruleId);</span>

<span class="fc" id="L327">            AppliedAutoProcessingRuleDAO appliedDAO =</span>
            new AppliedAutoProcessingRuleDAO(m_dmo);
<span class="fc" id="L329">            appliedDAO.deleteByAutoProcessingRuleID(ruleId);</span>

            //delete the AutoProcessing rule now.
<span class="fc" id="L332">            super.deleteObject(ruleId);</span>
        } 
<span class="nc" id="L334">        catch (Exception e ) </span>
        {
<span class="nc" id="L336">            throw RequestUtil.createBbmRemoveExceptionWrapper(e, m_cat);</span>
<span class="fc" id="L337">        }</span>
<span class="fc" id="L338">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>