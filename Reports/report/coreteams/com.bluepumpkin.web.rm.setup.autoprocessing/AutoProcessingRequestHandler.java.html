<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AutoProcessingRequestHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.setup.autoprocessing</a> &gt; <span class="el_source">AutoProcessingRequestHandler.java</span></div><h1>AutoProcessingRequestHandler.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.setup.autoprocessing;

import java.rmi.RemoteException;
import java.util.Arrays;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Set;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.setup.autoprocessing.model.AutoProcessingRule;
import com.bluepumpkin.web.bbm.organization.OrganizationRequestHandler;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.l10n.RmWebLogBundleKey;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.reflection.ParameterUtil;

/**
 * Title          AutoProcessingRequestHandler
 * Description    Handle request for the Autoprocessing page
 * Copyright      Copyright (c) 2002
 * Company        Blue Pumpkin Software, Inc
 * @author        Howard Mullings
 * @version       1.0
 */
<span class="nc" id="L38">public class AutoProcessingRequestHandler extends OrganizationRequestHandler {</span>
	static final String CREATE_RULE_TYPE = &quot;createRuleType&quot;;

<span class="fc" id="L41">	private static final Category log = 	Log.initCategory(AutoProcessingRequestHandler.class.getName());</span>

	private static final String LIST_PAGE = &quot;listPage&quot;;
	private static final String FORM_PAGE = &quot;editPage&quot;;

	private static final String APPLY_RULE = &quot;APPLY_RULE&quot;;
	private static final String NEW_TIMEOFF = &quot;NEW_TIME_OFF&quot;;
	private static final String NEW_TIMEOFF_WITHDRAW = &quot;NEW_TIMEOFF_WITHDRAW&quot;;
	private static final String NEW_SHIFTSWAP = &quot;NEW_SHIFT_SWAP&quot;;
	private static final String NEW_SHIFTBID = &quot;NEW_SHIFT_BID&quot;;
	private static final String NEW_CUSTOMSHIFT = &quot;NEW_CUSTOM_SHIFT&quot;;
	private static final String NEW_FLEXTIME = &quot;NEW_FLEX_TIME&quot;;
	private static final String NEW_SHIFTSWAP_WITHDRAW = &quot;NEW_SHIFTSWAP_WITHDRAW&quot;;
<span class="fc" id="L54">	private static final String[] ACTION_NAMES = new String[] { APPLY_RULE, NEW_TIMEOFF, NEW_TIMEOFF_WITHDRAW, NEW_SHIFTSWAP_WITHDRAW,</span>
			NEW_FLEXTIME, NEW_SHIFTSWAP, NEW_SHIFTBID, NEW_CUSTOMSHIFT };
<span class="nc" id="L56">	private Set&lt;String&gt; blockGetActionsSet = new HashSet&lt;&gt;(Arrays.asList(ACTION_NAMES));</span>
	private static final String GET_METHOD= &quot;GET&quot;;
	private static final String APPSCAN_ERROR_LOG = &quot;CSRF security constraint violated. Cannot GET with a pageAction parameter&quot;;
	/**
	 * Process Request for the User page
	 * @param   context   RequestContext
	 * @throws Exception
	 */
	@Override
	public void processRequest(RequestContext context) throws Exception {
		// Handle Appscan issue &quot;Body Parameter Accepted in Query&quot;
<span class="nc" id="L67">		HttpServletRequest httpServletRequest=context.getRequest();</span>
<span class="nc" id="L68">		String method = httpServletRequest.getMethod();</span>
<span class="nc" id="L69">		String pageAction = getPageAction(context);</span>
<span class="nc bnc" id="L70" title="All 4 branches missed.">		boolean inValid = GET_METHOD.equals(method) &amp;&amp; isBlockedPageAction(pageAction);</span>
<span class="nc" id="L71">		HttpServletResponse response = context.getResponse();</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">		if (inValid) {</span>
<span class="nc" id="L73">			log.error(APPSCAN_ERROR_LOG);</span>
<span class="nc" id="L74">			response.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="nc" id="L75">			return;</span>
		}
<span class="nc" id="L77">		validateIDParameter(httpServletRequest);</span>
		// Process requested action
<span class="nc bnc" id="L79" title="All 2 branches missed.">		if (isAction(context, PageAction.EDIT) ||</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">				isAction(context, PageAction.DIALOG_OK)) {</span>
<span class="nc" id="L81">			goToFormPage(context);</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">		} else if (isAction(context, NEW_TIMEOFF)) {</span>
<span class="nc" id="L83">			context.setAttribute(RequestContext.REQUEST_SCOPE,</span>
					CREATE_RULE_TYPE,
					Request.REQUESTTYPE_TIMEOFF);
<span class="nc" id="L86">			goToFormPage(context);</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">		} else if (isAction(context, NEW_TIMEOFF_WITHDRAW)) {</span>
<span class="nc" id="L88">			context.setAttribute(RequestContext.REQUEST_SCOPE,</span>
					CREATE_RULE_TYPE,
					Request.REQUESTTYPE_TIMEOFF_WITHDRAW);
<span class="nc" id="L91">			goToFormPage(context);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">		} else if (isAction(context, NEW_FLEXTIME)) {</span>
<span class="nc" id="L93">			context.setAttribute(RequestContext.REQUEST_SCOPE,</span>
					CREATE_RULE_TYPE,
					Request.REQUESTTYPE_FLEXTIME);
<span class="nc" id="L96">			goToFormPage(context);</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">		} else if (isAction(context, NEW_SHIFTSWAP)) {</span>
<span class="nc" id="L98">			context.setAttribute(RequestContext.REQUEST_SCOPE,</span>
					CREATE_RULE_TYPE,
					Request.REQUESTTYPE_SHIFTSWAP);
<span class="nc" id="L101">			goToFormPage(context);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">		} else if (isAction(context, NEW_SHIFTSWAP_WITHDRAW)) {</span>
<span class="nc" id="L103">			context.setAttribute(RequestContext.REQUEST_SCOPE,</span>
					CREATE_RULE_TYPE,
					Request.REQUESTTYPE_SHIFTSWAP_WITHDRAW);
<span class="nc" id="L106">			goToFormPage(context);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">		} else if (isAction(context, NEW_SHIFTBID)) {</span>
<span class="nc" id="L108">			context.setAttribute(RequestContext.REQUEST_SCOPE,</span>
					CREATE_RULE_TYPE,
					Request.REQUESTTYPE_SHIFTBID);
<span class="nc" id="L111">			goToFormPage(context);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">		} else if (isAction(context, NEW_CUSTOMSHIFT)) {</span>
<span class="nc" id="L113">			context.setAttribute(RequestContext.REQUEST_SCOPE,</span>
					CREATE_RULE_TYPE,
					Request.REQUESTTYPE_CUSTSHIFT);
<span class="nc" id="L116">			goToFormPage(context);</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">		} else if (isAction(context, PageAction.DELETE)) {</span>
<span class="nc" id="L118">			processDelete(context);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">		} else if (isAction(context, APPLY_RULE)) {</span>
<span class="nc" id="L120">			processApplyRule(context);</span>
<span class="nc" id="L121">			setNextPage(context, LIST_PAGE);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">		} else if (isAction(context, PageAction.SAVE)) {</span>
<span class="nc" id="L123">			processSave(context);</span>
<span class="nc" id="L124">			setNextPage(context, LIST_PAGE);</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">		} else if (isAction(context, PageAction.DONE) ||</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">				isAction(context, PageAction.NEW_ID)) {</span>
<span class="nc" id="L127">			setNextPage(context, LIST_PAGE);</span>
		} else {
<span class="nc" id="L129">			setNextPage(context, LIST_PAGE);</span>
		}
<span class="nc" id="L131">	}</span>
	boolean isBlockedPageAction(String pageAction) {
<span class="nc bnc" id="L133" title="All 2 branches missed.">		if (StringUtil.isEmpty(pageAction)) {</span>
<span class="nc" id="L134">			return false;</span>
		}

<span class="nc" id="L137">		return blockGetActionsSet.contains(pageAction);</span>
	}

	private void validateIDParameter(HttpServletRequest httpServletRequest) {
		// selectedID
<span class="nc" id="L142">		ParameterUtil.assertOptionalCommaSeparatedLongValues(httpServletRequest, &quot;selectedID&quot;);</span>
<span class="nc" id="L143">	}</span>
	/**
	 * Sets the page to be displayed
	 * @param   context   RequestContext
	 */
	private void goToFormPage(RequestContext context) {

		// Check if authorized then display Form page else display List Page
<span class="nc bnc" id="L151" title="All 2 branches missed.">		if (!isAuthorizedForOrg(context,</span>
				new String[] {
					PrivilegeKeys.TOM_SETAUTOPROCESSING,
					PrivilegeKeys.SS_SETAUTOPROCESSING,
					PrivilegeKeys.SB_SETAUTOPROCESSING,
					PrivilegeKeys.CS_SETAUTOPROCESSING,
					PrivilegeKeys.FT_SETAUTOPROCESSING
				},
				true)) {
<span class="nc" id="L160">			setNextPage(context, LIST_PAGE);</span>
<span class="nc" id="L161">			return;</span>
		}

<span class="nc" id="L164">		setNextPage(context, FORM_PAGE);</span>
<span class="nc" id="L165">	}</span>

	/**
	 * Deletes a AutoProcessingRule
	 * @param context RequestContext	The Request context object
	 */
	private void processDelete(RequestContext context) {
		/*Steps to be followed
		1. set the next page, Check if Authorized
		2. Instantiate the List model since its a delete and the user
		should be shown the same page
		4. Retreive the Ids selected by the user for deletion use the
		the method of the list model that returns array of ID's
		5. Invoke the delete function of ModelHandler by passing
		appropriate parameters
		6. cache the model */

<span class="nc" id="L182">		setNextPage(context, LIST_PAGE);</span>

		// Security check
<span class="nc bnc" id="L185" title="All 2 branches missed.">		if (!isAuthorizedForOrg(context,</span>
				new String[] {
					PrivilegeKeys.TOM_SETAUTOPROCESSING,
					PrivilegeKeys.SS_SETAUTOPROCESSING,
					PrivilegeKeys.SB_SETAUTOPROCESSING,
					PrivilegeKeys.CS_SETAUTOPROCESSING,
					PrivilegeKeys.FT_SETAUTOPROCESSING
				},
				true)) {
<span class="nc" id="L194">			return;</span>
		}

		// Extract Parameter
<span class="nc" id="L198">		AutoProcessingListPageModel model = new AutoProcessingListPageModel(context);</span>
<span class="nc" id="L199">		model.extractParameters(context.getRequest());</span>
<span class="nc" id="L200">		context.setPageModel(model);</span>

		// Invoke the delete method of the Model Handler here
		try {
<span class="nc" id="L204">			setNextPage(context, LIST_PAGE);</span>

			// Security check
			//if (!isAuthorized(context, REQUIRED_PRIVILEGE))	return;

			// Extract Parameter

			// Process Delete
<span class="nc" id="L212">			ID[] ids = model.getSelectedAutoProcessingRuleIDs();</span>
			// Invoke the delete method of the Model Handler here
<span class="nc" id="L214">			AutoProcessingModelHandler.deleteAutoProcessingRule(ids[0]);</span>

<span class="nc" id="L216">		}	catch(Exception ex) {</span>
<span class="nc" id="L217">			handleException(model, ex, RmWebBundleKey.ORG_RM_AUTO_PROCESSING_RULE_DELETE_FAILURE,</span>
					RmWebLogBundleKey.ORG_RM_AUTO_PROCESSING_RULE_DELETE_FAILURE);
<span class="nc" id="L219">		}</span>
<span class="nc" id="L220">	}</span>

	/**
	 * Saves a Applied Flag for Filing Rules
	 * @param   context RequestContext
	 */
	private void processApplyRule(RequestContext context) throws BbmCreateException, RemoteException {
<span class="nc" id="L227">		AutoProcessingListPageModel model = new AutoProcessingListPageModel(context);</span>
<span class="nc" id="L228">		model.extractParameters(context.getRequest());</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">		if (!isAuthorizedForOrg(context,</span>
				new String[] {
					PrivilegeKeys.TOM_SETAUTOPROCESSING,
					PrivilegeKeys.SS_SETAUTOPROCESSING,
					PrivilegeKeys.SB_SETAUTOPROCESSING,
					PrivilegeKeys.CS_SETAUTOPROCESSING,
					PrivilegeKeys.FT_SETAUTOPROCESSING
				},
				true)) {
<span class="nc" id="L238">			return;</span>
		}
<span class="nc bnc" id="L240" title="All 2 branches missed.">		if (model.validate()) {</span>
			try {
<span class="nc" id="L242">				String appliedRuleIds[] = model.getAppliedRuleIds();</span>
<span class="nc" id="L243">				String totalRuleIds[] = model.getTotalRuleIds();</span>
<span class="nc" id="L244">				HashMap map = new HashMap(31);</span>
<span class="nc bnc" id="L245" title="All 4 branches missed.">				if (totalRuleIds != null &amp;&amp; totalRuleIds.length != 0) {</span>
<span class="nc" id="L246">					int l = totalRuleIds.length;</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">					for (int i = 0; i &lt; l; i++) {</span>
<span class="nc" id="L248">						map.put(new ID(totalRuleIds[i]), &quot;false&quot;);</span>
					}
				}
<span class="nc bnc" id="L251" title="All 4 branches missed.">				if (appliedRuleIds != null &amp;&amp; appliedRuleIds.length != 0) {</span>
<span class="nc" id="L252">					int l = appliedRuleIds.length;</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">					for (int i = 0; i &lt; l; i++) {</span>
<span class="nc" id="L254">						map.put(new ID(appliedRuleIds[i]), &quot;true&quot;);</span>
					}
				}
<span class="nc" id="L257">				AutoProcessingModelHandler.saveApplied(model.getSelectedIDObject(),</span>
						map);
<span class="nc" id="L259">			}	catch(BbmUpdateException ex) {</span>
<span class="nc" id="L260">				handleException(model, ex, RmWebBundleKey.ORG_RM_FILING_RULE_UPDATE_FAILURE,</span>
						RmWebLogBundleKey.ORG_RM_FILING_RULE_UPDATE_FAILURE);
<span class="nc" id="L262">			}</span>
		}
<span class="nc" id="L264">	}</span>

	/**
	 * Saves a Autoprocessing Rule
	 * @param   context RequestContext
	 */
	private void processSave(RequestContext context) {
<span class="nc" id="L271">		AutoProcessingEditPageModel model = new AutoProcessingEditPageModel(context);</span>
<span class="nc" id="L272">		model.extractParameters(context.getRequest());</span>

<span class="nc bnc" id="L274" title="All 2 branches missed.">		if (!isAuthorizedForOrg(context,</span>
				new String[] {
					PrivilegeKeys.TOM_SETAUTOPROCESSING,
					PrivilegeKeys.SS_SETAUTOPROCESSING,
					PrivilegeKeys.SB_SETAUTOPROCESSING,
					PrivilegeKeys.CS_SETAUTOPROCESSING,
					PrivilegeKeys.FT_SETAUTOPROCESSING
				},
				true)) {
<span class="nc" id="L283">			return;</span>
		}

<span class="nc bnc" id="L286" title="All 2 branches missed.">		if (model.validate()) {</span>
<span class="nc" id="L287">			AutoProcessingRule apr = model.getAutoProcessingRule();</span>
<span class="nc" id="L288">			apr.setID(model.getRuleID());</span>
<span class="nc" id="L289">			apr.setOrganizationId(model.getSelectedIDObject());</span>
			try {
<span class="nc bnc" id="L291" title="All 2 branches missed.">				if (apr.getID() == null) {</span>
<span class="nc" id="L292">					apr.setApplied(true);</span>
<span class="nc" id="L293">					ID id = AutoProcessingModelHandler.createAutoProcessingRule(apr);</span>
<span class="nc" id="L294">					apr.setID(id);</span>
<span class="nc" id="L295">				}</span>
				else {
<span class="nc" id="L297">					AutoProcessingModelHandler.updateAutoProcessingRule(apr);</span>
				}
<span class="nc" id="L299">			} catch(BbmCreateException ex) {</span>
<span class="nc" id="L300">				handleException(model, ex, RmWebBundleKey.ORG_RM_AUTO_PROCESSING_RULE_CREATE_FAILURE,</span>
						RmWebLogBundleKey.ORG_RM_AUTO_PROCESSING_RULE_CREATE_FAILURE);
<span class="nc" id="L302">			}	catch(Exception ex) {</span>
<span class="nc" id="L303">				handleException(model, ex, RmWebBundleKey.ORG_RM_AUTO_PROCESSING_RULE_SAVE_FAILURE,</span>
						RmWebLogBundleKey.ORG_RM_AUTO_PROCESSING_RULE_SAVE_FAILURE);
<span class="nc" id="L305">			}</span>
		}
<span class="nc" id="L307">	}</span>

	private void handleException(PageModel model, Exception ex, String rbKey, String logRBKey) {
<span class="nc" id="L310">		model.addPageMessage(Message.ERROR_TYPE, rbKey, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L311">		log.l7dError(logRBKey, ex);</span>
<span class="nc" id="L312">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>