<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffBidDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.setup.timeoffbid.ejb</a> &gt; <span class="el_source">TimeOffBidDAO.java</span></div><h1>TimeOffBidDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.setup.timeoffbid.ejb;

import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.dao.DAONode;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOChoice;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.setup.timeoffbid.model.TimeOffBid;
import com.bluepumpkin.ejb.rm.setup.timeoffbid.model.TimeOffBidActivity;
import com.bluepumpkin.ejb.rm.setup.timeoffbid.model.TimeOffBidFieldInfo;

/**
 * DAO class for TimeOffBidDAO
 */
public class TimeOffBidDAO extends DAONode&lt;TimeOffBid&gt; {

<span class="nc" id="L38">	private static FieldInfo fieldInfo = new TimeOffBidFieldInfo();</span>

<span class="nc" id="L40">	private static Category catLog = Log.initCategory(TimeOffBidDAO.class.getName());</span>

	/**
	 * Constructor
	 */
	public TimeOffBidDAO() {
<span class="nc" id="L46">		super();</span>
<span class="nc" id="L47">	}</span>

	/**
	 * Constructor
	 * 
	 * @param - Jdmo - Jdmo object instance
	 * @see Jdmo.
	 */
	public TimeOffBidDAO(Jdmo dmo) {
<span class="nc" id="L56">		super(dmo);</span>
<span class="nc" id="L57">	}</span>

	@Override
	protected FieldInfo getFieldInfo() {
<span class="nc" id="L61">		return fieldInfo;</span>
	}

	protected Category getCategory() {
<span class="nc" id="L65">		return catLog;</span>
	}

	/**
	 * Creates the value object.
	 * 
	 * @return - returns new Value object
	 * @see com.bluepumpkin.ejb.bbm.vo.ValueObjectBase
	 * @see com.bluepumpkin.ejb.rm.setup.timeoffbid.model.TimeOffBid
	 */
	@Override
	protected TimeOffBid createValueObject() {
<span class="nc" id="L77">		return new TimeOffBid();</span>
	}

	@Override
	protected DAOBase&lt;TimeOffBidActivity&gt; createChildDAO(int iType) {
		DAOBase&lt;TimeOffBidActivity&gt; retDAOBase;
<span class="nc" id="L83">		retDAOBase = new TimeOffBidActivityDAO(m_dmo);</span>
<span class="nc" id="L84">		return retDAOBase;</span>
	}

	/**
	 * Get Time Off Bids for given organizations which logged user can access to
	 * 
	 * @param orgIds
	 * @param needOrdered
	 * @param isAscending
	 * @return Collection&lt;TimeOffBid&gt;
	 */
	public Collection&lt;TimeOffBid&gt; getTimeOffBidsForOrgIDs(Collection&lt;ID&gt; orgIds, boolean needOrdered, boolean isAscending)
			throws BbmFinderException {
<span class="nc bnc" id="L97" title="All 4 branches missed.">		if (orgIds == null || orgIds.isEmpty()) {</span>
<span class="nc" id="L98">			return Collections.emptyList();</span>
		}
		try {
<span class="nc" id="L101">			StringBuilder sqlWhere = new StringBuilder();</span>

<span class="nc" id="L103">			sqlWhere.append(&quot;ORGANIZATIONID IN &quot; + getDMO().createInClause(orgIds));</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">			if (needOrdered) {</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">				String sortOrder = isAscending ? &quot; ASC&quot; : &quot; DESC&quot;;</span>
<span class="nc" id="L106">				sqlWhere.append(&quot; order by A.NAME&quot;).append(sortOrder);</span>
			}
<span class="nc" id="L108">			return getObjects(sqlWhere.toString());</span>
<span class="nc" id="L109">		} catch (JdmoException e) {</span>
<span class="nc" id="L110">			throw new BbmFinderException(e);</span>
		}
	}

	/**
	 * Get Time Off Bids for given organizations which logged user can access to
	 * 
	 * @param orgIds
	 * @return Collection&lt;TimeOffBid&gt;
	 */
	public Collection&lt;TimeOffBid&gt; getTimeOffBidsForOrgIDs(Collection&lt;ID&gt; orgIds) throws BbmFinderException {
<span class="nc" id="L121">		return this.getTimeOffBidsForOrgIDs(orgIds, false, false);</span>
	}

	/**
	 * Get Time Off Bids for given organizations which logged user can access to
	 * 
	 * @param orgIds
	 * @parm status
	 * @return Collection&lt;TimeOffBid&gt;
	 */
	public Collection&lt;TimeOffBid&gt; getTimeOffBidsForOrgIDsAndStatus(Collection&lt;ID&gt; orgIds, int status) throws BbmFinderException {
<span class="nc bnc" id="L132" title="All 4 branches missed.">		if (orgIds == null || orgIds.isEmpty()) {</span>
<span class="nc" id="L133">			return Collections.emptyList();</span>
		}
		try {
<span class="nc" id="L136">			String sqlWhere = &quot;ORGANIZATIONID IN &quot; + getDMO().createInClause(orgIds) + &quot; and STATUS = &quot; + status;</span>
<span class="nc" id="L137">			return getObjects(sqlWhere);</span>
<span class="nc" id="L138">		} catch (JdmoException e) {</span>
<span class="nc" id="L139">			throw new BbmFinderException(e);</span>
		}
	}

	/**
	 * check if given name of time of bid exists in a group of organizations
	 * 
	 * @param name
	 * @param orgIds
	 * @return boolean
	 * */
	public boolean checkTimeOffBidNameExists(String name, Collection&lt;ID&gt; orgIds) throws BbmFinderException {
<span class="nc" id="L151">		JdmoRowset rs = null;</span>
<span class="nc" id="L152">		boolean result = false;</span>
		try {
<span class="nc" id="L154">			StringBuilder sb = new StringBuilder(200);</span>
<span class="nc" id="L155">			sb.append(&quot;SELECT 1 from TIMEOFFBID WHERE ORGANIZATIONID IN &quot;).append(m_dmo.createInClause(orgIds));</span>
<span class="nc" id="L156">			sb.append(&quot; AND NAME='&quot;).append(name.replaceAll(&quot;'&quot;, &quot;''&quot;)).append(&quot;'&quot;);</span>
<span class="nc" id="L157">			rs = m_dmo.createRowset(sb.toString());</span>
<span class="nc bnc" id="L158" title="All 4 branches missed.">			if (rs != null &amp;&amp; rs.next()) {</span>
<span class="nc" id="L159">				result = true;</span>
			}
<span class="nc" id="L161">		} catch (JdmoException e) {</span>
<span class="nc" id="L162">			throw new BbmFinderException(e);</span>
<span class="nc" id="L163">		}</span>
<span class="nc" id="L164">		return result;</span>
	}

	/**
	 * Check if there is any pending time off request of all employees added to to the selected open bid. with the activities
	 * configured in the bid.
	 * 
	 * @param timeOffBidId
	 * @return boolean
	 * */
	public boolean checkHaveTimeOffBidRequestPending(ID timeOffBidId) throws BbmFinderException {
<span class="nc" id="L175">		JdmoRowset rs = null;</span>
<span class="nc" id="L176">		boolean result = false;</span>
		try {
			//@formatter:off
<span class="nc" id="L179">			String sqlString = String.format(&quot;SELECT 1 from REQUEST R&quot; </span>
					+ &quot; Inner Join TIMEOFFREQUEST TR on TR.ID=R.ID&quot;
					+ &quot; Inner Join TIMEOFFBIDACTIVITY TBA on TBA.ACTIVITYID=TR.ActivityID&quot; 
					+ &quot; Inner Join TIMEOFFBID TB on TB.ID= TBA.TIMEOFFBIDID&quot;
					+ &quot; Inner join TIMEOFFBIDDER TBD on TB.ID = TBD.TIMEOFFBIDID&quot;
					+ &quot; Inner join WORKRESOURCEORGANIZATION WR on R.EMPLOYEEID= WR.WORKRESOURCEID and R.EMPLOYEEID = TBD.EMPLOYEEID&quot;
					+ &quot; WHERE R.REQUESTTYPE='time-off' and R.REQUESTSTATUS='Pending'&quot;
					+ &quot; and TB.BIDSTARTTIME&lt;=R.SUBMITTEDON and R.SUBMITTEDON&lt;=TB.BIDENDTIME&quot;
					+ &quot; and TB.STATUS=%d and (WR.STARTTIME&lt;TB.BIDENDTIME AND Isnull(WR.ENDTIME,'20700101')&gt;TB.BIDSTARTTIME)&quot;
<span class="nc" id="L188">					+ &quot; and TB.ID=%d&quot;, TimeOffBid.STATUS_OPEN_FOR_BIDDING, timeOffBidId.toInt());</span>
			//@formatter:on
<span class="nc" id="L190">			rs = m_dmo.createRowset(sqlString);</span>
<span class="nc bnc" id="L191" title="All 4 branches missed.">			if (rs != null &amp;&amp; rs.next()) {</span>
<span class="nc" id="L192">				result = true;</span>
			}
<span class="nc" id="L194">		} catch (JdmoException e) {</span>
<span class="nc" id="L195">			throw new BbmFinderException(e);</span>
<span class="nc" id="L196">		}</span>
<span class="nc" id="L197">		return result;</span>
	}

	/**
	 * Getting the open time off bid for a specific activity of the request submitted by an employee
	 * 
	 * @param activityId
	 * @param employeeId
	 * @param submittedDate
	 * @return TimeOffBid
	 * */
	public 	Collection&lt;TimeOffBid&gt; getTimeOffBidsOfEmployeId(ID employeeId)
			throws BbmFinderException {
<span class="nc" id="L210">		StringBuffer strSQL = new StringBuffer(200);</span>
<span class="nc" id="L211">		strSQL.append(&quot;SELECT A.* &quot;);</span>
<span class="nc" id="L212">		appendFromWhereStatement(strSQL);</span>
		//@formatter:off
<span class="nc" id="L214">		String sqlJoin = String.format(&quot; Inner Join TIMEOFFBIDDER TBD on A.ID = TBD.TIMEOFFBIDID&quot;</span>
				+ &quot; Inner Join WORKRESOURCEORGANIZATION WR on TBD.EMPLOYEEID= WR.WORKRESOURCEID &quot;);
<span class="nc" id="L216">		String sqlWhere = String.format(&quot; WHERE  ( WR.STARTTIME&lt; A.BIDENDTIME AND Isnull(WR.ENDTIME,'20700101')&gt;A.BIDSTARTTIME )&quot;</span>
<span class="nc" id="L217">				+ &quot;and TBD.EMPLOYEEID=%d&quot;, employeeId.toInt());</span>
		//@formatter:on
<span class="nc" id="L219">		strSQL.append(sqlJoin);</span>
<span class="nc" id="L220">		strSQL.append(sqlWhere);</span>

<span class="nc" id="L222">		return getObjectsGivenFullSqlQueryStr(strSQL.toString());</span>
		
	}

	private TimeOffBid getOnlyOneOpenTimeOffBid(Collection&lt;TimeOffBid&gt; timeOffBids, Date submittedDate) {
<span class="nc" id="L227">		TimeOffBid bid = null;</span>
<span class="nc bnc" id="L228" title="All 4 branches missed.">		if (timeOffBids != null &amp;&amp; !timeOffBids.isEmpty()) {</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">			if (timeOffBids.size() == 1) {</span>
<span class="nc" id="L230">				bid = timeOffBids.iterator().next();</span>
			} else {
				//There may be more than 1 time off bid which has &quot;open&quot; status 
				//but the enddate was over so we prefer to get the valid open time off bid
				//Example: Today: 4/6,
				//There are 2 time off bids: Bid1: 03/01 to 03/14 
				//                      and Bid2: 04/01 to 04/30 
				//We will get Bid2
<span class="nc bnc" id="L238" title="All 2 branches missed.">				for (Iterator&lt;TimeOffBid&gt; iter = timeOffBids.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L239">					bid = iter.next();</span>
<span class="nc bnc" id="L240" title="All 4 branches missed.">					if (submittedDate.after(bid.getBidStartTime()) &amp;&amp; submittedDate.before(bid.getBidEndTime())) {</span>
<span class="nc" id="L241">						break;</span>
					}
				}
			}
		}
<span class="nc" id="L246">		return bid;</span>
	}

	private String buildQueryToGetTimeOffBidsForActivityIdAndEmployeId(ID activityId, ID employeeId, Date submittedDate)
			throws BbmFinderException {
		//Just in case the submittedDate is null, we get the current time is submittedDate
<span class="nc" id="L252">		Date dateSubmitted = submittedDate;</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">		if (dateSubmitted == null) {</span>
<span class="nc" id="L254">			dateSubmitted = new Date();</span>
		}
<span class="nc" id="L256">		StringBuffer strSQL = new StringBuffer(200);</span>
<span class="nc" id="L257">		strSQL.append(&quot;SELECT A.*, TBD.PERIODUNIT,TBD.MAXNUMOFPERIODS&quot;);</span>
<span class="nc" id="L258">		appendFromWhereStatement(strSQL);</span>
		//@formatter:off
<span class="nc" id="L260">		String sqlJoin = String.format(&quot;Inner Join TIMEOFFBIDACTIVITY TBA on A.ID=TBA.TIMEOFFBIDID&quot;</span>
				+ &quot; Inner Join TIMEOFFBIDDER TBD on A.ID = TBD.TIMEOFFBIDID&quot;
				+ &quot; Inner Join WORKRESOURCEORGANIZATION WR on TBD.EMPLOYEEID= WR.WORKRESOURCEID &quot;);
<span class="nc" id="L263">		String sqlWhere = String.format(&quot; WHERE  ( WR.STARTTIME&lt; A.BIDENDTIME AND Isnull(WR.ENDTIME,'20700101')&gt;A.BIDSTARTTIME )&quot;</span>
				+ &quot; and A.BIDSTARTTIME&lt;='%s'&quot; 
				+ &quot; and A.STATUS=%d and TBA.ACTIVITYID=%d and TBD.EMPLOYEEID=%d&quot;,
<span class="nc" id="L266">				JdmoUtil.formatDBString(dateSubmitted), TimeOffBid.STATUS_OPEN_FOR_BIDDING, activityId.toInt(), employeeId.toInt());</span>
		//@formatter:on
<span class="nc" id="L268">		strSQL.append(sqlJoin);</span>
<span class="nc" id="L269">		strSQL.append(sqlWhere);</span>
<span class="nc" id="L270">		return strSQL.toString();</span>
	}

	/**
	 * Getting the open time off bid for a specific activity of the request submitted by an employee
	 * and the maximum weeks/days per employee can be approved
	 * 
	 * @param activityId
	 * @param employeeId
	 * @param submittedDate
	 * @return TimeOffBid and period unit(day,week) and maximum of periods
	 * */
	public Pair&lt;TimeOffBid, Pair&lt;Integer, Integer&gt;&gt; getOpenTimeOffBidDetailForActivityIdAndEmployeId(ID activityId, ID employeeId,
			Date submittedDate) throws BbmFinderException {
<span class="nc" id="L284">		Pair&lt;TimeOffBid, Pair&lt;Integer, Integer&gt;&gt; bidDetail = null;</span>
<span class="nc" id="L285">		Collection&lt;TimeOffBid&gt; timeOffBids = new ArrayList&lt;TimeOffBid&gt;();</span>
<span class="nc" id="L286">		Map&lt;ID, Pair&lt;Integer, Integer&gt;&gt; mapBidIdPeriod = new HashMap&lt;ID, Pair&lt;Integer, Integer&gt;&gt;();</span>
<span class="nc" id="L287">		TimeOffBid bid = null;</span>
<span class="nc" id="L288">		Pair&lt;Integer, Integer&gt; unitValuePeriod = new Pair&lt;Integer, Integer&gt;();</span>
<span class="nc" id="L289">		String query = buildQueryToGetTimeOffBidsForActivityIdAndEmployeId(activityId, employeeId, submittedDate);</span>
		try {
<span class="nc" id="L291">			JdmoRowset rs = m_dmo.createRowset(query);</span>
			//There may be more than 1 time off bid which has &quot;open&quot; status but the enddate was over so we prefer to get the valid open time off bid
			//Example: Today: 4/6,
			//There are 2 time off bids: Bid1: 03/01 to 03/14 
			//                      and Bid2: 04/01 to 04/30 
			//We will get Bid2
<span class="nc bnc" id="L297" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L298">				ID bidId = rs.getID(&quot;ID&quot;);</span>
<span class="nc" id="L299">				String bidName = rs.getString(&quot;NAME&quot;);</span>
<span class="nc" id="L300">				ID orgId = rs.getID(&quot;ORGANIZATIONID&quot;);</span>
<span class="nc" id="L301">				Timestamp bidStart = rs.getTimestamp(&quot;BIDSTARTTIME&quot;);</span>
<span class="nc" id="L302">				Timestamp bidEnd = rs.getTimestamp(&quot;BIDENDTIME&quot;);</span>
<span class="nc" id="L303">				Timestamp bidRequestStart = rs.getTimestamp(&quot;REQUESTSTARTTIME&quot;);</span>
<span class="nc" id="L304">				Timestamp bidRequestEnd = rs.getTimestamp(&quot;REQUESTENDTIME&quot;);</span>
<span class="nc" id="L305">				int minUnitPerChoice = rs.getInt(&quot;MINUNITPERCHOICE&quot;);</span>
<span class="nc" id="L306">				int minValuePerChoice = rs.getInt(&quot;MINVALUEPERCHOICE&quot;);</span>
<span class="nc" id="L307">				int maxUnitPerChoice = rs.getInt(&quot;MAXUNITPERCHOICE&quot;);</span>
<span class="nc" id="L308">				int maxValuePerChoice = rs.getInt(&quot;MAXVALUEPERCHOICE&quot;);</span>
<span class="nc" id="L309">				boolean isApproveMaxValueVaried = rs.getBoolean(&quot;ISAPPROVALMAXVALUEVARIEDBYEMP&quot;);</span>
<span class="nc" id="L310">				int numOffBider = rs.getInt(&quot;NUMOFBIDDERS&quot;);</span>
<span class="nc" id="L311">				int status = rs.getInt(&quot;STATUS&quot;);</span>
<span class="nc" id="L312">				Date created = rs.getTimestamp(&quot;CREATED&quot;);</span>
<span class="nc" id="L313">				String createdBy = rs.getString(&quot;CREATEDBY&quot;);</span>
<span class="nc" id="L314">				bid = new TimeOffBid();</span>
<span class="nc" id="L315">				bid.setId(bidId);</span>
<span class="nc" id="L316">				bid.setName(bidName);</span>
<span class="nc" id="L317">				bid.setOrganizationId(orgId);</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">				bid.setBidStartTime(bidStart != null ? TimeZoneUtil.toDate(bidStart) : null);</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">				bid.setBidEndTime(bidEnd != null ? TimeZoneUtil.toDate(bidEnd) : null);</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">				bid.setRequestStartTime(bidRequestStart != null ? TimeZoneUtil.toDate(bidRequestStart) : null);</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">				bid.setRequestEndTime(bidRequestEnd != null ? TimeZoneUtil.toDate(bidRequestEnd) : null);</span>
<span class="nc" id="L322">				bid.setIsApprovalMaxValueVariesByEmp(isApproveMaxValueVaried);</span>
<span class="nc" id="L323">				bid.setNumOfBidders(numOffBider);</span>
<span class="nc" id="L324">				bid.setMinUnitPerChoice(minUnitPerChoice);</span>
<span class="nc" id="L325">				bid.setMinValuePerChoice(minValuePerChoice);</span>
<span class="nc" id="L326">				bid.setMaxUnitPerChoice(maxUnitPerChoice);</span>
<span class="nc" id="L327">				bid.setMaxValuePerChoice(maxValuePerChoice);</span>
<span class="nc" id="L328">				bid.setStatus(status);</span>
<span class="nc" id="L329">				bid.setCreated(created);</span>
<span class="nc" id="L330">				bid.setCreatedBy(createdBy);</span>
<span class="nc" id="L331">				int periodUnit = 0;</span>
<span class="nc" id="L332">				int periodValue = 0;</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">				if (isApproveMaxValueVaried) {</span>
<span class="nc" id="L334">					periodUnit = rs.getInt(&quot;PERIODUNIT&quot;);</span>
<span class="nc" id="L335">					periodValue = rs.getInt(&quot;MAXNUMOFPERIODS&quot;);</span>
				} else {
<span class="nc" id="L337">					periodUnit = rs.getInt(&quot;MAXUNITFORAPPROVAL&quot;);</span>
<span class="nc" id="L338">					periodValue = rs.getInt(&quot;MAXVALUEFORAPPROVAL&quot;);</span>
				}
<span class="nc" id="L340">				timeOffBids.add(bid);</span>
<span class="nc" id="L341">				unitValuePeriod = new Pair&lt;Integer, Integer&gt;(new Integer(periodUnit), new Integer(periodValue));</span>
<span class="nc" id="L342">				mapBidIdPeriod.put(bidId, unitValuePeriod);</span>
<span class="nc" id="L343">			}//End while</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">			if (!timeOffBids.isEmpty()) {</span>
<span class="nc" id="L345">				bid = getOnlyOneOpenTimeOffBid(timeOffBids, submittedDate);</span>
<span class="nc" id="L346">				unitValuePeriod = mapBidIdPeriod.get(bid.getId());</span>
<span class="nc" id="L347">				bidDetail = new Pair&lt;TimeOffBid, Pair&lt;Integer, Integer&gt;&gt;(bid, unitValuePeriod);</span>

			}

<span class="nc" id="L351">		} catch (Exception e) {</span>
<span class="nc" id="L352">			throw new BbmFinderException(e);</span>
<span class="nc" id="L353">		}</span>

<span class="nc" id="L355">		return bidDetail;</span>
	}

	/**
	 * Get total duration (in minutes) of all approved choice of bid requests for an employee.
	 * 
	 * @param employeeId
	 * @return int
	 * */
	public long getTotalMinutesBidRequestApprovedPerEmployee(ID bidId, ID employeeId, ID activityId) throws BbmFinderException {
<span class="nc" id="L365">		JdmoRowset rs = null;</span>
<span class="nc" id="L366">		long totalMinute = 0;</span>
		try {
			//@formatter:off
<span class="nc" id="L369">			String sqlString = String.format(&quot;SELECT SUM(DATEDIFF(MINUTE,TRC.STARTTIME,TRC.ENDTIME)) as TOTALDURATION&quot;</span>
<span class="nc" id="L370">					+ sqlStringForGetApproveChoices() </span>
					+ &quot; and TBA.ACTIVITYID=%d&quot;
<span class="nc" id="L372">					+ &quot; group by TBD.EMPLOYEEID&quot;, bidId.toInt(), employeeId.toInt(), activityId.toInt());</span>
			//@formatter:on
<span class="nc" id="L374">			rs = m_dmo.createRowset(sqlString);</span>
<span class="nc bnc" id="L375" title="All 4 branches missed.">			if (rs != null &amp;&amp; rs.next()) {</span>
<span class="nc" id="L376">				totalMinute = rs.getLong(&quot;TOTALDURATION&quot;);</span>
			}
<span class="nc" id="L378">		} catch (JdmoException e) {</span>
<span class="nc" id="L379">			throw new BbmFinderException(e);</span>
<span class="nc" id="L380">		}</span>
<span class="nc" id="L381">		return totalMinute;</span>
	}

	private String sqlStringForGetApproveChoices() {
		//@formatter:off
<span class="nc" id="L386">		String sqlStr = &quot; From TIMEOFFBIDDER TBD&quot; + &quot; Inner Join REQUEST R on R.EMPLOYEEID = TBD.EMPLOYEEID&quot;</span>
				+ &quot; Inner Join WORKRESOURCEORGANIZATION WRO  on R.EMPLOYEEID=WRO.WORKRESOURCEID&quot;
				+ &quot; Inner Join TIMEOFFREQUEST TR on TR.ID=R.ID&quot; 
				+ &quot; Inner Join TIMEOFFBIDACTIVITY TBA on TBA.ACTIVITYID=TR.ACTIVITYID&quot;
				+ &quot; Inner Join TIMEOFFREQUESTCHOICE TRC on TRC.TIMEOFFREQUESTID=TR.ID&quot;
				+ &quot; and TRC.STARTTIME&lt;IsNull(WRO.ENDTIME,'20700101') and TRC.EndTime&gt;WRO.STARTTIME&quot;
				+ &quot; Inner Join TIMEOFFBID TB on TB.ID= TBA.TIMEOFFBIDID and TB.ID = TBD.TIMEOFFBIDID&quot; 
				+ &quot; WHERE R.REQUESTTYPE='time-off'&quot;
				+ &quot; and R.REQUESTSTATUS='approved' and TRC.APPROVED = 1&quot;
				+ &quot; and TB.STATUS=0&quot;
				+ &quot; and TRC.STARTTIME&lt;IsNull(TB.REQUESTENDTIME,'20700101') and TRC.EndTime&gt;TB.REQUESTSTARTTIME&quot;
				+ &quot; and (WRO.STARTTIME&lt;TB.BIDENDTIME AND Isnull(WRO.ENDTIME,'20700101')&gt;TB.BIDSTARTTIME)&quot;
				+ &quot; and TB.ID=%d&quot;
				+ &quot; and TBD.EMPLOYEEID=%d&quot; ;
		//@formatter:on
<span class="nc" id="L401">		return sqlStr;</span>
	}

	public Collection&lt;TOChoice&gt; getApprovedTimeOffRequestChoiceDuringOpenBid(ID bidId, ID employeeId, Collection&lt;ID&gt; activityIds)
			throws BbmFinderException {
<span class="nc" id="L406">		Collection&lt;TOChoice&gt; choices = new ArrayList&lt;TOChoice&gt;();</span>
		try {
			//@formatter:off
<span class="nc" id="L409">			String sqlString = String.format(&quot;SELECT TRC.*&quot; </span>
<span class="nc" id="L410">							+ sqlStringForGetApproveChoices()</span>
<span class="nc" id="L411">							+ &quot; and TBA.ACTIVITYID in &quot; + m_dmo.createInClause(activityIds)</span>
<span class="nc" id="L412">							, bidId.toInt(), employeeId.toInt());</span>
			//@formatter:on
<span class="nc" id="L414">			TOChoice choice = null;</span>
	
<span class="nc" id="L416">			JdmoRowset rs = m_dmo.createRowset(sqlString);</span>

<span class="nc bnc" id="L418" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L419">				ID choiceId = rs.getID(&quot;ID&quot;);</span>
<span class="nc" id="L420">				ID timeOffRequestId = rs.getID(&quot;TIMEOFFREQUESTID&quot;);</span>
<span class="nc" id="L421">				Timestamp choiceStart = rs.getTimestamp(&quot;STARTTIME&quot;);</span>
<span class="nc" id="L422">				Timestamp choiceEnd = rs.getTimestamp(&quot;ENDTIME&quot;);</span>
<span class="nc" id="L423">				int rank = rs.getInt(&quot;RANK&quot;);</span>
<span class="nc" id="L424">				int userRank = rs.getInt(&quot;USERRANK&quot;);</span>
<span class="nc" id="L425">				boolean isWaitList = rs.getBoolean(&quot;ISWAITLIST&quot;);</span>
<span class="nc" id="L426">				ID referenceSpId = rs.getID(&quot;REFERENCESPID&quot;);</span>
<span class="nc" id="L427">				choice = new TOChoice();</span>
<span class="nc" id="L428">				choice.setID(choiceId);</span>
<span class="nc" id="L429">				choice.setTimeOffRequestID(timeOffRequestId);</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">				choice.setStartDate(choiceStart != null ? TimeZoneUtil.toDate(choiceStart) : null);</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">				choice.setEndDate(choiceEnd != null ? TimeZoneUtil.toDate(choiceEnd) : null);</span>
<span class="nc" id="L432">				choice.setRank(rank);</span>
<span class="nc" id="L433">				choice.setUserRank(userRank);</span>
<span class="nc" id="L434">				choice.setIsWaitlist(isWaitList);</span>
<span class="nc" id="L435">				choice.setReferenceScheduleID(referenceSpId);</span>
<span class="nc" id="L436">				choices.add(choice);</span>
<span class="nc" id="L437">			}</span>
<span class="nc" id="L438">		} catch (Exception e) {</span>
<span class="nc" id="L439">			throw new BbmFinderException(e);</span>
<span class="nc" id="L440">		}</span>
<span class="nc" id="L441">		return choices;</span>
	}
	public Collection&lt;ID&gt; getBidActivityIds(ID timeOffBidId) throws BbmObjectNotFoundException, BbmFinderException{
<span class="nc" id="L444">		Collection&lt;TimeOffBidActivity&gt; bidActivities = getObjectByID(timeOffBidId).getTimeOffBidActivities();</span>
<span class="nc" id="L445">		Collection&lt;ID&gt; activityIds= new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">		for(TimeOffBidActivity bidActivity:bidActivities){</span>
<span class="nc" id="L447">			activityIds.add(bidActivity.getActivityId());</span>
<span class="nc" id="L448">		}</span>
<span class="nc" id="L449">		return activityIds;</span>
	}
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>