<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftImportPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules</a> &gt; <span class="el_source">ShiftImportPopupPM.java</span></div><h1>ShiftImportPopupPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeContext;
import com.bluepumpkin.common.datatypes.TimeOfDay;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignOrg;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.time.TimeContextFactory;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.Shift;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftEvent;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.shift.ShiftUtil;
import com.verint.web.fs.widgets.StartTimes;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.data.DataSet;
import com.witness.web.uif.data.DataTable;
import com.witness.web.uif.data.DataTableRow;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.TimeZoneOverrideUtil;

import java.text.ParseException;
import java.util.*;
import java.util.Map.Entry;

//import com.bluepumpkin.web.fs.l10n.FsWebBundle;

public class ShiftImportPopupPM extends WorkRulesImportPopupPM {
	private static final long serialVersionUID = 1L;

	public static final String FORM_ACTION = &quot;shift_import&quot;;

	private static final String SHIFT_NAME_FN = &quot;SHIFT_NAME_FN&quot;;
	private static final String SHIFT_ACTIVITY_FN = &quot;SHIFT_ACTIVITY_FN&quot;;
	private static final String SHIFT_DURATION_FN = &quot;SHIFT_DURATION_FN&quot;;
	private static final String START_TIMES_FN = &quot;START_TIMES_FN&quot;;
	private static final String MIN_SPACING_FN = &quot;MIN_SPACING_FN&quot;;
	private static final String MAX_SPACING_FN = &quot;MAX_SPACING_FN&quot;;
	private static final String ORGANIZATION_FN = &quot;ORGANIZATION_FN&quot;;
	private static final String SHIFT_DESCRIPTION_FN = &quot;SHIFT_DESCRIPTION_FN&quot;;
	private static final String SHIFT_EVENTS_FN = &quot;SHIFT_EVENTS_FN&quot;;

	private Map&lt;ID, Organization&gt; m_organizationMap;
	private Map&lt;ID, Campaign&gt; m_campaignMap;

	public ShiftImportPopupPM(RequestContext context) {
<span class="nc" id="L53">		super(context);</span>

		// Disable comma delimiter because shift events field comma delimits
		// multiple assignments.
<span class="nc" id="L57">		setIsCommaDelimiterEnabled(false);</span>

<span class="nc" id="L59">		setNumberOfLinesToIgnore(1);</span>
<span class="nc" id="L60">	}</span>

	public static ShiftImportPopupPM getInstance(RequestContext context) {
<span class="nc" id="L63">		return (ShiftImportPopupPM) getInstance(context, ShiftImportPopupPM.class);</span>
	}

	@Override
	protected void initializeFieldInfo() {
<span class="nc" id="L68">		m_fsResourceBundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>

<span class="nc" id="L70">		ArrayList&lt;FieldInfo&gt; fieldDefinitions = new ArrayList&lt;FieldInfo&gt;();</span>
<span class="nc" id="L71">		fieldDefinitions.add(new FieldInfo(SHIFT_NAME_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFT_NAME), true,</span>
				true, false));
<span class="nc" id="L73">		fieldDefinitions.add(new FieldInfo(SHIFT_ACTIVITY_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_ACTIVITY), true,</span>
				true, false));
<span class="nc" id="L75">		fieldDefinitions.add(new FieldInfo(SHIFT_DURATION_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_DURATION), false,</span>
				true, true));
<span class="nc" id="L77">		fieldDefinitions.add(new FieldInfo(START_TIMES_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_START_TIMES), true,</span>
				true, false));
<span class="nc" id="L79">		fieldDefinitions.add(new FieldInfo(MIN_SPACING_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_MIN_SPACING), false,</span>
				true, true));
<span class="nc" id="L81">		fieldDefinitions.add(new FieldInfo(MAX_SPACING_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_MAX_SPACING), false,</span>
				true, true));
<span class="nc" id="L83">		fieldDefinitions.add(new FieldInfo(ORGANIZATION_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_ORGANIZATION), true,</span>
				true, false));
<span class="nc" id="L85">		fieldDefinitions.add(new FieldInfo(SHIFT_DESCRIPTION_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_DESCRIPTION),</span>
				false, true, false));
<span class="nc" id="L87">		fieldDefinitions.add(new FieldInfo(SHIFT_EVENTS_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFT_EVENTS), false,</span>
				true, false));

		// Not defining a table because this is the only one.
<span class="nc" id="L91">		addTableFieldInfo(fieldDefinitions);</span>
<span class="nc" id="L92">	}</span>

	private void addStartTimesToShift(Shift shift, Collection&lt;TimeOfDay&gt; startTimesToAdd) {
<span class="nc" id="L95">		TimeContext timeContext = TimeContextFactory.getTimeContext(shift, m_organizationMap, m_campaignMap);</span>

		// TODO: This merges the shifts in
<span class="nc" id="L98">		shift.setShiftStarts(ShiftUtil.getShiftStarts(timeContext, shift.getID(), startTimesToAdd));</span>
<span class="nc" id="L99">	}</span>

	@Override
	protected void parseImport(DataSet dataSet) throws Exception {
<span class="nc" id="L103">		boolean success = true;</span>

<span class="nc" id="L105">		System.out.println(&quot;DEBUG: Shift import parse import START&quot;);</span>

<span class="nc" id="L107">		DataTable table = dataSet.getDefaultTable();</span>

<span class="nc" id="L109">		HashMap&lt;ID, String&gt; existingShifts = new HashMap&lt;ID, String&gt;();</span>
<span class="nc" id="L110">		HashMap&lt;ID, String&gt; updatableShifts = new HashMap&lt;ID, String&gt;();</span>
<span class="nc" id="L111">		Collection&lt;String&gt; reservedShiftNames = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L113">		Collection&lt;ID&gt; orgIds = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L114">		HashMap&lt;String, ShiftEvent&gt; shiftEventMap = new HashMap&lt;String, ShiftEvent&gt;();</span>
<span class="nc" id="L115">		m_organizationMap = new HashMap&lt;ID, Organization&gt;();</span>
<span class="nc" id="L116">		m_campaignMap = new HashMap&lt;ID, Campaign&gt;();</span>
<span class="nc" id="L117">		int dayBoundaryOffset = 0;</span>
		try {
<span class="nc bnc" id="L119" title="All 2 branches missed.">			if (m_isByOrganization) { // If by org</span>
<span class="nc" id="L120">				updatableShifts = WorkRulesModelHandler.getShiftNamesByOrg(m_context, new ID(m_organizationId));</span>

<span class="nc" id="L122">				ID orgID = new ID(m_organizationId);</span>

<span class="nc" id="L124">				Collection&lt;ID&gt; orgParams = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L125">				orgParams.add(orgID);</span>

<span class="nc" id="L127">				m_organizationMap = WorkRulesModelHandler.getOrgs(m_context, orgParams);</span>
<span class="nc" id="L128">				orgIds.add(orgID);</span>

<span class="nc" id="L130">				dayBoundaryOffset = m_organizationMap.get(orgID).getDayBoundaryOffset();</span>

<span class="nc" id="L132">				Collection&lt;ShiftEvent&gt; shiftEvents = WorkRulesModelHandler.getShiftEventsByOrgHierarchy(m_context, orgID);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">				for (ShiftEvent se : shiftEvents) {</span>
<span class="nc" id="L134">					shiftEventMap.put(se.getName(), se);</span>
<span class="nc" id="L135">				}</span>
<span class="nc" id="L136">			} else { // If by Scheduling Period/Campaign</span>
<span class="nc" id="L137">				SchedulingPeriod sp = CampaignModelHandler.getSchedulingPeriodByID(m_context, new ID(m_schedulingPeriodId));</span>
				// for naming conflicts.. getShiftListBySchedulingPeriod
<span class="nc" id="L139">				existingShifts = WorkRulesModelHandler.getShiftNamesBySchedulingPeriod(m_context, sp);</span>
				// for permitted edits..
<span class="nc" id="L141">				Collection&lt;Shift&gt; dbShifts = WorkRulesModelHandler.getCurrentShiftsBySchedulingPeriodCampaignOnly(m_context,</span>
<span class="nc" id="L142">						sp.getID());</span>
<span class="nc" id="L143">				Collection&lt;CampaignOrg&gt; orgAssigned = CampaignModelHandler.getCampaignOrgAssignments(m_context, new ID(</span>
<span class="nc" id="L144">						m_campaignId), sp.getStartTime(), sp.getEndTime());</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">				for (CampaignOrg co : orgAssigned) {</span>
<span class="nc" id="L146">					orgIds.add(co.getOrganizationID());</span>
<span class="nc" id="L147">				}</span>

<span class="nc bnc" id="L149" title="All 2 branches missed.">				for (Shift shift : dbShifts) {</span>
<span class="nc" id="L150">					updatableShifts.put(shift.getID(), shift.getName());</span>
<span class="nc" id="L151">				}</span>

				// Populate reserved shift names
<span class="nc bnc" id="L154" title="All 2 branches missed.">				for (Entry&lt;ID, String&gt; entry : existingShifts.entrySet()) {</span>
<span class="nc" id="L155">					reservedShiftNames.add(entry.getValue());</span>
<span class="nc" id="L156">				}</span>

				// Shift
<span class="nc" id="L159">				Collection&lt;ShiftEvent&gt; shiftEvents = WorkRulesModelHandler.getShiftEventsBySchedulingPeriod(m_context,</span>
<span class="nc" id="L160">						sp.getID());</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">				for (ShiftEvent se : shiftEvents) {</span>
<span class="nc" id="L162">					shiftEventMap.put(se.getName(), se);</span>
<span class="nc" id="L163">				}</span>

<span class="nc" id="L165">				Collection&lt;ID&gt; campaignIds = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L166">				campaignIds.add(sp.getCampaignID());</span>

<span class="nc" id="L168">				m_campaignMap = WorkRulesModelHandler.getCampaigns(m_context, campaignIds);</span>

<span class="nc" id="L170">				dayBoundaryOffset = m_campaignMap.get(sp.getCampaignID()).getDayBoundaryOffset();</span>
			}
<span class="nc" id="L172">		} catch (Exception ex) {</span>
<span class="nc" id="L173">			addPageMessage(Message.ERROR_TYPE, &quot;Error: &quot; + ex.getMessage());</span>
<span class="nc" id="L174">		}</span>

		// Populate a map with reverse look up by name instead of ID.
<span class="nc" id="L177">		HashMap&lt;String, ID&gt; shiftsNameIDMap = new HashMap&lt;String, ID&gt;();</span>

<span class="nc bnc" id="L179" title="All 2 branches missed.">		for (Entry&lt;ID, String&gt; entry : updatableShifts.entrySet()) {</span>
<span class="nc" id="L180">			shiftsNameIDMap.put(updatableShifts.get(entry.getKey()), entry.getKey());</span>
<span class="nc" id="L181">		}</span>

		// Populate a map with reverse look up of name instead of ID.
<span class="nc" id="L184">		Map&lt;String, ID&gt; orgsNameIDMap = new HashMap&lt;String, ID&gt;();</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">		for (ID key : m_organizationMap.keySet()) {</span>
<span class="nc" id="L186">			orgsNameIDMap.put(m_organizationMap.get(key).getName(), key);</span>
<span class="nc" id="L187">		}</span>

		// Get Activities that are viable for the current selection.
<span class="nc" id="L190">		Collection&lt;Activity&gt; activities = ActivityModelHandler.getActivitiesByActivitySelectionType(getRequestContext(),</span>
				ActivityModelHandler.ActivitySelectionProperty.UsedInShift, orgIds);
<span class="nc" id="L192">		Map&lt;String, ID&gt; activityNameIDMap = new HashMap&lt;String, ID&gt;();</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">		for (Activity activity : activities) {</span>
<span class="nc" id="L194">			activityNameIDMap.put(activity.getName(), activity.getID());</span>
<span class="nc" id="L195">		}</span>

<span class="nc" id="L197">		int shiftsCreated = 0;</span>
<span class="nc" id="L198">		int shiftsSkipped = 0;</span>
<span class="nc" id="L199">		Collection&lt;Shift&gt; shiftsToUpdate = new ArrayList&lt;Shift&gt;();</span>
<span class="nc" id="L200">		Map&lt;String, ID&gt; shiftNamesCreated = new HashMap&lt;String, ID&gt;();</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">		for (DataTableRow row : table.getRows()) {</span>
<span class="nc" id="L202">			boolean hasErrors = false;</span>
<span class="nc" id="L203">			boolean isNew = true;</span>

<span class="nc" id="L205">			Object shiftName = null;</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">			if (isChecked(SHIFT_NAME_FN)) { // REQUIRED</span>
<span class="nc" id="L207">				shiftName = row.get(SHIFT_NAME_FN);</span>
			}

<span class="nc" id="L210">			Shift shift = null;</span>

<span class="nc bnc" id="L212" title="All 2 branches missed.">			if (shiftName != null) {</span>
				// Identify the shift to work with.
				// shiftsNameIDMap is populated with 'updatable' shifts
<span class="nc" id="L215">				ID shiftId = shiftsNameIDMap.get(shiftName);</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">				if (shiftId != null) {</span>
<span class="nc" id="L217">					shift = WorkRulesModelHandler.getShift(m_context, shiftId);</span>
<span class="nc" id="L218">					isNew = false;</span>
				}
			}

			// If not shift is found, create a new shift.
<span class="nc bnc" id="L223" title="All 2 branches missed.">			if (shift == null) {</span>
				// We now need to check if the name conflicts with
				// any shift visible by this sp or org, not just the updatable
				// ones.
<span class="nc bnc" id="L227" title="All 2 branches missed.">				if (reservedShiftNames.contains(shiftName.toString())) {</span>
<span class="nc" id="L228">					addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFT_IMPORT_NAME_IN_USE,</span>
<span class="nc" id="L229">							new Object[]{shiftName.toString()}));</span>
<span class="nc" id="L230">					hasErrors = true;</span>
				}

<span class="nc" id="L233">				shift = new Shift();</span>
<span class="nc" id="L234">				shift.setName(shiftName.toString());</span>
<span class="nc" id="L235">				isNew = true;</span>
			}

<span class="nc bnc" id="L238" title="All 2 branches missed.">			if (isChecked(SHIFT_ACTIVITY_FN)) { // REQUIRED</span>
<span class="nc" id="L239">				Object shiftActivity = row.get(SHIFT_ACTIVITY_FN);</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">				if (activityNameIDMap.containsKey(shiftActivity)) {</span>
<span class="nc" id="L241">					shift.setActivityID(activityNameIDMap.get(shiftActivity));</span>
				} else {
<span class="nc" id="L243">					addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle,</span>
							FsWebBundleKey.FS_SHIFT_IMPORT_INVALID_ACTIVITY, new Object[]{shiftName, shiftActivity}));
<span class="nc" id="L245">					hasErrors = true;</span>
				}
			}

<span class="nc bnc" id="L249" title="All 2 branches missed.">			if (isChecked(ORGANIZATION_FN)) { // REQUIRED</span>
<span class="nc" id="L250">				Object organization = row.get(ORGANIZATION_FN);</span>
				// ! magic string.
<span class="nc" id="L252">				if (organization.toString().toLowerCase()</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">						.compareTo(i18n(m_fsResourceBundle, FsWebBundleKey.LOCAL).toLowerCase()) == 0) {</span>
<span class="nc" id="L254">					shift.setOrganizationID(null);</span>
<span class="nc" id="L255">					shift.setCampaignID(new ID(m_campaignId));</span>
				} else {
<span class="nc" id="L257">					ID lookupOrg = orgsNameIDMap.get(organization.toString());</span>
<span class="nc bnc" id="L258" title="All 4 branches missed.">					if (lookupOrg == null || !lookupOrg.equals(new ID(m_organizationId))) {</span>
<span class="nc" id="L259">						addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle,</span>
								FsWebBundleKey.FS_SHIFT_IMPORT_INVALID_ORGANIZATION,
<span class="nc" id="L261">								new Object[]{shiftName, String.valueOf(organization)}));</span>
<span class="nc" id="L262">						hasErrors = true;</span>
					} else {
<span class="nc" id="L264">						shift.setCampaignID(null);</span>
<span class="nc" id="L265">						shift.setOrganizationID(lookupOrg);</span>
					}
				}
				// Look for the permitted organization ID settings, should be a
				// specific ID or null (in the case of scheduling periods).
			}

<span class="nc bnc" id="L272" title="All 2 branches missed.">			if (isChecked(SHIFT_DURATION_FN)) {</span>
<span class="nc" id="L273">				Object shiftDuration = row.get(SHIFT_DURATION_FN);</span>
				try {
<span class="nc" id="L275">					shift.setDuration(parseDurationMinutesFromHHMM(shiftDuration.toString()));</span>
<span class="nc" id="L276">				} catch (Exception ex) {</span>
<span class="nc" id="L277">					addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle,</span>
							FsWebBundleKey.FS_SHIFT_IMPORT_INVALID_DURATION_FORMAT,
<span class="nc" id="L279">							new Object[]{shiftName, String.valueOf(shiftDuration)}));</span>
<span class="nc" id="L280">					hasErrors = true;</span>
<span class="nc" id="L281">				}</span>
<span class="nc" id="L282">			} else {</span>
				// Shift Duration should be 15 minutes minimum as a default if
				// not provided.
<span class="nc bnc" id="L285" title="All 4 branches missed.">				if (isNew &amp;&amp; shift.getDuration() == 0) {</span>
<span class="nc" id="L286">					shift.setDuration(15);</span>
				}
			}

<span class="nc bnc" id="L290" title="All 2 branches missed.">			if (isChecked(START_TIMES_FN)) { // REQUIRED</span>
<span class="nc" id="L291">				Object shiftStartTimes = row.get(START_TIMES_FN);</span>
				try {
<span class="nc" id="L293">					addStartTimesToShift(shift, parseStartTimes(shiftStartTimes.toString()));</span>
<span class="nc" id="L294">				} catch (Exception ex) {</span>
<span class="nc" id="L295">					addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle,</span>
							FsWebBundleKey.FS_SHIFT_IMPORT_INVALID_START_TIME_FORMAT,
<span class="nc" id="L297">							new Object[]{shiftName, String.valueOf(shiftStartTimes)}));</span>
<span class="nc" id="L298">					hasErrors = true;</span>
<span class="nc" id="L299">				}</span>
			}

<span class="nc bnc" id="L302" title="All 2 branches missed.">			if (isChecked(MIN_SPACING_FN)) {</span>
<span class="nc" id="L303">				Object minSpacing = row.get(MIN_SPACING_FN);</span>
				try {
<span class="nc" id="L305">					shift.setMinSpacing(parseDurationMinutesFromHHMM(minSpacing.toString()));</span>
<span class="nc" id="L306">				} catch (Exception ex) {</span>
<span class="nc" id="L307">					addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle,</span>
							FsWebBundleKey.FS_SHIFT_IMPORT_INVALID_MIN_SPACING_FORMAT,
<span class="nc" id="L309">							new Object[]{shiftName, String.valueOf(minSpacing)}));</span>
<span class="nc" id="L310">					hasErrors = true;</span>
<span class="nc" id="L311">				}</span>
			}
<span class="nc bnc" id="L313" title="All 2 branches missed.">			if (isChecked(MAX_SPACING_FN)) {</span>
<span class="nc" id="L314">				Object maxSpacing = row.get(MAX_SPACING_FN);</span>
				try {
<span class="nc" id="L316">					shift.setMaxSpacing(parseDurationMinutesFromHHMM(maxSpacing.toString()));</span>
<span class="nc" id="L317">				} catch (Exception ex) {</span>
<span class="nc" id="L318">					addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle,</span>
							FsWebBundleKey.FS_SHIFT_IMPORT_INVALID_MAX_SPACING_FORMAT,
<span class="nc" id="L320">							new Object[]{shiftName, String.valueOf(maxSpacing)}));</span>
<span class="nc" id="L321">					hasErrors = true;</span>
<span class="nc" id="L322">				}</span>
			}

<span class="nc bnc" id="L325" title="All 4 branches missed.">			if (shift.getMaxSpacing() != 0 &amp;&amp; shift.getMinSpacing() &gt; shift.getMaxSpacing()) {</span>
<span class="nc" id="L326">				addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle,</span>
						FsWebBundleKey.FS_SHIFT_IMPORT_INVALID_MIN_MAX_SPACING_DEFINTION, new Object[]{shiftName}));
<span class="nc" id="L328">				hasErrors = true;</span>
			}

<span class="nc bnc" id="L331" title="All 2 branches missed.">			if (isChecked(SHIFT_DESCRIPTION_FN)) {</span>
<span class="nc" id="L332">				Object shiftDescription = row.get(SHIFT_DESCRIPTION_FN);</span>
<span class="nc" id="L333">				shift.setDescription(shiftDescription.toString());</span>
			}

<span class="nc bnc" id="L336" title="All 2 branches missed.">			if (isChecked(SHIFT_EVENTS_FN)) {</span>

				// Shift Events Assigned
<span class="nc" id="L339">				StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">				for (ShiftEvent evt : shift.getShiftEvents()) {</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">					if (sb.length() &gt; 0) {</span>
<span class="nc" id="L342">						sb.append(&quot;, &quot;);</span>
					}
<span class="nc" id="L344">					sb.append(evt.getName());</span>
<span class="nc" id="L345">				}</span>

<span class="nc" id="L347">				Object shiftEvent = row.get(SHIFT_EVENTS_FN);</span>
<span class="nc" id="L348">				String[] shiftEventNames = shiftEvent.toString().split(&quot;,&quot;);</span>
<span class="nc" id="L349">				Collection&lt;ShiftEvent&gt; shiftEventAssignments = new ArrayList&lt;ShiftEvent&gt;();</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">				for (String shiftEventName : shiftEventNames) {</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">					if (shiftEventName.trim().length() == 0) {</span>
<span class="nc" id="L352">						continue; // Empty shift event name we treat as no</span>
					}
					// assignments.
<span class="nc" id="L355">					ShiftEvent se = shiftEventMap.get(shiftEventName.trim());</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">					if (se != null) {</span>
<span class="nc" id="L357">						shiftEventAssignments.add(se);</span>
					} else {
<span class="nc" id="L359">						addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle,</span>
								FsWebBundleKey.FS_SHIFT_IMPORT_INVALID_SHIFT_EVENT_ASSIGNMENT, new Object[]{shiftName,
<span class="nc" id="L361">										shiftEventName.trim()}));</span>
<span class="nc" id="L362">						hasErrors = true;</span>
					}
				}

<span class="nc" id="L366">				shift.setShiftEvents(shiftEventAssignments);</span>

<span class="nc" id="L368">				Map&lt;String, TimeZone&gt; shiftTimeZones = ShiftUtil.getTimeZoneForShifts(Collections.singleton(shift),</span>
						m_organizationMap, m_campaignMap);
<span class="nc" id="L370">				Map&lt;String, TimeZone&gt; shiftEventTimeZones = ShiftUtil.getTimeZoneForShiftEventsInShifts(Collections.singleton(shift),</span>
						m_organizationMap, m_campaignMap);

				// Call shift event validation.
<span class="nc" id="L374">				ArrayList&lt;Message&gt; validationResults = ShiftUtil.validateShiftEventAssignments(m_localizer,</span>
<span class="nc" id="L375">						dayBoundaryOffset, shift, shift.getWorkTypeShiftEvents(), true, shiftTimeZones, shiftEventTimeZones);</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">				for (Message m : validationResults) {</span>
<span class="nc" id="L377">					addImportStatusMessage(m.getLocalizedMessage(m_localizer));</span>
<span class="nc" id="L378">				}</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">				if (validationResults.size() &gt; 0) {</span>
<span class="nc" id="L380">					hasErrors = true;</span>
				}

<span class="nc" id="L383">				validationResults = ShiftUtil.validateShiftEventAssignments(m_localizer, dayBoundaryOffset, shift,</span>
<span class="nc" id="L384">						shift.getBreakTypeShiftEvents(), false, shiftTimeZones, shiftEventTimeZones);</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">				for (Message m : validationResults) {</span>
<span class="nc" id="L386">					addImportStatusMessage(m.getLocalizedMessage(m_localizer));</span>
<span class="nc" id="L387">				}</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">				if (validationResults.size() &gt; 0) {</span>
<span class="nc" id="L389">					hasErrors = true;</span>
				}

<span class="nc" id="L392">				sb = new StringBuilder();</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">				for (ShiftEvent evt : shift.getShiftEvents()) {</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">					if (sb.length() &gt; 0) {</span>
<span class="nc" id="L395">						sb.append(&quot;, &quot;);</span>
					}
<span class="nc" id="L397">					sb.append(evt.getName());</span>
<span class="nc" id="L398">				}</span>
			}

<span class="nc" id="L401">			List&lt;Message&gt; shiftValidationResults = ShiftUtil.validateShift(m_localizer, shift);</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">			for (Message m : shiftValidationResults) {</span>
<span class="nc" id="L403">				addImportStatusMessage(m.getLocalizedMessage(m_localizer));</span>
<span class="nc" id="L404">			}</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">			if (shiftValidationResults.size() &gt; 0) {</span>
<span class="nc" id="L406">				hasErrors = true;</span>
			}

<span class="nc bnc" id="L409" title="All 2 branches missed.">			if (!hasErrors) {</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">				if (isNew</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">						&amp;&amp; (m_importBehavior.compareTo(IMPORT_BEHAVIOR_ADD_UPDATE) == 0 || m_importBehavior</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">						.compareTo(IMPORT_BEHAVIOR_ADD_ONLY) == 0)) {</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">					if (!shiftNamesCreated.containsKey(shift.getName())) {</span>
						// If the shift was already created, i.e. someone added
						// a new shift multiple times in the file.
<span class="nc" id="L416">						Shift shiftAdded = WorkRulesModelHandler.createShift(m_context, shift);</span>
<span class="nc" id="L417">						shiftsCreated++;</span>
<span class="nc" id="L418">						shiftsNameIDMap.put(shift.getName(), shiftAdded.getID());</span>
<span class="nc" id="L419">					}</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">				} else if (!isNew</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">						&amp;&amp; (m_importBehavior.compareTo(IMPORT_BEHAVIOR_ADD_UPDATE) == 0 || m_importBehavior</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">						.compareTo(IMPORT_BEHAVIOR_UPDATE_ONLY) == 0)) {</span>
					// See if the shift was already added, only update the last
					// shift encountered if duplicates exist.
<span class="nc" id="L425">					Iterator&lt;Shift&gt; iter = shiftsToUpdate.iterator();</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">					if (iter != null) {</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">						while (iter.hasNext()) {</span>
<span class="nc" id="L428">							Shift s = iter.next();</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">							if (s.getName().compareToIgnoreCase(shift.getName()) == 0) {</span>
<span class="nc" id="L430">								iter.remove(); // remove this copy, there is a</span>
								// later entry for this shift in
								// the file.
							}
<span class="nc" id="L434">						}</span>
					}
<span class="nc" id="L436">					shiftsToUpdate.add(shift);</span>
<span class="nc" id="L437">				}</span>
			} else {
<span class="nc" id="L439">				shiftsSkipped++;</span>
			}
<span class="nc" id="L441">		}</span>

<span class="nc bnc" id="L443" title="All 2 branches missed.">		if (m_importBehavior.compareTo(IMPORT_BEHAVIOR_ADD_UPDATE) == 0</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">				|| m_importBehavior.compareTo(IMPORT_BEHAVIOR_UPDATE_ONLY) == 0) {</span>
<span class="nc" id="L445">			WorkRulesModelHandler.updateShifts(m_context, shiftsToUpdate);</span>
		}

<span class="nc bnc" id="L448" title="All 2 branches missed.">		if (m_importStatusMessages.size() &gt; 0) {</span>
<span class="nc" id="L449">			addPageMessage(new Message(Message.WARNING_TYPE, FsWebBundleKey.FS_IMPORT_FAILURE_MESSAGE,</span>
					FsWebBundleKey.BUNDLE_NAME, new String[]{
<span class="nc" id="L451">					String.valueOf(i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFT)),</span>
<span class="nc" id="L452">					String.valueOf(shiftsCreated), String.valueOf(shiftsToUpdate.size()),</span>
<span class="nc" id="L453">					String.valueOf(shiftsSkipped)}));</span>
		} else {
<span class="nc" id="L455">			addPageMessage(new Message(Message.INFO_TYPE, FsWebBundleKey.FS_IMPORT_SUCCESS_MESSAGE,</span>
					FsWebBundleKey.BUNDLE_NAME, new String[]{
<span class="nc" id="L457">					String.valueOf(i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFT)),</span>
<span class="nc" id="L458">					String.valueOf(shiftsCreated), String.valueOf(shiftsToUpdate.size())}));</span>
		}
<span class="nc bnc" id="L460" title="All 2 branches missed.">		if (success) {</span>
<span class="nc" id="L461">			setPageAction(SUCCESS);</span>
		}
<span class="nc" id="L463">	}</span>

	private Collection&lt;TimeOfDay&gt; parseStartTimes(String startTimeDisplay) throws Exception {
<span class="nc" id="L466">		String[] timeDefinitions = startTimeDisplay.split(&quot;, &quot;, -1);</span>
<span class="nc" id="L467">		ArrayList&lt;TimeOfDay&gt; times = new ArrayList&lt;TimeOfDay&gt;();</span>

<span class="nc" id="L469">		Date effectiveDate = this.m_timeZoneEffectiveDate;</span>
<span class="nc" id="L470">		TimeZone optTargetTimeZone = this.m_optimizationTargetTimezone;</span>

<span class="nc" id="L472">		int timeZoneOffset = TimeZoneOverrideUtil.getTimeZoneOffset(m_context, optTargetTimeZone, effectiveDate);</span>

<span class="nc bnc" id="L474" title="All 2 branches missed.">		for (String timeDefinition : timeDefinitions) {</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">			if (timeDefinition.contains(StartTimes.RANGE_DELIMMITER)) {</span>
				// It is a time range like 9:00 AM - 1:00 PM or 9:00 - 24:00 or
				// any other regional format.
<span class="nc" id="L478">				String[] timeRange = timeDefinition.split(StartTimes.RANGE_DELIMMITER);</span>

<span class="nc" id="L480">				Date startEntry = m_localizer.parseTime(timeRange[0], RegionalFormatBundleKey.TIME_FORMAT);</span>
<span class="nc" id="L481">				Date endEntry = m_localizer.parseTime(timeRange[1], RegionalFormatBundleKey.TIME_FORMAT);</span>

<span class="nc bnc" id="L483" title="All 2 branches missed.">				if (startEntry.after(endEntry)) {</span>
<span class="nc" id="L484">					throw new ParseException(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.TIME_RANGE_INVALID,</span>
							timeDefinition), 0);
				}
<span class="nc bnc" id="L487" title="All 2 branches missed.">				while (startEntry.compareTo(endEntry) &lt;= 0) {</span>
<span class="nc" id="L488">					Calendar c = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L489">					c.setTime(startEntry);</span>

<span class="nc" id="L491">					int hour = c.get(Calendar.HOUR_OF_DAY);</span>
					// Adjust to target.
<span class="nc" id="L493">					int minutes = c.get(Calendar.MINUTE) - timeZoneOffset;</span>
<span class="nc" id="L494">					times.add(new TimeOfDay(hour, minutes));</span>
					// Advance to the adjacent offset.
<span class="nc" id="L496">					c.add(Calendar.MINUTE, StartTimes.ADJACENT_OFFSET);</span>
<span class="nc" id="L497">					startEntry = c.getTime();</span>
<span class="nc" id="L498">				}</span>

<span class="nc" id="L500">			} else {</span>
				// It is a specific time like 9:45 AM
<span class="nc" id="L502">				Date timeEntry = m_localizer.parseTime(timeDefinition, RegionalFormatBundleKey.TIME_FORMAT);</span>
<span class="nc" id="L503">				Calendar c = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L504">				c.setTime(timeEntry);</span>

<span class="nc" id="L506">				int hour = c.get(Calendar.HOUR_OF_DAY);</span>
				// Adjust to target.
<span class="nc" id="L508">				int minutes = c.get(Calendar.MINUTE) - timeZoneOffset;</span>
<span class="nc" id="L509">				times.add(new TimeOfDay(hour, minutes));</span>
			}
		}

<span class="nc" id="L513">		return times;</span>
	}

	/**
	 * Return URL for HTML Form Action
	 */
	@Override
	public String getFormAction() {
<span class="nc" id="L521">		return FORM_ACTION;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>