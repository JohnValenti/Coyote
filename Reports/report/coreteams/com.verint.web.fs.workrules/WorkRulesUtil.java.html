<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WorkRulesUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules</a> &gt; <span class="el_source">WorkRulesUtil.java</span></div><h1>WorkRulesUtil.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern.StartTime;
import com.bluepumpkin.ejb.core.CoreEJBCreateException;
import com.bluepumpkin.ejb.core.CoreManagerFactory;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.witness.ejb.core.licensing.LicenseKeys;
import com.witness.web.uif.Log;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.TimeZoneOverrideUtil;

import java.rmi.RemoteException;
import java.util.Date;
import java.util.Map;
import java.util.TimeZone;

<span class="nc" id="L24">public class WorkRulesUtil {</span>

<span class="fc" id="L26">	private static Category log = Log.initCategory(WorkRulesUtil.class.getName());</span>
<span class="fc" id="L27">	private static boolean areMonthlyWorkRulesLicensed = false;</span>

	static {
		try {
			// Determine whether we have the monthly forecast and rules license.
			// If this license is not present, we
			// will not show the work pattern type dropdown.
<span class="fc" id="L34">			areMonthlyWorkRulesLicensed = CoreManagerFactory.getLicenseManager().isLicensed(</span>
					LicenseKeys.APP_MONTHLY_FORECAST_AND_RULES);
<span class="nc" id="L36">		} catch (RemoteException ex) {</span>
<span class="nc" id="L37">			log.error(&quot;Error retrieving monthly rule license in WorkRulesUtil&quot;, ex);</span>
<span class="nc" id="L38">		} catch (CoreEJBCreateException ex) {</span>
<span class="nc" id="L39">			log.error(&quot;Error retrieving monthly rule license in WorkRulesUtil&quot;, ex);</span>
<span class="pc" id="L40">		}</span>
<span class="fc" id="L41">	}</span>

	public static String getVTOEventStartTimeText(Localizer localizer, ShiftPattern.StartTime vtoEventStartTime) {
<span class="pc bnc" id="L44" title="All 4 branches missed.">		switch (vtoEventStartTime) {</span>
			case StartOfShift:
<span class="nc" id="L46">				return localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_VTO_EVENT_START_OF_SHIFT);</span>
			case EndOfShift:
<span class="nc" id="L48">				return localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_VTO_EVENT_END_OF_SHIFT);</span>
			case StartOrEndOfShift:
<span class="nc" id="L50">				return localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_VTO_EVENT_BEFORE_OR_AFTER);</span>
			default:
<span class="nc" id="L52">				return &quot;&quot;;</span>
		}
	}

	/**
	 * Returns the start time enumeration value for the given localized text
	 *
	 * @param localizer         {@link com.bluepumpkin.common.localization.Localizer
	 *                          Localizer}
	 * @param vtoEventStartTime
	 * @return {@link com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern.StartTime
	 * ShiftPattern.StartTime}
	 * @see com.bluepumpkin.common.localization.Localizer
	 * @see com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern.StartTime
	 */
	public static ShiftPattern.StartTime parseVTOEventStartTimeText(Localizer localizer, String vtoEventStartTime) {
<span class="nc bnc" id="L68" title="All 2 branches missed.">		if (vtoEventStartTime.compareToIgnoreCase(localizer.i18n(FsWebBundleKey.BUNDLE_NAME,</span>
				FsWebBundleKey.FS_VTO_EVENT_START_OF_SHIFT)) == 0) {
<span class="nc" id="L70">			return StartTime.StartOfShift;</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">		} else if (vtoEventStartTime.compareToIgnoreCase(localizer.i18n(FsWebBundleKey.BUNDLE_NAME,</span>
				FsWebBundleKey.FS_VTO_EVENT_END_OF_SHIFT)) == 0) {
<span class="nc" id="L73">			return StartTime.EndOfShift;</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">		} else if (vtoEventStartTime.compareToIgnoreCase(localizer.i18n(FsWebBundleKey.BUNDLE_NAME,</span>
				FsWebBundleKey.FS_VTO_EVENT_BEFORE_OR_AFTER)) == 0) {
<span class="nc" id="L76">			return StartTime.StartOrEndOfShift;</span>
		} else {
<span class="nc" id="L78">			return null;</span>
		}
	}

	public static String getOTExtensionStartTimeText(Localizer localizer, ShiftPattern.StartTime otExtensionStartTime) {
<span class="pc bpc" id="L83" title="1 of 4 branches missed.">		switch (otExtensionStartTime) {</span>
			case StartOfShift:
<span class="fc" id="L85">				return localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_OT_EXT_BEFORE_SHIFT);</span>
			case EndOfShift:
<span class="fc" id="L87">				return localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_OT_EXT_AFTER_SHIFT);</span>
			case StartOrEndOfShift:
<span class="fc" id="L89">				return localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.FS_OT_EXT_BEFORE_OR_AFTER);</span>
			default:
<span class="nc" id="L91">				return &quot;&quot;;</span>
		}
	}

	/**
	 * Returns the start time enumeration value for the given localized text
	 *
	 * @param localizer         {@link com.bluepumpkin.common.localization.Localizer
	 *                          Localizer}
	 * @param vtoEventStartTime
	 * @return {@link com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern.StartTime
	 * ShiftPattern.StartTime}
	 * @see com.bluepumpkin.common.localization.Localizer
	 * @see com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern.StartTime
	 */
	public static ShiftPattern.StartTime parseOTExtensionStartTimeText(Localizer localizer, String otExtensionStartTime) {
<span class="nc bnc" id="L107" title="All 2 branches missed.">		if (otExtensionStartTime.compareToIgnoreCase(localizer.i18n(FsWebBundleKey.BUNDLE_NAME,</span>
				FsWebBundleKey.FS_OT_EXT_BEFORE_SHIFT)) == 0) {
<span class="nc" id="L109">			return StartTime.StartOfShift;</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">		} else if (otExtensionStartTime.compareToIgnoreCase(localizer.i18n(FsWebBundleKey.BUNDLE_NAME,</span>
				FsWebBundleKey.FS_OT_EXT_AFTER_SHIFT)) == 0) {
<span class="nc" id="L112">			return StartTime.EndOfShift;</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">		} else if (otExtensionStartTime.compareToIgnoreCase(localizer.i18n(FsWebBundleKey.BUNDLE_NAME,</span>
				FsWebBundleKey.FS_OT_EXT_BEFORE_OR_AFTER)) == 0) {
<span class="nc" id="L115">			return StartTime.StartOrEndOfShift;</span>
		} else {
<span class="nc" id="L117">			return null;</span>
		}
	}

	public static String getStartTimeText(Localizer localizer, ShiftPattern.StartTime startTime, boolean isWithinShift) {
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">		if (isWithinShift) {</span>
<span class="nc" id="L123">			return getVTOEventStartTimeText(localizer, startTime);</span>
		} else {
<span class="fc" id="L125">			return getOTExtensionStartTimeText(localizer, startTime);</span>
		}
	}

	public static boolean areMonthlyWorkRulesLicensed() {
<span class="fc" id="L130">		return areMonthlyWorkRulesLicensed;</span>
	}

	/**
	 * Returns the week start day (as an integer) for an organization or campaign.
	 * If the organization is non-null, the org week start will be returned.  Otherwise,
	 * the campaign week start is returned.  If both are null, 1 is returned.
	 * &lt;p&gt;
	 * 1 = Sunday, 7=Saturday
	 *
	 * @param organization
	 * @param campaign
	 * @return
	 */
	public static int getWeekStartDate(Organization organization, Campaign campaign) {
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">		if (organization != null) {</span>
<span class="fc" id="L146">			return (int) organization.getWeekStartDate();</span>
		}
<span class="nc bnc" id="L148" title="All 2 branches missed.">		if (campaign != null) {</span>
<span class="nc" id="L149">			return campaign.getWeekStart() / 1440 + 1;</span>
		}
<span class="nc" id="L151">		return 1;</span>
	}

	/**
	 * Returns the start of week for the given work pattern.  This corresponds to the start of week of its owner, which
	 * is either an org or a campaign depending on where the work pattern was created.
	 */
	public static int getStartDayOfWeekOfWorkPatternOwner(ShiftPattern sp, Map&lt;ID, Organization&gt; orgMap, Map&lt;ID, Campaign&gt; campaignMap) {
<span class="fc" id="L159">		Organization organization = null;</span>
<span class="fc" id="L160">		Campaign campaign = null;</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">		if (orgMap != null) {</span>
<span class="fc" id="L162">			organization = orgMap.get(sp.getOrganizationID());</span>
		}
<span class="fc bfc" id="L164" title="All 2 branches covered.">		if (campaignMap != null) {</span>
<span class="fc" id="L165">			campaign = campaignMap.get(sp.getCampaignID());</span>
		}
<span class="fc" id="L167">		return WorkRulesUtil.getWeekStartDate(organization, campaign);</span>
	}

	/**
	 * Returns JavaScript that is used by some of the Work Rules Form pages when
	 * adding/linking a child component to the work rule (for example, when
	 * linking a Shift Event to a Shift). This javascript is used when the add
	 * button is clicked, and it gathers and sends a list of already selected
	 * child items to the popup window so that the items that have already been
	 * added will not be displayed again.
	 */
	public static String getAddButtonIdFilterJavaScript(String componentName, String selectedIdListName,
			String toolbarName, String popupEventName) {
<span class="fc" id="L180">		StringBuffer sb = new StringBuffer();</span>
<span class="fc" id="L181">		sb.append(&quot;var idList=[]; &quot;);</span>
<span class="fc" id="L182">		sb.append(&quot;var allRowIDs=jQuery('#&quot;).append(componentName).append(&quot;').val().split(','); &quot;);</span>
<span class="fc" id="L183">		sb.append(&quot;for (var i = 0; i &lt; allRowIDs.length; i++) { &quot;);</span>
<span class="fc" id="L184">		sb.append(&quot;var nonMultiRow = jQuery('[uid=' + allRowIDs[i] +'][multiEditNotCommon!=true]');&quot;);</span>
<span class="fc" id="L185">		sb.append(&quot;if (nonMultiRow &amp;&amp; nonMultiRow.length &gt; 0) { &quot;); // multiEditNotCommon!=true</span>
		// will
		// include
		// ids for
		// rows that
		// are
		// common to
		// all and
		// also rows
		// that have
		// been
		// added
		// without a
		// postback
<span class="fc" id="L199">		sb.append(&quot;idList[idList.length]=nonMultiRow.attr('uid'); &quot;);</span>
<span class="fc" id="L200">		sb.append(&quot;} &quot;);</span>
<span class="fc" id="L201">		sb.append(&quot;} &quot;);</span>
<span class="fc" id="L202">		sb.append(&quot;jQuery(this).attr('&quot;).append(selectedIdListName).append(&quot;', idList.join(',')); &quot;);</span>
<span class="fc" id="L203">		sb.append(toolbarName).append(&quot;.onSelect('&quot;).append(popupEventName).append(&quot;', this);&quot;);</span>
<span class="fc" id="L204">		return sb.toString();</span>
	}

	/**
	 * The Find functionality will find all names with the word typed occurs
	 * anywhere in the name. In SQL statement, the syntax will be LIKE '%word%'.
	 * However, SQL have some wildcard characters So this method is used to
	 * replaced some wildcard characters. [], [^] : Any single character
	 * within/not within the specified range ([a-f]) or set ([abcdef]).
	 * =&gt;replace the [ by [[] %:AnyString of zero or more charaters=&gt; replaced
	 * by [%] _(underscore) : Any single character ==&gt; replaced by [_]
	 */
	public static String getTextToFind(String textFind) {
<span class="fc" id="L217">		String textReplaced = textFind;</span>
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">		if (textFind != null) {</span>
			// Must handle the [ in [] first
<span class="nc" id="L220">			int lastOpenIndex = textFind.lastIndexOf(&quot;[&quot;);</span>
<span class="nc" id="L221">			int firstCloseIndex = textFind.indexOf(&quot;]&quot;);</span>
<span class="nc bnc" id="L222" title="All 6 branches missed.">			if (lastOpenIndex &gt; -1 &amp;&amp; firstCloseIndex &gt; -1 &amp;&amp; lastOpenIndex + 1 &lt; firstCloseIndex) {</span>
<span class="nc" id="L223">				String firstPart = textFind.substring(0, lastOpenIndex);</span>
<span class="nc" id="L224">				String replacepart = textFind.substring(lastOpenIndex + 1, firstCloseIndex);</span>
<span class="nc" id="L225">				String lastPart = textFind.substring(firstCloseIndex);</span>
<span class="nc" id="L226">				textFind = firstPart.concat(&quot;[[]&quot;).concat(replacepart).concat(lastPart);</span>
			}
			// Then handle % and _
<span class="nc" id="L229">			textReplaced = textFind.replaceAll(&quot;%&quot;, &quot;[%]&quot;);</span>
<span class="nc" id="L230">			textReplaced = textReplaced.replaceAll(&quot;_&quot;, &quot;[_]&quot;);</span>
		}
<span class="fc" id="L232">		return textReplaced;</span>
	}

	/**
	 * Calculates the total timezone offset for a work rule so that the times associated with that rule
	 * can be displayed appropriately given the current viewing time context.  A work rule's start time is
	 * set relative to the work rule's owner's timezone.  For example: if a shift is set to have a start time
	 * at 8AM and linked to an org at PST, that means the start time is 8AM PST.  If a child organization is EST,
	 * then that start time for the shift will be displayed as 11AM EST (assuming the timezone toggle is set to current org
	 * and not the user's view time zone preference).
	 * &lt;p&gt;
	 * This method will calculate the timezone offset between the work rule owner and the currently selected org/campaign,
	 * as well as the timezone offset between the currently selected org/campaign and the user's viewing timezone in order
	 * to determine the total offset needed for display purposes.
	 *
	 * @param context                    - used to retrieve the user's viewing time zone if applicable
	 * @param optimizationTargetTimeZone - The time zone of the currently selected organization or campaign
	 * @param workRuleTimeZone           - The time zone of the work rule's owner (org or campaign)
	 * @param timeZoneEffectiveDate      - The date used as a reference point to compare the offsets between different timezones.
	 *                                   Usually just the current date.
	 * @return The sum of the timezone offsets between the work rule's owner's timezone and the user's current view timezone.
	 */
	public static int getTotalTimeZoneOffsetForWorkRuleDisplay(RequestContext context,
			TimeZone optimizationTargetTimeZone, TimeZone workRuleTimeZone, Date timeZoneEffectiveDate) {
<span class="fc" id="L256">		int viewingTimeZoneOffset = TimeZoneOverrideUtil.getTimeZoneOffset(context, optimizationTargetTimeZone,</span>
				timeZoneEffectiveDate);
<span class="fc" id="L258">		int shiftStartTimeZoneOffset = getTimeZoneOffsetForWorkRuleOwner(workRuleTimeZone,</span>
				optimizationTargetTimeZone, timeZoneEffectiveDate);
<span class="fc" id="L260">		return viewingTimeZoneOffset + shiftStartTimeZoneOffset;</span>
	}

	/**
	 * Calculates the timezone offset between the work rule's owner and the currently selected org/campaign (known
	 * as the optimization target).
	 */
	private static int getTimeZoneOffsetForWorkRuleOwner(TimeZone workRuleTimeZone,
			TimeZone optimizationTargetTimeZone, Date date) {
<span class="fc" id="L269">		long dateLong = date.getTime();</span>
<span class="fc" id="L270">		return (optimizationTargetTimeZone.getOffset(dateLong) - workRuleTimeZone.getOffset(dateLong)) / (60 * 1000);</span>
	}

	/**
	 * A small utility method which returns the string form of the given object, with escaped characters making
	 * it safe to be used on an HTML page.  Returns &quot;&quot; if v is null.
	 */
	public static String getEscapedStringRepresentation(Object v) {
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">		return v == null ? &quot;&quot; : HtmlUtil.escapeAttributeValue(v.toString());</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>