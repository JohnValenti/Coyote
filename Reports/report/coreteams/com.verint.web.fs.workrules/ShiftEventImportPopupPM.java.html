<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftEventImportPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules</a> &gt; <span class="el_source">ShiftEventImportPopupPM.java</span></div><h1>ShiftEventImportPopupPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules;

import com.bluepumpkin.common.datatypes.Duration;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignOrg;
import com.bluepumpkin.ejb.bbm.campaign.model.SchedulingPeriod;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftEvent;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.shift.ShiftUtil;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.data.DataSet;
import com.witness.web.uif.data.DataTable;
import com.witness.web.uif.data.DataTableRow;
import com.witness.web.uif.system.RequestContext;

import java.util.*;

public class ShiftEventImportPopupPM extends WorkRulesImportPopupPM {
	private static final long serialVersionUID = 1L;

	public static final String FORM_ACTION = &quot;shift_event_import&quot;;

	private final static String SHIFT_EVENT_FN = &quot;SHIFT_EVENT_FN&quot;;
	private final static String ACTIVITY_FN = &quot;ACTIVITY_FN&quot;;
	private final static String LENGTH_FN = &quot;LENGTH_FN&quot;;
	private final static String START_TIME_TYPE_FN = &quot;START_TIME_TYPE_FN&quot;;
	private final static String START_WINDOW_FN = &quot;START_WINDOW_FN&quot;;
	private final static String EVENT_PAID_FN = &quot;EVENT_PAID_FN&quot;;
	private final static String FLEXIBLE_FN = &quot;FLEXIBLE_FN&quot;;
	private final static String MIN_COUNT_FN = &quot;MIN_COUNT_FN&quot;;
	private final static String MAX_COUNT_FN = &quot;MAX_COUNT_FN&quot;;
	private final static String ADDITIONAL_ACTIVITIES_FN = &quot;ADDITIONAL_ACTIVITIES_FN&quot;;
	private final static String ORGANIZATION_FN = &quot;ORGANIZATION_FN&quot;;
	private final static String DESCRIPTION_FN = &quot;DESCRIPTION_FN&quot;;

	private Map&lt;ID, Organization&gt; m_organizationMap;
	private Map&lt;ID, Campaign&gt; m_campaignMap;

	public ShiftEventImportPopupPM(RequestContext context) {
<span class="nc" id="L47">		super(context);</span>

<span class="nc" id="L49">		setIsCommaDelimiterEnabled(false);</span>
<span class="nc" id="L50">		setNumberOfLinesToIgnore(1);</span>
<span class="nc" id="L51">	}</span>

	public static ShiftEventImportPopupPM getInstance(RequestContext context) {
<span class="nc" id="L54">		return (ShiftEventImportPopupPM) getInstance(context, ShiftEventImportPopupPM.class);</span>
	}

	@Override
	protected void initializeFieldInfo() {
<span class="nc" id="L59">		m_fsResourceBundle = m_localizer.getBundle(FsWebBundleKey.BUNDLE_NAME);</span>

<span class="nc" id="L61">		ArrayList&lt;FieldInfo&gt; fieldDefinitions = new ArrayList&lt;FieldInfo&gt;();</span>
<span class="nc" id="L62">		fieldDefinitions.add(new FieldInfo(SHIFT_EVENT_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFT_EVENT), true, true, false));</span>
<span class="nc" id="L63">		fieldDefinitions.add(new FieldInfo(ACTIVITY_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_ACTIVITY), true, true, false));</span>
<span class="nc" id="L64">		fieldDefinitions.add(new FieldInfo(LENGTH_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_LENGTH), true, true, false));</span>
<span class="nc" id="L65">		fieldDefinitions.add(new FieldInfo(START_TIME_TYPE_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_START_TIME_TYPE), false, true, true));</span>
<span class="nc" id="L66">		fieldDefinitions.add(new FieldInfo(START_WINDOW_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_START_WINDOW), false, true, true));</span>
<span class="nc" id="L67">		fieldDefinitions.add(new FieldInfo(EVENT_PAID_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_EVENT_PAID), false, true, true));</span>
<span class="nc" id="L68">		fieldDefinitions.add(new FieldInfo(FLEXIBLE_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_FLEXIBLE), false, true, true));</span>
<span class="nc" id="L69">		fieldDefinitions.add(new FieldInfo(MIN_COUNT_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_MIN_COUNT), false, true, true));</span>
<span class="nc" id="L70">		fieldDefinitions.add(new FieldInfo(MAX_COUNT_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_MAX_COUNT), false, true, true));</span>
<span class="nc" id="L71">		fieldDefinitions.add(new FieldInfo(ADDITIONAL_ACTIVITIES_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_ADDITIONAL_ACTIVITIES), false, true, false));</span>
<span class="nc" id="L72">		fieldDefinitions.add(new FieldInfo(ORGANIZATION_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_ORGANIZATION), true, true, false));</span>
<span class="nc" id="L73">		fieldDefinitions.add(new FieldInfo(DESCRIPTION_FN, i18n(m_fsResourceBundle, FsWebBundleKey.FS_DESCRIPTION), false, true, true));</span>

		// Not defining a table because this is the only one.
<span class="nc" id="L76">		addTableFieldInfo(fieldDefinitions);</span>
<span class="nc" id="L77">	}</span>

	@Override
	protected void parseImport(DataSet dataSet) throws Exception {
<span class="nc" id="L81">		boolean success = true;</span>
<span class="nc" id="L82">		DataTable table = dataSet.getDefaultTable();</span>

<span class="nc" id="L84">		Map&lt;String, ShiftEvent&gt; shiftEventsMap = new HashMap&lt;String, ShiftEvent&gt;();</span>
<span class="nc" id="L85">		Collection&lt;ID&gt; orgIds = new ArrayList&lt;ID&gt;();</span>

<span class="nc" id="L87">		m_organizationMap = new HashMap&lt;ID, Organization&gt;();</span>
<span class="nc" id="L88">		m_campaignMap = new HashMap&lt;ID, Campaign&gt;();</span>


<span class="nc" id="L91">		Collection&lt;String&gt; reservedNames = new ArrayList&lt;String&gt;();</span>
		try {
<span class="nc bnc" id="L93" title="All 2 branches missed.">			if (m_isByOrganization) {</span>
<span class="nc" id="L94">				shiftEventsMap = WorkRulesModelHandler.getShiftEventsByOrg(m_context, new ID(m_organizationId));</span>
<span class="nc" id="L95">				orgIds.add(new ID(this.m_organizationId));</span>
<span class="nc" id="L96">				m_organizationMap = WorkRulesModelHandler.getOrgs(m_context, orgIds);</span>
			} else {
<span class="nc" id="L98">				SchedulingPeriod sp = CampaignModelHandler.getSchedulingPeriodByID(m_context, new ID(m_schedulingPeriodId));</span>

<span class="nc" id="L100">				Collection&lt;CampaignOrg&gt; orgAssigned = CampaignModelHandler.getCampaignOrgAssignments(m_context, new ID(m_campaignId), sp.getStartTime(), sp.getEndTime());</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">				for (CampaignOrg co : orgAssigned) {</span>
<span class="nc" id="L102">					orgIds.add(co.getOrganizationID());</span>
<span class="nc" id="L103">				}</span>

<span class="nc" id="L105">				Collection&lt;ShiftEvent&gt; existingShiftEvents = WorkRulesModelHandler.getShiftEventsBySchedulingPeriod(m_context, sp.getID());</span>
<span class="nc" id="L106">				Collection&lt;ShiftEvent&gt; shiftEvents = WorkRulesModelHandler.getShiftEventsBySchedulingPeriodCampaignOnly(m_context, sp.getID());</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">				for (ShiftEvent se : shiftEvents) {</span>
<span class="nc" id="L108">					shiftEventsMap.put(se.getName(), se);</span>
<span class="nc" id="L109">				}</span>

<span class="nc bnc" id="L111" title="All 2 branches missed.">				for (ShiftEvent se : existingShiftEvents) {</span>
<span class="nc" id="L112">					reservedNames.add(se.getName());</span>
<span class="nc" id="L113">				}</span>

<span class="nc" id="L115">				Collection&lt;ID&gt; campaignIds = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L116">				campaignIds.add(sp.getCampaignID());</span>

<span class="nc" id="L118">				m_campaignMap = WorkRulesModelHandler.getCampaigns(m_context, campaignIds);</span>
			}
<span class="nc" id="L120">		} catch (Exception ex) {</span>
<span class="nc" id="L121">			log.error(ex);</span>
<span class="nc" id="L122">			addPageMessage(Message.ERROR_TYPE, &quot;Error: &quot; + ex.getMessage());</span>
<span class="nc" id="L123">		}</span>

		// Get Activities that are viable for the current selection.
<span class="nc" id="L126">		Collection&lt;Activity&gt; activities = ActivityModelHandler.getActivitiesByActivitySelectionType(getRequestContext(), ActivityModelHandler.ActivitySelectionProperty.UsedInShiftEvent, orgIds);</span>
<span class="nc" id="L127">		Map&lt;String, ID&gt; activityNameIDMap = new HashMap&lt;String, ID&gt;();</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">		for (Activity activity : activities) {</span>
<span class="nc" id="L129">			activityNameIDMap.put(activity.getName(), activity.getID());</span>
<span class="nc" id="L130">		}</span>

<span class="nc" id="L132">		Map&lt;String, Activity&gt; activityByNameMap = new HashMap&lt;String, Activity&gt;();</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">		for (Activity activity : activities) {</span>
<span class="nc" id="L134">			activityByNameMap.put(activity.getName(), activity);</span>
<span class="nc" id="L135">		}</span>

		// Populate a map with reverse look up of name instead of ID.
<span class="nc" id="L138">		Map&lt;String, ID&gt; orgsNameIDMap = new HashMap&lt;String, ID&gt;();</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">		for (ID key : m_organizationMap.keySet()) {</span>
<span class="nc" id="L140">			orgsNameIDMap.put(m_organizationMap.get(key).getName(), key);</span>
<span class="nc" id="L141">		}</span>

<span class="nc" id="L143">		Collection&lt;ShiftEvent&gt; shiftEventsToUpdate = new ArrayList&lt;ShiftEvent&gt;();</span>
<span class="nc" id="L144">		int shiftEventsCreated = 0;</span>
<span class="nc" id="L145">		int shiftEventsSkipped = 0;</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">		for (DataTableRow row : table.getRows()) {</span>
<span class="nc" id="L147">			boolean hasErrors = false;</span>
<span class="nc" id="L148">			boolean isNew = true;</span>

<span class="nc" id="L150">			Object shiftEventName = null;</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">			if (isChecked(SHIFT_EVENT_FN)) { // REQUIRED</span>
<span class="nc" id="L152">				shiftEventName = row.get(SHIFT_EVENT_FN);</span>
			}

<span class="nc" id="L155">			ShiftEvent shiftEvent = null;</span>

<span class="nc bnc" id="L157" title="All 2 branches missed.">			if (shiftEventName != null) {</span>
				// Identify the shift to work with.
<span class="nc" id="L159">				shiftEvent = shiftEventsMap.get(shiftEventName);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">				if (shiftEvent != null) {</span>
<span class="nc" id="L161">					isNew = false;</span>
				}
			}

			// If not shift is found, create a new shift.
<span class="nc bnc" id="L166" title="All 2 branches missed.">			if (shiftEvent == null) {</span>
				// We now need to check if the name conflicts with
				// any shift visible by this sp or org, not just the updatable ones.
<span class="nc bnc" id="L169" title="All 2 branches missed.">				if (reservedNames.contains(shiftEventName.toString())) {</span>
<span class="nc" id="L170">					addImportStatusMessage(</span>
<span class="nc" id="L171">							m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFT_EVENT_IMPORT_NAME_IN_USE,</span>
<span class="nc" id="L172">									new Object[]{shiftEventName.toString()}));</span>
<span class="nc" id="L173">					hasErrors = true;</span>
				}

<span class="nc" id="L176">				shiftEvent = new ShiftEvent();</span>
<span class="nc" id="L177">				shiftEvent.setName(shiftEventName.toString());</span>
<span class="nc" id="L178">				isNew = true;</span>
			}

			// Activities (REQUIRED)
<span class="nc bnc" id="L182" title="All 2 branches missed.">			if (isChecked(ACTIVITY_FN)) { // REQUIRED</span>
<span class="nc" id="L183">				Object shiftActivity = row.get(ACTIVITY_FN);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">				if (activityNameIDMap.containsKey(shiftActivity)) {</span>
<span class="nc" id="L185">					shiftEvent.setActivityID(activityNameIDMap.get(shiftActivity));</span>
				} else {
<span class="nc" id="L187">					addImportStatusMessage(</span>
<span class="nc" id="L188">							m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_ACTIVITY,</span>
									new Object[]{shiftEventName, shiftActivity}));
<span class="nc" id="L190">					hasErrors = true;</span>
				}
			}

			// Length (default = 5 minutes)
<span class="nc bnc" id="L195" title="All 2 branches missed.">			if (isChecked(LENGTH_FN)) {</span>
<span class="nc" id="L196">				Object shiftEventLength = row.get(LENGTH_FN);</span>
				try {
<span class="nc" id="L198">					shiftEvent.setDuration(Duration.fromMinutes(parseDurationMinutesFromHHMM(shiftEventLength.toString())));</span>
<span class="nc" id="L199">				} catch (Exception ex) {</span>
<span class="nc" id="L200">					addImportStatusMessage(</span>
<span class="nc" id="L201">							m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_DURATION_FORMAT,</span>
<span class="nc" id="L202">									new Object[]{shiftEventName, String.valueOf(shiftEventLength)}));</span>
<span class="nc" id="L203">					hasErrors = true;</span>
<span class="nc" id="L204">				}</span>
<span class="nc" id="L205">			} else {</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">				if (isNew) {</span>
<span class="nc" id="L207">					shiftEvent.setDuration(Duration.fromMinutes(5));</span>
				}
			}

			// Start Time Type (default = Relative to Shift Start)
<span class="nc" id="L212">			boolean startTimeTypeHasErrors = false;</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">			if (isChecked(START_TIME_TYPE_FN)) {</span>
<span class="nc" id="L214">				Object shiftStartTimeType = row.get(START_TIME_TYPE_FN);</span>

<span class="nc bnc" id="L216" title="All 2 branches missed.">				if (!shiftStartTimeType.toString().equalsIgnoreCase(i18n(m_fsResourceBundle, FsWebBundleKey.FS_ANY_TIME)) &amp;&amp;</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">						!shiftStartTimeType.toString().equalsIgnoreCase(i18n(m_fsResourceBundle, FsWebBundleKey.FS_RELATIVE_TO_SHIFT_START)) &amp;&amp;</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">						!shiftStartTimeType.toString().equalsIgnoreCase(i18n(m_fsResourceBundle, FsWebBundleKey.FS_ABSOLUTE))) {</span>
<span class="nc" id="L219">					addImportStatusMessage(</span>
<span class="nc" id="L220">							m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_STARTTIME_TYPE,</span>
<span class="nc" id="L221">									new Object[]{shiftEventName, String.valueOf(shiftStartTimeType)}));</span>
<span class="nc" id="L222">					hasErrors = true;</span>
<span class="nc" id="L223">					startTimeTypeHasErrors = true;</span>
				}
<span class="nc" id="L225">				shiftEvent.setIsAnyTime(i18n(m_fsResourceBundle, FsWebBundleKey.FS_ANY_TIME).equalsIgnoreCase(shiftStartTimeType.toString()));</span>
<span class="nc" id="L226">				shiftEvent.setIsCafeteria(i18n(m_fsResourceBundle, FsWebBundleKey.FS_ABSOLUTE).equalsIgnoreCase(shiftStartTimeType.toString()));</span>
			}

			// Earliest Start (default = 00:00)
			// Latest Start (default = 00:00)
			// Start Window
<span class="nc bnc" id="L232" title="All 4 branches missed.">			if (isChecked(START_WINDOW_FN) &amp;&amp; !startTimeTypeHasErrors) {</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">				if (!shiftEvent.isAnyTime()) {</span>
					// TODO: Fix the time parsing to be locale, timezone sensitive.
<span class="nc" id="L235">					Object shiftEventWindow = row.get(START_WINDOW_FN);</span>
<span class="nc" id="L236">					String[] timeRangeTokens = shiftEventWindow.toString().split(&quot;-&quot;, -1); // !Magic String</span>
					try {
<span class="nc bnc" id="L238" title="All 2 branches missed.">						if (shiftEvent.isCafeteria()) { // Absolute</span>
<span class="nc" id="L239">							Date startTime = m_localizer.parseTime(timeRangeTokens[0], RegionalFormatBundleKey.TIME_FORMAT);</span>
<span class="nc" id="L240">							Date endTime = m_localizer.parseTime(timeRangeTokens[1], RegionalFormatBundleKey.TIME_FORMAT);</span>

<span class="nc" id="L242">							Calendar c = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L243">							c.setTime(startTime);</span>
<span class="nc" id="L244">							int hour = c.get(Calendar.HOUR_OF_DAY);</span>
<span class="nc" id="L245">							int minutes = c.get(Calendar.MINUTE);</span>

<span class="nc" id="L247">							shiftEvent.setStart(hour * 60 + minutes);</span>

<span class="nc" id="L249">							c.setTime(endTime);</span>
<span class="nc" id="L250">							hour = c.get(Calendar.HOUR_OF_DAY);</span>
<span class="nc" id="L251">							minutes = c.get(Calendar.MINUTE);</span>

<span class="nc" id="L253">							shiftEvent.setEnd(hour * 60 + minutes);</span>

<span class="nc" id="L255">						} else {  // Relative so the times are military time hh24:mm without AM/PM.</span>
<span class="nc" id="L256">							String[] startTimeTokens = timeRangeTokens[0].trim().split(&quot;:&quot;, -1);</span>
<span class="nc" id="L257">							int hour = Integer.valueOf(startTimeTokens[0]);</span>
<span class="nc" id="L258">							int minutes = Integer.valueOf(startTimeTokens[1]);</span>

<span class="nc" id="L260">							shiftEvent.setStart(hour * 60 + minutes);</span>

<span class="nc" id="L262">							String[] endTimeTokens = timeRangeTokens[1].trim().split(&quot;:&quot;, -1);</span>
<span class="nc" id="L263">							hour = Integer.valueOf(endTimeTokens[0]);</span>
<span class="nc" id="L264">							minutes = Integer.valueOf(endTimeTokens[1]);</span>

<span class="nc" id="L266">							shiftEvent.setEnd(hour * 60 + minutes);</span>
						}
<span class="nc" id="L268">					} catch (Exception ex) {</span>
<span class="nc" id="L269">						addImportStatusMessage(</span>
<span class="nc" id="L270">								m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_INVALID_SHIFTEVENT_WINDOW_FORMAT,</span>
<span class="nc" id="L271">										new Object[]{shiftEventName, String.valueOf(shiftEventWindow)}));</span>
<span class="nc" id="L272">						hasErrors = true;</span>
<span class="nc" id="L273">					}</span>
				}
			}

			// Is Paid (default = false)
<span class="nc bnc" id="L278" title="All 2 branches missed.">			if (isChecked(EVENT_PAID_FN)) {</span>
<span class="nc" id="L279">				Object shiftEventIsPaid = row.get(EVENT_PAID_FN);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">				if (shiftEventIsPaid.toString().equalsIgnoreCase(i18n(m_fsResourceBundle, FsWebBundleKey.FS_YES))) {</span>
<span class="nc" id="L281">					shiftEvent.setIsPaid(true);</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">				} else if (shiftEventIsPaid.toString().equalsIgnoreCase(i18n(m_fsResourceBundle, FsWebBundleKey.FS_NO))) {</span>
<span class="nc" id="L283">					shiftEvent.setIsPaid(false);</span>
				} else {
<span class="nc" id="L285">					addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_ISPAID_FORMAT,</span>
<span class="nc" id="L286">							new Object[]{shiftEventName, String.valueOf(shiftEventIsPaid)}));</span>
<span class="nc" id="L287">					hasErrors = true;</span>
				}
			}
			// Is Flexible (default = false)
<span class="nc bnc" id="L291" title="All 2 branches missed.">			if (isChecked(FLEXIBLE_FN)) {</span>
<span class="nc" id="L292">				Object shiftEventIsFlexible = row.get(FLEXIBLE_FN);</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">				if (shiftEventIsFlexible.toString().equalsIgnoreCase(i18n(m_fsResourceBundle, FsWebBundleKey.FS_YES))) {</span>
<span class="nc" id="L294">					shiftEvent.setIsFlexible(true);</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">				} else if (shiftEventIsFlexible.toString().equalsIgnoreCase(i18n(m_fsResourceBundle, FsWebBundleKey.FS_NO))) {</span>
<span class="nc" id="L296">					shiftEvent.setIsFlexible(false);</span>
				} else {
<span class="nc" id="L298">					addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_ISFLEXIBLE_FORMAT,</span>
<span class="nc" id="L299">							new Object[]{shiftEventName, String.valueOf(shiftEventIsFlexible)}));</span>
<span class="nc" id="L300">					hasErrors = true;</span>
				}
			}

<span class="nc bnc" id="L304" title="All 4 branches missed.">			if (shiftEvent.isPaid() &amp;&amp; shiftEvent.isFlexible()) {</span>
				// Min Count (default = 0)
<span class="nc bnc" id="L306" title="All 2 branches missed.">				if (isChecked(MIN_COUNT_FN)) {</span>
<span class="nc" id="L307">					Object minCount = row.get(MIN_COUNT_FN);</span>
					try {
<span class="nc" id="L309">						shiftEvent.setMinCount(Integer.valueOf(minCount.toString()));</span>
<span class="nc" id="L310">					} catch (Exception ex) {</span>
<span class="nc" id="L311">						addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_MIN_COUNT_FORMAT,</span>
<span class="nc" id="L312">								new Object[]{shiftEventName, String.valueOf(minCount)}));</span>
<span class="nc" id="L313">						hasErrors = true;</span>
<span class="nc" id="L314">					}</span>
				}

				// Max Count (default = 0)
<span class="nc bnc" id="L318" title="All 2 branches missed.">				if (isChecked(MAX_COUNT_FN)) {</span>
<span class="nc" id="L319">					Object maxCount = row.get(MAX_COUNT_FN);</span>
					try {
<span class="nc" id="L321">						shiftEvent.setMaxCount(Integer.valueOf(maxCount.toString()));</span>
<span class="nc" id="L322">					} catch (Exception ex) {</span>
<span class="nc" id="L323">						addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_MAX_COUNT_FORMAT,</span>
<span class="nc" id="L324">								new Object[]{shiftEventName, String.valueOf(maxCount)}));</span>
<span class="nc" id="L325">						hasErrors = true;</span>
<span class="nc" id="L326">					}</span>
				}

				// min count must be &lt;= max count.
<span class="nc bnc" id="L330" title="All 2 branches missed.">				if (shiftEvent.getMinCount() &gt; shiftEvent.getMaxCount()) {</span>
<span class="nc" id="L331">					addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_INVALID_MIN_MAX_COUNT,</span>
<span class="nc" id="L332">							new Object[]{shiftEventName, String.valueOf(shiftEvent.getMinCount()), String.valueOf(shiftEvent.getMaxCount())}));</span>
<span class="nc" id="L333">					hasErrors = true;</span>
				}
			}

			// Additional Activities (Only if 'Is Flexible' enabled)
<span class="nc bnc" id="L338" title="All 4 branches missed.">			if (shiftEvent.isPaid() &amp;&amp; shiftEvent.isFlexible()) {</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">				if (isChecked(ADDITIONAL_ACTIVITIES_FN)) {</span>
<span class="nc" id="L340">					Object additionalActivities = row.get(ADDITIONAL_ACTIVITIES_FN);</span>
<span class="nc" id="L341">					String[] activityTokens = additionalActivities.toString().split(&quot;, &quot;, -1);</span>
<span class="nc" id="L342">					Collection&lt;Activity&gt; activitiesToAdd = new ArrayList&lt;Activity&gt;();</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">					for (String activityName : activityTokens) {</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">						if (activityName.trim().length() == 0) {</span>
<span class="nc" id="L345">							continue;</span>
						}
<span class="nc" id="L347">						Activity activity = activityByNameMap.get(activityName);</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">						if (activity == null) {</span>
<span class="nc" id="L349">							addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_ACTIVITY,</span>
<span class="nc" id="L350">									new Object[]{shiftEventName, String.valueOf(activityName)}));</span>
<span class="nc" id="L351">							hasErrors = true;</span>
						} else {
<span class="nc" id="L353">							activitiesToAdd.add(activity);</span>
						}
					}
<span class="nc" id="L356">					shiftEvent.removeAdditionalActivities(shiftEvent.getAdditionalActivities());</span>
<span class="nc" id="L357">					shiftEvent.addAdditionalActivities(activitiesToAdd);</span>
				}
			}

			// Organization
<span class="nc bnc" id="L362" title="All 2 branches missed.">			if (isChecked(ORGANIZATION_FN)) { // REQUIRED</span>
<span class="nc" id="L363">				Object organization = row.get(ORGANIZATION_FN);</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">				if (organization.toString().trim().length() == 0) {</span>
<span class="nc" id="L365">					addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_ORGANIZATION,</span>
<span class="nc" id="L366">							new Object[]{shiftEventName, String.valueOf(organization)}));</span>
				} else {
<span class="nc bnc" id="L368" title="All 2 branches missed.">					if (organization.toString().toLowerCase().compareTo(i18n(m_fsResourceBundle, FsWebBundleKey.LOCAL).toLowerCase()) == 0) {  // ! magic string.</span>
<span class="nc" id="L369">						shiftEvent.setOrganizationID(null);</span>
<span class="nc" id="L370">						shiftEvent.setCampaignID(new ID(m_campaignId));</span>
					} else {
<span class="nc" id="L372">						ID lookupOrg = orgsNameIDMap.get(organization.toString());</span>
<span class="nc bnc" id="L373" title="All 4 branches missed.">						if (lookupOrg == null || !lookupOrg.equals(new ID(m_organizationId))) {</span>
<span class="nc" id="L374">							addImportStatusMessage(m_localizer.i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFTEVENT_IMPORT_INVALID_ORGANIZATION,</span>
<span class="nc" id="L375">									new Object[]{shiftEventName, String.valueOf(organization)}));</span>
<span class="nc" id="L376">							hasErrors = true;</span>
						} else {
<span class="nc" id="L378">							shiftEvent.setCampaignID(null);</span>
<span class="nc" id="L379">							shiftEvent.setOrganizationID(lookupOrg);</span>
						}
					}
				}
			}

			// Description (default = '')
<span class="nc bnc" id="L386" title="All 2 branches missed.">			if (isChecked(DESCRIPTION_FN)) {</span>
<span class="nc" id="L387">				Object description = row.get(DESCRIPTION_FN);</span>
<span class="nc" id="L388">				shiftEvent.setDescription(description.toString());</span>
			}

<span class="nc" id="L391">			List&lt;Message&gt; shiftEventValidationResults = ShiftUtil.validateShiftEvent(m_localizer, shiftEvent);</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">			for (Message m : shiftEventValidationResults) {</span>
<span class="nc" id="L393">				addImportStatusMessage(m.getLocalizedMessage(m_localizer));</span>
<span class="nc" id="L394">			}</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">			if (shiftEventValidationResults.size() &gt; 0) {</span>
<span class="nc" id="L396">				hasErrors = true;</span>
			}

<span class="nc bnc" id="L399" title="All 2 branches missed.">			if (!hasErrors) {</span>
<span class="nc bnc" id="L400" title="All 6 branches missed.">				if (isNew &amp;&amp; (m_importBehavior.compareTo(IMPORT_BEHAVIOR_ADD_UPDATE) == 0 || m_importBehavior.compareTo(IMPORT_BEHAVIOR_ADD_ONLY) == 0)) {</span>
<span class="nc" id="L401">					shiftEvent = WorkRulesModelHandler.createShiftEvent(m_context, shiftEvent);</span>
<span class="nc" id="L402">					shiftEventsCreated++;</span>
<span class="nc" id="L403">					shiftEventsMap.put(shiftEvent.getName(), shiftEvent);</span>
<span class="nc bnc" id="L404" title="All 6 branches missed.">				} else if (!isNew &amp;&amp; (m_importBehavior.compareTo(IMPORT_BEHAVIOR_ADD_UPDATE) == 0 || m_importBehavior.compareTo(IMPORT_BEHAVIOR_UPDATE_ONLY) == 0)) {</span>
					// See if the shift event was already added, only update the last shift event encountered if duplicates exist.
<span class="nc" id="L406">					Iterator&lt;ShiftEvent&gt; iter = shiftEventsToUpdate.iterator();</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">					if (iter != null) {</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">						while (iter.hasNext()) {</span>
<span class="nc" id="L409">							ShiftEvent s = iter.next();</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">							if (s.getName().compareToIgnoreCase(shiftEvent.getName()) == 0) {</span>
<span class="nc" id="L411">								iter.remove(); // remove this copy, there is a later entry for this shift in the file.</span>
							}
<span class="nc" id="L413">						}</span>
					}
<span class="nc" id="L415">					shiftEventsToUpdate.add(shiftEvent);</span>
<span class="nc" id="L416">				}</span>
			} else {
<span class="nc" id="L418">				shiftEventsSkipped++;</span>
			}
<span class="nc" id="L420">		}</span>

<span class="nc bnc" id="L422" title="All 4 branches missed.">		if (m_importBehavior.compareTo(IMPORT_BEHAVIOR_ADD_UPDATE) == 0 || m_importBehavior.compareTo(IMPORT_BEHAVIOR_UPDATE_ONLY) == 0) {</span>
<span class="nc" id="L423">			WorkRulesModelHandler.updateShiftEvents(m_context, shiftEventsToUpdate);</span>
		}

<span class="nc bnc" id="L426" title="All 2 branches missed.">		if (m_importStatusMessages.size() &gt; 0) {</span>
<span class="nc" id="L427">			addPageMessage(new Message(Message.WARNING_TYPE, FsWebBundleKey.FS_IMPORT_FAILURE_MESSAGE,</span>
					FsWebBundleKey.BUNDLE_NAME,
					new String[]{
<span class="nc" id="L430">							String.valueOf(i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFT_EVENT)),</span>
<span class="nc" id="L431">							String.valueOf(shiftEventsCreated),</span>
<span class="nc" id="L432">							String.valueOf(shiftEventsToUpdate.size()),</span>
<span class="nc" id="L433">							String.valueOf(shiftEventsSkipped)</span>
					}));
		} else {
<span class="nc" id="L436">			addPageMessage(new Message(Message.INFO_TYPE, FsWebBundleKey.FS_IMPORT_SUCCESS_MESSAGE,</span>
					FsWebBundleKey.BUNDLE_NAME,
					new String[]{
<span class="nc" id="L439">							String.valueOf(i18n(m_fsResourceBundle, FsWebBundleKey.FS_SHIFT_EVENT)),</span>
<span class="nc" id="L440">							String.valueOf(shiftEventsCreated),</span>
<span class="nc" id="L441">							String.valueOf(shiftEventsToUpdate.size())</span>
					}));
		}
<span class="nc bnc" id="L444" title="All 2 branches missed.">		if (success) {</span>
<span class="nc" id="L445">			setPageAction(SUCCESS);</span>
		}
<span class="nc" id="L447">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>