<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WorkPatternFormPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.fs.workrules</a> &gt; <span class="el_source">WorkPatternFormPM.java</span></div><h1>WorkPatternFormPM.java</h1><pre class="source lang-java linenums">package com.verint.web.fs.workrules;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import com.bluepumpkin.common.datatypes.Duration;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.campaign.model.Campaign;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectIDListComparator;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeType;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeTypeComparator;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.Shift;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftOTExtension;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPattern;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPatternPeriod;
import com.bluepumpkin.ejb.bbm.workrules.model.ShiftPatternShiftAttributes;
import com.bluepumpkin.ejb.bbm.workrules.model.VTOEvent;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.organization.setup.employeetype.EmployeeTypeModelHandler;
import com.bluepumpkin.web.core.pagecomponent.DropDownSelectionPC;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.PageComponent;
import com.witness.web.uif.pagecomponent.container.CollapsibleContainerPC;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.form.FormTwoColumnPC;
import com.witness.web.uif.pagecomponent.picker.time.DurationSpinnerPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.SortUtil;

public class WorkPatternFormPM extends WorkRulesFormPM {
	private static final long serialVersionUID = 1L;

<span class="fc" id="L48">	private ArrayList&lt;ShiftPattern&gt; shiftPatterns = new ArrayList&lt;ShiftPattern&gt;();</span>
	private Collection&lt;EmployeeType&gt; allEmployeeTypes;
	private String m_optimizationTargetName;
	private Organization m_activeOrganization;
	private Campaign m_activeCampaign;
	
	// Field Names
	private static final String FN_NAME=&quot;workPatternName&quot;;
	private static final String FN_DESCRIPTION=&quot;workPatternDesc&quot;;
	
	// Page Components 
	private FormTwoColumnPC pc_form;
	private FormInputPC pc_name; 
	private FormInputPC pc_description;
	private DurationSpinnerPC pc_consistencyTolerance;
	private DropDownSelectionPC&lt;EmployeeType&gt; pc_employeeType;
	private OTExtensionInlineEditPC pc_otExtension;
	private VTOEventInlineEditPC pc_vtoEvents;
	private WorkDaysInlineEditListPC pc_workDays;
	private WorkPatternPeriodDropDownPC pc_workPatternPeriod;

	public WorkPatternFormPM(RequestContext context) {
<span class="fc" id="L70">		super(context);</span>

<span class="fc" id="L72">		addRequiredJavaScriptFile(JavaScriptFileID.JQUERY);</span>
<span class="fc" id="L73">	}</span>

	@Override
	protected void initContentTitle() {
<span class="fc" id="L77">		super.initContentTitle();</span>
<span class="fc" id="L78">		m_contentTitlePC.setPageTitle(m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.WORK_PATTERNS));</span>
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">		if (isMultiEdit()) {</span>
<span class="nc" id="L80">			m_contentTitlePC.setItemName(m_localizer.i18n(m_bundle, FsWebBundleKey.N_WORK_PATTERNS, shiftPatterns.size()));</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">		} else if (shiftPatterns.size() &gt; 0){</span>
<span class="fc" id="L82">			m_contentTitlePC.setItemName(shiftPatterns.iterator().next().getName());</span>
		}
<span class="fc" id="L84">	}</span>

	@SuppressWarnings(&quot;unchecked&quot;)
	@Override
	protected void loadData() throws Exception {
<span class="fc" id="L89">		super.loadData();</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">		if (getPerformActionOnIDSize() &gt; 0) {</span>
<span class="fc" id="L91">			List&lt;ID&gt; paoIDs = Arrays.asList(getPerformActionOnIDs());</span>
<span class="fc" id="L92">			shiftPatterns = new ArrayList&lt;ShiftPattern&gt;(WorkRulesModelHandler.getShiftPatterns(m_context, paoIDs));</span>
<span class="fc" id="L93">			Collections.sort(shiftPatterns, new ValueObjectIDListComparator(paoIDs));</span>
			// For single edit, get optimization target name (either org name or &quot;Local&quot;) 
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">			if (shiftPatterns.size() == 1) { </span>
<span class="fc" id="L96">				ShiftPattern sp = shiftPatterns.iterator().next();</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">				if (sp.getCampaignID() != null) {</span>
<span class="nc" id="L98">					m_optimizationTargetName = m_localizer.i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.LOCAL);</span>
<span class="nc" id="L99">					m_activeCampaign = selectedCampaign;</span>
				}
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">				if (sp.getOrganizationID() != null) {</span>
<span class="fc" id="L102">					Organization o = OrganizationModelHandler.getOrganization(m_context, sp.getOrganizationID());</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">					if (o != null) {</span>
<span class="fc" id="L104">						m_optimizationTargetName = o.getName();</span>
<span class="fc" id="L105">						m_activeOrganization = selectedOrg;</span>
					}
				}
			}
		}
		
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">		if (selectedOrg != null) {</span>
<span class="fc" id="L112">			allEmployeeTypes = EmployeeTypeModelHandler.getEmployeeTypes(m_context, selectedOrg.getID());</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">		} else if (selectedSchedulingPeriod != null) {</span>
<span class="nc" id="L114">			allEmployeeTypes = EmployeeTypeModelHandler.getEmployeeTypes(m_context,</span>
<span class="nc" id="L115">					WorkRulesModelHandler.getOrgIDsLinkedToSP(m_context, selectedSchedulingPeriod.getID()));</span>
		}
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">		if (allEmployeeTypes != null) {</span>
<span class="fc" id="L118">			allEmployeeTypes = SortUtil.sort(allEmployeeTypes, new EmployeeTypeComparator(m_locale));</span>
		}

		// If editing a new object, or multi-editing
<span class="fc bfc" id="L122" title="All 2 branches covered.">		if (StringUtil.isEmpty(m_optimizationTargetName)) {</span>
<span class="pc bpc" id="L123" title="2 of 4 branches missed.">			if (isByOrg &amp;&amp; selectedOrg != null) {</span>
<span class="fc" id="L124">				m_optimizationTargetName = selectedOrg.getName();</span>
<span class="fc" id="L125">				m_activeOrganization = selectedOrg;</span>
			}
<span class="nc bnc" id="L127" title="All 4 branches missed.">			else if (!isByOrg &amp;&amp; selectedCampaign != null) {</span>
<span class="nc" id="L128">				m_optimizationTargetName = selectedCampaign.getName();</span>
<span class="nc" id="L129">				m_activeCampaign = selectedCampaign;</span>
			}
		}
<span class="fc" id="L132">	}</span>

	@Override
	protected void initForm() {
<span class="fc" id="L136">		pc_form = new FormTwoColumnPC(m_context);</span>
<span class="fc" id="L137">		pc_form.setIsBorderEnabled(true);</span>
<span class="fc" id="L138">		addForm(pc_form);</span>
		
		//Organization/Campaign
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">		if (isByOrg) {</span>
<span class="fc" id="L142">			String orgName = &quot;&quot;;</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">			if (selectedOrg != null) {</span>
<span class="fc" id="L144">				orgName = selectedOrg.getName();</span>
			}
<span class="fc" id="L146">			pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_ORGANIZATION), orgName);</span>
<span class="fc" id="L147">		} else {</span>
<span class="nc" id="L148">			String campaignName = &quot;&quot;;</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">			if (selectedCampaign != null) {</span>
<span class="nc" id="L150">				campaignName = selectedCampaign.getName();</span>
			}
<span class="nc" id="L152">			pc_form.addRow(i18n(m_bundle, FsWebBundleKey.FS_CAMPAIGN), campaignName);</span>
		}

<span class="fc" id="L155">		ShiftPattern sp = new ShiftPattern();</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">		if (shiftPatterns.size() &gt; 0) { </span>
<span class="fc" id="L157">			sp = shiftPatterns.iterator().next();</span>
		} else {
			try {
				//Possible days off shift should be included in all new work patterns
<span class="fc" id="L161">				Shift daysOffShift = WorkRulesModelHandler.getPossibleDaysOffShift(m_context);</span>
<span class="fc" id="L162">				ShiftPatternShiftAttributes spsa = new ShiftPatternShiftAttributes();</span>
				
				// QC-85840: This is seemingly bad that the occurrences are set to the max period type
				// but the way FS client deals with this data, it is ok to define the full days
				// because FS client windows the data based on work pattern type and we want to 
				// check all the points by default for the user experience and not just the first
				// 7 days which would be the default work pattern type.
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">				int[] daysInPeriod = (WorkRulesUtil.areMonthlyWorkRulesLicensed() ? </span>
<span class="pc" id="L170">						ShiftPatternPeriod.ThirtyOneDayMonth.getDaysInPeriod() : ShiftPatternPeriod.Week.getDaysInPeriod() );</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">				for (int i = 0; i &lt; daysInPeriod.length; i++) {</span>
<span class="fc" id="L172">					spsa.getOccurrenceDays().add(daysInPeriod[i]);</span>
				}
<span class="fc" id="L174">				sp.getShiftPatternShiftAttributes().put(daysOffShift, spsa);</span>
<span class="fc" id="L175">				shiftPatterns.add(sp);</span>
<span class="nc" id="L176">			} catch (Exception ex) {</span>
<span class="nc" id="L177">				handleUnableToLoadDataError(log, ex);</span>
<span class="fc" id="L178">			}</span>
		}
		
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">		if (isMultiEdit() == false) {</span>
			//Name
<span class="fc" id="L183">			pc_name = new FormInputPC(m_context);</span>
<span class="fc" id="L184">			pc_name.reset(FN_NAME, sp.getName(),</span>
				FormInputPC.TYPE_STRING, true);
<span class="fc" id="L186">			pc_name.setAutoExtractParamEnabled(true);</span>
<span class="fc" id="L187">			pc_name.setMaxLength(50);</span>
<span class="fc" id="L188">			pc_name.setInputFieldDesc(UIFWebBundleKey.NAME, UIFWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L189">			pc_name.setIsRequired(true);</span>
<span class="fc" id="L190">			pc_name.setInputValue(sp.getName());</span>
<span class="fc" id="L191">			pc_name.setNotAllowedChars(&quot;'&quot;); </span>
<span class="fc" id="L192">			addRow(i18n(m_common_bundle, UIFWebBundleKey.NAME), pc_name);</span>
			
			//Description
<span class="fc" id="L195">			pc_description = new FormInputPC(m_context);</span>
<span class="fc" id="L196">			pc_description.reset(FN_DESCRIPTION, sp.getName(),</span>
					FormInputPC.TYPE_STRING, false);
<span class="fc" id="L198">			pc_description.setAutoExtractParamEnabled(true);</span>
<span class="fc" id="L199">			pc_description.setMaxLength(250);</span>
<span class="fc" id="L200">			pc_description.setInputFieldDesc(UIFWebBundleKey.DESCRIPTION, UIFWebBundleKey.BUNDLE_NAME);</span>
<span class="fc" id="L201">			pc_description.setInputValue(sp.getDescription());</span>
<span class="fc" id="L202">			addRow(i18n(m_common_bundle, UIFWebBundleKey.DESCRIPTION), pc_description);</span>
		}

		// Consistency Tolerance
<span class="fc" id="L206">		pc_consistencyTolerance = new DurationSpinnerPC(m_context, &quot;consistencyTolerance&quot;);</span>
<span class="fc" id="L207">		pc_consistencyTolerance.setValue(Duration.fromMinutes(sp.getConsistentStartsTolerance()));</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">		for (ShiftPattern shiftPattern : shiftPatterns) {</span>
<span class="pc bpc" id="L209" title="3 of 4 branches missed.">			if (shiftPattern != sp &amp;&amp; shiftPattern.getConsistentStartsTolerance() != sp.getConsistentStartsTolerance()) { </span>
<span class="nc" id="L210">				pc_consistencyTolerance.setMultiEdit(true); </span>
<span class="nc" id="L211">				break; </span>
			}
<span class="fc" id="L213">		}</span>
<span class="fc" id="L214">		addRow(i18n(m_bundle, FsWebBundleKey.FS_CONSISTENCY_TOLERANCE), pc_consistencyTolerance);</span>

		// Employee Type
<span class="fc" id="L217">		pc_employeeType = new DropDownSelectionPC&lt;EmployeeType&gt;(m_context, &quot;employeeType&quot;);</span>
<span class="fc bfc" id="L218" title="All 2 branches covered.">		for (EmployeeType empType : allEmployeeTypes) {</span>
<span class="fc" id="L219">			pc_employeeType.addOption(empType.getID().toString(), empType.getDescription(), empType, empType.getID().equals(sp.getEmployeeTypeID()));</span>
<span class="fc bfc" id="L220" title="All 4 branches covered.">			if (empType.getDescription().equals(&quot;Full-time&quot;) &amp;&amp; sp.getEmployeeTypeID() == null) {</span>
<span class="fc" id="L221">				pc_employeeType.setSelectedID(empType.getID().toString());</span>
			}
<span class="fc" id="L223">		}</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">		if (sp.getEmployeeTypeID() != null) {</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">			for (ShiftPattern shiftPattern : shiftPatterns) {</span>
<span class="pc bpc" id="L226" title="3 of 4 branches missed.">				if (shiftPattern != sp &amp;&amp; !shiftPattern.getEmployeeTypeID().equals(sp.getEmployeeTypeID())) {</span>
<span class="nc" id="L227">					pc_employeeType.setMultiEdit(true);</span>
<span class="nc" id="L228">					break;</span>
				}
<span class="fc" id="L230">			}</span>
		}
<span class="fc" id="L232">		addRow(i18n(m_bundle, FsWebBundleKey.FS_EMPLOYEE_TYPE), pc_employeeType);</span>
		
		//Work pattern type (only available if monthly features license is available)
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">		if (WorkRulesUtil.areMonthlyWorkRulesLicensed()) {</span>
<span class="nc" id="L236">			pc_workPatternPeriod = new WorkPatternPeriodDropDownPC(m_context, &quot;workPatternPeriodPC&quot;);</span>
<span class="nc" id="L237">			pc_workPatternPeriod.extractParameters(m_context.getRequest());</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">			if (pc_workPatternPeriod.isEdited() == false) {		//If this drop down was edited, it means the user selected a new type of work pattern and the form page was refreshed.  Do not set the drop down to the type that was loaded in the shift pattern from the DB in this case.</span>
<span class="nc" id="L239">				pc_workPatternPeriod.setSelectedWorkPatternPeriod(shiftPatterns.iterator().next().getPeriod());				</span>
			}
<span class="nc" id="L241">			addRow(i18n(m_bundle, FsWebBundleKey.FS_WORK_PATTERN_TYPE), pc_workPatternPeriod);</span>
		}
		
		ID ownerID;
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">		if (isByOrg) ownerID = selectedOrg.getID();</span>
<span class="nc" id="L246">		else ownerID = selectedSchedulingPeriod.getID();</span>
		
		// Work days/consistency list		
<span class="fc" id="L249">		CollapsibleContainerPC workDaysContainer = new CollapsibleContainerPC(m_context);</span>
<span class="fc" id="L250">		workDaysContainer.setName(&quot;workDaysContainer&quot;);</span>
<span class="fc" id="L251">		workDaysContainer.setTitle(getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
				FsWebBundleKey.FS_WORK_DAYS_CONSISTENCY));
<span class="fc" id="L253">		workDaysContainer.setIsBorderEnabled(true);</span>
<span class="fc" id="L254">		pc_workDays =  new WorkDaysInlineEditListPC(m_context, &quot;shiftPatternWorkDaysTable&quot;, </span>
<span class="pc bpc" id="L255" title="1 of 2 branches missed.">				getShiftPatternShiftAttributes(), isByOrg, ownerID, optimizationTargetTimeZone, </span>
				timeZoneEffectiveDate, m_activeOrganization, m_activeCampaign,
<span class="pc" id="L257">				pc_workPatternPeriod == null ? ShiftPatternPeriod.Week : pc_workPatternPeriod.getSelection());</span>
<span class="fc" id="L258">		pc_workDays.getWrapper().setAttribute(&quot;style&quot;, &quot;width:100%&quot;);</span>
<span class="fc" id="L259">		pc_workDays.setIsInnerTable(true);</span>
<span class="fc" id="L260">		pc_workDays.setIsBorderEnabled(false);</span>
<span class="fc" id="L261">		pc_workDays.setIsCancelSelectEventPropagation(false);</span>
<span class="fc" id="L262">		workDaysContainer.addComponent(pc_workDays);</span>
<span class="fc" id="L263">		addChildComponent(workDaysContainer);</span>
<span class="fc" id="L264">		addForm(workDaysContainer);</span>
		
		// VTO Event list
<span class="fc" id="L267">		CollapsibleContainerPC vtoContainer = new CollapsibleContainerPC(m_context);</span>
<span class="fc" id="L268">		vtoContainer.setName(&quot;vtoContainer&quot;);</span>
<span class="fc" id="L269">		vtoContainer.setTitle(getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
				FsWebBundleKey.FS_VTO_EVENTS));
<span class="fc" id="L271">		vtoContainer.setIsBorderEnabled(true);</span>
<span class="fc" id="L272">		pc_vtoEvents =  new VTOEventInlineEditPC(m_context, &quot;shiftPatternVTOEventTable&quot;, getVTOEvents(), isByOrg, ownerID);</span>
<span class="fc" id="L273">		pc_vtoEvents.getWrapper().setAttribute(&quot;style&quot;, &quot;width:100%&quot;);</span>
<span class="fc" id="L274">		pc_vtoEvents.setIsInnerTable(true);</span>
<span class="fc" id="L275">		pc_vtoEvents.setIsBorderEnabled(false);</span>
<span class="fc" id="L276">		pc_vtoEvents.setIsCancelSelectEventPropagation(false);</span>
<span class="fc" id="L277">		vtoContainer.addComponent(pc_vtoEvents);</span>
<span class="fc" id="L278">		addChildComponent(vtoContainer);</span>
<span class="fc" id="L279">		addForm(vtoContainer);</span>
		
		// OT Extensions List
<span class="fc" id="L282">		CollapsibleContainerPC otExtensionContainer = new CollapsibleContainerPC(m_context);</span>
<span class="fc" id="L283">		otExtensionContainer.setName(&quot;otExtensionContainer&quot;);</span>
<span class="fc" id="L284">		otExtensionContainer.setTitle(getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME,</span>
				FsWebBundleKey.FS_OT_EXTENSION));
<span class="fc" id="L286">		otExtensionContainer.setIsBorderEnabled(true);</span>
<span class="fc" id="L287">		pc_otExtension = new OTExtensionInlineEditPC(m_context, &quot;shiftPatternOTExtensionTable&quot;,</span>
<span class="fc" id="L288">				getOTExtensionsFromSelectedShiftPatterns(), isByOrg, ownerID, optimizationTargetTimeZone, timeZoneEffectiveDate);</span>
<span class="fc" id="L289">		pc_otExtension.getWrapper().setAttribute(&quot;style&quot;, &quot;width:100%&quot;);</span>
<span class="fc" id="L290">		pc_otExtension.setIsInnerTable(true);</span>
<span class="fc" id="L291">		pc_otExtension.setIsBorderEnabled(false);</span>
<span class="fc" id="L292">		pc_otExtension.setIsCancelSelectEventPropagation(false);</span>
<span class="fc" id="L293">		otExtensionContainer.addComponent(pc_otExtension);</span>
<span class="fc" id="L294">		addChildComponent(otExtensionContainer);</span>
<span class="fc" id="L295">		addForm(otExtensionContainer);</span>
		
		// Set page component state from submitted values
<span class="pc bpc" id="L298" title="1 of 6 branches missed.">		if ( null != getPageAction() &amp;&amp; ! (PageAction.EDIT.equals(getPageAction()) || PageAction.ADD.equals(getPageAction()))) {  // Is postback</span>
<span class="fc" id="L299">			this.extractParameters(m_context.getRequest());	</span>
		}
<span class="fc" id="L301">	}</span>
	
	public static WorkPatternFormPM getInstance(RequestContext context) {
<span class="fc" id="L304">		return (WorkPatternFormPM) PageModel.getInstance(context, WorkPatternFormPM.class);</span>
	}
	
	private void addRow(String label, PageComponent pc) {
<span class="fc" id="L308">		this.addChildComponent(pc);</span>
<span class="fc" id="L309">		pc_form.addRow(label, pc);</span>
<span class="fc" id="L310">	}</span>

	private HashMap&lt;Shift, ShiftPatternShiftAttributes&gt; getShiftPatternShiftAttributes() {
<span class="fc" id="L313">		HashMap&lt;Shift, ShiftPatternShiftAttributes&gt; retVal = new HashMap&lt;Shift, ShiftPatternShiftAttributes&gt;();</span>
<span class="fc" id="L314">		HashMap&lt;ID, Shift&gt; shiftAssignments = new HashMap&lt;ID, Shift&gt;();</span>
<span class="fc" id="L315">		HashMap&lt;Shift, HashSet&lt;ShiftPattern&gt;&gt; shiftShiftPatterns = new HashMap&lt;Shift, HashSet&lt;ShiftPattern&gt;&gt;();</span>
		
<span class="fc bfc" id="L317" title="All 2 branches covered.">		for (ShiftPattern sp : shiftPatterns) {</span>
<span class="fc bfc" id="L318" title="All 2 branches covered.">			for (Shift shift : sp.getShiftPatternShiftAttributes().keySet()) {</span>
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">				if (shiftAssignments.containsKey(shift.getID())) {	//same shift is present in more than 1 pattern, check for multi-edit attributes</span>
<span class="nc" id="L320">					ShiftPatternShiftAttributes existingAttributes = retVal.get(shift);</span>
<span class="nc" id="L321">					ShiftPatternShiftAttributes newAttributes = sp.getShiftPatternShiftAttributes().get(shift);</span>
					//Set multi-edit on all values that are not common to all instances of the shift
<span class="nc" id="L323">					if (existingAttributes.isConsistentShiftActivities() !=</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">						newAttributes.isConsistentShiftActivities()) {</span>
<span class="nc" id="L325">						existingAttributes.setIsConsistentShiftActivitesMultiEdit(true);</span>
					}
<span class="nc bnc" id="L327" title="All 2 branches missed.">					if (existingAttributes.getMaxConsecutiveDay() != newAttributes.getMaxConsecutiveDay()) {</span>
<span class="nc" id="L328">						existingAttributes.setIsMaxConsecutiveDaysMultiEdit(true);</span>
					}
<span class="nc bnc" id="L330" title="All 2 branches missed.">					if (existingAttributes.getMinConsecutiveDay() != newAttributes.getMinConsecutiveDay()) {</span>
<span class="nc" id="L331">						existingAttributes.setIsMinConsecutiveDaysMultiEdit(true);</span>
					}
					//Set multi-edit on all work days that are not common to all instances of the shift
<span class="nc bnc" id="L334" title="All 2 branches missed.">					for (int day : existingAttributes.getOccurrenceDays()) {</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">						if (newAttributes.getOccurrenceDays().contains(day) == false) {</span>
<span class="nc" id="L336">							existingAttributes.setOccurrenceDayMultiEdit(day, true);</span>
						}
<span class="nc" id="L338">					}</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">					for (int day : newAttributes.getOccurrenceDays()) {</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">						if (existingAttributes.getOccurrenceDays().contains(day) == false) {</span>
<span class="nc" id="L341">							existingAttributes.getOccurrenceDays().add(day);</span>
<span class="nc" id="L342">							existingAttributes.setOccurrenceDayMultiEdit(day, true);</span>
						}
<span class="nc" id="L344">					}</span>
					//Set multi-edit on all consistency groups that are not common to all instances of the shift
<span class="nc bnc" id="L346" title="All 2 branches missed.">					for (int day : existingAttributes.getConsistentShiftGroupMap().keySet()) {</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">						if (newAttributes.getConsistentShiftGroupMap().keySet().contains(day) == false ||</span>
<span class="nc" id="L348">								(newAttributes.getConsistentShiftGroupMap().get(day) !=</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">									existingAttributes.getConsistentShiftGroupMap().get(day))) {</span>
<span class="nc" id="L350">							existingAttributes.setConsistentShiftGroupMultiEdit(day, true);</span>
						}
<span class="nc" id="L352">					}</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">					for (int day : newAttributes.getConsistentShiftGroupMap().keySet()) {</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">						if (existingAttributes.getConsistentShiftGroupMap().keySet().contains(day) == false ||</span>
<span class="nc" id="L355">								(existingAttributes.getConsistentShiftGroupMap().get(day) !=</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">									newAttributes.getConsistentShiftGroupMap().get(day))) {						</span>
<span class="nc" id="L357">							existingAttributes.getConsistentShiftGroupMap().put(day,</span>
<span class="nc" id="L358">									newAttributes.getConsistentShiftGroupMap().get(day));</span>
<span class="nc" id="L359">							existingAttributes.setConsistentShiftGroupMultiEdit(day, true);</span>
						}
<span class="nc" id="L361">					}</span>
<span class="nc" id="L362">				} else {</span>
<span class="fc" id="L363">					shiftAssignments.put(shift.getID(), shift);</span>
<span class="fc" id="L364">					retVal.put(shift, sp.getShiftPatternShiftAttributes().get(shift).clone());</span>
				}

<span class="fc" id="L367">				HashSet&lt;ShiftPattern&gt; col = shiftShiftPatterns.get(shift);</span>
<span class="pc bpc" id="L368" title="1 of 2 branches missed.">				if (col == null) {</span>
<span class="fc" id="L369">					col = new HashSet&lt;ShiftPattern&gt;();</span>
<span class="fc" id="L370">					shiftShiftPatterns.put(shift, col);</span>
				}
<span class="fc" id="L372">				col.add(sp);</span>
<span class="fc" id="L373">			}</span>
<span class="fc" id="L374">		}</span>
<span class="fc bfc" id="L375" title="All 2 branches covered.">		for (Shift shift : retVal.keySet()) {</span>
<span class="fc" id="L376">			shift.setMultiEditCommon(shiftShiftPatterns.get(shift).containsAll(shiftPatterns));</span>
<span class="fc" id="L377">		}</span>
<span class="fc" id="L378">		return retVal;</span>
	}
	
	private HashMap&lt;VTOEvent, Set&lt;ShiftPattern.StartTime&gt;&gt; getVTOEvents() {
<span class="fc" id="L382">		HashMap&lt;VTOEvent, Set&lt;ShiftPattern.StartTime&gt;&gt; retVal = new HashMap&lt;VTOEvent, Set&lt;ShiftPattern.StartTime&gt;&gt;();</span>
<span class="fc" id="L383">		HashMap&lt;VTOEvent, HashSet&lt;ShiftPattern&gt;&gt; vtoEventAssignments = new HashMap&lt;VTOEvent, HashSet&lt;ShiftPattern&gt;&gt;();</span>
<span class="fc bfc" id="L384" title="All 2 branches covered.">		for (ShiftPattern sp : shiftPatterns) {</span>
<span class="fc bfc" id="L385" title="All 2 branches covered.">			for (VTOEvent vtoE : sp.getVTOEventStartTimes().keySet()) {</span>
				// Filter out vto events that have been deleted in the past
<span class="pc bpc" id="L387" title="3 of 4 branches missed.">				if (vtoE.getDeleteOnDate() != null &amp;&amp; vtoE.getDeleteOnDate().before(timeZoneEffectiveDate)) continue;</span>
				
<span class="fc" id="L389">				Set&lt;ShiftPattern.StartTime&gt; startTimes = retVal.get(vtoE);</span>
<span class="pc bpc" id="L390" title="1 of 2 branches missed.">				if (startTimes == null) {</span>
<span class="fc" id="L391">					startTimes = new HashSet&lt;ShiftPattern.StartTime&gt;();</span>
<span class="fc" id="L392">					retVal.put(vtoE, startTimes);</span>
				}
<span class="fc" id="L394">				startTimes.add(sp.getVTOEventStartTime(vtoE));</span>
<span class="fc" id="L395">				HashSet&lt;ShiftPattern&gt; col = vtoEventAssignments.get(vtoE);</span>
<span class="pc bpc" id="L396" title="1 of 2 branches missed.">				if (col == null) {</span>
<span class="fc" id="L397">					col = new HashSet&lt;ShiftPattern&gt;();</span>
<span class="fc" id="L398">					vtoEventAssignments.put(vtoE, col);</span>
				}
<span class="fc" id="L400">				col.add(sp);</span>
<span class="fc" id="L401">			}</span>
<span class="fc" id="L402">		}</span>
<span class="fc bfc" id="L403" title="All 2 branches covered.">		for (VTOEvent vtoE : retVal.keySet()) {</span>
<span class="fc" id="L404">			vtoE.setMultiEditCommon(vtoEventAssignments.get(vtoE).containsAll(shiftPatterns));</span>
<span class="fc" id="L405">		}</span>
<span class="fc" id="L406">		return retVal;</span>
	}
	
	/**
	 * Returns an array list of all OT Extensions belonging to the selected shift patterns.
	 * Also sets the multi edit common flag on each otExtension so the OTExtensionListPC
	 * can render the item appropriately
	 * @return
	 */
	private HashMap&lt;ShiftOTExtension, Set&lt;ShiftPattern.StartTime&gt;&gt; getOTExtensionsFromSelectedShiftPatterns() {
<span class="fc" id="L416">		HashMap&lt;ShiftOTExtension, Set&lt;ShiftPattern.StartTime&gt;&gt; retVal = new HashMap&lt;ShiftOTExtension, Set&lt;ShiftPattern.StartTime&gt;&gt;();</span>
<span class="fc" id="L417">		HashMap&lt;ShiftOTExtension, HashSet&lt;ShiftPattern&gt;&gt; otExtensionAssignments = new HashMap&lt;ShiftOTExtension, HashSet&lt;ShiftPattern&gt;&gt;();</span>
<span class="fc bfc" id="L418" title="All 2 branches covered.">		for (ShiftPattern sp : shiftPatterns) {</span>
<span class="fc bfc" id="L419" title="All 2 branches covered.">			for (ShiftOTExtension sote : sp.getOTExtensionStartTimes().keySet()) {</span>
				// Filter out objects that have been deleted in the past
<span class="pc bpc" id="L421" title="3 of 4 branches missed.">				if (sote.getDeleteOnDate() != null &amp;&amp; sote.getDeleteOnDate().before(timeZoneEffectiveDate)) continue;</span>
				
<span class="fc" id="L423">				Set&lt;ShiftPattern.StartTime&gt; startTimes = retVal.get(sote);</span>
<span class="pc bpc" id="L424" title="1 of 2 branches missed.">				if (startTimes == null) {</span>
<span class="fc" id="L425">					startTimes = new HashSet&lt;ShiftPattern.StartTime&gt;();</span>
<span class="fc" id="L426">					retVal.put(sote, startTimes);</span>
				}
<span class="fc" id="L428">				startTimes.add(sp.getOTExtensionStartTime(sote));</span>
<span class="fc" id="L429">				HashSet&lt;ShiftPattern&gt; col = otExtensionAssignments.get(sote);</span>
<span class="pc bpc" id="L430" title="1 of 2 branches missed.">				if (col == null) {</span>
<span class="fc" id="L431">					col = new HashSet&lt;ShiftPattern&gt;();</span>
<span class="fc" id="L432">					otExtensionAssignments.put(sote, col);</span>
				}
<span class="fc" id="L434">				col.add(sp);</span>
<span class="fc" id="L435">			}</span>
<span class="fc" id="L436">		}</span>
<span class="fc bfc" id="L437" title="All 2 branches covered.">		for (ShiftOTExtension sote : retVal.keySet()) {</span>
<span class="fc" id="L438">			sote.setMultiEditCommon(otExtensionAssignments.get(sote).containsAll(shiftPatterns));</span>
<span class="fc" id="L439">		}</span>
<span class="fc" id="L440">		return retVal;</span>
	}
	
	public Collection&lt;ShiftPattern&gt; getShiftPatterns() throws BbmFinderException {
<span class="fc" id="L444">		Collection&lt;ShiftPattern&gt; ret = new ArrayList&lt;ShiftPattern&gt;(shiftPatterns);</span>
<span class="pc bpc" id="L445" title="1 of 2 branches missed.">		if (ret.isEmpty()) ret.add(new ShiftPattern());</span>

<span class="fc bfc" id="L447" title="All 2 branches covered.">		for (ShiftPattern shiftPattern : ret) {</span>
			// Construct a shift pattern from the form fields
			
			//Employee type
<span class="pc bpc" id="L451" title="3 of 4 branches missed.">			if (!isMultiEdit() || pc_employeeType.isEdited()) shiftPattern.setEmployeeTypeID(pc_employeeType.getSelections().get(0).getID());</span>
			//Name/desc
<span class="pc bpc" id="L453" title="1 of 2 branches missed.">			if (isEditingNameAndDesc()) {</span>
<span class="pc bpc" id="L454" title="1 of 2 branches missed.">				shiftPattern.setName(pc_name.getInputValue() != null ? pc_name.getInputValue().trim() : null);</span>
<span class="fc" id="L455">				shiftPattern.setDescription(pc_description.getInputValue());</span>
<span class="pc bpc" id="L456" title="1 of 2 branches missed.">				if (isByOrg) shiftPattern.setOrganizationID(selectedOrg.getID());</span>
<span class="nc" id="L457">				else shiftPattern.setCampaignID(selectedCampaign.getDEID());</span>
			}
			//Consistency tolerance
<span class="pc bpc" id="L460" title="3 of 4 branches missed.">			if (!isMultiEdit() || pc_consistencyTolerance.isEdited()) shiftPattern.setConsistentStartsTolerance(pc_consistencyTolerance.getDuration().getDurationInMinutes());</span>
			
			//Period type
<span class="pc bpc" id="L463" title="1 of 2 branches missed.">			if (WorkRulesUtil.areMonthlyWorkRulesLicensed()) {</span>
<span class="nc" id="L464">				shiftPattern.setPeriod(pc_workPatternPeriod.getSelection());</span>
			} else {
<span class="fc" id="L466">				shiftPattern.setPeriod(ShiftPatternPeriod.Week);</span>
			}

			//OT Extensions
<span class="fc" id="L470">			Map&lt;ShiftOTExtension, ShiftPattern.StartTime&gt; otExtensions = shiftPattern.getOTExtensionStartTimes();</span>
<span class="fc" id="L471">			Collection&lt;ID&gt; removedOTExtensionIDs = pc_otExtension.getRemovedRowIDCollection();</span>
<span class="fc bfc" id="L472" title="All 2 branches covered.">			for (Iterator&lt;ShiftOTExtension&gt; otExtensionIter = otExtensions.keySet().iterator(); otExtensionIter.hasNext(); ) {</span>
<span class="pc bpc" id="L473" title="1 of 2 branches missed.">				if (removedOTExtensionIDs.contains(otExtensionIter.next().getID())) otExtensionIter.remove();</span>
			}
<span class="fc" id="L475">			otExtensions.putAll(pc_otExtension.getAddedOTExtensionAssignments());</span>
<span class="fc bfc" id="L476" title="All 2 branches covered.">			for (Map.Entry&lt;ShiftOTExtension, ShiftPattern.StartTime&gt; entry : pc_otExtension.getModifiedOTExtensionAssignments().entrySet()) {</span>
<span class="pc bpc" id="L477" title="1 of 2 branches missed.">				if (otExtensions.containsKey(entry.getKey())) otExtensions.put(entry.getKey(), entry.getValue());</span>
<span class="fc" id="L478">			}</span>
			
			//VTO Events
<span class="fc" id="L481">			Map&lt;VTOEvent, ShiftPattern.StartTime&gt; vtoEvents = shiftPattern.getVTOEventStartTimes();</span>
<span class="fc" id="L482">			Collection&lt;ID&gt; removedVTOEventIDs = pc_vtoEvents.getRemovedRowIDCollection();</span>
<span class="fc bfc" id="L483" title="All 2 branches covered.">			for (Iterator&lt;VTOEvent&gt; vtoEIter = vtoEvents.keySet().iterator(); vtoEIter.hasNext(); ) {</span>
<span class="pc bpc" id="L484" title="1 of 2 branches missed.">				if (removedVTOEventIDs.contains(vtoEIter.next().getID())) vtoEIter.remove();</span>
			}
<span class="fc" id="L486">			vtoEvents.putAll(pc_vtoEvents.getAddedVTOEventAssignments());</span>
<span class="fc bfc" id="L487" title="All 2 branches covered.">			for (Map.Entry&lt;VTOEvent, ShiftPattern.StartTime&gt; entry : pc_vtoEvents.getModifiedVTOEventAssignments().entrySet()) {</span>
<span class="pc bpc" id="L488" title="1 of 2 branches missed.">				if (vtoEvents.containsKey(entry.getKey())) vtoEvents.put(entry.getKey(), entry.getValue());</span>
<span class="fc" id="L489">			}</span>
						
			//Consistency/work groups
<span class="fc" id="L492">			Map&lt;Shift, ShiftPatternShiftAttributes&gt; shiftPatternShiftAttributes = shiftPattern.getShiftPatternShiftAttributes();</span>
<span class="fc" id="L493">			Collection&lt;ID&gt; removedShiftIDs = pc_workDays.getRemovedRowIDCollection();</span>
<span class="fc bfc" id="L494" title="All 2 branches covered.">			for (Iterator&lt;Shift&gt; shiftIter = shiftPatternShiftAttributes.keySet().iterator(); shiftIter.hasNext(); ) {</span>
<span class="pc bpc" id="L495" title="1 of 2 branches missed.">				if (removedShiftIDs.contains(shiftIter.next().getID())) shiftIter.remove();</span>
			}		
<span class="fc" id="L497">			shiftPatternShiftAttributes.putAll(pc_workDays.getAddedShiftAssignments());</span>
			//Check if any attributes were modified and update those
<span class="fc bfc" id="L499" title="All 2 branches covered.">			for (Map.Entry&lt;Shift, ShiftPatternShiftAttributes&gt; entry : pc_workDays.getModifiedShiftAssignments().entrySet()) {</span>
<span class="pc bpc" id="L500" title="1 of 2 branches missed.">				if (shiftPatternShiftAttributes.containsKey(entry.getKey())) {</span>
<span class="pc bpc" id="L501" title="1 of 2 branches missed.">					if (entry.getValue().isMinConsecutiveDaysMultiEdit() == false) {</span>
<span class="fc" id="L502">						shiftPatternShiftAttributes.get(entry.getKey()).setMinConsecutiveDay(entry.getValue().getMinConsecutiveDay());</span>
					}
<span class="pc bpc" id="L504" title="1 of 2 branches missed.">					if (entry.getValue().isMaxConsecutiveDaysMultiEdit() == false) {</span>
<span class="fc" id="L505">						shiftPatternShiftAttributes.get(entry.getKey()).setMaxConsecutiveDay(entry.getValue().getMaxConsecutiveDay());</span>
					}
<span class="pc bpc" id="L507" title="1 of 2 branches missed.">					if (entry.getValue().isConsistentShiftActivitiesMultiEdit() == false) {</span>
<span class="fc" id="L508">						shiftPatternShiftAttributes.get(entry.getKey()).setisConsistentShiftActivities(entry.getValue().isConsistentShiftActivities());</span>
					}
<span class="fc" id="L510">					int[] dows = shiftPattern.getPeriod().getDaysInPeriod();</span>
<span class="fc bfc" id="L511" title="All 2 branches covered.">					for (int i = 0; i &lt; dows.length; i++) {</span>
<span class="pc bpc" id="L512" title="1 of 2 branches missed.">						if (entry.getValue().isOccurrenceDayMultiEdit(dows[i]) == false) {</span>
<span class="fc bfc" id="L513" title="All 2 branches covered.">							if (entry.getValue().getOccurrenceDays().contains(dows[i])) {</span>
<span class="fc" id="L514">								shiftPatternShiftAttributes.get(entry.getKey()).getOccurrenceDays().add(dows[i]);</span>
							} else {
<span class="fc" id="L516">								shiftPatternShiftAttributes.get(entry.getKey()).getOccurrenceDays().remove(dows[i]);</span>
							}
						}
<span class="pc bpc" id="L519" title="1 of 2 branches missed.">						if (entry.getValue().isConsistentShiftGroupMultiEdit(dows[i]) == false) {</span>
<span class="pc bpc" id="L520" title="1 of 2 branches missed.">							if (entry.getValue().getConsistentShiftGroupMap().keySet().contains(dows[i])) {</span>
<span class="nc" id="L521">								shiftPatternShiftAttributes.get(entry.getKey()).getConsistentShiftGroupMap().put(</span>
<span class="nc" id="L522">										dows[i], entry.getValue().getConsistentShiftGroupMap().get(dows[i]));</span>
							} else {
<span class="fc" id="L524">								shiftPatternShiftAttributes.get(entry.getKey()).</span>
<span class="fc" id="L525">									getConsistentShiftGroupMap().remove(dows[i]);</span>
							}
						}
					}
				}
<span class="fc" id="L530">			}</span>
<span class="fc" id="L531">		}</span>
<span class="fc" id="L532">		return ret;</span>
	}
	
	private boolean isEditingNameAndDesc() {
<span class="pc bpc" id="L536" title="1 of 2 branches missed.">		return !isMultiEdit();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>