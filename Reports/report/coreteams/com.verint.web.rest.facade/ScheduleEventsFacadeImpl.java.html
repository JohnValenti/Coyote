<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ScheduleEventsFacadeImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.rest.facade</a> &gt; <span class="el_source">ScheduleEventsFacadeImpl.java</span></div><h1>ScheduleEventsFacadeImpl.java</h1><pre class="source lang-java linenums">package com.verint.web.rest.facade;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.TimeZone;

import javax.ws.rs.core.Response;

import com.bluepumpkin.common.datatypes.CalendarRange;
import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.DateTimeUtil;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.activity.model.SimpleEvent;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.effectivity.TimePeriod;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.time.TimeInterval;
import com.bluepumpkin.ejb.bbm.timeseries.model.NetStaffingCube;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workresource.model.WorkResourceAssignment;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.fs.Log;
import com.bluepumpkin.web.fs.l10n.FsWebBundleKey;
import com.bluepumpkin.web.fs.schedule.ScheduleViewMH;
import com.bluepumpkin.web.fs.schedule.ScheduleViewPM;
import com.bluepumpkin.web.fs.schedule.ScheduleViewUtil;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.verint.web.rest.entity.ScheduleEventsEntity;
import com.verint.web.rest.entity.ribbon.RibbonDayEntity;
import com.verint.web.rest.entity.ribbon.RibbonResponseEntity;
import com.verint.web.rest.exception.checked.BusinessWFOException;
import com.verint.web.rest.exception.checked.SystemWFOException;
import com.verint.web.rest.exception.checked.WFOException;
import com.verint.web.rest.util.FormatUtils;
import com.verint.web.rest.util.SecurityUtils;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.system.RequestContext;

public class ScheduleEventsFacadeImpl implements IScheduleEventsFacade {
<span class="fc" id="L61">	private static final Category logger = Log.initCategory(ScheduleEventsFacadeImpl.class.getName());</span>
	private static final int INTERVAL = 15;

<span class="fc" id="L64">	private static ScheduleAccessManager saMgr = getScheduleAccessManager();</span>
<span class="fc" id="L65">	private static WorkResourceManager wrMgr = getWorkResourceManager();</span>

<span class="fc" id="L67">    public ScheduleEventsFacadeImpl() { // NOSONAR</span>
<span class="fc" id="L68">    }</span>

    private static ScheduleAccessManager  getScheduleAccessManager() {
		try {
<span class="fc" id="L72">			return WfmManagerFactory.getScheduleAccessManager();</span>
<span class="nc" id="L73">		} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L74">			throw new RuntimeException(&quot;Cannot get ScheduleAccessManager.&quot;);</span>
		}
	}

    private static WorkResourceManager  getWorkResourceManager() {
		try {
<span class="fc" id="L80">			return BbmManagerFactory.getWorkResourceManager();</span>
<span class="nc" id="L81">		} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L82">			throw new RuntimeException(&quot;Cannot get WorkResourceManager.&quot;);</span>
		}
	}

	public List&lt;ScheduleEventsEntity&gt; getAllScheduleEvents(RequestContext context, ID employeeId, ID organizationId, Date startTime, Date endTime) throws WFOException {
		try {
<span class="nc" id="L88">			List&lt;ScheduleEventsEntity&gt; schedules = new ArrayList&lt;ScheduleEventsEntity&gt; ();</span>

<span class="nc" id="L90">			User user = context.getUser();</span>
<span class="nc" id="L91">			Calendar startCal = Calendar.getInstance(TimeZone.getTimeZone(&quot;GMT&quot;));</span>
<span class="nc" id="L92">			startCal.setTime(startTime);</span>
<span class="nc" id="L93">			Calendar endCal = Calendar.getInstance(TimeZone.getTimeZone(&quot;GMT&quot;));</span>
<span class="nc" id="L94">			endCal.setTime(endTime);</span>

			// add &amp; subtract 1 day from start and end dates
<span class="nc" id="L97">			startCal.add(Calendar.DATE, -1);</span>
<span class="nc" id="L98">			endCal.add(Calendar.DATE, 1);</span>

<span class="nc" id="L100">            ID userEmpId = user.getEmployeeID();</span>
	        //-- get activities map
<span class="nc" id="L102">	        HashMap&lt;ID, Activity&gt; activitiesMap = getActivitiesMap();</span>

			// FS.VIEWPEOPLESCHEDULES allows access to the &quot;People -&gt; Schedules&quot; page.
			// FS_VIEWORGSCHEDULES allows access to the &quot;My Schedule -&gt; Group&quot; page.
			// FS_VIEWPERSONALSCHEDULES allows access to the &quot;My Schedule -&gt; Personal&quot; page.
<span class="nc" id="L107">	        boolean isAuthorizedToViewComments = false;</span>
<span class="nc" id="L108">	        Collection&lt;ID&gt; employeeList = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">	        if (organizationId != null) {</span>
				// either one of these allows access to view organization schedules
<span class="nc bnc" id="L111" title="All 2 branches missed.">				boolean isAuthorized = SecurityUtils.isPrivWithOrgScope(user, PrivilegeKeys.FS_VIEWORGSCHEDULES, false, organizationId) ||</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">				                       SecurityUtils.isPrivWithOrgScope(user, PrivilegeKeys.FS_VIEWPEOPLESCHEDULES, false, organizationId);</span>
<span class="nc" id="L113">				ID userOrgId = null;</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">				if (!isAuthorized) {</span>
<span class="nc" id="L115">					userOrgId = OrganizationModelHandler.getEmployeeOrgID(context, userEmpId);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">					if (organizationId.equals(userOrgId)) {</span>
<span class="nc" id="L117">					    isAuthorized = SecurityUtils.isPrivWithGenScope(user, PrivilegeKeys.FS_VIEWPERSONALSCHEDULES);</span>
					}
<span class="nc bnc" id="L119" title="All 2 branches missed.">					if (!isAuthorized) {</span>
<span class="nc" id="L120">					    throw new BusinessWFOException(&quot;Not authorized to view group schedules&quot;, Response.Status.CONFLICT);</span>
					}

<span class="nc" id="L123">					employeeList.add(userEmpId);</span>
				}
				else {
<span class="nc" id="L126">					ArrayList&lt;ID&gt; orgList = new ArrayList&lt;ID&gt; ();</span>
<span class="nc" id="L127">					orgList.add(organizationId);</span>
<span class="nc" id="L128">					Date now = new Date();</span>
<span class="nc" id="L129">					employeeList = wrMgr.getEmployeeIds(orgList, now, now, 0L);</span>
				}

<span class="nc" id="L132">			    isAuthorizedToViewComments = SecurityUtils.isPrivWithOrgScope(user, PrivilegeKeys.FS_VIEWEMPLOYEESCHEDULECOMMENTS, false, organizationId);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">			    if (!isAuthorizedToViewComments) {</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">			        if (userOrgId == null) {</span>
<span class="nc" id="L135">				        userOrgId = OrganizationModelHandler.getEmployeeOrgID(context, userEmpId);</span>
			        }
<span class="nc bnc" id="L137" title="All 2 branches missed.">			        if (organizationId.equals(userOrgId)) {</span>
<span class="nc" id="L138">				        isAuthorizedToViewComments = SecurityUtils.isPrivWithGenScope(user, PrivilegeKeys.FS_VIEWPERSONALSCHEDULECOMMENTS);</span>
			        }
			    }

<span class="nc" id="L142">	        }</span>
	        else {
<span class="nc" id="L144">    			employeeList.add(employeeId);</span>
<span class="nc" id="L145">    			HashMap empOrgs = wrMgr.getEmployeesReportingOrgs(employeeList, new Date());</span>
<span class="nc" id="L146">    			ID empOrgId = (ID)empOrgs.get(employeeId);</span>
<span class="nc" id="L147">    			boolean isAuthorizedToView = false;</span>
<span class="nc bnc" id="L148" title="All 4 branches missed.">        		if (userEmpId==null || !userEmpId.equals(employeeId)) { // empUserId of wsuperuser will be null</span>
			        // either one of these allows access to view organization schedules
<span class="nc bnc" id="L150" title="All 2 branches missed.">			        isAuthorizedToView = SecurityUtils.isPrivWithOrgScope(user, PrivilegeKeys.FS_VIEWORGSCHEDULES, false, empOrgId) ||</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">			                             SecurityUtils.isPrivWithOrgScope(user, PrivilegeKeys.FS_VIEWPEOPLESCHEDULES, false, empOrgId);</span>
<span class="nc" id="L152">		        	isAuthorizedToViewComments = SecurityUtils.isPrivWithOrgScope(user, PrivilegeKeys.FS_VIEWEMPLOYEESCHEDULECOMMENTS, false, empOrgId);</span>
        		}
	        	else {  // the user is requesting to view her own schedules
			        // either has privilege to see her own schedules or the organization's schedules
<span class="nc bnc" id="L156" title="All 2 branches missed.">	        		isAuthorizedToView = SecurityUtils.isPrivWithGenScope(user, PrivilegeKeys.FS_VIEWPERSONALSCHEDULES) ||</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">				                         SecurityUtils.isPrivWithOrgScope(user, PrivilegeKeys.FS_VIEWORGSCHEDULES, false, empOrgId) ||</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">				                         SecurityUtils.isPrivWithOrgScope(user, PrivilegeKeys.FS_VIEWPEOPLESCHEDULES, false, empOrgId);</span>

			        //allow user to see his own schedule comments if he has explicit privilege to view his own schedules OR has privilege to view schedules for his org
<span class="nc bnc" id="L161" title="All 2 branches missed.">			        isAuthorizedToViewComments = SecurityUtils.isPrivWithGenScope(user, PrivilegeKeys.FS_VIEWPERSONALSCHEDULECOMMENTS) ||</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">				                                 SecurityUtils.isPrivWithOrgScope(user, PrivilegeKeys.FS_VIEWEMPLOYEESCHEDULECOMMENTS, false, empOrgId);</span>
	        	}
<span class="nc bnc" id="L164" title="All 2 branches missed.">	                if (!isAuthorizedToView) {</span>
<span class="nc" id="L165">				        throw new BusinessWFOException(&quot;Not authorized to view schedules&quot;, Response.Status.CONFLICT);</span>
	                }
	        }

<span class="nc" id="L169">        	Collection&lt;Collection&lt;SimpleEvent&gt;&gt; flattenedSchedule = getFlattenedSchedule(saMgr, employeeList, startCal.getTime(), endCal.getTime());</span>

<span class="nc bnc" id="L171" title="All 4 branches missed.">        	if (employeeList != null &amp;&amp; flattenedSchedule != null) {</span>
<span class="nc" id="L172">        		for (Iterator iEID = employeeList.iterator(),</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">        				iSched = flattenedSchedule.iterator(); iEID.hasNext(); ) {</span>
<span class="nc" id="L174">        			ID empId = (ID)iEID.next();</span>
<span class="nc" id="L175">        			Collection&lt;SimpleEvent&gt; sched = (Collection&lt;SimpleEvent&gt;) iSched.next();</span>
<span class="nc" id="L176">        			schedules.addAll(buildEventList(empId.toInt(), sched, activitiesMap, startTime, endTime, user));</span>
<span class="nc" id="L177">        		}</span>
        	}

<span class="nc" id="L180">			return schedules;</span>
<span class="nc" id="L181">		} catch (BusinessWFOException ex) {</span>
<span class="nc" id="L182">			logger.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L183">			throw ex;</span>
<span class="nc" id="L184">		} catch (Exception ex) {</span>
<span class="nc" id="L185">			logger.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L186">			throw new SystemWFOException(ex.getLocalizedMessage());</span>
		}
	}

	private HashMap&lt;ID, Activity&gt; getActivitiesMap() throws BbmException, RemoteException {
<span class="nc" id="L191">		ActivityManager actMgr = WfmManagerFactory.getActivityManager(false);</span>

		//Get all active and deleted activities
<span class="nc" id="L194">		ActivityFilter activityFilter = new ActivityFilter(ActivityFilter.FILTER_NONE);</span>

<span class="nc" id="L196">		Collection activities = actMgr.findActivities(activityFilter);</span>
<span class="nc" id="L197">		HashMap activityMap = new HashMap();</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">		for (Iterator i = activities.iterator(); i.hasNext();){</span>
<span class="nc" id="L199">			Activity activity = (Activity)i.next();</span>
<span class="nc" id="L200">			activityMap.put(activity.getID(), activity);</span>
<span class="nc" id="L201">		}</span>
<span class="nc" id="L202">		return activityMap;</span>
	}

	// build the list of Events
	private ArrayList&lt;ScheduleEventsEntity&gt; buildEventList(int employeeId, Collection&lt;SimpleEvent&gt; flattenedSchedule, HashMap&lt;ID,Activity&gt; activitiesMap,
											Date startTime, Date endTime, User user) {
<span class="nc" id="L208">		ArrayList&lt;ScheduleEventsEntity&gt; rtnList = new ArrayList&lt;ScheduleEventsEntity&gt;();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">		for (SimpleEvent sEvent: flattenedSchedule ) {</span>
			// ensure that events overlap with start and end times
<span class="nc bnc" id="L211" title="All 4 branches missed.">			if (sEvent.getStartTime().before(endTime) &amp;&amp; sEvent.getEndTime().after(startTime)) {</span>
<span class="nc" id="L212">				ScheduleEventsEntity evt = new ScheduleEventsEntity();</span>

<span class="nc" id="L214">				evt.setStartTime(FormatUtils.dateToISO8601SecPrecisionString(sEvent.getStartTime()));</span>
<span class="nc" id="L215">				evt.setEndTime(FormatUtils.dateToISO8601SecPrecisionString(sEvent.getEndTime()));</span>

<span class="nc" id="L217">				ID idAct = sEvent.getActivityID();</span>
<span class="nc" id="L218">				evt.setActivityId(idAct.toInt());</span>
<span class="nc" id="L219">				Activity activity = activitiesMap.get(idAct);</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">				if (activity != null) {</span>
<span class="nc" id="L221">					evt.setActivityName(activity.getName());</span>
<span class="nc" id="L222">					evt.setColorCode(activity.getColor());</span>
				}

<span class="nc" id="L225">				evt.setEmployeeId(employeeId);</span>
<span class="nc" id="L226">				evt.setComments(sEvent.getDescription()); // need to check permissions ScheduleViewMH.getShowMyScheduleNote(m_context, orgID) / ScheduleViewMH.getShowOrgScheduleNote(m_context, orgID)</span>

<span class="nc" id="L228">				rtnList.add(evt);</span>
			}
<span class="nc" id="L230">		}</span>

<span class="nc" id="L232">		return rtnList;</span>
	}

	private Collection&lt;Collection&lt;SimpleEvent&gt;&gt; getFlattenedSchedule(ScheduleAccessManager schedAccessMgr, Collection&lt;ID&gt; employeeIds, Date startTime, Date endTime)
	throws BbmEJBCreateException, BbmFinderException, RemoteException {
<span class="nc" id="L237">		int eventTypeMask = com.bluepumpkin.ejb.bbm.activity.model.Event.EVENT_TYPE_ALL_CALENDAR_EVENTS</span>
						| com.bluepumpkin.ejb.bbm.activity.model.Event.EVENT_TYPE_SHIFT_ASSIGNMENT
						| com.bluepumpkin.ejb.bbm.activity.model.Event.EVENT_TYPE_SHIFT_EVENT_ASSIGNMENT;
<span class="nc" id="L240">		Collection&lt;Collection&lt;? extends Event&gt;&gt; groupSchedule = schedAccessMgr.getPublishedEventsForWorkResourcesByType(eventTypeMask,employeeIds,startTime,endTime);</span>

<span class="nc" id="L242">        Collection&lt;Collection&lt;ShiftAssignment&gt;&gt; groupShifts = ScheduleViewMH.selectGroupShifts(groupSchedule);</span>

		//--- flatten schedules
<span class="nc" id="L245">		Collection&lt;Collection&lt;SimpleEvent&gt;&gt; flattenedSchedule = ScheduleViewMH.flattenGroupSchedule(groupSchedule);</span>

		//--- mark events as overlap if they are covered by shift extensions
<span class="nc" id="L248">		Collection&lt;Collection&lt;SimpleEvent&gt;&gt; markedSchedule = ScheduleViewMH.markGroupOvertimeEvents(flattenedSchedule, groupShifts);</span>

<span class="nc" id="L250">		return markedSchedule;</span>
	}

	/**
	 * Gets the net staffing ribbon for the employee over the specified time range.
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	@Override
	public RibbonResponseEntity getRibbon(RequestContext context, ID employeeID, TimeRange timeRange)  // NOSONAR
			throws BusinessWFOException, SystemWFOException { // NOSONAR
		try {
<span class="nc" id="L261">			RibbonResponseEntity response = new RibbonResponseEntity();</span>
<span class="nc" id="L262">			TimeZone tz = context.getViewingTimeZone();</span>

<span class="nc" id="L264">			Organization organization = ScheduleViewMH.getOrganizationForEmp(context, employeeID);</span>
<span class="nc" id="L265">			OrganizationSetting orgSetting = ScheduleViewPM.getOrgSetting(organization.getID());</span>
<span class="nc" id="L266">			boolean allowNewShifts = orgSetting.getEnableCustomShiftRequests();</span>
<span class="nc" id="L267">			boolean allowShiftChanges = orgSetting.getAllowShiftChangeRequests();</span>
<span class="nc bnc" id="L268" title="All 4 branches missed.">			boolean csReqEnabled = (allowNewShifts || allowShiftChanges);</span>
<span class="nc" id="L269">			boolean vtoReqEnabled = orgSetting.getAgentTimeOffWorkflowActive();</span>

			// check priv / settings
<span class="nc bnc" id="L272" title="All 4 branches missed.">			boolean isNetStaffingRibbonEnabled = csReqEnabled || vtoReqEnabled;</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">			if (!isNetStaffingRibbonEnabled) {</span>
<span class="nc" id="L274">				throwUnauthorizedRequest(context);</span>
			}

<span class="nc" id="L277">			TimeRange paddedTimeRange = getPaddedTimeRange(timeRange, tz);</span>
<span class="nc" id="L278">			CalendarRange aDay = DateTimeUtil.makeDayRange(timeRange.getStartDate(), tz);</span>

			// always showNetStaffing regardless of user preference setting
<span class="nc" id="L281">			boolean showNetStaffing = true;</span>
<span class="nc" id="L282">			Map&lt;String, Object&gt; theData = ScheduleViewMH.getPersonalData(context, ScheduleViewPM.VIEW_TYPE_MY_GRAPH, paddedTimeRange,</span>
					employeeID, employeeID, showNetStaffing);
<span class="nc" id="L284">			Collection&lt;SimpleEvent&gt; schedule = (Collection&lt;SimpleEvent&gt;) theData.get(ScheduleViewMH.SCHEDULE_ITEMS_KEY);</span>
<span class="nc" id="L285">			HashMap&lt;ID, Activity&gt; activities = (HashMap&lt;ID, Activity&gt;) theData.get(ScheduleViewMH.ACTIVITIES_KEY);</span>
<span class="nc" id="L286">			Map&lt;ID, Collection&lt;ID&gt;&gt; activityMedias = (Map&lt;ID, Collection&lt;ID&gt;&gt;) theData.get(ScheduleViewMH.ACTIVITY_MEDIAS_KEY);</span>
<span class="nc" id="L287">			Map&lt;ID, Collection&lt;ID&gt;&gt; activityQueues = (Map&lt;ID, Collection&lt;ID&gt;&gt;) theData.get(ScheduleViewMH.ACTIVITY_QUEUES_KEY);</span>
<span class="nc" id="L288">			boolean isPublished = ScheduleViewPM.isPublished(theData);</span>

			// Net staffing wants start of day so make sure it matches - otherwise the data will be incorrect
			// 0500 starts with the next day's data while the day starts at 0400
<span class="nc" id="L292">			TimeRange fullDayTimeRange = new TimeRange(DateTimeUtil.getDayStart(timeRange.getStartDate(), tz),</span>
<span class="nc" id="L293">					DateTimeUtil.getDayStart(timeRange.getEndDate(), tz));</span>

<span class="nc" id="L295">			Date now = ScheduleViewPM.getNowSnappedTo15MinuteInterval(tz);</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">			Date nsStart = fullDayTimeRange.getStartDate().before(now) ? now : fullDayTimeRange.getStartDate();</span>
<span class="nc" id="L297">			Calendar nsCal = Calendar.getInstance(tz);</span>
<span class="nc" id="L298">			nsCal.setTime(nsStart);</span>
<span class="nc" id="L299">			nsCal.add(Calendar.DATE, TimeInterval.DAYS_PER_WEEK);</span>
<span class="nc" id="L300">			Date nsEnd = nsCal.getTime();</span>

<span class="nc bnc" id="L302" title="All 2 branches missed.">			nsEnd = timeRange.getEndDate().before(nsEnd) ? timeRange.getEndDate() : nsEnd;</span>
			// warn the user if they requested too much
<span class="nc bnc" id="L304" title="All 2 branches missed.">			if (timeRange.getEndDate().after(nsEnd)) {</span>
<span class="nc" id="L305">				String msg = context.getLocalizer().i18n(FsWebBundleKey.BUNDLE_NAME, FsWebBundleKey.NET_STAFFING_SEVEN_DAY_LIMIT);</span>
<span class="nc" id="L306">				response.setOverMaxDays(true);</span>
<span class="nc" id="L307">				response.setOverMaxDaysMessage(msg);</span>
			}

<span class="nc" id="L310">			NetStaffingCube nsCube = ScheduleViewPM.getTimeSeriesManager(context).getNetStaffing(employeeID, nsStart, nsEnd);</span>

<span class="nc bnc" id="L312" title="All 2 branches missed.">			if (nsCube != null) {</span>
<span class="nc" id="L313">				Pair&lt;Collection&lt;WorkResourceAssignment&gt;, Map&lt;ID, Collection&lt;TimePeriod&gt;&gt;&gt; pair =</span>
<span class="nc" id="L314">						ScheduleViewPM.getOrgsAndOpenPeriodsForNetStaffingEmp(context, employeeID, nsStart, nsEnd);</span>
<span class="nc" id="L315">				Collection&lt;WorkResourceAssignment&gt; wrAssignmentsForNetStaffingEmp = pair.getFirst();</span>
<span class="nc" id="L316">				Map&lt;ID, Collection&lt;TimePeriod&gt;&gt; orgOpenPeriodsForNetStaffingEmp = pair.getSecond();</span>

<span class="nc" id="L318">				boolean dstAdjustment = false;</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">				while (!aDay.isAfter(timeRange)) {</span>
<span class="nc" id="L320">					Date startDate = aDay.getStartDate();</span>

					// aDay is midnight to midnight - but they might have requested a range starting within the day
<span class="nc bnc" id="L323" title="All 2 branches missed.">					if (startDate.before(timeRange.getStartDate())) { // NOSONAR</span>
<span class="nc" id="L324">						startDate = timeRange.getStartDate();</span>
					}

					// net staffing is only valid from &quot;now&quot; on
<span class="nc bnc" id="L328" title="All 2 branches missed.">					startDate = now.after(startDate) ? now : startDate;</span>
<span class="nc" id="L329">					Calendar eventStartCal = Calendar.getInstance(tz);</span>
<span class="nc" id="L330">					eventStartCal.setTime(startDate);</span>

<span class="nc" id="L332">					Calendar eventEndCal = Calendar.getInstance(tz);</span>
<span class="nc" id="L333">					eventEndCal.setTime(eventStartCal.getTime());</span>
<span class="nc" id="L334">					eventEndCal.add(Calendar.MINUTE, INTERVAL);</span>

<span class="nc bnc" id="L336" title="All 2 branches missed.">					if (!startDate.before(timeRange.getStartDate())) { // NOSONAR</span>
<span class="nc" id="L337">						RibbonDayEntity dayEntity = new RibbonDayEntity();</span>
<span class="nc" id="L338">						response.getDays().add(dayEntity);</span>
<span class="nc" id="L339">						dayEntity.setStartTime(FormatUtils.dateToISO8601SecPrecisionString(startDate));</span>

<span class="nc" id="L341">						List&lt;int[]&gt; intervals = dayEntity.getIntervals();</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">						while (eventStartCal.getTime().before(aDay.getEndDate())) {</span>
<span class="nc" id="L343">							int[] intervalValues = ScheduleViewPM.getPersonalizedNetStaffingValue(nsCube, eventStartCal, eventEndCal,</span>
									schedule,
									csReqEnabled, vtoReqEnabled, isPublished, activities, activityMedias, activityQueues,
									wrAssignmentsForNetStaffingEmp, orgOpenPeriodsForNetStaffingEmp);

<span class="nc" id="L348">							intervals.add(intervalValues);</span>

<span class="nc" id="L350">							eventStartCal.add(Calendar.MINUTE, INTERVAL);</span>
<span class="nc" id="L351">							eventEndCal.add(Calendar.MINUTE, INTERVAL);</span>
<span class="nc" id="L352">						}</span>

<span class="nc" id="L354">						dstAdjustment = ScheduleViewUtil.nextDay(aDay, dstAdjustment);</span>
					}
<span class="nc" id="L356">				}</span>
			}

<span class="nc" id="L359">			return response;</span>
<span class="nc" id="L360">		} catch (BusinessWFOException ex) {</span>
<span class="nc" id="L361">			logger.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L362">			throw ex;</span>
<span class="nc" id="L363">		} catch (Exception ex) {</span>
<span class="nc" id="L364">			logger.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L365">			throw new SystemWFOException(ex.getLocalizedMessage());</span>
		}
	}

	/**
	 * -1 to startDate and +1 to endDate
	 */
	private TimeRange getPaddedTimeRange(TimeRange timeRange, TimeZone tz) {
<span class="nc" id="L373">		Calendar cal = Calendar.getInstance(tz);</span>
<span class="nc" id="L374">		cal.setTime(timeRange.getStartDate());</span>
<span class="nc" id="L375">		cal.add(Calendar.DATE, -1);</span>
<span class="nc" id="L376">		Date paddedStartDate = cal.getTime();</span>

<span class="nc" id="L378">		cal.setTime(timeRange.getEndDate());</span>
<span class="nc" id="L379">		cal.add(Calendar.DATE, 1);</span>
<span class="nc" id="L380">		return new TimeRange(paddedStartDate, cal.getTime());</span>
	}

	/**
	 * Throws a BusinessWFOException for an unauthorized request.
	 */
	public static void throwUnauthorizedRequest(RequestContext context) throws BusinessWFOException {
<span class="nc" id="L387">		String msg = context.getLocalizer().i18n(UIFWebBundleKey.BUNDLE_NAME, UIFWebBundleKey.UNAUTHORIZED_REQUEST);</span>
<span class="nc" id="L388">		throw new BusinessWFOException(msg, Response.Status.FORBIDDEN);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>