<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PulseNotificationRuleChecker.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.pulse.ejb</a> &gt; <span class="el_source">PulseNotificationRuleChecker.java</span></div><h1>PulseNotificationRuleChecker.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.pulse.ejb;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:  This notification rule checker checks whether the actual pulse
 *               has deviated from a given specified range or forecast or service goal
 *               resources
 * Copyright:    Copyright (c) 2004
 * Company:      Blue Pumpkin Software, inc
 * @author       Sheng Song
 * @version 1.0
 */
import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;

import org.w3c.dom.Document;
import org.w3c.dom.Element;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.LocaleContext;
import com.bluepumpkin.common.localization.LocalizationManager;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.l10n.BbmEjbBundleKey;
import com.bluepumpkin.ejb.bbm.localization.DefaultLocalizationManager;
import com.bluepumpkin.ejb.bbm.notifyrules.model.ActionDetail;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRule;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleChecker;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleParameter;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleTemplate;
import com.bluepumpkin.ejb.bbm.pulse.model.TraceChart;
import com.bluepumpkin.ejb.bbm.pulse.model.TrackingView;
import com.bluepumpkin.ejb.bbm.timeseries.model.AggrForecastedTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.AggrRequiredTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.ForecastTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.PredictTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.ServiceGoalTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.Trace;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceOperator;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceOperatorAdapter;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceUtil;
import com.bluepumpkin.ejb.bbm.workload.ejb.WorkloadManager;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workload.model.QueueSelection;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.verint.ejb.wfm.WfmManagerFactory;

<span class="nc" id="L69">public class PulseNotificationRuleChecker implements NotifyRuleChecker</span>
{
	protected Localizer m_localizer;
<span class="nc" id="L72">	private WorkloadManager m_WorkloadManager = null;</span>
<span class="nc" id="L73">	private CampaignManager m_CampaignManager = null;</span>
<span class="nc" id="L74">	private TrackingManager m_TrackingManager = null;</span>
<span class="nc" id="L75">	private DocumentBuilder m_parser = null;</span>

<span class="nc" id="L77">	private static Category m_cat = Log.initCategory(PulseNotificationRuleChecker.class.getName());</span>

<span class="nc" id="L79">	private static final ID CMBQUEID = new ID(-1);</span>
	private static final short IN_BETWEEN = 0;
	private static final short NOT_BETWEEN = 1;

	private static final short PCT_DEVIATION = 0;

	private static final short DIF_GREATER = 0;
	private static final short DIF_LESSER = 1;
	private static final short DIF_DEVIATE = 2;

	private static final short TIME_METRIC_MINUTES = 0;
	private static final short TIME_METRIC_HOURS = 1;
	private static final short TIME_METRIC_DAYS = 2;

	private static final short COMBINE_CLAUSE_INDIVIDUAL=0;
	private static final short COMBINE_CLAUSE_COMBINED=1;
	//Sankar - Finding the org name so that the org name can also be added in the
	//alert rule notification which will be sent.
<span class="nc" id="L97">	private String organizationName = null; </span>
	/**
	 * Initialize method called once per notify rule checker type to perform
	 * one-time initialization
	 */
	public void init() throws Exception
	{
<span class="nc" id="L104">		m_WorkloadManager = WfmManagerFactory.getWorkloadManager();</span>
<span class="nc" id="L105">		m_CampaignManager = WfmManagerFactory.getCampaignManager();</span>
<span class="nc" id="L106">		m_TrackingManager = WfmManagerFactory.getPulseTrackingManager();</span>
<span class="nc" id="L107">		DocumentBuilderFactory docBuilderFactory = DocumentBuilderFactory.newInstance();</span>
<span class="nc" id="L108">		docBuilderFactory.setValidating(false);</span>
<span class="nc" id="L109">		m_parser = docBuilderFactory.newDocumentBuilder();</span>
<span class="nc" id="L110">		m_localizer = DefaultLocalizationManager.getDefaultInstance().getLocalizer();</span>
<span class="nc" id="L111">		Trace.setVolumeEnabled( BbmManagerFactory.getDBConfigManager().getBooleanValue(ConfigKey.VOLUME_HANDLED_ENABLE));</span>
<span class="nc" id="L112">		Trace.setAlwaysUseVHInsteadOfCV(BbmManagerFactory.getDBConfigManager().getBooleanValue(ConfigKey.ALWAYS_USE_VOLUME_HANDLED));</span>

<span class="nc" id="L114">	}</span>

	/**
	 * Tests whether this rule &quot;fires&quot;. If so, returns an action detail object
	 *
	 */
	public ActionDetail testRule(NotifyRule notifyRule, Object actionContext) throws Exception
	{
<span class="nc" id="L122">        Trace.setVolumeEnabled( BbmManagerFactory.getDBConfigManager().getBooleanValue(ConfigKey.VOLUME_HANDLED_ENABLE));</span>
<span class="nc" id="L123">		Trace.setAlwaysUseVHInsteadOfCV(BbmManagerFactory.getDBConfigManager().getBooleanValue(ConfigKey.ALWAYS_USE_VOLUME_HANDLED));</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L125">			m_cat.debug(&quot;ENTER: testRule&quot;);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">			if (notifyRule != null)</span>
<span class="nc" id="L127">				m_cat.debug(&quot;Checking rule &quot;+notifyRule+&quot; with parameters &quot;+notifyRule.getRuleParameters());</span>
		}
<span class="nc" id="L129">		ActionDetail actionDetail = null;</span>

<span class="nc" id="L131">		ID campaignID = notifyRule.getScopeID();</span>
<span class="nc" id="L132">		ID templateID = notifyRule.getTemplateID();</span>

		/*
		 * Sankar - We are using the same Notify Rule Implementation class for the new 'Actual Statistics Out Of Range' rule
		 * created for organization. The difference in implementation comes when the user selects notify by role for email or
		 * popup notification.
		 *
		 * In the current implementation, we are using the queue ids or the campaign id as the ActionDetail object's key.
		 * But when the same rule is used in Organization mode, we will have to modify this with an employee id for that
		 * Org. In the Combined queue mode, we only need to find one employee id but in the individual queue mode, we will
		 * have to identify multiple employee ids belonging to this org or use some dummy employee ids.
		 */
<span class="nc" id="L144">		ArrayList wrkResourceIDs = null;</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">		if(templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID)) {</span>
			//Get the employee IDs
<span class="nc" id="L147">			wrkResourceIDs = getEmployeesForOrg(notifyRule);</span>
		}

<span class="nc" id="L150">		short traceType = -1;</span>
<span class="nc" id="L151">		short diffType = -1;</span>
<span class="nc" id="L152">		int deviation = -1;</span>
<span class="nc" id="L153">		short deviationClause = 0;</span>
<span class="nc" id="L154">		short metricType = -1;</span>
<span class="nc" id="L155">		int lookBack = -1;</span>
<span class="nc" id="L156">		short timeType = 0;</span>
<span class="nc" id="L157">		boolean  isCombined = false;</span>
<span class="nc" id="L158">		QueueSelection queueIDSel = null;</span>

<span class="nc" id="L160">		short betweenClause = 0;</span>
<span class="nc" id="L161">		int val1 = -1;</span>
<span class="nc" id="L162">		int val2 = -1;</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">		for (Iterator itRuleParameter = notifyRule.getRuleParameters().iterator(); itRuleParameter.hasNext();)</span>
		{
<span class="nc" id="L165">			NotifyRuleParameter notifyRuleParameter = (NotifyRuleParameter) itRuleParameter.next();</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;MetricType&quot;)) {</span>
<span class="nc" id="L167">				traceType = ((Integer)notifyRuleParameter.getValue()).shortValue();</span>
<span class="nc" id="L168">				continue;</span>
			}
<span class="nc bnc" id="L170" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;diff&quot;)) {</span>
<span class="nc" id="L171">				diffType = ((Integer)notifyRuleParameter.getValue()).shortValue();</span>
<span class="nc" id="L172">				continue;</span>
			}
<span class="nc bnc" id="L174" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;DeviationValue&quot;)) {</span>
<span class="nc" id="L175">				deviation = ((Integer)notifyRuleParameter.getValue()).intValue();</span>
<span class="nc" id="L176">				continue;</span>
			}
<span class="nc bnc" id="L178" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;LookBack&quot;)) {</span>
<span class="nc" id="L179">				lookBack = ((Integer) notifyRuleParameter.getValue()).intValue();</span>
<span class="nc" id="L180">				continue;</span>
			}
<span class="nc bnc" id="L182" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;TimeMetric&quot;)) {</span>
<span class="nc" id="L183">				timeType = ((Integer) notifyRuleParameter.getValue()).shortValue();</span>
<span class="nc" id="L184">				continue;</span>
			}
<span class="nc bnc" id="L186" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;DeviationClause&quot;)) {</span>
<span class="nc" id="L187">				deviationClause = ((Integer) notifyRuleParameter.getValue()).shortValue();</span>
<span class="nc" id="L188">				continue;</span>
			}
<span class="nc bnc" id="L190" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;MetricType_SEC&quot;)) {</span>
<span class="nc" id="L191">				metricType = ((Integer) notifyRuleParameter.getValue()).shortValue();</span>
<span class="nc" id="L192">				continue;</span>
			}
<span class="nc bnc" id="L194" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;Queue&quot;))</span>
			{
<span class="nc" id="L196">				queueIDSel = (QueueSelection) notifyRuleParameter.getValue();</span>
<span class="nc" id="L197">				continue;</span>
			}
<span class="nc bnc" id="L199" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;CombineClause&quot;)) {</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">				isCombined = ((Integer) notifyRuleParameter.getValue()).intValue()==COMBINE_CLAUSE_COMBINED;</span>
<span class="nc" id="L201">				continue;</span>
			}
			// for Actual out of range, additional parameters are needed
<span class="nc bnc" id="L204" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;BetweenClause&quot;)) {</span>
<span class="nc" id="L205">				betweenClause = ((Integer) notifyRuleParameter.getValue()).shortValue();</span>
<span class="nc" id="L206">				continue;</span>
			}
<span class="nc bnc" id="L208" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;Value1&quot;)) {</span>
<span class="nc" id="L209">				val1 = ((Integer) notifyRuleParameter.getValue()).intValue();</span>
<span class="nc" id="L210">				continue;</span>
			}
<span class="nc bnc" id="L212" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;Value2&quot;)) {</span>
<span class="nc" id="L213">				val2 = ((Integer) notifyRuleParameter.getValue()).intValue();</span>
<span class="nc" id="L214">				continue;</span>
			}
<span class="nc" id="L216">		}</span>
		// adjuste val1/val2 automatically
<span class="nc bnc" id="L218" title="All 2 branches missed.">		if (val1 &gt; val2) {</span>
<span class="nc" id="L219">			val1 = val2;</span>
<span class="nc" id="L220">			val2 = val1;</span>
		}
		// validation
<span class="nc bnc" id="L223" title="All 2 branches missed."> 		if (lookBack == -1)</span>
<span class="nc" id="L224">			throw new BbmException(&quot;Bad Notify Rule: missing lookback window&quot;);</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">		if (queueIDSel == null)</span>
<span class="nc" id="L226">			throw new BbmException(&quot;Bad Notify Rule: missing Queue selections&quot;);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">		if (traceType == -1)</span>
<span class="nc" id="L228">			throw new BbmException(&quot;Bad Notify Rule: missing trace type&quot;);</span>
		// then check tracking manager to obtain data back
<span class="nc" id="L230">		long lookBackMillis = lookBack*getTimeUnit(timeType);</span>
<span class="nc" id="L231">		Date curDate = new Date();</span>
<span class="nc" id="L232">        Date lookBackDate = new Date(curDate.getTime()-lookBackMillis);</span>
        // always snap back first
<span class="nc" id="L234">        lookBackDate = TraceUtil.snapDate(lookBackDate);</span>
        
<span class="nc bnc" id="L236" title="All 2 branches missed.">		if (lookBackMillis &gt; Trace.INTERVAL_IN_MILLIS) {</span>
			//fix bug 29526 - Angela
<span class="nc" id="L238">			curDate = new Date(System.currentTimeMillis() - Trace.INTERVAL_IN_MILLIS);</span>
		}

		// convert QueueIDCol into cpgID, mediaID, queueIDCol
<span class="nc" id="L242">		Collection qIDCol = new ArrayList();</span>

<span class="nc" id="L244">		ID cpgID = queueIDSel.getCampaignID();</span>
<span class="nc" id="L245">		ID mediaID = queueIDSel.getMediaID();</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">		if (queueIDSel.getQueueIDs() != null) {</span>
<span class="nc" id="L247">			Iterator qIt = queueIDSel.getQueueIDs().iterator();</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">			while (qIt.hasNext()) {</span>
<span class="nc" id="L249">				qIDCol.add(qIt.next());</span>
			}
		}

<span class="nc" id="L253">		HashMap cubeMap = null;</span>
<span class="nc" id="L254">		TrackingView tv = getTrackingView(templateID, traceType, metricType, isCombined);</span>
<span class="nc" id="L255">		Date loadDate = lookBackDate;</span>
<span class="nc" id="L256">		short start = 0;</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">		if (templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALVSSERVICEGOAL_ID)) {</span>
			// if need load SG, need move date to previous hour's boundary
<span class="nc" id="L259">			Calendar cal = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L260">			cal.setTime(lookBackDate);</span>
<span class="nc" id="L261">			start = (short)(cal.get(Calendar.MINUTE)/Trace.INTERVAL);</span>
<span class="nc" id="L262">			cal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L263">			cal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L264">			cal.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L265">			loadDate = cal.getTime();</span>
		}
<span class="nc bnc" id="L267" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L268">			m_cat.debug(&quot;Rule is checking from &quot;+lookBackDate+&quot; to &quot;+curDate+&quot; and load from &quot;+loadDate);</span>
		}
<span class="nc bnc" id="L270" title="All 4 branches missed.">		if (qIDCol != null &amp;&amp; !qIDCol.isEmpty()) {</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">			if (templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ID) ||</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">					templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID)) {</span>
				// For actual out of range, we ignore campaign ID.
<span class="nc" id="L274">				cubeMap = m_TrackingManager.getTraceCubesByTrackingView(tv, null, qIDCol, loadDate, curDate);</span>
			} else {
<span class="nc" id="L276">				cubeMap = m_TrackingManager.getTraceCubesByTrackingView(tv, cpgID, qIDCol, loadDate, curDate);</span>
			}
		} else {
<span class="nc" id="L279">			cubeMap = m_TrackingManager.getCombineTraceCubesByTrackingView(tv, cpgID, mediaID, loadDate, curDate);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">			if (!isCombined) {</span>
				// Combined Queue but need check individually
<span class="nc" id="L282">				qIDCol.addAll(cubeMap.keySet());</span>
<span class="nc" id="L283">				qIDCol.remove(CMBQUEID);</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">				if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L285">					m_cat.debug(&quot;Picked a combined queue, and check on individual level, so queues list is &quot;+qIDCol);</span>
				}
			}
		}
<span class="nc bnc" id="L289" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L290">			m_cat.debug(&quot;Return cubeMap is &quot;+cubeMap);</span>
		}
		// now prepare for XML result
<span class="nc" id="L293">		String campaignName = null;</span>
<span class="nc" id="L294">		String mediaName = null;</span>
<span class="nc" id="L295">		Map queIDNameMap = null;</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">		if (cpgID != null) {</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">			if(!templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID))</span>
<span class="nc" id="L298">				campaignName = m_CampaignManager.getCampaignByID(cpgID).getName();</span>
		}
<span class="nc bnc" id="L300" title="All 2 branches missed.">		if (mediaID != null) {</span>
<span class="nc" id="L301">			mediaName = m_WorkloadManager.getMediaByID(mediaID).getName();</span>
		}
<span class="nc bnc" id="L303" title="All 2 branches missed.">		if (qIDCol != null) {</span>
<span class="nc" id="L304">			queIDNameMap = m_WorkloadManager.getQueueNamesByIDs(qIDCol);</span>
		}
<span class="nc bnc" id="L306" title="All 2 branches missed.">		if (isCombined) {</span>
			// combined mode
<span class="nc" id="L308">			Document doc = m_parser.newDocument();</span>
<span class="nc" id="L309">			Element xmlRoot = doc.createElement(&quot;PulseAlert&quot;);</span>
<span class="nc" id="L310">			doc.appendChild(xmlRoot);</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">			if (campaignName != null) {</span>
<span class="nc" id="L312">				Element xmlCampaign = doc.createElement(&quot;Campaign&quot;);</span>
<span class="nc" id="L313">				xmlRoot.appendChild(xmlCampaign);</span>
<span class="nc" id="L314">				Element xmlCpgName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L315">				xmlCpgName.appendChild(doc.createTextNode(campaignName));</span>
<span class="nc" id="L316">				xmlCampaign.appendChild(xmlCpgName);</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">				if (mediaName != null) {</span>
<span class="nc" id="L318">					Element xmlMedia = doc.createElement(&quot;Media&quot;);</span>
<span class="nc" id="L319">					xmlRoot.appendChild(xmlMedia);</span>
<span class="nc" id="L320">					Element xmlMediaName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L321">					xmlMediaName.appendChild(doc.createTextNode(mediaName));</span>
<span class="nc" id="L322">					xmlMedia.appendChild(xmlMediaName);</span>
				}
			}
<span class="nc bnc" id="L325" title="All 4 branches missed.">			if(organizationName != null &amp;&amp; templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID)) {</span>
<span class="nc" id="L326">				Element xmlCampaign = doc.createElement(&quot;Organization&quot;);</span>
<span class="nc" id="L327">				xmlRoot.appendChild(xmlCampaign);</span>
<span class="nc" id="L328">				Element xmlCpgName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L329">				xmlCpgName.appendChild(doc.createTextNode(organizationName));</span>
<span class="nc" id="L330">				xmlCampaign.appendChild(xmlCpgName);</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">				if (mediaName != null) {</span>
<span class="nc" id="L332">					Element xmlMedia = doc.createElement(&quot;Media&quot;);</span>
<span class="nc" id="L333">					xmlRoot.appendChild(xmlMedia);</span>
<span class="nc" id="L334">					Element xmlMediaName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L335">					xmlMediaName.appendChild(doc.createTextNode(mediaName));</span>
<span class="nc" id="L336">					xmlMedia.appendChild(xmlMediaName);</span>
				}
			}

<span class="nc bnc" id="L340" title="All 4 branches missed.">			if (queIDNameMap != null &amp;&amp; !queIDNameMap.isEmpty()) {</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">				for (Iterator it = queIDNameMap.keySet().iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L342">					ID queueID = (ID)it.next();</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">					if (queueID.equals(CMBQUEID))</span>
<span class="nc" id="L344">						continue;</span>
<span class="nc" id="L345">					String queueName = (String)queIDNameMap.get(queueID);</span>
<span class="nc" id="L346">					Element xmlQueue = doc.createElement(&quot;Queue&quot;);</span>
<span class="nc" id="L347">					xmlRoot.appendChild(xmlQueue);</span>
<span class="nc" id="L348">					Element xmlID = doc.createElement(&quot;ID&quot;);</span>
<span class="nc" id="L349">					xmlID.appendChild(doc.createTextNode(queueID.toString()));</span>
<span class="nc" id="L350">					xmlQueue.appendChild(xmlID);</span>
<span class="nc" id="L351">					Element xmlName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L352">					xmlName.appendChild(doc.createTextNode(queueName));</span>
<span class="nc" id="L353">					xmlQueue.appendChild(xmlName);</span>
<span class="nc" id="L354">				}</span>
			}
<span class="nc" id="L356">			TraceCube[] resCubes = new TraceCube[getCubeNums(templateID)];</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">			if (cubeMap.containsKey(CMBQUEID)) {</span>
				// if it is a combined queue, directly use CMBQUEID from backend
<span class="nc" id="L359">				TraceCube[] queCubes = (TraceCube[])cubeMap.get(CMBQUEID);</span>
<span class="nc" id="L360">				TraceCube[] filteredCubes = filterCube(templateID, queCubes, traceType);</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">				for (int i=0; i&lt;resCubes.length; i++) {</span>
<span class="nc" id="L362">					resCubes[i] = filteredCubes[i];</span>
				}
<span class="nc" id="L364">			} else {</span>
<span class="nc" id="L365">				TraceCube[][] rawCubes = new TraceCube[getCubeNums(templateID)][cubeMap.size()];</span>
<span class="nc" id="L366">				int qNum = 0;</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">				for (Iterator it = cubeMap.keySet().iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L368">					ID qID = (ID)it.next();</span>
<span class="nc" id="L369">					TraceCube[] queCubes = (TraceCube[])cubeMap.get(qID);</span>
<span class="nc" id="L370">					TraceCube[] filteredCubes = filterCube(templateID, queCubes, traceType);</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">					for (int i=0; i&lt;filteredCubes.length; i++)</span>
<span class="nc" id="L372">						rawCubes[i][qNum] = filteredCubes[i];</span>
<span class="nc" id="L373">					qNum ++;</span>
<span class="nc" id="L374">				}</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">				for (int i=0; i&lt;resCubes.length; i++) {</span>
<span class="nc" id="L376">					resCubes[i] = TraceOperatorAdapter.combineQueue(rawCubes[i], true, false);</span>
				}
			}
<span class="nc bnc" id="L379" title="All 2 branches missed.">			if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L380">				m_cat.debug(&quot;In combined mode, now check &quot;+resCubes);</span>
			}
<span class="nc bnc" id="L382" title="All 2 branches missed.">			if (checkConflict(templateID, resCubes, traceType, diffType, start, deviation, deviationClause, metricType, betweenClause, val1, val2, doc, xmlRoot)) {</span>
<span class="nc" id="L383">				Element xmlLooBack = doc.createElement(&quot;LookBack&quot;);</span>
<span class="nc" id="L384">				xmlLooBack.appendChild(doc.createTextNode(Integer.toString(lookBack)));</span>
<span class="nc" id="L385">				xmlRoot.appendChild(xmlLooBack);</span>
<span class="nc" id="L386">				Element xmlTimeMetric = doc.createElement(&quot;TimeMetric&quot;);</span>
<span class="nc" id="L387">				xmlTimeMetric.appendChild(doc.createTextNode(Integer.toString(timeType)));</span>
<span class="nc" id="L388">				xmlRoot.appendChild(xmlTimeMetric);</span>

<span class="nc" id="L390">				actionDetail = new ActionDetail();</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">				if(templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID)) {</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">					if(wrkResourceIDs.size() &gt; 0) {</span>
<span class="nc" id="L393">						actionDetail.setDetails((ID)wrkResourceIDs.get(0), xmlRoot);</span>
					} else {
						//Setting a dummy employee id. This is because there are no employees assigned to this organization
						//or any of its parent organizations
<span class="nc" id="L397">						actionDetail.setDetails(new ID(-1), xmlRoot);</span>
					}
				} else {
<span class="nc" id="L400">					actionDetail.setDetails(campaignID, xmlRoot);</span>
				}
			}
<span class="nc" id="L403">		} else {</span>
			// check individual
			// Remove combined cube from map, as there is rule checking against predicted line
<span class="nc" id="L406">			TraceCube[] DQCubes = (TraceCube[])cubeMap.remove(CMBQUEID);</span>
<span class="nc" id="L407">			Iterator it = cubeMap.keySet().iterator();</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">			if (qIDCol != null)</span>
<span class="nc" id="L409">				it = qIDCol.iterator();</span>

<span class="nc" id="L411">			int employeeIndex = 0;</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">			while (it.hasNext()) {</span>
<span class="nc" id="L413">				ID qID = (ID)it.next();</span>
				// individual mode
<span class="nc" id="L415">				TraceCube[] queCubes = (TraceCube[])cubeMap.get(qID);</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">				if (queCubes == null) {</span>
<span class="nc" id="L417">					Queue dq = m_WorkloadManager.getQueueByID(qID);</span>
<span class="nc bnc" id="L418" title="All 4 branches missed.">					if (dq != null &amp;&amp; dq.getQueueType() == Queue.QUEUE_TYPE_DISTRIBUTED) {</span>
<span class="nc" id="L419">						queCubes = DQCubes;</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">						if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L421">							m_cat.debug(&quot;Special handle DQ mode, use presaved cubes.&quot;);</span>
						}
					}
				}
<span class="nc" id="L425">				TraceCube[] filteredCubes = filterCube(templateID, queCubes, traceType);</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">				if (filteredCubes == null) {</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">					if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L428">						m_cat.debug(&quot;Failed to retrieve data for Queue &quot;+qID);</span>
					}
					continue;
				}
<span class="nc" id="L432">				Document doc = m_parser.newDocument();</span>
<span class="nc" id="L433">				Element xmlRoot = doc.createElement(&quot;PulseAlert&quot;);</span>
<span class="nc" id="L434">				doc.appendChild(xmlRoot);</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">				if (campaignName != null) {</span>
<span class="nc" id="L436">					Element xmlCampaign = doc.createElement(&quot;Campaign&quot;);</span>
<span class="nc" id="L437">					xmlRoot.appendChild(xmlCampaign);</span>
<span class="nc" id="L438">					Element xmlCpgName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L439">					xmlCpgName.appendChild(doc.createTextNode(campaignName));</span>
<span class="nc" id="L440">					xmlCampaign.appendChild(xmlCpgName);</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">					if (mediaName != null) {</span>
<span class="nc" id="L442">						Element xmlMedia = doc.createElement(&quot;Media&quot;);</span>
<span class="nc" id="L443">						xmlRoot.appendChild(xmlMedia);</span>
<span class="nc" id="L444">						Element xmlMediaName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L445">						xmlMediaName.appendChild(doc.createTextNode(mediaName));</span>
<span class="nc" id="L446">						xmlMedia.appendChild(xmlMediaName);</span>
					}
				}
				
<span class="nc bnc" id="L450" title="All 4 branches missed.">				if(organizationName != null &amp;&amp; templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID)) {</span>
<span class="nc" id="L451">					Element xmlCampaign = doc.createElement(&quot;Organization&quot;);</span>
<span class="nc" id="L452">					xmlRoot.appendChild(xmlCampaign);</span>
<span class="nc" id="L453">					Element xmlCpgName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L454">					xmlCpgName.appendChild(doc.createTextNode(organizationName));</span>
<span class="nc" id="L455">					xmlCampaign.appendChild(xmlCpgName);</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">					if (mediaName != null) {</span>
<span class="nc" id="L457">						Element xmlMedia = doc.createElement(&quot;Media&quot;);</span>
<span class="nc" id="L458">						xmlRoot.appendChild(xmlMedia);</span>
<span class="nc" id="L459">						Element xmlMediaName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L460">						xmlMediaName.appendChild(doc.createTextNode(mediaName));</span>
<span class="nc" id="L461">						xmlMedia.appendChild(xmlMediaName);</span>
					}
				}

<span class="nc bnc" id="L465" title="All 2 branches missed.">				String queueName = queIDNameMap == null? null:(String)queIDNameMap.get(qID);</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">				if (queueName != null) {</span>
<span class="nc" id="L467">					Element xmlQueue = doc.createElement(&quot;Queue&quot;);</span>
<span class="nc" id="L468">					xmlRoot.appendChild(xmlQueue);</span>
<span class="nc" id="L469">					Element xmlID = doc.createElement(&quot;ID&quot;);</span>
<span class="nc" id="L470">					xmlID.appendChild(doc.createTextNode(qID.toString()));</span>
<span class="nc" id="L471">					xmlQueue.appendChild(xmlID);</span>
<span class="nc" id="L472">					Element xmlName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L473">					xmlName.appendChild(doc.createTextNode(queueName));</span>
<span class="nc" id="L474">					xmlQueue.appendChild(xmlName);</span>
				}
<span class="nc bnc" id="L476" title="All 2 branches missed.">				if (checkConflict(templateID, filteredCubes, traceType, diffType, start, deviation, deviationClause, metricType, betweenClause, val1, val2, doc, xmlRoot)) {</span>
<span class="nc" id="L477">					Element xmlLooBack = doc.createElement(&quot;LookBack&quot;);</span>
<span class="nc" id="L478">					xmlLooBack.appendChild(doc.createTextNode(Integer.toString(lookBack)));</span>
<span class="nc" id="L479">					xmlRoot.appendChild(xmlLooBack);</span>
<span class="nc" id="L480">					Element xmlTimeMetric = doc.createElement(&quot;TimeMetric&quot;);</span>
<span class="nc" id="L481">					xmlTimeMetric.appendChild(doc.createTextNode(Integer.toString(timeType)));</span>
<span class="nc" id="L482">					xmlRoot.appendChild(xmlTimeMetric);</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">					if (actionDetail == null)</span>
<span class="nc" id="L484">						actionDetail = new ActionDetail();</span>

<span class="nc bnc" id="L486" title="All 2 branches missed.">					if(templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID)) {</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">							if(wrkResourceIDs.size() &gt; employeeIndex) {</span>
<span class="nc" id="L488">								actionDetail.setDetails((ID)wrkResourceIDs.get(employeeIndex++), xmlRoot);</span>
							} else {
								//Setting a dummy employee id. This is because there are no employees assigned to this organization
								//or any of its parent organizations
<span class="nc" id="L492">								actionDetail.setDetails(new ID(employeeIndex++ * -1), xmlRoot);</span>
							}
					} else {
<span class="nc" id="L495">						actionDetail.setDetails(qID, xmlRoot);</span>
					}
				}
<span class="nc" id="L498">			}</span>
		}
<span class="nc bnc" id="L500" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">			if (actionDetail != null) m_cat.debug(actionDetail);</span>
<span class="nc" id="L502">			m_cat.debug(&quot;EXIT: testRule&quot;);</span>
		}
<span class="nc" id="L504">		return actionDetail;</span>
	}


	private static int getCubeNums(ID templateID) {
<span class="nc bnc" id="L509" title="All 2 branches missed.">		if (templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ID) ||</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">				templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID)) {</span>
<span class="nc" id="L511">			return 1;</span>
		}
<span class="nc" id="L513">		return 2;</span>
	}

	private static TraceCube[] filterCube(ID templateID, TraceCube[] cubes, short traceType) throws Exception {
<span class="nc" id="L517">		TraceCube[] res = null;</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">		if (cubes == null)</span>
<span class="nc" id="L519">			return res;</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">		if (templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ID) ||</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">				templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID)) {</span>
<span class="nc" id="L522">			res = new TraceCube[1];</span>
<span class="nc" id="L523">			res[0] = cubes[0];</span>
		} else {
<span class="nc" id="L525">			res = new TraceCube[2];</span>
<span class="nc" id="L526">			res[0] = cubes[0];</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">			if (templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALVSFORECAST_ID)) {</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">				boolean needAggrForecastedTraceCube = !(TraceUtil.META_FORECAST.supportType(traceType));</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">				if (!needAggrForecastedTraceCube) {</span>
<span class="nc" id="L530">					res[1] = cubes[1]; // Does not need the AggrForecastedTraceCube, can proceed with Forecast tracecube only.</span>
					//Now we will check if the Dependent types need AggrForecastedTraceCube
<span class="nc" id="L532">					short[] dependentTypeArray = TraceOperator.getDependentTypeForWeightedAvgForPeriod(traceType, null);</span>
<span class="nc bnc" id="L533" title="All 4 branches missed.">					for (int i = 0; dependentTypeArray!=null &amp;&amp; i &lt; dependentTypeArray.length; i++) {</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">						needAggrForecastedTraceCube = !(TraceUtil.META_FORECAST.supportType(dependentTypeArray[i]));</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">						if (needAggrForecastedTraceCube) {</span>
<span class="nc" id="L536">							break;</span>
						}
					}
				}
<span class="nc bnc" id="L540" title="All 2 branches missed.">				if (needAggrForecastedTraceCube) {</span>
                    // QC85268-QA102617
<span class="nc bnc" id="L542" title="All 2 branches missed.">                    if (cubes[2] != null) {</span>
<span class="nc" id="L543">                        res[1] = new AggrForecastedTraceCube(cubes[2].getQueueID(), cubes[2].getRawStartDate(), cubes[2].getRawEndDate(), cubes[2].getTraceTypes());</span>
<span class="nc" id="L544">                        ((AggrForecastedTraceCube)res[1]).setPredictTraceCube((PredictTraceCube)cubes[2]);</span>
<span class="nc" id="L545">                        ((AggrForecastedTraceCube)res[1]).setForecastTrace((ForecastTraceCube)cubes[1]);</span>
                    }
				}
<span class="nc" id="L548">			} else {</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">				if (cubes[3] != null) {</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">					if (cubes[3] instanceof ServiceGoalTraceCube) {</span>
<span class="nc" id="L551">						res[1] = new AggrRequiredTraceCube(cubes[3].getQueueID(), cubes[3].getRawStartDate(), cubes[3].getRawEndDate(), cubes[3].getTraceTypes());</span>
<span class="nc" id="L552">						((AggrRequiredTraceCube)res[1]).setServiceGoalTrace((ServiceGoalTraceCube)cubes[3]);</span>
					} else {
<span class="nc" id="L554">						res[1] = cubes[3];</span>
					}
<span class="nc" id="L556">					((AggrRequiredTraceCube)res[1]).setForecastTrace((ForecastTraceCube)cubes[1]);</span>
				}
			}
		}
<span class="nc" id="L560">		return res;</span>
	}

	private static boolean checkConflict(ID templateID, TraceCube[] cubes, short traceType, short diffType, short start, int deviation, short deviationClause, short metricType, short betweenClause, int val1, int val2, Document doc, Element xmlRoot) {
<span class="nc bnc" id="L564" title="All 2 branches missed.">		if (templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ID) ||</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">				templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID))</span>
<span class="nc" id="L566">			return hasConflict(cubes[0], traceType, betweenClause, val1, val2, metricType, doc, xmlRoot);</span>
<span class="nc" id="L567">		return hasConflict(cubes[0], cubes[1], traceType, diffType, start, deviation, deviationClause, metricType, doc, xmlRoot);</span>
	}

	private static boolean hasConflict(TraceCube src, TraceCube tgt, short traceType, short diffType, short start, int deviation, short deviationClause, short metricType, Document doc, Element xmlRoot) {
<span class="nc bnc" id="L571" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc bnc" id="L572" title="All 4 branches missed.">			m_cat.debug(&quot;Check conflicts on source &quot;+(src==null?&quot;null&quot;:src.toString())+&quot; vs target &quot;+(tgt==null?&quot;null&quot;:tgt.toString()));</span>
		}
<span class="nc bnc" id="L574" title="All 4 branches missed.">		if (src == null || tgt == null) {</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">			if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L576">				m_cat.debug(&quot;Rule Check result is not valid, skip rule checking.&quot;);</span>
			}
<span class="nc" id="L578">			return false;</span>
		}
<span class="nc" id="L580">		int end = src.getMaximumLength(new short[]{traceType})-1;</span>
<span class="nc" id="L581">		int end2 = tgt.getMaximumLength(new short[]{traceType})-1;</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">		end = end&gt;end2?end2:end;</span>
		// fix onyx QA 83773: we will get the forecast in the period that actual has data
		// ported from 7.6.999 , Sameet, March 2008
<span class="nc bnc" id="L585" title="All 2 branches missed.">		for (int i = start; i &lt;= end ; i++){</span>
<span class="nc" id="L586">			double[] sourceValues = src.getTraceValueD(traceType,i,i);</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">			if (sourceValues[0]&lt;0){</span>
                 // QC-128807 - ESR-4276624 [AHT forecast figures incorrect on Campaign email alert] changed -1 to interger min value
				// It is making calculation incorrect
<span class="nc" id="L590">				tgt.setTraceValue(traceType, Trace.TRACENA, i, true);</span>
			}
		}
<span class="nc bnc" id="L593" title="All 2 branches missed.">		int aggValSrc = TraceUtil.roundDouble(src==null?0:TraceOperator.aggregatePeriod(src, traceType, start, end));</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">		int aggValTgt = TraceUtil.roundDouble(tgt==null?0:TraceOperator.aggregatePeriod(tgt, traceType, start, end));</span>
<span class="nc bnc" id="L595" title="All 4 branches missed.">		if (aggValSrc &lt;0 || aggValTgt &lt;0) {</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">			if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L597">				m_cat.debug(&quot;Either src &quot;+aggValSrc+&quot; or tgt &quot;+aggValTgt+&quot; value is not valid, skip rule checking.&quot;);</span>
			}
<span class="nc" id="L599">			return false;</span>
		}
		//QA 81821 - Alert's being received during Closed Hours
		//Solution: return false incase CV is zero
		//TODO: this is a bad hack needs to be removed later Sameet 2008
<span class="nc bnc" id="L604" title="All 2 branches missed.">		if (traceType == Trace.PCA) {</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">			double aggCV    = src==null?0:TraceOperator.aggregatePeriod(src, Trace.VAR, start, end);</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">			double aggCVTGT = tgt==null?0:TraceOperator.aggregatePeriod(tgt, Trace.VAR, start, end);</span>
<span class="nc bnc" id="L607" title="All 4 branches missed.">			if (aggCV &lt;= 0||aggCVTGT&lt;=0 ) {</span>
<span class="nc" id="L608">				return false;</span>
			}

		}
		//End #81821
<span class="nc" id="L613">		double diff = (aggValSrc - aggValTgt)/getMetricUnit(metricType);</span>
<span class="nc" id="L614">		boolean conflict = false;</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">		if (deviationClause == PCT_DEVIATION) {</span>
			// only care about pct
<span class="nc" id="L617">			diff *= 100;</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">			if (aggValSrc != 0){</span>
				// Fix for Bug: 90308, Sameet,   Feb 2006
				// changed to divide by aggValTgt from aggValSrc since we want to find deviation from Forecasted Value
<span class="nc" id="L621">				diff = diff/aggValTgt;</span>
			}
		}
<span class="nc bnc" id="L624" title="All 2 branches missed.">		if (diffType == DIF_GREATER) {</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">			conflict = diff&gt;=deviation;</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">		} else if (diffType == DIF_LESSER) {</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">			conflict = -diff&gt;=deviation;</span>
		} else
<span class="nc bnc" id="L629" title="All 2 branches missed.">			conflict = Math.abs(diff) &gt;= deviation;</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">		if (conflict) {</span>
<span class="nc" id="L631">			Element xmlDev = doc.createElement(&quot;Deviation&quot;);</span>
<span class="nc" id="L632">			xmlRoot.appendChild(xmlDev);</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">			if (src.getQueueID() != null) {</span>
<span class="nc" id="L634">				Element xmlQueue = doc.createElement(&quot;QueueID&quot;);</span>
<span class="nc" id="L635">				xmlQueue.appendChild(doc.createTextNode(src.getQueueID().toString()));</span>
<span class="nc" id="L636">				xmlDev.appendChild(xmlQueue);</span>
			}
<span class="nc" id="L638">			Element xmlDeviation = doc.createElement(&quot;DeviationClause&quot;);</span>
<span class="nc" id="L639">			xmlDeviation.appendChild(doc.createTextNode(Integer.toString(deviationClause)));</span>
<span class="nc" id="L640">			xmlDev.appendChild(xmlDeviation);</span>
<span class="nc" id="L641">			Element xmlDiffType = doc.createElement(&quot;DiffType&quot;);</span>
<span class="nc" id="L642">			xmlDiffType.appendChild(doc.createTextNode(Integer.toString(diffType)));</span>
<span class="nc" id="L643">			xmlDev.appendChild(xmlDiffType);</span>
<span class="nc" id="L644">			Element xmlMetric = doc.createElement(&quot;Metric&quot;);</span>
<span class="nc" id="L645">			xmlMetric.appendChild(doc.createTextNode(Integer.toString(metricType)));</span>
<span class="nc" id="L646">			xmlDev.appendChild(xmlMetric);</span>
<span class="nc" id="L647">			Element xmlTrace = doc.createElement(&quot;TraceType&quot;);</span>
<span class="nc" id="L648">			xmlTrace.appendChild(doc.createTextNode(Integer.toString(traceType)));</span>
<span class="nc" id="L649">			xmlDev.appendChild(xmlTrace);</span>
<span class="nc" id="L650">			Element actualVal = doc.createElement(&quot;ActualVal&quot;);</span>
<span class="nc" id="L651">			actualVal.appendChild(doc.createTextNode(Integer.toString(aggValSrc)));</span>
<span class="nc" id="L652">			xmlDev.appendChild(actualVal);</span>
<span class="nc" id="L653">			Element otherVal = doc.createElement(&quot;OtherVal&quot;);</span>
<span class="nc" id="L654">			otherVal.appendChild(doc.createTextNode(Integer.toString(aggValTgt)));</span>
<span class="nc" id="L655">			xmlDev.appendChild(otherVal);</span>
<span class="nc" id="L656">			Element xmlDevaitonVal = doc.createElement(&quot;DeviationValue&quot;);</span>
<span class="nc" id="L657">			xmlDevaitonVal.appendChild(doc.createTextNode(Integer.toString(deviation)));</span>
<span class="nc" id="L658">			xmlDev.appendChild(xmlDevaitonVal);</span>
		}
<span class="nc" id="L660">		return conflict;</span>
	}

	private static boolean hasConflict(TraceCube src, short traceType, short betweenClause, int val1, int val2, short metricType, Document doc, Element xmlRoot) {
<span class="nc bnc" id="L664" title="All 2 branches missed.">		int aggValOrig = TraceUtil.roundDouble(src==null?Trace.TRACENA:TraceOperator.aggregatePeriod(src, traceType, 0, src.getMaximumLength(new short[]{traceType})-1));</span>
<span class="nc" id="L665">		double aggVal = aggValOrig/(getMetricUnit(metricType));</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">		if (aggVal &lt;0) {</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">			if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L668">				m_cat.debug(&quot;Actual value &quot;+aggVal+&quot; is not valid, skip rule checking.&quot;);</span>
			}
<span class="nc" id="L670">			return false;</span>
		}
		//QA 81821 - Alert's being received during Closed Hours
		//Solution: return false incase CV is zero
		//TODO: this is a bad hack needs to be removed later Sameet 2008
<span class="nc bnc" id="L675" title="All 2 branches missed.">		if (traceType == Trace.PCA) {</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">			double aggCV = src==null?0:TraceOperator.aggregatePeriod(src, Trace.VAR, 0, src.getMaximumLength(new short[]{Trace.CV})-1);</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">			if (aggCV &lt;= 0)</span>
<span class="nc" id="L678">				return false;</span>
		}
		//End #81821
<span class="nc bnc" id="L681" title="All 4 branches missed.">		if (traceType == Trace.ABANDONMENT &amp;&amp; metricType == 0) {</span>
			// need convert Abandonments to percentage with ACV
<span class="nc bnc" id="L683" title="All 2 branches missed.">			double aggCV = src==null?0:TraceOperator.aggregatePeriod(src, Trace.CV, 0, src.getMaximumLength(new short[]{Trace.CV})-1);</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">			if (aggCV &lt;= 0)</span>
<span class="nc" id="L685">				aggVal = 0;</span>
			else
<span class="nc" id="L687">				aggVal = aggVal*100/aggCV;</span>
		}
<span class="nc" id="L689">		boolean conflict = false;</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">		if (betweenClause == IN_BETWEEN) {</span>
<span class="nc bnc" id="L691" title="All 4 branches missed.">			if (aggVal&gt;=val1 &amp;&amp; aggVal&lt;=val2) {</span>
<span class="nc" id="L692">				conflict = true;</span>
			}
		} else {
<span class="nc bnc" id="L695" title="All 4 branches missed.">			if (aggVal&lt;val1 || aggVal&gt;val2) {</span>
<span class="nc" id="L696">				conflict = true;</span>
			}
		}
<span class="nc bnc" id="L699" title="All 2 branches missed.">		if (conflict) {</span>
<span class="nc" id="L700">			Element xmlDev = doc.createElement(&quot;Deviation&quot;);</span>
<span class="nc" id="L701">			xmlRoot.appendChild(xmlDev);</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">			if (src.getQueueID() != null) {</span>
<span class="nc" id="L703">				Element xmlQueue = doc.createElement(&quot;QueueID&quot;);</span>
<span class="nc" id="L704">				xmlQueue.appendChild(doc.createTextNode(src.getQueueID().toString()));</span>
<span class="nc" id="L705">				xmlDev.appendChild(xmlQueue);</span>
			}
<span class="nc" id="L707">			Element xmlBetween = doc.createElement(&quot;BetweenClause&quot;);</span>
<span class="nc" id="L708">			xmlBetween.appendChild(doc.createTextNode(Integer.toString(betweenClause)));</span>
<span class="nc" id="L709">			xmlDev.appendChild(xmlBetween);</span>
<span class="nc" id="L710">			Element xmlMetric = doc.createElement(&quot;Metric&quot;);</span>
<span class="nc" id="L711">			xmlMetric.appendChild(doc.createTextNode(Integer.toString(metricType)));</span>
<span class="nc" id="L712">			xmlDev.appendChild(xmlMetric);</span>
<span class="nc" id="L713">			Element xmlTrace = doc.createElement(&quot;TraceType&quot;);</span>
<span class="nc" id="L714">			xmlTrace.appendChild(doc.createTextNode(Integer.toString(traceType)));</span>
<span class="nc" id="L715">			xmlDev.appendChild(xmlTrace);</span>
<span class="nc" id="L716">			Element userVal = doc.createElement(&quot;UserVal&quot;);</span>
<span class="nc" id="L717">			userVal.appendChild(doc.createTextNode(Integer.toString(TraceUtil.roundDouble(aggVal))));</span>
<span class="nc" id="L718">			xmlDev.appendChild(userVal);</span>
<span class="nc" id="L719">			Element xmlVal1 = doc.createElement(&quot;Val1&quot;);</span>
<span class="nc" id="L720">			xmlVal1.appendChild(doc.createTextNode(Integer.toString(val1)));</span>
<span class="nc" id="L721">			xmlDev.appendChild(xmlVal1);</span>
<span class="nc" id="L722">			Element xmlVal2 = doc.createElement(&quot;Val2&quot;);</span>
<span class="nc" id="L723">			xmlVal2.appendChild(doc.createTextNode(Integer.toString(val2)));</span>
<span class="nc" id="L724">			xmlDev.appendChild(xmlVal2);</span>
		}
<span class="nc" id="L726">		return conflict;</span>
	}

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleChecker#isRuleValid(com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRule, com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleTemplate)
	 */
	public boolean isRuleValid(NotifyRule notifyRule, NotifyRuleTemplate notifyRuleTemplate) {
<span class="nc" id="L733">		ID templateID = notifyRule.getTemplateID();</span>
<span class="nc" id="L734">		int lookBack = -1;</span>
<span class="nc" id="L735">		boolean lookBackExists = false;</span>
<span class="nc" id="L736">		int timeMetric = -1;</span>
<span class="nc" id="L737">		boolean timeMetricExists = false;</span>
<span class="nc bnc" id="L738" title="All 2 branches missed.">		for (Iterator itRuleParameter = notifyRule.getRuleParameters().iterator(); itRuleParameter.hasNext();) {</span>
<span class="nc" id="L739">			NotifyRuleParameter notifyRuleParameter = (NotifyRuleParameter) itRuleParameter.next();</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;LookBack&quot;)) {</span>
<span class="nc" id="L741">				Integer value = (Integer) notifyRuleParameter.getValue();</span>
<span class="nc" id="L742">				lookBack = value.intValue();</span>
<span class="nc" id="L743">				lookBackExists = true;</span>
<span class="nc bnc" id="L744" title="All 2 branches missed.">				if (lookBack &lt; 0)</span>
<span class="nc" id="L745">					return false;</span>
			}
<span class="nc bnc" id="L747" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;TimeMetric&quot;)) {</span>
<span class="nc" id="L748">				Integer value = (Integer) notifyRuleParameter.getValue();</span>
<span class="nc" id="L749">				timeMetric = value.intValue();</span>
<span class="nc" id="L750">				timeMetricExists = true;</span>
			}
<span class="nc bnc" id="L752" title="All 2 branches missed.">			if (!(templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ID) ||</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">					templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID))</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">					&amp;&amp; (notifyRuleParameter.getName().equals(&quot;DeviationValue&quot;))) {</span>
<span class="nc" id="L755">				Integer value = (Integer) notifyRuleParameter.getValue();</span>
<span class="nc" id="L756">				int val = value.intValue();</span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">				if (val &lt; 0)</span>
<span class="nc" id="L758">					return false;</span>
			}

<span class="nc bnc" id="L761" title="All 2 branches missed.">			if ((templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ID) ||</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">					templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID))</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">					&amp;&amp; (notifyRuleParameter.getName().equals(&quot;Value1&quot;)</span>
<span class="nc bnc" id="L764" title="All 2 branches missed.">					|| notifyRuleParameter.getName().equals(&quot;Value2&quot;))) {</span>
<span class="nc" id="L765">				Integer value = (Integer) notifyRuleParameter.getValue();</span>
<span class="nc" id="L766">				int val = value.intValue();</span>
<span class="nc bnc" id="L767" title="All 2 branches missed.">				if (val &lt; 0)</span>
<span class="nc" id="L768">					return false;</span>
			}
<span class="nc" id="L770">		}</span>
<span class="nc bnc" id="L771" title="All 4 branches missed.">        if (timeMetricExists &amp;&amp; lookBackExists) {</span>
<span class="nc bnc" id="L772" title="All 2 branches missed.">			return (validateTimeMetricAndLoopBack(timeMetric, lookBack, null)==null);</span>
		}
<span class="nc" id="L774">		return true;</span>
	}

	public String validateTimeMetricAndLoopBack(int timeMetric, int lookBack,  LocaleContext localeContext){
<span class="nc bnc" id="L778" title="All 2 branches missed.">		if (timeMetric == TIME_METRIC_MINUTES) {</span>
<span class="nc bnc" id="L779" title="All 2 branches missed.">			if (lookBack &lt; Trace.INTERVAL) {</span>
<span class="nc" id="L780">				 return BbmEjbBundleKey.PULSELOOKBACK_INVALID_MINUTES;</span>
			}
<span class="nc bnc" id="L782" title="All 2 branches missed.">		} else if (timeMetric == TIME_METRIC_HOURS) {</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">             if (lookBack &lt;= 0) {</span>
<span class="nc" id="L784">             return BbmEjbBundleKey.PULSELOOKBACK_INVALID_HOURS;</span>
			 }
<span class="nc bnc" id="L786" title="All 2 branches missed.">		} else if (timeMetric == TIME_METRIC_DAYS) {</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">            if (lookBack &lt;= 0) {</span>
<span class="nc" id="L788">			return BbmEjbBundleKey.PULSELOOKBACK_INVALID_DAYS;</span>
			}
		}
<span class="nc" id="L791">		return null;</span>
	}

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleChecker#getRuleViolation(com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRule, com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleTemplate, com.bluepumpkin.common.localization.LocaleContext)
	 */
	public String getRuleViolation(NotifyRule notifyRule, NotifyRuleTemplate notifyRuleTemplate, LocaleContext localeContext)
	{
<span class="nc" id="L799">		Localizer localizer = LocalizationManager.getInstance().getLocalizer(localeContext);</span>
		//ResourceBundle resourceBundle = ResourceBundle.getBundle(BbmEjbBundleKey.BUNDLE, localeContext.getLanguageLocale());
<span class="nc" id="L801">		int lookBack = -1;</span>
<span class="nc" id="L802">		boolean lookBackExists = false;</span>
<span class="nc" id="L803">		int timeMetric = -1;</span>
<span class="nc" id="L804">		boolean timeMetricExists = false;</span>
<span class="nc" id="L805">		ID templateID = notifyRule.getTemplateID();</span>
<span class="nc bnc" id="L806" title="All 2 branches missed.">		for (Iterator itRuleParameter = notifyRule.getRuleParameters().iterator(); itRuleParameter.hasNext();)</span>
		{
<span class="nc" id="L808">			NotifyRuleParameter notifyRuleParameter = (NotifyRuleParameter) itRuleParameter.next();</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;LookBack&quot;)) {</span>
<span class="nc" id="L810">				Integer value = (Integer) notifyRuleParameter.getValue();</span>
<span class="nc" id="L811">				lookBack = value.intValue();</span>
<span class="nc" id="L812">				lookBackExists =true;</span>
<span class="nc bnc" id="L813" title="All 2 branches missed.">				if (lookBack &lt; 0) {</span>
<span class="nc" id="L814">					return localizer.i18n(BbmEjbBundleKey.BUNDLE_NAME, BbmEjbBundleKey.PULSELOOKBACK_CANNOT_BE_NEGATIVE);</span>
				}
			}
<span class="nc bnc" id="L817" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;TimeMetric&quot;)) {</span>
<span class="nc" id="L818">				Integer value = (Integer) notifyRuleParameter.getValue();</span>
<span class="nc" id="L819">				timeMetric = value.intValue();</span>
<span class="nc" id="L820">				timeMetricExists = true;</span>
			}
<span class="nc bnc" id="L822" title="All 2 branches missed.">			if (!(templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ID) ||</span>
<span class="nc bnc" id="L823" title="All 2 branches missed.">					templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID))</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">					&amp;&amp; (notifyRuleParameter.getName().equals(&quot;DeviationValue&quot;))) {</span>
<span class="nc" id="L825">				Integer value = (Integer) notifyRuleParameter.getValue();</span>
<span class="nc" id="L826">				int val = value.intValue();</span>
<span class="nc bnc" id="L827" title="All 2 branches missed.">				if (val &lt; 0) {</span>
<span class="nc" id="L828">					return localizer.i18n(BbmEjbBundleKey.BUNDLE_NAME, BbmEjbBundleKey.PULSEDEVIATION_CANNOT_BE_NEGATIVE);</span>
				}
			}

<span class="nc bnc" id="L832" title="All 2 branches missed.">			if ((templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ID) ||</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">					templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID))</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">					&amp;&amp; (notifyRuleParameter.getName().equals(&quot;Value1&quot;)</span>
<span class="nc bnc" id="L835" title="All 2 branches missed.">					|| notifyRuleParameter.getName().equals(&quot;Value2&quot;))) {</span>
<span class="nc" id="L836">				Integer value = (Integer) notifyRuleParameter.getValue();</span>
<span class="nc" id="L837">				int val = value.intValue();</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">				if (val &lt; 0) {</span>
<span class="nc" id="L839">					return localizer.i18n(BbmEjbBundleKey.BUNDLE_NAME, BbmEjbBundleKey.PULSETHRESHOLD_CANNOT_BE_NEGATIVE);</span>
				}
			}

<span class="nc" id="L843">		}</span>
<span class="nc bnc" id="L844" title="All 4 branches missed.">		if (timeMetricExists &amp;&amp; lookBackExists) {</span>
<span class="nc" id="L845">			String errorMsg= validateTimeMetricAndLoopBack(timeMetric, lookBack, localeContext);</span>
<span class="nc bnc" id="L846" title="All 2 branches missed.">			if(errorMsg!=null){</span>
<span class="nc" id="L847">				return localizer.i18n(BbmEjbBundleKey.BUNDLE_NAME, errorMsg);</span>
			}
		}
<span class="nc" id="L850">		return null;</span>
	}

	private TrackingView getTrackingView(ID templateID, short traceType, short metricType, boolean isCombined) {
<span class="nc" id="L854">		TrackingView tv = new TrackingView();</span>
<span class="nc bnc" id="L855" title="All 2 branches missed.">		if (templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALVSFORECAST_ID)) {</span>
			// forecast vs actual
<span class="nc" id="L857">			TraceChart chart = new TraceChart(traceType, TraceChart.ABSOLUTE_CHART, new short[]{TraceChart.ACTUAL_LINE, TraceChart.FORECAST_LINE}, true);</span>
<span class="nc" id="L858">			tv.setChartDefinition(Collections.singletonList(chart));</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">		} else if (templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALVSSERVICEGOAL_ID)) {</span>
			// actual vs sg
<span class="nc" id="L861">			TraceChart chart = new TraceChart(traceType, TraceChart.ABSOLUTE_CHART, new short[]{TraceChart.ACTUAL_LINE, TraceChart.REQUIRE_LINE}, true);</span>
<span class="nc" id="L862">			tv.setChartDefinition(Collections.singletonList(chart));</span>
<span class="nc bnc" id="L863" title="All 2 branches missed.">		} else if (templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ID) ||</span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">				templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID)) {</span>
			// actual
<span class="nc" id="L866">			ArrayList chartList = new ArrayList();</span>
<span class="nc" id="L867">			TraceChart chart = new TraceChart(traceType, TraceChart.ABSOLUTE_CHART, new short[]{TraceChart.ACTUAL_LINE}, true);</span>
<span class="nc" id="L868">			chartList.add(chart);</span>
			// if Abandonment is selected with Percentage points, need additional ACV
<span class="nc bnc" id="L870" title="All 4 branches missed.">			if (traceType == Trace.ABANDONMENT &amp;&amp; metricType == 0) {</span>
<span class="nc" id="L871">				TraceChart chart2 = new TraceChart(Trace.CV, TraceChart.ABSOLUTE_CHART, new short[]{TraceChart.ACTUAL_LINE}, true);</span>
<span class="nc" id="L872">				chartList.add(chart2);</span>
			}
<span class="nc" id="L874">			tv.setChartDefinition(chartList);</span>
		}
<span class="nc bnc" id="L876" title="All 2 branches missed.">		tv.setTrending(!isCombined); //Trend if     isCombined = false ; for indvl queues only</span>
<span class="nc" id="L877">		return tv;</span>
	}

	private static long getTimeUnit(short timeType) {
<span class="nc bnc" id="L881" title="All 4 branches missed.">		switch (timeType) {</span>
			case TIME_METRIC_MINUTES:
				// minutes
<span class="nc" id="L884">				return TimeZoneUtil.MINUTE_IN_MILLISECONDS_LONG;</span>
			case TIME_METRIC_HOURS:
				// hours
<span class="nc" id="L887">				return TimeZoneUtil.HOUR_IN_MILLISECONDS_LONG;</span>
			case TIME_METRIC_DAYS:
				// days
<span class="nc" id="L890">				return TimeZoneUtil.DAY_IN_MILLISECONDS_LONG;</span>
		}
<span class="nc" id="L892">		return TimeZoneUtil.MINUTE_IN_MILLISECONDS_LONG;</span>
	}

	private static double getMetricUnit(short metricType) {
<span class="nc bnc" id="L896" title="All 3 branches missed.">		switch (metricType) {</span>
			case 3:
				// minutes
<span class="nc" id="L899">				return 60;</span>
			case 4:
				// hours
<span class="nc" id="L902">				return 360;</span>
		}
<span class="nc" id="L904">		return 1;</span>
	}



	private ArrayList getEmployeesForOrg(NotifyRule notifyRule) {
<span class="nc" id="L910">		ArrayList employeeIDs = new ArrayList();</span>

<span class="nc" id="L912">		ID idOrganization = notifyRule.getScopeID();</span>
<span class="nc" id="L913">		ArrayList colOrganizationIDs = new ArrayList();</span>
<span class="nc" id="L914">		colOrganizationIDs.add(idOrganization);</span>

<span class="nc" id="L916">		WorkResourceManager m_workResourceManager = null;</span>
<span class="nc" id="L917">		Collection employees = null;</span>
<span class="nc" id="L918">		Organization org = null;</span>
		/*
		 * Sankar - If there are no employees assigned to the organization which is selected by the user,
		 * we are going to the parent organization and getting the employees associated for that organization. This
		 * continues till we find an organization with employees assigned or an organization where the parent org id
		 * is same as the current org id (Org -3001)
		 */
		try {
<span class="nc" id="L926">			m_workResourceManager = BbmManagerFactory.getWorkResourceManager();</span>
<span class="nc" id="L927">			org = m_workResourceManager.getOrganizationByID(idOrganization);</span>
<span class="nc" id="L928">			organizationName = org.getName();</span>
				
<span class="nc" id="L930">			employees = m_workResourceManager.getEmployees(colOrganizationIDs, null, Employee.DETAIL_LEVEL_EMPLOYEE_CONTACT);</span>
<span class="nc bnc" id="L931" title="All 4 branches missed.">			if(employees == null || employees.size() &lt; 1) {</span>
<span class="nc" id="L932">				 org = m_workResourceManager.getOrganizationByID(idOrganization);</span>
<span class="nc bnc" id="L933" title="All 4 branches missed.">				 while(org.getParentID() != null &amp;&amp; (org.getParentID().toInt()  != idOrganization.toInt())) {</span>
<span class="nc" id="L934">					 colOrganizationIDs.add(org.getParentID());</span>
<span class="nc" id="L935">					 idOrganization = org.getParentID();</span>
<span class="nc" id="L936">					 employees = m_workResourceManager.getEmployees(colOrganizationIDs, null, Employee.DETAIL_LEVEL_EMPLOYEE_CONTACT);</span>
<span class="nc bnc" id="L937" title="All 4 branches missed.">					 if(employees != null &amp;&amp; employees.size() &gt; 0) {</span>
<span class="nc" id="L938">						 break;</span>
					 }
<span class="nc" id="L940">					 org = m_workResourceManager.getOrganizationByID(idOrganization);</span>

				 }
			}
<span class="nc" id="L944">		} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L945">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L946">		} catch (RemoteException e) {</span>
<span class="nc" id="L947">		}</span>

<span class="nc bnc" id="L949" title="All 4 branches missed.">		if(employees == null || employees.size() &lt; 1) {</span>
<span class="nc" id="L950">			return employeeIDs;</span>
		}
<span class="nc" id="L952">		Iterator it = employees.iterator();</span>
<span class="nc bnc" id="L953" title="All 2 branches missed.">		while(it.hasNext()) {</span>
<span class="nc" id="L954">			Employee employee = (Employee)it.next();</span>
<span class="nc" id="L955">			employeeIDs.add(employee.getID());</span>
<span class="nc" id="L956">		}</span>

<span class="nc" id="L958">		return employeeIDs;</span>

	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>