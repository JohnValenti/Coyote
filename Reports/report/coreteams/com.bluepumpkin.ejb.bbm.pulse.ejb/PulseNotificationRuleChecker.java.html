<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PulseNotificationRuleChecker.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.bbm.pulse.ejb</a> &gt; <span class="el_source">PulseNotificationRuleChecker.java</span></div><h1>PulseNotificationRuleChecker.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.bbm.pulse.ejb;

/**
 * Title:        Blue Pumpkin Software Basic Business Model
 * Description:  This notification rule checker checks whether the actual pulse
 *               has deviated from a given specified range or forecast or service goal
 *               resources
 * Copyright:    Copyright (c) 2004
 * Company:      Blue Pumpkin Software, inc
 * @author       Sheng Song
 * @version 1.0
 */
import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.ResourceBundle;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;

import org.w3c.dom.Document;
import org.w3c.dom.Element;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.LocaleContext;
import com.bluepumpkin.common.localization.LocalizationManager;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.Log;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.campaign.ejb.CampaignManager;
import com.bluepumpkin.ejb.bbm.config.ConfigKey;
import com.bluepumpkin.ejb.bbm.l10n.BbmEjbBundleKey;
import com.bluepumpkin.ejb.bbm.localization.DefaultLocalizationManager;
import com.bluepumpkin.ejb.bbm.notifyrules.model.ActionDetail;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRule;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleChecker;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleParameter;
import com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleTemplate;
import com.bluepumpkin.ejb.bbm.pulse.model.TraceChart;
import com.bluepumpkin.ejb.bbm.pulse.model.TrackingView;
import com.bluepumpkin.ejb.bbm.timeseries.model.AggrForecastedTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.AggrRequiredTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.ForecastTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.PredictTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.ServiceGoalTraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.model.Trace;
import com.bluepumpkin.ejb.bbm.timeseries.model.TraceCube;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceOperator;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceOperatorAdapter;
import com.bluepumpkin.ejb.bbm.timeseries.util.TraceUtil;
import com.bluepumpkin.ejb.bbm.workload.ejb.WorkloadManager;
import com.bluepumpkin.ejb.bbm.workload.model.Queue;
import com.bluepumpkin.ejb.bbm.workload.model.QueueSelection;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.verint.ejb.wfm.WfmManagerFactory;

<span class="nc" id="L70">public class PulseNotificationRuleChecker implements NotifyRuleChecker</span>
{
	protected Localizer m_localizer;
<span class="nc" id="L73">	private WorkloadManager m_WorkloadManager = null;</span>
<span class="nc" id="L74">	private CampaignManager m_CampaignManager = null;</span>
<span class="nc" id="L75">	private TrackingManager m_TrackingManager = null;</span>
<span class="nc" id="L76">	private DocumentBuilder m_parser = null;</span>

<span class="nc" id="L78">	private static Category m_cat = Log.initCategory(PulseNotificationRuleChecker.class.getName());</span>

<span class="nc" id="L80">	private static final ID CMBQUEID = new ID(-1);</span>
	private static final short IN_BETWEEN = 0;
	private static final short NOT_BETWEEN = 1;

	private static final short PCT_DEVIATION = 0;

	private static final short DIF_GREATER = 0;
	private static final short DIF_LESSER = 1;
	private static final short DIF_DEVIATE = 2;

	private static final short TIME_METRIC_MINUTES = 0;
	private static final short TIME_METRIC_HOURS = 1;
	private static final short TIME_METRIC_DAYS = 2;

	private static final short COMBINE_CLAUSE_INDIVIDUAL=0;
	private static final short COMBINE_CLAUSE_COMBINED=1;
	//Sankar - Finding the org name so that the org name can also be added in the
	//alert rule notification which will be sent.
<span class="nc" id="L98">	private String organizationName = null; </span>
	/**
	 * Initialize method called once per notify rule checker type to perform
	 * one-time initialization
	 */
	public void init() throws Exception
	{
<span class="nc" id="L105">		m_WorkloadManager = WfmManagerFactory.getWorkloadManager();</span>
<span class="nc" id="L106">		m_CampaignManager = WfmManagerFactory.getCampaignManager();</span>
<span class="nc" id="L107">		m_TrackingManager = WfmManagerFactory.getPulseTrackingManager();</span>
<span class="nc" id="L108">		DocumentBuilderFactory docBuilderFactory = DocumentBuilderFactory.newInstance();</span>
<span class="nc" id="L109">		docBuilderFactory.setValidating(false);</span>
<span class="nc" id="L110">		m_parser = docBuilderFactory.newDocumentBuilder();</span>
<span class="nc" id="L111">		m_localizer = DefaultLocalizationManager.getDefaultInstance().getLocalizer();</span>
<span class="nc" id="L112">		Trace.setVolumeEnabled( BbmManagerFactory.getDBConfigManager().getBooleanValue(ConfigKey.VOLUME_HANDLED_ENABLE));</span>
<span class="nc" id="L113">		Trace.setAlwaysUseVHInsteadOfCV(BbmManagerFactory.getDBConfigManager().getBooleanValue(ConfigKey.ALWAYS_USE_VOLUME_HANDLED));</span>

<span class="nc" id="L115">	}</span>

	/**
	 * Tests whether this rule &quot;fires&quot;. If so, returns an action detail object
	 *
	 */
	public ActionDetail testRule(NotifyRule notifyRule, Object actionContext) throws Exception
	{
<span class="nc" id="L123">        Trace.setVolumeEnabled( BbmManagerFactory.getDBConfigManager().getBooleanValue(ConfigKey.VOLUME_HANDLED_ENABLE));</span>
<span class="nc" id="L124">		Trace.setAlwaysUseVHInsteadOfCV(BbmManagerFactory.getDBConfigManager().getBooleanValue(ConfigKey.ALWAYS_USE_VOLUME_HANDLED));</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L126">			m_cat.debug(&quot;ENTER: testRule&quot;);</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">			if (notifyRule != null)</span>
<span class="nc" id="L128">				m_cat.debug(&quot;Checking rule &quot;+notifyRule+&quot; with parameters &quot;+notifyRule.getRuleParameters());</span>
		}
<span class="nc" id="L130">		ActionDetail actionDetail = null;</span>

<span class="nc" id="L132">		ID campaignID = notifyRule.getScopeID();</span>
<span class="nc" id="L133">		ID templateID = notifyRule.getTemplateID();</span>

		/*
		 * Sankar - We are using the same Notify Rule Implementation class for the new 'Actual Statistics Out Of Range' rule
		 * created for organization. The difference in implementation comes when the user selects notify by role for email or
		 * popup notification.
		 *
		 * In the current implementation, we are using the queue ids or the campaign id as the ActionDetail object's key.
		 * But when the same rule is used in Organization mode, we will have to modify this with an employee id for that
		 * Org. In the Combined queue mode, we only need to find one employee id but in the individual queue mode, we will
		 * have to identify multiple employee ids belonging to this org or use some dummy employee ids.
		 */
<span class="nc" id="L145">		ArrayList wrkResourceIDs = null;</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">		if(templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID)) {</span>
			//Get the employee IDs
<span class="nc" id="L148">			wrkResourceIDs = getEmployeesForOrg(notifyRule);</span>
		}

<span class="nc" id="L151">		short traceType = -1;</span>
<span class="nc" id="L152">		short diffType = -1;</span>
<span class="nc" id="L153">		int deviation = -1;</span>
<span class="nc" id="L154">		short deviationClause = 0;</span>
<span class="nc" id="L155">		short metricType = -1;</span>
<span class="nc" id="L156">		int lookBack = -1;</span>
<span class="nc" id="L157">		short timeType = 0;</span>
<span class="nc" id="L158">		boolean  isCombined = false;</span>
<span class="nc" id="L159">		QueueSelection queueIDSel = null;</span>

<span class="nc" id="L161">		short betweenClause = 0;</span>
<span class="nc" id="L162">		int val1 = -1;</span>
<span class="nc" id="L163">		int val2 = -1;</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">		for (Iterator itRuleParameter = notifyRule.getRuleParameters().iterator(); itRuleParameter.hasNext();)</span>
		{
<span class="nc" id="L166">			NotifyRuleParameter notifyRuleParameter = (NotifyRuleParameter) itRuleParameter.next();</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;MetricType&quot;)) {</span>
<span class="nc" id="L168">				traceType = ((Integer)notifyRuleParameter.getValue()).shortValue();</span>
<span class="nc" id="L169">				continue;</span>
			}
<span class="nc bnc" id="L171" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;diff&quot;)) {</span>
<span class="nc" id="L172">				diffType = ((Integer)notifyRuleParameter.getValue()).shortValue();</span>
<span class="nc" id="L173">				continue;</span>
			}
<span class="nc bnc" id="L175" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;DeviationValue&quot;)) {</span>
<span class="nc" id="L176">				deviation = ((Integer)notifyRuleParameter.getValue()).intValue();</span>
<span class="nc" id="L177">				continue;</span>
			}
<span class="nc bnc" id="L179" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;LookBack&quot;)) {</span>
<span class="nc" id="L180">				lookBack = ((Integer) notifyRuleParameter.getValue()).intValue();</span>
<span class="nc" id="L181">				continue;</span>
			}
<span class="nc bnc" id="L183" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;TimeMetric&quot;)) {</span>
<span class="nc" id="L184">				timeType = ((Integer) notifyRuleParameter.getValue()).shortValue();</span>
<span class="nc" id="L185">				continue;</span>
			}
<span class="nc bnc" id="L187" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;DeviationClause&quot;)) {</span>
<span class="nc" id="L188">				deviationClause = ((Integer) notifyRuleParameter.getValue()).shortValue();</span>
<span class="nc" id="L189">				continue;</span>
			}
<span class="nc bnc" id="L191" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;MetricType_SEC&quot;)) {</span>
<span class="nc" id="L192">				metricType = ((Integer) notifyRuleParameter.getValue()).shortValue();</span>
<span class="nc" id="L193">				continue;</span>
			}
<span class="nc bnc" id="L195" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;Queue&quot;))</span>
			{
<span class="nc" id="L197">				queueIDSel = (QueueSelection) notifyRuleParameter.getValue();</span>
<span class="nc" id="L198">				continue;</span>
			}
<span class="nc bnc" id="L200" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;CombineClause&quot;)) {</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">				isCombined = ((Integer) notifyRuleParameter.getValue()).intValue()==COMBINE_CLAUSE_COMBINED;</span>
<span class="nc" id="L202">				continue;</span>
			}
			// for Actual out of range, additional parameters are needed
<span class="nc bnc" id="L205" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;BetweenClause&quot;)) {</span>
<span class="nc" id="L206">				betweenClause = ((Integer) notifyRuleParameter.getValue()).shortValue();</span>
<span class="nc" id="L207">				continue;</span>
			}
<span class="nc bnc" id="L209" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;Value1&quot;)) {</span>
<span class="nc" id="L210">				val1 = ((Integer) notifyRuleParameter.getValue()).intValue();</span>
<span class="nc" id="L211">				continue;</span>
			}
<span class="nc bnc" id="L213" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;Value2&quot;)) {</span>
<span class="nc" id="L214">				val2 = ((Integer) notifyRuleParameter.getValue()).intValue();</span>
<span class="nc" id="L215">				continue;</span>
			}
<span class="nc" id="L217">		}</span>
		// adjuste val1/val2 automatically
<span class="nc bnc" id="L219" title="All 2 branches missed.">		if (val1 &gt; val2) {</span>
<span class="nc" id="L220">			val1 = val2;</span>
<span class="nc" id="L221">			val2 = val1;</span>
		}
		// validation
<span class="nc bnc" id="L224" title="All 2 branches missed."> 		if (lookBack == -1)</span>
<span class="nc" id="L225">			throw new BbmException(&quot;Bad Notify Rule: missing lookback window&quot;);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">		if (queueIDSel == null)</span>
<span class="nc" id="L227">			throw new BbmException(&quot;Bad Notify Rule: missing Queue selections&quot;);</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">		if (traceType == -1)</span>
<span class="nc" id="L229">			throw new BbmException(&quot;Bad Notify Rule: missing trace type&quot;);</span>
		// then check tracking manager to obtain data back
<span class="nc" id="L231">		long lookBackMillis = lookBack*getTimeUnit(timeType);</span>
<span class="nc" id="L232">		Date curDate = new Date();</span>
<span class="nc" id="L233">        Date lookBackDate = new Date(curDate.getTime()-lookBackMillis);</span>
        // always snap back first
<span class="nc" id="L235">        lookBackDate = TraceUtil.snapDate(lookBackDate);</span>
        
<span class="nc bnc" id="L237" title="All 2 branches missed.">		if (lookBackMillis &gt; Trace.INTERVAL_IN_MILLIS) {</span>
			//fix bug 29526 - Angela
<span class="nc" id="L239">			curDate = new Date(System.currentTimeMillis() - Trace.INTERVAL_IN_MILLIS);</span>
		}

		// convert QueueIDCol into cpgID, mediaID, queueIDCol
<span class="nc" id="L243">		Collection qIDCol = new ArrayList();</span>

<span class="nc" id="L245">		ID cpgID = queueIDSel.getCampaignID();</span>
<span class="nc" id="L246">		ID mediaID = queueIDSel.getMediaID();</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">		if (queueIDSel.getQueueIDs() != null) {</span>
<span class="nc" id="L248">			Iterator qIt = queueIDSel.getQueueIDs().iterator();</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">			while (qIt.hasNext()) {</span>
<span class="nc" id="L250">				qIDCol.add(qIt.next());</span>
			}
		}

<span class="nc" id="L254">		HashMap cubeMap = null;</span>
<span class="nc" id="L255">		TrackingView tv = getTrackingView(templateID, traceType, metricType, isCombined);</span>
<span class="nc" id="L256">		Date loadDate = lookBackDate;</span>
<span class="nc" id="L257">		short start = 0;</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">		if (templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALVSSERVICEGOAL_ID)) {</span>
			// if need load SG, need move date to previous hour's boundary
<span class="nc" id="L260">			Calendar cal = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L261">			cal.setTime(lookBackDate);</span>
<span class="nc" id="L262">			start = (short)(cal.get(Calendar.MINUTE)/Trace.INTERVAL);</span>
<span class="nc" id="L263">			cal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L264">			cal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L265">			cal.set(Calendar.MILLISECOND, 0);</span>
<span class="nc" id="L266">			loadDate = cal.getTime();</span>
		}
<span class="nc bnc" id="L268" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L269">			m_cat.debug(&quot;Rule is checking from &quot;+lookBackDate+&quot; to &quot;+curDate+&quot; and load from &quot;+loadDate);</span>
		}
<span class="nc bnc" id="L271" title="All 4 branches missed.">		if (qIDCol != null &amp;&amp; !qIDCol.isEmpty()) {</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">			if (templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ID) ||</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">					templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID)) {</span>
				// For actual out of range, we ignore campaign ID.
<span class="nc" id="L275">				cubeMap = m_TrackingManager.getTraceCubesByTrackingView(tv, null, qIDCol, loadDate, curDate);</span>
			} else {
<span class="nc" id="L277">				cubeMap = m_TrackingManager.getTraceCubesByTrackingView(tv, cpgID, qIDCol, loadDate, curDate);</span>
			}
		} else {
<span class="nc" id="L280">			cubeMap = m_TrackingManager.getCombineTraceCubesByTrackingView(tv, cpgID, mediaID, loadDate, curDate);</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">			if (!isCombined) {</span>
				// Combined Queue but need check individually
<span class="nc" id="L283">				qIDCol.addAll(cubeMap.keySet());</span>
<span class="nc" id="L284">				qIDCol.remove(CMBQUEID);</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">				if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L286">					m_cat.debug(&quot;Picked a combined queue, and check on individual level, so queues list is &quot;+qIDCol);</span>
				}
			}
		}
<span class="nc bnc" id="L290" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L291">			m_cat.debug(&quot;Return cubeMap is &quot;+cubeMap);</span>
		}
		// now prepare for XML result
<span class="nc" id="L294">		String campaignName = null;</span>
<span class="nc" id="L295">		String mediaName = null;</span>
<span class="nc" id="L296">		Map queIDNameMap = null;</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">		if (cpgID != null) {</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">			if(!templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID))</span>
<span class="nc" id="L299">				campaignName = m_CampaignManager.getCampaignByID(cpgID).getName();</span>
		}
<span class="nc bnc" id="L301" title="All 2 branches missed.">		if (mediaID != null) {</span>
<span class="nc" id="L302">			mediaName = m_WorkloadManager.getMediaByID(mediaID).getName();</span>
		}
<span class="nc bnc" id="L304" title="All 2 branches missed.">		if (qIDCol != null) {</span>
<span class="nc" id="L305">			queIDNameMap = m_WorkloadManager.getQueueNamesByIDs(qIDCol);</span>
		}
<span class="nc bnc" id="L307" title="All 2 branches missed.">		if (isCombined) {</span>
			// combined mode
<span class="nc" id="L309">			Document doc = m_parser.newDocument();</span>
<span class="nc" id="L310">			Element xmlRoot = doc.createElement(&quot;PulseAlert&quot;);</span>
<span class="nc" id="L311">			doc.appendChild(xmlRoot);</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">			if (campaignName != null) {</span>
<span class="nc" id="L313">				Element xmlCampaign = doc.createElement(&quot;Campaign&quot;);</span>
<span class="nc" id="L314">				xmlRoot.appendChild(xmlCampaign);</span>
<span class="nc" id="L315">				Element xmlCpgName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L316">				xmlCpgName.appendChild(doc.createTextNode(campaignName));</span>
<span class="nc" id="L317">				xmlCampaign.appendChild(xmlCpgName);</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">				if (mediaName != null) {</span>
<span class="nc" id="L319">					Element xmlMedia = doc.createElement(&quot;Media&quot;);</span>
<span class="nc" id="L320">					xmlRoot.appendChild(xmlMedia);</span>
<span class="nc" id="L321">					Element xmlMediaName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L322">					xmlMediaName.appendChild(doc.createTextNode(mediaName));</span>
<span class="nc" id="L323">					xmlMedia.appendChild(xmlMediaName);</span>
				}
			}
<span class="nc bnc" id="L326" title="All 4 branches missed.">			if(organizationName != null &amp;&amp; templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID)) {</span>
<span class="nc" id="L327">				Element xmlCampaign = doc.createElement(&quot;Organization&quot;);</span>
<span class="nc" id="L328">				xmlRoot.appendChild(xmlCampaign);</span>
<span class="nc" id="L329">				Element xmlCpgName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L330">				xmlCpgName.appendChild(doc.createTextNode(organizationName));</span>
<span class="nc" id="L331">				xmlCampaign.appendChild(xmlCpgName);</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">				if (mediaName != null) {</span>
<span class="nc" id="L333">					Element xmlMedia = doc.createElement(&quot;Media&quot;);</span>
<span class="nc" id="L334">					xmlRoot.appendChild(xmlMedia);</span>
<span class="nc" id="L335">					Element xmlMediaName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L336">					xmlMediaName.appendChild(doc.createTextNode(mediaName));</span>
<span class="nc" id="L337">					xmlMedia.appendChild(xmlMediaName);</span>
				}
			}

<span class="nc bnc" id="L341" title="All 4 branches missed.">			if (queIDNameMap != null &amp;&amp; !queIDNameMap.isEmpty()) {</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">				for (Iterator it = queIDNameMap.keySet().iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L343">					ID queueID = (ID)it.next();</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">					if (queueID.equals(CMBQUEID))</span>
<span class="nc" id="L345">						continue;</span>
<span class="nc" id="L346">					String queueName = (String)queIDNameMap.get(queueID);</span>
<span class="nc" id="L347">					Element xmlQueue = doc.createElement(&quot;Queue&quot;);</span>
<span class="nc" id="L348">					xmlRoot.appendChild(xmlQueue);</span>
<span class="nc" id="L349">					Element xmlID = doc.createElement(&quot;ID&quot;);</span>
<span class="nc" id="L350">					xmlID.appendChild(doc.createTextNode(queueID.toString()));</span>
<span class="nc" id="L351">					xmlQueue.appendChild(xmlID);</span>
<span class="nc" id="L352">					Element xmlName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L353">					xmlName.appendChild(doc.createTextNode(queueName));</span>
<span class="nc" id="L354">					xmlQueue.appendChild(xmlName);</span>
<span class="nc" id="L355">				}</span>
			}
<span class="nc" id="L357">			TraceCube[] resCubes = new TraceCube[getCubeNums(templateID)];</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">			if (cubeMap.containsKey(CMBQUEID)) {</span>
				// if it is a combined queue, directly use CMBQUEID from backend
<span class="nc" id="L360">				TraceCube[] queCubes = (TraceCube[])cubeMap.get(CMBQUEID);</span>
<span class="nc" id="L361">				TraceCube[] filteredCubes = filterCube(templateID, queCubes, traceType);</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">				for (int i=0; i&lt;resCubes.length; i++) {</span>
<span class="nc" id="L363">					resCubes[i] = filteredCubes[i];</span>
				}
<span class="nc" id="L365">			} else {</span>
<span class="nc" id="L366">				TraceCube[][] rawCubes = new TraceCube[getCubeNums(templateID)][cubeMap.size()];</span>
<span class="nc" id="L367">				int qNum = 0;</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">				for (Iterator it = cubeMap.keySet().iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L369">					ID qID = (ID)it.next();</span>
<span class="nc" id="L370">					TraceCube[] queCubes = (TraceCube[])cubeMap.get(qID);</span>
<span class="nc" id="L371">					TraceCube[] filteredCubes = filterCube(templateID, queCubes, traceType);</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">					for (int i=0; i&lt;filteredCubes.length; i++)</span>
<span class="nc" id="L373">						rawCubes[i][qNum] = filteredCubes[i];</span>
<span class="nc" id="L374">					qNum ++;</span>
<span class="nc" id="L375">				}</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">				for (int i=0; i&lt;resCubes.length; i++) {</span>
<span class="nc" id="L377">					resCubes[i] = TraceOperatorAdapter.combineQueue(rawCubes[i], true, false);</span>
				}
			}
<span class="nc bnc" id="L380" title="All 2 branches missed.">			if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L381">				m_cat.debug(&quot;In combined mode, now check &quot;+resCubes);</span>
			}
<span class="nc bnc" id="L383" title="All 2 branches missed.">			if (checkConflict(templateID, resCubes, traceType, diffType, start, deviation, deviationClause, metricType, betweenClause, val1, val2, doc, xmlRoot)) {</span>
<span class="nc" id="L384">				Element xmlLooBack = doc.createElement(&quot;LookBack&quot;);</span>
<span class="nc" id="L385">				xmlLooBack.appendChild(doc.createTextNode(Integer.toString(lookBack)));</span>
<span class="nc" id="L386">				xmlRoot.appendChild(xmlLooBack);</span>
<span class="nc" id="L387">				Element xmlTimeMetric = doc.createElement(&quot;TimeMetric&quot;);</span>
<span class="nc" id="L388">				xmlTimeMetric.appendChild(doc.createTextNode(Integer.toString(timeType)));</span>
<span class="nc" id="L389">				xmlRoot.appendChild(xmlTimeMetric);</span>

<span class="nc" id="L391">				actionDetail = new ActionDetail();</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">				if(templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID)) {</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">					if(wrkResourceIDs.size() &gt; 0) {</span>
<span class="nc" id="L394">						actionDetail.setDetails((ID)wrkResourceIDs.get(0), xmlRoot);</span>
					} else {
						//Setting a dummy employee id. This is because there are no employees assigned to this organization
						//or any of its parent organizations
<span class="nc" id="L398">						actionDetail.setDetails(new ID(-1), xmlRoot);</span>
					}
				} else {
<span class="nc" id="L401">					actionDetail.setDetails(campaignID, xmlRoot);</span>
				}
			}
<span class="nc" id="L404">		} else {</span>
			// check individual
			// Remove combined cube from map, as there is rule checking against predicted line
<span class="nc" id="L407">			TraceCube[] DQCubes = (TraceCube[])cubeMap.remove(CMBQUEID);</span>
<span class="nc" id="L408">			Iterator it = cubeMap.keySet().iterator();</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">			if (qIDCol != null)</span>
<span class="nc" id="L410">				it = qIDCol.iterator();</span>

<span class="nc" id="L412">			int employeeIndex = 0;</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">			while (it.hasNext()) {</span>
<span class="nc" id="L414">				ID qID = (ID)it.next();</span>
				// individual mode
<span class="nc" id="L416">				TraceCube[] queCubes = (TraceCube[])cubeMap.get(qID);</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">				if (queCubes == null) {</span>
<span class="nc" id="L418">					Queue dq = m_WorkloadManager.getQueueByID(qID);</span>
<span class="nc bnc" id="L419" title="All 4 branches missed.">					if (dq != null &amp;&amp; dq.getQueueType() == Queue.QUEUE_TYPE_DISTRIBUTED) {</span>
<span class="nc" id="L420">						queCubes = DQCubes;</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">						if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L422">							m_cat.debug(&quot;Special handle DQ mode, use presaved cubes.&quot;);</span>
						}
					}
				}
<span class="nc" id="L426">				TraceCube[] filteredCubes = filterCube(templateID, queCubes, traceType);</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">				if (filteredCubes == null) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">					if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L429">						m_cat.debug(&quot;Failed to retrieve data for Queue &quot;+qID);</span>
					}
					continue;
				}
<span class="nc" id="L433">				Document doc = m_parser.newDocument();</span>
<span class="nc" id="L434">				Element xmlRoot = doc.createElement(&quot;PulseAlert&quot;);</span>
<span class="nc" id="L435">				doc.appendChild(xmlRoot);</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">				if (campaignName != null) {</span>
<span class="nc" id="L437">					Element xmlCampaign = doc.createElement(&quot;Campaign&quot;);</span>
<span class="nc" id="L438">					xmlRoot.appendChild(xmlCampaign);</span>
<span class="nc" id="L439">					Element xmlCpgName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L440">					xmlCpgName.appendChild(doc.createTextNode(campaignName));</span>
<span class="nc" id="L441">					xmlCampaign.appendChild(xmlCpgName);</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">					if (mediaName != null) {</span>
<span class="nc" id="L443">						Element xmlMedia = doc.createElement(&quot;Media&quot;);</span>
<span class="nc" id="L444">						xmlRoot.appendChild(xmlMedia);</span>
<span class="nc" id="L445">						Element xmlMediaName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L446">						xmlMediaName.appendChild(doc.createTextNode(mediaName));</span>
<span class="nc" id="L447">						xmlMedia.appendChild(xmlMediaName);</span>
					}
				}
				
<span class="nc bnc" id="L451" title="All 4 branches missed.">				if(organizationName != null &amp;&amp; templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID)) {</span>
<span class="nc" id="L452">					Element xmlCampaign = doc.createElement(&quot;Organization&quot;);</span>
<span class="nc" id="L453">					xmlRoot.appendChild(xmlCampaign);</span>
<span class="nc" id="L454">					Element xmlCpgName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L455">					xmlCpgName.appendChild(doc.createTextNode(organizationName));</span>
<span class="nc" id="L456">					xmlCampaign.appendChild(xmlCpgName);</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">					if (mediaName != null) {</span>
<span class="nc" id="L458">						Element xmlMedia = doc.createElement(&quot;Media&quot;);</span>
<span class="nc" id="L459">						xmlRoot.appendChild(xmlMedia);</span>
<span class="nc" id="L460">						Element xmlMediaName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L461">						xmlMediaName.appendChild(doc.createTextNode(mediaName));</span>
<span class="nc" id="L462">						xmlMedia.appendChild(xmlMediaName);</span>
					}
				}

<span class="nc bnc" id="L466" title="All 2 branches missed.">				String queueName = queIDNameMap == null? null:(String)queIDNameMap.get(qID);</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">				if (queueName != null) {</span>
<span class="nc" id="L468">					Element xmlQueue = doc.createElement(&quot;Queue&quot;);</span>
<span class="nc" id="L469">					xmlRoot.appendChild(xmlQueue);</span>
<span class="nc" id="L470">					Element xmlID = doc.createElement(&quot;ID&quot;);</span>
<span class="nc" id="L471">					xmlID.appendChild(doc.createTextNode(qID.toString()));</span>
<span class="nc" id="L472">					xmlQueue.appendChild(xmlID);</span>
<span class="nc" id="L473">					Element xmlName = doc.createElement(&quot;Name&quot;);</span>
<span class="nc" id="L474">					xmlName.appendChild(doc.createTextNode(queueName));</span>
<span class="nc" id="L475">					xmlQueue.appendChild(xmlName);</span>
				}
<span class="nc bnc" id="L477" title="All 2 branches missed.">				if (checkConflict(templateID, filteredCubes, traceType, diffType, start, deviation, deviationClause, metricType, betweenClause, val1, val2, doc, xmlRoot)) {</span>
<span class="nc" id="L478">					Element xmlLooBack = doc.createElement(&quot;LookBack&quot;);</span>
<span class="nc" id="L479">					xmlLooBack.appendChild(doc.createTextNode(Integer.toString(lookBack)));</span>
<span class="nc" id="L480">					xmlRoot.appendChild(xmlLooBack);</span>
<span class="nc" id="L481">					Element xmlTimeMetric = doc.createElement(&quot;TimeMetric&quot;);</span>
<span class="nc" id="L482">					xmlTimeMetric.appendChild(doc.createTextNode(Integer.toString(timeType)));</span>
<span class="nc" id="L483">					xmlRoot.appendChild(xmlTimeMetric);</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">					if (actionDetail == null)</span>
<span class="nc" id="L485">						actionDetail = new ActionDetail();</span>

<span class="nc bnc" id="L487" title="All 2 branches missed.">					if(templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID)) {</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">							if(wrkResourceIDs.size() &gt; employeeIndex) {</span>
<span class="nc" id="L489">								actionDetail.setDetails((ID)wrkResourceIDs.get(employeeIndex++), xmlRoot);</span>
							} else {
								//Setting a dummy employee id. This is because there are no employees assigned to this organization
								//or any of its parent organizations
<span class="nc" id="L493">								actionDetail.setDetails(new ID(employeeIndex++ * -1), xmlRoot);</span>
							}
					} else {
<span class="nc" id="L496">						actionDetail.setDetails(qID, xmlRoot);</span>
					}
				}
<span class="nc" id="L499">			}</span>
		}
<span class="nc bnc" id="L501" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">			if (actionDetail != null) m_cat.debug(actionDetail);</span>
<span class="nc" id="L503">			m_cat.debug(&quot;EXIT: testRule&quot;);</span>
		}
<span class="nc" id="L505">		return actionDetail;</span>
	}


	private static int getCubeNums(ID templateID) {
<span class="nc bnc" id="L510" title="All 2 branches missed.">		if (templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ID) ||</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">				templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID)) {</span>
<span class="nc" id="L512">			return 1;</span>
		}
<span class="nc" id="L514">		return 2;</span>
	}

	private static TraceCube[] filterCube(ID templateID, TraceCube[] cubes, short traceType) throws Exception {
<span class="nc" id="L518">		TraceCube[] res = null;</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">		if (cubes == null)</span>
<span class="nc" id="L520">			return res;</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">		if (templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ID) ||</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">				templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID)) {</span>
<span class="nc" id="L523">			res = new TraceCube[1];</span>
<span class="nc" id="L524">			res[0] = cubes[0];</span>
		} else {
<span class="nc" id="L526">			res = new TraceCube[2];</span>
<span class="nc" id="L527">			res[0] = cubes[0];</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">			if (templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALVSFORECAST_ID)) {</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">				boolean needAggrForecastedTraceCube = !(TraceUtil.META_FORECAST.supportType(traceType));</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">				if (!needAggrForecastedTraceCube) {</span>
<span class="nc" id="L531">					res[1] = cubes[1]; // Does not need the AggrForecastedTraceCube, can proceed with Forecast tracecube only.</span>
					//Now we will check if the Dependent types need AggrForecastedTraceCube
<span class="nc" id="L533">					short[] dependentTypeArray = TraceOperator.getDependentTypeForWeightedAvgForPeriod(traceType, null);</span>
<span class="nc bnc" id="L534" title="All 4 branches missed.">					for (int i = 0; dependentTypeArray!=null &amp;&amp; i &lt; dependentTypeArray.length; i++) {</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">						needAggrForecastedTraceCube = !(TraceUtil.META_FORECAST.supportType(dependentTypeArray[i]));</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">						if (needAggrForecastedTraceCube) {</span>
<span class="nc" id="L537">							break;</span>
						}
					}
				}
<span class="nc bnc" id="L541" title="All 2 branches missed.">				if (needAggrForecastedTraceCube) {</span>
                    // QC85268-QA102617
<span class="nc bnc" id="L543" title="All 2 branches missed.">                    if (cubes[2] != null) {</span>
<span class="nc" id="L544">                        res[1] = new AggrForecastedTraceCube(cubes[2].getQueueID(), cubes[2].getRawStartDate(), cubes[2].getRawEndDate(), cubes[2].getTraceTypes());</span>
<span class="nc" id="L545">                        ((AggrForecastedTraceCube)res[1]).setPredictTraceCube((PredictTraceCube)cubes[2]);</span>
<span class="nc" id="L546">                        ((AggrForecastedTraceCube)res[1]).setForecastTrace((ForecastTraceCube)cubes[1]);</span>
                    }
				}
<span class="nc" id="L549">			} else {</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">				if (cubes[3] != null) {</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">					if (cubes[3] instanceof ServiceGoalTraceCube) {</span>
<span class="nc" id="L552">						res[1] = new AggrRequiredTraceCube(cubes[3].getQueueID(), cubes[3].getRawStartDate(), cubes[3].getRawEndDate(), cubes[3].getTraceTypes());</span>
<span class="nc" id="L553">						((AggrRequiredTraceCube)res[1]).setServiceGoalTrace((ServiceGoalTraceCube)cubes[3]);</span>
					} else {
<span class="nc" id="L555">						res[1] = cubes[3];</span>
					}
<span class="nc" id="L557">					((AggrRequiredTraceCube)res[1]).setForecastTrace((ForecastTraceCube)cubes[1]);</span>
				}
			}
		}
<span class="nc" id="L561">		return res;</span>
	}

	private static boolean checkConflict(ID templateID, TraceCube[] cubes, short traceType, short diffType, short start, int deviation, short deviationClause, short metricType, short betweenClause, int val1, int val2, Document doc, Element xmlRoot) {
<span class="nc bnc" id="L565" title="All 2 branches missed.">		if (templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ID) ||</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">				templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID))</span>
<span class="nc" id="L567">			return hasConflict(cubes[0], traceType, betweenClause, val1, val2, metricType, doc, xmlRoot);</span>
<span class="nc" id="L568">		return hasConflict(cubes[0], cubes[1], traceType, diffType, start, deviation, deviationClause, metricType, doc, xmlRoot);</span>
	}

	private static boolean hasConflict(TraceCube src, TraceCube tgt, short traceType, short diffType, short start, int deviation, short deviationClause, short metricType, Document doc, Element xmlRoot) {
<span class="nc bnc" id="L572" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc bnc" id="L573" title="All 4 branches missed.">			m_cat.debug(&quot;Check conflicts on source &quot;+(src==null?&quot;null&quot;:src.toString())+&quot; vs target &quot;+(tgt==null?&quot;null&quot;:tgt.toString()));</span>
		}
<span class="nc bnc" id="L575" title="All 4 branches missed.">		if (src == null || tgt == null) {</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">			if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L577">				m_cat.debug(&quot;Rule Check result is not valid, skip rule checking.&quot;);</span>
			}
<span class="nc" id="L579">			return false;</span>
		}
<span class="nc" id="L581">		int end = src.getMaximumLength(new short[]{traceType})-1;</span>
<span class="nc" id="L582">		int end2 = tgt.getMaximumLength(new short[]{traceType})-1;</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">		end = end&gt;end2?end2:end;</span>
		// fix onyx QA 83773: we will get the forecast in the period that actual has data
		// ported from 7.6.999 , Sameet, March 2008
<span class="nc bnc" id="L586" title="All 2 branches missed.">		for (int i = start; i &lt;= end ; i++){</span>
<span class="nc" id="L587">			double[] sourceValues = src.getTraceValueD(traceType,i,i);</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">			if (sourceValues[0]&lt;0){</span>
                 // QC-128807 - ESR-4276624 [AHT forecast figures incorrect on Campaign email alert] changed -1 to interger min value
				// It is making calculation incorrect
<span class="nc" id="L591">				tgt.setTraceValue(traceType, Trace.TRACENA, i, true);</span>
			}
		}
<span class="nc bnc" id="L594" title="All 2 branches missed.">		int aggValSrc = TraceUtil.roundDouble(src==null?0:TraceOperator.aggregatePeriod(src, traceType, start, end));</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">		int aggValTgt = TraceUtil.roundDouble(tgt==null?0:TraceOperator.aggregatePeriod(tgt, traceType, start, end));</span>
<span class="nc bnc" id="L596" title="All 4 branches missed.">		if (aggValSrc &lt;0 || aggValTgt &lt;0) {</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">			if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L598">				m_cat.debug(&quot;Either src &quot;+aggValSrc+&quot; or tgt &quot;+aggValTgt+&quot; value is not valid, skip rule checking.&quot;);</span>
			}
<span class="nc" id="L600">			return false;</span>
		}
		//QA 81821 - Alert's being received during Closed Hours
		//Solution: return false incase CV is zero
		//TODO: this is a bad hack needs to be removed later Sameet 2008
<span class="nc bnc" id="L605" title="All 2 branches missed.">		if (traceType == Trace.PCA) {</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">			double aggCV    = src==null?0:TraceOperator.aggregatePeriod(src, Trace.VAR, start, end);</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">			double aggCVTGT = tgt==null?0:TraceOperator.aggregatePeriod(tgt, Trace.VAR, start, end);</span>
<span class="nc bnc" id="L608" title="All 4 branches missed.">			if (aggCV &lt;= 0||aggCVTGT&lt;=0 ) {</span>
<span class="nc" id="L609">				return false;</span>
			}

		}
		//End #81821
<span class="nc" id="L614">		double diff = (aggValSrc - aggValTgt)/getMetricUnit(metricType);</span>
<span class="nc" id="L615">		boolean conflict = false;</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">		if (deviationClause == PCT_DEVIATION) {</span>
			// only care about pct
<span class="nc" id="L618">			diff *= 100;</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">			if (aggValSrc != 0){</span>
				// Fix for Bug: 90308, Sameet,   Feb 2006
				// changed to divide by aggValTgt from aggValSrc since we want to find deviation from Forecasted Value
<span class="nc" id="L622">				diff = diff/aggValTgt;</span>
			}
		}
<span class="nc bnc" id="L625" title="All 2 branches missed.">		if (diffType == DIF_GREATER) {</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">			conflict = diff&gt;=deviation;</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">		} else if (diffType == DIF_LESSER) {</span>
<span class="nc bnc" id="L628" title="All 2 branches missed.">			conflict = -diff&gt;=deviation;</span>
		} else
<span class="nc bnc" id="L630" title="All 2 branches missed.">			conflict = Math.abs(diff) &gt;= deviation;</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">		if (conflict) {</span>
<span class="nc" id="L632">			Element xmlDev = doc.createElement(&quot;Deviation&quot;);</span>
<span class="nc" id="L633">			xmlRoot.appendChild(xmlDev);</span>
<span class="nc bnc" id="L634" title="All 2 branches missed.">			if (src.getQueueID() != null) {</span>
<span class="nc" id="L635">				Element xmlQueue = doc.createElement(&quot;QueueID&quot;);</span>
<span class="nc" id="L636">				xmlQueue.appendChild(doc.createTextNode(src.getQueueID().toString()));</span>
<span class="nc" id="L637">				xmlDev.appendChild(xmlQueue);</span>
			}
<span class="nc" id="L639">			Element xmlDeviation = doc.createElement(&quot;DeviationClause&quot;);</span>
<span class="nc" id="L640">			xmlDeviation.appendChild(doc.createTextNode(Integer.toString(deviationClause)));</span>
<span class="nc" id="L641">			xmlDev.appendChild(xmlDeviation);</span>
<span class="nc" id="L642">			Element xmlDiffType = doc.createElement(&quot;DiffType&quot;);</span>
<span class="nc" id="L643">			xmlDiffType.appendChild(doc.createTextNode(Integer.toString(diffType)));</span>
<span class="nc" id="L644">			xmlDev.appendChild(xmlDiffType);</span>
<span class="nc" id="L645">			Element xmlMetric = doc.createElement(&quot;Metric&quot;);</span>
<span class="nc" id="L646">			xmlMetric.appendChild(doc.createTextNode(Integer.toString(metricType)));</span>
<span class="nc" id="L647">			xmlDev.appendChild(xmlMetric);</span>
<span class="nc" id="L648">			Element xmlTrace = doc.createElement(&quot;TraceType&quot;);</span>
<span class="nc" id="L649">			xmlTrace.appendChild(doc.createTextNode(Integer.toString(traceType)));</span>
<span class="nc" id="L650">			xmlDev.appendChild(xmlTrace);</span>
<span class="nc" id="L651">			Element actualVal = doc.createElement(&quot;ActualVal&quot;);</span>
<span class="nc" id="L652">			actualVal.appendChild(doc.createTextNode(Integer.toString(aggValSrc)));</span>
<span class="nc" id="L653">			xmlDev.appendChild(actualVal);</span>
<span class="nc" id="L654">			Element otherVal = doc.createElement(&quot;OtherVal&quot;);</span>
<span class="nc" id="L655">			otherVal.appendChild(doc.createTextNode(Integer.toString(aggValTgt)));</span>
<span class="nc" id="L656">			xmlDev.appendChild(otherVal);</span>
<span class="nc" id="L657">			Element xmlDevaitonVal = doc.createElement(&quot;DeviationValue&quot;);</span>
<span class="nc" id="L658">			xmlDevaitonVal.appendChild(doc.createTextNode(Integer.toString(deviation)));</span>
<span class="nc" id="L659">			xmlDev.appendChild(xmlDevaitonVal);</span>
		}
<span class="nc" id="L661">		return conflict;</span>
	}

	private static boolean hasConflict(TraceCube src, short traceType, short betweenClause, int val1, int val2, short metricType, Document doc, Element xmlRoot) {
<span class="nc bnc" id="L665" title="All 2 branches missed.">		int aggValOrig = TraceUtil.roundDouble(src==null?Trace.TRACENA:TraceOperator.aggregatePeriod(src, traceType, 0, src.getMaximumLength(new short[]{traceType})-1));</span>
<span class="nc" id="L666">		double aggVal = aggValOrig/(getMetricUnit(metricType));</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">		if (aggVal &lt;0) {</span>
<span class="nc bnc" id="L668" title="All 2 branches missed.">			if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L669">				m_cat.debug(&quot;Actual value &quot;+aggVal+&quot; is not valid, skip rule checking.&quot;);</span>
			}
<span class="nc" id="L671">			return false;</span>
		}
		//QA 81821 - Alert's being received during Closed Hours
		//Solution: return false incase CV is zero
		//TODO: this is a bad hack needs to be removed later Sameet 2008
<span class="nc bnc" id="L676" title="All 2 branches missed.">		if (traceType == Trace.PCA) {</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">			double aggCV = src==null?0:TraceOperator.aggregatePeriod(src, Trace.VAR, 0, src.getMaximumLength(new short[]{Trace.CV})-1);</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">			if (aggCV &lt;= 0)</span>
<span class="nc" id="L679">				return false;</span>
		}
		//End #81821
<span class="nc bnc" id="L682" title="All 4 branches missed.">		if (traceType == Trace.ABANDONMENT &amp;&amp; metricType == 0) {</span>
			// need convert Abandonments to percentage with ACV
<span class="nc bnc" id="L684" title="All 2 branches missed.">			double aggCV = src==null?0:TraceOperator.aggregatePeriod(src, Trace.CV, 0, src.getMaximumLength(new short[]{Trace.CV})-1);</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">			if (aggCV &lt;= 0)</span>
<span class="nc" id="L686">				aggVal = 0;</span>
			else
<span class="nc" id="L688">				aggVal = aggVal*100/aggCV;</span>
		}
<span class="nc" id="L690">		boolean conflict = false;</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">		if (betweenClause == IN_BETWEEN) {</span>
<span class="nc bnc" id="L692" title="All 4 branches missed.">			if (aggVal&gt;=val1 &amp;&amp; aggVal&lt;=val2) {</span>
<span class="nc" id="L693">				conflict = true;</span>
			}
		} else {
<span class="nc bnc" id="L696" title="All 4 branches missed.">			if (aggVal&lt;val1 || aggVal&gt;val2) {</span>
<span class="nc" id="L697">				conflict = true;</span>
			}
		}
<span class="nc bnc" id="L700" title="All 2 branches missed.">		if (conflict) {</span>
<span class="nc" id="L701">			Element xmlDev = doc.createElement(&quot;Deviation&quot;);</span>
<span class="nc" id="L702">			xmlRoot.appendChild(xmlDev);</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">			if (src.getQueueID() != null) {</span>
<span class="nc" id="L704">				Element xmlQueue = doc.createElement(&quot;QueueID&quot;);</span>
<span class="nc" id="L705">				xmlQueue.appendChild(doc.createTextNode(src.getQueueID().toString()));</span>
<span class="nc" id="L706">				xmlDev.appendChild(xmlQueue);</span>
			}
<span class="nc" id="L708">			Element xmlBetween = doc.createElement(&quot;BetweenClause&quot;);</span>
<span class="nc" id="L709">			xmlBetween.appendChild(doc.createTextNode(Integer.toString(betweenClause)));</span>
<span class="nc" id="L710">			xmlDev.appendChild(xmlBetween);</span>
<span class="nc" id="L711">			Element xmlMetric = doc.createElement(&quot;Metric&quot;);</span>
<span class="nc" id="L712">			xmlMetric.appendChild(doc.createTextNode(Integer.toString(metricType)));</span>
<span class="nc" id="L713">			xmlDev.appendChild(xmlMetric);</span>
<span class="nc" id="L714">			Element xmlTrace = doc.createElement(&quot;TraceType&quot;);</span>
<span class="nc" id="L715">			xmlTrace.appendChild(doc.createTextNode(Integer.toString(traceType)));</span>
<span class="nc" id="L716">			xmlDev.appendChild(xmlTrace);</span>
<span class="nc" id="L717">			Element userVal = doc.createElement(&quot;UserVal&quot;);</span>
<span class="nc" id="L718">			userVal.appendChild(doc.createTextNode(Integer.toString(TraceUtil.roundDouble(aggVal))));</span>
<span class="nc" id="L719">			xmlDev.appendChild(userVal);</span>
<span class="nc" id="L720">			Element xmlVal1 = doc.createElement(&quot;Val1&quot;);</span>
<span class="nc" id="L721">			xmlVal1.appendChild(doc.createTextNode(Integer.toString(val1)));</span>
<span class="nc" id="L722">			xmlDev.appendChild(xmlVal1);</span>
<span class="nc" id="L723">			Element xmlVal2 = doc.createElement(&quot;Val2&quot;);</span>
<span class="nc" id="L724">			xmlVal2.appendChild(doc.createTextNode(Integer.toString(val2)));</span>
<span class="nc" id="L725">			xmlDev.appendChild(xmlVal2);</span>
		}
<span class="nc" id="L727">		return conflict;</span>
	}

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleChecker#isRuleValid(com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRule, com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleTemplate)
	 */
	public boolean isRuleValid(NotifyRule notifyRule, NotifyRuleTemplate notifyRuleTemplate) {
<span class="nc" id="L734">		ID templateID = notifyRule.getTemplateID();</span>
<span class="nc" id="L735">		int lookBack = -1;</span>
<span class="nc" id="L736">		boolean lookBackExists = false;</span>
<span class="nc" id="L737">		int timeMetric = -1;</span>
<span class="nc" id="L738">		boolean timeMetricExists = false;</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">		for (Iterator itRuleParameter = notifyRule.getRuleParameters().iterator(); itRuleParameter.hasNext();) {</span>
<span class="nc" id="L740">			NotifyRuleParameter notifyRuleParameter = (NotifyRuleParameter) itRuleParameter.next();</span>
<span class="nc bnc" id="L741" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;LookBack&quot;)) {</span>
<span class="nc" id="L742">				Integer value = (Integer) notifyRuleParameter.getValue();</span>
<span class="nc" id="L743">				lookBack = value.intValue();</span>
<span class="nc" id="L744">				lookBackExists = true;</span>
<span class="nc bnc" id="L745" title="All 2 branches missed.">				if (lookBack &lt; 0)</span>
<span class="nc" id="L746">					return false;</span>
			}
<span class="nc bnc" id="L748" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;TimeMetric&quot;)) {</span>
<span class="nc" id="L749">				Integer value = (Integer) notifyRuleParameter.getValue();</span>
<span class="nc" id="L750">				timeMetric = value.intValue();</span>
<span class="nc" id="L751">				timeMetricExists = true;</span>
			}
<span class="nc bnc" id="L753" title="All 2 branches missed.">			if (!(templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ID) ||</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">					templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID))</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">					&amp;&amp; (notifyRuleParameter.getName().equals(&quot;DeviationValue&quot;))) {</span>
<span class="nc" id="L756">				Integer value = (Integer) notifyRuleParameter.getValue();</span>
<span class="nc" id="L757">				int val = value.intValue();</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">				if (val &lt; 0)</span>
<span class="nc" id="L759">					return false;</span>
			}

<span class="nc bnc" id="L762" title="All 2 branches missed.">			if ((templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ID) ||</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">					templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID))</span>
<span class="nc bnc" id="L764" title="All 2 branches missed.">					&amp;&amp; (notifyRuleParameter.getName().equals(&quot;Value1&quot;)</span>
<span class="nc bnc" id="L765" title="All 2 branches missed.">					|| notifyRuleParameter.getName().equals(&quot;Value2&quot;))) {</span>
<span class="nc" id="L766">				Integer value = (Integer) notifyRuleParameter.getValue();</span>
<span class="nc" id="L767">				int val = value.intValue();</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">				if (val &lt; 0)</span>
<span class="nc" id="L769">					return false;</span>
			}
<span class="nc" id="L771">		}</span>
<span class="nc bnc" id="L772" title="All 4 branches missed.">        if (timeMetricExists &amp;&amp; lookBackExists) {</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">			return (validateTimeMetricAndLoopBack(timeMetric, lookBack, null)==null);</span>
		}
<span class="nc" id="L775">		return true;</span>
	}

	public String validateTimeMetricAndLoopBack(int timeMetric, int lookBack,  LocaleContext localeContext){
<span class="nc bnc" id="L779" title="All 2 branches missed.">		if (timeMetric == TIME_METRIC_MINUTES) {</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">			if (lookBack &lt; Trace.INTERVAL) {</span>
<span class="nc" id="L781">				 return BbmEjbBundleKey.PULSELOOKBACK_INVALID_MINUTES;</span>
			}
<span class="nc bnc" id="L783" title="All 2 branches missed.">		} else if (timeMetric == TIME_METRIC_HOURS) {</span>
<span class="nc bnc" id="L784" title="All 2 branches missed.">             if (lookBack &lt;= 0) {</span>
<span class="nc" id="L785">             return BbmEjbBundleKey.PULSELOOKBACK_INVALID_HOURS;</span>
			 }
<span class="nc bnc" id="L787" title="All 2 branches missed.">		} else if (timeMetric == TIME_METRIC_DAYS) {</span>
<span class="nc bnc" id="L788" title="All 2 branches missed.">            if (lookBack &lt;= 0) {</span>
<span class="nc" id="L789">			return BbmEjbBundleKey.PULSELOOKBACK_INVALID_DAYS;</span>
			}
		}
<span class="nc" id="L792">		return null;</span>
	}

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleChecker#getRuleViolation(com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRule, com.bluepumpkin.ejb.bbm.notifyrules.model.NotifyRuleTemplate, com.bluepumpkin.common.localization.LocaleContext)
	 */
	public String getRuleViolation(NotifyRule notifyRule, NotifyRuleTemplate notifyRuleTemplate, LocaleContext localeContext)
	{
<span class="nc" id="L800">		Localizer localizer = LocalizationManager.getInstance().getLocalizer(localeContext);</span>
		//ResourceBundle resourceBundle = ResourceBundle.getBundle(BbmEjbBundleKey.BUNDLE, localeContext.getLanguageLocale());
<span class="nc" id="L802">		int lookBack = -1;</span>
<span class="nc" id="L803">		boolean lookBackExists = false;</span>
<span class="nc" id="L804">		int timeMetric = -1;</span>
<span class="nc" id="L805">		boolean timeMetricExists = false;</span>
<span class="nc" id="L806">		ID templateID = notifyRule.getTemplateID();</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">		for (Iterator itRuleParameter = notifyRule.getRuleParameters().iterator(); itRuleParameter.hasNext();)</span>
		{
<span class="nc" id="L809">			NotifyRuleParameter notifyRuleParameter = (NotifyRuleParameter) itRuleParameter.next();</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;LookBack&quot;)) {</span>
<span class="nc" id="L811">				Integer value = (Integer) notifyRuleParameter.getValue();</span>
<span class="nc" id="L812">				lookBack = value.intValue();</span>
<span class="nc" id="L813">				lookBackExists =true;</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">				if (lookBack &lt; 0) {</span>
<span class="nc" id="L815">					return localizer.i18n(BbmEjbBundleKey.BUNDLE_NAME, BbmEjbBundleKey.PULSELOOKBACK_CANNOT_BE_NEGATIVE);</span>
				}
			}
<span class="nc bnc" id="L818" title="All 2 branches missed.">			if (notifyRuleParameter.getName().equals(&quot;TimeMetric&quot;)) {</span>
<span class="nc" id="L819">				Integer value = (Integer) notifyRuleParameter.getValue();</span>
<span class="nc" id="L820">				timeMetric = value.intValue();</span>
<span class="nc" id="L821">				timeMetricExists = true;</span>
			}
<span class="nc bnc" id="L823" title="All 2 branches missed.">			if (!(templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ID) ||</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">					templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID))</span>
<span class="nc bnc" id="L825" title="All 2 branches missed.">					&amp;&amp; (notifyRuleParameter.getName().equals(&quot;DeviationValue&quot;))) {</span>
<span class="nc" id="L826">				Integer value = (Integer) notifyRuleParameter.getValue();</span>
<span class="nc" id="L827">				int val = value.intValue();</span>
<span class="nc bnc" id="L828" title="All 2 branches missed.">				if (val &lt; 0) {</span>
<span class="nc" id="L829">					return localizer.i18n(BbmEjbBundleKey.BUNDLE_NAME, BbmEjbBundleKey.PULSEDEVIATION_CANNOT_BE_NEGATIVE);</span>
				}
			}

<span class="nc bnc" id="L833" title="All 2 branches missed.">			if ((templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ID) ||</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">					templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID))</span>
<span class="nc bnc" id="L835" title="All 2 branches missed.">					&amp;&amp; (notifyRuleParameter.getName().equals(&quot;Value1&quot;)</span>
<span class="nc bnc" id="L836" title="All 2 branches missed.">					|| notifyRuleParameter.getName().equals(&quot;Value2&quot;))) {</span>
<span class="nc" id="L837">				Integer value = (Integer) notifyRuleParameter.getValue();</span>
<span class="nc" id="L838">				int val = value.intValue();</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">				if (val &lt; 0) {</span>
<span class="nc" id="L840">					return localizer.i18n(BbmEjbBundleKey.BUNDLE_NAME, BbmEjbBundleKey.PULSETHRESHOLD_CANNOT_BE_NEGATIVE);</span>
				}
			}

<span class="nc" id="L844">		}</span>
<span class="nc bnc" id="L845" title="All 4 branches missed.">		if (timeMetricExists &amp;&amp; lookBackExists) {</span>
<span class="nc" id="L846">			String errorMsg= validateTimeMetricAndLoopBack(timeMetric, lookBack, localeContext);</span>
<span class="nc bnc" id="L847" title="All 2 branches missed.">			if(errorMsg!=null){</span>
<span class="nc" id="L848">				return localizer.i18n(BbmEjbBundleKey.BUNDLE_NAME, errorMsg);</span>
			}
		}
<span class="nc" id="L851">		return null;</span>
	}

	private TrackingView getTrackingView(ID templateID, short traceType, short metricType, boolean isCombined) {
<span class="nc" id="L855">		TrackingView tv = new TrackingView();</span>
<span class="nc bnc" id="L856" title="All 2 branches missed.">		if (templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALVSFORECAST_ID)) {</span>
			// forecast vs actual
<span class="nc" id="L858">			TraceChart chart = new TraceChart(traceType, TraceChart.ABSOLUTE_CHART, new short[]{TraceChart.ACTUAL_LINE, TraceChart.FORECAST_LINE}, true);</span>
<span class="nc" id="L859">			tv.setChartDefinition(Collections.singletonList(chart));</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">		} else if (templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALVSSERVICEGOAL_ID)) {</span>
			// actual vs sg
<span class="nc" id="L862">			TraceChart chart = new TraceChart(traceType, TraceChart.ABSOLUTE_CHART, new short[]{TraceChart.ACTUAL_LINE, TraceChart.REQUIRE_LINE}, true);</span>
<span class="nc" id="L863">			tv.setChartDefinition(Collections.singletonList(chart));</span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">		} else if (templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ID) ||</span>
<span class="nc bnc" id="L865" title="All 2 branches missed.">				templateID.equals(NotifyRuleTemplate.NOTIFY_TEMPLATE_PULSEACTUALOUTOFRANGE_ORG_ID)) {</span>
			// actual
<span class="nc" id="L867">			ArrayList chartList = new ArrayList();</span>
<span class="nc" id="L868">			TraceChart chart = new TraceChart(traceType, TraceChart.ABSOLUTE_CHART, new short[]{TraceChart.ACTUAL_LINE}, true);</span>
<span class="nc" id="L869">			chartList.add(chart);</span>
			// if Abandonment is selected with Percentage points, need additional ACV
<span class="nc bnc" id="L871" title="All 4 branches missed.">			if (traceType == Trace.ABANDONMENT &amp;&amp; metricType == 0) {</span>
<span class="nc" id="L872">				TraceChart chart2 = new TraceChart(Trace.CV, TraceChart.ABSOLUTE_CHART, new short[]{TraceChart.ACTUAL_LINE}, true);</span>
<span class="nc" id="L873">				chartList.add(chart2);</span>
			}
<span class="nc" id="L875">			tv.setChartDefinition(chartList);</span>
		}
<span class="nc bnc" id="L877" title="All 2 branches missed.">		tv.setTrending(!isCombined); //Trend if     isCombined = false ; for indvl queues only</span>
<span class="nc" id="L878">		return tv;</span>
	}

	private static long getTimeUnit(short timeType) {
<span class="nc bnc" id="L882" title="All 4 branches missed.">		switch (timeType) {</span>
			case TIME_METRIC_MINUTES:
				// minutes
<span class="nc" id="L885">				return TimeZoneUtil.MINUTE_IN_MILLISECONDS_LONG;</span>
			case TIME_METRIC_HOURS:
				// hours
<span class="nc" id="L888">				return TimeZoneUtil.HOUR_IN_MILLISECONDS_LONG;</span>
			case TIME_METRIC_DAYS:
				// days
<span class="nc" id="L891">				return TimeZoneUtil.DAY_IN_MILLISECONDS_LONG;</span>
		}
<span class="nc" id="L893">		return TimeZoneUtil.MINUTE_IN_MILLISECONDS_LONG;</span>
	}

	private static double getMetricUnit(short metricType) {
<span class="nc bnc" id="L897" title="All 3 branches missed.">		switch (metricType) {</span>
			case 3:
				// minutes
<span class="nc" id="L900">				return 60;</span>
			case 4:
				// hours
<span class="nc" id="L903">				return 360;</span>
		}
<span class="nc" id="L905">		return 1;</span>
	}



	private ArrayList getEmployeesForOrg(NotifyRule notifyRule) {
<span class="nc" id="L911">		ArrayList employeeIDs = new ArrayList();</span>

<span class="nc" id="L913">		ID idOrganization = notifyRule.getScopeID();</span>
<span class="nc" id="L914">		ArrayList colOrganizationIDs = new ArrayList();</span>
<span class="nc" id="L915">		colOrganizationIDs.add(idOrganization);</span>

<span class="nc" id="L917">		WorkResourceManager m_workResourceManager = null;</span>
<span class="nc" id="L918">		Collection employees = null;</span>
<span class="nc" id="L919">		Organization org = null;</span>
		/*
		 * Sankar - If there are no employees assigned to the organization which is selected by the user,
		 * we are going to the parent organization and getting the employees associated for that organization. This
		 * continues till we find an organization with employees assigned or an organization where the parent org id
		 * is same as the current org id (Org -3001)
		 */
		try {
<span class="nc" id="L927">			m_workResourceManager = BbmManagerFactory.getWorkResourceManager();</span>
<span class="nc" id="L928">			org = m_workResourceManager.getOrganizationByID(idOrganization);</span>
<span class="nc" id="L929">			organizationName = org.getName();</span>
				
<span class="nc" id="L931">			employees = m_workResourceManager.getEmployees(colOrganizationIDs, null, Employee.DETAIL_LEVEL_EMPLOYEE_CONTACT);</span>
<span class="nc bnc" id="L932" title="All 4 branches missed.">			if(employees == null || employees.size() &lt; 1) {</span>
<span class="nc" id="L933">				 org = m_workResourceManager.getOrganizationByID(idOrganization);</span>
<span class="nc bnc" id="L934" title="All 4 branches missed.">				 while(org.getParentID() != null &amp;&amp; (org.getParentID().toInt()  != idOrganization.toInt())) {</span>
<span class="nc" id="L935">					 colOrganizationIDs.add(org.getParentID());</span>
<span class="nc" id="L936">					 idOrganization = org.getParentID();</span>
<span class="nc" id="L937">					 employees = m_workResourceManager.getEmployees(colOrganizationIDs, null, Employee.DETAIL_LEVEL_EMPLOYEE_CONTACT);</span>
<span class="nc bnc" id="L938" title="All 4 branches missed.">					 if(employees != null &amp;&amp; employees.size() &gt; 0) {</span>
<span class="nc" id="L939">						 break;</span>
					 }
<span class="nc" id="L941">					 org = m_workResourceManager.getOrganizationByID(idOrganization);</span>

				 }
			}
<span class="nc" id="L945">		} catch (BbmEJBCreateException e) {</span>
<span class="nc" id="L946">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L947">		} catch (RemoteException e) {</span>
<span class="nc" id="L948">		}</span>

<span class="nc bnc" id="L950" title="All 4 branches missed.">		if(employees == null || employees.size() &lt; 1) {</span>
<span class="nc" id="L951">			return employeeIDs;</span>
		}
<span class="nc" id="L953">		Iterator it = employees.iterator();</span>
<span class="nc bnc" id="L954" title="All 2 branches missed.">		while(it.hasNext()) {</span>
<span class="nc" id="L955">			Employee employee = (Employee)it.next();</span>
<span class="nc" id="L956">			employeeIDs.add(employee.getID());</span>
<span class="nc" id="L957">		}</span>

<span class="nc" id="L959">		return employeeIDs;</span>

	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>