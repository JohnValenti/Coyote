<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AutoProcessingRuleManagerEJB.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.setup.autoprocessing.ejb</a> &gt; <span class="el_source">AutoProcessingRuleManagerEJB.java</span></div><h1>AutoProcessingRuleManagerEJB.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.setup.autoprocessing.ejb;

import java.util.*;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TONotifyMessage;
import com.bluepumpkin.ejb.core.base.SessionEJBBase;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.util.TONotifyMessageClient;
import com.bluepumpkin.ejb.rm.setup.autoprocessing.model.AutoProcessingRule;

/**
 * Title:        AutoProcessingRuleManagerEJB
 * Description:  EJB for AutoProcessingRule
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc.
 * @author       Howard Mullings
 * @version      1.0
 *
 * This class represent the EJB for the AutoProcessing Rule.
 */
<span class="fc" id="L29">public class AutoProcessingRuleManagerEJB extends SessionEJBBase { //OUTSIDE_CONTAINER</span>
//public class AutoProcessingRuleManagerEJB extends SessionEjbBaseForTest implements AutoProcessingRuleManager { //OUTSIDE_CONTAINER

<span class="fc" id="L32">    private static Category m_cat = Log.initCategory(</span>
<span class="fc" id="L33">        AutoProcessingRuleManagerEJB.class.getName());</span>

    /** override the base class to provide the appropriate logging category */
    protected Category getCategory() {
<span class="fc" id="L37">        return m_cat;</span>
    }

    {
<span class="fc" id="L41">        super.init( AutoProcessingRuleManagerEJB.class.getName() );</span>
<span class="fc" id="L42">    }</span>

    /* Find the autoprocessing rules for the organization id.
     * @param pOrganizationId- Organization ID.
     * @return Collection of AutoProcessingRule object.
     * @throw BbmFinderException.
     */
    public Collection findAutoProcessingRuleByOrgId(ID pOrganizationId )
        throws BbmFinderException {

<span class="nc" id="L52">        final String l_MethodName = &quot;findAutoProcessingRuleByOrgId&quot;;</span>
<span class="nc" id="L53">        methodStart(l_MethodName, pOrganizationId);</span>
        Collection results;
        try {
<span class="nc" id="L56">            results = findAutoProcessingRuleByOrgId(pOrganizationId,</span>
                                                    Request.REQUESTTYPE_ALL,
                                                    false,
                                                    null);
<span class="nc" id="L60">        } catch (Exception e) {</span>
<span class="nc" id="L61">            handleException(e);</span>
<span class="nc" id="L62">            throw RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
        } finally {
<span class="nc" id="L64">            methodFinish();</span>
<span class="nc" id="L65">        }</span>
<span class="nc" id="L66">        return results;</span>
    }

    /* Find the autoprocessing rules for the organization id and  request type.
     * @param pOrganizationId- Organization ID.
     * @param pRequestType - Request Type
     * @return Collection of AutoProcessingRule object.
     * @throw BbmFinderException.
     */
    public Collection findAutoProcessingRuleByOrgId(ID pOrganizationId,
                                                    String pRequestType)
        throws BbmFinderException {
<span class="fc" id="L78">        final String l_MethodName = &quot;findAutoProcessingRuleByOrgId&quot;;</span>

<span class="fc" id="L80">        methodStart(l_MethodName, pOrganizationId, pRequestType);</span>
        try {
<span class="fc" id="L82">            Collection results = findAutoProcessingRuleByOrgId(pOrganizationId,</span>
                                                               pRequestType,
                                                               false,
                                                               null);
<span class="fc" id="L86">            return results;</span>
<span class="nc" id="L87">        } catch (Exception e) {</span>
<span class="nc" id="L88">            handleException(e);</span>
<span class="nc" id="L89">            throw RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
        }  finally {
<span class="pc" id="L91">            methodFinish();</span>
        }
    }

    /* Find the autoprocessing rules for the organization id.
     * @param pAutoProcessingRuleId- ID object for  AutoProcessingRuleId .
     * @return Collection of AutoProcessingRule object.
     * @throw BbmFinderException.
     */
    public Collection findEnabledAutoProcessingRules(ID pOrganizationId,
                                                    String pRequestType)
        throws BbmFinderException {
<span class="nc" id="L103">        return findEnabledAutoProcessingRules(pOrganizationId, pRequestType,</span>
                                              null);
    }

    /* Find the autoprocessing rules for the organization id.
     * @param pOrganizationId- ID object for  the associated organization .
     * @param pRequestType - the request type; one of 'time-off', 'shift-swap',
     *                       or 'all'.
     * @return Collection of AutoProcessingRule object.
     * @throw BbmFinderException.
     */
    public Collection findEnabledAutoProcessingRules(ID pOrganizationId,
                                                     String pRequestType,
                                                     ID activityId)
        throws BbmFinderException {

<span class="fc" id="L119">        final String l_MethodName = &quot;findEnabledAutoProcessingRules&quot;;</span>
<span class="fc" id="L120">        methodStart(l_MethodName, pOrganizationId, pRequestType);</span>
        try {
<span class="fc" id="L122">            Collection results = findAutoProcessingRuleByOrgId(pOrganizationId,</span>
                                                               pRequestType,
                                                               true,
                                                               activityId);
<span class="fc" id="L126">            return results;</span>
<span class="nc" id="L127">        } catch (Exception e) {</span>
<span class="nc" id="L128">            handleException(e);</span>
<span class="nc" id="L129">            throw RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
        } finally {
<span class="pc" id="L131">            methodFinish();</span>
        }
    }

    /* Find the autoprocessing rules for the organization id and  request type.
     * @param pOrganizationId- Organization ID.
     * @param pRequestType - Request Type
     * @return Collection of AutoProcessingRule object.
     * @throw BbmFinderException.
     */
    public Collection findAutoProcessingRuleByOrgId(ID pOrganizationId, String pRequestType, 
            boolean onlyIfApplied, ID activityId) throws BbmFinderException {
<span class="fc" id="L143">        final String l_MethodName = &quot;findAutoProcessingRuleByOrgId&quot;;</span>
<span class="fc bfc" id="L144" title="All 2 branches covered.">        methodStart(l_MethodName, pOrganizationId, pRequestType,</span>
                    onlyIfApplied ? Boolean.TRUE : Boolean.FALSE);

<span class="fc" id="L147">        AutoProcessingRuleDAO dao = new AutoProcessingRuleDAO();</span>
        try {
            // get parent orgs
            // get applied processing rules that match only if applied logic
            // get auto processing rules that are in the resulting set
<span class="fc" id="L152">            Collection results = dao.findAutoProcessingRuleByOrgId(pOrganizationId,</span>
                    pRequestType, onlyIfApplied, activityId);

<span class="fc" id="L155">            return results;</span>
<span class="nc" id="L156">        } catch (Exception e) {</span>
<span class="nc" id="L157">            handleException(e);</span>
<span class="nc" id="L158">            throw RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
        } finally {
<span class="pc" id="L160">            methodFinish();</span>
<span class="pc" id="L161">            dao.cleanUp();</span>
        }
    }

    /* Find the autoprocessing rules for the organization id.
     * @param pAutoProcessingRuleId- ID object for  AutoProcessingRuleId .
     * @return Collection of AutoProcessingRule object.
     * @throw BbmFinderException.
     */
    public AutoProcessingRule findAutoProcessingRuleById(ID pAutoProcessingRuleId)
        throws BbmFinderException {

<span class="nc" id="L173">        final String l_MethodName = &quot;findAutoProcessingRuleById&quot;;</span>
<span class="nc" id="L174">        methodStart(l_MethodName, pAutoProcessingRuleId);</span>
<span class="nc" id="L175">        AutoProcessingRule rule = null;</span>

<span class="nc" id="L177">        AutoProcessingRuleDAO dao = new AutoProcessingRuleDAO();</span>
        try {
<span class="nc" id="L179">            rule = dao.findAutoProcessingRuleById(pAutoProcessingRuleId);</span>
//        }
//        c_atch (RmMultipleObjectsException e ) {
//            m_cat.error(pAutoProcessingRuleId, e);
//            t_hrow new BbmFinderException(e);
<span class="nc" id="L184">        } catch (Exception e) {</span>
<span class="nc" id="L185">            handleException(e);</span>
<span class="nc" id="L186">            throw RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
        }  finally {
<span class="nc" id="L188">            methodFinish();</span>
<span class="nc" id="L189">            dao.cleanUp();</span>
<span class="nc" id="L190">        }</span>
<span class="nc" id="L191">        return rule;</span>
    }

    /* Update the autoprocessing rule.
     * @param pAutoProcessingRule-  AutoProcessingRule object.
     * @throw BbmUpdateException.
     */
    public void updateAutoProcessingRule(AutoProcessingRule pAutoProcessingRule)
        throws BbmUpdateException {

<span class="nc" id="L201">        final String l_MethodName = &quot;updateAutoProcessingRule&quot;;</span>
<span class="nc" id="L202">        methodStart(l_MethodName, pAutoProcessingRule);</span>
<span class="nc" id="L203">        AutoProcessingRuleDAO dao = new AutoProcessingRuleDAO();</span>
        try {
<span class="nc" id="L205">            dao.updateObject(pAutoProcessingRule);</span>
<span class="nc" id="L206">            triggerWaitlistScan(pAutoProcessingRule.getOrganizationId(),true, pAutoProcessingRule);</span>
<span class="nc" id="L207">        } catch (Exception e) {</span>
<span class="nc" id="L208">            handleException(e);</span>
<span class="nc" id="L209">            throw RequestUtil.createBbmUpdateExceptionWrapper(e, m_cat);</span>
        }  finally {
<span class="nc" id="L211">            methodFinish();</span>
<span class="nc" id="L212">            dao.cleanUp();</span>
<span class="nc" id="L213">        }</span>
<span class="nc" id="L214">    }</span>

    /* Delete the autoprocessing rule.
     * @param ID-  AutoProcessingRule ID object.
     * @throw BbmRemoveException.
     */
    public void deleteAutoProcessingRule(ID pAutoProcessingRuleID)
        throws BbmRemoveException {
<span class="nc" id="L222">        final String l_MethodName = &quot;deleteAutoProcessingRule&quot;;</span>
<span class="nc" id="L223">        methodStart(l_MethodName, pAutoProcessingRuleID);</span>
<span class="nc" id="L224">        AutoProcessingRuleDAO dao = new AutoProcessingRuleDAO();</span>
        try {
<span class="nc" id="L226">            AutoProcessingRule aRule=findAutoProcessingRuleById(pAutoProcessingRuleID);</span>
<span class="nc" id="L227">            dao.deleteObject(pAutoProcessingRuleID);</span>
<span class="nc" id="L228">            triggerWaitlistScan(aRule.getOrganizationId(),true, aRule);</span>
<span class="nc" id="L229">        } catch (Exception e) {</span>
<span class="nc" id="L230">            handleException(e);</span>
<span class="nc" id="L231">            m_cat.error(pAutoProcessingRuleID, e);</span>
<span class="nc" id="L232">            throw new BbmRemoveException(e);</span>
        }  finally {
<span class="nc" id="L234">            methodFinish();</span>
<span class="nc" id="L235">            dao.cleanUp();</span>
<span class="nc" id="L236">        }</span>
<span class="nc" id="L237">    }</span>

    /* Creates the autoprocessing rule.
     * @param pAutoProcessingRule-  AutoProcessingRule object.
     * @return - ID of created AutoProcessingRule object.
     * @throw BbmCreateException.
     */
    public ID createAutoProcessingRule(AutoProcessingRule pAutoProcessingRule)
        throws BbmCreateException {
<span class="fc" id="L246">        final String l_MethodName = &quot;createAutoProcessingRule&quot;;</span>
<span class="fc" id="L247">        methodStart(l_MethodName, pAutoProcessingRule);</span>
<span class="fc" id="L248">        AutoProcessingRuleDAO dao = new AutoProcessingRuleDAO();</span>
        try {
            //insert record in AutoProcessing rule table.
<span class="fc" id="L251">            ID id= dao.createObject(pAutoProcessingRule);</span>
<span class="fc" id="L252">            triggerWaitlistScan(pAutoProcessingRule.getOrganizationId(),true, pAutoProcessingRule);</span>
<span class="fc" id="L253">            return id;</span>
<span class="nc" id="L254">        } catch (Exception e) {</span>
<span class="nc" id="L255">            handleException(e);</span>
<span class="nc" id="L256">            throw RequestUtil.createBbmCreateExceptionWrapper(e, m_cat);</span>
        }  finally {
<span class="pc" id="L258">            methodFinish();</span>
<span class="pc" id="L259">            dao.cleanUp();</span>
        }
    }

    /* Update the  the applied status for the autoprocessing rule.
     * @param ID-  Organization ID object.
     * @param pMap- Object with AutoprocessingRuleId and its status ( true or false ).
     * @throw BbmUpdateException.
     */
    public void saveApplied(ID pOrganizationId, Map map)
        throws BbmUpdateException {
<span class="nc" id="L270">        final String l_MethodName = &quot;saveApplied&quot;;</span>
<span class="nc" id="L271">        methodStart(l_MethodName, pOrganizationId, map);</span>
<span class="nc" id="L272">        AppliedAutoProcessingRuleDAO dao = new AppliedAutoProcessingRuleDAO();</span>
        try {
<span class="nc" id="L274">            dao.saveAppliedStatus(pOrganizationId, map);</span>
<span class="nc" id="L275">            triggerWaitlistScan(pOrganizationId,true, null);</span>
<span class="nc" id="L276">        } catch (Exception e) {</span>
<span class="nc" id="L277">            handleException(e);</span>
<span class="nc" id="L278">            throw RequestUtil.createBbmUpdateExceptionWrapper(e, m_cat);</span>
        }  finally {
<span class="nc" id="L280">            methodFinish();</span>
<span class="nc" id="L281">            dao.cleanUp();</span>
<span class="nc" id="L282">        }</span>
<span class="nc" id="L283">    }</span>

    /* copy the autoprocessing rule from one organization to other.
     * @param ID-  AutoprocessingRule ID object.
     * @param ID- ToOrganizationId.
     * @throw BbmCreateException.
     */
    public ID copyAutoProcessingRule(ID pAutoProcessingRuleId,
                                     ID pToOrganizationId)
        throws  BbmCreateException, BbmFinderException {

<span class="nc" id="L294">        final String l_MethodName = &quot;copyAutoProcessingRule&quot;;</span>
<span class="nc" id="L295">        methodStart(l_MethodName, pAutoProcessingRuleId, pToOrganizationId);</span>
        try {
<span class="nc" id="L297">            AutoProcessingRule apr = findAutoProcessingRuleById(pAutoProcessingRuleId);</span>
<span class="nc" id="L298">            apr.setID(null);</span>
<span class="nc" id="L299">            apr.setOrganizationId(pToOrganizationId);</span>
            // FIXME: this may not be correct. We should copy the applied flag
            // from the source but this data is not stored in the auto processing rule
            // so we don't know it. Since we don't know the correct value, we use
            // true as the default.
<span class="nc" id="L304">            apr.setApplied(true);</span>
<span class="nc" id="L305">            ID id= createAutoProcessingRule(apr);</span>
<span class="nc" id="L306">            return id;</span>
<span class="nc" id="L307">        } catch (Exception e) {</span>
<span class="nc" id="L308">            handleException(e);</span>
<span class="nc" id="L309">            throw RequestUtil.createBbmFinderExceptionWrapper(e, m_cat);</span>
        }  finally {
<span class="nc" id="L311">            methodFinish();</span>
        }
    }
    public void triggerWaitlistScan(ID orgID, boolean includeChildOrg, AutoProcessingRule rule) throws BbmUpdateException {
<span class="pc bpc" id="L315" title="1 of 2 branches missed.">        String requestType = (rule != null ? rule.getRequestType() : null);</span>
<span class="pc bpc" id="L316" title="2 of 4 branches missed.">        if ((Request.REQUESTTYPE_TIMEOFF.equals(requestType) || requestType == null)) {</span>
<span class="nc" id="L317">            TONotifyMessageClient toNotifyMessageClient = new TONotifyMessageClient();</span>
<span class="nc" id="L318">            toNotifyMessageClient.scanTOWaitlist(orgID, includeChildOrg, TONotifyMessage.TO_NOTIFY_AUTO_PROCESS_RULE_CHANGE);</span>
        }
<span class="fc" id="L320">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>