<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftBidRequestDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb</a> &gt; <span class="el_source">ShiftBidRequestDAO.java</span></div><h1>ShiftBidRequestDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb;

import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoPCommand;
import com.bluepumpkin.common.jdmo.JdmoQuery;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.jdmo.JdmoUtil;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestAggregateDAO;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.FilterExpr;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestFieldInfo;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.ejb.ShiftBidAuctionDAO;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb.bidoptionsloaderdao.BiddableScheduleLoaderDAO;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.BiddableSchedule;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequest;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequestFieldInfo;
import com.bluepumpkin.ejb.rm.util.DAOUtil;
import com.bluepumpkin.ejb.rm.util.JdmoPreparedStatement;

/**
 * 
 * see {@link com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.ejb.ShiftBidAuctionManager ShiftBidAuctionManager}
 * for a description of the shift bidding process. 
 * 
 * Title:        ShiftBidRequestDAO
 * Description:  DAO class for ShiftBidRequest
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc.
 * @author       Robert Granat
 * @version 1.0
 */

public class ShiftBidRequestDAO extends RequestAggregateDAO {
<span class="nc" id="L55">	private static Category m_cat = Log.initCategory(ShiftBidRequestDAO.class.getName());</span>

	/**
	 * This is a member field (and not a static field) as each DAO instance can be assigned
	 * one among a set of FieldInfo objects.  The assigned
	 * FieldInfo reflects the chosen parentID field (of the VO) to use when this DAO
	 * serves as a childDAO. (childDAO is created by the parentDAO).
	 * 
	 * For instance, a shiftBidRequest can be either a ShiftBidder or ShiftBidAuction's child.
	 */
<span class="nc" id="L65">	private static ShiftBidRequestFieldInfo m_fieldInfo = new ShiftBidRequestFieldInfo();</span>

	//private Class m_parentDAO = null;

	// not initialized here since m_fieldInfo necessary for obtaining the column name is null.
<span class="nc" id="L70">	private static String COLNAME_SHIFTBIDDERID =</span>
<span class="nc" id="L71">			m_fieldInfo.getFieldName(ShiftBidRequestFieldInfo.SHIFTBIDREQUEST_I_SHIFTBIDDERID);</span>

<span class="nc" id="L73">	private static final DAOUtil.ColumnMetaData COLMETADATA_INT_ONE =</span>
			new DAOUtil.ColumnMetaData(DAOUtil.ColumnMetaData.COLUMNTYPE_INTEGER, 1);

<span class="nc" id="L76">	private static final DAOUtil.ColumnMetaData[] COLMETADATAARR_ID_ONE_INT_TWO = {</span>
			new DAOUtil.ColumnMetaData(DAOUtil.ColumnMetaData.COLUMNTYPE_ID, 1),
			new DAOUtil.ColumnMetaData(DAOUtil.ColumnMetaData.COLUMNTYPE_INTEGER, 2),
	};

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.rm.requests.common.ejb.RequestAggregateDAO#getRequestType()
	 */
	@Override
	protected String getRequestType() {
<span class="nc" id="L86">		return Request.REQUESTTYPE_SHIFTBID;</span>
	}

	@Override
	protected FieldInfo getFieldInfo() {
<span class="nc" id="L91">		return m_fieldInfo;</span>
	}

	public ShiftBidRequestDAO(long detailLevel) {
<span class="nc" id="L95">		super(detailLevel);</span>
<span class="nc" id="L96">	}</span>

	public ShiftBidRequestDAO(Jdmo dmo, long detailLevel) {
<span class="nc" id="L99">		super(dmo, detailLevel);</span>
<span class="nc" id="L100">	}</span>

	@Override
	protected ValueObjectBase createValueObject()
	{
		// adjust detail level to include DL_EMPLOYEE and DL_AUCTION if any of the following detailLevel
		// is used to retrieve requests.  This adjustment applies to all 
		// shift bid requests fetched by DAOBase.getObjectsGivenFullSqlQuery() method.
<span class="nc" id="L108">		long detailLevelToCheck = ShiftBidRequest.DL_BIDRANK_FOR_SHIFTBIDREQUEST;</span>
		// the detail levels added below are necessary to compute the score for a shift bid request.
<span class="nc bnc" id="L110" title="All 2 branches missed.">		if ((getDetailLevel() &amp; detailLevelToCheck) != 0) {</span>
<span class="nc" id="L111">			addDetailLevel(ShiftBidRequest.DL_EMPLOYEE | ShiftBidRequest.DL_SHIFTBID_AUCTION);</span>
		}

<span class="nc" id="L114">		return (new ShiftBidRequest(getDetailLevel()));</span>
	}

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.bbm.dao.DAONode#needToLoadChildObjects()
	 */
	@Override
	protected boolean needToLoadChildObjects() {
<span class="nc" id="L122">		long detailLevelsToCheck =</span>
				ShiftBidRequest.DL_SHIFTBID_AUCTION |
						ShiftBidRequest.DL_SHIFTBIDDER |
						ShiftBidRequest.DL_SHIFT_ASSIGNMENTS_COLL |
						ShiftBidRequest.DL_EMPLOYEE |
						ShiftBidRequest.DL_BIDDABLESCHEDULE_IDS |
						ShiftBidRequest.DL_BIDRANK_FOR_SHIFTBIDREQUEST |
						ShiftBidRequest.DL_BONUSTOBEAWARDED_FOR_SHIFTBID_REQUEST;

<span class="nc bnc" id="L131" title="All 2 branches missed.">		return (getDetailLevel() &amp; detailLevelsToCheck) != 0;</span>
	}

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.bbm.dao.DAONode#needToLoadChildObjects(int)
	 */
	@Override
	protected boolean needToLoadChildObjects(int childType) {
<span class="nc bnc" id="L139" title="All 4 branches missed.">		switch (childType) {</span>
		case ShiftBidRequestFieldInfo.SHIFTBIDAUCTION_CHILDTYPE: {
<span class="nc" id="L141">			long detailLevelToCheck = ShiftBidRequest.DL_SHIFTBID_AUCTION | //need auction startTime and endTime for finding employee ORGID</span>
					BiddableSchedule.DL_BIDRANK_FOR_SHIFTBIDREQUEST;

<span class="nc bnc" id="L144" title="All 2 branches missed.">			return (getDetailLevel() &amp; detailLevelToCheck) != 0;</span>
		}
		case ShiftBidRequestFieldInfo.SHIFTBIDDER_CHILDTYPE: {
			//TODO: must DL_EMPLOYEE load the employee child object from Request.getEmpID() instead of ShiftBidder.getEmpID()?
<span class="nc" id="L148">			long detailLevelsToCheck = ShiftBidRequest.DL_SHIFTBIDDER | ShiftBidRequest.DL_EMPLOYEE |</span>
					ShiftBidRequest.DL_BIDRANK_FOR_SHIFTBIDREQUEST |
					BiddableSchedule.DL_BIDRANK_FOR_SHIFTBIDREQUEST;

<span class="nc bnc" id="L152" title="All 2 branches missed.">			return (getDetailLevel() &amp; detailLevelsToCheck) != 0;</span>
		}
		case ShiftBidRequestFieldInfo.SHIFTBIDREQUESTBIDDABLESCHEDULE_CHILDTYPE: {
<span class="nc" id="L155">			long detailLevelsToCheck = ShiftBidRequest.DL_SHIFT_ASSIGNMENTS_COLL |</span>
					ShiftBidRequest.DL_BIDDABLESCHEDULE_IDS |
					ShiftBidRequest.DL_BIDRANK_FOR_SHIFTBIDREQUEST |
					ShiftBidRequest.DL_BONUSTOBEAWARDED_FOR_SHIFTBID_REQUEST;

<span class="nc bnc" id="L160" title="All 2 branches missed.">			return (getDetailLevel() &amp; detailLevelsToCheck) != 0;</span>
		}
		default:
<span class="nc" id="L163">			throw new IllegalArgumentException(&quot;childType = &quot; + childType);</span>
		}
	}

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.bbm.dao.DAONode#createChildDAO(int)
	 */
	@Override
	protected DAOBase createChildDAO(int iType) {
<span class="nc bnc" id="L172" title="All 2 branches missed.">		if (iType == ShiftBidRequestFieldInfo.SHIFTBIDREQUESTBIDDABLESCHEDULE_CHILDTYPE) {</span>
<span class="nc" id="L173">			return new ShiftBidRequestBiddableScheduleDAO(m_dmo, getClass(), getDetailLevel());</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">		} else if (iType == ShiftBidRequestFieldInfo.SHIFTBIDAUCTION_CHILDTYPE) {</span>

<span class="nc" id="L176">			return new ShiftBidAuctionDAO(m_dmo, getDetailLevel());</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">		} else if (iType == ShiftBidRequestFieldInfo.SHIFTBIDDER_CHILDTYPE) {</span>
<span class="nc" id="L178">			return new ShiftBidderDAO(m_dmo, /*getClass(), */getDetailLevel());</span>
		}

<span class="nc" id="L181">		return null;</span>
	}



	/**
	 * @param id
	 * @param l
	 * @return
	 */
	public Collection getRequestsByShiftBidderID(ID shiftBidderID, long detailLevel) throws Exception {
<span class="nc" id="L192">		saveAndSetDetailLevel(detailLevel);</span>

		try {
<span class="nc" id="L195">			return getObjects(COLNAME_SHIFTBIDDERID + &quot; = &quot; + shiftBidderID);</span>
		} finally {
<span class="nc" id="L197">			resetDetailLevel();</span>
		}
	}

	/**
	 * @param id
	 * @param l
	 * @return
	 */
	public ID getApprovedRequestIDByShiftBidderAndAuctionID(ID shiftBidderID, ID auctionID) throws Exception {
<span class="nc" id="L207">		String query = &quot;SELECT SBR.ID FROM SHIFTBIDREQUEST SBR, REQUEST REQ WHERE &quot; +</span>
				&quot; SBR.ID = REQ.ID &quot; +
				&quot; AND SBR.&quot; + ShiftBidRequestFieldInfo.COLNAME_SHIFTBIDDERID + &quot; = &quot; + shiftBidderID +
				&quot; AND SBR.&quot; + ShiftBidRequestFieldInfo.COLNAME_AUCTIONID + &quot; = &quot; + auctionID +
				&quot; AND REQ.&quot; + RequestFieldInfo.COLNAME_REQUESTSTATUS + &quot; = '&quot; + RequestAuditTrail.STATUS_APPROVED + &quot;'&quot;;

<span class="nc" id="L213">		ID approvedID = (ID) DAOUtil.getFromSQLQuerySingleValue(getDMO(), query,</span>
				new DAOUtil.ColumnMetaData(DAOUtil.ColumnMetaData.COLUMNTYPE_ID, 1));

<span class="nc" id="L216">		return approvedID;</span>
	}

	/**
	 * @param strings
	 */
	public Collection getRequestsUsingFilter(FilterExpr[] filters, long detailLevel) throws Exception {
<span class="nc" id="L223">		saveAndSetDetailLevel(detailLevel);</span>

		try {
<span class="nc" id="L226">			StringBuffer whereSubClause = new StringBuffer(128);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">			for (int i = 0; i &lt; filters.length; i++) {</span>
				// obtain the filter.
<span class="nc" id="L229">				FilterExpr filter = filters[i];</span>

<span class="nc bnc" id="L231" title="All 2 branches missed.">				whereSubClause = (whereSubClause.length() != 0) ? whereSubClause.append(&quot; AND &quot;) : whereSubClause;</span>

				// if filter by request status
<span class="nc bnc" id="L234" title="All 2 branches missed.">				if (filter.getLHS() == FilterExpr.LHS_REQUESTSTATUS) {</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">					if (filter.getOperator() == FilterExpr.OP_IN) {</span>
<span class="nc" id="L236">						String[] statusArr = (String[]) filter.getRHS();</span>
<span class="nc" id="L237">						whereSubClause.append(&quot; A.REQUESTSTATUS IN &quot; + DAOUtil.createInClause(statusArr));</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">					} else if (filter.getOperator() == FilterExpr.OP_EQUALTO) {</span>
<span class="nc" id="L239">						whereSubClause.append(&quot; A.REQUESTSTATUS = '&quot; + filter.getRHS() + '\'');</span>
					}
				}

				// if filter by shiftBidderID
<span class="nc bnc" id="L244" title="All 2 branches missed.">				if (filter.getLHS() == FilterExpr.LHS_BIDDERIDS) {</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">					if (filter.getOperator() == FilterExpr.OP_IN) {</span>
<span class="nc" id="L246">						Collection bidderIDs = (Collection) filter.getRHS();</span>
<span class="nc" id="L247">						whereSubClause.append(&quot; B.SHIFTBIDDERID IN &quot; + m_dmo.createInClause(bidderIDs));</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">					} else if (filter.getOperator() == FilterExpr.OP_EQUALTO) {</span>
<span class="nc" id="L249">						whereSubClause.append(&quot; B.SHIFTBIDDERID = &quot; + filter.getRHS());</span>
					}
				}
			}

<span class="nc" id="L254">			return getObjects(whereSubClause.toString());</span>
		} finally {
<span class="nc" id="L256">			resetDetailLevel();</span>
		}
	}

	/**
	 * Returns a map of shiftBidderID to # of shiftBidRequests for the bidder.
	 * 
	 * @param bidderIDs
	 * @return
	 * @throws Exception
	 */
	public Map&lt;ID, Integer&gt; getNumOfShiftBidRequestsForBidders(Collection&lt;ID&gt; bidderIDs) throws Exception {
		// query for # of shift bid requests for each shift bidder.
<span class="nc" id="L269">		String sql = &quot;SELECT SHIFTBIDDERID, COUNT(*) AS NUMOFREQUESTS &quot; +</span>
				&quot;FROM SHIFTBIDREQUEST A,REQUEST B WHERE SHIFTBIDDERID IN ? &quot; +
				&quot; AND B.ID=A.ID AND REQUESTSTATUS NOT IN ('withdrawn','invalid') &quot; +
				&quot;GROUP BY SHIFTBIDDERID&quot;;

<span class="nc" id="L274">		Map&lt;ID, Integer&gt; result = new HashMap&lt;ID, Integer&gt;(bidderIDs.size());</span>

<span class="nc" id="L276">		JdmoRowset rs = JdmoPreparedStatement.createRowset(m_dmo, sql, bidderIDs);</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L278">			ID bidderID = rs.getID(1);</span>
<span class="nc" id="L279">			int numRequests = rs.getInt(2);</span>
<span class="nc" id="L280">			result.put(bidderID, numRequests);</span>
<span class="nc" id="L281">		}</span>
<span class="nc" id="L282">		return result;</span>
	}

	public Collection getRequestWithMatchPreference(ID shiftBidderID, ID shiftBidActionID, ID shiftBidRequestID, int preference)
			throws Exception {
<span class="nc" id="L287">		StringBuffer sqlQuery = new StringBuffer(200);</span>
<span class="nc" id="L288">		sqlQuery.append(&quot;SELECT *&quot;);</span>
<span class="nc" id="L289">		sqlQuery.append(&quot; FROM SHIFTBIDREQUEST A&quot;);</span>
<span class="nc" id="L290">		sqlQuery.append(&quot; INNER JOIN REQUEST R ON R.ID = A.ID and R.REQUESTSTATUS in ('pending', 'escalated')&quot;);</span>
<span class="nc" id="L291">		sqlQuery.append(&quot; WHERE A.SHIFTBIDDERID = &quot;);</span>
<span class="nc" id="L292">		sqlQuery.append(shiftBidderID);</span>
<span class="nc" id="L293">		sqlQuery.append(&quot; and A.SHIFTBIDAUCTIONID = &quot;);</span>
<span class="nc" id="L294">		sqlQuery.append(shiftBidActionID);</span>
<span class="nc" id="L295">		sqlQuery.append(&quot; and A.PREFERENCE = &quot;);</span>
<span class="nc" id="L296">		sqlQuery.append(preference);</span>
<span class="nc" id="L297">		sqlQuery.append(&quot; and A.ID not in (&quot;);</span>
<span class="nc" id="L298">		sqlQuery.append(shiftBidRequestID);</span>
<span class="nc" id="L299">		sqlQuery.append(&quot;)&quot;);</span>

<span class="nc" id="L301">		return getObjectsGivenFullSqlQueryStr(sqlQuery.toString());</span>
	}

	/**
	 * check if a request with the given name exists for the given shiftBidder.  Returns the number of
	 * requests with the given name.
	 * 
	 * @param shiftBidderID
	 * @param reqName
	 * @return
	 */
	public List checkIfRequestWithNameExists(ID shiftBidderID, String reqName) throws Exception {
		//check for single quotes in the name string, to prevent sql exception
<span class="nc" id="L314">		reqName = StringUtil.replace(reqName, &quot;'&quot;, &quot;''&quot;);</span>
		//TODO: use SQL positional parameters.  This will allow the query to be cached by the DB server
<span class="nc" id="L316">		String query = &quot;SELECT ID FROM ShiftBidRequest WHERE &quot; +</span>
				ShiftBidRequestFieldInfo.COLNAME_SHIFTBIDDERID + &quot; = &quot; + shiftBidderID +
				&quot; AND &quot; + ShiftBidRequestFieldInfo.COLNAME_NAME + &quot; = '&quot; + reqName + '\'';

<span class="nc" id="L320">		List reqIDs = DAOUtil.getIDsUsingSQLQuery(m_dmo, query);</span>

<span class="nc" id="L322">		return reqIDs;</span>
	}

	/**
	 * @param empID
	 * @param auctionID
	 * @param statuses
	 * @return
	 */
	public int getNumOfBidsSubmittedForBidderID(ID bidderID, ID auctionID, String[] statuses) throws Exception {
<span class="nc" id="L332">		String query = &quot;SELECT COUNT(*) FROM SHIFTBIDREQUEST SBR, REQUEST REQ WHERE &quot; +</span>
				&quot; SBR.ID = REQ.ID &quot; +
				&quot; AND SBR.&quot; + ShiftBidRequestFieldInfo.COLNAME_SHIFTBIDDERID + &quot; = &quot; + bidderID +
				&quot; AND SBR.&quot; + ShiftBidRequestFieldInfo.COLNAME_AUCTIONID + &quot; = &quot; + auctionID +
<span class="nc" id="L336">				&quot; AND REQ.&quot; + RequestFieldInfo.COLNAME_REQUESTSTATUS + &quot; IN &quot; + DAOUtil.createInClause(statuses);</span>

<span class="nc" id="L338">		Integer numOfBids = (Integer) DAOUtil.getFromSQLQuerySingleValue(getDMO(), query,</span>
				new DAOUtil.ColumnMetaData(DAOUtil.ColumnMetaData.COLUMNTYPE_INTEGER, 1));

<span class="nc bnc" id="L341" title="All 2 branches missed.">		return (numOfBids != null) ? numOfBids.intValue() : 0;</span>
	}

	/**
	 * Delete all Shift Bid requests for employees in the given organization
	 * with biddable schedules starting during the given range.
	 */
	public void deleteRequestsByStartDateRange(ID organizationID, boolean isForBranch, TimeRange range) throws Exception {
<span class="nc" id="L349">		Collection&lt;ID&gt; orgEmpIDs = RequestUtil.getEmployeeIDsInOrganization(organizationID, isForBranch,</span>
<span class="nc" id="L350">				range.getStartDate(), range.getEndDate());</span>

<span class="nc" id="L352">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L353">		sb.append(&quot;SELECT DISTINCT R.ID &quot; +</span>
				&quot;from REQUEST R &quot; +
				&quot;inner join SHIFTBIDREQSTBIDDABLESCHEDULE SBRSCH on SBRSCH.SHIFTBIDREQUESTID = R.ID &quot; +
				&quot;inner join BIDDABLESCHEDULE BSCH on BSCH.ID = SBRSCH.BIDDABLESCHEDULEID &quot; +
				&quot;inner join BIDDABLESHIFTASSIGNMENT BSA on BSA.BIDDABLESCHEDULEID = BSCH.ID &quot;);
		
<span class="nc" id="L359">		String where = String.format(&quot;where BSA.STARTTIME BETWEEN '%s' and '%s' and R.EMPLOYEEID in %s &quot;,</span>
<span class="nc" id="L360">				JdmoUtil.formatDBString(range.getStartDate()),</span>
<span class="nc" id="L361">				JdmoUtil.formatDBString(range.getEndDate()),</span>
<span class="nc" id="L362">				m_dmo.createInClause(orgEmpIDs) );</span>
<span class="nc" id="L363">		sb.append(where);</span>

<span class="nc bnc" id="L365" title="All 2 branches missed.">		if (!StringUtil.isEmpty(sb.toString())) {</span>
<span class="nc" id="L366">			deleteObjects(sb.toString());</span>
		}
<span class="nc" id="L368">	}</span>

	/**
	 * &lt;p&gt;
	 * Gets the number of requests by the employee for the specified list of auctions.
	 * &lt;/p&gt;
	 * &lt;p&gt;
	 * The map's key is the auction ID and the value is the count.
	 * &lt;/p&gt;
	 */
	public Map&lt;ID, Integer&gt; getRequestCountsForEmployeeAuctions(ID employeeID, Collection&lt;ID&gt; auctionIDs)
			throws JdmoException {
<span class="nc" id="L380">		Map&lt;ID, Integer&gt; results = new HashMap&lt;ID, Integer&gt;();</span>

<span class="nc" id="L382">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L383">		sb.append(&quot;select sbr.SHIFTBIDAUCTIONID, count(r.ID) as COUNT from REQUEST r inner join SHIFTBIDREQUEST sbr on sbr.ID = r.ID&quot;);</span>
<span class="nc" id="L384">		sb.append(&quot; where r.EMPLOYEEID = &quot;).append(employeeID.toInt()).append(&quot; AND sbr.SHIFTBIDAUCTIONID in &quot;);</span>
<span class="nc" id="L385">		sb.append(m_dmo.createInClause(auctionIDs));</span>
<span class="nc" id="L386">		sb.append(&quot; group by sbr.SHIFTBIDAUCTIONID&quot;);</span>

<span class="nc" id="L388">		JdmoRowset rows = m_dmo.createRowset(sb.toString());</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">		while (rows.next()) {</span>
<span class="nc" id="L390">			ID auctionID = rows.getID(&quot;SHIFTBIDAUCTIONID&quot;);</span>
<span class="nc" id="L391">			int count = rows.getInt(&quot;COUNT&quot;);</span>
<span class="nc" id="L392">			results.put(auctionID, count);</span>
<span class="nc" id="L393">		}</span>

<span class="nc" id="L395">		return results;</span>
	}

	/**
	 * Updates the preferences for the specified requests.
	 */
	public void updatePreferences(Collection&lt;ShiftBidRequest&gt; requests) throws JdmoException {
<span class="nc" id="L402">		JdmoPCommand command = m_dmo.createPCommand(&quot;update SHIFTBIDREQUEST set PREFERENCE = ? where id = ?&quot;);</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">		for (ShiftBidRequest request : requests) {</span>
<span class="nc" id="L404">			Object[] params = new Object[] {</span>
<span class="nc" id="L405">					request.getPreference(), request.getID().toInt() };</span>
<span class="nc" id="L406">			m_dmo.executePCommand(command, params);</span>
<span class="nc" id="L407">		}</span>
<span class="nc" id="L408">	}</span>

	public List&lt;ID&gt; getFilteredRequestIds(FilterAndSortParams p) {

<span class="nc" id="L412">		return JdmoPreparedStatement.getIDListFromStoredProc(m_dmo,</span>
				&quot;RM_GetShiftBidFilteredRequestList&quot;,
<span class="nc" id="L414">				p.getUserEmployeeID(),</span>
<span class="nc" id="L415">				p.getOrganizations(),</span>
<span class="nc" id="L416">				p.getStartDate(),</span>
<span class="nc" id="L417">				p.getEndDate(),</span>
				//If null don't filter by day of week. Sunday=1,Monday=2,...
<span class="nc" id="L419">				p.getNullableDayOfWeek(),</span>
				//if null don't filter by employee ID
<span class="nc" id="L421">				p.getNullableFilterByEmployeeID(),</span>
				//if null don't filter by supervisor ID. Otherwise return only requests for employees with the specified supervisor
<span class="nc" id="L423">				p.getNullableSupervisorID(),</span>
				//If not null filter by the specified score. 
				//The FilterScoreOperator specifies how this value is used to filter requests
<span class="nc" id="L426">				p.getNullableFilterScore(),</span>
				//1 = Requests have a score &lt; FilterScore
				//2 = Requests have a score = FilterScore
				//3 = Requests have a score &gt; FilterScore
				//Null = don't filter by score
<span class="nc" id="L431">				p.getNullableFilterScoreOperator(),</span>
				//1 = Sort ascending by score
				//2 = Sort descending by score
				//Null = no need to sort by score
<span class="nc" id="L435">				p.getNullableSortByScore()</span>
				);

	}

	/**
	 * 1. Set BiddableSchedule.TotalUsed to the count of currently approved requests
	 * 2. Run RM_SBMarkOthersAsInvalid to mark other requests from this bidder as invalid
	 * 3. Update EmployeeAM.AssignedPoints as follows:
	 * 		a. Store the current EmployeeAM.AssignedPoints so that we can handle withdrawing the request
	 * 		b. If the request is using bonus then zero out the EmployeeAM.AssignedPoints (points have been consumed by this request)
	 * 		c. Increase EmployeeAM.AssignedPoints by the bonus points for all the biddable schedules in this request
	 */
	public void runAfterApprovalProcess(ID approvedRequestID) throws JdmoException {
<span class="nc" id="L449">		JdmoQuery jdmoQuery = m_dmo.createQuery(&quot;RM_SBRunAfterApprovalProcess&quot;, Jdmo.STORPROC_QUERY_NORS);</span>
<span class="nc" id="L450">		jdmoQuery.setParID(1, approvedRequestID);</span>
<span class="nc" id="L451">		m_dmo.execute(jdmoQuery);</span>
<span class="nc" id="L452">	}</span>

	/**
	 *	1.	Set BiddableSchedule.TotalUsed to the count of currently approved requests
	 *	2.	Set EmployeeAM.AssignedPoints to SHIFTBIDREQUEST.ASSIGNEDPOINTSBEFOREAPPROVAL
	 *			This sets the assigned point for the bidder to what it was when the request was approved.
	 * 		
	 */
	public static void runAfterWithdrawalProcess(Jdmo dmo, ID withdrawnRequestID) throws JdmoException {
<span class="nc" id="L461">		JdmoQuery jdmoQuery = dmo.createQuery(&quot;RM_SBRunAfterWithdrawalProcess&quot;, Jdmo.STORPROC_QUERY_NORS);</span>
<span class="nc" id="L462">		jdmoQuery.setParID(1, withdrawnRequestID);</span>
<span class="nc" id="L463">		dmo.execute(jdmoQuery);</span>
<span class="nc" id="L464">	}</span>

	/**
	 * Computes the rank for a request that has not yet been persisted to the database. 
	 * This is used to calculate the rank for the request when the user select the biddable schedules that would make up the request, but
	 * before the request has been saved to the database
	 */
	public void setRankForUncreatedRequest(ShiftBidRequest sbRequest) throws JdmoException {
<span class="nc" id="L472">		ID bidderID = sbRequest.getShiftBidderID();</span>
<span class="nc" id="L473">		List&lt;ID&gt; biddableScheudleIds = sbRequest.getBiddableScheduleIDs();</span>
<span class="nc bnc" id="L474" title="All 4 branches missed.">		if (bidderID == null || biddableScheudleIds.isEmpty()) {</span>
<span class="nc" id="L475">			throw new IllegalArgumentException(&quot;setRankForUncreatedRequest: invalid sbRequest&quot;);</span>
		}

<span class="nc" id="L478">		JdmoRowset rs = JdmoPreparedStatement.createStoredProcedureRowset(m_dmo, &quot;RM_GetRankingUncreatedRequest&quot;, bidderID,</span>
				biddableScheudleIds);

<span class="nc bnc" id="L481" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L482">			int withBonus = rs.getInt(&quot;EmployeeRankwithBonus&quot;);</span>
<span class="nc" id="L483">			int withoutBonus = rs.getInt(&quot;EmployeeRankwithoutBonus&quot;);</span>
<span class="nc" id="L484">			int countWithBonus = rs.getInt(&quot;NbrBidswith&quot;);</span>
<span class="nc" id="L485">			int countWithoutBonus = rs.getInt(&quot;NbrBidsWithout&quot;);</span>

<span class="nc" id="L487">			Pair&lt;Integer, Integer&gt; rankWithoutBonus = new Pair&lt;Integer, Integer&gt;(withoutBonus, countWithoutBonus);</span>
<span class="nc" id="L488">			Pair&lt;Integer, Integer&gt; rankWithBonus = new Pair&lt;Integer, Integer&gt;(withBonus, countWithBonus);</span>

<span class="nc" id="L490">			sbRequest.getSetters().setRankWithBonus(rankWithBonus);</span>
<span class="nc" id="L491">			sbRequest.getSetters().setRankWithoutBonus(rankWithoutBonus);</span>
		}

<span class="nc" id="L494">	}</span>

	public void loadRequestRankAndScore(Map&lt;ID, ShiftBidRequest&gt; requestsByID) throws JdmoException {

<span class="nc" id="L498">		JdmoRowset rs = JdmoPreparedStatement.createStoredProcedureRowset(m_dmo, &quot;RM_GetRankingRequestList&quot;, requestsByID.keySet());</span>

<span class="nc bnc" id="L500" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L501">			ID requestID = rs.getID(&quot;ThisRequestID&quot;);</span>

<span class="nc" id="L503">			ShiftBidRequest request = requestsByID.get(requestID);</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">			if (request == null) {</span>
<span class="nc" id="L505">				continue;</span>
			}

<span class="nc" id="L508">			Pair&lt;Integer, Integer&gt; rankWithoutBonus = new Pair&lt;Integer, Integer&gt;(rs.getInt(&quot;BidRankwithoutBonus&quot;),</span>
<span class="nc" id="L509">					rs.getInt(&quot;NbrBidsWithout&quot;));</span>

<span class="nc" id="L511">			Pair&lt;Integer, Integer&gt; rankWithBonus = new Pair&lt;Integer, Integer&gt;(rs.getInt(&quot;BidRankwithBonus&quot;), rs.getInt(&quot;NbrBidswith&quot;));</span>

<span class="nc" id="L513">			request.getSetters().setRankWithBonus(rankWithBonus);</span>
<span class="nc" id="L514">			request.getSetters().setRankWithoutBonus(rankWithoutBonus);</span>
<span class="nc" id="L515">			request.setScore(rs.getInt(&quot;Score&quot;));</span>
<span class="nc" id="L516">		}</span>

<span class="nc" id="L518">	}</span>

	@Override
	public ShiftBidRequest getObjectByID(ID requestID) throws BbmObjectNotFoundException, BbmFinderException {

<span class="nc" id="L523">		ShiftBidRequest shiftBidRequest = (ShiftBidRequest) super.getObjectByID(requestID);</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">		if (shiftBidRequest == null) {</span>
<span class="nc" id="L525">			return null;</span>
		}

<span class="nc" id="L528">		loadShiftAssignmentsIntoShiftBidRequest(Collections.singleton(shiftBidRequest));</span>
<span class="nc" id="L529">		return shiftBidRequest;</span>
	}

	@Override
	public Collection&lt;ShiftBidRequest&gt; getObjectsByIDs(Collection requestIDs) throws BbmFinderException {
		@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L535">		Collection&lt;ShiftBidRequest&gt; shiftBidRequests = super.getObjectsByIDs(requestIDs);</span>
<span class="nc" id="L536">		loadShiftAssignmentsIntoShiftBidRequest(shiftBidRequests);</span>
<span class="nc" id="L537">		return shiftBidRequests;</span>
	}
	 /**
     * Find a collection of Shift Bid requests for a given employeeID
     * @param employeeID the employee id
     * @return a collection of ShiftBidRequest objects matching the employeeID 
     * which has child objects of shift bid requests such as skills, shift assingment
     */
    @Override
	public Collection getRequestsByEmployee(ID employeeID, long detailLevel)
        throws Exception
    {
<span class="nc" id="L549">    	Collection&lt;ShiftBidRequest&gt; shiftBidRequests = super.getRequestsByEmployee(employeeID, detailLevel);</span>
<span class="nc" id="L550">    	loadShiftAssignmentsIntoShiftBidRequest(shiftBidRequests);</span>
<span class="nc" id="L551">		return shiftBidRequests;</span>
    }
	private void loadShiftAssignmentsIntoShiftBidRequest(Collection&lt;ShiftBidRequest&gt; shiftBidRequests) {

<span class="nc bnc" id="L555" title="All 2 branches missed.">		boolean needShiftAssignments = (getDetailLevel() &amp; ShiftBidRequest.DL_SHIFT_ASSIGNMENTS_COLL) != 0;</span>

<span class="nc bnc" id="L557" title="All 4 branches missed.">		if (shiftBidRequests.isEmpty() || !needShiftAssignments) {</span>
<span class="nc" id="L558">			return;</span>
		}

<span class="nc" id="L561">		Set&lt;ID&gt; requestIDs = DAOUtil.valueObjectsToIdSet(shiftBidRequests);</span>
<span class="nc" id="L562">		BiddableScheduleLoaderDAO bidDao2 = new BiddableScheduleLoaderDAO(getDMO());</span>
<span class="nc" id="L563">		Map&lt;ID, List&lt;BiddableSchedule&gt;&gt; biddabMap = bidDao2.getBiddableSchedulesForRequests(requestIDs);</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">		for (ShiftBidRequest request : shiftBidRequests) {</span>
<span class="nc" id="L565">			List&lt;BiddableSchedule&gt; schedules = biddabMap.get(request.getID());</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">			if (schedules == null) {</span>
<span class="nc" id="L567">				schedules = Collections.emptyList();</span>
			}
<span class="nc" id="L569">			request.getOptMethods().setBiddableSchedules(schedules);</span>
<span class="nc" id="L570">		}</span>

<span class="nc" id="L572">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>