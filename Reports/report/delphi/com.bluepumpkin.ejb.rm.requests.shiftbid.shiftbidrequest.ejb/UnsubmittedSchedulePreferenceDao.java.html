<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>UnsubmittedSchedulePreferenceDao.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb</a> &gt; <span class="el_source">UnsubmittedSchedulePreferenceDao.java</span></div><h1>UnsubmittedSchedulePreferenceDao.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb;

import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.ejb.rm.base.RmRuntimeException;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidPreference;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.UnsubmittedShiftBidPreference;
import com.bluepumpkin.ejb.rm.util.BasicJdmoDao;
import com.bluepumpkin.ejb.rm.util.JdmoPreparedStatement;
import com.bluepumpkin.ejb.rm.util.orm.JdmoOrm;
import com.bluepumpkin.ejb.rm.util.orm.WriteOptions;

/*
 * The UNSUBMITTEDSHIFTBIDPREFERENCE is used to hold the employee preferences for shift bid templates (BIDDABLESCHEDULE) 
 * for a shift bid auction. 
 *  
 * There are now two preferences for a shift bid request. The one in the actual bid request (SHIFTBIDREQUEST) and the one in this table.
 * The one in this table is used in the drop down list in the bid options page.  
 * This table started out as way to keep preferences for shift templates without actually creating a bid 
 * and then mass create bids from this table. Further changes to how it works ended up with the table containing preferences for shifts 
 * that are pending or escalated in addition to ones that have not yet been submitted.
 * When a shift bid request that is pending or escalated is modified it updates the preference in both
 * this table and the SHIFTBIDREQUEST table. However, when using the preference drop down in the bid options list it updates only the
 * UNSUBMITTEDSHIFTBIDPREFERENCE table.    
 * 
 */
<span class="nc" id="L33">public class UnsubmittedSchedulePreferenceDao extends BasicJdmoDao {</span>

	//unsubmitted preferences for an employee in an auction plus bids that are pending or escalated
	//withdrawn and invalid are considered as unsubmitted
	private static final String UN_SUBMITTED_PERFERENCE_FOR_EMPLOYEE_SQL =
			&quot;;with SubmittedRequests as ( &quot;
					+ &quot;	select RqstBSH.BIDDABLESCHEDULEID,SBR.PREFERENCE as BidRequestPreference, R.REQUESTSTATUS    &quot;
					+ &quot;	from SHIFTBIDREQSTBIDDABLESCHEDULE RqstBSH &quot;
					+ &quot;	inner join SHIFTBIDREQUEST SBR on RqstBSH.SHIFTBIDREQUESTID = SBR.ID &quot;
					+ &quot;	inner join SHIFTBIDDER SB on SB.ID = SBR.SHIFTBIDDERID &quot;
					+ &quot; inner join REQUEST R on R.ID = SBR.ID &quot;
					+ &quot;	where  SBR.SHIFTBIDAUCTIONID = ? and SB.EMPLOYEEID = ? and R.REQUESTSTATUS not in ('withdrawn', 'invalid') &quot;
					+ &quot;) &quot;
					+ &quot; select SBP.BIDDABLESCHEDULEID, SBP.Preference as UnSubmittedPreference, &quot;
					+ &quot; SubmittedRequests.BidRequestPreference, NUMOFAVAILINSTANCES as NumberOfAvailableShifts &quot;
					+ &quot; from UNSUBMITTEDSHIFTBIDPREFERENCE SBP   &quot;
					+ &quot; inner join BIDDABLESCHEDULE BSH on SBP.BiddableScheduleID = BSH.ID   &quot;
					+ &quot; inner join SHIFTBIDAUCTION A on BSH.SHIFTBIDAUCTIONID = A.ID    &quot;
					+ &quot; left join SubmittedRequests on SubmittedRequests.BIDDABLESCHEDULEID = SBP.BIDDABLESCHEDULEID &quot;
					+ &quot; where   A.ISFORSINGLESHIFTS = 0 and A.ID = ? and  SBP.EmployeeID = ? and BSH.NUMOFAVAILINSTANCES &gt; 0 and &quot;
					+ &quot; (SubmittedRequests.BIDDABLESCHEDULEID is null or SubmittedRequests.REQUESTSTATUS in ('pending', 'escalated') ) &quot;;


	private static final String UN_SUBMITTED_PERFERENCE_FOR_BIDDER_SQL_BASE =
			&quot;;with SubmittedRequests as ( &quot; +
					&quot;	select RqstBSH.BIDDABLESCHEDULEID,SBR.PREFERENCE as BidRequestPreference, R.REQUESTSTATUS &quot; +
					&quot;	from SHIFTBIDREQSTBIDDABLESCHEDULE RqstBSH &quot; +
					&quot;	inner join SHIFTBIDREQUEST SBR on RqstBSH.SHIFTBIDREQUESTID = SBR.ID &quot; +
					&quot;   inner join REQUEST R on R.ID = SBR.ID &quot; +
					&quot;	where  SBR.SHIFTBIDAUCTIONID = ? and SBR.SHIFTBIDDERID = ? and R.REQUESTSTATUS not in ('withdrawn', 'invalid') &quot; +
					&quot;) &quot; +
					&quot;select SBP.BIDDABLESCHEDULEID, SBP.Preference as UnSubmittedPreference,  SubmittedRequests.BidRequestPreference ,&quot; +
					&quot; SBP.EmployeeID, NUMOFAVAILINSTANCES as NumberOfAvailableShifts     &quot; +
					&quot; from UNSUBMITTEDSHIFTBIDPREFERENCE SBP    &quot; +
					&quot; inner join BIDDABLESCHEDULE BSH on SBP.BiddableScheduleID = BSH.ID    &quot; +
					&quot; inner join SHIFTBIDAUCTION A on BSH.SHIFTBIDAUCTIONID = A.ID   &quot; +
					&quot; inner join SHIFTBIDDER SB on SB.SHIFTBIDAUCTIONID = BSH.SHIFTBIDAUCTIONID and SB.EMPLOYEEID = SBP.EmployeeID   &quot; +
					&quot; left join SubmittedRequests on SubmittedRequests.BIDDABLESCHEDULEID = SBP.BIDDABLESCHEDULEID &quot; +
					&quot; where   A.ISFORSINGLESHIFTS = 0  and BSH.NUMOFAVAILINSTANCES &gt; 0 and A.ID = ? and  SB.ID = ?  and  &quot;;

	//unsubmitted preferences for a bidder in an auction plus bids that are pending or escalated
	//withdrawn and invalid are considered as unsubmitted
	private static final String UN_SUBMITTED_PERFERENCE_FOR_BIDDER_SQL_INCLUDE_PENDING = UN_SUBMITTED_PERFERENCE_FOR_BIDDER_SQL_BASE
			+ &quot; (SubmittedRequests.BIDDABLESCHEDULEID is null or SubmittedRequests.REQUESTSTATUS in ('pending', 'escalated') ) &quot;;

	//unsubmitted preferences for a bidder in an auction, does not include any bid request that have been submitted
	//withdrawn and invalid are considered as unsubmitted
	private static final String UN_SUBMITTED_PERFERENCE_FOR_BIDDER_SQL = UN_SUBMITTED_PERFERENCE_FOR_BIDDER_SQL_BASE
			+ &quot; (SubmittedRequests.BIDDABLESCHEDULEID is null) &quot;;

	/**
	 * The preference for requests that have not yet been submitted or requests that are in pending state for the given employee and auction
	 * Requests that are in withdrawn or invalid states are considered as not having been submitted (since they can be re-submitted) 
	 */
	public Map&lt;ID, ShiftBidPreference&gt; getUnsubmittedSchedulePreference(ID auctionID, ID employeeID) {
<span class="nc" id="L88">		List&lt;ShiftBidPreference&gt; preferences = JdmoOrm.toObjects(ShiftBidPreference.class, dmo, UN_SUBMITTED_PERFERENCE_FOR_EMPLOYEE_SQL,</span>
				auctionID, employeeID,
				auctionID,
				employeeID);

<span class="nc" id="L93">		return convertListToMap(preferences);</span>
	}

	private Map&lt;ID, ShiftBidPreference&gt; convertListToMap(List&lt;ShiftBidPreference&gt; preferences) {
<span class="nc" id="L97">		Map&lt;ID, ShiftBidPreference&gt; result = new HashMap&lt;ID, ShiftBidPreference&gt;(preferences.size());</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">		for (ShiftBidPreference p : preferences) {</span>
<span class="nc" id="L99">			result.put(p.getBiddableScheduleID(), p);</span>
<span class="nc" id="L100">		}</span>
<span class="nc" id="L101">		return result;</span>
	}

	/**
	 * The preference for requests that have not yet been submitted or requests that are in pending state for the given bidderID and auction
	 * Requests that are in withdrawn or invalid states are considered as not having been submitted (since they can be re-submitted) 
	 */
	public Map&lt;ID, ShiftBidPreference&gt; getUnsubmittedSchedulePreferenceForBidder(ID auctionID, ID bidderID) {
<span class="nc" id="L109">		List&lt;ShiftBidPreference&gt; preferences = JdmoOrm.toObjects(ShiftBidPreference.class, dmo,</span>
				UN_SUBMITTED_PERFERENCE_FOR_BIDDER_SQL_INCLUDE_PENDING,
				auctionID, bidderID, auctionID,
				bidderID);
<span class="nc" id="L113">		return convertListToMap(preferences);</span>
	}

	public void updateUnsubmittedSchedulePreference(Collection&lt;UnsubmittedShiftBidPreference&gt; preferences) {
		try {
			//write to temp table #MergePerferences
<span class="nc" id="L119">			WriteOptions options = new WriteOptions(&quot;#MergePerferences&quot;);</span>
			//we write the bidder id, not the employee id to the temp table so exclude employeeID
<span class="nc" id="L121">			options.setExcludedProperties(&quot;employeeID&quot;);</span>
<span class="nc" id="L122">			JdmoOrm.insertToTempTable(dmo, UnsubmittedShiftBidPreference.class, preferences, options);</span>

			//and merge the temp table to UNSUBMITTEDSHIFTBIDPREFERENCE
<span class="nc" id="L125">			String mergeSql = &quot;;merge UNSUBMITTEDSHIFTBIDPREFERENCE as dest &quot;</span>
					+ &quot; using ( &quot;
					+ &quot;  select mp.biddableScheduleID, SB.EMPLOYEEID, mp.UnSubmittedPreference &quot;
					+ &quot;  from #MergePerferences mp &quot;
					+ &quot;  inner join SHIFTBIDDER SB on SB.ID = mp.bidderID &quot;
					+ &quot; ) as src &quot;
					+ &quot; on src.BIDDABLESCHEDULEID = dest.BIDDABLESCHEDULEID and  src.EMPLOYEEID = dest.EMPLOYEEID &quot;
					+ &quot; when matched then update set dest.Preference = src.UnSubmittedPreference &quot;
					+ &quot; when not matched by target then &quot;
					+ &quot; insert (BIDDABLESCHEDULEID,EMPLOYEEID,Preference) Values (BIDDABLESCHEDULEID,EMPLOYEEID,UnSubmittedPreference); &quot;;

<span class="nc" id="L136">			dmo.execute(mergeSql);</span>

<span class="nc" id="L138">		} catch (JdmoException e) {</span>
<span class="nc" id="L139">			throw new RmRuntimeException(e);</span>
<span class="nc" id="L140">		}</span>
<span class="nc" id="L141">	}</span>

	/**
	 * The preference for requests that have not yet been submitted for the given bidderID and auction
	 * This does not include requests that are in pending state
	 * Requests that are in withdrawn or invalid states are considered as not having been submitted (since they can be re-submitted) 
	 */
	public List&lt;UnsubmittedShiftBidPreference&gt; getUnsubmittedSchedulePreferencesForBidder(ID auctionID, ID bidderID) {
<span class="nc" id="L149">		return JdmoOrm.toObjects(UnsubmittedShiftBidPreference.class, dmo, UN_SUBMITTED_PERFERENCE_FOR_BIDDER_SQL, auctionID, bidderID,</span>
				auctionID, bidderID);
	}

	// The number of available shifts for submitted bids (excluding withdrawn/invalid) 
	public int getAvailableShiftsForSubmittedBids(ID auctionID, ID bidderID) {
<span class="nc" id="L155">		String sql = &quot;select sum(NUMOFAVAILINSTANCES) as NumSubmittedRequests &quot; +</span>
				&quot;from SHIFTBIDREQUEST SBR  &quot; +
				&quot;inner join SHIFTBIDAUCTION A on SBR.SHIFTBIDAUCTIONID = A.ID &quot; +
				&quot;inner join SHIFTBIDREQSTBIDDABLESCHEDULE RqstBSH on RqstBSH.SHIFTBIDREQUESTID = SBR.ID &quot; +
				&quot;inner join BIDDABLESCHEDULE BSH on RqstBSH.BiddableScheduleID = BSH.ID    &quot; +
				&quot;inner join REQUEST R on R.ID = SBR.ID &quot; +
				&quot;where A.ISFORSINGLESHIFTS = 0 and A.ID = ? and SBR.SHIFTBIDDERID = ? and R.REQUESTSTATUS not in ('withdrawn', 'invalid') &quot;;
<span class="nc" id="L162">		return JdmoPreparedStatement.executeScalarInt(dmo, 0, sql, auctionID, bidderID);</span>

	}

	public String getTemplateNameFromBiddableScheduleID(ID biddableScheduleID) {

<span class="nc" id="L168">		String sql = &quot;select TemplateName from BIDDABLESCHEDULE BSCH where BSCH.ID = ?&quot;;</span>

<span class="nc" id="L170">		return JdmoPreparedStatement.executeScalarString(dmo, &quot;&quot;, sql, biddableScheduleID);</span>
	}

	/**
	 * update the  preference in the pending request to the one specified in the unsubmitted preference
	 */
	public void updatePendingPreferences(ID auctionID, ID bidderID) {
<span class="nc" id="L177">		String sql = &quot;update SBR  set  SBR.PREFERENCE = USBP.PREFERENCE &quot; +</span>
				&quot;from SHIFTBIDREQUEST SBR &quot; +
				&quot;inner join SHIFTBIDREQSTBIDDABLESCHEDULE RqstBSH on RqstBSH.SHIFTBIDREQUESTID = SBR.ID &quot; +
				&quot;inner join REQUEST R on R.ID = SBR.ID &quot; +
				&quot;inner join SHIFTBIDDER SB on SB.EMPLOYEEID = R.EMPLOYEEID  &quot; +
				&quot;inner join UNSUBMITTEDSHIFTBIDPREFERENCE USBP on USBP.BIDDABLESCHEDULEID =  RqstBSH.BIDDABLESCHEDULEID &quot; +
				&quot; and USBP.EMPLOYEEID = R.EMPLOYEEID &quot; +
				&quot;where R.RequestStatus in ('pending', 'escalated') and SB.SHIFTBIDAUCTIONID = ? and SB.ID = ? and  USBP.PREFERENCE &gt; 0&quot;;

		try {
<span class="nc" id="L187">			JdmoPreparedStatement.executeSql(dmo, sql, auctionID, bidderID);</span>
<span class="nc" id="L188">		} catch (JdmoException e) {</span>
<span class="nc" id="L189">			throw new RmRuntimeException(e);</span>
<span class="nc" id="L190">		}</span>

<span class="nc" id="L192">	}</span>

	/**
	 * update the unsubmitted preference to the one in the pending request
	 */
	public static void updateUnsubmittedPreferences(Jdmo dmo, ID requestID) {
<span class="nc" id="L198">		String sql = &quot;;merge UNSUBMITTEDSHIFTBIDPREFERENCE as dest &quot; +</span>
				&quot;using ( &quot; +
				&quot;	select RqstBSH.BIDDABLESCHEDULEID, R.EmployeeID, SBR.PREFERENCE &quot; +
				&quot;	from REQUEST R &quot; +
				&quot;	inner join SHIFTBIDREQUEST SBR on SBR.ID = R.ID  &quot; +
				&quot;	inner join SHIFTBIDREQSTBIDDABLESCHEDULE RqstBSH on RqstBSH.SHIFTBIDREQUESTID = R.ID  &quot; +
				&quot;	where R.ID = ? and R.RequestStatus in ('pending', 'escalated')  &quot; +
				&quot;) as src &quot; +
				&quot;on src.BIDDABLESCHEDULEID = dest.BIDDABLESCHEDULEID and  src.EMPLOYEEID = dest.EMPLOYEEID &quot; +
				&quot;when matched then update set dest.Preference = src.PREFERENCE &quot; +
				&quot;when not matched by target then &quot; +
				&quot;insert (BIDDABLESCHEDULEID,EMPLOYEEID,Preference) Values (BIDDABLESCHEDULEID,EMPLOYEEID,PREFERENCE);&quot;;
		
		try {
<span class="nc" id="L212">			JdmoPreparedStatement.executeSql(dmo, sql, requestID);</span>
<span class="nc" id="L213">		} catch (JdmoException e) {</span>
<span class="nc" id="L214">			throw new RmRuntimeException(e);</span>
<span class="nc" id="L215">		}</span>

<span class="nc" id="L217">	}</span>
	
	public static void deleteUnsubmittedPreferences(Jdmo dmo, ID requestID) {

<span class="nc" id="L221">		String sql = &quot;delete  USP from UNSUBMITTEDSHIFTBIDPREFERENCE USP &quot; +</span>
				&quot;inner join SHIFTBIDREQSTBIDDABLESCHEDULE RqstBSH on RqstBSH.BIDDABLESCHEDULEID = USP.BIDDABLESCHEDULEID &quot; +
				&quot;inner join REQUEST R on RqstBSH.SHIFTBIDREQUESTID = R.ID and USP.EMPLOYEEID = R.EMPLOYEEID &quot; +
				&quot;where R.ID = ?&quot;;

		try {
<span class="nc" id="L227">			JdmoPreparedStatement.executeSql(dmo, sql, requestID);</span>
<span class="nc" id="L228">		} catch (JdmoException e) {</span>
<span class="nc" id="L229">			throw new RmRuntimeException(e);</span>
<span class="nc" id="L230">		}</span>
<span class="nc" id="L231">	}</span>

	/*
	 * This returns preferences that would be duplicates if we  create new request or update pending/escalated request from
	 * the UNSUBMITTEDSHIFTBIDPREFERENCE table. 
	 * 
	 *  We need to check if duplicate preference would be created for shift bid requests if the following operations are done
	 *  
	 *   1. Update the preference with the one in the UNSUBMITTEDSHIFTBIDPREFERENCE table for existing pending/escalated shift bid requests
	 *    
	 *   2. For rows in UNSUBMITTEDSHIFTBIDPREFERENCE that do not match with existing requests (excluding withdrawn and invalid requests) 
	 *   	create new shift bid requests with the preference in UNSUBMITTEDSHIFTBIDPREFERENCE
	 *   
	 * 
	 * 
	 */
	public List&lt;Integer&gt; getDuplicatePreferences(ID auctionID, ID bidderID) {
<span class="nc" id="L248">		String sql = &quot;;with SubmittedPrefrences as (   &quot; +</span>
				&quot;	select RqstBSH.BIDDABLESCHEDULEID, SBR.PREFERENCE,R.EMPLOYEEID,R.RequestStatus    &quot; +
				&quot;	from SHIFTBIDREQUEST SBR    &quot; +
				&quot;	inner join SHIFTBIDREQSTBIDDABLESCHEDULE RqstBSH on RqstBSH.SHIFTBIDREQUESTID = SBR.ID      &quot; +
				&quot;	inner join REQUEST R on R.ID = SBR.ID      &quot; +
				&quot;	where   SBR.SHIFTBIDAUCTIONID = ? and SBR.SHIFTBIDDERID = ? and REQUESTSTATUS not in ( 'withdrawn', 'invalid')   &quot; +
				&quot;)    &quot; +
				&quot;, PreferencesAfterUpdate as  (    &quot; +
				&quot;	select isnull(USBP.PREFERENCE,SP.PREFERENCE) as Preference, SP.REQUESTSTATUS,   &quot; +
				&quot;			isnull(SP.BIDDABLESCHEDULEID,USBP.BIDDABLESCHEDULEID) as BIDDABLESCHEDULEID   &quot; +
				&quot;	from SubmittedPrefrences SP    &quot; +
				&quot;	full outer join ( &quot; +
				&quot;		select USBP.BIDDABLESCHEDULEID,USBP.EMPLOYEEID, USBP.PREFERENCE &quot; +
				&quot;		from   UNSUBMITTEDSHIFTBIDPREFERENCE USBP &quot; +
				&quot;		inner join SHIFTBIDDER SB on USBP.EMPLOYEEID = SB.EMPLOYEEID &quot; +
				&quot;		inner join BIDDABLESCHEDULE BSH on BSH.ID = USBP.BIDDABLESCHEDULEID  and BSH.SHIFTBIDAUCTIONID = SB.SHIFTBIDAUCTIONID &quot; +
				&quot;		where BSH.SHIFTBIDAUCTIONID = ? and SB.ID = ?  &quot; +
				&quot;	) USBP on USBP.BIDDABLESCHEDULEID = SP.BIDDABLESCHEDULEID  	and USBP.EMPLOYEEID = SP.EMPLOYEEID   &quot; +
				&quot;)    &quot; +
				&quot;select Preference     &quot; +
				&quot;from PreferencesAfterUpdate    &quot; +
				&quot;	inner join  BIDDABLESCHEDULE BSH on BSH.ID = BIDDABLESCHEDULEID   &quot; +
				&quot;where Preference &gt; 0 and BSH.NUMOFAVAILINSTANCES &gt; 0   &quot; +
				&quot;		and (REQUESTSTATUS is null Or REQUESTSTATUS in ('pending', 'escalated') )   &quot; +
				&quot;group by Preference    &quot; +
				&quot;having count(*) &gt; 1&quot;;
		
<span class="nc" id="L275">		return JdmoPreparedStatement.getIntegerList(dmo, sql, auctionID, bidderID, auctionID, bidderID);</span>
	}


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>