<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftSwapRequestFormPopupPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.shiftswap</a> &gt; <span class="el_source">ShiftSwapRequestFormPopupPM.java</span></div><h1>ShiftSwapRequestFormPopupPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.shiftswap;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.util.BPMessageFormat;
import com.bluepumpkin.common.util.DateTimeUtil;
import com.bluepumpkin.common.util.PersonNameUtil;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.workresource.ejb.WorkResourceManager;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.swap.posting.model.ShiftSwapPosting;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.swap.shiftitem.model.ShiftSwapItem;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.rm.keys.RmKeys;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.l10n.RmWebLogBundleKey;
import com.bluepumpkin.web.rm.requests.RequestUtil;
import com.bluepumpkin.web.rm.requests.RequestsMH;
import com.bluepumpkin.web.rm.requests.SwapFormPopupPM;
import com.bluepumpkin.web.rm.requests.SwapUtil;
import com.bluepumpkin.web.rm.requests.swapboard.RequestsSwapBoardMH;
import com.verint.ejb.wfm.WfmManagerFactory;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.message.MessagePC;
import com.witness.web.uif.pagecomponent.picker.date.DatePickerPC;
import com.witness.web.uif.pagecomponent.picker.date.DateRangePickerPC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.html.HtmlChoiceInput;
import com.witness.web.uif.util.js.JSUtil;
import com.witness.web.uif.validator.InLengthRangeFieldValidator;

/**
 * Title:        ShiftSwapRequestFormPopupPM
 * Description:  Form to Create or Edit Shift Swap Request
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc
 * @author       David Su, dsu
 * @version      1.0
 *
 * Created on November 5, 2002, 10:20 AM
 */
public class ShiftSwapRequestFormPopupPM extends SwapFormPopupPM {
	private static final String TD_CLOSE_TAG = &quot;\&quot;&gt;&lt;td&gt;&quot;;

	private static final int NEG_COMMENT_MAX_LEN = 500;

	public static final String POSTING_ID_FN     = &quot;postingID&quot;;
	public static final String AGENT_ID_FN       = &quot;agentID&quot;;
	//Swap OUT date
	public static final String REQUEST_DATE_1_FN = &quot;requestDate1&quot;;
	//Swap IN date
	public static final String REQUEST_DATE_2_FN = &quot;requestDate2&quot;;
	public static final String SUBMIT2MGR_FN     = &quot;isSubmitToMgr&quot;;
	public static final String NEGOTIATION_CMT_FN = &quot;negotiationComment&quot;;
	public static final String SUBMIT_TO_MANAGER_ONLY_FN = &quot;showSubmitToManagerOnly&quot;;
	public static final String PARTIAL_SWAP_FN = &quot;isSwapPartial&quot;;
	public static final String PARTIAL_PICKUP_FN = &quot;isPickupPartial&quot;;
	private static final String TIMERANGE_SWAP_FN  = &quot;timeRangeSwap&quot;;
	private static final String TIMERANGE_PICKUP_FN  = &quot;timeRangePickup&quot;;
	private static final String CUSTOM_DYNAMIC_ROW_CLASS_VARIABLE = &quot;customDynamicRowClass&quot;;
	private static final String CUSTOM_DYNAMIC_ROW_CLASS = &quot;customDynamicRow&quot;;
	

	private ShiftSwapRequest m_ssRequest;
	private ShiftSwapPosting shiftSwapPosting;
	private ID shiftSwapPostingID;

<span class="nc" id="L94">	private Collection m_eNames = Collections.emptyList();</span>
<span class="nc" id="L95">	private Map&lt;ID, EmployeeName&gt; idNameMap = Collections.emptyMap();</span>
<span class="nc" id="L96">	private final HashMap m_orgSettingMap = new HashMap();</span>
<span class="nc" id="L97">	private Map&lt;ID, ID&gt; empOrgIDMap = Collections.emptyMap();</span>
	private String m_shiftType;
	private ID m_agentID1;
	private ID m_agentID2;
	
	private Date m_expireTime1;
	private Date m_expireTime2;
<span class="nc" id="L104">	private boolean m_isSubmitToMgr=false;</span>
<span class="nc" id="L105">	private boolean m_isNegotiable1=true;</span>
<span class="nc" id="L106">	private boolean m_isNegotiable2=true;</span>
<span class="nc" id="L107">	private boolean m_isRequestSaved=false;</span>
<span class="nc" id="L108">	private boolean m_isWithdrawConfirmed=false;</span>
<span class="nc" id="L109">	private ShiftSwapItem m_ssItem1=null;</span>
<span class="nc" id="L110">	private ShiftSwapItem m_ssItem2=null;</span>
<span class="nc" id="L111">	private boolean m_allowPartial=true;</span>
	private Date m_requestEndDate;
	private DateRangePickerPC swapDateRangePickerPC;
	private DateRangePickerPC pickupDateRangePickerPC;
	Date swapOutDate; // what the agent gives away
	Date swapInDate;
	Date partialSwapOutStartDate;
	Date partialSwapOutEndDate;
	Date partialSwapInStartDate;
	Date partialSwapInEndDate;
	boolean swapOutPartial;
	boolean swapInPartial;

	//Determines whether user should only be shown the 'Submit to Manager' section.
<span class="nc" id="L125">	private boolean m_showSubmitToManagerOnly=false;</span>

	
	
	/**
	 * Constructor
	 */
	public ShiftSwapRequestFormPopupPM(RequestContext context) {

<span class="nc" id="L134">		super(context, RmKeys.RH_SHIFTSWAP_FORM);</span>

<span class="nc" id="L136">		initNewShiftSwapRequest(context);</span>

		// Add Field Validator
<span class="nc" id="L139">		addValidator(new InLengthRangeFieldValidator(this, COMMENT_FN, RmWebBundleKey.SWAP_REQUEST_SUBMIT_TO_MGR_COMMENT,</span>
				RmWebBundleKey.BUNDLE_NAME, 0, 200));

<span class="nc" id="L142">		addValidator(new InLengthRangeFieldValidator(this, NEGOTIATION_CMT_FN, RmWebBundleKey.SWAP_REQUEST_NEGOTIATION_COMMENT,</span>
				RmWebBundleKey.BUNDLE_NAME, 0, 500));

<span class="nc" id="L145">		initDateRangePickers();</span>

<span class="nc bnc" id="L147" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L148">			addJSVariableAsString(CUSTOM_DYNAMIC_ROW_CLASS_VARIABLE, CUSTOM_DYNAMIC_ROW_CLASS);</span>
<span class="nc" id="L149">			appendJSToJSMain(&quot;initSwapPopup();&quot;);</span>
		}
<span class="nc" id="L151">	}</span>
	
	@Override
	protected void setMainPCAriaTitle(String mainPCAriaTitle) {
<span class="nc" id="L155">		String selectionDependentContentMsg = HtmlUtil</span>
<span class="nc" id="L156">				.makeHiddenReadableText(i18n(m_bundle, RmWebBundleKey.RM_SA_FILTER_REGION_DESC));</span>
<span class="nc" id="L157">		super.setMainPCAriaTitle(mainPCAriaTitle + selectionDependentContentMsg);</span>
<span class="nc" id="L158">	}</span>

	@Override
	protected void initDataPickersWithOrgWeekStartDay(int weekStartDay) {
<span class="nc" id="L162">		swapDateRangePickerPC.setFirstDayOfWeek(weekStartDay);</span>
<span class="nc" id="L163">		pickupDateRangePickerPC.setFirstDayOfWeek(weekStartDay);</span>
<span class="nc" id="L164">	}</span>

	/**
	 * Initialize New Shift Swap Request
	 */
	private void initNewShiftSwapRequest(RequestContext context) {
<span class="nc" id="L170">		setShiftSwapRequest(new ShiftSwapRequest(ShiftSwapRequest.DL_BASIC));</span>
<span class="nc" id="L171">		m_ssRequest.setSwapType(ShiftSwapRequest.SHIFTSWAP_TYPE_TWOWAY);</span>
<span class="nc" id="L172">		m_ssRequest.setRequestStatus(RequestAuditTrail.STATUS_NEGOTIATION);</span>
<span class="nc" id="L173">		m_agentID1 = m_empID;</span>

<span class="nc" id="L175">		String showSubmitToManagerOnly = (String)context.getAttribute(RequestContext.REQUEST_SCOPE, RmKeys.SHIFT_SWAP_FORM_SHOW_SUBMIT_ONLY);</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">		if (showSubmitToManagerOnly != null)</span>
		{
<span class="nc" id="L178">			m_showSubmitToManagerOnly = showSubmitToManagerOnly.equals(&quot;true&quot;);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">			if (m_showSubmitToManagerOnly)</span>
			{
				//The default for the submit to manager checkbox should be true
<span class="nc" id="L182">				m_isSubmitToMgr = true;</span>
			}
		}
<span class="nc" id="L185">	}</span>

	private void initDateRangePickers(){
<span class="nc" id="L188">		initPickupDateRangePicker();</span>
<span class="nc" id="L189">		initSwapDateRangePicker();</span>
<span class="nc" id="L190">	}</span>

	/**
	 * Create and add Date Range Picker as Child Component
	 */
	private void initPickupDateRangePicker() {
<span class="nc" id="L196">		Date nowDate = new Date();</span>
<span class="nc" id="L197">		pickupDateRangePickerPC = new DateRangePickerPC(m_context, TIMERANGE_PICKUP_FN);</span>
<span class="nc" id="L198">		pickupDateRangePickerPC.setIsTimeEnabled(true);</span>
<span class="nc" id="L199">		setDateRangePickerStartAndEnd(pickupDateRangePickerPC);</span>
<span class="nc" id="L200">		pickupDateRangePickerPC.getStartDatePickerPC().setTimeInterval(15);</span>
<span class="nc" id="L201">		pickupDateRangePickerPC.getEndDatePickerPC().setTimeInterval(15);</span>
<span class="nc" id="L202">		pickupDateRangePickerPC.getStartDatePickerPC().setLowerLimit(nowDate);// Prevent Date in the past</span>
<span class="nc" id="L203">		pickupDateRangePickerPC.getEndDatePickerPC().setLowerLimit(nowDate);</span>
		
<span class="nc bnc" id="L205" title="All 2 branches missed.">		if (!this.isCreateRequestFromPosting()) {</span>
<span class="nc" id="L206">			pickupDateRangePickerPC.getStartDatePickerPC().setOnChangeJS(JSUtil.REFRESH_PAGE_NO_CONFIRM);</span>
<span class="nc" id="L207">			pickupDateRangePickerPC.getEndDatePickerPC().setOnChangeJS(JSUtil.REFRESH_PAGE_NO_CONFIRM);</span>
		}
<span class="nc" id="L209">		addAriaLabelToDatePicker(pickupDateRangePickerPC, i18n(m_bundle, RmWebBundleKey.PARTIAL_SHIFT));</span>
<span class="nc" id="L210">		addChildComponent(pickupDateRangePickerPC);</span>
<span class="nc" id="L211">	}</span>

	/**
	 * Create and add Date Range Picker as Child Component
	 */
	private void initSwapDateRangePicker() {
<span class="nc" id="L217">		Date nowDate = new Date();</span>
<span class="nc" id="L218">		swapDateRangePickerPC = new DateRangePickerPC(m_context, TIMERANGE_SWAP_FN);</span>
<span class="nc" id="L219">		swapDateRangePickerPC.setIsTimeEnabled(true);</span>
		
<span class="nc" id="L221">		setDateRangePickerStartAndEnd(swapDateRangePickerPC);</span>
<span class="nc" id="L222">		swapDateRangePickerPC.getStartDatePickerPC().setTimeInterval(15);</span>
<span class="nc" id="L223">		swapDateRangePickerPC.getEndDatePickerPC().setTimeInterval(15);</span>
<span class="nc" id="L224">		swapDateRangePickerPC.getStartDatePickerPC().setLowerLimit(nowDate);// Prevent Date in the past</span>
<span class="nc" id="L225">		swapDateRangePickerPC.getEndDatePickerPC().setLowerLimit(nowDate);</span>
		
<span class="nc bnc" id="L227" title="All 2 branches missed.">		if (!this.isCreateRequestFromPosting()) {</span>
<span class="nc" id="L228">			swapDateRangePickerPC.getStartDatePickerPC().setOnChangeJS(JSUtil.REFRESH_PAGE_NO_CONFIRM);</span>
<span class="nc" id="L229">			swapDateRangePickerPC.getEndDatePickerPC().setOnChangeJS(JSUtil.REFRESH_PAGE_NO_CONFIRM);</span>
		}
<span class="nc" id="L231">		addAriaLabelToDatePicker(swapDateRangePickerPC, i18n(m_bundle, RmWebBundleKey.PARTIAL_SHIFT));</span>
<span class="nc" id="L232">		addChildComponent(swapDateRangePickerPC);</span>
<span class="nc" id="L233">	}</span>
	
	protected void addAriaLabelToDatePicker(DateRangePickerPC dateRangePicker, String text) {
<span class="nc bnc" id="L236" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L237">			DatePickerPC startDatePicker = dateRangePicker.getStartDatePickerPC();</span>
<span class="nc" id="L238">			DatePickerPC endDatePicker = dateRangePicker.getEndDatePickerPC();</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">			if (startDatePicker != null) {</span>
<span class="nc" id="L240">				startDatePicker.setAriaLabel(text + &quot; &quot; + i18n(m_common_bundle, UIFWebBundleKey.START_DATE));</span>
			}
<span class="nc bnc" id="L242" title="All 2 branches missed.">			if (endDatePicker != null) {</span>
<span class="nc" id="L243">				endDatePicker.setAriaLabel(text + &quot; &quot; + i18n(m_common_bundle, UIFWebBundleKey.END_DATE));</span>
			}
		}
<span class="nc" id="L246">	}</span>

	/**
	 * Return an instance of the model that is ready for rendering
	 */
	public static PageModel getInstance(RequestContext context) throws Exception {
<span class="nc" id="L252">		return getInstance(context, ShiftSwapRequestFormPopupPM.class);</span>
	}

	/**
	 * Load Specific Data
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	@Override
	protected void loadSpecificData() throws Exception {
		
		//JT
<span class="nc bnc" id="L263" title="All 2 branches missed.">		if (isCreateNewFromScratch()) {</span>
<span class="nc" id="L264">			Date earliestDate = this.getEarliestDate();</span>
<span class="nc" id="L265">			m_eNames = ShiftSwapRequestsMH.getEmpNamesOneCanSwapShiftWith(m_context, m_empID, earliestDate);</span>
<span class="nc" id="L266">			fillOrgSettingMap(earliestDate);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">		} else if (isCreateRequestFromPosting()) {</span>
			
			
<span class="nc" id="L270">			ID postingID = getPostingID();</span>
<span class="nc" id="L271">			shiftSwapPosting = RequestsSwapBoardMH.getPostingByID(postingID);</span>
<span class="nc" id="L272">			idNameMap = RequestsSwapBoardMH.getEmployeeNameMap(m_context, shiftSwapPosting);</span>
<span class="nc" id="L273">			processShiftSwapPosting(shiftSwapPosting);</span>
<span class="nc" id="L274">		} else {</span>
<span class="nc" id="L275">			ID requestID = getRequestID();</span>
<span class="nc" id="L276">			ShiftSwapRequest request = ShiftSwapRequestsMH.getRequestByID(requestID);</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">			if (request == null) {</span>
<span class="nc" id="L278">				this.addPageMessage(Message.ERROR_TYPE, i18n(m_bundle, RmWebBundleKey.REQUEST_NOT_FOUND_ERROR));</span>
<span class="nc" id="L279">				initToolbar(false);</span>
			} else {
<span class="nc" id="L281">				m_isAuthorized = RequestUtil.isAuthToUpdate(m_context, request);</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">				if (m_isAuthorized) {</span>
<span class="nc" id="L283">					idNameMap = ShiftSwapRequestsMH.getEmpNameMapForRequest(m_context, request);</span>
<span class="nc" id="L284">					processShiftSwapRequest(request);</span>
				}
			}
		}
<span class="nc" id="L288">	}</span>

	
	Date getEarliestDate() {
<span class="nc bnc" id="L292" title="All 2 branches missed.">		if (getSwapType().equals(&quot;two-way&quot;)) {</span>
			// Two controls enabled.
<span class="nc" id="L294">			return SwapUtil.getEarliestDateTwoWay(getIsSwapOutPartial(), getIsSwapInPartial(), partialSwapOutStartDate,</span>
					partialSwapInStartDate, this.swapOutDate, this.swapInDate);

		} else {
<span class="nc" id="L298">			Date fullSwapDate = swapOutDate;</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">			if (!getShiftType().equals(&quot;shift&quot;)) {</span>
<span class="nc" id="L300">				fullSwapDate = swapInDate;</span>
			}
<span class="nc" id="L302">			return SwapUtil.getEarliestDateOneWay(getIsSwapOutPartial(), partialSwapOutStartDate, fullSwapDate);</span>
		}
	}
	

	

	

	private void fillOrgSettingMap(Date effectiveDate){
//		 Sort Employee Names
<span class="nc" id="L313">		List&lt;EmployeeName&gt; sortedEmpNames = new ArrayList&lt;EmployeeName&gt;(m_eNames);</span>
<span class="nc" id="L314">		PersonNameUtil.sort(sortedEmpNames, true, m_localeContext);</span>
<span class="nc" id="L315">		ArrayList&lt;ID&gt; empList = new ArrayList&lt;ID&gt;();</span>
		// Convert to Options
<span class="nc bnc" id="L317" title="All 2 branches missed.">		for(EmployeeName eName : sortedEmpNames ) {</span>
<span class="nc" id="L318">			empList.add(eName.getID());</span>
<span class="nc" id="L319">		}</span>

		//add array of empOrgs: get orgs for the employees
<span class="nc" id="L322">		HashSet orgIDSet = new HashSet();</span>
		try {
<span class="nc" id="L324">			empOrgIDMap = OrganizationModelHandler.getEmployeeOrgMap(m_context, empList, effectiveDate);</span>

<span class="nc bnc" id="L326" title="All 2 branches missed.">			for (Iterator it = empOrgIDMap.values().iterator(); it.hasNext(); ){</span>
<span class="nc" id="L327">				orgIDSet.add(it.next());</span>
			}

<span class="nc bnc" id="L330" title="All 2 branches missed.">			for (Iterator orgIDSetIter = orgIDSet.iterator(); orgIDSetIter.hasNext();){</span>
<span class="nc" id="L331">				ID orgID = (ID)orgIDSetIter.next();</span>
<span class="nc" id="L332">				OrganizationSetting orgSetting = RequestsMH.getOrgSetting(orgID);</span>
<span class="nc" id="L333">				m_orgSettingMap.put(orgID, orgSetting);</span>
<span class="nc" id="L334">			}</span>
<span class="nc" id="L335">		} catch (Exception ex){</span>
<span class="nc" id="L336">			this.log.error(ex.getMessage(), ex);</span>
<span class="nc" id="L337">		}</span>
<span class="nc" id="L338">	}</span>

	/**
	 * Process Request for Edit
	 */
	private void processShiftSwapRequest(ShiftSwapRequest request) {
<span class="nc" id="L344">		setShiftSwapRequest(request);</span>

<span class="nc" id="L346">		List ssItems = request.getShiftSwapItems();</span>
<span class="nc" id="L347">		m_ssItem1 = (ShiftSwapItem)ssItems.get(0);</span>
<span class="nc" id="L348">		m_ssItem2 = (ShiftSwapItem)ssItems.get(1);</span>

		// Determine which item to be displayed first
<span class="nc bnc" id="L351" title="All 2 branches missed.">		if (!m_empID.equals(m_ssItem1.getEmployeeID()) &amp;&amp;</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">				m_empID.equals(m_ssItem2.getEmployeeID())) {</span>
<span class="nc" id="L353">			ShiftSwapItem tmpItem = m_ssItem1;</span>
<span class="nc" id="L354">			m_ssItem1 = m_ssItem2;</span>
<span class="nc" id="L355">			m_ssItem2 = tmpItem;</span>
		}

<span class="nc" id="L358">		m_agentID1 = m_ssItem1.getEmployeeID();</span>
<span class="nc" id="L359">		m_shiftType = m_ssItem1.getShiftType();</span>
<span class="nc" id="L360">		swapOutDate = m_ssItem1.getStartDate();</span>
<span class="nc" id="L361">		m_expireTime1 = m_ssItem1.getExpirationDate();</span>
<span class="nc" id="L362">		m_isNegotiable1 = m_ssItem1.getNegotiation();</span>

<span class="nc" id="L364">		m_agentID2 = m_ssItem2.getEmployeeID();</span>
<span class="nc" id="L365">		swapInDate = m_ssItem2.getStartDate();</span>
<span class="nc" id="L366">		m_expireTime2 = m_ssItem2.getExpirationDate();</span>
<span class="nc" id="L367">		m_isNegotiable2 = m_ssItem2.getNegotiation();</span>

<span class="nc bnc" id="L369" title="All 2 branches missed.">		if (m_isRequestSaved) {</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">			if (request.getWithdrawInfo()!=null){</span>
<span class="nc" id="L371">				RequestUtil.addSavedRequestMsg(request.getWithdrawInfo().getRequestStatus(), this);</span>
			} else {
<span class="nc" id="L373">				RequestUtil.addSavedRequestMsg(request, this);</span>
			}
		}
<span class="nc" id="L376">	}</span>

	/**
	 * Process Posting to create New Request
	 */
	private void processShiftSwapPosting(ShiftSwapPosting posting) {
<span class="nc" id="L382">		setSwapType(posting.getSwapType());</span>

<span class="nc" id="L384">		ShiftSwapItem item = posting.getShiftSwapItem();</span>
<span class="nc" id="L385">		Date shiftDate = item.getStartDate();</span>
<span class="nc" id="L386">		Date shiftEndDate = item.getEndDate();</span>
<span class="nc" id="L387">		String shiftType = item.getShiftType();</span>

		// Keep extracted value if available
<span class="nc bnc" id="L390" title="All 2 branches missed.">		if (m_expireTime1==null) {</span>
<span class="nc" id="L391">			m_expireTime1 = createNewOfferExpDate();</span>
		}
<span class="nc" id="L393">		String nComment = getNegotiationComment();</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">		if (StringUtil.isEmpty(nComment)) {</span>
<span class="nc" id="L395">			setNegotiationComment(posting.getComment());</span>
		}

<span class="nc bnc" id="L398" title="All 2 branches missed.">		if (isTwoWaySwap()) {</span>
<span class="nc" id="L399">			m_shiftType = shiftType;</span>

			// Keep extracted date if available
<span class="nc bnc" id="L402" title="All 2 branches missed.">			if (swapOutDate==null) {</span>
<span class="nc" id="L403">				swapOutDate = shiftDate;</span>
			}
		} else {
<span class="nc bnc" id="L406" title="All 2 branches missed.">				m_shiftType = SwapUtil.isTimeOffShift(shiftType)</span>
						? ShiftSwapItem.SWAPITEMTYPE_SHIFT
						: ShiftSwapItem.SWAPITEMTYPE_TIMEOFF;
<span class="nc" id="L409">			swapOutDate = shiftDate;</span>
		}
<span class="nc" id="L411">		m_requestEndDate = shiftEndDate;</span>
<span class="nc" id="L412">		m_agentID2 = item.getEmployeeID();</span>
<span class="nc" id="L413">		swapInDate = shiftDate;</span>
<span class="nc" id="L414">		m_expireTime2 = item.getExpirationDate();</span>
<span class="nc" id="L415">		m_isNegotiable2 = item.getNegotiation();</span>
<span class="nc" id="L416">		m_allowPartial = item.getAllowPartial();</span>

		//set values of date range pickers
<span class="nc bnc" id="L419" title="All 2 branches missed.">		if (partialSwapOutStartDate == null) {</span>
<span class="nc" id="L420">			partialSwapOutStartDate = shiftDate;</span>
		}
<span class="nc bnc" id="L422" title="All 2 branches missed.">		if (partialSwapOutEndDate == null) {</span>
<span class="nc" id="L423">			partialSwapOutEndDate = shiftEndDate;</span>
		}
<span class="nc bnc" id="L425" title="All 2 branches missed.">		if (partialSwapInStartDate == null) {</span>
<span class="nc" id="L426">			partialSwapInStartDate = shiftDate;</span>
		}
<span class="nc bnc" id="L428" title="All 2 branches missed.">		if (partialSwapInEndDate == null) {</span>
<span class="nc" id="L429">			partialSwapInEndDate = shiftEndDate;</span>
		}
		
		
		// We don't want refreshes if from posting
<span class="nc" id="L434">		pickupDateRangePickerPC.getStartDatePickerPC().setOnChangeJS(JSUtil.ON_CHANGE);</span>
<span class="nc" id="L435">		pickupDateRangePickerPC.getEndDatePickerPC().setOnChangeJS(JSUtil.ON_CHANGE);</span>

<span class="nc" id="L437">		swapDateRangePickerPC.getStartDatePickerPC().setOnChangeJS(JSUtil.ON_CHANGE);</span>
<span class="nc" id="L438">		swapDateRangePickerPC.getEndDatePickerPC().setOnChangeJS(JSUtil.ON_CHANGE);</span>

<span class="nc" id="L440">		pickupDateRangePickerPC.getStartDatePickerPC().setDate(partialSwapInStartDate);</span>
<span class="nc" id="L441">		pickupDateRangePickerPC.getEndDatePickerPC().setDate(partialSwapInEndDate);</span>

<span class="nc" id="L443">		swapDateRangePickerPC.getStartDatePickerPC().setDate(partialSwapOutStartDate);</span>
<span class="nc" id="L444">		swapDateRangePickerPC.getEndDatePickerPC().setDate(partialSwapOutEndDate);</span>
		
		
		
<span class="nc" id="L448">	}</span>

	/**
	 * Prepare content title for rendering
	 */
	@Override
	protected void initContentTitle() {
<span class="nc bnc" id="L455" title="All 2 branches missed.">		String rbKey = isNew()</span>
<span class="nc bnc" id="L456" title="All 4 branches missed.">				? (isCreateRequestFromPosting()</span>
				? RmWebBundleKey.CREATE_NEW_REQUEST_FROM_POSTING
				: RmWebBundleKey.CREATE_NEW_REQUEST
				)
				: (m_showSubmitToManagerOnly ? RmWebBundleKey.SWAP_REQUEST_SUBMIT_TO_MGR_COMMENT : RmWebBundleKey.EDIT_REQUEST);

<span class="nc" id="L462">		String pageTitle = i18n(m_bundle, rbKey);</span>

<span class="nc" id="L464">		String itemName = i18n(m_bundle, RmWebBundleKey.REQUEST_TYPE_SHIFT_SWAP);</span>
<span class="nc" id="L465">		m_contentTitlePC.setPageTitle(pageTitle);</span>
<span class="nc" id="L466">		m_contentTitlePC.setItemName(itemName);</span>
<span class="nc" id="L467">	}</span>

	/**
	 * Add List Content
	 */
	@Override
	protected void addListContent(List listModel)
	{
<span class="nc" id="L475">		resetAriaTitleArgs();</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">		if (isWithdrawConfirmation()){</span>
<span class="nc" id="L477">			addWithdrawApproveSentance(listModel);</span>
<span class="nc bnc" id="L478" title="All 6 branches missed.">		} else if (canSwapPartial() &amp;&amp; (shiftSwapPosting != null &amp;&amp; shiftSwapPosting.getShiftSwapItem().getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_SHIFT) ||</span>
<span class="nc bnc" id="L479" title="All 4 branches missed.">				(isCreateNewFromScratch() &amp;&amp; this.getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_SHIFT)))){</span>
<span class="nc" id="L480">			addPartialSwapSentence(listModel);</span>
		} else {
<span class="nc" id="L482">			addSwapSentence(listModel);</span>
		}
<span class="nc bnc" id="L484" title="All 2 branches missed.">		if (!m_showSubmitToManagerOnly)</span>
		{
<span class="nc bnc" id="L486" title="All 6 branches missed.">			if (canSwapPartial() &amp;&amp; ((shiftSwapPosting != null &amp;&amp; shiftSwapPosting.getShiftSwapItem().getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_SHIFT)) ||</span>
<span class="nc bnc" id="L487" title="All 6 branches missed.">					(isCreateNewFromScratch() &amp;&amp; getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_SHIFT))) &amp;&amp; getRequestID()==null){</span>
<span class="nc bnc" id="L488" title="All 4 branches missed.">				if (isTwoWaySwap() || isCreateNewFromScratch()) {</span>
<span class="nc" id="L489">					addPartialSwapOptionRow(listModel);</span>
				}
<span class="nc bnc" id="L491" title="All 4 branches missed.">				if (isCreateRequestFromPosting() || isTwoWaySwap()) {</span>
<span class="nc" id="L492">					addPartialPickupOptionRow(listModel);</span>
				}
			}
<span class="nc" id="L495">			addExpireSentence(listModel);</span>
<span class="nc" id="L496">			addNegotiationOptionRow(listModel);</span>
<span class="nc" id="L497">			addNegotiatioCommentRow(listModel);</span>
<span class="nc" id="L498">			addCommentHistory(listModel);</span>
		}
<span class="nc" id="L500">		addCommentRow(listModel);</span>
<span class="nc" id="L501">		addSubmitToMgrRow(listModel);</span>
<span class="nc" id="L502">	}</span>


	/**
	 * Add Swap Sentence
	 */
	private void addSwapSentence(List listModel) {
<span class="nc bnc" id="L509" title="All 2 branches missed.">		String rbKey = isTwoWaySwap()?RmWebBundleKey.SWAP_REQUEST_TWOWAY_SENTENCE</span>
				:RmWebBundleKey.SWAP_REQUEST_ONEWAY_SENTENCE;

<span class="nc bnc" id="L512" title="All 6 branches missed.">		if (!isTwoWaySwap() &amp;&amp; m_empID.equals(m_agentID1) &amp;&amp; getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF)){</span>
			//shift detail message
<span class="nc" id="L514">			rbKey = RmWebBundleKey.SWAP_REQUEST_ONEWAY_DAYOFF_SENTENCE;</span>
		}

<span class="nc" id="L517">		String sentence_template = i18n(m_bundle, rbKey);</span>
<span class="nc" id="L518">		Object[] args = null;</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">		if (isNew()) {</span>
<span class="nc" id="L520">			args = createArgsForNewSwapSentence();</span>
		} else {
<span class="nc bnc" id="L522" title="All 2 branches missed.">			if (m_ssItem1.getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF) &amp;&amp;</span>
<span class="nc bnc" id="L523" title="All 8 branches missed.">					m_empID.equals(m_agentID1) &amp;&amp; !isTwoWaySwap() &amp;&amp; m_ssItem2.getIsPartial() &amp;&amp; !isCreateNewFromScratch()){//do not display day off</span>
<span class="nc" id="L524">				sentence_template = i18n(m_bundle, RmWebBundleKey.SWAP_REQUEST_ONEWAY_DAYOFF_PARTIAL_SENTENCE);</span>
<span class="nc" id="L525">				args = new Object[] {</span>
<span class="nc" id="L526">						getAgent2Name(),</span>
<span class="nc" id="L527">						SwapUtil.formatShiftDate(m_ssItem2, m_localizer, m_view_tz),</span>
<span class="nc" id="L528">						getShiftSwapTypeDisplayWithHiddenInput()</span>
					};
		} else {
<span class="nc" id="L531">			args = new Object[] {</span>
<span class="nc" id="L532">				getAgent1Name(),</span>
<span class="nc" id="L533">				getShiftTypeDisplay(),</span>
<span class="nc" id="L534">				SwapUtil.formatShiftDate(m_ssItem1, m_localizer, m_view_tz),</span>
<span class="nc" id="L535">				getAgent2Name(),</span>
<span class="nc" id="L536">				SwapUtil.formatShiftDate(m_ssItem2, m_localizer, m_view_tz),</span>
<span class="nc" id="L537">				getShiftSwapTypeDisplay()</span>
			};
<span class="nc" id="L539">			initAriaTitleArgs(args);</span>
			}
		}

<span class="nc" id="L543">		String sentence = BPMessageFormat.format(sentence_template, args);</span>
<span class="nc" id="L544">		setMainPCAriaTitle(BPMessageFormat.format(sentence_template, getAriaTitleArgs().toArray()));</span>
<span class="nc" id="L545">		addDataRow(sentence, listModel);</span>
<span class="nc" id="L546">	}</span>

	/**
	 * Add Swap Sentence
	 */
	private void addPartialSwapSentence(List listModel) {
<span class="nc bnc" id="L552" title="All 2 branches missed.">		if (getRequestID() != null){</span>
			//add for already created request
<span class="nc" id="L554">			addSwapSentence(listModel);</span>
		} else {
<span class="nc" id="L556">			String sentence_template = i18n(m_bundle, RmWebBundleKey.SWAP_POSTING_TWOWAY_PARTIAL_SENTENCE);</span>
<span class="nc" id="L557">			Object[] args = null;</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">			if (getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF) &amp;&amp;</span>
<span class="nc bnc" id="L559" title="All 6 branches missed.">					m_empID.equals(m_agentID1) &amp;&amp; shiftSwapPosting.getIsPartial() &amp;&amp; !isCreateNewFromScratch()){//do not display day off</span>
<span class="nc" id="L560">				sentence_template = i18n(m_bundle, RmWebBundleKey.SWAP_POSTING_ONEWAY_DAYOFF_PARTIAL_SENTENCE);</span>
			}
<span class="nc bnc" id="L562" title="All 2 branches missed.">			if (isNew()) {</span>
<span class="nc" id="L563">				args = createArgsForNewPartialSwapSentence();</span>
			} else {
<span class="nc" id="L565">				args = new Object[] {</span>
<span class="nc" id="L566">					getAgent1Name(),</span>
<span class="nc" id="L567">					getShiftTypeDisplay(),</span>
<span class="nc" id="L568">					getAgent2Name(),</span>
<span class="nc" id="L569">					getShiftSwapTypeDisplay()</span>
				};
			}
<span class="nc" id="L572">			String sentence = BPMessageFormat.format(sentence_template, args);</span>
<span class="nc" id="L573">			addDataRow(sentence, listModel);</span>
		}
<span class="nc" id="L575">	}</span>

	private void addWithdrawApproveSentance(List listModel){
		try{
<span class="nc" id="L579">			String swapEmployee = RequestUtil.getSwapEmployeeName(m_request, m_context);</span>
<span class="nc" id="L580">			String simpleText = m_localizer.i18n(m_bundle, RmWebBundleKey.SHIFTSWAP_WITHDRAW_REQUESTED_NEEDS_CONFIRMATION,swapEmployee);</span>
<span class="nc" id="L581">			addDataRow(simpleText, listModel);</span>
<span class="nc" id="L582">		} catch (Exception ex) {</span>
<span class="nc" id="L583">			log.l7dError(RmWebLogBundleKey.UNABLE_TO_LOAD_PERSON_INFO_FOR_EMPLOYEE, ex);</span>
<span class="nc" id="L584">		}</span>
<span class="nc" id="L585">	}</span>

	/**
	 * Create Args for New Swap Sentence
	 */
	private Object[] createArgsForNewSwapSentence() {
<span class="nc" id="L591">		Object[] args = null;</span>

		
<span class="nc" id="L594">		String agent1Name = i18n(m_common_bundle, UIFWebBundleKey.MY);</span>
<span class="nc" id="L595">		addAriaTitleArg(agent1Name);</span>
<span class="nc" id="L596">		String myDateAriaLabel = i18n(m_bbm_bundle, BbmWebBundleKey.MY_DATE);</span>
<span class="nc" id="L597">		String personDateAriaLabel = i18n(m_bbm_bundle, BbmWebBundleKey.PERSON_DATE);</span>

<span class="nc bnc" id="L599" title="All 2 branches missed.">		if (isCreateNewFromScratch()) {</span>
<span class="nc" id="L600">			args = new Object[] {</span>
				agent1Name,
<span class="nc" id="L602">				createShiftTypeDD(),</span>
<span class="nc" id="L603">				getDatePickerHTML(REQUEST_DATE_1_FN, swapOutDate, false, myDateAriaLabel,true),</span>
<span class="nc" id="L604">				createAgentDD(),</span>
<span class="nc" id="L605">				getDatePickerHTML(REQUEST_DATE_2_FN, swapInDate, false, personDateAriaLabel,true),</span>
<span class="nc" id="L606">				createShiftSwapTypeDD(true)</span>
			};
		} else {
<span class="nc" id="L609">			boolean isFromPosting = isCreateRequestFromPosting();</span>
<span class="nc bnc" id="L610" title="All 4 branches missed.">			String datePicker= isTwoWaySwap()</span>
<span class="nc" id="L611">					? getDatePickerHTML(REQUEST_DATE_1_FN, swapOutDate, false, myDateAriaLabel,!isFromPosting)</span>
<span class="nc" id="L612">					: getReadOnlyDate(REQUEST_DATE_1_FN, swapOutDate, false);</span>
<span class="nc" id="L613">			args = new Object[] {</span>
				agent1Name,
<span class="nc" id="L615">				getShiftTypeDisplayWithHiddenInput(),</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">				isTwoWaySwap()//datePicker</span>
<span class="nc" id="L617">							? getDatePickerHTML(REQUEST_DATE_1_FN, swapInDate, false, myDateAriaLabel, false)</span>
<span class="nc" id="L618">							: getReadOnlyDate(REQUEST_DATE_1_FN, swapInDate, false),</span>
<span class="nc" id="L619">				getAgent2Name(),</span>
<span class="nc" id="L620">					getReadOnlyDate(REQUEST_DATE_2_FN, swapInDate, false, personDateAriaLabel),</span>
<span class="nc" id="L621">				getShiftSwapTypeDisplayWithHiddenInput()</span>
			};
		}

<span class="nc" id="L625">		return args;</span>
	}

	/**
	 * Create Args for New Swap Sentence
	 */
	private Object[] createArgsForNewPartialSwapSentence() {
<span class="nc" id="L632">		Object[] args = null;</span>

<span class="nc" id="L634">		String agent1Name = i18n(m_common_bundle, UIFWebBundleKey.MY);</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">		if (isCreateNewFromScratch()) {</span>
<span class="nc" id="L636">			args = new Object[] {</span>
				agent1Name,
<span class="nc" id="L638">				createShiftTypeDD(),</span>
<span class="nc" id="L639">				createAgentDD(),</span>
<span class="nc" id="L640">				createShiftSwapTypeDD(true)</span>
			};
		} else {
<span class="nc bnc" id="L643" title="All 2 branches missed.">			if (getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF) &amp;&amp;</span>
<span class="nc bnc" id="L644" title="All 6 branches missed.">					m_empID.equals(m_agentID1) &amp;&amp; shiftSwapPosting.getIsPartial() &amp;&amp; !isCreateNewFromScratch()){</span>
<span class="nc" id="L645">				args = new Object[] {</span>
<span class="nc" id="L646">						getAgent2Name() + HtmlUtil.makeHiddenInput(SHIFT_TYPE_FN, getShiftType()),</span>
<span class="nc" id="L647">						getShiftSwapTypeDisplayWithHiddenInput()</span>
					};
			} else {
<span class="nc" id="L650">				args = new Object[] {</span>
					agent1Name,
<span class="nc" id="L652">					getShiftTypeDisplayWithHiddenInput(),</span>
<span class="nc" id="L653">					getAgent2Name(),</span>
<span class="nc" id="L654">					getShiftSwapTypeDisplayWithHiddenInput()</span>
				};
			}
		}

<span class="nc" id="L659">		return args;</span>
	}

	/**
	 * Return Agent 1 Name
	 */
	private String getAgent1Name() {
<span class="nc bnc" id="L666" title="All 2 branches missed.">		if (m_empID.equals(m_agentID1)) {</span>
<span class="nc" id="L667">			return i18n(m_common_bundle, UIFWebBundleKey.MY);</span>
		}

<span class="nc" id="L670">		return getEmployeeName(m_agentID1, idNameMap);</span>
	}

	/**
	 * Return Agent 2 Name
	 */
	private String getAgent2Name() {
<span class="nc" id="L677">		String employeeName = getEmployeeName(m_agentID2, idNameMap);</span>
<span class="nc" id="L678">		addAriaTitleArg(employeeName);</span>
<span class="nc" id="L679">		return employeeName + HtmlUtil.makeHiddenInput(AGENT_ID_FN, m_agentID2);</span>
	}

	/**
	 * Add Negotiation Option Row
	 */
	protected void addPartialSwapOptionRow(List listModel) {
<span class="nc" id="L686">		boolean isFromPosting = isCreateRequestFromPosting();</span>
<span class="nc" id="L687">		String label_toAgt = i18n(m_bundle, RmWebBundleKey.ENTIRE_SHIFT);</span>
<span class="nc bnc" id="L688" title="All 4 branches missed.">		String input_toAgt = HtmlChoiceInput.makeRadioInput(PARTIAL_SWAP_FN, &quot;false&quot;, label_toAgt, !swapOutPartial,&quot;disableTab('partialSwapTab');enableTab('entireSwapTab');&quot;</span>
				+ (isFromPosting? &quot;&quot; : JSUtil.REFRESH_PAGE_NO_CONFIRM));

<span class="nc" id="L691">		String label_toMgr = i18n(m_bundle, RmWebBundleKey.PARTIAL_SHIFT);</span>
<span class="nc bnc" id="L692" title="All 2 branches missed.">		String input_toMgr = HtmlChoiceInput.makeRadioInput(PARTIAL_SWAP_FN, &quot;true&quot;, label_toMgr,  swapOutPartial, &quot;disableTab('entireSwapTab');enableTab('partialSwapTab');&quot;</span>
				+ (isFromPosting? &quot;&quot; : JSUtil.REFRESH_PAGE_NO_CONFIRM));

<span class="nc" id="L695">		StringBuffer sb = new StringBuffer(100);</span>

		/**/
<span class="nc" id="L698">		sb.append(&quot;&lt;table id=\&quot;partialTable\&quot; border=\&quot;0\&quot; cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot;&gt;&lt;tr class=\&quot;&quot;);</span>
<span class="nc" id="L699">		sb.append(CUSTOM_DYNAMIC_ROW_CLASS);</span>
<span class="nc" id="L700">		sb.append(TD_CLOSE_TAG);</span>
<span class="nc" id="L701">		sb.append(input_toAgt);</span>
<span class="nc" id="L702">		sb.append(&quot;&lt;/td&gt;&lt;td id=\&quot;entireSwapTab\&quot;&quot;);</span>
<span class="nc bnc" id="L703" title="All 4 branches missed.">	 	if(getIsSwapOutPartial() &amp;&amp; !isAccessibilityComplianceMode()){</span>
<span class="nc" id="L704">       		sb.append(&quot; disabled&quot;);</span>
       	}
<span class="nc" id="L706">       	sb.append(&quot;&gt;&quot;);</span>
<span class="nc" id="L707">       	String ariaLabel = &quot;&quot;;</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">       	if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L709">       		ariaLabel = getEntireShiftDateLabel();</span>
       	}
       	//If from posting, don't refresh
<span class="nc bnc" id="L712" title="All 2 branches missed.">       	sb.append(getDatePickerHTML(REQUEST_DATE_1_FN, swapOutDate, false, !isFromPosting ));</span>
<span class="nc" id="L713">       	sb.append(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr class=\&quot;&quot;);</span>
<span class="nc" id="L714">       	sb.append(CUSTOM_DYNAMIC_ROW_CLASS);</span>
<span class="nc" id="L715">       	sb.append(TD_CLOSE_TAG);</span>
<span class="nc" id="L716">       	sb.append(input_toMgr);</span>
<span class="nc" id="L717">       	sb.append(&quot;&lt;/td&gt;&lt;td  id=\&quot;partialSwapTab\&quot;&quot;);</span>
<span class="nc bnc" id="L718" title="All 4 branches missed.">    	if(!getIsSwapOutPartial() &amp;&amp; !isAccessibilityComplianceMode()){</span>
<span class="nc" id="L719">       		sb.append(&quot; disabled&quot;);</span>
       	}
<span class="nc" id="L721">       	sb.append(&quot;&gt;&quot;);</span>

<span class="nc" id="L723">       	sb.append(swapDateRangePickerPC.toString());</span>
<span class="nc" id="L724">	    sb.append(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">	    if(getIsSwapOutPartial()) {</span>
<span class="nc" id="L726">			appendJSToJSMain(&quot;\ndisableTab('entireSwapTab');\n&quot;);</span>
		}else {
<span class="nc" id="L728">			appendJSToJSMain(&quot;\ndisableTab('partialSwapTab');\n&quot;);</span>
		}
	    
<span class="nc" id="L731">		addDataRow(sb.toString(), listModel);</span>
<span class="nc" id="L732">	}</span>

	/**
	 * Add Negotiation Option Row
	 */
	protected void addPartialPickupOptionRow(List listModel) {
		//TODO add partial shift pickup support
<span class="nc bnc" id="L739" title="All 6 branches missed.">		boolean canPickPartial =  (shiftSwapPostingID!=null &amp;&amp; m_allowPartial) || isCreateNewFromScratch();</span>
<span class="nc" id="L740">		boolean isFromPosting = isCreateRequestFromPosting();</span>
<span class="nc" id="L741">		String additionalPickupHiddenText = HtmlUtil.makeHiddenReadableText(i18n(m_bundle, RmWebBundleKey.PICKUP_SENTENCE));</span>
<span class="nc" id="L742">		String label_toAgt = additionalPickupHiddenText + i18n(m_bundle, RmWebBundleKey.ENTIRE_SHIFT);</span>

<span class="nc bnc" id="L744" title="All 4 branches missed.">		String input_toAgt = HtmlChoiceInput.makeRadioInput(PARTIAL_PICKUP_FN, &quot;false&quot;, label_toAgt, !swapInPartial, &quot;disableTab('partialPickupTab');enableTab('entirePickupTab');&quot;+</span>
				(isFromPosting? &quot;&quot; :JSUtil.REFRESH_PAGE_NO_CONFIRM));

<span class="nc bnc" id="L747" title="All 10 branches missed.">		boolean isSelected = (shiftSwapPostingID != null &amp;&amp; !m_allowPartial?true:swapInPartial)</span>
			|| !(shiftSwapPostingID == null &amp;&amp; m_allowPartial);
<span class="nc" id="L749">		String label_toMgr = additionalPickupHiddenText + i18n(m_bundle, RmWebBundleKey.PARTIAL_SHIFT);</span>
<span class="nc bnc" id="L750" title="All 4 branches missed.">		String input_toMgr = HtmlChoiceInput.makeRadioInput(PARTIAL_PICKUP_FN, &quot;true&quot;, label_toMgr, isSelected, !canPickPartial, &quot;disableTab('entirePickupTab');enableTab('partialPickupTab');&quot;</span>
				+ (isFromPosting? &quot;&quot; :JSUtil.REFRESH_PAGE_NO_CONFIRM));

<span class="nc bnc" id="L753" title="All 6 branches missed.">		if (shiftSwapPostingID != null &amp;&amp; shiftSwapPosting != null &amp;&amp; !shiftSwapPosting.getAllowPartial()){</span>
			//label should say &quot;Entire Shift&quot; if posting is not partial
<span class="nc" id="L755">			label_toMgr = i18n(m_bundle, RmWebBundleKey.ENTIRE_SHIFT);</span>
		}

<span class="nc" id="L758">		StringBuffer sb = new StringBuffer(100);</span>
<span class="nc" id="L759">		sb.append(i18n(m_bundle, RmWebBundleKey.PICKUP_SENTENCE)).append(&quot;&lt;br&gt;&quot;);</span>
<span class="nc" id="L760">		sb.append(&quot;&lt;table id=\&quot;pickupTable\&quot; border=\&quot;0\&quot; cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot;&gt;&quot;);</span>
<span class="nc bnc" id="L761" title="All 4 branches missed.">		if (shiftSwapPostingID == null &amp;&amp; m_allowPartial){</span>
<span class="nc" id="L762">			String requestDateStr =&quot;&quot;;</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">			if (swapInDate == null) {</span>
<span class="nc" id="L764">				swapInDate = new Date();</span>
			}
<span class="nc bnc" id="L766" title="All 2 branches missed.">			if (isCreateNewFromScratch()) {</span>
<span class="nc" id="L767">				String ariaLabel = &quot;&quot;;</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">				if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L769">					ariaLabel = getEntireShiftDateLabel();</span>
				}
<span class="nc bnc" id="L771" title="All 2 branches missed.">				requestDateStr =getDatePickerHTML(REQUEST_DATE_2_FN, swapInDate, false, ariaLabel, !isFromPosting);</span>
<span class="nc bnc" id="L772" title="All 2 branches missed.">			} else if (shiftSwapPostingID != null) {// get item start and end</span>
<span class="nc" id="L773">				requestDateStr = formatDateTime(shiftSwapPosting.getStartDate()) + &quot; - &quot; + formatDateTime(shiftSwapPosting.getEndDate());</span>
			} else {
<span class="nc" id="L775">				requestDateStr =getReadOnlyDate(REQUEST_DATE_2_FN, swapInDate, false);</span>
			}
<span class="nc" id="L777">			sb.append(&quot;&lt;tr class=\&quot;&quot;);</span>
<span class="nc" id="L778">			sb.append(CUSTOM_DYNAMIC_ROW_CLASS);</span>
<span class="nc" id="L779">			sb.append(TD_CLOSE_TAG);</span>
<span class="nc" id="L780">			sb.append(input_toAgt);</span>
<span class="nc" id="L781">			sb.append(&quot;&lt;/td&gt;&lt;td  id=\&quot;entirePickupTab\&quot;&quot;);</span>
<span class="nc bnc" id="L782" title="All 4 branches missed.">			if(getIsSwapOutPartial() &amp;&amp; !isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L783">				sb.append(&quot;disabled=\&quot;\&quot; &gt;&quot;);</span>
			} else {
<span class="nc" id="L785">				sb.append(&quot;&gt;&quot;);</span>
			}
<span class="nc" id="L787">		 	sb.append(requestDateStr);</span>

<span class="nc" id="L789">			sb.append(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
		}
<span class="nc" id="L791">		sb.append(&quot;&lt;tr class=\&quot;&quot;);</span>
<span class="nc" id="L792">		sb.append(CUSTOM_DYNAMIC_ROW_CLASS);</span>
<span class="nc" id="L793">		sb.append(TD_CLOSE_TAG);</span>
<span class="nc" id="L794">		sb.append(input_toMgr);</span>
<span class="nc" id="L795">		sb.append(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L796">		String pickupDateRangeStr =&quot;&quot;;</span>
<span class="nc" id="L797">		sb.append(&quot;&lt;td  id=\&quot;partialPickupTab\&quot; &quot;);</span>

<span class="nc bnc" id="L799" title="All 4 branches missed.">		if (isCreateNewFromScratch() || canPickPartial){</span>
<span class="nc bnc" id="L800" title="All 2 branches missed.">				if (shiftSwapPostingID != null){</span>
					//set range values to posting start and end
<span class="nc" id="L802">					pickupDateRangePickerPC.getStartDatePickerPC().setDate(shiftSwapPosting.getStartDate());</span>
<span class="nc" id="L803">					pickupDateRangePickerPC.getEndDatePickerPC().setDate(shiftSwapPosting.getEndDate());</span>
					//set upper and lower limit to the same
<span class="nc" id="L805">					pickupDateRangePickerPC.getStartDatePickerPC().setLowerLimit(shiftSwapPosting.getStartDate());</span>
<span class="nc" id="L806">					pickupDateRangePickerPC.getEndDatePickerPC().setUpperLimit(shiftSwapPosting.getEndDate());</span>
				}
<span class="nc" id="L808">				pickupDateRangeStr= pickupDateRangePickerPC.toString();</span>
			} else {
<span class="nc" id="L810">				pickupDateRangeStr = StringUtil.NBSP + formatDateTime(shiftSwapPosting.getDisplayStartDate()) + &quot; - &quot; + formatDateTime(m_requestEndDate);</span>
			}
<span class="nc" id="L812">		sb.append(&quot; &gt;&quot;);</span>
<span class="nc" id="L813">		sb.append(pickupDateRangeStr);</span>
<span class="nc" id="L814">		sb.append(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;);</span>
<span class="nc bnc" id="L815" title="All 6 branches missed.">		if(getIsSwapInPartial()||(shiftSwapPostingID!=null &amp;&amp; m_allowPartial)) {</span>
<span class="nc" id="L816">			appendJSToJSMain(&quot;\ndisableTab('entirePickupTab');\n&quot;);</span>
		}else {
<span class="nc" id="L818">			appendJSToJSMain(&quot;\ndisableTab('partialPickupTab');\n&quot;);</span>
		}
		
<span class="nc" id="L821">		addDataRow(sb.toString(), listModel);</span>
<span class="nc" id="L822">	}</span>

	private String getEntireShiftDateLabel() {
<span class="nc" id="L825">		return i18n(m_bundle, RmWebBundleKey.ENTIRE_SHIFT) + &quot; &quot; + i18n(m_common_bundle, UIFWebBundleKey.DATE);</span>
	}

	/**
	 * Add Expire Sentence
	 */
	private void addExpireSentence(List listModel) {
<span class="nc" id="L832">		String sentence = &quot;&quot;;</span>

<span class="nc bnc" id="L834" title="All 2 branches missed.">		if (isCreateNewFromScratch()) {</span>
<span class="nc" id="L835">			String name = i18n(m_common_bundle, UIFWebBundleKey.I);</span>
<span class="nc" id="L836">			Date expDate = createNewOfferExpDate();</span>
<span class="nc" id="L837">			sentence = createOfferExpireSentence(name, expDate, true);</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">		} else if (isInNegotiation()) {</span>
<span class="nc" id="L839">			String agent1Name = i18n(m_common_bundle, UIFWebBundleKey.I);</span>
<span class="nc" id="L840">			String agent2Name = getEmployeeName(m_agentID2, idNameMap);</span>

<span class="nc" id="L842">			String personExpireSentence = createOfferExpireSentence(agent2Name, m_expireTime2, false);</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">			if (isAccessibilityComplianceMode()){</span>
<span class="nc" id="L844">				personExpireSentence = HtmlUtil.getTabbableLabel(personExpireSentence, null);</span>
			}
<span class="nc" id="L846">			sentence =  personExpireSentence + &quot;&lt;br&gt;&quot; + createOfferExpireSentence(agent1Name, m_expireTime1, true);</span>
<span class="nc" id="L847">		} else {</span>
<span class="nc" id="L848">			sentence = createExpirationSentence();</span>
		};

<span class="nc" id="L851">		addDataRow(sentence, listModel);</span>
<span class="nc" id="L852">	}</span>

	/**
	 * Create Offer Expire Sentence
	 */
	private String createOfferExpireSentence(String agentName, Date date, boolean isEditable) {
<span class="nc" id="L858">		String sentence_template = i18n(m_bundle, RmWebBundleKey.SWAP_OFFER_EXPIRE_SENTENCE);</span>
<span class="nc" id="L859">		String ariaLabel = BPMessageFormat.format(sentence_template, new Object[] {agentName, &quot;&quot;});</span>

<span class="nc bnc" id="L861" title="All 2 branches missed.">		Object dateArg = isEditable?</span>
<span class="nc" id="L862">				getDatePickerHTML(EXPIRATION_FN, date, true, ariaLabel, false) :</span>
<span class="nc" id="L863">				formatDateTime(date);</span>

<span class="nc" id="L865">		Object[] args = new Object[] {agentName, dateArg};</span>
<span class="nc" id="L866">		String sentence = BPMessageFormat.format(sentence_template, args);</span>
<span class="nc" id="L867">		return sentence;</span>
	}

	/**
	 * Return Expiration Sentation
	 */
	private String createExpirationSentence() {
<span class="nc" id="L874">		String sentence_template = i18n(m_bundle, RmWebBundleKey.SWAP_REQUEST_EXPIRE_SENTENCE);</span>
<span class="nc" id="L875">		Date date = m_ssRequest.getExpirationDate();</span>
<span class="nc bnc" id="L876" title="All 2 branches missed.">		Object dateArg = isManagerMode()?</span>
<span class="nc" id="L877">				formatDateTime(date):</span>
<span class="nc" id="L878">				getDatePickerHTML(EXPIRATION_FN, date, true, false);</span>

<span class="nc" id="L880">		Object[] args = new Object[] { dateArg };</span>
<span class="nc" id="L881">		return BPMessageFormat.format(sentence_template, args);</span>
	}

	/**
	 * Add Negotiation Option Row
	 */
	private void addNegotiationOptionRow(List listModel) {
<span class="nc bnc" id="L888" title="All 2 branches missed.">		if (!isInNegotiation()) {</span>
<span class="nc" id="L889">			return;</span>
		}
<span class="nc" id="L891">		super.addNegotiationOptionRow(listModel, isNegotiable(),</span>
				RmWebBundleKey.SWAP_REQUEST_ALLOW_FEEDBACK_FROM_AGENT,
				RmWebBundleKey.SWAP_REQUEST_ALLOW_SUBMIT_TO_MGR);
<span class="nc" id="L894">	}</span>

	/**
	 * Add Negotiation Comment Row
	 */
	private void addNegotiatioCommentRow(List listModel)
    {
<span class="nc bnc" id="L901" title="All 2 branches missed.">		if (!isInNegotiation()) {</span>
<span class="nc" id="L902">			return;</span>
		}


<span class="nc" id="L906">        boolean isReadOnly = false;</span>
        try
        {//GQ
<span class="nc" id="L909">            Collection auditTrails = m_ssRequest.getAuditTrail();</span>
<span class="nc bnc" id="L910" title="All 6 branches missed.">            if (!isManagerMode() &amp;&amp; auditTrails!=null &amp;&amp; !auditTrails.isEmpty())</span>
            {
                //get the Users for this request
<span class="nc" id="L913">                Map userMap = null;</span>
<span class="nc" id="L914">                userMap = RequestsMH.getUserMapForRequest(m_ssRequest);</span>

                //get the max number of shift swap request updates per agent for the org
<span class="nc" id="L917">                fillOrgSettingMap(new Date()); //populates empOrgIDMap and m_orgSettingMap</span>

<span class="nc bnc" id="L919" title="All 2 branches missed.">                if (userMap != null)</span>
                {
                    //ID orgID = (ID)empOrgIDMap.get(m_empID);
<span class="nc" id="L922">                    Organization org = OrganizationModelHandler.getEmployeeOrg(m_context, m_empID);</span>

                    //OrganizationSetting orgSetting = (OrganizationSetting)m_orgSettingMap.get(orgID); //RequestsMH.getOrgSetting(orgID);
<span class="nc" id="L925">                    OrganizationSetting orgSetting = RequestsMH.getOrgSetting(org.getID());</span>

<span class="nc" id="L927">                    int maxNumUpdates = orgSetting.getShiftSwapMaxNegotiationUpdates();</span>

                    //get the &quot;Updated&quot; note string
<span class="nc" id="L930">                    ResourceBundle rmEjbBundle = m_localizer.getBundle(RmEjbBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L931">                    String sUpdatedNote = i18n(rmEjbBundle, RmEjbBundleKey.UPDATED);</span>

<span class="nc" id="L933">                    int numUpdatesByCurAgent = 0;</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">                    for (Iterator it=auditTrails.iterator(); it.hasNext(); )</span>
                    {
<span class="nc" id="L936">                        RequestAuditTrail rat = (RequestAuditTrail)it.next();</span>
<span class="nc" id="L937">                        User user = (User)userMap.get(rat.getBpUserId());</span>

<span class="nc bnc" id="L939" title="All 2 branches missed.">                        if (rat.getNote().equals(sUpdatedNote))</span>
                        {
<span class="nc bnc" id="L941" title="All 4 branches missed.">                            if (user!=null &amp;&amp; user.getEmployeeID().equals(m_empID)) {</span>
<span class="nc" id="L942">								numUpdatesByCurAgent++;</span>
							}
                        }
<span class="nc" id="L945">                    }</span>

<span class="nc bnc" id="L947" title="All 2 branches missed.">                    if (numUpdatesByCurAgent &gt;= maxNumUpdates) {</span>
<span class="nc" id="L948">						isReadOnly = true;</span>
					}
                }
            }
        }
<span class="nc" id="L953">        catch (Exception ex)</span>
<span class="nc" id="L954">        {}</span>


<span class="nc" id="L957">        String label = null;</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">        if (!isReadOnly)</span>
        {
<span class="nc" id="L960">            label = i18n(m_bundle, RmWebBundleKey.SWAP_REQUEST_NEGOTIATION_COMMENT); //Negotiation comment</span>
        }
        else
        {
<span class="nc" id="L964">            label = i18n(m_bundle, RmWebBundleKey.SWAP_REQUEST_NEGOTIATION_COMMENT_NONEDITABLE); //Negotiation comment (Maximum number of comments has been reached)</span>
<span class="nc" id="L965">            String warning = i18n(m_bundle, RmWebBundleKey.SWAP_REQUEST_NEGOTIATION_COMMENT_NONEDITABLE_WARNING); //Maximum number of comments has been reached. The swap request must be submitted to manager or withdrawn.</span>
<span class="nc" id="L966">            addPageMessage(Message.WARNING_TYPE, warning);</span>
        }

<span class="nc" id="L969">        String input = RequestUtil.createTextArea(NEGOTIATION_CMT_FN,</span>
<span class="nc" id="L970">                getNegotiationComment(), 95, 5, NEG_COMMENT_MAX_LEN, this,</span>
                RmWebBundleKey.SWAP_REQUEST_NEGOTIATION_COMMENT,
<span class="nc" id="L972">                RmWebBundleKey.BUNDLE_NAME, isReadOnly, i18n(m_bundle, RmWebBundleKey.SWAP_REQUEST_NEGOTIATION_COMMENT));</span>

<span class="nc" id="L974">        StringBuffer sb = new StringBuffer(100);</span>
<span class="nc" id="L975">		sb.append(label).append(&quot;&lt;br&gt;&quot;).append(input);</span>
<span class="nc" id="L976">		addDataRow(sb.toString(), listModel);</span>
<span class="nc" id="L977">	}</span>

	/**
	 * Add Comment History Row
	 */
	private void addCommentHistory(List listModel) {
<span class="nc bnc" id="L983" title="All 2 branches missed.">		if (isInNegotiation()) {</span>
<span class="nc" id="L984">			return;</span>
		}

<span class="nc" id="L987">		MessagePC msgPC = RequestUtil.createCmntMsgPC(m_context, &quot;490px&quot;, &quot;70px&quot;, &quot;&quot;);</span>
<span class="nc" id="L988">		Collection msgs = RequestUtil.getCommentsAsMessages(m_ssRequest);</span>
<span class="nc" id="L989">		msgPC.addMessage(msgs);</span>

<span class="nc" id="L991">		String label = i18n(m_common_bundle, UIFWebBundleKey.COMMENT_HISTORY);</span>
<span class="nc" id="L992">		StringBuffer sb = new StringBuffer(100);</span>
<span class="nc" id="L993">		sb.append(label).append(&quot;&lt;br&gt;&quot;).append(msgPC);</span>
<span class="nc" id="L994">		addDataRow(sb.toString(), listModel);</span>
<span class="nc" id="L995">	}</span>

	/**
	 * Return True if request is in negotiation
	 */
	private boolean isInNegotiation() {
<span class="nc" id="L1001">		return RequestAuditTrail.STATUS_NEGOTIATION.</span>
<span class="nc" id="L1002">				equals(m_ssRequest.getRequestStatus());</span>
	}

	/**
	 * Add Comment Row by verifying if it's editable or not
	 * If withdraw request is sent to manager for approval, then it should be disabled
	 */
	private void addCommentRow(List listModel) {
<span class="nc bnc" id="L1010" title="All 2 branches missed.">		if (isInNegotiation()) {</span>
<span class="nc" id="L1011">			return;</span>
		}
<span class="nc" id="L1013">		boolean isReadOnly = false;</span>
<span class="nc bnc" id="L1014" title="All 6 branches missed.">		if(!isManagerMode() &amp;&amp; (m_ssRequest!= null &amp;&amp; m_ssRequest.getWithdrawInfo() != null &amp;&amp; RequestAuditTrail.STATUS_WITHDRAW_REQUEST.</span>
<span class="nc bnc" id="L1015" title="All 2 branches missed.">				equals(m_ssRequest.getWithdrawInfo().getRequestStatus()))) {</span>
<span class="nc" id="L1016">			isReadOnly = true;</span>
		}

<span class="nc" id="L1019">		addCommentRow(listModel, m_common_bundle, UIFWebBundleKey.ADD_COMMENT, isReadOnly);</span>
<span class="nc" id="L1020">	}</span>

	/**
	 * Add Submit to Manager Row
	 */
	private void addSubmitToMgrRow(List listModel) {
<span class="nc bnc" id="L1026" title="All 4 branches missed.">		if (isManagerMode() || isCreateNewFromScratch()</span>
<span class="nc bnc" id="L1027" title="All 4 branches missed.">				|| !isInNegotiation() || m_isNegotiable2) {</span>
<span class="nc" id="L1028">			return;</span>
		}

<span class="nc" id="L1031">		String label = i18n(m_bundle, RmWebBundleKey.SWAP_REQUEST_SUBMIT_TO_MGR);</span>
<span class="nc" id="L1032">		String checkBox = HtmlChoiceInput.makeChkBoxInput(SUBMIT2MGR_FN, &quot;true&quot;,</span>
				label, m_isSubmitToMgr, JSUtil.ON_CHANGE);
<span class="nc" id="L1034">		String input = RequestUtil.createCommentUI(COMMENT_FN, getComment(), 95, 5, this, i18n(m_bundle, RmWebBundleKey.SWAP_REQUEST_SUBMIT_TO_MGR_COMMENT));</span>

<span class="nc" id="L1036">		StringBuffer sb = new StringBuffer(100);</span>
<span class="nc" id="L1037">		sb.append(checkBox).append(&quot;&lt;br&gt;&quot;).append(input);</span>
<span class="nc" id="L1038">		addDataRow(sb.toString(), listModel);</span>
<span class="nc" id="L1039">	}</span>

	/**
	 * Create Agent Drop Down
	 */
	private String createAgentDD() {
<span class="nc" id="L1045">		List options = Collections.emptyList();</span>
<span class="nc" id="L1046">		String selectedAgent = &quot;&quot;;</span>
<span class="nc bnc" id="L1047" title="All 2 branches missed.">		if (!m_eNames.isEmpty()) {</span>
<span class="nc" id="L1048">			options = new ArrayList(m_eNames.size());</span>

			// Sort Employee Names
<span class="nc" id="L1051">			List sortedENames = new ArrayList(m_eNames);</span>
<span class="nc" id="L1052">			PersonNameUtil.sort(sortedENames, true, m_localeContext);</span>

			// Convert to Options
<span class="nc bnc" id="L1055" title="All 2 branches missed.">			for(Iterator it=sortedENames.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L1056">				EmployeeName eName = (EmployeeName)it.next();</span>
<span class="nc" id="L1057">				String key = eName.getID().toString();</span>
<span class="nc" id="L1058">				String display = m_localizer.formatName(eName);</span>
<span class="nc" id="L1059">				options.add( new StringsPair(key, display) );</span>
				//508
<span class="nc bnc" id="L1061" title="All 4 branches missed.">				if(m_agentID2!=null &amp;&amp; m_agentID2.equals(eName.getID())){</span>
<span class="nc" id="L1062">					selectedAgent = display;</span>
				}
<span class="nc" id="L1064">			}</span>
		}
<span class="nc bnc" id="L1066" title="All 4 branches missed.">		if (StringUtil.isEmpty(selectedAgent) &amp;&amp; !options.isEmpty()) {</span>
<span class="nc" id="L1067">			selectedAgent = ((StringsPair)options.get(0)).getValue();</span>
		}
<span class="nc" id="L1069">		addAriaTitleArg(selectedAgent);</span>

<span class="nc bnc" id="L1071" title="All 2 branches missed.">		String selectedOption = (m_agentID2!=null)?m_agentID2.toString():&quot;&quot;;</span>
		//return HtmlUtil.makeSelectInput(AGENT_ID_FN, selectedOption, &quot;validateOrgSetting();&quot;, options);

        //508 TBD: passing selectedValue instead of selectedText. SHould still work, but let's see!
<span class="nc" id="L1075">        String agentNameLabel = i18n(m_bundle, RmWebBundleKey.AGENT_NAME); //508</span>
<span class="nc" id="L1076">        return HtmlUtil.makeSelectInput(AGENT_ID_FN, options, null, selectedOption, agentNameLabel,</span>
                &quot;validateOrgSetting();&quot;, true);
	}

	@Override
	protected boolean isSaveButtonEnabled() {
<span class="nc bnc" id="L1082" title="All 4 branches missed.">		return isWithdrawConfirmation() || RequestUtil.isRequestFormSaveBtnEnabled(m_request);</span>
	}

	/**
	 * Override extract Parameters to handle date input
	 */
	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L1090">		boolean success = super.extractParameters(request);</span>
<span class="nc bnc" id="L1091" title="All 2 branches missed.">		if (swapDateRangePickerPC.getStartDatePickerPC().getDate() == null ||</span>
<span class="nc bnc" id="L1092" title="All 2 branches missed.">				pickupDateRangePickerPC.getStartDatePickerPC().getDate() == null){</span>

			//see if date is set, try to get the shift for that day
<span class="nc" id="L1095">			Date shiftStart = null;</span>
<span class="nc" id="L1096">			Date shiftEnd = null;</span>
<span class="nc bnc" id="L1097" title="All 2 branches missed.">			if (shiftSwapPostingID == null){</span>
				//get shift for current agent on this day
<span class="nc" id="L1099">				ArrayList empList = new ArrayList();</span>
<span class="nc" id="L1100">				empList.add(m_empID);</span>
<span class="nc" id="L1101">				Date date = extractDate(REQUEST_DATE_1_FN, false);</span>
<span class="nc bnc" id="L1102" title="All 2 branches missed.">				if (date != null){</span>
<span class="nc" id="L1103">					Date endDate = DateTimeUtil.getDayEnd(date);</span>
					try {
<span class="nc" id="L1105">						Collection saColl = WfmManagerFactory.getScheduleAccessManager()</span>
<span class="nc" id="L1106">							.getPublishedEventsForWorkResourcesByType(Event.EVENT_TYPE_SHIFT_ASSIGNMENT, empList, date, endDate);</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">						if (!saColl.isEmpty()){</span>
<span class="nc bnc" id="L1108" title="All 2 branches missed.">							for (Iterator it=saColl.iterator(); it.hasNext();){</span>
<span class="nc" id="L1109">								ArrayList saList = (ArrayList) it.next();</span>

<span class="nc bnc" id="L1111" title="All 2 branches missed.">								if (!saList.isEmpty()){</span>
<span class="nc" id="L1112">									ShiftAssignment sa = (ShiftAssignment) saList.get(0);</span>
<span class="nc" id="L1113">									shiftStart = sa.getStartTime();</span>
<span class="nc" id="L1114">									shiftEnd = sa.getEndTime();</span>
<span class="nc" id="L1115">									break;</span>
								}
<span class="nc" id="L1117">							}</span>
						}
<span class="nc" id="L1119">					} catch (Exception ex) {</span>
<span class="nc" id="L1120">						log.l7dError(RmWebLogBundleKey.EXTRACT_PARAM_FAILED, ex);</span>
<span class="nc" id="L1121">					}</span>
				}
			}
<span class="nc bnc" id="L1124" title="All 2 branches missed.">			if (swapDateRangePickerPC.getStartDatePickerPC().getDate() == null){//init picker</span>
				//see if date is set, try to get the shift for that day
<span class="nc bnc" id="L1126" title="All 4 branches missed.">				if (shiftStart != null &amp;&amp; shiftEnd != null){</span>
<span class="nc" id="L1127">					swapDateRangePickerPC.getStartDatePickerPC().setDate(shiftStart);</span>
<span class="nc" id="L1128">					swapDateRangePickerPC.getEndDatePickerPC().setDate(shiftEnd);</span>
					//To prevent Date in the past, On Entire Shift, we get the current Date as lower limit so on the Partial shift, 
					//we also get the current Date on Entire shift part,
					// the time will is start time of the shift of current Date 
<span class="nc" id="L1132">					swapDateRangePickerPC.getStartDatePickerPC().setLowerLimit(shiftStart);</span>
<span class="nc" id="L1133">					swapDateRangePickerPC.getEndDatePickerPC().setLowerLimit(shiftStart);	</span>
			} else {
<span class="nc" id="L1135">					setDateRangePickerStartAndEnd(swapDateRangePickerPC);</span>
				}
			}
<span class="nc bnc" id="L1138" title="All 2 branches missed.">			if (pickupDateRangePickerPC.getStartDatePickerPC().getDate() == null){//init picker</span>
<span class="nc bnc" id="L1139" title="All 4 branches missed.">				if (shiftStart != null &amp;&amp; shiftEnd != null){</span>
<span class="nc" id="L1140">					pickupDateRangePickerPC.getStartDatePickerPC().setDate(shiftStart);</span>
<span class="nc" id="L1141">					pickupDateRangePickerPC.getEndDatePickerPC().setDate(shiftEnd);</span>
					// To prevent Date in the past, On Entire Shift, we get the current Date as lower limit so on the Partial shift,
					//we also get the current Date on Entire shift part,
					// the time will is start time of the shift of current Date 
<span class="nc" id="L1145">					pickupDateRangePickerPC.getStartDatePickerPC().setLowerLimit(shiftStart);</span>
<span class="nc" id="L1146">					pickupDateRangePickerPC.getEndDatePickerPC().setLowerLimit(shiftStart);</span>
			} else {
<span class="nc" id="L1148">					setDateRangePickerStartAndEnd(pickupDateRangePickerPC);</span>
				}
			}
		}
		try {
<span class="nc" id="L1153">			swapOutDate = extractDate(REQUEST_DATE_1_FN, false);</span>
<span class="nc" id="L1154">			swapInDate = extractDate(REQUEST_DATE_2_FN, false);</span>
<span class="nc" id="L1155">			m_expireTime1   = extractDate(EXPIRATION_FN, true);</span>
<span class="nc" id="L1156">			partialSwapOutStartDate = swapDateRangePickerPC.getStartDatePickerPC().getDate();</span>
<span class="nc" id="L1157">			partialSwapOutEndDate = swapDateRangePickerPC.getEndDatePickerPC().getDate();</span>
<span class="nc" id="L1158">			partialSwapInStartDate = pickupDateRangePickerPC.getStartDatePickerPC().getDate();</span>
<span class="nc" id="L1159">			partialSwapInEndDate = pickupDateRangePickerPC.getEndDatePickerPC().getDate();</span>
<span class="nc" id="L1160">			String partialSwapIn = request.getParameter(PARTIAL_PICKUP_FN);</span>
<span class="nc" id="L1161">			String partialSwapOut = request.getParameter(PARTIAL_SWAP_FN);</span>
<span class="nc" id="L1162">			swapOutPartial = &quot;true&quot;.equals(partialSwapOut);</span>
<span class="nc" id="L1163">			swapInPartial = &quot;true&quot;.equals(partialSwapIn);</span>
			
<span class="nc" id="L1165">		} catch (Exception ex) {</span>
<span class="nc" id="L1166">			success=false;</span>
<span class="nc" id="L1167">			log.l7dError(RmWebLogBundleKey.EXTRACT_PARAM_FAILED, ex);</span>
<span class="nc" id="L1168">		}</span>

<span class="nc" id="L1170">		return success;</span>
	}

	public void setShiftSwapRequest(ShiftSwapRequest request) {
<span class="nc" id="L1174">		m_ssRequest = request;</span>
<span class="nc" id="L1175">		m_request = request;</span>
<span class="nc" id="L1176">	}</span>

	public ShiftSwapRequest getShiftSwapRequest() {
<span class="nc" id="L1179">		return m_ssRequest;</span>
	}

	@Override
	public void setSwapType(String type) {
<span class="nc" id="L1184">		m_ssRequest.setSwapType(type);</span>
<span class="nc" id="L1185">	}</span>

	@Override
	public String getSwapType() {
<span class="nc" id="L1189">		return m_ssRequest.getSwapType();</span>
	}

	@Override
	public void setShiftType(String type) {
<span class="nc" id="L1194">		m_shiftType = type;</span>
<span class="nc" id="L1195">	}</span>

	@Override
	public String getShiftType(){
<span class="nc bnc" id="L1199" title="All 2 branches missed.">		if (m_shiftType==null) {</span>
<span class="nc" id="L1200">			m_shiftType = ShiftSwapItem.SWAPITEMTYPE_SHIFT;</span>
		}
<span class="nc" id="L1202">		return m_shiftType;</span>
	}

	@Override
	public boolean isNegotiable() {
<span class="nc" id="L1207">		return m_isNegotiable1;</span>
	}

	@Override
	public void setIsNegotiable(boolean bSwitch){
<span class="nc" id="L1212">		m_isNegotiable1 = bSwitch;</span>
<span class="nc" id="L1213">	}</span>
	
	public Date getRequestDate1(){
<span class="nc" id="L1216">		return getSwapOutDate();</span>
	}
	public Date getSwapOutDate(){
<span class="nc" id="L1219">		return swapOutDate;</span>
	}

	public Date getRequestDate2(){
<span class="nc" id="L1223">		return getSwapInDate();</span>
	}
	
	public Date getSwapInDate(){
<span class="nc" id="L1227">		return swapInDate;</span>
	}

	@Override
	public void setExpiration(Date date) {
<span class="nc" id="L1232">		m_expireTime1 = date;</span>
<span class="nc" id="L1233">	}</span>

	@Override
	public Date getExpiration(){
<span class="nc" id="L1237">		return m_expireTime1;</span>
	}

	public ID getAgentID(){
<span class="nc" id="L1241">		return m_agentID2;</span>
	}

	public void setAgentID(ID agentID){
<span class="nc" id="L1245">		m_agentID2 = agentID;</span>
<span class="nc" id="L1246">	}</span>

	public void setNegotiationComment(String comment) {
<span class="nc" id="L1249">		m_ssRequest.setNegotiationComment(comment);</span>
<span class="nc" id="L1250">	}</span>

	public String getNegotiationComment() {
<span class="nc" id="L1253">		return m_ssRequest.getNegotiationComment();</span>
	}

	/**
	 * Specify whether to submit request to Manager
	 */
	public void setIsSubmitToMgr(boolean bSwitch) {
<span class="nc" id="L1260">		m_isSubmitToMgr = bSwitch;</span>
<span class="nc" id="L1261">	}</span>

	/**
	 * Return true if Submit request to manager is enabled
	 */
	public boolean isSubmitToMgr() {
<span class="nc" id="L1267">		return m_isSubmitToMgr;</span>
	}

	public boolean isWithdrawConfirmation(){
<span class="nc" id="L1271">		boolean ret = false;</span>
<span class="nc bnc" id="L1272" title="All 4 branches missed.">		if (m_request!=null &amp;&amp; ((ShiftSwapRequest)m_request).getWithdrawInfo()!=null){</span>
<span class="nc" id="L1273">			ret = ((ShiftSwapRequest)m_request).getWithdrawInfo().getRequestStatus().equals(RequestAuditTrail.STATUS_WITHDRAW_NEGOTIATION);</span>
		}
<span class="nc" id="L1275">		return ret;</span>
	}

	/**
	 * Specify whether to show only the &quot;Submit request to Manager&quot; row.
	 */
	public void setShowSubmitToManagerOnly(boolean bSwitch) {
<span class="nc" id="L1282">		m_showSubmitToManagerOnly = bSwitch;</span>
<span class="nc" id="L1283">	}</span>

	/**
	 * Get whether to show only the &quot;Submit request to Manager&quot; row.
	 */
	public boolean getShowSubmitToManagerOnly() {
<span class="nc" id="L1289">		return m_showSubmitToManagerOnly;</span>
	}

	/**
	 * Set Posting ID
	 */
	public void setPostingID(ID id) {
<span class="nc" id="L1296">		shiftSwapPostingID = id;</span>
<span class="nc" id="L1297">	}</span>

	/**
	 * Return Posting ID
	 */
	public ID getPostingID() {
<span class="nc" id="L1303">		return shiftSwapPostingID;</span>
	}

	/**
	 * Return true if Creating Request From Posting
	 */
	public boolean isCreateRequestFromPosting() {
<span class="nc bnc" id="L1310" title="All 2 branches missed.">		return shiftSwapPostingID!=null;</span>
	}

	/**
	 * Is Creating new Request from Scratch
	 */
	public boolean isCreateNewFromScratch() {
<span class="nc bnc" id="L1317" title="All 4 branches missed.">		return isNew() &amp;&amp; !isCreateRequestFromPosting();</span>
	}

	public void setIsSwapPartial(boolean bSwitch){
<span class="nc" id="L1321">		setIsSwapOutPartial(bSwitch);</span>
<span class="nc" id="L1322">	}</span>
	public boolean getIsSwapPartial(){
<span class="nc" id="L1324">		return getIsSwapOutPartial();</span>
	}
	
	public void setIsSwapOutPartial(boolean bSwitch){
<span class="nc" id="L1328">		swapOutPartial = bSwitch;</span>
<span class="nc" id="L1329">	}</span>
	
	
	

	public boolean getIsSwapOutPartial(){
<span class="nc" id="L1335">		return swapOutPartial;</span>
	}

	public void setIsPickupPartial(boolean bSwitch){
<span class="nc" id="L1339">		setIsSwapInPartial(bSwitch);</span>
<span class="nc" id="L1340">	}</span>
	
	public boolean getIsPickupPartial(){
<span class="nc" id="L1343">		return getIsSwapInPartial();</span>
	}
	
	public void setIsSwapInPartial(boolean bSwitch){
<span class="nc" id="L1347">		swapInPartial = bSwitch;</span>
<span class="nc" id="L1348">	}</span>

	public boolean getIsSwapInPartial(){
<span class="nc" id="L1351">		return swapInPartial;</span>
	}

	@Override
	public void setSavedRequestID(ID requsetID) {
<span class="nc" id="L1356">		m_isRequestSaved = true;</span>
<span class="nc" id="L1357">		setPostingID(null);</span>
<span class="nc" id="L1358">		super.setSavedRequestID(requsetID);</span>
<span class="nc" id="L1359">	}</span>

	public void setWithdrawConfirmed(boolean bSwitch){
<span class="nc" id="L1362">		m_isWithdrawConfirmed=bSwitch;</span>
<span class="nc" id="L1363">	}</span>

	public boolean isWithdrawConfirmed(){
<span class="nc" id="L1366">		return m_isWithdrawConfirmed;</span>
	}



	public DateRangePickerPC getSwapDateRangePicker(){
<span class="nc" id="L1372">		return swapDateRangePickerPC;</span>
	}

	public DateRangePickerPC getPickupDateRangePicker(){
<span class="nc" id="L1376">		return pickupDateRangePickerPC;</span>
	}

	public ShiftSwapPosting getPosting(){
<span class="nc" id="L1380">		return shiftSwapPosting;</span>
	}

	public boolean isPartialSwapAllowed(){
<span class="nc" id="L1384">		return m_allowPartial;</span>
	}

	/**
	 * Return the custom JavaScript code for the Page model.
	 */
	@Override
	public String getCustomJavaScript() {
<span class="nc" id="L1392">		StringBuffer jsInitCode = new StringBuffer(512);</span>

//		 Sort Employee Names
<span class="nc" id="L1395">		List sortedENames = new ArrayList(m_eNames);</span>
<span class="nc" id="L1396">		PersonNameUtil.sort(sortedENames, true, m_localeContext);</span>

		//add array of empIds to get index for getting org for settings
<span class="nc" id="L1399">		jsInitCode.append(&quot;var empIDIndex = new Array();\n&quot;);</span>
<span class="nc" id="L1400">		int num = 0;</span>

		// Convert to Options
<span class="nc bnc" id="L1403" title="All 2 branches missed.">		for(Iterator it=sortedENames.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L1404">			EmployeeName eName = (EmployeeName)it.next();</span>
<span class="nc" id="L1405">			String key = eName.getID().toString();</span>
<span class="nc" id="L1406">			jsInitCode.append(&quot;empIDIndex[&quot; + num + &quot;] = &quot; + key + &quot;;\n&quot;);</span>
<span class="nc" id="L1407">			num++;</span>
<span class="nc" id="L1408">		}</span>

<span class="nc" id="L1410">		jsInitCode.append(&quot;var swapArr = new Array();\n&quot;);</span>
<span class="nc" id="L1411">		jsInitCode.append(&quot;var pickupArr = new Array();\n&quot;);</span>
<span class="nc" id="L1412">		num = 0;</span>
		// Convert to Options
<span class="nc bnc" id="L1414" title="All 2 branches missed.">		for(Iterator it=sortedENames.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L1415">			EmployeeName eName = (EmployeeName)it.next();</span>
			//get setting
<span class="nc" id="L1417">			OrganizationSetting setting = (OrganizationSetting) m_orgSettingMap.get(empOrgIDMap.get(eName.getID()));</span>
<span class="nc bnc" id="L1418" title="All 2 branches missed.">			if (setting != null) {</span>
<span class="nc" id="L1419">				jsInitCode.append(&quot;swapArr[&quot; + num + &quot;] = &quot; + setting.getAllowPartialShiftSwap() + &quot;;\n&quot;);</span>
<span class="nc" id="L1420">				jsInitCode.append(&quot;pickupArr[&quot; + num + &quot;] = &quot; + setting.getAllowPartialShiftPickup() + &quot;;\n&quot;);</span>
<span class="nc" id="L1421">				num++;</span>
			}
<span class="nc" id="L1423">		}</span>

<span class="nc" id="L1425">		jsInitCode.append(&quot;\nfunction validateOrgSetting(){&quot;);</span>
		//only needed to do the check if partial swap is allowed
<span class="nc bnc" id="L1427" title="All 4 branches missed.">		if (canSwapPartial() &amp;&amp; getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_SHIFT)){</span>
<span class="nc" id="L1428">			jsInitCode.append(&quot;var index = getEmpIndex(document.oFormMain.agentID.value);&quot;)</span>
<span class="nc" id="L1429">			.append(&quot;var swap = swapArr[index];&quot;)</span>
<span class="nc" id="L1430">			.append(&quot;var pickup = pickupArr[index];&quot;)</span>
<span class="nc" id="L1431">			.append(&quot;if (swap == false){&quot;)</span>
<span class="nc" id="L1432">			.append(&quot;\n\tdocument.oFormMain.isSwapPartial[1].disabled=true;\n&quot;)</span>
<span class="nc" id="L1433">			.append(&quot;\n\tdocument.oFormMain.isSwapPartial[0].checked=true;\n&quot;)</span>
<span class="nc" id="L1434">			.append(&quot;\n\tdocument.oFormMain.timeRangeSwap_START.disabled=true;\n&quot;)</span>
<span class="nc" id="L1435">			.append(&quot;\n\tdocument.oFormMain.timeRangeSwap_END.disabled=true;\n&quot;)</span>
<span class="nc" id="L1436">			.append(&quot;} else {\n&quot;)</span>
<span class="nc" id="L1437">			.append(&quot;\n\tdocument.oFormMain.isSwapPartial[1].disabled=false;\n&quot;)</span>
<span class="nc" id="L1438">			.append(&quot;\n\tdocument.oFormMain.timeRangeSwap_START.disabled=false;\n&quot;)</span>
<span class="nc" id="L1439">			.append(&quot;\n\tdocument.oFormMain.timeRangeSwap_END.disabled=false;\n&quot;)</span>
<span class="nc" id="L1440">			.append(&quot;}\n&quot;);</span>
<span class="nc bnc" id="L1441" title="All 2 branches missed.">			if (isTwoWaySwap()){</span>
<span class="nc" id="L1442">				jsInitCode.append(&quot;if (swap == false){&quot;)</span>
<span class="nc" id="L1443">					.append(&quot;\n\tdocument.oFormMain.isPickupPartial[1].disabled=true;\n&quot;)</span>
<span class="nc" id="L1444">					.append(&quot;\n\tdocument.oFormMain.timeRangePickup_START.disabled=true;\n&quot;)</span>
<span class="nc" id="L1445">					.append(&quot;\n\tdocument.oFormMain.timeRangePickup_END.disabled=true;\n&quot;)</span>
<span class="nc" id="L1446">					.append(&quot;\n\tdocument.oFormMain.isPickupPartial[0].checked=true;\n&quot;)</span>
<span class="nc" id="L1447">					.append(&quot;} else {\n&quot;)</span>
<span class="nc" id="L1448">					.append(&quot;\n\tdocument.oFormMain.isPickupPartial[1].disabled=false;\n&quot;)</span>
<span class="nc" id="L1449">					.append(&quot;\n\tdocument.oFormMain.timeRangePickup_START.disabled=false;\n&quot;)</span>
<span class="nc" id="L1450">					.append(&quot;\n\tdocument.oFormMain.timeRangePickup_END.disabled=false;\n&quot;)</span>
<span class="nc" id="L1451">					.append(&quot;}\n&quot;);</span>
			}
		}
<span class="nc" id="L1454">		jsInitCode.append(&quot;}\n&quot;);</span>

		//function to get index for employee
<span class="nc" id="L1457">		jsInitCode.append(&quot;\nfunction getEmpIndex(empID){\n&quot;)</span>
<span class="nc" id="L1458">		.append(&quot;\n\tfor (var i =0; i&lt; empIDIndex.length; i++){\n&quot;)</span>
<span class="nc" id="L1459">		.append(&quot;\n\tif (empIDIndex[i] == empID){\n&quot;)</span>
<span class="nc" id="L1460">		.append(&quot;\n\treturn i;}\n&quot;)</span>
<span class="nc" id="L1461">		.append(&quot;}\n&quot;)</span>
<span class="nc" id="L1462">		.append(&quot;}\n&quot;);</span>

<span class="nc" id="L1464">		return jsInitCode.toString();</span>
	}

	/**
	 * Return Required HTML for Request Popups
	 */
	@Override
	public String getRequiredHTML() {
<span class="nc" id="L1472">		return super.getRequiredHTML() +</span>
<span class="nc" id="L1473">				HtmlUtil.makeHiddenInput(POSTING_ID_FN, shiftSwapPostingID) +</span>
<span class="nc" id="L1474">				HtmlUtil.makeHiddenInput(SUBMIT_TO_MANAGER_ONLY_FN, m_showSubmitToManagerOnly);</span>
	}
	
	@Override
	public boolean validate() {
		
<span class="nc bnc" id="L1480" title="All 2 branches missed.">		if (isCreateNewFromScratch()) {</span>
<span class="nc" id="L1481">			Date earliestDate = getEarliestDate();</span>
<span class="nc bnc" id="L1482" title="All 2 branches missed.">			if (!SwapUtil.canSwapWith(m_empID, m_agentID2, earliestDate)) {</span>
<span class="nc" id="L1483">				ResourceBundle rmEjbBundle = m_localizer.getBundle(RmEjbBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L1484">				String name = getName(m_agentID2);</span>
<span class="nc" id="L1485">				this.addPageMessage(Message.ERROR_TYPE, m_localizer.i18n(rmEjbBundle, RmEjbBundleKey.CANNOT_SWAP_WITH_EMPLOYEE, name));</span>
<span class="nc" id="L1486">				return false;</span>
			}
		}
<span class="nc" id="L1489">		return super.validate();</span>
	}

	private String getName(ID id) {
		try {
<span class="nc" id="L1494">			WorkResourceManager wrm = BbmManagerFactory.getWorkResourceManager();</span>
<span class="nc" id="L1495">			EmployeeName empName = wrm.getEmployeeNameByID(id);</span>
<span class="nc" id="L1496">			return empName.getDisplayName(m_localizer);</span>
<span class="nc" id="L1497">		} catch (Exception e) {</span>
		}
<span class="nc" id="L1499">		return &quot;&quot;;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>