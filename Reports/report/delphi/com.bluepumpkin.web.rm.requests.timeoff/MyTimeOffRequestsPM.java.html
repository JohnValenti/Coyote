<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MyTimeOffRequestsPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.timeoff</a> &gt; <span class="el_source">MyTimeOffRequestsPM.java</span></div><h1>MyTimeOffRequestsPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.timeoff;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.web.fs.schedule.summary.TimeOffSummaryPC;
import com.bluepumpkin.web.rm.keys.RmKeys;
import com.bluepumpkin.web.rm.keys.RmPageAction;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.MyRequestsPM;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.data.wrapper.DateWrapper;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.DefaultMultiColumnNodeData;
import com.witness.web.uif.pagecomponent.MultiColumnNodeData;
import com.witness.web.uif.pagecomponent.table.TableHeaderPC;
import com.witness.web.uif.pagemodel.ContainersInRowsPM;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.system.RequestContext;


/**
 * Title:        MyTimeOffRequestsPM
 * Description:  My Time Off Requests Display
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, inc
 * @author       David Su
 * @version      1.0
 */
public class MyTimeOffRequestsPM extends MyRequestsPM
		implements ContainersInRowsPM {
<span class="nc" id="L44">	private ArrayList m_containerList = new ArrayList(3);</span>
	private TimeOffSummaryPC m_timeOffSummaryPC;
	private TimeOffCalendarPC m_timeOffCalPC;
<span class="nc" id="L47">	private Map m_toTypeMap = Collections.EMPTY_MAP;</span>

	/**
	 * Constructs a schedule view page model shell.
	 */
	public MyTimeOffRequestsPM(RequestContext context) {
<span class="nc" id="L53">		super(context, Request.REQUESTTYPE_TIMEOFF);</span>

<span class="nc bnc" id="L55" title="All 2 branches missed.">		if (isAuthToViewTORqts()) {</span>
<span class="nc" id="L56">			m_timeOffSummaryPC = new TimeOffSummaryPC(m_context);</span>
<span class="nc" id="L57">			addChildComponent(m_timeOffSummaryPC);</span>

<span class="nc" id="L59">			m_timeOffCalPC = new TimeOffCalendarPC(m_context, 4, true, m_toolbar);</span>
<span class="nc" id="L60">			addChildComponent(m_timeOffCalPC);</span>
		}
<span class="nc" id="L62">	}</span>

	/**
	 * Add Page Not Enabled Message
	 */
	@Override
	protected void addPageNotEnabledMsg() {
<span class="nc" id="L69">		TimeOffRequestUtil.addTONotActiveMsg(this);</span>
<span class="nc" id="L70">	}</span>

	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static PageModel getInstance(RequestContext context) throws Exception {
<span class="nc" id="L76">		return getInstance(context, MyTimeOffRequestsPM.class);</span>
	}

	/**
	 * Populate Model
	 */
	@Override
	protected void loadData() throws Exception {
<span class="nc bnc" id="L84" title="All 2 branches missed.">		if (isAuthToViewTORqts()) {</span>
			try {
<span class="nc" id="L86">				Map dataMap = TimeOffRequestsMH.getMyTimeOffRequestData(m_context, m_empID, m_isIncludeExpired);</span>
<span class="nc" id="L87">				m_orgSetting = (OrganizationSetting)dataMap.get(RmKeys.DATA_MY_TO_ORG_SETTING);</span>
<span class="nc" id="L88">				m_isPageEnabled = m_orgSetting.getAgentTimeOffWorkflowActive();</span>
<span class="nc" id="L89">				m_requestList = (Collection)dataMap.get(RmKeys.DATA_MY_TO_REQUESTS);</span>
<span class="nc" id="L90">				m_toTypeMap = (Map)dataMap.get(RmKeys.DATA_MY_TO_TYPES);</span>

<span class="nc" id="L92">				m_timeOffCalPC.setOrgSetting(m_orgSetting);</span>
<span class="nc" id="L93">				m_timeOffCalPC.fetchData(m_empID, false, null);</span>
<span class="nc" id="L94">				m_timeOffSummaryPC.init();</span>
<span class="nc" id="L95">			} catch (RmHardValidationException ex) {</span>
<span class="nc" id="L96">				Message msg = handleUnableToLoadDataError(log, ex);</span>
<span class="nc" id="L97">				msg.setAssociatedMessage(ex.getLocalizedMessage(m_localizer, m_context.getViewingTimeZone()));</span>
<span class="nc" id="L98">			}</span>
		}
<span class="nc" id="L100">	}</span>

	/**
	 * Initialize Selectable Items
	 */
	@Override
	protected void initSelectableItems() {
<span class="nc" id="L107">		isDateSort = false;</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">		if (!isAuthToViewTORqts()) {</span>
<span class="nc" id="L109">			return;</span>
		}

		// Remove Components if Time Off Workflow is Not Active
<span class="nc bnc" id="L113" title="All 2 branches missed.">		if (!m_isPageEnabled) {</span>
<span class="nc" id="L114">			removeChildComponent(m_timeOffSummaryPC);</span>
<span class="nc" id="L115">			removeChildComponent(m_timeOffCalPC);</span>
<span class="nc" id="L116">			return;</span>
		}

		// added for sorting date columns as dates instead of as strings. (created based on API: TimeOffRequestUtil.addTOChoiceInfo(toRequest, m_context, row_data, m_bundle))
<span class="nc" id="L120">		int[] sortColumnIndexes = m_list.getHeader().getSortColumnIndexes();</span>
<span class="nc bnc" id="L121" title="All 8 branches missed.">		if (sortColumnIndexes != null &amp;&amp; sortColumnIndexes.length&gt;0 &amp;&amp; (sortColumnIndexes[0]==3 ||  sortColumnIndexes[0]==4)) {</span>

<span class="nc bnc" id="L123" title="All 2 branches missed.">		 if (sortColumnIndexes[0]==3) {</span>
<span class="nc" id="L124">			Collections.sort((List&lt;TORequest&gt;)m_requestList, new Comparator&lt;TORequest&gt;() {</span>
				@Override
				public int compare(TORequest req1, TORequest req2) {
<span class="nc" id="L127">				Pair&lt;ID, TimeRange&gt; pair1 = (Pair&lt;ID, TimeRange&gt;)req1.getEmpIDTimeRangePairs().iterator().next();</span>
<span class="nc" id="L128">				Pair&lt;ID, TimeRange&gt; pair2 = (Pair&lt;ID, TimeRange&gt;)req2.getEmpIDTimeRangePairs().iterator().next();</span>
<span class="nc" id="L129">				return (pair1.getSecond().getStartDate().compareTo(pair2.getSecond().getStartDate()));</span>
}});
		}

<span class="nc bnc" id="L133" title="All 2 branches missed.">		 if (sortColumnIndexes[0]==4) {</span>
<span class="nc" id="L134">			Collections.sort((List&lt;TORequest&gt;)m_requestList, new Comparator&lt;TORequest&gt;() {</span>
				@Override
				public int compare(TORequest req1, TORequest req2) {
<span class="nc" id="L137">					Pair&lt;ID, TimeRange&gt; pair1 = (Pair&lt;ID, TimeRange&gt;)req1.getEmpIDTimeRangePairs().iterator().next();</span>
<span class="nc" id="L138">					Pair&lt;ID, TimeRange&gt; pair2 = (Pair&lt;ID, TimeRange&gt;)req2.getEmpIDTimeRangePairs().iterator().next();</span>
<span class="nc" id="L139">					return (pair1.getSecond().getEndDate().compareTo(pair2.getSecond().getEndDate()));</span>
		}});
		}


			// check if desc order
<span class="nc bnc" id="L145" title="All 2 branches missed.">			if (!m_list.getHeader().isAscending()) {</span>
<span class="nc" id="L146">				Collections.reverse((List&lt;TORequest&gt;)m_requestList);</span>
			}

			// mark so autosort will not be enabled in myRequestsPM
<span class="nc" id="L150">			isDateSort = true;</span>
		}

		// Initialize Time Off Request List
<span class="nc" id="L154">		super.initSelectableItems();</span>
<span class="nc" id="L155">		m_list.setIsBorderEnabled(true);</span>
<span class="nc" id="L156">		m_list.setHeightInPixels(200);</span>
<span class="nc" id="L157">		m_containerList.add(m_list);</span>

		// Initialize Time Off Summary
<span class="nc" id="L160">		m_containerList.add(m_timeOffSummaryPC);</span>

		// Initialize Time Off Calendars
<span class="nc" id="L163">		m_timeOffCalPC.setIsLegendButtonEnabled(true);</span>
<span class="nc" id="L164">		m_containerList.add(m_timeOffCalPC);</span>
<span class="nc" id="L165">	}</span>

	/**
	 * Initialise List Header
	 */
	@Override
	protected void initHeader() {
<span class="nc" id="L172">		TableHeaderPC header = m_list.getHeader();</span>
<span class="nc" id="L173">		header.setPartialSortable(true);</span>

<span class="nc" id="L175">		addHeaderData(header, m_common_bundle, UIFWebBundleKey.STATUS, true);</span>
<span class="nc" id="L176">		addHeaderData(header, m_common_bundle, UIFWebBundleKey.TYPE, true);</span>
<span class="nc" id="L177">		addHeaderData(header, m_common_bundle, UIFWebBundleKey.SUBMITTED, true);</span>

<span class="nc" id="L179">		TimeOffRequestUtil.addTOChoiceHeader(m_common_bundle, m_bundle, m_localizer, header, true);</span>
<span class="nc" id="L180">		addCommonHeaderData();</span>
<span class="nc" id="L181">	}</span>

	/**
	 * Create Row Data From Request
	 */
	@Override
	protected MultiColumnNodeData createRowData(RequestAggregate request) {
<span class="nc" id="L188">		TORequest toRequest = (TORequest)request;</span>

<span class="nc" id="L190">		String rowID = request.getID().toString();</span>
<span class="nc" id="L191">		DefaultMultiColumnNodeData row_data = new DefaultMultiColumnNodeData(rowID);</span>

<span class="nc" id="L193">		String status = createStatusIcon(request);</span>
<span class="nc" id="L194">		row_data.add(status);</span>

<span class="nc" id="L196">		String toType = getTOType(toRequest);</span>
<span class="nc" id="L197">		row_data.add(toType);</span>

<span class="nc" id="L199">		DateWrapper submittedDT = createDataWrapper(request.getSubmittedOn());</span>
<span class="nc" id="L200">		row_data.add(submittedDT);</span>

		// Create TO Choice info
<span class="nc" id="L203">		TimeOffRequestUtil.addTOChoiceInfo(toRequest, m_context, row_data, m_bundle, true, true, false,true);</span>

<span class="nc" id="L205">		addCommonListData(request, row_data);</span>
<span class="nc" id="L206">		return row_data;</span>
	}

	/**
	 * Return Request Validation Results
	 */
	@Override
	protected Collection getValidationResults(RequestAggregate request) {
<span class="nc" id="L214">		return request.getValidationResults(false);</span>
	}

	/**
	 * Return Time Off Type Display
	 */
	private String getTOType(TORequest request) {
<span class="nc" id="L221">		ID toTypeID = request.getTimeOffType();</span>
<span class="nc" id="L222">		return (String)m_toTypeMap.get(toTypeID);</span>
	}

	/**
	 * Add Create Request Button
	 */
	@Override
	protected void addCreateRequestButton() {
<span class="nc bnc" id="L230" title="All 4 branches missed.">		boolean isBtnEnabled = m_isPageEnabled &amp;&amp; isAuthToEditTORqts();</span>
<span class="nc" id="L231">		String newRequestLabel = i18n(m_bundle, RmWebBundleKey.CREATE_NEW_REQUEST);</span>
<span class="nc" id="L232">		m_toolbar.addPopupWindowTextButton(RmPageAction.POPUP_TIMEOFF_REQUEST_FORM_ACTION,</span>
				newRequestLabel, isBtnEnabled);
<span class="nc" id="L234">	}</span>

	/** Return List of Containers
	 *
	 * NOTE: Items in the Collection will be treated either as Page Components or
	 *       just a basic Object.
	 *
	 */
	@Override
	public Collection getContainers() {
<span class="nc" id="L244">		return m_containerList;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>