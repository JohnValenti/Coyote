<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffIntervalCalendarPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.timeoff</a> &gt; <span class="el_source">TimeOffIntervalCalendarPC.java</span></div><h1>TimeOffIntervalCalendarPC.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.timeoff;

import java.text.NumberFormat;
import java.util.HashMap;
import java.util.List;
import java.util.ResourceBundle;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.l10n.RegionalFormatBundleKey;
import com.bluepumpkin.common.util.HtmlEncoder;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOIntervalCalendar;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOIntervalCalendarDay;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOIntervalCalendarIncrement;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOIntervalCalendarInterval;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOIntervalAllocation;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.ejb.rm.util.DateUtil;
import com.bluepumpkin.web.core.l10n.CoreWebBundleKey;
import com.bluepumpkin.web.rm.keys.RmJavaScriptFileID;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.keys.AccessibilityComplianceKeys;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.CompositePC;
import com.witness.web.uif.pagecomponent.container.DualContainerPC;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;

/**
 * Renders HTML for the Time Off Interval Calendar.
 */
public class TimeOffIntervalCalendarPC extends CompositePC {
	private static final int NUMBER_OF_DECIMALS = 2;
	private static final String ALLOCATION_ARROWS_NAV_INSTRUCTION_ID = &quot;allocation_days_nav_instruction_id&quot;;
	private static final String ALLOCATION_TAB_NAV_INSTRUCTION_ID = &quot;allocation_select_next_instruction_id&quot;;
	private static final String ALLOCATION_VIEW_INSTRUCTION_HIDDEN_SPAN_ID = &quot;allocation_view_instruction_id&quot;;


	/**
	 *
	 */
	private static final long serialVersionUID = 5093278963757536344L;

	private final ResourceBundle rmWebBundle;
<span class="nc" id="L46">	private DualContainerPC dualContainerPC = null;</span>
	private String legendHtml;
	private final NumberFormat numberFormat;
	private OrganizationSetting orgSetting;
	private TOIntervalCalendar timeOffIntervalCalendar;
	private final TimeOffIntervalCalendarCellDetailBuilder cellBuilder;
	private final boolean isLinkToRequestEnabledForInterval;

	// ================================================================================
	// CONSTRUCTION
	// ================================================================================

	/**
	 * Constructor
	 *
	 * @param context
	 *            The RequestContext
	 */
	public TimeOffIntervalCalendarPC(RequestContext context) {
<span class="nc" id="L65">		super(context);</span>

<span class="nc" id="L67">		setName(&quot;timeOffIntervalCalendarPC&quot;);</span>
<span class="nc" id="L68">		rmWebBundle = m_localizer.getBundle(RmWebBundleKey.BUNDLE_NAME);</span>

<span class="nc" id="L70">		dualContainerPC = new DualContainerPC(context);</span>
<span class="nc" id="L71">		dualContainerPC.setName(this.getName() + &quot;_DualContainer&quot;);</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">		if(isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L73">			HashMap rightWrapperAttr = dualContainerPC.getRightWrapperAttr();</span>
<span class="nc" id="L74">			rightWrapperAttr.put(AccessibilityComplianceKeys.ATTR_ROLE, AccessibilityComplianceKeys.ATTR_VALUE_REGION);</span>
<span class="nc" id="L75">			String ariaTitle = i18n(rmWebBundle, RmWebBundleKey.AGENTS_TO_CALENDAR) + ' ' + </span>
<span class="nc" id="L76">				i18n(m_common_bundle, UIFWebBundleKey.TIMEZONE_ORGANIZATION) + ':' +</span>
<span class="nc" id="L77">				m_localizer.formatTimeZone(m_context.getViewingTimeZone().getID()) + ' ' + </span>
<span class="nc" id="L78">				i18n(rmWebBundle, RmWebBundleKey.TIME_OFF_INTERVAL_CALENDAR_INFORMATION_GRAPH);</span>
<span class="nc" id="L79">			rightWrapperAttr.put(AccessibilityComplianceKeys.ATTR_ARIA_LABEL, ariaTitle);</span>
		}
<span class="nc" id="L81">		addChildComponent(dualContainerPC);</span>

		// start with empty cells so it doesn't render &quot;null&quot;
<span class="nc" id="L84">		dualContainerPC.setLeftComponent(&quot;&quot;);</span>
<span class="nc" id="L85">		dualContainerPC.setRightComponent(&quot;&quot;);</span>

<span class="nc" id="L87">		numberFormat = getNumberFormat();</span>
<span class="nc" id="L88">		isLinkToRequestEnabledForInterval = context.getUser().isAuthorized(PrivilegeKeys.TOM_VIEWINTERVALCALENDARLINKS);</span>
<span class="nc" id="L89">		cellBuilder = new TimeOffIntervalCalendarCellDetailBuilder(numberFormat, m_localizer, getName(),isLinkToRequestEnabledForInterval);</span>

<span class="nc" id="L91">		setWrapperRegion(false);</span>
<span class="nc" id="L92">		setUseWrapper(false);</span>
<span class="nc" id="L93">		setJSMediator(RmJavaScriptFileID.TIMEOFF_CAL_CONTAINER);</span>
<span class="nc" id="L94">		addRequiredJavaScriptFile(RmJavaScriptFileID.JQUERY_UI);</span>
<span class="nc" id="L95">		addRequiredJavaScriptFile(RmJavaScriptFileID.TIME_OFF_INTERVAL_CALENDAR_EXPANDED_VIEW);</span>
<span class="nc" id="L96">	}</span>

	// ================================================================================
	// INTERFACE
	// ================================================================================

	/**
	 * Initialize For Display
	 */
	@Override
	public void initForDisplay() {
<span class="nc bnc" id="L107" title="All 2 branches missed.">		if (m_isInitializedForDisplay) {</span>
<span class="nc" id="L108">			return;</span>
		} else {
<span class="nc" id="L110">			super.initForDisplay();</span>
		}
<span class="nc" id="L112">	}</span>

	@Override
	public String getCustomJavaScript() {
<span class="nc" id="L116">		String js = super.getCustomJavaScript();</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">		if (dualContainerPC != null) {</span>
<span class="nc" id="L118">			js += &quot;\nfunction customResize() {&quot; + dualContainerPC.getName() + &quot;.onResize(); } \n&quot;;</span>
		}
<span class="nc" id="L120">		return js;</span>
	}

	public void setLegendHtml(String legendHtml) {
<span class="nc" id="L124">		this.legendHtml = legendHtml;</span>
<span class="nc" id="L125">	}</span>

	public void setMode(boolean isAgentView, boolean isAgentTOPoolView) {
<span class="nc" id="L128">		cellBuilder.setMode(isAgentView, isAgentTOPoolView);</span>
<span class="nc" id="L129">	}</span>

	public void setOrganizationSetting(OrganizationSetting orgSetting) {
<span class="nc" id="L132">		this.orgSetting = orgSetting;</span>
<span class="nc" id="L133">	}</span>

	public void setSelectedOrganization(ID orgID) {
<span class="nc" id="L136">		cellBuilder.setSelectedOrganization(orgID);</span>
<span class="nc" id="L137">	}</span>

	public void setSelectedPool(ID topID) {
<span class="nc" id="L140">		cellBuilder.setSelectedPool(topID);</span>
<span class="nc" id="L141">	}</span>

	public void setTimeOffIntervalCalendar(TOIntervalCalendar timeOffIntervalCalendar) {
<span class="nc" id="L144">		this.timeOffIntervalCalendar = timeOffIntervalCalendar;</span>
<span class="nc" id="L145">	}</span>

	/**
	 * Return HTML Display
	 */
	@Override
	public String getHtmlDisplay() {
<span class="nc" id="L152">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L153">		sb.append(&quot;&lt;div id=\&quot;timeOffIntervalCalendarPC\&quot; class=\&quot;timeOffIntervalCalendarPC\&quot; &quot;);</span>
<span class="nc" id="L154">		sb.append(&quot;style=\&quot;position:absolute;top:25px;left:0px;right:0px;bottom:0px;\&quot;&gt;\n&quot;);</span>
<span class="nc" id="L155">		appendStyle(sb);</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">		if (timeOffIntervalCalendar != null) {</span>
<span class="nc" id="L157">			buildDates();</span>
<span class="nc" id="L158">			buildIntervalGrid();</span>
<span class="nc" id="L159">			appendIntervalGraphNavigationInstructions(sb);</span>
		}
<span class="nc" id="L161">		sb.append(dualContainerPC.getHtmlDisplay());</span>
<span class="nc" id="L162">		return sb.toString();</span>
	}

	private void appendIntervalGraphNavigationInstructions(StringBuilder sb) {
<span class="nc" id="L166">		String arrowsNavigationInstruction = i18n(rmWebBundle, </span>
			RmWebBundleKey.TIME_OFF_INTERVAL_CALENDAR_MOVE_TO_NEXT_PREV_DAY_TIME_OFF_ALLOCATION_INSTRUCTION);
<span class="nc" id="L168">		sb.append(HtmlUtil.makeHiddenSpanWithId(arrowsNavigationInstruction, ALLOCATION_ARROWS_NAV_INSTRUCTION_ID));</span>
<span class="nc" id="L169">		String tabNavigationInstruction = i18n(rmWebBundle, </span>
			RmWebBundleKey.TIME_OFF_INTERVAL_CALENDAR_MOVE_TO_NEXT_TIME_OFF_ALLOCATION_INSTRUCTION);
<span class="nc" id="L171">		sb.append(HtmlUtil.makeHiddenSpanWithId(tabNavigationInstruction, ALLOCATION_TAB_NAV_INSTRUCTION_ID));</span>
<span class="nc" id="L172">		String viewInstruction = i18n(rmWebBundle, </span>
			RmWebBundleKey.TIME_OFF_INTERVAL_CALENDAR_VIEW_ALLOCATION_INSTRUCTION);
<span class="nc" id="L174">		sb.append(HtmlUtil.makeHiddenSpanWithId(viewInstruction, ALLOCATION_VIEW_INSTRUCTION_HIDDEN_SPAN_ID));</span>
<span class="nc" id="L175">	}</span>

	// ================================================================================
	// IMPLEMENTATION
	// ================================================================================

	/**
	 * Appends the legend container and the legend HTML. This is used because of the sync scrolling on the dual list container.
	 */
	private void appendLegend(StringBuilder sb, boolean isAppendingLegend) {
<span class="nc" id="L185">		sb.append(&quot;&lt;br/&gt;&quot;);</span>
<span class="nc" id="L186">		sb.append(&quot;&lt;div class=\&quot;legendContainer\&quot;&gt;&quot;);</span>
<span class="nc bnc" id="L187" title="All 4 branches missed.">		if (isAppendingLegend &amp;&amp; legendHtml != null) {</span>
<span class="nc" id="L188">			sb.append(legendHtml);</span>
		}
<span class="nc" id="L190">		sb.append(&quot;&lt;/div&gt;&quot;);</span>
<span class="nc" id="L191">	}</span>

	private void appendStyle(StringBuilder sb) {
<span class="nc" id="L194">		sb.append(&quot;&lt;style type=\&quot;text/css\&quot;&gt;&quot;);</span>
<span class="nc" id="L195">		sb.append(&quot;.timeOffIntervalCalendarPC .legendContainer { display: inline-block; height: 200px; width: 100%; font-family:arial; }&quot;);</span>
<span class="nc" id="L196">		sb.append(&quot;.toicIntervalGrid { box-sizing: border-box; margin: 0px 1em 0px 0px; padding: 0px; font-family:arial; }&quot;);</span>
<span class="nc" id="L197">		sb.append(&quot;.toicIntervalGrid td, .toicIntervalGrid th { white-space: nowrap; }&quot;);</span>
<span class="nc" id="L198">		sb.append(&quot;.toicIntervalGrid th span.hour { height: 23px; box-sizing: border-box; width: 60px;  }&quot;);</span>
<span class="nc" id="L199">		sb.append(&quot;.toicIntervalGrid th { }&quot;);</span>
<span class="nc" id="L200">		sb.append(&quot;.toicIntervalGrid td { }&quot;);</span>
<span class="nc" id="L201">		sb.append(&quot;.toicIntervalGrid .scroll-spacer { width: 5px; }&quot;);</span>
<span class="nc" id="L202">		sb.append(&quot;.toicIntervalGrid .intervalcell { padding-top: 2px; padding-bottom: 2px; display:inline-block; &quot;);</span>
<span class="nc" id="L203">		sb.append(&quot; border-right: 1px solid #e3e3e3; overflow: hidden; text-overflow: ellipsis; text-align: center; box-sizing: border-box; &quot;);</span>
<span class="nc" id="L204">		sb.append(&quot; position: relative; z-index: 0; height: 22px; vertical-align: middle; }&quot;);</span>

<span class="nc" id="L206">		sb.append(&quot;.toicIntervalGrid .intervalcell label { vertical-align: middle; font-family:arial; } &quot;);</span>
<span class="nc" id="L207">		sb.append(&quot;.toicIntervalGrid td button span.increment { position: absolute; top: 2px; bottom: 2px; width: 15px; z-index: -1; }&quot;);</span>
<span class="nc" id="L208">		cellBuilder.appendOrganziationColorStyles(sb, orgSetting, &quot;.toicIntervalGrid td button span.increment&quot;);</span>
<span class="nc" id="L209">		sb.append(&quot;button.intervalcell {background: none; border: 0; color: inherit; font: inherit; line-height: normal; &quot;);</span>
<span class="nc" id="L210">		sb.append(&quot;overflow: visible; padding: 0;}&quot;);</span>
<span class="nc" id="L211">		sb.append(&quot;.toicIntervalGrid td span.spacer { display: inline-block; border: none; width:60px; max-width:60px; }&quot;);</span>
<span class="nc" id="L212">		sb.append(&quot;.toicIntervalGrid tr { height: 22px; max-height: 22px; }&quot;);</span>
<span class="nc" id="L213">		sb.append(&quot;.toicIntervalGrid_HeaderRow { height: 29px; font-family:arial; }&quot;);</span>

<span class="nc" id="L215">		sb.append(&quot;.expandedView { position: absolute; display:inline-block;  padding: 6px; min-height: 66px; border: 1px solid #e3e3e3; &quot;);</span>
<span class="nc" id="L216">		sb.append(&quot;font-family:arial;&quot;);</span>
<span class="nc" id="L217">		sb.append(&quot; background-color:#ffffca; z-index: 10;} &quot;);</span>

<span class="nc" id="L219">		sb.append(&quot;.toicDateGrid { box-sizing: border-box; margin: 0px 0px 0px 0px; padding: 0px; font-family:arial; }&quot;);</span>
<span class="nc" id="L220">		sb.append(&quot;.toicDateGrid td, .toicDateGrid th { padding-left: 1px; padding-right: 1px; }&quot;);</span>
<span class="nc" id="L221">		sb.append(&quot;.toicDateGrid th.date { vertical-align: middle; white-space: nowrap; text-align: right; }&quot;);</span>
<span class="nc" id="L222">		sb.append(&quot;.toicDateGrid tbody tr { height: 22px; max-height: 22px; }&quot;);</span>
<span class="nc" id="L223">		sb.append(&quot;&lt;/style&gt;&quot;);</span>
<span class="nc" id="L224">	}</span>

	private void buildDates() {
<span class="nc" id="L227">		List&lt;TOIntervalCalendarDay&gt; days = timeOffIntervalCalendar.getDays();</span>
<span class="nc" id="L228">		TimeZone tz = m_context.getViewingTimeZone();</span>
<span class="nc" id="L229">		StringBuilder sb = new StringBuilder();</span>

<span class="nc" id="L231">		sb.append(&quot;&lt;table class=\&quot;toicDateGrid\&quot; cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot;&gt;&quot;);</span>
<span class="nc" id="L232">		sb.append(&quot;&lt;thead&gt;&lt;tr&gt;&lt;th class=\&quot;tableHeaderLightLeft\&quot;&gt;&quot;);</span>
<span class="nc" id="L233">		sb.append(i18n(m_common_bundle, UIFWebBundleKey.DATE));</span>
<span class="nc" id="L234">		sb.append(&quot;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&quot;);</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">		for (TOIntervalCalendarDay day : days) {</span>
<span class="nc" id="L236">			sb.append(&quot;&lt;tr&gt;&lt;th class=\&quot;date\&quot;&gt;&quot;);</span>
<span class="nc" id="L237">			sb.append(m_localizer.formatDate(day.getStartTime(), tz, RegionalFormatBundleKey.FULL_DATE_FORMAT));</span>
<span class="nc" id="L238">			sb.append(&quot;&lt;/th&gt;&lt;/tr&gt;&quot;);</span>
<span class="nc" id="L239">		}</span>
<span class="nc" id="L240">		sb.append(&quot;&lt;/tbody&gt;&lt;/table&gt;&quot;);</span>

<span class="nc" id="L242">		appendLegend(sb, false);</span>

<span class="nc" id="L244">		dualContainerPC.setLeftComponent(sb.toString());</span>
<span class="nc" id="L245">	}</span>

	private void buildIntervalGrid() {
<span class="nc" id="L248">		TOIntervalCalendarDay longestDay = timeOffIntervalCalendar.getLongestDay();</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">		if (longestDay == null) {</span>
<span class="nc" id="L250">			return;</span>
		}
<span class="nc" id="L252">		TimeZone tz = m_context.getViewingTimeZone();</span>
<span class="nc" id="L253">		int index = timeOffIntervalCalendar.getIndex(longestDay.getStartTime());</span>
<span class="nc" id="L254">		int endIndexExclusive = timeOffIntervalCalendar.getIndex(longestDay.getEndTime());</span>
<span class="nc" id="L255">		List&lt;TOIntervalCalendarIncrement&gt; increments = timeOffIntervalCalendar.getIncrements();</span>

<span class="nc" id="L257">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L258">		sb.append(getExpandedView());</span>

<span class="nc" id="L260">		sb.append(&quot;&lt;table class=\&quot;toicIntervalGrid\&quot; cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot; &quot;);</span>
<span class="nc" id="L261">		sb.append(&quot;style=\&quot;\&quot;&gt;&lt;thead&gt;&lt;tr class=\&quot;toicIntervalGrid_HeaderRow\&quot;&gt;&quot;);</span>

<span class="nc" id="L263">		sb.append(&quot;&lt;th class=\&quot;\&quot;&gt;&quot;);</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">		for (; index &lt; endIndexExclusive; index += DateUtil.INTERVALS_IN_HOUR) {</span>
<span class="nc" id="L265">			TOIntervalCalendarIncrement increment = increments.get(index);</span>
<span class="nc" id="L266">			String time = m_localizer.formatDate(increment.getDate(), tz, RegionalFormatBundleKey.TIME_FORMAT);</span>
<span class="nc" id="L267">			sb.append(&quot;&lt;span class=\&quot;hour\&quot;&gt;&quot;).append(time).append(&quot;&lt;/span&gt;&quot;);</span>
		}
<span class="nc" id="L269">		sb.append(&quot;&lt;/th&gt;&lt;th class=\&quot;scroll-spacer\&quot;&gt;&amp;nbsp;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&quot;);</span>
<span class="nc" id="L270">		buildIntervals(sb);</span>
<span class="nc" id="L271">		sb.append(&quot;&lt;/tbody&gt;&lt;/table&gt;&quot;);</span>

<span class="nc" id="L273">		appendLegend(sb, true);</span>
<span class="nc" id="L274">		appendIntervalGraphNavigationInstructions(sb);</span>

<span class="nc" id="L276">		dualContainerPC.setRightComponent(sb.toString());</span>
<span class="nc" id="L277">	}</span>

	private String getExpandedView() {
<span class="nc" id="L280">		return &quot;&lt;div id=\&quot;expandedViewPopup\&quot; tabindex=\&quot;0\&quot; role=\&quot;region\&quot; class=\&quot;expandedView tabbable\&quot;&gt;&quot;</span>
				// table start and header
				+ &quot;&lt;table&gt;&lt;tr&gt;&lt;td colspan='2'&gt;&lt;b&gt;&lt;label id='expanded_view_heading'&gt;&lt;/label&gt;&lt;/b&gt;&lt;td&gt;&lt;/tr&gt; &lt;tr&gt;&lt;td&gt;&quot;
				// hours available/allocated
<span class="nc" id="L284">				+ cellBuilder.getAvailableOrAllocatedLabelText()</span>
				+ &quot;&lt;/td&gt;&lt;td&gt;&lt;label id='expanded_view_val_available'&gt;&lt;/label&gt;&lt;td&gt;&lt;/tr&gt;&quot;
				// hours pending
<span class="nc" id="L287">				+ getExpandedViewRow(&quot;pending&quot;, i18n(rmWebBundle, RmWebBundleKey.TIMEOFF_HOURS_PENDING))</span>
				// hours scheduled
<span class="nc" id="L289">				+ getExpandedViewRow(&quot;scheduled&quot;, i18n(rmWebBundle, RmWebBundleKey.TIMEOFF_SCHEDULED_TO))</span>
				// close table
				+ &quot;&lt;/table&gt;&lt;/div&gt;&quot;;
	}

	private String getExpandedViewRow(String id, String heading) {
<span class="nc" id="L295">		return String.format(</span>
				// heading cell
				&quot;&lt;tr&gt;&lt;td&gt; &lt;label id='label_%s'&gt;%s&lt;/label&gt;&lt;a id='anchor_%s'&gt;%s&lt;/a&gt;  &lt;/td&gt;&quot;
						// value cell
						+ &quot;&lt;td&gt;&lt;label id='label_val_%s'&gt;&lt;/label&gt;&lt;a id='anchor_val_%s'&gt;&lt;/a&gt; &lt;td&gt;&lt;/tr&gt;&quot;,
				// heading cell
				id, heading, id, heading,
				// value cell
				id, id);
	}

	private void buildIncrements(StringBuilder sb, TOIntervalCalendarInterval interval) {
<span class="nc" id="L307">		int startIndex = timeOffIntervalCalendar.getIndex(interval.getStartTime());</span>
<span class="nc" id="L308">		int endIndexExclusive = timeOffIntervalCalendar.getIndex(interval.getEndTime());</span>
<span class="nc" id="L309">		List&lt;TOIntervalCalendarIncrement&gt; increments = timeOffIntervalCalendar.getIncrements();</span>
<span class="nc" id="L310">		int dstOffset = 0;</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">		for (int index = startIndex; index &lt; endIndexExclusive; index++) {</span>
<span class="nc" id="L312">			TOIntervalCalendarIncrement increment = increments.get(index);</span>
<span class="nc" id="L313">			boolean sameStartTime = interval.getStartTime().equals(increment.getDate());</span>
<span class="nc bnc" id="L314" title="All 4 branches missed.">			if (!sameStartTime &amp;&amp; timeOffIntervalCalendar.hasDstTransitionGapBefore(increment)) {</span>
<span class="nc" id="L315">				dstOffset = DateUtil.INTERVALS_IN_HOUR;</span>
			}
<span class="nc" id="L317">			String cssClass = cellBuilder.getCssClass(increment);</span>
<span class="nc" id="L318">			sb.append(&quot;&lt;span class=\&quot;increment &quot;).append(cssClass).append(&quot;\&quot; style=\&quot;&quot;);</span>
<span class="nc" id="L319">			sb.append(&quot;left:&quot;).append((index - startIndex + dstOffset) * DateUtil.TIME_INTERVAL).append(&quot;px;&quot;);</span>
<span class="nc" id="L320">			sb.append(&quot;\&quot;&gt;&lt;/span&gt;&quot;);</span>
		}
<span class="nc" id="L322">	}</span>

	private void buildIntervals(StringBuilder sb) {
<span class="nc" id="L325">		List&lt;TOIntervalCalendarDay&gt; days = timeOffIntervalCalendar.getDays();</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">		for (int dayIndex = 0; dayIndex &lt; days.size(); dayIndex++) {</span>
<span class="nc" id="L327">			TOIntervalCalendarDay day = days.get(dayIndex);</span>
<span class="nc" id="L328">			sb.append(&quot;&lt;tr&gt;&lt;td&gt;&quot;);</span>
<span class="nc" id="L329">			List&lt;TOIntervalCalendarInterval&gt; intervals = day.getIntervals();</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">			for (int i = 0; i &lt; intervals.size(); i++) {</span>
<span class="nc" id="L331">				TOIntervalCalendarInterval interval = intervals.get(i);</span>
<span class="nc" id="L332">				int index = timeOffIntervalCalendar.getIndex(interval.getStartTime());</span>
<span class="nc" id="L333">				int endIndexExclusive = timeOffIntervalCalendar.getIndex(interval.getEndTime());</span>
<span class="nc" id="L334">				int colspan = endIndexExclusive - index;</span>
				// Add a spacer cell if necessary
<span class="nc bnc" id="L336" title="All 2 branches missed.">				if (timeOffIntervalCalendar.hasDstTransitionGapBefore(interval, day)) {</span>
<span class="nc" id="L337">					sb.append(&quot;&lt;span class=\&quot;spacer\&quot; style=\&quot;\&quot;&gt; &lt;/span&gt;&quot;);</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">				} else if (timeOffIntervalCalendar.hasDstTransitionGapWithin(interval)) {</span>
					// Add spacer columns to the interval.
<span class="nc" id="L340">					colspan += DateUtil.INTERVALS_IN_HOUR;</span>
				}
<span class="nc" id="L342">				buildIntervalCell(sb, interval, colspan, day, i);</span>
			}
<span class="nc" id="L344">			sb.append(&quot;&lt;/td&gt;&lt;td class=\&quot;scroll-spacer\&quot;&gt;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
		}
<span class="nc" id="L346">	}</span>

	private void buildIntervalCell(StringBuilder sb, TOIntervalCalendarInterval interval, int colspan, 
								   TOIntervalCalendarDay day, int intervalNumber) {

<span class="nc" id="L351">		cellBuilder.initialize(interval);</span>
<span class="nc" id="L352">		String dateRangeText = getDateRangeText(interval);</span>
<span class="nc" id="L353">		String cell = cellBuilder.getCellText();</span>
<span class="nc" id="L354">		int startIndex = timeOffIntervalCalendar.getIndex(interval.getStartTime());</span>
<span class="nc" id="L355">		List&lt;TOIntervalCalendarIncrement&gt; increments = timeOffIntervalCalendar.getIncrements();</span>
<span class="nc" id="L356">		TOIntervalCalendarIncrement toIntervalCalendarIncrement = increments.get(startIndex);</span>

<span class="nc bnc" id="L358" title="All 2 branches missed.">		String tooltip = isAccessibilityComplianceMode()</span>
<span class="nc" id="L359">			? cellBuilder.getCell508AriaTooltip(dateRangeText, toIntervalCalendarIncrement, orgSetting)</span>
<span class="nc" id="L360">			: cellBuilder.getCellTooltip(dateRangeText);</span>
		
<span class="nc" id="L362">		sb.append(&quot;&lt;button role=\&quot;link\&quot; tabindex=\&quot;0\&quot; class='intervalcell intervalCellWrapper tabbable subregion' data-columns=\&quot;&quot;).append(colspan).append(&quot;\&quot; &quot;);</span>
<span class="nc" id="L363">		addDataElement(sb, &quot;data-heading&quot;, dateRangeText);</span>
<span class="nc" id="L364">		addDataElement(sb, &quot;data-availableorallocated&quot;, cellBuilder.getAvailableOrAllocatedHoursText());</span>
<span class="nc" id="L365">		addDataElement(sb, &quot;data-pending&quot;, cellBuilder.getPendingHoursText());</span>
<span class="nc" id="L366">		addDataElement(sb, &quot;data-scheduled&quot;, cellBuilder.getScheduledHoursText());</span>
<span class="nc" id="L367">		sb.append(&quot;aria-label=\&quot;&quot;);</span>
<span class="nc bnc" id="L368" title="All 4 branches missed.">		if(isAccessibilityComplianceMode() &amp;&amp; intervalNumber == 0) {</span>
<span class="nc" id="L369">			appendFullDayInfo(sb, day);</span>
		}
<span class="nc" id="L371">		sb.append(tooltip).append(&quot;\&quot;&quot;);</span>
<span class="nc" id="L372">		appendKeyboardAccessibilityInstructions(sb);</span>
<span class="nc" id="L373">		sb.append(&quot;aria-label-tooltip=\&quot;true\&quot;&quot;);</span>
<span class="nc" id="L374">		sb.append(&quot;onmouseenter=\&quot;showAriaTooltip(window.event,this)\&quot;&quot;);</span>
<span class="nc" id="L375">		sb.append(&quot;onmouseleave=\&quot;hideAriaTooltip()\&quot;&quot;);</span>
<span class="nc" id="L376">		sb.append(&quot;onfocus=\&quot;showAriaTooltip(window.event,this)\&quot;&quot;);</span>
<span class="nc" id="L377">		sb.append(&quot;onblur=\&quot;hideAriaTooltip()\&quot; &quot;);</span>

<span class="nc" id="L379">		sb.append(&quot;style=\&quot;width: &quot;).append(colspan * DateUtil.TIME_INTERVAL).append(&quot;px;&quot;);</span>
<span class="nc" id="L380">		sb.append(&quot;max-width: &quot;).append(colspan * DateUtil.TIME_INTERVAL).append(&quot;px;&quot;);</span>
<span class="nc" id="L381">		sb.append(&quot;min-width: &quot;).append(colspan * DateUtil.TIME_INTERVAL).append(&quot;px;\&quot; &quot;);</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">		if(!isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L383">			sb.append(&quot;title=\&quot;&quot;).append(HtmlEncoder.encode(tooltip)).append(&quot;\&quot;&quot;);</span>
		}
<span class="nc" id="L385">		sb.append(&quot; &gt;&quot;);</span>
		
<span class="nc" id="L387">		buildIncrements(sb, interval);</span>

<span class="nc" id="L389">		sb.append(&quot;&lt;label style=\&quot;width: 100%;\&quot;&gt;&quot;);</span>
<span class="nc" id="L390">		sb.append(cell);</span>
<span class="nc" id="L391">		sb.append(&quot;&lt;/label&gt;&quot;);</span>


<span class="nc" id="L394">		sb.append(&quot;&lt;/button&gt;&quot;);</span>
<span class="nc" id="L395">	}</span>

	private void appendFullDayInfo(StringBuilder sb, TOIntervalCalendarDay day) {
<span class="nc" id="L398">		TimeZone tz = m_context.getViewingTimeZone();</span>
<span class="nc" id="L399">		String fullDayDescription = m_localizer.formatDate(day.getStartTime(), tz, RegionalFormatBundleKey.FULL_DATE_FORMAT);</span>
<span class="nc" id="L400">		sb.append(fullDayDescription).append(' ');</span>
<span class="nc" id="L401">	}</span>

	private void appendKeyboardAccessibilityInstructions(StringBuilder sb) {
<span class="nc" id="L404">		sb.append(&quot;aria-describedby=\&quot;&quot;)</span>
<span class="nc" id="L405">			.append(ALLOCATION_VIEW_INSTRUCTION_HIDDEN_SPAN_ID + ' ')</span>
<span class="nc" id="L406">			.append(ALLOCATION_TAB_NAV_INSTRUCTION_ID + ' ')</span>
<span class="nc" id="L407">			.append(ALLOCATION_ARROWS_NAV_INSTRUCTION_ID)</span>
<span class="nc" id="L408">			.append('&quot;');</span>
<span class="nc" id="L409">	}</span>

	private void addDataElement(StringBuilder sb, String elementName, String value) {
<span class="nc" id="L412">		sb.append(elementName).append(&quot;='&quot;).append(HtmlEncoder.encode(value)).append(&quot;'&quot;);</span>
<span class="nc" id="L413">	}</span>

	private String getDateRangeText(TOIntervalCalendarInterval interval) {
<span class="nc" id="L416">		TimeZone timeZone = m_context.getViewingTimeZone();</span>
<span class="nc" id="L417">		TOIntervalAllocation allocationInterval = interval.getInterval();</span>
<span class="nc" id="L418">		return m_localizer.i18n(CoreWebBundleKey.BUNDLE_NAME, CoreWebBundleKey.RANGE_SEPARATOR,</span>
<span class="nc" id="L419">				m_localizer.formatDateTime(allocationInterval.getStartTime(), timeZone),</span>
<span class="nc" id="L420">				m_localizer.formatDateTime(allocationInterval.getEndTime(), timeZone));</span>
	}

	/**
	 * Gets the number formatter used for the interval's allocated hours.
	 */
	private NumberFormat getNumberFormat() {
<span class="nc" id="L427">		NumberFormat format = m_context.getLocalizer().getNumberFormatter(NUMBER_OF_DECIMALS);</span>
<span class="nc" id="L428">		format.setMinimumFractionDigits(0);</span>
<span class="nc" id="L429">		format.setMaximumFractionDigits(NUMBER_OF_DECIMALS);</span>
<span class="nc" id="L430">		return format;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>