<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AgentsTimeOffCalendarPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.timeoff</a> &gt; <span class="el_source">AgentsTimeOffCalendarPM.java</span></div><h1>AgentsTimeOffCalendarPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.timeoff;

import java.util.ArrayList;
import java.util.ResourceBundle;

import weblogic.wsee.util.StringUtil;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.workresource.OrganizationScopeManagerProxy;
import com.bluepumpkin.ejb.rm.RmManagerFactory;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOPool;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.web.bbm.organization.OrgWorkpaneFormPageModel;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.keys.RmPageAction;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.RequestsMH;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.JavaScriptFileID;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.contenttitle.ContentTitlePC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.pagemodel.WorkpaneFieldNames;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;

/**
 * Title:        AgentsTimeOffCalendarPM
 * Description:  Agents Time Off Calendar
 * Copyright:    Copyright (c) 2001
 * Company:      Blue Pumpkin Software, inc
 * @author       David Su
 * @version      1.0
 */
public class AgentsTimeOffCalendarPM extends OrgWorkpaneFormPageModel {
	/**
	 *
	 */
	private static final long serialVersionUID = 1L;
<span class="nc" id="L46">	private static Category m_log = Log.initCategory(AgentsTimeOffCalendarPM.class.getName());</span>
	private static final String FORM_ACTION = &quot;agents_to_calendar&quot;;
	public static final String ALLOCATION_TYPE_FN = &quot;allocationType&quot;;

	private static final String ALLOCATION_SESSION_KEY = &quot;agentAllocationTypeSession&quot;;

	private TimeOffCalendarPC m_timeOffCalPC;

	private ResourceBundle m_bundle;
	private OrganizationSetting m_orgSetting;
<span class="nc" id="L56">	private boolean m_isTOActive = true;</span>
	private User m_user;
	private ID m_empID;
	private ID m_poolID; //The Time Off Pool ID which was selected in the Time Off Pool List page
<span class="nc" id="L60">	private TOPool m_pool = null; //The Time Off Pool which was selected in the Time Off Pool List page</span>
<span class="nc" id="L61">	private boolean m_isOrgMode = false; //are we in org mode? True if org mode, false if pool mode.</span>
<span class="nc" id="L62">	private boolean hasAdvancedRMLicense = false;</span>
<span class="nc" id="L63">	private String timeOffAllocationType = TimeOffCalendarPC.DAILY_ALLOCATION_DROPDOWN_VALUE;</span>

	/**
	 * Constructs a schedule view page model shell.
	 */
	public AgentsTimeOffCalendarPM(RequestContext context) {
<span class="nc" id="L69">		super(context);</span>

<span class="nc" id="L71">		setJSMediator(JavaScriptFileID.MEDIATOR_WORKPANE_GENERIC);</span>
<span class="nc" id="L72">		m_bundle = m_localizer.getBundle(RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L73">		m_user = m_context.getUser();</span>
<span class="nc" id="L74">		m_empID = m_user.getEmployeeID();</span>

<span class="nc" id="L76">		m_timeOffCalPC = new TimeOffCalendarPC(context, 1, false, m_toolbar);</span>
<span class="nc" id="L77">		m_timeOffCalPC.setNumOfCals(2);</span>
<span class="nc" id="L78">		m_timeOffCalPC.setIsDetailEnabled(true);</span>
<span class="nc" id="L79">		m_timeOffCalPC.setWrapperRegion(false);</span>
<span class="nc" id="L80">		addChildComponent(m_timeOffCalPC);</span>
<span class="nc" id="L81">		hasAdvancedRMLicense = LicenseUtil.isAdvancedRMLicense();</span>

<span class="nc" id="L83">	}</span>

	/**
	 * Initialize Model with Data.
	 * Overriding the parent class' implementation to set the m_pool before org authorization is performed,
	 * since we need the pool in order to get the orgID.
	 */
	@Override
	protected void initializeModel() {
		//Get the time off pool. We need it to get the orgID, since we cannot assume that the selected org ID is the one for the pool
<span class="nc bnc" id="L93" title="All 2 branches missed.">		if (!isViewAllMode()) {</span>
			try {
<span class="nc" id="L95">				m_pool = RmManagerFactory.getInstance().getTimeOffDayFacade().getTOPool(m_poolID);</span>
<span class="nc" id="L96">			} catch (Exception ex) {</span>
<span class="nc" id="L97">				handleUnableToLoadDataError(m_log, ex);</span>
<span class="nc" id="L98">			}</span>
		}
<span class="nc" id="L100">		super.initializeModel();</span>
<span class="nc" id="L101">	}</span>

	/**
	 * Initialize For Display
	 */
	@Override
	public void initForDisplay() {
<span class="nc bnc" id="L108" title="All 2 branches missed.">		if (m_isInitializedForDisplay) {</span>
<span class="nc" id="L109">			return;</span>
		} else {
<span class="nc" id="L111">			super.initForDisplay();</span>

<span class="nc bnc" id="L113" title="All 2 branches missed.">			if (!isValidEmployee()) {</span>
<span class="nc" id="L114">				addPageMessage(Message.INFO_TYPE, UIFWebBundleKey.SCREEN_DISABLED_FOR_NON_EMP, UIFWebBundleKey.BUNDLE_NAME);</span>
			}

<span class="nc bnc" id="L117" title="All 6 branches missed.">			if (!hasError() &amp;&amp; isValidSelectedOrg() &amp;&amp; !isAuthorized()) {</span>
<span class="nc" id="L118">				addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.AGENTS_TO_CALENDAR_UNAUTH_TO_VIEW_ORG, RmWebBundleKey.BUNDLE_NAME);</span>
			}

			//add message for the &quot;All pools&quot; option: &quot;Time off hour allocations can be viewed on selection of any one Time-Off Pool only.&quot;
<span class="nc bnc" id="L122" title="All 2 branches missed.">			if (isViewAllMode()) {</span>
<span class="nc" id="L123">				addPageMessage(Message.INFO_TYPE, RmWebBundleKey.AGENTS_TO_CALENDAR_ALLOCATIONS_SHARED, RmWebBundleKey.BUNDLE_NAME);</span>
			}

<span class="nc bnc" id="L126" title="All 2 branches missed.">			if (!m_isTOActive) {</span>
<span class="nc" id="L127">				TimeOffRequestUtil.addTONotActiveMsg(this);</span>
			}
		}
<span class="nc" id="L130">	}</span>

	public boolean isViewAllMode() {
<span class="nc bnc" id="L133" title="All 4 branches missed.">		return pageAction.equals(PageAction.VIEW_DETAIL) || m_isOrgMode;</span>
	}

	/**
	 * Return instance of Model which is ready to be rendered
	 */
	public static PageModel getInstance(RequestContext context) {
<span class="nc" id="L140">		return getInstance(context, AgentsTimeOffCalendarPM.class);</span>
	}
	
	public String getPageTitle() {
<span class="nc" id="L144">		return i18n(m_bundle, RmWebBundleKey.AGENTS_TO_CALENDAR);</span>
	}

	/**
	 * creates the form model. Use to load the information from the backend or in
	 * case it is a &quot;create new&quot; opertion to initilaized the value object
	 */
	@Override
	protected void createFormModel() {
		try {
<span class="nc bnc" id="L154" title="All 4 branches missed.">			if (isAuthorized() &amp;&amp; isValidSelectedOrg()) {</span>
<span class="nc" id="L155">				ID orgID = getOrgID();</span>
<span class="nc" id="L156">				m_orgSetting = RequestsMH.getOrgSetting(orgID);</span>
<span class="nc" id="L157">				m_isTOActive = m_orgSetting.getManagerTimeOffWorkflowActive();</span>

<span class="nc" id="L159">				m_timeOffCalPC.setOrgSetting(m_orgSetting);</span>
<span class="nc" id="L160">				m_timeOffCalPC.setIsAgentCal(false);</span>
				
<span class="nc" id="L162">				boolean intervalAllocationSelected = false;</span>
<span class="nc" id="L163">				String allocationType = getAllocationType();</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">				if (hasAdvancedRMLicense) {</span>
<span class="nc" id="L165">					m_timeOffCalPC.setTimeOffAllocationType(allocationType);</span>
<span class="nc" id="L166">					intervalAllocationSelected = TimeOffCalendarPC.INTERVAL_ALLOCATION_DROPDOWN_VALUE.equals(allocationType);</span>
					
				}
<span class="nc bnc" id="L169" title="All 2 branches missed.">				if (intervalAllocationSelected) {</span>
<span class="nc" id="L170">					m_timeOffCalPC.setUseWrapper(false);</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">				} else if (TimeOffCalendarPC.DAILY_ALLOCATION_DROPDOWN_VALUE.equals(allocationType)) {</span>
<span class="nc" id="L172">					m_timeOffCalPC.setWrapperStyle(&quot;margin: 2px&quot;);</span>
				}
				// JT No activityID
<span class="nc" id="L175">				m_timeOffCalPC</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">						.fetchDataForManager(m_empID, orgID, isViewAllMode() ? null : m_poolID, Integer.parseInt(getAllocationType()));</span>
			}
<span class="nc" id="L178">		} catch (Exception ex) {</span>
<span class="nc" id="L179">			handleUnableToLoadDataError(m_log, ex);</span>
<span class="nc" id="L180">		}</span>
<span class="nc" id="L181">	}</span>

	/**
	 * Return the content title
	 */
	@Override
	public ContentTitlePC getContentTitle() {
		// Initialize Content Title		
<span class="nc" id="L189">		m_contentTitlePC.setPageTitle(getPageTitle());</span>

<span class="nc" id="L191">		String orgName = getOrganizationName();</span>
<span class="nc" id="L192">		String itemName = orgName;</span>

<span class="nc bnc" id="L194" title="All 2 branches missed.">		if (isDisplayEnabled()) {</span>
			// Calendar Navigation
<span class="nc" id="L196">			String calendarNav = m_timeOffCalPC.getNavigationControl();</span>
<span class="nc" id="L197">			itemName = calendarNav; // + &quot; - &quot; + orgName;</span>
<span class="nc" id="L198">			String tabbableTitleLabel = &quot;&quot;;</span>

<span class="nc bnc" id="L200" title="All 2 branches missed.">			if (isViewAllMode()) {</span>
				//show org name
<span class="nc" id="L202">				tabbableTitleLabel = HtmlUtil.getTabbableLabel(i18n(m_bundle, RmWebBundleKey.ORGANIZATION_TITLE) + &quot; &quot; + orgName, null);</span>
<span class="nc" id="L203">				itemName += &quot; &quot; + tabbableTitleLabel; //&quot; Organization: &quot;</span>
			} else {
				//show pool name
<span class="nc" id="L206">				String poolName = &quot;&quot;;</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">				if (m_pool != null) {</span>
<span class="nc" id="L208">					poolName = m_pool.getName();</span>
				}

<span class="nc" id="L211">				tabbableTitleLabel = HtmlUtil.makeHiddenReadableText(HtmlUtil.NBSP) + HtmlUtil.getTabbableLabel(</span>
<span class="nc" id="L212">					i18n(m_bundle, RmWebBundleKey.TIME_OFF_POOL_TITLE) + &quot; &quot; + poolName, null);</span>
<span class="nc" id="L213">				itemName += &quot; &quot; + tabbableTitleLabel; //&quot; Time Off Pool: &quot;</span>
			}
		}
<span class="nc" id="L216">		m_contentTitlePC.setItemName(itemName);</span>
<span class="nc" id="L217">		String viewLabel = i18n(m_common_bundle, UIFWebBundleKey.VIEW);</span>
<span class="nc" id="L218">		m_contentTitlePC.setActiveComponent(viewLabel, HtmlUtil.NBSP + createAllocationDropdownList(viewLabel), hasAdvancedRMLicense);</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L220">			m_contentTitlePC.setAriaRegion(true);</span>
		}

<span class="nc" id="L223">		return m_contentTitlePC;</span>
	}

	@SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
	private String createAllocationDropdownList(String ariaLabel) {
<span class="nc" id="L228">		ArrayList options = new ArrayList();</span>
<span class="nc" id="L229">		options.add(new StringsPair(TimeOffCalendarPC.DAILY_ALLOCATION_DROPDOWN_VALUE, i18n(RmWebBundleKey.TIMEOFF_POOL_DAILY_ALLOCATIONS)));</span>
<span class="nc" id="L230">		options.add(new StringsPair(TimeOffCalendarPC.INTERVAL_ALLOCATION_DROPDOWN_VALUE,</span>
<span class="nc" id="L231">				i18n(RmWebBundleKey.TIMEOFF_POOL_INTERVAL_ALLOCATIONS)));</span>
<span class="nc" id="L232">		StringBuilder onChangeJS = new StringBuilder();</span>
<span class="nc" id="L233">		onChangeJS.append(&quot;pageMediator.refreshPageWithAction('&quot;).append(RmPageAction.TIMEOFF_ALLOCATION_TYPE_CHANGE_ACTION).append(&quot;')&quot;);</span>
<span class="nc" id="L234">		return HtmlUtil.makeSelectInput(ALLOCATION_TYPE_FN, &quot;&quot;, new String[]{getAllocationType()}, </span>
<span class="nc" id="L235">			onChangeJS.toString(), options, null, false, false,</span>
			true, false, null, null, true, ariaLabel, null);

	}

	/**
	 * Initialize Toolbar
	 */
	@Override
	protected void initToolbar() {
<span class="nc" id="L245">		String refreshLabel = i18n(m_common_bundle, UIFWebBundleKey.TOOLBAR_REFRESH);</span>
<span class="nc" id="L246">		m_toolbar.addSubmitTextButton(PageAction.REFRESH, refreshLabel, isDisplayEnabled());</span>
<span class="nc" id="L247">	}</span>

	/** Return URL for HTML Form Action
	 */
	@Override
	public String getFormAction() {
<span class="nc" id="L253">		return FORM_ACTION;</span>
	}

	/**
	 * Return True if Employee is Valid
	 */
	protected boolean isValidEmployee() {
<span class="nc bnc" id="L260" title="All 2 branches missed.">		return m_empID != null;</span>
	}

	/**
	 * Return True if authorized
	 */
	protected boolean isAuthorized() {
<span class="nc" id="L267">		ID orgID = getOrgID();</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">		return isValidEmployee()</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">				&amp;&amp; m_context.getUser().isAuthorized(PrivilegeKeys.TOM_VIEWTIMEOFFCALENDAR_ID,</span>
<span class="nc" id="L270">						OrganizationScopeManagerProxy.getScopeID(orgID));</span>
	}

	/**
	 * Return Html Display
	 */
	@Override
	public String getHtmlDisplay() {
<span class="nc bnc" id="L278" title="All 2 branches missed.">		if (!isDisplayEnabled()) {</span>
<span class="nc" id="L279">			return &quot;&quot;;</span>
		}

<span class="nc" id="L282">		return m_timeOffCalPC.getHtmlDisplay();</span>
	}

	/**
	 * Return Required HTML
	 */
	@Override
	public String getRequiredHTML() {
<span class="nc" id="L290">		StringBuffer sb = new StringBuffer(super.getRequiredHTML()).append(HtmlUtil.makeHiddenInput(SELECTED_ID_FN, getSelectedID())) //the orgID</span>
<span class="nc" id="L291">				.append(HtmlUtil.makeHiddenInput(WorkpaneFieldNames.PERFORM_ACTION_ON_ID_FN, m_poolID));</span>

<span class="nc bnc" id="L293" title="All 2 branches missed.">		if (isViewAllMode()) {</span>
<span class="nc" id="L294">			sb.append(HtmlUtil.makeHiddenInput(&quot;orgMode&quot;, &quot;true&quot;));</span>
		}
<span class="nc bnc" id="L296" title="All 2 branches missed.">		if (isAccessibilityComplianceMode()) {</span>
<span class="nc" id="L297">			sb.append(HtmlUtil.makeHiddenSpanWithId(i18n(m_bundle, getPageTitle()), ALTERNATIVE_RIGHT_DIV_TITLE_ID));</span>
		}

<span class="nc" id="L300">		return sb.toString();</span>
	}

	/**
	 * Return true if Display is Enabled
	 */
	private boolean isDisplayEnabled() {
<span class="nc bnc" id="L307" title="All 6 branches missed.">		return m_isTOActive &amp;&amp; isAuthorized() &amp;&amp; isValidSelectedOrg();</span>
	}

	@Override
	protected String getEntityName() {
<span class="nc" id="L312">		return &quot;&quot;;</span>
	}

	@Override
	public String getFormTitle() {
<span class="nc" id="L317">		return &quot;&quot;;</span>
	}

	@Override
	protected String getTitleEntityType() {
<span class="nc" id="L322">		return &quot;&quot;;</span>
	}

	@Override
	protected void initFieldValidators() {
<span class="nc" id="L327">	}</span>
	
	/**
	 * Setter for pool ID. Automatically extracted.
	 * @param poolID
	 */
	public void setPerformActionOnID(ID poolID) {
<span class="nc" id="L334">		m_poolID = poolID;</span>
<span class="nc" id="L335">	}</span>

	public ID getPoolID() {
<span class="nc" id="L338">		return m_poolID;</span>
	}

	public ID getOrgID() {
<span class="nc bnc" id="L342" title="All 2 branches missed.">		if (isViewAllMode()) {</span>
<span class="nc" id="L343">			return getSelectedIDObject();</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">		} else if (m_pool != null) {</span>
<span class="nc" id="L345">			return m_pool.getOrganizationId(); //can't use getSelectedIDObject() because user might be viewing TOCalendar for a parent org of the one selected</span>
		}

<span class="nc" id="L348">		return null;</span>
	}

	/**
	 * Getter for the orgMode boolean
	 * @return
	 */
	public boolean getOrgMode() {
<span class="nc" id="L356">		return m_isOrgMode;</span>
	}

	/**
	 * Setter for the orgMode boolean. This is called automatically from super.extractParameters().
	 * It is a hidden variable that gets set from this page model whenever in org mode. We need it
	 * because the &quot;View Organization&quot; button is only on the pool list page. But our page model
	 * still needs to remember the setting when refreshing  (Refresh button), or changing dates
	 * (date picker in title area).
	 * @return - true if we are in org mode, false if we are in pool mode. The default is false.
	 */
	public boolean setOrgMode(boolean isOrgMode) {
<span class="nc" id="L368">		return m_isOrgMode = isOrgMode;</span>
	}

	public String getAllocationType() {
<span class="nc" id="L372">		String allocationTypeSession = (String) m_context.getAttribute(RequestContext.SESSION_SCOPE, ALLOCATION_SESSION_KEY);</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">		return StringUtil.isEmpty(allocationTypeSession) ? timeOffAllocationType : allocationTypeSession;</span>
	}

	public void setAllocationType(String type) {
<span class="nc" id="L377">		timeOffAllocationType = type;</span>
<span class="nc" id="L378">		m_context.setAttribute(RequestContext.SESSION_SCOPE, ALLOCATION_SESSION_KEY, type);</span>
<span class="nc" id="L379">	}</span>

	private String i18n(String key) {
<span class="nc" id="L382">		return i18n(m_bundle, key);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>