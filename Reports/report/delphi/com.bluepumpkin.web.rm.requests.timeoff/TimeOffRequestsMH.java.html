<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffRequestsMH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.timeoff</a> &gt; <span class="el_source">TimeOffRequestsMH.java</span></div><h1>TimeOffRequestsMH.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.timeoff;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.util.PersonNameUtil;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityProperties;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.facade.base.FacadeException;
import com.bluepumpkin.ejb.rm.base.RmException;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.timeoff.ejb.TORequestManager;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOCalendarDayData;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOIntervalCalendar;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOPool;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.rm.keys.RmKeys;
import com.bluepumpkin.web.rm.requests.RequestsMH;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.system.RequestContext;

/**
 * Title:        TimeOffRequestsMH
 * Description:  Model Handler for Time Off Requests
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc
 * @author       David Su, dsu
 * @version      1.0
 *
 * Created on November 13, 2002, 9:45 AM
 */
<span class="nc" id="L57">public class TimeOffRequestsMH extends RequestsMH {</span>
	protected static TORequestManager getTORequestManager() throws BbmCreateException {
<span class="nc" id="L59">		return m_managerFactory.getTimeOffRequestManager();</span>
	}

	/**
	 * Approve Time Off Request
	 *
	 * @param requestID The ID of the Request
	 * @param toChoiceID The ID of the TimeOff Choice
	 * @param requestVersion The Request Value Object version
	 * @param comment The comment associated with the action
	 */
	public static void approveTORequest(ID requestID, ID toChoiceID,
			String requestVersion, String comment)
			throws RemoteException, MultiUserException,
			RmHardValidationException, BbmCreateException, RmException {
<span class="nc" id="L74">		getTORequestManager().approveRequestByID(requestID, toChoiceID,</span>
				requestVersion, comment);
<span class="nc" id="L76">	}</span>

	/**
	 * Tentativeley Approve Time Off Request
	 *
	 * @param requestID The ID of the Request
	 * @param toChoiceID The ID of the TimeOff Choice
	 * @param requestVersion The Request Value Object version
	 * @param comment The comment associated with the action
	 */
	public static void tentativelyApproveTORequest(ID requestID, ID toChoiceID,
			String requestVersion, String comment)
			throws MultiUserException, BbmCreateException, RmHardValidationException, RemoteException, RmException {
<span class="nc" id="L89">		getTORequestManager().approveRequestTentativelyByID(requestID, toChoiceID,</span>
				requestVersion, comment);
<span class="nc" id="L91">	}</span>

	/**
	 * Deny Time Off Request
	 *
	 * @param requestID The ID of the Request
	 * @param requestVersion The Request Value Object version
	 * @param comment The comment associated with the action
	 */
	public static void denyTORequest(ID requestID, String requestVersion, String comment)
			throws MultiUserException, BbmCreateException, RmHardValidationException, RemoteException, RmException {
<span class="nc" id="L102">		getTORequestManager().denyRequestByID(requestID, requestVersion, comment);</span>
<span class="nc" id="L103">	}</span>

	/**
	 * Return TimeOff Types for the specified Organization ID
	 *
	 * @param orgID The Organization ID
	 * @return Collection of ActivityType
	 */
	public static Collection getTimeOffTypes(ID orgID)
			throws BbmFinderException, BbmCreateException, RemoteException {
<span class="nc" id="L113">		return getTORequestManager().getTimeOffTypes(orgID);</span>
	}

	/**
	 * Return TimeOff Types for the specified Organization ID. If isFromNetStaffingRibbon, we get only VTO.
	 *
	 * @param orgID The Organization ID
	 * @return Collection of ActivityType
	 */
	public static Collection getTimeOffTypes(ID orgID, boolean isFromNetStaffingRibbon, RequestContext context)
			throws BbmFinderException, BbmCreateException, RemoteException, BbmException {
		//if (!isFromNetStaffingRibbon)
		//{
<span class="nc" id="L126">			return getTORequestManager().getTimeOffTypes(orgID);</span>
		//}
		/*
		else
		{
			ArrayList onlyVTO = new ArrayList(1);
			Activity vto = ActivityModelHandler.getActivityByID(context, Activity.ACTIVITY_VOLUNTARY_TIMEOFF);
			if (vto.isRequestable() &amp;&amp; vto.isTimeoff())
				onlyVTO.add(vto);

			return onlyVTO;
		}
		*/
	}

	/**
	 * Return TimeOff Types for the specified Employee ID
	 *
	 * @param empID The Employee ID
	 * @return Collection of ActivityType
	 */
	public static Collection getTimeOffTypesForEmployee(RequestContext context, ID empID)
			throws RemoteException, BbmException {
<span class="nc" id="L149">		ID orgID = getEmpOrgID(context, empID);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">		if (orgID==null) {</span>
<span class="nc" id="L151">			return Collections.emptyList();</span>
		}

<span class="nc" id="L154">		return getTimeOffTypes(orgID);</span>
	}


	/**
	 * Return &quot;TimeoffWithAllotment&quot; TimeOff Types for the specified Organization ID.
	 *
	 * @param orgID The Organization ID
	 * @return Collection of ActivityType
	 */
	public static Collection getAccruableTimeOffTypes(ID orgID)
			throws BbmFinderException, BbmCreateException, RemoteException {
<span class="nc" id="L166">		return getTORequestManager().getAccruableTimeOffTypes(orgID);</span>
	}

	/**
	 * Create TimeOff Request
	 *
	 * @param request The Request Object to be created
	 * @param comment The Comment associated with the Request
	 */
	public static ID createTORequest(TORequest request, String comment)throws Exception {
<span class="nc" id="L176">		return getTORequestManager().createRequest(request, comment) ;</span>
	}

	/**
	 * Update TimeOff Request
	 *
	 * @param request The Request Object to be created
	 * @param comment The Comment associated with the Request
	 */
	public static void updateTORequest(TORequest request, String comment)
			throws BbmUpdateException, MultiUserException, BbmCreateException, RmHardValidationException, RemoteException {
<span class="nc" id="L187">		getTORequestManager().updateRequest(request, comment);</span>
<span class="nc" id="L188">	}</span>

	/**
	 * Return Time Off Request for specified ID
	 *
	 * @param requestID The Time Off Request ID
	 */
	public static TORequest getTORequest(ID requestID) throws
			BbmFinderException, BbmCreateException, RemoteException, RmHardValidationException {
<span class="nc" id="L197">		return (TORequest)getTORequestManager().getRequestByID(requestID, true, true,</span>
				TORequest.DL_AUDIT_TRAIL |
				TORequest.DL_TIMEOFF_CHOICES |
				TORequest.DL_TIMEOFF_CHOICES_LENGTH |
                TORequest.DL_TIMEOFF_WAITLIST |
                TORequest.DL_TIMEOFF_WITHDRAW);
	}

	public static TORequest getTORequest(ID requestID, boolean incExpired, boolean runSoftValids, long detailLevel) throws
			BbmFinderException, BbmCreateException, RemoteException, RmHardValidationException {
<span class="nc" id="L207">		return (TORequest)getTORequestManager().getRequestByID(requestID, incExpired, runSoftValids, detailLevel);</span>
	}

	/**
	 * Get the waitlist rank of a given TORequest
	 *
	 * @return a string like &quot;3/5&quot;
	 */
	public static String getWaitlistRank(ID toReqID) {
<span class="nc" id="L216">		String result = &quot;/&quot;;</span>
		try {
<span class="nc" id="L218">			int[] rank = m_managerFactory.getTOWaitlistManager().getWaitlistRank(toReqID);</span>
<span class="nc" id="L219">			result = rank[0] + result + rank[1];</span>
<span class="nc" id="L220">		} catch (Exception e) {</span>
<span class="nc" id="L221">		}</span>
<span class="nc" id="L222">		return result;</span>
	}

	/**
	 * Get the waitlist rank of a given TORequest. The first element is the rank. The second is the total number of waitlisted requests
	 * for the range of the request.
	 * 
	 * @throws RemoteException
	 * @throws BbmCreateException
	 */
	public static int[] getWaitlistRankByID(ID toReqID) throws BbmCreateException, RemoteException {
<span class="nc" id="L233">		return m_managerFactory.getTOWaitlistManager().getWaitlistRank(toReqID);</span>
	}

	/**
	 * Return Time Off Type Map
	 */
	public static Map getTimeOffTypeMap(RequestContext context, ID empID)
			throws RemoteException, BbmException {
<span class="nc" id="L241">		Collection toTypeList = getTimeOffTypesForEmployee(context, empID);</span>
<span class="nc" id="L242">		Map toTypeMap = new HashMap();</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">		for(Iterator it=toTypeList.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L244">			Activity activity = (Activity)it.next();</span>
<span class="nc" id="L245">			toTypeMap.put(activity.getID(), activity.getName());</span>
<span class="nc" id="L246">		}</span>
<span class="nc" id="L247">		return toTypeMap;</span>
	}

	/**
	 * Return All Postings For a Employee
	 */
	public static Collection getRequestsByEmployee(ID empID, boolean incExpired)
		throws RemoteException, BbmException, RmHardValidationException {
<span class="nc" id="L255">		return getTORequestManager().getRequestsByEmployee(empID, incExpired, true,</span>
				TORequest.DL_AUDIT_TRAIL |
				TORequest.DL_TIMEOFF_CHOICES|
				TORequest.DL_TIMEOFF_CHOICES_LENGTH|
                TORequest.DL_TIMEOFF_WAITLIST |
                TORequest.DL_TIMEOFF_WITHDRAW);
	}

	/**
	 * Return Data for My Time Off Request Page
	 */
	public static Map getMyTimeOffRequestData(RequestContext context, ID empID, boolean incExpired)
			throws RemoteException, BbmException, BbmFinderException, BbmEJBCreateException, RmHardValidationException {
<span class="nc" id="L268">		HashMap map = new HashMap();</span>

		// Request Information
<span class="nc" id="L271">		Collection requestList = getRequestsByEmployee(empID, incExpired);</span>
<span class="nc" id="L272">		map.put(RmKeys.DATA_MY_TO_REQUESTS, requestList);</span>

		// Time Off Type Map
<span class="nc" id="L275">		Map toTypeMap = getTimeOffTypeMap(context, empID);</span>
<span class="nc" id="L276">		map.put(RmKeys.DATA_MY_TO_TYPES, toTypeMap);</span>

		// Information for Time Off Calendar
<span class="nc" id="L279">		OrganizationSetting orgSetting = getOrgSettingForEmployee(context, empID);</span>
<span class="nc" id="L280">		map.put(RmKeys.DATA_MY_TO_ORG_SETTING, orgSetting);</span>

<span class="nc" id="L282">		return map;</span>
	}

	/**
	 * Return Agents Emp Name that have Scheduled Time Off for the specified
	 * Org and Date
	 */
	public static Collection getEmpNamesForTOHour(ID managerID, ID orgID, ID toPoolID,  Date date, String hourType) throws RemoteException, BbmException {
<span class="nc" id="L290">		Collection result = Collections.emptyList();</span>

<span class="nc bnc" id="L292" title="All 2 branches missed.">		if (RmKeys.SCHEDULED_TO_TYPE.equals(hourType))</span>
		{
<span class="nc" id="L294">			result = getTORequestManager().getEmpNamesForScheduledTO(managerID, orgID,toPoolID, date);</span>
		}
		//else if (RmKeys.HOURS_PENDING_TYPE.equals(hourType))
		//{
		//	result = getTORequestManager().getEmployeeNamesForPendingTO(null, orgID,toPoolID, date);
		//}

<span class="nc" id="L301">		return result;</span>
	}

	/**
	 * Return Time Off Detail Calendar Data in the specified time range for specified Employee
	 */
	public static List getTOCalendarDataForEmployee(ID empID, Date startDate, Date endDate, boolean isTOPoolView,Organization currentEmpOrg)
			throws RemoteException, BbmException {
<span class="nc" id="L309">		TOCalendarDayData[] toDayData = getTORequestManager().getTOCalendarDetailData(empID, startDate, endDate, isTOPoolView,currentEmpOrg);</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">		return toDayData!=null? Arrays.asList(toDayData): Collections.emptyList();</span>
	}
	

	/**
	 * Gets the time off interval calendar for the employee. See getTOCalendarDetailData.
	 *
	 * @param empID
	 *            The employee's ID.
	 * @param startDate
	 *            The start of the range.
	 * @param endDate
	 *            The exclusive end of the range.
	 * @param timeZone
	 *            The viewing time zone.
	 * @param isTOPoolView
	 *            True if we are viewing the time off pool. Otherwise, only the employee's
	 *            data will be returned
	 * @return
	 * @throws BbmFinderException
	 * @throws RemoteException
	 */
	public static TOIntervalCalendar getTOIntervalCalendarForEmp(ID empID, Date startDate, Date endDate, TimeZone timeZone,
			boolean isTOPoolView) throws BbmFinderException, BbmCreateException, RemoteException {
<span class="nc" id="L334">		return getTORequestManager().getTOIntervalCalendarForEmp(empID, startDate, endDate, timeZone, isTOPoolView);</span>
	}

	/**
	 * Return Time Off Detail Calendar Data in the specified time range for specified Employee
	 */
	public static List getTOCalendarDataForManager(ID empID, ID orgID, ID pTOPoolID, Date startDate, Date endDate)
			throws RemoteException, BbmException {
<span class="nc" id="L342">		TOCalendarDayData[] toDayData = getTORequestManager()</span>
<span class="nc" id="L343">				.getTOCalendarDetailDataForManager(empID, orgID, pTOPoolID, startDate, endDate);</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">		return toDayData!=null? Arrays.asList(toDayData): Collections.emptyList();</span>
	}

	/**
	 * Gets the time off interval calendar for a manager. See getTOCalendarDetailDataForManager.
	 *
	 * @param orgID
	 *            The selected organization's ID.
	 * @param pTOPoolID
	 *            The time off pool's ID to view. Null will return the organization's TOIC.
	 * @param startDate
	 *            The start of the range.
	 * @param endDate
	 *            The exclusive end of the range.
	 * @return
	 * @throws BbmFinderException
	 * @throws RemoteException
	 */
	public static TOIntervalCalendar getTOIntervalCalendarForManager(ID orgID, ID pTOPoolID, Date startDate, Date endDate)
			throws BbmFinderException, BbmCreateException, RemoteException {
<span class="nc" id="L364">		return getTORequestManager().getTOIntervalCalendarForManager(orgID, pTOPoolID, startDate, endDate);</span>
	}

	/**
	 * Return Time Off Detail Calendar Data in the specified time range for specified Employee for organization view
	 */
	/* COMMENTED BY SAMEET to-pOOLS
	public static List getTOCalendarDataForAgentOrgView(ID orgID, ID parentOrgID, Date startDate, Date endDate)
			throws RemoteException, BbmException {
		TOCalendarDayData[] toDayData = getTORequestManager()
				.getTOCalendarDetailDataForAgentOrgView(orgID, parentOrgID, startDate, endDate);
		return Arrays.asList(toDayData);
	}                              */

	/**
	 * Return Time Off Detail Data
	 */
	public static TODetailData getTODetailData(RequestContext context, ID empID, TORequest request, boolean isFromNetStaffingRibbon)
			throws Exception {
		// TimeOff Request details
<span class="nc" id="L384">		return getTimeOffOrFlexDetailData(context, empID, request, isFromNetStaffingRibbon, ActivityProperties.TIME_OFF_TIME);</span>
	}

	/**
	 * @param context
	 * @param empID
	 * @param request
	 * @param isFromNetStaffingRibbon
	 * @param flexType
	 * @return
	 * @throws RemoteException
	 * @throws BbmException
	 * @throws BbmFinderException
	 * @throws BbmCreateException
	 * @throws Exception
	 */
	public static TODetailData getTimeOffOrFlexDetailData(RequestContext context, ID empID, TORequest request,
			boolean isFromNetStaffingRibbon, int flexType)
					throws RemoteException, BbmException, BbmFinderException, BbmCreateException, Exception {
<span class="nc" id="L403">		ID orgID = getEmpOrgID(context, empID);</span>
<span class="nc" id="L404">		Collection toTypeList = getTimeOffTypes(orgID, isFromNetStaffingRibbon, context, flexType);</span>
<span class="nc" id="L405">		OrganizationSetting orgSetting = getOrgSetting(orgID);</span>
<span class="nc" id="L406">		TOPool pool = getEmpPool(context, empID);</span>

<span class="nc" id="L408">		return new TODetailData(empID, request, toTypeList, orgSetting, pool, Collections.EMPTY_LIST);</span>
	}

	/**
	 * Return TimeOff Types for the specified Organization ID. If isFromNetStaffingRibbon, we get only VTO.
	 *
	 * @param orgID The Organization ID
	 * @param flexType - to identify if it's a flex or Time Off request
	 * @return Collection of ActivityType
	 */
	private static Collection getTimeOffTypes(ID orgID, boolean isFromNetStaffingRibbon, RequestContext context, int flexFlag)
			throws BbmFinderException, BbmCreateException, RemoteException, BbmException {

<span class="nc" id="L421">			return getTORequestManager().getTimeOffTypes(orgID, flexFlag);</span>
	}

	/**
	 * Return Time Off Detail Data For Manager
	 */
	public static TODetailData getTODetailDataForManager(RequestContext context, User user, ID empID,
			boolean isNewRequest, TORequest request, boolean isFromNetStaffingRibbon)
		throws RemoteException, BbmException, FacadeException, RmHardValidationException {
<span class="nc" id="L430">		return getTimeOffOrFlexDetailDataForManager(context, user, empID, isNewRequest, request, isFromNetStaffingRibbon, ActivityProperties.TIME_OFF_TIME);</span>
	}

	/**
	 * Return either Time Off or flex Detail Data For Manager based on the flexType
	 * @param context
	 * @param user
	 * @param empID
	 * @param isNewRequest
	 * @param request
	 * @param isFromNetStaffingRibbon
	 * @param flexType
	 * @return TODetailData
	 * @throws RemoteException
	 * @throws BbmException
	 * @throws FacadeException
	 * @throws RmHardValidationException
	 */
	public static TODetailData getTimeOffOrFlexDetailDataForManager(RequestContext context, User user, ID empID,
			boolean isNewRequest, TORequest request, boolean isFromNetStaffingRibbon, int flexType)
		throws RemoteException, BbmException, FacadeException, RmHardValidationException
	{
		try
		{
			// @todo: need backend implementation for optimization
<span class="nc bnc" id="L455" title="All 4 branches missed.">			if (empID==null &amp;&amp; request!=null) {</span>
<span class="nc" id="L456">				empID = request.getEmployeeID();</span>
			}

<span class="nc" id="L459">			Collection empNameList = Collections.emptyList();</span>
<span class="nc" id="L460">			Collection orgIDs = Collections.emptyList();</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">			if (isNewRequest) {</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">				if (TORequest.FLEXTYPE_FLEXWITHMAKEUP == flexType)</span>
				{
<span class="nc" id="L464">					orgIDs = user.getAuthorizedScopes(PrivilegeKeys.FT_MODIFYREQUESTSFOREMPLOYEE, Organization.SCOPE_TYPE);</span>
				} else {
<span class="nc" id="L466">					orgIDs = user.getAuthorizedScopes(PrivilegeKeys.TOM_MODIFYREQUESTSFOREMPLOYEE, Organization.SCOPE_TYPE);</span>
				}
<span class="nc" id="L468">				empNameList = EmployeeModelHandler.getEmployeeNamesForOrgs(context, orgIDs, null);</span>

<span class="nc bnc" id="L470" title="All 4 branches missed.">				if (empID==null &amp;&amp; !empNameList.isEmpty())</span>
				{
					//Create sorted list
<span class="nc" id="L473">					List sortedENames = new ArrayList(empNameList);</span>
<span class="nc" id="L474">					PersonNameUtil.sort(sortedENames, true, context.getLocaleContext());</span>
<span class="nc" id="L475">					EmployeeName eName = (EmployeeName)sortedENames.iterator().next();</span>
<span class="nc" id="L476">					empID = eName.getID();</span>
<span class="nc" id="L477">				}</span>
			}
			else
			{
<span class="nc bnc" id="L481" title="All 2 branches missed.">				if (request!=null)</span>
				{
<span class="nc" id="L483">					List ids = new ArrayList(1); ids.add(request.getEmployeeID());</span>
<span class="nc" id="L484">					HashMap eNameMap = EmployeeModelHandler.getEmployeeNamesByIDs(context, ids);</span>
<span class="nc" id="L485">					empNameList = eNameMap.values();</span>
				}
			}

<span class="nc bnc" id="L489" title="All 4 branches missed.">			if (isNewRequest &amp;&amp; empNameList.isEmpty())</span>
			{
				// No Agents under manager's supervision
<span class="nc" id="L492">				return new TODetailData(empID, request, Collections.EMPTY_LIST, null, null, Collections.EMPTY_LIST);</span>
			}
			else
			{
<span class="nc" id="L496">				ID orgID = getEmpOrgID(context, empID);</span>
<span class="nc" id="L497">				Collection toTypeList = getTimeOffTypes(orgID, isFromNetStaffingRibbon, context, flexType);</span>
<span class="nc" id="L498">				OrganizationSetting orgSetting = getOrgSetting(orgID);</span>
<span class="nc" id="L499">				TOPool pool = getEmpPool(context, empID);</span>
<span class="nc" id="L500">				return new TODetailData(empID, request, toTypeList, orgSetting, pool, empNameList);</span>
			}
		}
<span class="nc" id="L503">		catch ( Exception e )</span>
		{
<span class="nc" id="L505">			return null;</span>
		}
	}

	/**
	 * Return Time Off Type Name
	 */
	public static String getTimeOffTypeName(RequestContext context, TORequest request)
			throws RemoteException, BbmException {
		// @todo: need backend implementation for optimization

		// Determine Time Off Type Display Name
<span class="nc" id="L517">		ID empID = request.getEmployeeID();</span>
<span class="nc" id="L518">		ID orgID = getEmpOrgID(context, empID);</span>
<span class="nc" id="L519">		Collection toTypeList = getTimeOffTypes(orgID);</span>
<span class="nc" id="L520">		String toTypeName = &quot;&quot;;</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">		for(Iterator it=toTypeList.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L522">			Activity activity = (Activity)it.next();</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">			if (request.getTimeOffType().equals(activity.getID())) {</span>
<span class="nc" id="L524">				toTypeName = activity.getName();</span>
<span class="nc" id="L525">				break;</span>
			}
<span class="nc" id="L527">		}</span>

<span class="nc" id="L529">		return toTypeName;</span>
	}

	/**
	 * Return Time Off Detail Data
	 */
	public static Collection getTOActivities(ID empID, Date start, Date end)
	        throws RemoteException, BbmException {
<span class="nc" id="L537">		return getTORequestManager().getTOActivities(empID, start, end);</span>
	}

	public static Pair addRequestToWaitlist(RequestContext context, ID requestID, String comment, Date expiryDate) throws Exception {
		//TODO: check view privilege here to verify it is a manager
<span class="nc" id="L542">		Pair pair = new Pair(new Boolean(&quot;true&quot;), null);</span>
<span class="nc" id="L543">		boolean isManager = true;</span>
<span class="nc" id="L544">		TORequest request =  getTORequest(requestID);</span>
<span class="nc" id="L545">		String oldStatus = request.getRequestStatus();</span>
<span class="nc" id="L546">		getTORequestManager().addRequestTOWaitlist(context.getUser().getID(), request, comment, expiryDate, isManager);</span>
<span class="nc" id="L547">		request =  getTORequest(requestID);</span>
<span class="nc" id="L548">		System.out.println(&quot;at end of getRequestByID&quot;);</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">		if (request.getRequestStatus().equals(oldStatus)) {</span>
<span class="nc" id="L550">			pair = new Pair(new Boolean(&quot;false&quot;), RequestUtil.getLocalizedMsgInAppDefLocale(RmEjbBundleKey.TIMEOFF_CANNOT_ADD_TO_WAITLIST));</span>
		}
<span class="nc" id="L552">		return pair;</span>
	}

	public static Pair acceptWithdrawOfApprovedRequest(RequestContext context, ID requestID, String comment) throws Exception {
<span class="nc" id="L556">		TORequest request = getTORequest(requestID);</span>
<span class="nc" id="L557">		Pair pair = getTORequestManager().isEligibleForRequestWithdrawOfApprovedRequest(request);</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">		if (((Boolean)pair.getFirst()).booleanValue()) {</span>
<span class="nc" id="L559">			getTORequestManager().acceptWithdrawOfApprovedRequest(request, comment);</span>
		}
<span class="nc" id="L561">		return pair;</span>
	}

	public static void rejectWithdrawOfApprovedRequest(RequestContext context, ID requestID, String comment) throws Exception {
<span class="nc" id="L565">		getTORequestManager().rejectWithdrawOfApprovedRequest(getTORequest(requestID), comment);</span>
<span class="nc" id="L566">	}</span>

	public static Pair&lt;Boolean, String&gt; cancelWithdrawOfApprovedRequest(RequestContext context, ID requestID, String comment) throws Exception {
<span class="nc" id="L569">		TORequest request = getTORequest(requestID);</span>
<span class="nc" id="L570">		Pair&lt;Boolean, String&gt; pair = getTORequestManager().isEligibleForRequestWithdrawOfApprovedRequest(request);</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">		if (pair.getFirst().booleanValue()) {</span>
<span class="nc" id="L572">			getTORequestManager().cancelWithdrawOfApprovedRequest(request, comment);</span>
		}
<span class="nc" id="L574">		return pair;</span>
	}

	public static Pair&lt;Boolean, String&gt; requestWithdrawOfApprovedRequest(ID requestID, String requestType,
	                                                    String requestVersion, String requestStatus, String comment) throws Exception {
<span class="nc" id="L579">		Pair&lt;Boolean, String&gt; pair = new Pair&lt;Boolean, String&gt;(new Boolean(&quot;true&quot;), &quot;&quot;); //return true by default. false is explicitly set in one scenario only</span>
<span class="nc" id="L580">		TORequest request = getTORequest(requestID);</span>
		//if request is approved then invoke the approved TO Withdraw process
<span class="nc bnc" id="L582" title="All 2 branches missed.">		if (request.getRequestStatus().equals(RequestAuditTrail.STATUS_APPROVED)) {</span>
<span class="nc" id="L583">			pair = getTORequestManager().isEligibleForRequestWithdrawOfApprovedRequest(request);</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">			if (pair.getFirst().booleanValue()) {</span>
<span class="nc" id="L585">				getTORequestManager().requestWithdrawOfApprovedRequest(request, comment);</span>
			}
		} else {
<span class="nc" id="L588">			RequestsMH.changeRequestStatus(requestID, requestType, requestVersion, requestStatus, comment);</span>
		}
<span class="nc" id="L590">		return pair;</span>
	}
	/*****************************************************************************
	 * Inner Classes used to package data
	 ****************************************************************************/
<span class="nc" id="L595">	public static class TODetailData {</span>
		private ID _empID;
		private TORequest _toRequest;
		private Collection&lt;Activity&gt; _toTypeList;
		private OrganizationSetting _orgSetting;
		private TOPool _pool;
<span class="nc" id="L601">		private Collection&lt;EmployeeName&gt; _empNameList = Collections.emptyList();</span>

		public TODetailData(ID empID, TORequest request, Collection&lt;Activity&gt; toTypeList,
<span class="nc" id="L604">				OrganizationSetting orgSetting, TOPool pool, Collection&lt;EmployeeName&gt; empNameList) {</span>
<span class="nc" id="L605">			_empID = empID;</span>
<span class="nc" id="L606">			_toRequest = request;</span>
<span class="nc" id="L607">			_toTypeList = toTypeList;</span>
<span class="nc" id="L608">			_orgSetting = orgSetting;</span>
<span class="nc" id="L609">			_pool = pool;</span>
<span class="nc" id="L610">			_empNameList = empNameList;</span>
<span class="nc" id="L611">		}</span>

<span class="nc" id="L613">		public ID getEmpID() { return _empID; }</span>
<span class="nc" id="L614">		public TORequest getTORequest() { return _toRequest; }</span>
<span class="nc" id="L615">		public Collection&lt;Activity&gt; getTOTypes() { return _toTypeList; }</span>
<span class="nc" id="L616">		public OrganizationSetting getOrgSetting() { return _orgSetting; }</span>
<span class="nc" id="L617">		public TOPool getPool() { return _pool; }</span>
<span class="nc" id="L618">		public Collection&lt;EmployeeName&gt; getEmployeeNames() { return _empNameList; }</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>