<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffRequestsMH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.timeoff</a> &gt; <span class="el_source">TimeOffRequestsMH.java</span></div><h1>TimeOffRequestsMH.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.timeoff;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.util.PersonNameUtil;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityProperties;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.core.base.MultiUserException;
import com.bluepumpkin.ejb.facade.base.FacadeException;
import com.bluepumpkin.ejb.rm.base.RmException;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.base.RmRuntimeException;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.timeoff.ejb.TOPoolUtil;
import com.bluepumpkin.ejb.rm.requests.timeoff.ejb.TORequestManager;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOCalendarDayData;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOIntervalCalendar;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.model.TOPool;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.rm.keys.RmKeys;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.RequestsMH;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.system.RequestContext;

/**
 * Title:        TimeOffRequestsMH
 * Description:  Model Handler for Time Off Requests
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc
 * @author       David Su, dsu
 * @version      1.0
 *
 * Created on November 13, 2002, 9:45 AM
 */
<span class="nc" id="L65">public class TimeOffRequestsMH extends RequestsMH {</span>
	protected static TORequestManager getTORequestManager() throws BbmCreateException {
<span class="nc" id="L67">		return m_managerFactory.getTimeOffRequestManager();</span>
	}

	/**
	 * Approve Time Off Request
	 *
	 * @param requestID The ID of the Request
	 * @param toChoiceID The ID of the TimeOff Choice
	 * @param requestVersion The Request Value Object version
	 * @param comment The comment associated with the action
	 */
	public static void approveTORequests(ID requestID, Collection&lt;ID&gt; toChoiceIDs,
			String requestVersion, String comment)
			throws RemoteException, MultiUserException,
			RmHardValidationException, BbmCreateException, RmException {
<span class="nc" id="L82">		getTORequestManager().approveRequestByIDWithChoiceIDs(requestID, toChoiceIDs,</span>
				requestVersion, comment);
<span class="nc" id="L84">	}</span>



	/**
	 * Tentativeley Approve Time Off Request
	 *
	 * @param requestID The ID of the Request
	 * @param toChoiceID The ID of the TimeOff Choice
	 * @param requestVersion The Request Value Object version
	 * @param comment The comment associated with the action
	 */
	public static void tentativelyApproveTORequests(ID requestID, Collection&lt;ID&gt; toChoiceID,
			String requestVersion, String comment)
			throws MultiUserException, BbmCreateException, RmHardValidationException, RemoteException, RmException {
<span class="nc" id="L99">		getTORequestManager().approveRequestTentativelyByIDWithChoiceIDs(requestID, toChoiceID,</span>
				requestVersion, comment);
<span class="nc" id="L101">	}</span>

	public static void tentativelyApproveTORequest(ID requestID, ID toChoiceID,
			String requestVersion, String comment)
			throws MultiUserException, BbmCreateException, RmHardValidationException, RemoteException, RmException {
<span class="nc" id="L106">		getTORequestManager().approveRequestTentativelyByID(requestID, toChoiceID,</span>
				requestVersion, comment);
<span class="nc" id="L108">	}</span>

	/**
	 * Deny Time Off Request
	 *
	 * @param requestID The ID of the Request
	 * @param requestVersion The Request Value Object version
	 * @param comment The comment associated with the action
	 */
	public static void denyTORequest(ID requestID, String requestVersion, String comment) throws MultiUserException, BbmCreateException,
			RmHardValidationException, RemoteException, RmException {
<span class="nc" id="L119">		getTORequestManager().denyRequestByID(requestID, requestVersion, comment);</span>
<span class="nc" id="L120">	}</span>

	/**
	 * Return TimeOff Types for the specified Organization ID
	 *
	 * @param orgID The Organization ID
	 * @return Collection of ActivityType
	 */
	public static Collection getTimeOffTypes(ID orgID) throws BbmFinderException, BbmCreateException, RemoteException {
<span class="nc" id="L129">		return getTORequestManager().getTimeOffTypes(orgID);</span>
	}

	/**
	 * Return TimeOff Types for the specified Organization ID
	 *
	 * @param orgIDs Collection of  Organization IDs
	 * @return Collection of ActivityType
	 */
	public static Collection getTimeOffTypes(Collection&lt;ID&gt; orgIDs) throws BbmFinderException, BbmCreateException, RemoteException {
<span class="nc" id="L139">		return getTORequestManager().getTimeOffTypes(orgIDs);</span>
	}

	/**
	 * Return TimeOff Types for the specified Organization ID
	 *
	 * @param orgIDs Collection of  Organization IDs
	 * @return Collection of ActivityType
	 */
	public static Collection getTimeOffTypes(Collection&lt;ID&gt; orgIDs, int flexTypes) throws BbmFinderException, BbmCreateException, RemoteException {
<span class="nc" id="L149">		return getTORequestManager().getTimeOffTypes(orgIDs, flexTypes);</span>
	}

	/**
	 * Return TimeOff Types for the specified Organization ID. If isFromNetStaffingRibbon, we get only VTO.
	 *
	 * @param orgID The Organization ID
	 * @return Collection of ActivityType
	 */
	public static Collection getTimeOffTypes(ID orgID, boolean isFromNetStaffingRibbon, RequestContext context) throws BbmFinderException,
			BbmCreateException, RemoteException, BbmException {
		//if (!isFromNetStaffingRibbon)
		//{
<span class="nc" id="L162">		return getTORequestManager().getTimeOffTypes(orgID);</span>
		//}
		/*
		else
		{
			ArrayList onlyVTO = new ArrayList(1);
			Activity vto = ActivityModelHandler.getActivityByID(context, Activity.ACTIVITY_VOLUNTARY_TIMEOFF);
			if (vto.isRequestable() &amp;&amp; vto.isTimeoff())
				onlyVTO.add(vto);

			return onlyVTO;
		}
		*/
	}

	/**
	 * Return TimeOff Types for the specified Employee ID
	 *
	 * @param empID The Employee ID
	 * @return Collection of ActivityType
	 */
	public static Collection getTimeOffTypesForEmployee(RequestContext context, ID empID) throws RemoteException, BbmException {
<span class="nc" id="L184">		ID orgID = getEmpOrgID(context, empID);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">		if (orgID == null) {</span>
<span class="nc" id="L186">			return Collections.emptyList();</span>
		}

<span class="nc" id="L189">		return getTimeOffTypes(orgID);</span>
	}

	/**
	 * Return &quot;TimeoffWithAllotment&quot; TimeOff Types for the specified Organization ID.
	 *
	 * @param orgID The Organization ID
	 * @return Collection of ActivityType
	 */
	public static Collection getAccruableTimeOffTypes(ID orgID) throws BbmFinderException, BbmCreateException, RemoteException {
<span class="nc" id="L199">		return getTORequestManager().getAccruableTimeOffTypes(orgID);</span>
	}

	/**
	 * Create TimeOff Request
	 *
	 * @param request The Request Object to be created
	 * @param comment The Comment associated with the Request
	 */
	public static ID createTORequest(TORequest request, String comment) throws Exception {
<span class="nc" id="L209">		return getTORequestManager().createRequest(request, comment);</span>
	}

	/**
	 * Update TimeOff Request
	 *
	 * @param request The Request Object to be created
	 * @param comment The Comment associated with the Request
	 */
	public static void updateTORequest(TORequest request, String comment) throws BbmUpdateException, MultiUserException,
			BbmCreateException, RmHardValidationException, RemoteException {
<span class="nc" id="L220">		getTORequestManager().updateRequest(request, comment);</span>
<span class="nc" id="L221">	}</span>

	/**
	 * Return Time Off Request for specified ID
	 *
	 * @param requestID The Time Off Request ID
	 */
	public static TORequest getTORequest(ID requestID) throws
			BbmFinderException, BbmCreateException, RemoteException, RmHardValidationException {
<span class="nc" id="L230">		return (TORequest)getTORequestManager().getRequestByID(requestID, true, true,</span>
				TORequest.DL_AUDIT_TRAIL |
				TORequest.DL_TIMEOFF_CHOICES |
				TORequest.DL_TIMEOFF_CHOICES_LENGTH |
                TORequest.DL_TIMEOFF_WAITLIST |
                TORequest.DL_TIMEOFF_WITHDRAW);
	}

	public static TORequest getTORequest(ID requestID, boolean incExpired, boolean runSoftValids, long detailLevel)
			throws BbmFinderException, BbmCreateException, RemoteException, RmHardValidationException {
<span class="nc" id="L240">		return (TORequest) getTORequestManager().getRequestByID(requestID, incExpired, runSoftValids, detailLevel);</span>
	}

	/**
	 * Get the waitlist rank of a given TORequest
	 *
	 * @return a string like &quot;3/5&quot;
	 */
	public static String getWaitlistRank(ID toReqID) {
<span class="nc" id="L249">		String result = &quot;/&quot;;</span>
		try {
<span class="nc" id="L251">			int[] rank = m_managerFactory.getTOWaitlistManager().getWaitlistRank(toReqID);</span>
<span class="nc" id="L252">			result = rank[0] + result + rank[1];</span>
<span class="nc" id="L253">		} catch (Exception e) {</span>
<span class="nc" id="L254">		}</span>
<span class="nc" id="L255">		return result;</span>
	}

	/**
	 * Get the waitlist rank of a given TORequest. The first element is the rank. The second is the total number of waitlisted requests
	 * for the range of the request.
	 *
	 * @throws RemoteException
	 * @throws BbmCreateException
	 */
	public static int[] getWaitlistRankByID(ID toReqID) throws BbmCreateException, RemoteException {
<span class="nc" id="L266">		return m_managerFactory.getTOWaitlistManager().getWaitlistRank(toReqID);</span>
	}

	/**
	 * Return Time Off Type Map
	 */
	public static Map getTimeOffTypeMap(RequestContext context, ID empID) throws RemoteException, BbmException {
<span class="nc" id="L273">		Collection toTypeList = getTimeOffTypesForEmployee(context, empID);</span>
<span class="nc" id="L274">		Map toTypeMap = new HashMap();</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">		for (Iterator it = toTypeList.iterator(); it.hasNext();) {</span>
<span class="nc" id="L276">			Activity activity = (Activity) it.next();</span>
<span class="nc" id="L277">			toTypeMap.put(activity.getID(), activity.getName());</span>
<span class="nc" id="L278">		}</span>
<span class="nc" id="L279">		return toTypeMap;</span>
	}

	/**
	 * Return All Postings For a Employee
	 */
	public static Collection getRequestsByEmployee(ID empID, boolean incExpired)
		throws RemoteException, BbmException, RmHardValidationException {
<span class="nc" id="L287">		return getTORequestManager().getRequestsByEmployee(empID, incExpired, true,</span>
				TORequest.DL_AUDIT_TRAIL |
				TORequest.DL_TIMEOFF_CHOICES|
				TORequest.DL_TIMEOFF_CHOICES_LENGTH|
                TORequest.DL_TIMEOFF_WAITLIST |
                TORequest.DL_TIMEOFF_WITHDRAW);
	}

	/**
	 * Return Data for My Time Off Request Page
	 */
	public static Map getMyTimeOffRequestData(RequestContext context, ID empID, boolean incExpired) throws RemoteException, BbmException,
			BbmFinderException, BbmEJBCreateException, RmHardValidationException {
<span class="nc" id="L300">		HashMap map = new HashMap();</span>

		// Request Information
<span class="nc" id="L303">		Collection requestList = getRequestsByEmployee(empID, incExpired);</span>
<span class="nc" id="L304">		map.put(RmKeys.DATA_MY_TO_REQUESTS, requestList);</span>

		// Time Off Type Map
<span class="nc" id="L307">		Map toTypeMap = getTimeOffTypeMap(context, empID);</span>
<span class="nc" id="L308">		map.put(RmKeys.DATA_MY_TO_TYPES, toTypeMap);</span>

		// Information for Time Off Calendar
<span class="nc" id="L311">		OrganizationSetting orgSetting = getOrgSettingForEmployee(context, empID);</span>
<span class="nc" id="L312">		map.put(RmKeys.DATA_MY_TO_ORG_SETTING, orgSetting);</span>

<span class="nc" id="L314">		return map;</span>
	}

	/**
	 * Return Agents Emp Name that have Scheduled Time Off for the specified
	 * Org and Date
	 */
	public static Collection getEmpNamesForTOHour(ID managerID, ID orgID, ID toPoolID, Date date, String hourType) throws RemoteException,
			BbmException {
<span class="nc" id="L323">		Collection result = Collections.emptyList();</span>

<span class="nc bnc" id="L325" title="All 2 branches missed.">		if (RmKeys.SCHEDULED_TO_TYPE.equals(hourType)) {</span>
<span class="nc" id="L326">			result = getTORequestManager().getEmpNamesForScheduledTO(managerID, orgID, toPoolID, date);</span>
		}
		//else if (RmKeys.HOURS_PENDING_TYPE.equals(hourType))
		//{
		//	result = getTORequestManager().getEmployeeNamesForPendingTO(null, orgID,toPoolID, date);
		//}

<span class="nc" id="L333">		return result;</span>
	}

	/**
	 * Return Time Off Detail Calendar Data in the specified time range for specified Employee
	 */
	public static List getTOCalendarDataForEmployee(ID empID, Date startDate, Date endDate, boolean isTOPoolView,
			Organization currentEmpOrg, ID timeoffPoolID, ID activityID) throws RemoteException, BbmException {
<span class="nc" id="L341">		TOCalendarDayData[] toDayData = getTORequestManager().getTOCalendarDetailData(empID, startDate, endDate, isTOPoolView,</span>
				currentEmpOrg, timeoffPoolID, activityID);
<span class="nc bnc" id="L343" title="All 2 branches missed.">		return toDayData!=null? Arrays.asList(toDayData): Collections.emptyList();</span>
	}


	/**
	 * Gets the time off interval calendar for the employee. See getTOCalendarDetailData.
	 *
	 * @param empID
	 *            The employee's ID.
	 * @param startDate
	 *            The start of the range.
	 * @param endDate
	 *            The exclusive end of the range.
	 * @param timeZone
	 *            The viewing time zone.
	 * @param isTOPoolView
	 *            True if we are viewing the time off pool. Otherwise, only the employee's
	 *            data will be returned
	 *@param TOPoolID
	 *				ID of pool of interest. If null, we get the employee's default pool.
	 *
	 * @return
	 * @throws BbmFinderException
	 * @throws RemoteException
	 */
	public static TOIntervalCalendar getTOIntervalCalendarForEmp(ID empID, Date startDate, Date endDate, TimeZone timeZone,
			boolean isTOPoolView, ID TOPoolID, ID activityID) throws BbmFinderException, BbmCreateException, RemoteException {
<span class="nc" id="L370">		return getTORequestManager().getTOIntervalCalendarForEmp(empID, startDate, endDate, timeZone, isTOPoolView, TOPoolID, activityID);</span>
	}

	/**
	 * Return Time Off Detail Calendar Data in the specified time range for specified Employee
	 */
	public static List getTOCalendarDataForManager(ID empID, ID orgID, ID pTOPoolID, Date startDate, Date endDate) throws RemoteException,
			BbmException {
<span class="nc" id="L378">		TOCalendarDayData[] toDayData = getTORequestManager()</span>
<span class="nc" id="L379">				.getTOCalendarDetailDataForManager(empID, orgID, pTOPoolID, startDate, endDate);</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">		return toDayData!=null? Arrays.asList(toDayData): Collections.emptyList();</span>
	}

	/**
	 * Gets the time off interval calendar for a manager. See getTOCalendarDetailDataForManager.
	 *
	 * @param orgID
	 *            The selected organization's ID.
	 * @param pTOPoolID
	 *            The time off pool's ID to view. Null will return the organization's TOIC.
	 * @param startDate
	 *            The start of the range.
	 * @param endDate
	 *            The exclusive end of the range.
	 * @return
	 * @throws BbmFinderException
	 * @throws RemoteException
	 */
	public static TOIntervalCalendar getTOIntervalCalendarForManager(ID orgID, ID pTOPoolID, Date startDate, Date endDate)
			throws BbmFinderException, BbmCreateException, RemoteException {
<span class="nc" id="L400">		return getTORequestManager().getTOIntervalCalendarForManager(orgID, pTOPoolID, startDate, endDate);</span>
	}



	/**
	 * Return Time Off Detail Data
	 */
	public static TODetailData getTODetailData(RequestContext context, ID empID, TORequest request, boolean isFromNetStaffingRibbon)
			throws Exception {
		// TimeOff Request details
<span class="nc" id="L411">		return getTimeOffOrFlexDetailData(context, empID, request, isFromNetStaffingRibbon, ActivityProperties.TIME_OFF_TIME);</span>
	}

	/**
	 * @param context
	 * @param empID
	 * @param request
	 * @param isFromNetStaffingRibbon
	 * @param flexType
	 * @return
	 * @throws RemoteException
	 * @throws BbmException
	 * @throws BbmFinderException
	 * @throws BbmCreateException
	 * @throws Exception
	 */
	public static TODetailData getTimeOffOrFlexDetailData(RequestContext context, ID empID, TORequest request,
			boolean isFromNetStaffingRibbon, int flexType) throws RemoteException, BbmException, BbmFinderException, BbmCreateException,
			Exception {
<span class="nc" id="L430">		ID orgID = getEmpOrgID(context, empID);</span>
<span class="nc" id="L431">		Collection toTypeList = getTimeOffTypes(orgID, isFromNetStaffingRibbon, context, flexType);</span>
<span class="nc" id="L432">		OrganizationSetting orgSetting = getOrgSetting(orgID);</span>
<span class="nc" id="L433">		TOPool pool = getEmpPool(empID, TOPoolUtil.getRequestActivityForTOPool(request));</span>

<span class="nc" id="L435">		return new TODetailData(empID, request, toTypeList, orgSetting, pool, Collections.emptyList());</span>
	}

	/**
	 * Return TimeOff Types for the specified Organization ID. If isFromNetStaffingRibbon, we get only VTO.
	 *
	 * @param orgID The Organization ID
	 * @param flexType - to identify if it's a flex or Time Off request
	 * @return Collection of ActivityType
	 */
	private static Collection&lt;Activity&gt; getTimeOffTypes(ID orgID, boolean isFromNetStaffingRibbon, RequestContext context, int flexFlag)
			throws BbmFinderException, BbmCreateException, RemoteException, BbmException {
<span class="nc" id="L447">		return getTORequestManager().getTimeOffTypes(orgID, flexFlag);</span>
	}

	/**
	 * Return Time Off Detail Data For Manager
	 */
	public static TODetailData getTODetailDataForManager(RequestContext context, User user, ID empID, boolean isNewRequest,
			TORequest request, boolean isFromNetStaffingRibbon) throws RemoteException, BbmException, FacadeException,
			RmHardValidationException {
<span class="nc" id="L456">		return getTimeOffOrFlexDetailDataForManager(context, user, empID, isNewRequest, request, isFromNetStaffingRibbon,</span>
				ActivityProperties.TIME_OFF_TIME);
	}

	/**
	 * Return either Time Off or flex Detail Data For Manager based on the flexType
	 * @param context
	 * @param user
	 * @param empID
	 * @param isNewRequest
	 * @param request
	 * @param isFromNetStaffingRibbon
	 * @param flexType
	 * @return TODetailData
	 * @throws RemoteException
	 * @throws BbmException
	 * @throws FacadeException
	 * @throws RmHardValidationException
	 */
	public static TODetailData getTimeOffOrFlexDetailDataForManager(RequestContext context, User user, ID empID, boolean isNewRequest,
			TORequest request, boolean isFromNetStaffingRibbon, int flexType) throws RemoteException, BbmException, FacadeException,
			RmHardValidationException {
		try {
			// @todo: need backend implementation for optimization
<span class="nc bnc" id="L480" title="All 4 branches missed.">			if (empID == null &amp;&amp; request != null) {</span>
<span class="nc" id="L481">				empID = request.getEmployeeID();</span>
			}

<span class="nc" id="L484">			Collection empNameList = Collections.emptyList();</span>
<span class="nc" id="L485">			Collection&lt;ID&gt; orgIDs = Collections.emptyList();</span>
<span class="nc" id="L486">			Collection&lt;Activity&gt; toTypeList =  new ArrayList&lt;Activity&gt;();</span>
<span class="nc" id="L487">			Map&lt;ID, Activity&gt; mapIDActivity = new HashMap&lt;ID, Activity&gt;();</span>

<span class="nc bnc" id="L489" title="All 2 branches missed.">			if (isNewRequest) {</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">				if (TORequest.FLEXTYPE_FLEXWITHMAKEUP == flexType) {</span>
<span class="nc" id="L491">					orgIDs = user.getAuthorizedScopes(PrivilegeKeys.FT_MODIFYREQUESTSFOREMPLOYEE, Organization.SCOPE_TYPE);</span>

				} else {
<span class="nc" id="L494">					orgIDs = user.getAuthorizedScopes(PrivilegeKeys.TOM_MODIFYREQUESTSFOREMPLOYEE, Organization.SCOPE_TYPE);</span>
				}

				//QC 197238: Only get organizations have appropriate totype -either flextime or normal time off type
<span class="nc" id="L498">				Set&lt;ID&gt; orgIdsFiltered= new HashSet&lt;ID&gt;();</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">				for(ID orgId:orgIDs){</span>
<span class="nc" id="L500">					Collection&lt;Activity&gt; toTypesPerOrg = getTimeOffTypes(orgId, isFromNetStaffingRibbon, context, flexType);</span>
<span class="nc bnc" id="L501" title="All 4 branches missed.">					if(toTypesPerOrg!=null&amp;&amp;!toTypesPerOrg.isEmpty()){</span>
<span class="nc" id="L502">						orgIdsFiltered.add(orgId);</span>

<span class="nc bnc" id="L504" title="All 2 branches missed.">						for(Activity act : toTypesPerOrg){</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">							if(!toTypeList.contains(act)){</span>
<span class="nc" id="L506">								toTypeList.add(act);</span>
							}

<span class="nc" id="L509">						}</span>
					}
<span class="nc" id="L511">				}</span>


				// then get employees of those organizations
				//End QC197238*/
<span class="nc" id="L516">				empNameList = EmployeeModelHandler.getEmployeeNamesForOrgs(context, orgIdsFiltered, null);</span>

<span class="nc bnc" id="L518" title="All 4 branches missed.">				if (empID == null &amp;&amp; !empNameList.isEmpty()) {</span>
					//Create sorted list
<span class="nc" id="L520">					List sortedENames = new ArrayList(empNameList);</span>
<span class="nc" id="L521">					PersonNameUtil.sort(sortedENames, true, context.getLocaleContext());</span>
<span class="nc" id="L522">					EmployeeName eName = (EmployeeName) sortedENames.iterator().next();</span>
<span class="nc" id="L523">					empID = eName.getID();</span>
				}
<span class="nc" id="L525">			} else {</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">				if (request != null) {</span>
<span class="nc" id="L527">					List ids = new ArrayList(1);</span>
<span class="nc" id="L528">					ids.add(request.getEmployeeID());</span>
<span class="nc" id="L529">					HashMap eNameMap = EmployeeModelHandler.getEmployeeNamesByIDs(context, ids);</span>
<span class="nc" id="L530">					empNameList = eNameMap.values();</span>
				}
			}

<span class="nc bnc" id="L534" title="All 4 branches missed.">			if (isNewRequest &amp;&amp; empNameList.isEmpty()) {</span>
				// No Agents under manager's supervision
<span class="nc" id="L536">				return new TODetailData(empID, request, Collections.emptyList(), null, null, Collections.emptyList());</span>
			} else {
<span class="nc" id="L538">				ID orgID = getEmpOrgID(context, empID);</span>
				//No need to get time off types if it is already found in previous if-new Request
<span class="nc bnc" id="L540" title="All 2 branches missed.">				if(toTypeList.isEmpty()) {</span>
<span class="nc" id="L541">					toTypeList = getTimeOffTypes(orgID, isFromNetStaffingRibbon, context, flexType);</span>
				}
<span class="nc" id="L543">				OrganizationSetting orgSetting = getOrgSetting(orgID);</span>
<span class="nc" id="L544">				TOPool pool = getEmpPool(empID, TOPoolUtil.getRequestActivityForTOPool(request));</span>
<span class="nc" id="L545">				return new TODetailData(empID, request, toTypeList, orgSetting, pool, empNameList);</span>
			}
<span class="nc" id="L547">		} catch (Exception e) {</span>
<span class="nc" id="L548">			return null;</span>
		}
	}

	/**
	 * Return Time Off Type Name
	 */
	public static String getTimeOffTypeName(RequestContext context, TORequest request) throws RemoteException, BbmException {
		// @todo: need backend implementation for optimization

		// Determine Time Off Type Display Name
<span class="nc" id="L559">		ID empID = request.getEmployeeID();</span>
<span class="nc" id="L560">		ID orgID = getEmpOrgID(context, empID);</span>
<span class="nc" id="L561">		Collection toTypeList = getTimeOffTypes(orgID);</span>
<span class="nc" id="L562">		String toTypeName = &quot;&quot;;</span>
<span class="nc" id="L563">		boolean hasAdvancedVTOOptions = false;</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">		for (Iterator it = toTypeList.iterator(); it.hasNext();) {</span>
<span class="nc" id="L565">			Activity activity = (Activity) it.next();</span>
<span class="nc" id="L566">			ID  activityID=activity.getID();</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">			if (request.getTimeOffType().equals(activityID)) {</span>
<span class="nc" id="L568">				toTypeName = activity.getName();</span>
<span class="nc" id="L569">				ActivityProperties activityProperty = ActivityModelHandler.getActivityProperties(context, activityID);</span>
<span class="nc" id="L570">				hasAdvancedVTOOptions= activityProperty.isUseAdvancedVTOOptions();</span>
<span class="nc" id="L571">				break;</span>
			}
<span class="nc" id="L573">		}</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">		if (LicenseUtil.isAdvancedRMLicense()) {</span>
<span class="nc" id="L575">			toTypeName = toTypeName + getAdvanceTimeOffTypeLabel(context, hasAdvancedVTOOptions,</span>
<span class="nc" id="L576">					request.isVTOFullDay(),request.isVTOPartialDay(),request.isVTOLateStart(),request.isVTOEarlyOff(),request.isVTOAnytimeOff());</span>
		}
<span class="nc" id="L578">		return toTypeName;</span>
	}

	public static String getAdvanceTimeOffTypeLabel(RequestContext context,boolean hasAdvancedVTOOptions, boolean isFull, boolean isPartial,
			boolean isLateStart, boolean isEarlyOff, boolean isAnytimeOff ) {
<span class="nc" id="L583">		StringBuilder label = new StringBuilder(100);</span>
<span class="nc" id="L584">		String comma=&quot;, &quot;;</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">		if(hasAdvancedVTOOptions){</span>
<span class="nc" id="L586">			label.append(&quot; (&quot; );</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">			if(isFull){</span>
<span class="nc" id="L588">				label.append(context.getLocalizer().i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_FULLDAY));</span>
<span class="nc bnc" id="L589" title="All 8 branches missed.">				if(isPartial||isLateStart||isEarlyOff||isAnytimeOff){</span>
<span class="nc" id="L590">					label.append(comma);</span>
				}
			}

<span class="nc bnc" id="L594" title="All 2 branches missed.">			if(isPartial){</span>
<span class="nc" id="L595">				label.append(context.getLocalizer().i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_PARTIALDAY));</span>
<span class="nc bnc" id="L596" title="All 6 branches missed.">				if(isLateStart||isEarlyOff||isAnytimeOff){</span>
<span class="nc" id="L597">					label.append(comma);</span>
				}
			}

<span class="nc bnc" id="L601" title="All 2 branches missed.">			if(isLateStart){</span>
<span class="nc" id="L602">				label.append(context.getLocalizer().i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_LATESTART));</span>
<span class="nc bnc" id="L603" title="All 4 branches missed.">				if(isEarlyOff||isAnytimeOff){</span>
<span class="nc" id="L604">					label.append(comma);</span>
				}
			}

<span class="nc bnc" id="L608" title="All 2 branches missed.">			if(isEarlyOff){</span>
<span class="nc" id="L609">				label.append(context.getLocalizer().i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_EARLYOFF));</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">				if(isAnytimeOff){</span>
<span class="nc" id="L611">					label.append(comma);</span>
				}
			}

<span class="nc bnc" id="L615" title="All 2 branches missed.">			if(isAnytimeOff){</span>
<span class="nc" id="L616">				label.append(context.getLocalizer().i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TIMEOFF_ANYTIMEOFF));</span>
			}
<span class="nc" id="L618">			label.append(&quot;)&quot; );</span>
		}
<span class="nc" id="L620">		return label.toString();</span>
	}

	/**
	 * Return Time Off Detail Data
	 */
	public static Collection getTOActivities(ID empID, Date start, Date end) throws RemoteException, BbmException {
<span class="nc" id="L627">		return getTORequestManager().getTOActivities(empID, start, end);</span>
	}

	public static Pair&lt;Boolean, String&gt; addRequestToWaitlist(RequestContext context, ID requestID, String comment, Date expiryDate)
			throws Exception {
		//TODO: check view privilege here to verify it is a manager
<span class="nc" id="L633">		Pair&lt;Boolean, String&gt; pair = new Pair&lt;&gt;(new Boolean(&quot;true&quot;), null);</span>
<span class="nc" id="L634">		boolean isManager = true;</span>
<span class="nc" id="L635">		TORequest request = getTORequest(requestID);</span>
<span class="nc" id="L636">		String oldStatus = request.getRequestStatus();</span>
<span class="nc" id="L637">		getTORequestManager().addRequestTOWaitlist(context.getUser().getID(), request, comment, expiryDate, isManager);</span>
<span class="nc" id="L638">		request = getTORequest(requestID);</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">		if (request.getRequestStatus().equals(oldStatus)) {</span>
<span class="nc" id="L640">			pair = new Pair&lt;&gt;(new Boolean(&quot;false&quot;),</span>
<span class="nc" id="L641">					RequestUtil.getLocalizedMsgInAppDefLocale(RmEjbBundleKey.TIMEOFF_CANNOT_ADD_TO_WAITLIST));</span>
		}
<span class="nc" id="L643">		return pair;</span>
	}

	public static Pair&lt;Boolean, String&gt; acceptWithdrawOfApprovedRequest(RequestContext context, ID requestID, String comment)
			throws Exception {
<span class="nc" id="L648">		TORequest request = getTORequest(requestID);</span>
<span class="nc" id="L649">		Pair&lt;Boolean, String&gt; pair = getTORequestManager().isEligibleForRequestWithdrawOfApprovedRequest(request);</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">		if (pair.getFirst().booleanValue()) {</span>
<span class="nc" id="L651">			getTORequestManager().acceptWithdrawOfApprovedRequest(request, comment);</span>
		}
<span class="nc" id="L653">		return pair;</span>
	}

	public static void rejectWithdrawOfApprovedRequest(RequestContext context, ID requestID, String comment) throws Exception {
<span class="nc" id="L657">		getTORequestManager().rejectWithdrawOfApprovedRequest(getTORequest(requestID), comment);</span>
<span class="nc" id="L658">	}</span>

	public static Pair&lt;Boolean, String&gt; cancelWithdrawOfApprovedRequest(RequestContext context, ID requestID, String comment) throws Exception {
<span class="nc" id="L661">		TORequest request = getTORequest(requestID);</span>
<span class="nc" id="L662">		Pair&lt;Boolean, String&gt; pair = getTORequestManager().isEligibleForRequestWithdrawOfApprovedRequest(request);</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">		if (pair.getFirst().booleanValue()) {</span>
<span class="nc" id="L664">			getTORequestManager().cancelWithdrawOfApprovedRequest(request, comment);</span>
		}
<span class="nc" id="L666">		return pair;</span>
	}

	public static Pair&lt;Boolean, String&gt; requestWithdrawOfApprovedRequest(TORequest request, String requestType,
			 String requestStatus, String comment) throws Exception {
<span class="nc" id="L671">		Pair&lt;Boolean, String&gt; pair = new Pair&lt;Boolean, String&gt;(new Boolean(&quot;true&quot;), &quot;&quot;); //return true by default. false is explicitly set in one scenario only</span>

		//if request is approved then invoke the approved TO Withdraw process
<span class="nc bnc" id="L674" title="All 2 branches missed.">		if (request.getRequestStatus().equals(RequestAuditTrail.STATUS_APPROVED)) {</span>
<span class="nc" id="L675">			pair = getTORequestManager().isEligibleForRequestWithdrawOfApprovedRequest(request);</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">			if (pair.getFirst().booleanValue()) {</span>
<span class="nc" id="L677">				getTORequestManager().requestWithdrawOfApprovedRequest(request, comment);</span>
			}
		} else {
<span class="nc" id="L680">			RequestsMH.changeRequestStatus(request.getID(), requestType, request.getObjectVersionNumber(), requestStatus, comment);</span>
		}
<span class="nc" id="L682">		return pair;</span>
	}
	public static Collection&lt;ID&gt; getActivityIDsfromActivity(Collection&lt;Activity&gt; activities){
<span class="nc" id="L685">		Collection&lt;ID&gt; ids= new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L686" title="All 4 branches missed.">		if(activities!=null&amp;&amp;!activities.isEmpty()) {</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">			for(Activity activity:activities){</span>
<span class="nc" id="L688">				ids.add(activity.getID());</span>
<span class="nc" id="L689">			}</span>
		}
<span class="nc" id="L691">		return ids;</span>
	}
	public static void doValidationsForMultiChoiceTOB(TORequest toRequest) {
		try {
<span class="nc" id="L695">			TORequestManager toManager = m_managerFactory.getTimeOffRequestManager();</span>
<span class="nc" id="L696">			toManager.doValidationsForMultiChoiceTOB(toRequest);</span>
<span class="nc" id="L697">		} catch (Exception e) {</span>
<span class="nc" id="L698">			throw RmRuntimeException.toRuntimeException(e);</span>
<span class="nc" id="L699">		}</span>
<span class="nc" id="L700">	}</span>
	public static RequestAggregate approveTOBChoicesWithoutViolations(ID reqID) throws Exception, RemoteException {
<span class="nc" id="L702">		return getTORequestManager().approveTOBChoicesWithoutViolations(reqID);</span>
	}

	public static RequestAggregate processAllVTORequests(ID reqID) throws Exception, RemoteException {
<span class="nc" id="L706">		return getTORequestManager().processAllVTORequests(reqID);</span>
	}
	/*****************************************************************************
	 * Inner Classes used to package data
	 ****************************************************************************/
<span class="nc" id="L711">	public static class TODetailData {</span>
		private final ID _empID;
		private final TORequest _toRequest;
		private final Collection&lt;Activity&gt; _toTypeList;
		private final OrganizationSetting _orgSetting;
		private final TOPool _pool;
<span class="nc" id="L717">		private Collection&lt;EmployeeName&gt; _empNameList = Collections.emptyList();</span>

		public TODetailData(ID empID, TORequest request, Collection&lt;Activity&gt; toTypeList, OrganizationSetting orgSetting, TOPool pool,
<span class="nc" id="L720">				Collection&lt;EmployeeName&gt; empNameList) {</span>
<span class="nc" id="L721">			_empID = empID;</span>
<span class="nc" id="L722">			_toRequest = request;</span>
<span class="nc" id="L723">			_toTypeList = toTypeList;</span>
<span class="nc" id="L724">			_orgSetting = orgSetting;</span>
<span class="nc" id="L725">			_pool = pool;</span>
<span class="nc" id="L726">			_empNameList = empNameList;</span>
<span class="nc" id="L727">		}</span>

		public ID getEmpID() {
<span class="nc" id="L730">			return _empID;</span>
		}

		public TORequest getTORequest() {
<span class="nc" id="L734">			return _toRequest;</span>
		}

		public Collection&lt;Activity&gt; getTOTypes() {
<span class="nc" id="L738">			return _toTypeList;</span>
		}

		public OrganizationSetting getOrgSetting() {
<span class="nc" id="L742">			return _orgSetting;</span>
		}

		public TOPool getPool() {
<span class="nc" id="L746">			return _pool;</span>
		}

		public Collection&lt;EmployeeName&gt; getEmployeeNames() {
<span class="nc" id="L750">			return _empNameList;</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>