<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AuctionBonusDescriptionListPM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.auction</a> &gt; <span class="el_source">AuctionBonusDescriptionListPM.java</span></div><h1>AuctionBonusDescriptionListPM.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.auction;

import java.util.*;

import javax.servlet.http.HttpServletRequest;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.ejb.bbm.campaign.CampaignScopeManagerProxy;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.model.ShiftBidAuction;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.BiddableScheduleRow;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.organization.tree.OrganizationTreeHelper;
import com.bluepumpkin.web.rm.auction.filter.BidOptionsFilterUtil;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.data.wrapper.BasicWrapper;
import com.witness.web.uif.data.wrapper.NumberWrapper;
import com.witness.web.uif.keys.UserPreferenceKeys;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.form.FormInputPC;
import com.witness.web.uif.pagecomponent.toolbar.ToolbarUtil;
import com.witness.web.uif.pagemodel.WorkpaneListPM;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.js.JSUtil;

/**
 * Title:        AuctionBonusListPM
 * Description:  Base Class for Auction List with Bonus Input
 * Copyright:    Copyright (c) 2003
 * Company:      Blue Pumpkin Software, Inc
 * @author       David Su, DSu
 * @version      1.0
 *
 * Created on Aug 7, 2003, 10:16:13 AM
 */
public abstract class AuctionBonusDescriptionListPM extends WorkpaneListPM implements AuctionPM {
	protected static final String BONUS_PREFIX_FN = &quot;bonusPF&quot;;
	protected static final String DESCRIPTION_PREFIX_FN = &quot;descriptionPF&quot;;
	protected static final String ORG_ID_FN = &quot;orgID&quot;;

	protected ResourceBundle bundle;
	protected FormInputPC formInputPC;
	protected FormInputPC descFormInputPC;
	protected TimeZone tz;
	protected String pageTitleRBKey;

	//This is the selected organization ID from the drop-down organization selector. 
	//The selector only shows up if the SP associated to the auction is linked to more than one organizations. 
	protected ID orgID;
<span class="nc" id="L55">	protected boolean isPageEnabled = true;</span>
<span class="nc" id="L56">	protected boolean hasRMAdvanceLicense = false;</span>
	protected ShiftBidAuction auction;
<span class="nc" id="L58">	protected Collection&lt;BiddableScheduleRow&gt; listData = Collections.emptyList();</span>
<span class="nc" id="L59">	protected Collection&lt;Organization&gt; orgList = Collections.emptyList();</span>

<span class="nc" id="L61">	protected Map&lt;ID, String&gt; bonusMap = Collections.emptyMap();</span>
<span class="nc" id="L62">	protected Map&lt;ID, String&gt; descriptionMap = Collections.emptyMap();</span>

	/**
	 * Constructor
	 */
	public AuctionBonusDescriptionListPM(RequestContext context, String formAction, String pageTitleRBKey) {
<span class="nc" id="L68">		super(context, FRAMED_MODEL);</span>
<span class="nc" id="L69">		setFormAction(formAction);</span>
<span class="nc" id="L70">		m_list.setIsZebra(true);</span>
<span class="nc" id="L71">		this.pageTitleRBKey = pageTitleRBKey;</span>
<span class="nc" id="L72">		tz = m_context.getViewingTimeZone();</span>
<span class="nc" id="L73">		bundle = m_localizer.getBundle(RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L74">		setIsAutoSortEnabled(true);</span>

<span class="nc" id="L76">		hasRMAdvanceLicense = LicenseUtil.isAdvancedRMLicense();</span>

<span class="nc" id="L78">		formInputPC = new FormInputPC(context);</span>
<span class="nc" id="L79">		descFormInputPC = new FormInputPC(context);</span>
<span class="nc" id="L80">		addChildComponent(formInputPC);</span>
<span class="nc" id="L81">		addChildComponent(descFormInputPC);</span>
<span class="nc" id="L82">	}</span>

	/**
	 * Add Select Auction Message
	 */
	protected void addSelectAuctionMsg() {
<span class="nc" id="L88">		addPageMessage(Message.RESPONSE_TYPE, RmWebBundleKey.SELECT_AUCTION_MSG,</span>
				RmWebBundleKey.BUNDLE_NAME);
<span class="nc" id="L90">	}</span>

	/**
	 * Return Bonus Map
	 */
	public Map&lt;ID, String&gt; getBonusMap() {
<span class="nc" id="L96">		return bonusMap;</span>
	}

	public Map&lt;ID, String&gt; getDescriptionMap() {
<span class="nc" id="L100">		return descriptionMap;</span>
	}

	public boolean isAdvancedRMLicense() {
<span class="nc" id="L104">		return hasRMAdvanceLicense;</span>
	}

	@Override
	public void setIsPageEnabled(boolean bValue) {
<span class="nc" id="L109">		isPageEnabled = bValue;</span>
<span class="nc" id="L110">	}</span>

	/**
	 * Set Organization ID
	 */
	public void setOrgID(ID id) {
<span class="nc" id="L116">		orgID = id;</span>
<span class="nc" id="L117">	}</span>

	/**
	 * Retrieve request parameters from request object to the page model object.
	 */
	@Override
	public boolean extractParameters(HttpServletRequest request) {
<span class="nc" id="L124">		boolean success = super.extractParameters(request);</span>

<span class="nc" id="L126">		bonusMap = FormInputPC.extractIDKeyParamMap(request, BONUS_PREFIX_FN);</span>
<span class="nc" id="L127">		descriptionMap = FormInputPC.extractIDKeyParamMap(request, DESCRIPTION_PREFIX_FN);</span>

<span class="nc" id="L129">		return success;</span>
	}

	/**
	 * Initialize Content Title
	 */
	@Override
	protected void initContentTitle() {
<span class="nc" id="L137">		String pageTitle = i18n(bundle, pageTitleRBKey);</span>
<span class="nc" id="L138">		m_contentTitlePC.setPageTitle(pageTitle);</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">		if (auction == null) {</span>
<span class="nc" id="L140">			return;</span>
		}

<span class="nc" id="L143">		String name = auction.getName();</span>
<span class="nc" id="L144">		AuctionUtil.initContentTitle(m_context, isPageEnabled, name, null, m_contentTitlePC, null);</span>

		// Add Organization Selector
<span class="nc bnc" id="L147" title="All 4 branches missed.">		if (orgList.size() &gt; 1 &amp;&amp; isPageEnabled) {</span>
<span class="nc" id="L148">			String lbl = i18n(m_common_bundle, UIFWebBundleKey.FROM);</span>
<span class="nc" id="L149">			String orgSelector = getOrgSelector();</span>
<span class="nc" id="L150">			m_contentTitlePC.addActiveComponent(lbl, orgSelector, true);</span>
		}
<span class="nc" id="L152">	}</span>

	/**
	 * Initialize Toolbar
	 */
	@Override
	protected void initToolbar() {
<span class="nc bnc" id="L159" title="All 4 branches missed.">		boolean isEditable = isEditActionEnabled() &amp;&amp; hasEditableField();</span>

<span class="nc" id="L161">		ToolbarUtil.addValidateSaveBtn(m_toolbar, isEditable);</span>
<span class="nc" id="L162">		ToolbarUtil.addResetBtn(m_toolbar, isEditable);</span>

<span class="nc" id="L164">		enableToolbarPagination();</span>
<span class="nc" id="L165">	}</span>

	//////////////////////////////////////////////////////////////////////////////
	// Helper Methods
	//////////////////////////////////////////////////////////////////////////////
	protected String getOrgSelector() {
<span class="nc bnc" id="L171" title="All 2 branches missed.">		String selectedVal = (orgID != null) ? orgID.toString() : null;</span>

<span class="nc" id="L173">		ArrayList options = new ArrayList(orgList.size() + 1);</span>
<span class="nc" id="L174">		options.add(new StringsPair(&quot;&quot;, i18n(m_common_bundle, UIFWebBundleKey.ALL)));</span>

<span class="nc" id="L176">		Collection tmpList = null;</span>

		// Get user preference whether the org list should be indented or not.
<span class="nc" id="L179">		boolean isOrgListHierarchical = &quot;true&quot;.equals(</span>
<span class="nc" id="L180">				m_context.getUserProperty(UserPreferenceKeys.USER_SHOW_ORG_LIST_HIERARCHICAL));</span>

<span class="nc bnc" id="L182" title="All 2 branches missed.">		if (isOrgListHierarchical) {</span>
			// Hierarchical or indented org list
<span class="nc" id="L184">			tmpList = OrganizationTreeHelper.createIndentedOrgNameList(orgList, m_localizer);</span>
		} else {
			// Straight list of organization (not indented) in user's scope
<span class="nc" id="L187">			tmpList = OrganizationTreeHelper.createOrgNameList(orgList, m_localizer);</span>
		}

<span class="nc" id="L190">		options.addAll(tmpList);</span>

<span class="nc" id="L192">		return HtmlUtil.makeSelectInput(ORG_ID_FN, selectedVal, JSUtil.REFRESH_PAGE, options);</span>
	}

	/**
	 * Get the list of organizations to appear in the organizations dropdown selector in the page title area.
	 * These are the organizations tied to the auction's scheduling period
	 * @param context
	 * @return - a collection of orgs in the auction. If the user preference for viewing orgs
	 * 		     in hierarchical order is set, then we will also get the ancestor orgs so they appear in a 
	 * 		     hierarchy. 
	 * @throws Exception
	 */
	public static Collection&lt;Organization&gt; getOrgList(RequestContext context, ShiftBidAuction auction) throws Exception {
		// Get user preference whether the org list should be indented or not.
<span class="nc" id="L206">		boolean isOrgListHierarchical = &quot;true&quot;.equals(</span>
<span class="nc" id="L207">				context.getUserProperty(UserPreferenceKeys.USER_SHOW_ORG_LIST_HIERARCHICAL));</span>

		//Get Organization ID's linked to the auction's SP
<span class="nc" id="L210">		Collection&lt;ID&gt; auctionFilteredOrgIDs = null;</span>
<span class="nc" id="L211">		Collection&lt;ID&gt; auctionOrgIDs = BidOptionsFilterUtil.getOrgIDs(context, auction);</span>
<span class="nc bnc" id="L212" title="All 4 branches missed.">		if (LicenseUtil.isAdvancedRMLicense() &amp;&amp; auction.getIsFullPeriodSchedule()) {</span>
<span class="nc" id="L213">			auctionFilteredOrgIDs = BidOptionsFilterUtil.getFilteredOrgIDs(context, auction, auctionOrgIDs);</span>
		} else {
<span class="nc" id="L215">			auctionFilteredOrgIDs = auctionOrgIDs;</span>
		}
<span class="nc" id="L217">		Collection&lt;Organization&gt; auctionOrgs = OrganizationModelHandler.getOrganizationsByIDs(context, auctionFilteredOrgIDs);</span>

<span class="nc bnc" id="L219" title="All 2 branches missed.">		if (isOrgListHierarchical) {</span>
<span class="nc" id="L220">			HashSet&lt;Organization&gt; allOrgs = null;</span>
			
			// Hierarchical or indented org list
<span class="nc bnc" id="L223" title="All 4 branches missed.">			if (auction.getOrganizationId() == 0 &amp;&amp; auctionFilteredOrgIDs.size() == auctionOrgIDs.size()) {</span>
<span class="nc" id="L224">				Collection&lt;Organization&gt; parentOrgs = OrganizationModelHandler.getOrganizationsParentsByIDsExceptSystem(context,</span>
						auctionOrgIDs);
<span class="nc" id="L226">				allOrgs = new HashSet(auctionOrgs.size() + parentOrgs.size());</span>
<span class="nc" id="L227">				allOrgs.addAll(parentOrgs);</span>
<span class="nc" id="L228">			} else { </span>
<span class="nc" id="L229">				allOrgs = new HashSet&lt;Organization&gt;(auctionOrgs.size());</span>
			}
<span class="nc" id="L231">			allOrgs.addAll(auctionOrgs);</span>
<span class="nc" id="L232">			return allOrgs;</span>
		} else {
			// Straight list of organization (not indented) in the auction
<span class="nc" id="L235">			return auctionOrgs;</span>
		}
	}

	/**
	 * Create Bonus UI
	 */
	protected NumberWrapper getBonusUI(String rowID, int bonus, boolean isEditable) {
<span class="nc" id="L243">		String sBonus = &quot;&quot;;</span>

<span class="nc bnc" id="L245" title="All 2 branches missed.">		if (isEditable) {</span>
<span class="nc" id="L246">			String fn = BONUS_PREFIX_FN + rowID;</span>
<span class="nc" id="L247">			formInputPC.reset();</span>
<span class="nc" id="L248">			formInputPC.setSize(5);</span>
<span class="nc" id="L249">			formInputPC.setInputFieldDesc(UIFWebBundleKey.BONUS, UIFWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L250">			formInputPC.setInputType(FormInputPC.TYPE_INTEGER);</span>
<span class="nc" id="L251">			formInputPC.setInputValue(String.valueOf(bonus));</span>
<span class="nc" id="L252">			formInputPC.setLowerLimit(0);</span>
<span class="nc" id="L253">			formInputPC.setInputFN(fn);</span>
<span class="nc" id="L254">			formInputPC.initForDisplay();</span>
<span class="nc" id="L255">			sBonus = formInputPC.getHtmlDisplay();</span>
<span class="nc" id="L256">		} else {</span>
<span class="nc" id="L257">			sBonus = AuctionUtil.columnCellFormatForAlignment(AuctionUtil.COLUMN_CELL_ALIGNMENT, m_localizer.formatNumber(bonus));</span>
		}
<span class="nc" id="L259">		return new NumberWrapper(bonus, sBonus);</span>
	}

	/**
	 * Create Description UI
	 */
	protected BasicWrapper getDescriptionUI(String rowID, String description, boolean isEditable) {
<span class="nc" id="L266">		String sDescription = &quot;&quot;;</span>

<span class="nc bnc" id="L268" title="All 2 branches missed.">		if (isEditable) {</span>
<span class="nc" id="L269">			String fn = DESCRIPTION_PREFIX_FN + rowID;</span>
<span class="nc" id="L270">			descFormInputPC.reset();</span>
<span class="nc" id="L271">			descFormInputPC.setInputFieldDesc(UIFWebBundleKey.DESCRIPTION, UIFWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L272">			descFormInputPC.setInputType(FormInputPC.TYPE_STRING);</span>
<span class="nc" id="L273">			descFormInputPC.setInputValue(description);</span>
<span class="nc" id="L274">			descFormInputPC.setMaxLength(50);</span>
<span class="nc" id="L275">			descFormInputPC.setInputFN(fn);</span>
<span class="nc" id="L276">			descFormInputPC.initForDisplay();</span>
<span class="nc" id="L277">			sDescription = descFormInputPC.getHtmlDisplay();</span>
<span class="nc" id="L278">		} else {</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">			String desc = description == null ? &quot;&quot; : description;</span>
<span class="nc" id="L280">			sDescription =  AuctionUtil.columnCellFormatForAlignment(AuctionUtil.COLUMN_CELL_ALIGNMENT, desc);</span>
		}

<span class="nc" id="L283">		return new BasicWrapper(description, sDescription);</span>
	}

	/**
	 * is the edit action enabled?
	 */
	@Override
	protected boolean isEditActionEnabled() {
<span class="nc bnc" id="L291" title="All 2 branches missed.">		if (auction == null) {</span>
<span class="nc" id="L292">			return false;</span>
		}
<span class="nc" id="L294">		ID camID = auction.getOptMethods().getCampaign().getID();</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">		return !listData.isEmpty() &amp;&amp;</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">				m_context.getUser().isAuthorized(PrivilegeKeys.SB_MODIFYAUCTIONS, CampaignScopeManagerProxy.getScopeID(camID));</span>
	}

	/**
	 * Return true to indicate that Page has editable fields
	 */
	protected abstract boolean hasEditableField();
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>