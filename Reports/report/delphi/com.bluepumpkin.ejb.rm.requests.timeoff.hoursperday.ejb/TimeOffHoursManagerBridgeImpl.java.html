<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffHoursManagerBridgeImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.ejb</a> &gt; <span class="el_source">TimeOffHoursManagerBridgeImpl.java</span></div><h1>TimeOffHoursManagerBridgeImpl.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.ejb;

import java.rmi.RemoteException;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.BbmEJBCreateException;
import com.bluepumpkin.ejb.bbm.BbmManagerFactory;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmObjectNotFoundException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.schedule.model.ScheduleChangeDetails;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.schedule.model.TimeOffEvent;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.DailyHoursBuckets;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TONotifyMessage;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TimeOffHoursManagerBridge;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.RmManagerFactory;
import com.bluepumpkin.ejb.rm.requests.timeoff.ejb.TORequestManager;
import com.bluepumpkin.ejb.rm.requests.timeoff.hoursperday.model.TOHoursPerDay;
import com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.TimeOffIntervalAllocationUtil;
import com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.ejb.TimeOffIntervalNotificationHandler;
import com.bluepumpkin.ejb.rm.setup.settings.ejb.OrganizationConfigManager;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.verint.ejb.wfm.WfmManagerFactory;


<span class="nc" id="L40">public class TimeOffHoursManagerBridgeImpl implements TimeOffHoursManagerBridge {</span>

<span class="nc" id="L42">	private static final Category LOG = Log.initCategory(TimeOffHoursManagerBridgeImpl.class.getName());</span>

	public DailyHoursBuckets getDailyHoursBucketsForDateRange(ID employeeID,
			TimeOffEvent timeOffEvent, Organization org, Date toPeriodStart,
			Date toPeriodEnd) throws BbmCreateException, BbmFinderException, RemoteException {
<span class="nc" id="L47">		TOHoursPerDayManager toHoursManager = RmManagerFactory.getInstance().getTOHoursPerDayManager();</span>
<span class="nc" id="L48">		TOHoursPerDay hoursPerDay = toHoursManager.getTOHoursPerDaysForTOEvent(employeeID, timeOffEvent);</span>
<span class="nc" id="L49">		return TOHoursPerDayUtil.getDailyHoursBucketsForDateRange(org, hoursPerDay, toPeriodStart, toPeriodEnd);</span>
	}

	public void onTONotifyMessage(TONotifyMessage msg) throws BbmUpdateException, BbmFinderException, RemoteException, BbmCreateException {//NOSONAR
<span class="nc" id="L53">		TOHoursPerDayManager toHoursManager = RmManagerFactory.getInstance().getTOHoursPerDayManager();</span>
<span class="nc" id="L54">		toHoursManager.updateTOHoursPerDay(msg);</span>
		
<span class="nc" id="L56">		TimeOffIntervalNotificationHandler intervalHandler = new TimeOffIntervalNotificationHandler(toHoursManager);</span>
<span class="nc" id="L57">		intervalHandler.onTONotifyMessage(msg);</span>
<span class="nc" id="L58">	}</span>

	public void onSynchronizeScheduleChange(ScheduleChangeDetails changeDetails) throws RemoteException, BbmException, BbmCreateException {//NOSONAR
		
<span class="nc" id="L62">		TOHoursPerDayManager toHoursManager = RmManagerFactory.getInstance().getTOHoursPerDayManager();</span>
<span class="nc" id="L63">		toHoursManager.updateHoursPerDay(changeDetails);</span>
		
<span class="nc" id="L65">		TimeOffIntervalNotificationHandler intervalHandler = new TimeOffIntervalNotificationHandler(toHoursManager);</span>
<span class="nc" id="L66">		intervalHandler.onScheduleChange(changeDetails);</span>
<span class="nc" id="L67">	}</span>

	public Collection dumpTOReportDataWithResult(Collection colEmployeeIDs, int threadID, int lookBack, int lookForward, Date start, Date end) throws BbmUpdateException, RemoteException {
<span class="nc" id="L70">		Collection failed = null;</span>
		try {
<span class="nc" id="L72">			TORequestManager torManager = RmManagerFactory.getInstance(true).getTimeOffRequestManager();</span>
<span class="nc" id="L73">			failed = torManager.dumpTOReportDataWithResult(colEmployeeIDs, threadID, lookBack, lookForward, start, end);</span>
<span class="nc" id="L74">		} catch (Exception e) {</span>
<span class="nc" id="L75">			LOG.error(e.getMessage(), e);</span>
<span class="nc" id="L76">		}</span>
<span class="nc" id="L77">		return failed;</span>
	}
	
	// max duration and max tolerance override start
	/*
	 Fully-Overridable (the entire activity can be overridden):
		Vacation (may not be needed afterall. This is an open issue)
		
	Partially-Overridable (only two attributes can be overridden per activity):
		No Activity
		Unknown Activity
		Shift/Overtime Gap
		Voluntary Time Off
		Learning
		Coaching
		
		note: Unknown: Tolerance=n/a
		note: No Activity: MaxTime=n/a
	 */
<span class="nc" id="L96">	private static int DEFAULT_OVERRIDE_NOTFOUND = -2; //-1 MEANS UNLIMITED HERE </span>
<span class="nc" id="L97">	public static ID[] specialActivityIDs = new ID[6];</span>
    static {
<span class="nc" id="L99">          specialActivityIDs[0] = Activity.ACTIVITY_NONE;</span>
<span class="nc" id="L100">          specialActivityIDs[1] = Activity.ACTIVITY_UNKNOWN;</span>
<span class="nc" id="L101">          specialActivityIDs[2] = Activity.ACTIVITY_SHIFT_OVERTIME_GAP;          </span>
<span class="nc" id="L102">          specialActivityIDs[3] = Activity.ACTIVITY_VOLUNTARY_TIMEOFF;</span>
<span class="nc" id="L103">          specialActivityIDs[4] = Activity.ACTIVITY_LEARNING_BREAK;</span>
<span class="nc" id="L104">          specialActivityIDs[5] = Activity.ACTIVITY_COACHING;</span>
<span class="nc" id="L105">    }     </span>
	
	public int getMaxDurationOverride(ID orgID, ID activityID) throws BbmFinderException, RemoteException {
<span class="nc" id="L108">		int maxDuration = 0;</span>
		try {
<span class="nc" id="L110">			maxDuration = getActivityByID(activityID).getMaxDurationThreshold(); //default value</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">			if (activityID.equals(Activity.ACTIVITY_NONE))</span>
<span class="nc" id="L112">				return maxDuration; //No Activity: MaxTime=n/a, no override supported</span>
<span class="nc" id="L113">			int override = getActivityOverride(orgID, activityID, Activity.getMaxDurationOverrideKey(activityID));</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">			if (override != DEFAULT_OVERRIDE_NOTFOUND)</span>
<span class="nc" id="L115">				maxDuration = override;</span>
<span class="nc" id="L116">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L117">			throw e;</span>
<span class="nc" id="L118">		} catch (Exception e) {</span>
<span class="nc" id="L119">			throw new BbmFinderException(e);</span>
<span class="nc" id="L120">		}</span>
<span class="nc" id="L121">		return maxDuration;</span>
	}
	
	public void setMaxDurationOverride(ID orgID, ID activityID, int value) throws BbmUpdateException, RemoteException {
		try {
<span class="nc" id="L126">			setActivityOverride(orgID, activityID, Activity.getMaxDurationOverrideKey(activityID), value);</span>
<span class="nc" id="L127">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L128">			throw e;</span>
<span class="nc" id="L129">		} catch (Exception e) {</span>
<span class="nc" id="L130">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L131">		}</span>
<span class="nc" id="L132">	}</span>
	
	public int getAdherenceToleranceOverride(ID orgID, ID activityID) throws BbmFinderException, RemoteException {
<span class="nc" id="L135">		int adherenceTolerance = 0;</span>
		try {
<span class="nc" id="L137">			adherenceTolerance = getActivityByID(activityID).getAdherenceTolerance(); //default value</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">			if (activityID.equals(Activity.ACTIVITY_UNKNOWN))</span>
<span class="nc" id="L139">				return adherenceTolerance; //Unknown: Tolerance=n/a, no override supported</span>
<span class="nc" id="L140">			int override = getActivityOverride(orgID, activityID, Activity.getAdherenceToleranceOverrideKey(activityID));</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">			if (override != DEFAULT_OVERRIDE_NOTFOUND)</span>
<span class="nc" id="L142">				adherenceTolerance = override;</span>
<span class="nc" id="L143">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L144">			throw e;</span>
<span class="nc" id="L145">		} catch (Exception e) {</span>
<span class="nc" id="L146">			throw new BbmFinderException(e);</span>
<span class="nc" id="L147">		}</span>
<span class="nc" id="L148">		return adherenceTolerance;</span>
	}
	
	public void setAdherenceToleranceOverride(ID orgID, ID activityID, int value) throws BbmUpdateException, RemoteException {
		try {
<span class="nc" id="L153">			setActivityOverride(orgID, activityID, Activity.getAdherenceToleranceOverrideKey(activityID), value);</span>
<span class="nc" id="L154">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L155">			throw e;</span>
<span class="nc" id="L156">		} catch (Exception e) {</span>
<span class="nc" id="L157">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L158">		}</span>
<span class="nc" id="L159">	}</span>
	
	public Activity getVacationOverride(ID orgID) throws BbmFinderException, RemoteException {
<span class="nc" id="L162">		Activity vacation = null;</span>
		try {
<span class="nc" id="L164">			vacation = getActivityByID(Activity.ACTIVITY_VACATION);</span>
<span class="nc" id="L165">			int vacationID = getActivityOverride(orgID, Activity.ACTIVITY_VACATION, Activity.ACTIVITY_VACATION.toString());</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">			if (vacationID != DEFAULT_OVERRIDE_NOTFOUND) //found one</span>
			{
				try
				{
<span class="nc" id="L170">					vacation = getActivityByID(new ID(vacationID));</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">					if (vacation.isDeleted())</span>
					{
<span class="nc" id="L173">						ID parentOrgID = handleDeletedVacationOverride(orgID);</span>
<span class="nc" id="L174">						return getVacationOverride(parentOrgID);</span>
					}
				}
<span class="nc" id="L177">				catch (BbmObjectNotFoundException deletedException)</span>
				{
<span class="nc" id="L179">					LOG.error(deletedException.getMessage(), deletedException);</span>
<span class="nc" id="L180">					ID parentOrgID = handleDeletedVacationOverride(orgID);</span>
<span class="nc" id="L181">					return getVacationOverride(parentOrgID);</span>
<span class="nc" id="L182">				}</span>
			}
<span class="nc" id="L184">		} catch (BbmFinderException e) {</span>
<span class="nc" id="L185">			throw e;</span>
<span class="nc" id="L186">		} catch (Exception e) {</span>
<span class="nc" id="L187">			throw new BbmFinderException(e);</span>
<span class="nc" id="L188">		}</span>
<span class="nc" id="L189">		return vacation;</span>
	}
	
	private ID handleDeletedVacationOverride(ID orgID) throws BbmEJBCreateException, BbmCreateException, BbmFinderException, RemoteException
	{
		//delete mapping from organizationconfig table for this org (clear cache will happen automatically)
<span class="nc" id="L195">		OrganizationConfigManager manager = RmManagerFactory.getInstance().getOrganizationConfigManager();</span>
<span class="nc" id="L196">		HashSet set = new HashSet(1);</span>
<span class="nc" id="L197">		set.add(Activity.ACTIVITY_VACATION.toString());</span>
<span class="nc" id="L198">		manager.deletePropertyList(orgID, set);</span>
		
		//return the parent orgID
<span class="nc" id="L201">		Organization org = BbmManagerFactory.getWorkResourceManager().getOrganizationByID(orgID);</span>
<span class="nc" id="L202">		return org.getParentID();</span>
	}
	
	public void setVacationOverride(ID orgID, ID vacationActivityID) throws BbmUpdateException, RemoteException {
		try {
<span class="nc" id="L207">			setActivityOverride(orgID, Activity.ACTIVITY_VACATION, Activity.ACTIVITY_VACATION, vacationActivityID.toInt()); </span>
<span class="nc" id="L208">		} catch (BbmUpdateException e) {</span>
<span class="nc" id="L209">			throw e;</span>
<span class="nc" id="L210">		} catch (Exception e) {</span>
<span class="nc" id="L211">			throw new BbmUpdateException(e);</span>
<span class="nc" id="L212">		}</span>
<span class="nc" id="L213">	}</span>
	
	private Activity getActivityByID(ID activityID) throws Exception {
<span class="nc" id="L216">		ActivityManager aManager = WfmManagerFactory.getActivityManager();</span>
<span class="nc" id="L217">		return aManager.findActivityById(activityID);</span>
	}
	
	private int getActivityOverride(ID orgID, ID activityID, Object key) throws Exception {
<span class="nc" id="L221">		int override = DEFAULT_OVERRIDE_NOTFOUND;		</span>
<span class="nc" id="L222">		boolean isOverridable = false;</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">		for (int ix = 0; ix &lt; specialActivityIDs.length; ix++) {</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">			if (specialActivityIDs[ix].equals(activityID)) {</span>
<span class="nc" id="L225">				isOverridable = true;</span>
<span class="nc" id="L226">				break;</span>
			}
		}
<span class="nc bnc" id="L229" title="All 4 branches missed.">		if (isOverridable || activityID.equals(Activity.ACTIVITY_VACATION)) {</span>
<span class="nc" id="L230">			OrganizationConfigManager manager = RmManagerFactory.getInstance().getOrganizationConfigManager();</span>
<span class="nc" id="L231">			Object value =  manager.getConfiguration(orgID).getValue((String)key);</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">			if (value != null)</span>
<span class="nc" id="L233">				override = Integer.parseInt((String)value);</span>
		}
<span class="nc" id="L235">		return override;</span>
	}
	
	private void setActivityOverride(ID orgID, ID activityID, Object key, int value) throws Exception {
<span class="nc" id="L239">		int override = 0;		</span>
<span class="nc" id="L240">		boolean isOverridable = false;</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">		for (int ix = 0; ix &lt; specialActivityIDs.length; ix++) {</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">			if (specialActivityIDs[ix].equals(activityID)) {</span>
<span class="nc" id="L243">				isOverridable = true;</span>
<span class="nc" id="L244">				break;</span>
			}
		}
<span class="nc bnc" id="L247" title="All 4 branches missed.">		if (isOverridable || activityID.equals(Activity.ACTIVITY_VACATION)) {</span>
<span class="nc" id="L248">			OrganizationConfigManager manager = RmManagerFactory.getInstance().getOrganizationConfigManager();</span>
<span class="nc" id="L249">			Map propMap = new HashMap();</span>
<span class="nc" id="L250">			propMap.put(key.toString(), &quot;&quot;+value);</span>
<span class="nc" id="L251">			manager.setConfiguration(orgID, new OrganizationSetting(propMap,orgID.toString()), false ); //TBD: We need to base this on whether user clicked &quot;Save&quot; or &quot;Save and apply to sub-orgs&quot;</span>
		}
<span class="nc" id="L253">	}</span>
	// max duration and max tolerance override end

	
	public List&lt;ShiftAssignment&gt; getReferenceSchedules(Organization organization , ID employeeID, Date start, Date end) throws BbmFinderException{
		
<span class="nc" id="L259">		return TimeOffIntervalAllocationUtil.getReferenceSchedules(organization, employeeID, start, end );</span>

	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>