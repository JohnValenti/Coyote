<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffRequestFacadeImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.rm.rest.facade.timeoff</a> &gt; <span class="el_source">TimeOffRequestFacadeImpl.java</span></div><h1>TimeOffRequestFacadeImpl.java</h1><pre class="source lang-java linenums">package com.verint.web.rm.rest.facade.timeoff;

import java.io.Serializable;
import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TimeZone;

import javax.ws.rs.core.Response;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TOCalcUtil;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.commonrequestmanager.model.RequestCollection;
import com.bluepumpkin.ejb.rm.requests.commonrequestmanager.model.RequestFilter;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOChoice;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.requests.timeoff.waitlist.model.TOWaitlist;
import com.bluepumpkin.ejb.rm.requests.timeoff.withdraw.model.TOWithdraw;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.requests.RequestUtil;
import com.bluepumpkin.web.rm.requests.RequestsMH;
import com.bluepumpkin.web.rm.requests.flextime.FlexTimeRequestsMH;
import com.bluepumpkin.web.rm.requests.flextime.ShiftAssignmentDetailData;
import com.bluepumpkin.web.rm.requests.timeoff.TimeOffRequestsMH;
import com.verint.web.rest.exception.checked.BusinessWFOException;
import com.verint.web.rest.exception.checked.SystemWFOException;
import com.verint.web.rest.exception.checked.WFOException;
import com.verint.web.rest.util.FormatUtils;
import com.verint.web.rest.util.SecurityUtils;
import com.verint.web.rm.rest.entity.ActionCode;
import com.verint.web.rm.rest.entity.timeoff.TimeOffRequestEntity;
import com.verint.web.rm.rest.facade.RequestFacadeImpl;
import com.verint.web.rm.rest.facade.flex.ShiftAssignmentDetailRequestQuery;
import com.verint.web.rm.rest.util.RmUtils;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.system.RequestContext;


public class TimeOffRequestFacadeImpl implements ITimeOffRequestFacade {
<span class="nc" id="L61">	private static final Category logger = Log.initCategory(TimeOffRequestFacadeImpl.class.getName());</span>
	private static final int TIME_INTERVAL = 15;

	private RequestContext m_context;

<span class="nc" id="L66">	private static ActivityManager actMgr = null;</span>
	private List&lt;String&gt; m_statusList;
	private FlexTimeRequestsMH flexTimeRequestsMH;

<span class="nc" id="L70">	public TimeOffRequestFacadeImpl() { // NOSONAR</span>
<span class="nc" id="L71">	}</span>

	public void setFlexShiftRequest(FlexTimeRequestsMH flexTimeRequestsMH) {
<span class="nc" id="L74">		this.flexTimeRequestsMH = flexTimeRequestsMH;</span>
<span class="nc" id="L75">	}</span>

	public FlexTimeRequestsMH getFlexTimeRequestsMH() {
<span class="nc bnc" id="L78" title="All 2 branches missed.">		if(this.flexTimeRequestsMH == null) {</span>
<span class="nc" id="L79">			this.flexTimeRequestsMH = new FlexTimeRequestsMH();</span>
		}

<span class="nc" id="L82">		return this.flexTimeRequestsMH;</span>
	}

	@Override
	public List&lt;TimeOffRequestEntity&gt; getAllTimeOffEvents(RequestContext context, ID employeeId, ID organizationId, Date startTime, Date endTime,
	                                                      Date submittedFrom, Date submittedTo, int status) throws WFOException {
//	                                                      Date submittedFrom, Date submittedTo, int status, boolean showExpired) throws WFOException {
<span class="nc" id="L89">		boolean showExpired = false;</span>
		try {
<span class="nc" id="L91">			List&lt;TimeOffRequestEntity&gt; toRequests = new ArrayList&lt;TimeOffRequestEntity&gt; ();</span>

<span class="nc" id="L93">			m_context = context;</span>
<span class="nc" id="L94">			User user = m_context.getUser();</span>
<span class="nc" id="L95">			ID userEmpId = user.getEmployeeID();</span>

<span class="nc" id="L97">			boolean isAuthorized = false;</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">			if (organizationId != null) {</span>
<span class="nc" id="L99">				isAuthorized = SecurityUtils.isPrivWithOrgScope(user, PrivilegeKeys.TOM_VIEWREQUESTSFOREMPLOYEE, false, organizationId);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">				if (!isAuthorized) {</span>
					// allow to view own requests if not authorized to view organization requests but
					// user is authorized to view own requests and user's organization equals requested organization
<span class="nc" id="L103">					ID userOrgId = OrganizationModelHandler.getEmployeeOrgID(context, userEmpId);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">					if (organizationId.equals(userOrgId)) {</span>
<span class="nc" id="L105">						isAuthorized = SecurityUtils.isPrivWithGenScope(user, PrivilegeKeys.TOM_VIEWPERSONALREQUESTS);</span>
<span class="nc" id="L106">						employeeId = userEmpId;</span>
<span class="nc" id="L107">						organizationId = null;</span>
					}
<span class="nc" id="L109">				}</span>
			}
			else {
<span class="nc" id="L112">				ID empOrgId = OrganizationModelHandler.getEmployeeOrgID(context, employeeId);</span>
<span class="nc bnc" id="L113" title="All 4 branches missed.">				if (userEmpId==null || !userEmpId.equals(employeeId)) { // empUserId of wsuperuser will be null</span>
<span class="nc" id="L114">					isAuthorized = SecurityUtils.isPrivWithOrgScope(user, PrivilegeKeys.TOM_VIEWREQUESTSFOREMPLOYEE, false, empOrgId);</span>
				}
				else {
<span class="nc" id="L117">					isAuthorized = SecurityUtils.isPrivWithGenScope(user, PrivilegeKeys.TOM_VIEWPERSONALREQUESTS);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">					if (!isAuthorized) {</span>
<span class="nc" id="L119">						isAuthorized = SecurityUtils.isPrivWithOrgScope(user, PrivilegeKeys.TOM_VIEWREQUESTSFOREMPLOYEE, false, empOrgId);</span>
					}
				}
			}
<span class="nc bnc" id="L123" title="All 2 branches missed.">			if (!isAuthorized) {</span>
<span class="nc" id="L124">				throw new BusinessWFOException(&quot;Not authorized to get time off requests&quot;, Response.Status.CONFLICT);</span>
			}

<span class="nc bnc" id="L127" title="All 2 branches missed.">			if (startTime == null) {</span>
<span class="nc" id="L128">				Calendar startCal = Calendar.getInstance(TimeZone.getTimeZone(&quot;GMT&quot;));</span>
<span class="nc" id="L129">				startCal.set(1970, Calendar.JANUARY, 1);</span>
<span class="nc" id="L130">				Calendar endCal = Calendar.getInstance(TimeZone.getTimeZone(&quot;GMT&quot;));</span>
<span class="nc" id="L131">				endCal.set(2100, Calendar.JANUARY, 1);</span>

<span class="nc" id="L133">				startTime = startCal.getTime();</span>
<span class="nc" id="L134">				endTime = endCal.getTime();</span>
			}

<span class="nc" id="L137">			RequestFilter rFilter = initRequestFilter(employeeId, organizationId, startTime, endTime, submittedFrom, submittedTo, status, user);</span>

<span class="nc" id="L139">			RequestCollection requestCol = RequestsMH.getRequestsForManager(userEmpId, rFilter, &quot;&quot;, &quot;&quot;, true, Integer.MAX_VALUE, true, true);</span>
<span class="nc" id="L140">			List&lt;TORequest&gt; allRequests = requestCol.getRequests();</span>

			/**
			 *  Filter the requests by status and expiration date.
			 */
<span class="nc" id="L145">			Date dtNow = new Date();</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">			for (Iterator&lt;TORequest&gt; it = allRequests.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L147">				TORequest req = it.next();</span>
<span class="nc" id="L148">				updateWithdrawalStatus(req);</span>
<span class="nc bnc" id="L149" title="All 4 branches missed.">				if (!m_statusList.contains(req.getRequestStatus()) ||</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">				    (!showExpired &amp;&amp; req.getExpirationDate().before(dtNow))) {</span>
<span class="nc" id="L151">					it.remove();</span>
				}
<span class="nc" id="L153">			}</span>

<span class="nc" id="L155">			toRequests = buildRequestEntityList(allRequests);</span>

<span class="nc" id="L157">			return toRequests;</span>
<span class="nc" id="L158">		} catch (RmHardValidationException ex) {</span>
<span class="nc" id="L159">			logger.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L160">			throw new BusinessWFOException(ex.getLocalizedMessage(), Response.Status.CONFLICT);</span>
<span class="nc" id="L161">		} catch (BusinessWFOException ex) {</span>
<span class="nc" id="L162">			logger.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L163">			throw ex;</span>
<span class="nc" id="L164">		} catch (Exception ex) {</span>
<span class="nc" id="L165">			logger.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L166">			throw new SystemWFOException(ex.getLocalizedMessage());</span>
		}

	}

	public static void updateWithdrawalStatus(TORequest req) {
<span class="nc" id="L172">		String reqStatus = req.getRequestStatus();</span>
		// if request status is in withdrawal state WITHDRAW_REQUEST or WITHDRAW_REJECT, set request state to that for front end display
<span class="nc bnc" id="L174" title="All 2 branches missed.">		if (reqStatus.equals(RequestAuditTrail.STATUS_APPROVED)) {</span>
<span class="nc" id="L175">			TOWithdraw toWithdraw = req.getWithdrawInfo();</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">			if (toWithdraw != null) {</span>
<span class="nc" id="L177">				String toWithdrawStatus = toWithdraw.getRequestStatus();</span>
<span class="nc bnc" id="L178" title="All 4 branches missed.">				if (toWithdrawStatus != null &amp;&amp; RequestAuditTrail.isRequestForWithdrawalStates(toWithdrawStatus)) {</span>
<span class="nc" id="L179">					req.setRequestStatus(toWithdrawStatus);</span>
				}
			}
		}
<span class="nc" id="L183">	}</span>

	private void initalizeEndTimeFromStartTime(Date endTime, Date startTime) {
<span class="nc" id="L186">		endTime = new Date();</span>
		//set to current date + 30 days
<span class="nc" id="L188">		Calendar aCal = Calendar.getInstance();</span>
<span class="nc" id="L189">		aCal.setTime(startTime);</span>
		//add 30 days
<span class="nc" id="L191">		TOCalcUtil.addDaysToCalendar(aCal, 30);</span>
<span class="nc" id="L192">		endTime.setTime(aCal.getTime().getTime());</span>
<span class="nc" id="L193">	}</span>

	private RequestFilter initRequestFilter(ID employeeId, ID organizationId, Date startTime, Date endTime,
	                                        Date submittedFrom, Date submittedTo, int status, User user) {
<span class="nc" id="L197">		RequestFilter rf = new RequestFilter(user.getID(), &quot;restTemp&quot;);</span>

<span class="nc" id="L199">		rf.setKey(RequestFilter.REQUEST_TYPE_KEY, Request.REQUESTTYPE_TIMEOFF);</span>
<span class="nc" id="L200">		rf.setKey(RequestFilter.TO_NUMBER_OF_CHOICES_KEY, RequestFilter.FIRST_ONLY_TO_CHOICE);</span>

<span class="nc bnc" id="L202" title="All 2 branches missed.">		if (organizationId != null) {</span>
<span class="nc" id="L203">			Set&lt;ID&gt; orgIDList = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L204">			orgIDList.add(organizationId);</span>
			//get the entire org tree because hours are shown for entire branch
//			orgIDList.addAll(OrganizationModelHandler.getSelfAndChildOrganizationIDs(m_context, organizationId));
<span class="nc" id="L207">			rf.setKey(RequestFilter.ORGANIZATION_KEY, (Serializable) orgIDList);</span>
<span class="nc" id="L208">		}</span>
		else {
<span class="nc" id="L210">			rf.setKey(RequestFilter.EMPLOYEE_KEY, employeeId);</span>
		}

<span class="nc bnc" id="L213" title="All 4 branches missed.">		if (startTime != null &amp;&amp; endTime != null) {</span>
<span class="nc" id="L214">			List&lt;Date&gt; dates = new ArrayList&lt;Date&gt;(2);</span>
<span class="nc" id="L215">			dates.add(startTime);</span>
<span class="nc" id="L216">			dates.add(endTime);</span>
<span class="nc" id="L217">			rf.setKey(RequestFilter.REQUEST_DATE_RANGE_KEY, (Serializable) dates);</span>
		}

<span class="nc bnc" id="L220" title="All 4 branches missed.">		if (submittedFrom != null &amp;&amp; submittedTo != null) {</span>
<span class="nc" id="L221">			List&lt;Date&gt; dates = new ArrayList&lt;Date&gt;(2);</span>
<span class="nc" id="L222">			dates.add(submittedFrom);</span>
<span class="nc" id="L223">			dates.add(submittedTo);</span>
<span class="nc" id="L224">			rf.setKey(RequestFilter.SUBMITTED_KEY, (Serializable) dates);</span>
		}

<span class="nc" id="L227">		m_statusList = RmUtils.getStatusListForFilter(status);</span>

<span class="nc" id="L229">		return rf;</span>
	}

	private List&lt;TimeOffRequestEntity&gt; buildRequestEntityList(List&lt;TORequest&gt; requests) throws RemoteException, BbmException {
<span class="nc" id="L233">		List&lt;TimeOffRequestEntity&gt; entityList = new ArrayList&lt;TimeOffRequestEntity&gt;();</span>

<span class="nc" id="L235">		Map&lt;ID,String&gt; activityIDNameMap = new HashMap&lt;ID,String&gt;();</span>
<span class="nc" id="L236">		final boolean addWaitlistRank = false;</span>

<span class="nc bnc" id="L238" title="All 2 branches missed.">		for (TORequest req : requests) {</span>
<span class="nc" id="L239">			TimeOffRequestEntity reqEntity = createTORequestEntity(req, activityIDNameMap, m_context, true, addWaitlistRank);</span>
<span class="nc" id="L240">			entityList.add(reqEntity);</span>
<span class="nc" id="L241">		}</span>

<span class="nc" id="L243">		return entityList;</span>
	}

	public static TimeOffRequestEntity createTORequestEntity(TORequest req, Map&lt;ID,String&gt; activityIDNameMap,
			RequestContext context, boolean addActions, boolean addWaitlistOrder) throws RemoteException, BbmException {
<span class="nc" id="L248">		TimeOffRequestEntity reqEntity = new TimeOffRequestEntity();</span>
<span class="nc" id="L249">		ID reqId = req.getID();</span>
<span class="nc" id="L250">		reqEntity.setId(reqId.toString());</span>
<span class="nc" id="L251">		reqEntity.setTimeoffRequestID(reqId.toInt());</span>
<span class="nc" id="L252">		reqEntity.setEmployeeId(req.getEmployeeID().toInt());</span>
<span class="nc" id="L253">		ID activityId = req.getTimeOffType();</span>
<span class="nc" id="L254">		reqEntity.setActivityId(activityId.toInt());</span>
<span class="nc" id="L255">		setActivityName(reqEntity, activityId, activityIDNameMap);</span>
<span class="nc" id="L256">		reqEntity.setDebitType(getDebitType(req.getTimeOffDebitType()));</span>
<span class="nc" id="L257">		reqEntity.setStartTime(FormatUtils.dateToISO8601SecPrecisionString(req.getFirstTOChoice().getStartDate()));</span>
<span class="nc" id="L258">		reqEntity.setEndTime(FormatUtils.dateToISO8601SecPrecisionString(req.getFirstTOChoice().getEndDate()));</span>
<span class="nc" id="L259">		reqEntity.setExpiration(FormatUtils.dateToISO8601SecPrecisionString(req.getExpirationDate()));</span>
<span class="nc" id="L260">		reqEntity.setLastModifiedDate(FormatUtils.dateToISO8601SecPrecisionString(req.getLastModifiedAt()));</span>
<span class="nc" id="L261">		reqEntity.setStatusCode(RmUtils.getRequestStatusCode(req.getRequestStatus()));</span>
<span class="nc" id="L262">		reqEntity.setSubmittedOn(FormatUtils.dateToISO8601SecPrecisionString(req.getSubmittedOn()));</span>
<span class="nc" id="L263">		RmUtils.setStatusHistory(reqEntity, req.getAuditTrail());</span>
<span class="nc" id="L264">		RmUtils.setValidationResults(reqEntity, req.getValidationResults(true), context);</span>

<span class="nc" id="L266">		TOWaitlist waitlist = req.getWaitlistInfo();</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">		if (waitlist != null) {</span>
<span class="nc" id="L268">			reqEntity.setWaitlistExpirationDate(RmUtils.getString(waitlist.getTOWaitlistExpiryDate()));</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">			if (addWaitlistOrder) {</span>
<span class="nc" id="L270">				int[] rank = TimeOffRequestsMH.getWaitlistRankByID(req.getID());</span>
<span class="nc" id="L271">				reqEntity.setWaitlistRank(rank[0]);</span>
<span class="nc" id="L272">				reqEntity.setWaitlistTotal(rank[1]);</span>
			}
		}

<span class="nc bnc" id="L276" title="All 2 branches missed.">		if(addActions) {</span>
<span class="nc" id="L277">			OrganizationSetting orgSettings = RequestsMH.getOrgSettingForEmployee(context, context.getUser().getEmployeeID());</span>
<span class="nc" id="L278">			RequestFacadeImpl.addActions(context, req, reqEntity, orgSettings, null);</span>
		}

<span class="nc" id="L281">		return reqEntity;</span>
	}

	private static void setActivityName(TimeOffRequestEntity reqEntity, ID activityID, Map&lt;ID, String&gt; activityIDNameMap) {
<span class="nc" id="L285">		String name = &quot;&quot;;</span>

		try {
<span class="nc" id="L288">			name = activityIDNameMap.get(activityID);</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">			if(actMgr == null){</span>
<span class="nc" id="L290">				actMgr = RmUtils.getActivityManager();</span>
			}
<span class="nc bnc" id="L292" title="All 2 branches missed.">			if (StringUtil.isEmpty(name)) {</span>
<span class="nc" id="L293">				Activity activity = actMgr.findActivityById(activityID);</span>
<span class="nc" id="L294">				name = activity.getName();</span>
<span class="nc" id="L295">				activityIDNameMap.put(activityID, name);</span>
			}
		}
<span class="nc" id="L298">		catch (Exception e) {</span>
<span class="nc" id="L299">			logger.debug(&quot;Cannot resolve activity name&quot;);</span>
<span class="nc" id="L300">		}</span>

<span class="nc" id="L302">		reqEntity.setActivityName(name);</span>
<span class="nc" id="L303">	}</span>

	/*  Use my time off = 1
			Schedule around = 2
		 */
	private static int getDebitType(String debitType) {
<span class="nc bnc" id="L309" title="All 2 branches missed.">		return debitType.equals(TORequest.DEBITTYPE_DEBIT) ? 1 : (</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">			debitType.equals(TORequest.DEBITTYPE_DEBIT_ONLY_IF) ? 2 : 2</span>
			);
	}

	private String getDebitType(int debitType) {
<span class="nc bnc" id="L315" title="All 4 branches missed.">		return debitType == 1 ? TORequest.DEBITTYPE_DEBIT : (</span>
			debitType == 2 ? TORequest.DEBITTYPE_DEBIT_ONLY_IF : TORequest.DEBITTYPE_DEBIT_ONLY_IF
			);
	}

	///////////////////////////////////////////////////////////////////////////

	@Override
	public TimeOffRequestEntity submitTimeOffRequest(RequestContext context, ID actId, int debitType, Date startTime, Date endTime,
	                                          String comment, boolean addToWaitlist, Date waitlistExpiration) throws WFOException {
		try {
<span class="nc" id="L326">			final boolean addWaitlistRank = true;</span>
<span class="nc" id="L327">			m_context = context;</span>
<span class="nc" id="L328">			User user = m_context.getUser();</span>
<span class="nc" id="L329">			ID userEmpId = user.getEmployeeID();</span>
<span class="nc" id="L330">			TORequest toReq = instantiateTOReq(userEmpId, actId, debitType, startTime, endTime, comment, addToWaitlist, waitlistExpiration, user);</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">			if (!RequestUtil.isAuthToUpdate(context, toReq)) {</span>
<span class="nc" id="L332">				throw new BusinessWFOException(&quot;not authorized to create a time off request&quot;, Response.Status.CONFLICT);</span>
			}
<span class="nc" id="L334">			ID requestID = TimeOffRequestsMH.createTORequest(toReq, comment);</span>

<span class="nc" id="L336">			Map&lt;ID,String&gt; activityIDNameMap = new HashMap&lt;ID, String&gt;();</span>
<span class="nc" id="L337">			toReq = (TORequest) RequestsMH.getRequest(requestID, Request.REQUESTTYPE_TIMEOFF);</span>
<span class="nc" id="L338">			TimeOffRequestEntity reqEntity = createTORequestEntity(toReq, activityIDNameMap, m_context, true, addWaitlistRank);</span>

<span class="nc" id="L340">			return reqEntity;</span>
<span class="nc" id="L341">		} catch (RmHardValidationException e) {</span>
<span class="nc" id="L342">			logger.error(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L343">			throw new BusinessWFOException(e.getLocalizedMessage(), Response.Status.CONFLICT);</span>
<span class="nc" id="L344">		} catch (BusinessWFOException e) {</span>
<span class="nc" id="L345">			logger.error(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L346">			throw e;</span>
<span class="nc" id="L347">		} catch (Exception e) {</span>
<span class="nc" id="L348">			logger.error(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L349">			throw new SystemWFOException(e.getLocalizedMessage());</span>
		}
	}

	private TORequest instantiateTOReq(ID userEmpId, ID actId, int debitType, Date startTime, Date endTime,
	                                   String comment, boolean addToWaitlist, Date waitlistExpiration, User user) {
<span class="nc" id="L355">		TORequest toReq = new TORequest(TORequest.DL_BASIC);</span>
<span class="nc" id="L356">		toReq.setEmployeeID(userEmpId);</span>

<span class="nc" id="L358">		toReq.setTimeOffType(actId);</span>
<span class="nc" id="L359">		toReq.setTimeOffDebitType(getDebitType(debitType));</span>
<span class="nc" id="L360">		toReq.setRequestChoiceList(createTOChoiceList(startTime, endTime));</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">		if (addToWaitlist) {</span>
<span class="nc" id="L362">			toReq.setWaitlistInfo(makeWaitlist(waitlistExpiration));</span>
		}

<span class="nc" id="L365">		return toReq;</span>
	}


	// refer to TimeOffRequestFormPopupPM.extractParameters()
	private Collection&lt;TOChoice&gt; createTOChoiceList(Date startTime, Date endTime) {
<span class="nc" id="L371">		List&lt;TOChoice&gt; choiceList = new ArrayList&lt;TOChoice&gt;(2);</span>

		// Round the dates to the nearest interval
<span class="nc bnc" id="L374" title="All 2 branches missed.">		if (startTime !=null) {</span>
<span class="nc" id="L375">			startTime = roundToNearestInterval(startTime);</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">			if (endTime!=null) {</span>
<span class="nc" id="L377">				endTime = roundToNearestInterval(endTime);</span>
			} else {
<span class="nc" id="L379">				endTime = TimeZoneUtil.addDay(startTime);</span>
			}
		}
<span class="nc" id="L382">		TOChoice choice = new TOChoice();</span>

<span class="nc" id="L384">		choice.setRank(1);</span>
<span class="nc" id="L385">		choice.setUserRank(1);</span>
<span class="nc" id="L386">		choice.setStartDate(startTime);</span>
<span class="nc" id="L387">		choice.setEndDate(endTime);</span>
<span class="nc" id="L388">		choiceList.add(choice);</span>

<span class="nc" id="L390">		return choiceList;</span>
	}

	private Date roundToNearestInterval(Date date) {
<span class="nc" id="L394">		Date result=null;</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">		if (date!=null) {</span>
<span class="nc" id="L396">			Calendar aCal = Calendar.getInstance(TimeZoneUtil.GMT_TIMEZONE);</span>
<span class="nc" id="L397">			aCal.setTime(date);</span>
<span class="nc" id="L398">			int min = aCal.get(Calendar.MINUTE);</span>
<span class="nc" id="L399">			int remainder = min%TIME_INTERVAL;</span>

<span class="nc bnc" id="L401" title="All 2 branches missed.">			if (remainder==0) {</span>
<span class="nc" id="L402">				result=date;</span>
			} else {
<span class="nc bnc" id="L404" title="All 2 branches missed.">				int diff = (remainder&gt;(TIME_INTERVAL/2)) ? (TIME_INTERVAL-remainder) : (0-remainder);</span>
<span class="nc" id="L405">				min += diff;</span>
<span class="nc" id="L406">				aCal.set(Calendar.MINUTE, min);</span>
<span class="nc" id="L407">				result=aCal.getTime();</span>
			}
		}
<span class="nc" id="L410">		return result;</span>
	}

	private TOWaitlist makeWaitlist(Date waitlistExpiration) {
<span class="nc" id="L414">		TOWaitlist waitlist = new TOWaitlist();</span>
<span class="nc" id="L415">		waitlist.setTOWaitlistCreatorID(m_context.getUser().getID());</span>
<span class="nc" id="L416">		waitlist.setTOWaitlistCreationDate(new Date());</span>
<span class="nc" id="L417">		waitlist.setTOWaitlistExpiryDate(waitlistExpiration);</span>

<span class="nc" id="L419">		return waitlist;</span>
	}


	///////////////////////////////////////////////////////////////////////////

	@Override
	public TimeOffRequestEntity editTimeOffRequest(RequestContext context, ID reqId, ID actId, int debitType,
	                                               Date startTime, Date endTime, String strComment)
	throws WFOException {
<span class="nc" id="L429">		m_context = context;</span>
<span class="nc" id="L430">		User user = m_context.getUser();</span>

<span class="nc" id="L432">		TimeOffRequestEntity reqEntity = null;</span>
		try {
<span class="nc" id="L434">			ID userEmpId = user.getEmployeeID();</span>
<span class="nc" id="L435">			TORequest toReq = TimeOffRequestsMH.getTORequest(reqId);</span>

<span class="nc bnc" id="L437" title="All 2 branches missed.">			if (!RequestUtil.isAuthToUpdate(context, toReq)) {</span>
<span class="nc" id="L438">				throw new BusinessWFOException(&quot;Not authorized to update a time off request&quot;, Response.Status.CONFLICT);</span>
			}

			// the mobile app only supports one time off request choice
			// editing existing requests with more than one time off request choice is not supported
<span class="nc" id="L443">			List&lt;TOChoice&gt; choiceList = toReq.getRequestChoiceList();</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">			if (choiceList.size() &gt; 1) {</span>
<span class="nc" id="L445">				throw new BusinessWFOException(&quot;Requests with more than one TimeOffRequestChoice are not supported.&quot;, Response.Status.CONFLICT);</span>
			}

<span class="nc" id="L448">			toReq.setTimeOffType(actId);</span>
<span class="nc" id="L449">			toReq.setTimeOffDebitType(getDebitType(debitType));</span>
<span class="nc" id="L450">			toReq.setRequestChoiceList(createTOChoiceList(startTime, endTime));</span>
<span class="nc" id="L451">			toReq.clearValidationCache();</span>

<span class="nc" id="L453">			TimeOffRequestsMH.updateTORequest(toReq, strComment);</span>

<span class="nc" id="L455">			toReq = TimeOffRequestsMH.getTORequest(reqId);</span>
<span class="nc" id="L456">			Map&lt;ID,String&gt; activityIDNameMap = new HashMap&lt;ID, String&gt;();</span>
<span class="nc" id="L457">			final boolean addWaitlistRank = true;</span>
<span class="nc" id="L458">			reqEntity = createTORequestEntity(toReq, activityIDNameMap, m_context, true, addWaitlistRank);</span>
<span class="nc" id="L459">		} catch (BusinessWFOException e) {</span>
<span class="nc" id="L460">			logger.error(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L461">			throw e;</span>
<span class="nc" id="L462">		} catch (RmHardValidationException e) {</span>
<span class="nc" id="L463">			logger.error(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L464">			throw new BusinessWFOException(e.getLocalizedMessage(), Response.Status.CONFLICT);</span>
<span class="nc" id="L465">		} catch (Exception e) {</span>
<span class="nc" id="L466">			logger.error(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L467">			throw new SystemWFOException(e.getLocalizedMessage());</span>
<span class="nc" id="L468">		}</span>

<span class="nc" id="L470">		return reqEntity;</span>
	}

	///////////////////////////////////////////////////////////////////////////

	@SuppressWarnings(&quot;unused&quot;)
	@Override
	public TimeOffRequestEntity processTimeOffRequest(RequestContext context, ID reqId, int actionCode, String comment) throws WFOException {

		try {
<span class="nc" id="L480">			m_context = context;</span>
<span class="nc" id="L481">			final boolean addWaitlistRank = true;</span>

<span class="nc" id="L483">			TORequest toReq = TimeOffRequestsMH.getTORequest(reqId);</span>

<span class="nc bnc" id="L485" title="All 2 branches missed.">			if (ActionCode.APPROVE.getActionCode() == actionCode) {</span>
<span class="nc" id="L486">				TimeOffRequestsMH.approveTORequest(reqId, toReq.getFirstTOChoice().getID(), toReq.getObjectVersionNumber(), comment);</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">			} else if (ActionCode.TENTATIVELYAPPROVE.getActionCode() == actionCode) {</span>
<span class="nc" id="L488">				TimeOffRequestsMH.tentativelyApproveTORequest(reqId, toReq.getFirstTOChoice().getID(), toReq.getObjectVersionNumber(), comment);</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">			} else if (ActionCode.DENY.getActionCode() == actionCode) {</span>
<span class="nc" id="L490">				TimeOffRequestsMH.denyTORequest(reqId, toReq.getObjectVersionNumber(), comment);</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">			} else if (ActionCode.ADDTOWAITLIST.getActionCode() == actionCode) {</span>
<span class="nc" id="L492">				Pair pair = TimeOffRequestsMH.addRequestToWaitlist(context, reqId, comment, toReq.getExpirationDate());</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">				if (!((Boolean) pair.getFirst()).booleanValue()) {</span>
<span class="nc" id="L494">					throw new BusinessWFOException(pair.getSecond().toString(), Response.Status.CONFLICT);</span>
				}
<span class="nc bnc" id="L496" title="All 2 branches missed.">			} else if (ActionCode.WITHDRAW.getActionCode() == actionCode) {</span>
<span class="nc" id="L497">				Pair&lt;Boolean, String&gt; pair = TimeOffRequestsMH.requestWithdrawOfApprovedRequest(reqId, Request.REQUESTTYPE_TIMEOFF,</span>
<span class="nc" id="L498">						toReq.getObjectVersionNumber(), RequestAuditTrail.STATUS_WITHDRAWN, comment);</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">				if (!pair.getFirst().booleanValue()) {</span>
<span class="nc" id="L500">					throw new BusinessWFOException(pair.getSecond().toString(), Response.Status.CONFLICT);</span>
				}
<span class="nc bnc" id="L502" title="All 2 branches missed.">			} else if (ActionCode.ESCALATE.getActionCode() == actionCode) {</span>
<span class="nc" id="L503">				RequestsMH.changeRequestStatus(reqId, Request.REQUESTTYPE_TIMEOFF, toReq.getObjectVersionNumber(),</span>
					RequestAuditTrail.STATUS_ESCALATED, comment);
<span class="nc bnc" id="L505" title="All 2 branches missed.">			} else if (ActionCode.CANCEL_WITHDRAWAL.getActionCode() == actionCode) {</span>
<span class="nc" id="L506">				Pair&lt;Boolean, String&gt; pair = TimeOffRequestsMH.cancelWithdrawOfApprovedRequest(context, reqId, comment);</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">				if (!pair.getFirst().booleanValue()) {</span>
<span class="nc" id="L508">					throw new BusinessWFOException(pair.getSecond(), Response.Status.CONFLICT);</span>
				}
<span class="nc" id="L510">			} else {</span>
<span class="nc" id="L511">				throw new BusinessWFOException(&quot;ActionCode not supported&quot;, Response.Status.CONFLICT);</span>
			}

<span class="nc" id="L514">			toReq = TimeOffRequestsMH.getTORequest(reqId);</span>
<span class="nc" id="L515">			Map&lt;ID,String&gt; activityIDNameMap = new HashMap&lt;ID,String&gt;();</span>
<span class="nc" id="L516">			return createTORequestEntity(toReq, activityIDNameMap, context, true, addWaitlistRank);</span>
<span class="nc" id="L517">		} catch (RmHardValidationException ex) {</span>
<span class="nc" id="L518">			logger.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L519">			throw new BusinessWFOException(ex.getLocalizedMessage(), Response.Status.CONFLICT);</span>
<span class="nc" id="L520">		} catch (BusinessWFOException ex) {</span>
<span class="nc" id="L521">			logger.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L522">			throw ex;</span>
<span class="nc" id="L523">		} catch (Exception ex) {</span>
<span class="nc" id="L524">			logger.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L525">			throw new SystemWFOException(ex.getLocalizedMessage());</span>
		}
	}

	@Override
	public ShiftAssignmentDetailData getShiftAssignmentDetail(ShiftAssignmentDetailRequestQuery query) {
		try {
<span class="nc" id="L532">			return this.getFlexTimeRequestsMH().getShiftAssignmentDetail(query.getContext(), query.getUserId(), query.getEmployeeId(), query.getFromDate());</span>
<span class="nc" id="L533">		} catch (Exception e) {</span>
<span class="nc" id="L534">			logger.info(&quot;TimeOffRequestFacadeImpl.getShiftAssignmentDetail(...): query[&quot; + query + &quot;]&quot;);</span>
<span class="nc" id="L535">			logger.error(&quot;TimeOffRequestFacadeImpl.getShiftAssignmentDetail(...)&quot;, e);</span>
		}

<span class="nc" id="L538">		return new ShiftAssignmentDetailData();</span>
	}

	public TimeOffRequestEntity getRequest(RequestContext context, ID requestID) throws WFOException {
<span class="nc" id="L542">		TimeOffRequestEntity reqEntity = null;</span>
		try {
<span class="nc" id="L544">			TORequest req = TimeOffRequestsMH.getTORequest(requestID);</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">			if (!RequestUtil.isAuthToView(context, req)) {</span>
<span class="nc" id="L546">				RmUtils.throwUnauthorizedToAccessRequest(context);</span>
			}

<span class="nc" id="L549">			Map&lt;ID, String&gt; activityIDNameMap = new HashMap&lt;ID, String&gt;();</span>
<span class="nc" id="L550">			final boolean addWaitlistRank = true;</span>
<span class="nc" id="L551">			reqEntity = createTORequestEntity(req, activityIDNameMap, context, true, addWaitlistRank);</span>
<span class="nc" id="L552">		} catch (BusinessWFOException e) {</span>
<span class="nc" id="L553">			logger.error(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L554">			throw e;</span>
<span class="nc" id="L555">		} catch (RmHardValidationException e) {</span>
<span class="nc" id="L556">			logger.error(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L557">			throw new BusinessWFOException(e.getLocalizedMessage(), Response.Status.CONFLICT);</span>
<span class="nc" id="L558">		} catch (Exception e) {</span>
<span class="nc" id="L559">			logger.error(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L560">			throw new SystemWFOException(e.getLocalizedMessage());</span>
<span class="nc" id="L561">		}</span>

<span class="nc" id="L563">		return reqEntity;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>