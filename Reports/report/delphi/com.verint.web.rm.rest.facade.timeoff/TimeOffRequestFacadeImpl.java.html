<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffRequestFacadeImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.verint.web.rm.rest.facade.timeoff</a> &gt; <span class="el_source">TimeOffRequestFacadeImpl.java</span></div><h1>TimeOffRequestFacadeImpl.java</h1><pre class="source lang-java linenums">package com.verint.web.rm.rest.facade.timeoff;

import java.io.Serializable;
import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TimeZone;

import javax.ws.rs.core.Response;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.common.util.TimeZoneUtil;
import com.bluepumpkin.ejb.bbm.activity.ejb.ActivityManager;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TOCalcUtil;
import com.bluepumpkin.ejb.rm.base.RmHardValidationException;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.commonrequestmanager.model.RequestCollection;
import com.bluepumpkin.ejb.rm.requests.commonrequestmanager.model.RequestFilter;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOChoice;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.requests.timeoff.waitlist.model.TOWaitlist;
import com.bluepumpkin.ejb.rm.requests.timeoff.withdraw.model.TOWithdraw;
import com.bluepumpkin.ejb.rm.setup.settings.model.OrganizationSetting;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.requests.RequestUtil;
import com.bluepumpkin.web.rm.requests.RequestsMH;
import com.bluepumpkin.web.rm.requests.flextime.FlexTimeRequestsMH;
import com.bluepumpkin.web.rm.requests.flextime.ShiftAssignmentDetailData;
import com.bluepumpkin.web.rm.requests.timeoff.TimeOffRequestUtil;
import com.bluepumpkin.web.rm.requests.timeoff.TimeOffRequestsMH;
import com.verint.web.rest.exception.checked.BusinessWFOException;
import com.verint.web.rest.exception.checked.SystemWFOException;
import com.verint.web.rest.exception.checked.WFOException;
import com.verint.web.rest.util.FormatUtils;
import com.verint.web.rest.util.SecurityUtils;
import com.verint.web.rm.rest.entity.ActionCode;
import com.verint.web.rm.rest.entity.timeoff.TimeOffRequestEntity;
import com.verint.web.rm.rest.facade.RequestFacadeImpl;
import com.verint.web.rm.rest.facade.flex.ShiftAssignmentDetailRequestQuery;
import com.verint.web.rm.rest.util.RmUtils;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.system.RequestContext;


public class TimeOffRequestFacadeImpl implements ITimeOffRequestFacade {
<span class="nc" id="L63">	private static final Category logger = Log.initCategory(TimeOffRequestFacadeImpl.class.getName());</span>
	private static final int TIME_INTERVAL = 15;

	private RequestContext m_context;

<span class="nc" id="L68">	private static ActivityManager actMgr = null;</span>
	private List&lt;String&gt; m_statusList;
	private FlexTimeRequestsMH flexTimeRequestsMH;

<span class="nc" id="L72">	public TimeOffRequestFacadeImpl() { // NOSONAR</span>
<span class="nc" id="L73">	}</span>

	public void setFlexShiftRequest(FlexTimeRequestsMH flexTimeRequestsMH) {
<span class="nc" id="L76">		this.flexTimeRequestsMH = flexTimeRequestsMH;</span>
<span class="nc" id="L77">	}</span>

	public FlexTimeRequestsMH getFlexTimeRequestsMH() {
<span class="nc bnc" id="L80" title="All 2 branches missed.">		if(this.flexTimeRequestsMH == null) {</span>
<span class="nc" id="L81">			this.flexTimeRequestsMH = new FlexTimeRequestsMH();</span>
		}

<span class="nc" id="L84">		return this.flexTimeRequestsMH;</span>
	}

	@Override
	public List&lt;TimeOffRequestEntity&gt; getAllTimeOffEvents(RequestContext context, ID employeeId, ID organizationId, Date startTime, Date endTime,
	                                                      Date submittedFrom, Date submittedTo, int status) throws WFOException {
//	                                                      Date submittedFrom, Date submittedTo, int status, boolean showExpired) throws WFOException {
<span class="nc" id="L91">		boolean showExpired = false;</span>
		try {
<span class="nc" id="L93">			List&lt;TimeOffRequestEntity&gt; toRequests = new ArrayList&lt;TimeOffRequestEntity&gt; ();</span>

<span class="nc" id="L95">			m_context = context;</span>
<span class="nc" id="L96">			User user = m_context.getUser();</span>
<span class="nc" id="L97">			ID userEmpId = user.getEmployeeID();</span>

<span class="nc" id="L99">			boolean isAuthorized = false;</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">			if (organizationId != null) {</span>
<span class="nc" id="L101">				isAuthorized = SecurityUtils.isPrivWithOrgScope(user, PrivilegeKeys.TOM_VIEWREQUESTSFOREMPLOYEE, false, organizationId);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">				if (!isAuthorized) {</span>
					// allow to view own requests if not authorized to view organization requests but
					// user is authorized to view own requests and user's organization equals requested organization
<span class="nc" id="L105">					ID userOrgId = OrganizationModelHandler.getEmployeeOrgID(context, userEmpId);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">					if (organizationId.equals(userOrgId)) {</span>
<span class="nc" id="L107">						isAuthorized = SecurityUtils.isPrivWithGenScope(user, PrivilegeKeys.TOM_VIEWPERSONALREQUESTS);</span>
<span class="nc" id="L108">						employeeId = userEmpId;</span>
<span class="nc" id="L109">						organizationId = null;</span>
					}
<span class="nc" id="L111">				}</span>
			}
			else {
<span class="nc" id="L114">				ID empOrgId = OrganizationModelHandler.getEmployeeOrgID(context, employeeId);</span>
<span class="nc bnc" id="L115" title="All 4 branches missed.">				if (userEmpId==null || !userEmpId.equals(employeeId)) { // empUserId of wsuperuser will be null</span>
<span class="nc" id="L116">					isAuthorized = SecurityUtils.isPrivWithOrgScope(user, PrivilegeKeys.TOM_VIEWREQUESTSFOREMPLOYEE, false, empOrgId);</span>
				}
				else {
<span class="nc" id="L119">					isAuthorized = SecurityUtils.isPrivWithGenScope(user, PrivilegeKeys.TOM_VIEWPERSONALREQUESTS);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">					if (!isAuthorized) {</span>
<span class="nc" id="L121">						isAuthorized = SecurityUtils.isPrivWithOrgScope(user, PrivilegeKeys.TOM_VIEWREQUESTSFOREMPLOYEE, false, empOrgId);</span>
					}
				}
			}
<span class="nc bnc" id="L125" title="All 2 branches missed.">			if (!isAuthorized) {</span>
<span class="nc" id="L126">				throw new BusinessWFOException(&quot;Not authorized to get time off requests&quot;, Response.Status.CONFLICT);</span>
			}

<span class="nc bnc" id="L129" title="All 2 branches missed.">			if (startTime == null) {</span>
<span class="nc" id="L130">				Calendar startCal = Calendar.getInstance(TimeZone.getTimeZone(&quot;GMT&quot;));</span>
<span class="nc" id="L131">				startCal.set(1970, Calendar.JANUARY, 1);</span>
<span class="nc" id="L132">				Calendar endCal = Calendar.getInstance(TimeZone.getTimeZone(&quot;GMT&quot;));</span>
<span class="nc" id="L133">				endCal.set(2100, Calendar.JANUARY, 1);</span>

<span class="nc" id="L135">				startTime = startCal.getTime();</span>
<span class="nc" id="L136">				endTime = endCal.getTime();</span>
			}

<span class="nc" id="L139">			RequestFilter rFilter = initRequestFilter(employeeId, organizationId, startTime, endTime, submittedFrom, submittedTo, status, user);</span>

<span class="nc" id="L141">			RequestCollection requestCol = RequestsMH.getRequestsForManager(userEmpId, rFilter, &quot;&quot;, &quot;&quot;, true, Integer.MAX_VALUE, true, true);</span>
<span class="nc" id="L142">			List&lt;TORequest&gt; allRequests = requestCol.getRequests();</span>

			/**
			 *  Filter the requests by status and expiration date.
			 */
<span class="nc" id="L147">			Date dtNow = new Date();</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">			for (Iterator&lt;TORequest&gt; it = allRequests.iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L149">				TORequest req = it.next();</span>
<span class="nc bnc" id="L150" title="All 4 branches missed.">				if (!m_statusList.contains(req.getRequestStatus()) ||</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">				    (!showExpired &amp;&amp; req.getExpirationDate().before(dtNow))) {</span>
<span class="nc" id="L152">					it.remove();</span>
				}
<span class="nc" id="L154">			}</span>

<span class="nc" id="L156">			toRequests = buildRequestEntityList(allRequests);</span>

<span class="nc" id="L158">			return toRequests;</span>
<span class="nc" id="L159">		} catch (RmHardValidationException ex) {</span>
<span class="nc" id="L160">			throw RmUtils.handleFacadeException(context, ex, logger);</span>
<span class="nc" id="L161">		} catch (BusinessWFOException ex) {</span>
<span class="nc" id="L162">			logger.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L163">			throw ex;</span>
<span class="nc" id="L164">		} catch (Exception ex) {</span>
<span class="nc" id="L165">			logger.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L166">			throw new SystemWFOException(ex.getLocalizedMessage());</span>
		}

	}

	public static void updateWithdrawalStatus(TORequest req) {
<span class="nc" id="L172">		String reqStatus = req.getRequestStatus();</span>
		// if request status is in withdrawal state WITHDRAW_REQUEST or WITHDRAW_REJECT, set request state to that for front end display
<span class="nc bnc" id="L174" title="All 2 branches missed.">		if (reqStatus.equals(RequestAuditTrail.STATUS_APPROVED)) {</span>
<span class="nc" id="L175">			TOWithdraw toWithdraw = req.getWithdrawInfo();</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">			if (toWithdraw != null) {</span>
<span class="nc" id="L177">				String toWithdrawStatus = toWithdraw.getRequestStatus();</span>
<span class="nc bnc" id="L178" title="All 4 branches missed.">				if (toWithdrawStatus != null &amp;&amp; RequestAuditTrail.isRequestForWithdrawalStates(toWithdrawStatus)) {</span>
<span class="nc" id="L179">					req.setRequestStatus(toWithdrawStatus);</span>
				}
			}
		}
<span class="nc" id="L183">	}</span>

	private void initalizeEndTimeFromStartTime(Date endTime, Date startTime) {
<span class="nc" id="L186">		endTime = new Date();</span>
		//set to current date + 30 days
<span class="nc" id="L188">		Calendar aCal = Calendar.getInstance();</span>
<span class="nc" id="L189">		aCal.setTime(startTime);</span>
		//add 30 days
<span class="nc" id="L191">		TOCalcUtil.addDaysToCalendar(aCal, 30);</span>
<span class="nc" id="L192">		endTime.setTime(aCal.getTime().getTime());</span>
<span class="nc" id="L193">	}</span>

	private RequestFilter initRequestFilter(ID employeeId, ID organizationId, Date startTime, Date endTime,
	                                        Date submittedFrom, Date submittedTo, int status, User user) {
<span class="nc" id="L197">		RequestFilter rf = new RequestFilter(user.getID(), &quot;restTemp&quot;);</span>

<span class="nc" id="L199">		rf.setKey(RequestFilter.REQUEST_TYPE_KEY, Request.REQUESTTYPE_TIMEOFF);</span>
<span class="nc" id="L200">		rf.setKey(RequestFilter.TO_NUMBER_OF_CHOICES_KEY, RequestFilter.FIRST_ONLY_TO_CHOICE);</span>

<span class="nc bnc" id="L202" title="All 2 branches missed.">		if (organizationId != null) {</span>
<span class="nc" id="L203">			Set&lt;ID&gt; orgIDList = new HashSet&lt;ID&gt;();</span>
<span class="nc" id="L204">			orgIDList.add(organizationId);</span>
			//get the entire org tree because hours are shown for entire branch
//			orgIDList.addAll(OrganizationModelHandler.getSelfAndChildOrganizationIDs(m_context, organizationId));
<span class="nc" id="L207">			rf.setKey(RequestFilter.ORGANIZATION_KEY, (Serializable) orgIDList);</span>
<span class="nc" id="L208">		}</span>
		else {
<span class="nc" id="L210">			rf.setKey(RequestFilter.EMPLOYEE_KEY, employeeId);</span>
		}

<span class="nc bnc" id="L213" title="All 4 branches missed.">		if (startTime != null &amp;&amp; endTime != null) {</span>
<span class="nc" id="L214">			List&lt;Date&gt; dates = new ArrayList&lt;Date&gt;(2);</span>
<span class="nc" id="L215">			dates.add(startTime);</span>
<span class="nc" id="L216">			dates.add(endTime);</span>
<span class="nc" id="L217">			rf.setKey(RequestFilter.REQUEST_DATE_RANGE_KEY, (Serializable) dates);</span>
		}

<span class="nc bnc" id="L220" title="All 4 branches missed.">		if (submittedFrom != null &amp;&amp; submittedTo != null) {</span>
<span class="nc" id="L221">			List&lt;Date&gt; dates = new ArrayList&lt;Date&gt;(2);</span>
<span class="nc" id="L222">			dates.add(submittedFrom);</span>
<span class="nc" id="L223">			dates.add(submittedTo);</span>
<span class="nc" id="L224">			rf.setKey(RequestFilter.SUBMITTED_KEY, (Serializable) dates);</span>
		}

<span class="nc" id="L227">		m_statusList = RmUtils.getStatusListForFilter(status);</span>

<span class="nc" id="L229">		return rf;</span>
	}

	private List&lt;TimeOffRequestEntity&gt; buildRequestEntityList(List&lt;TORequest&gt; requests) throws RemoteException, BbmException {
<span class="nc" id="L233">		List&lt;TimeOffRequestEntity&gt; entityList = new ArrayList&lt;TimeOffRequestEntity&gt;();</span>

<span class="nc" id="L235">		Map&lt;ID,String&gt; activityIDNameMap = new HashMap&lt;ID,String&gt;();</span>
<span class="nc" id="L236">		final boolean addWaitlistRank = false;</span>

<span class="nc bnc" id="L238" title="All 2 branches missed.">		for (TORequest req : requests) {</span>
<span class="nc" id="L239">			TimeOffRequestEntity reqEntity = createTORequestEntity(req, activityIDNameMap, m_context, true, addWaitlistRank);</span>
<span class="nc" id="L240">			entityList.add(reqEntity);</span>
<span class="nc" id="L241">		}</span>

<span class="nc" id="L243">		return entityList;</span>
	}

	public static TimeOffRequestEntity createTORequestEntity(TORequest req, Map&lt;ID,String&gt; activityIDNameMap,
			RequestContext context, boolean addActions, boolean addWaitlistOrder) throws RemoteException, BbmException {

<span class="nc" id="L249">		updateWithdrawalStatus(req);</span>

<span class="nc" id="L251">		TimeOffRequestEntity reqEntity = new TimeOffRequestEntity();</span>
<span class="nc" id="L252">		ID reqId = req.getID();</span>
<span class="nc" id="L253">		reqEntity.setId(reqId.toString());</span>
<span class="nc" id="L254">		reqEntity.setTimeoffRequestID(reqId.toInt());</span>
<span class="nc" id="L255">		reqEntity.setEmployeeId(req.getEmployeeID().toInt());</span>
<span class="nc" id="L256">		ID activityId = req.getTimeOffType();</span>
<span class="nc" id="L257">		reqEntity.setActivityId(activityId.toInt());</span>
<span class="nc" id="L258">		setActivityName(reqEntity, activityId, activityIDNameMap);</span>
<span class="nc" id="L259">		reqEntity.setDebitType(getDebitType(req.getTimeOffDebitType()));</span>
<span class="nc" id="L260">		reqEntity.setStartTime(FormatUtils.dateToISO8601SecPrecisionString(req.getFirstTOChoice().getStartDate()));</span>
<span class="nc" id="L261">		reqEntity.setEndTime(FormatUtils.dateToISO8601SecPrecisionString(req.getFirstTOChoice().getEndDate()));</span>
<span class="nc" id="L262">		reqEntity.setExpiration(FormatUtils.dateToISO8601SecPrecisionString(req.getExpirationDate()));</span>
<span class="nc" id="L263">		reqEntity.setLastModifiedDate(FormatUtils.dateToISO8601SecPrecisionString(req.getLastModifiedAt()));</span>
<span class="nc" id="L264">		reqEntity.setStatusCode(RmUtils.getRequestStatusCode(req.getRequestStatus()));</span>
<span class="nc" id="L265">		reqEntity.setSubmittedOn(FormatUtils.dateToISO8601SecPrecisionString(req.getSubmittedOn()));</span>
<span class="nc" id="L266">		RmUtils.setStatusHistory(reqEntity, req.getAuditTrail());</span>
<span class="nc" id="L267">		RmUtils.setValidationResults(reqEntity, req.getValidationResults(true), context);</span>

<span class="nc" id="L269">		TOWaitlist waitlist = req.getWaitlistInfo();</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">		if (waitlist != null) {</span>
<span class="nc" id="L271">			reqEntity.setWaitlistExpirationDate(RmUtils.getString(waitlist.getTOWaitlistExpiryDate()));</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">			if (addWaitlistOrder) {</span>
<span class="nc" id="L273">				int[] rank = TimeOffRequestsMH.getWaitlistRankByID(req.getID());</span>
<span class="nc" id="L274">				reqEntity.setWaitlistRank(rank[0]);</span>
<span class="nc" id="L275">				reqEntity.setWaitlistTotal(rank[1]);</span>
			}
		}

<span class="nc bnc" id="L279" title="All 2 branches missed.">		if(addActions) {</span>
<span class="nc" id="L280">			OrganizationSetting orgSettings = RequestsMH.getOrgSettingForEmployee(context, context.getUser().getEmployeeID());</span>
<span class="nc" id="L281">			RequestFacadeImpl.addActions(context, req, reqEntity, orgSettings, null);</span>
		}

<span class="nc" id="L284">		return reqEntity;</span>
	}

	private static void setActivityName(TimeOffRequestEntity reqEntity, ID activityID, Map&lt;ID, String&gt; activityIDNameMap) {
<span class="nc" id="L288">		String name = &quot;&quot;;</span>

		try {
<span class="nc" id="L291">			name = activityIDNameMap.get(activityID);</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">			if(actMgr == null){</span>
<span class="nc" id="L293">				actMgr = RmUtils.getActivityManager();</span>
			}
<span class="nc bnc" id="L295" title="All 2 branches missed.">			if (StringUtil.isEmpty(name)) {</span>
<span class="nc" id="L296">				Activity activity = actMgr.findActivityById(activityID);</span>
<span class="nc" id="L297">				name = activity.getName();</span>
<span class="nc" id="L298">				activityIDNameMap.put(activityID, name);</span>
			}
		}
<span class="nc" id="L301">		catch (Exception e) {</span>
<span class="nc" id="L302">			logger.debug(&quot;Cannot resolve activity name&quot;);</span>
<span class="nc" id="L303">		}</span>

<span class="nc" id="L305">		reqEntity.setActivityName(name);</span>
<span class="nc" id="L306">	}</span>

	/*  Use my time off = 1
			Schedule around = 2
		 */
	private static int getDebitType(String debitType) {
<span class="nc bnc" id="L312" title="All 2 branches missed.">		return debitType.equals(TORequest.DEBITTYPE_DEBIT) ? 1 : (</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">			debitType.equals(TORequest.DEBITTYPE_DEBIT_ONLY_IF) ? 2 : 2</span>
			);
	}

	private String getDebitType(int debitType) {
<span class="nc bnc" id="L318" title="All 4 branches missed.">		return debitType == 1 ? TORequest.DEBITTYPE_DEBIT : (</span>
			debitType == 2 ? TORequest.DEBITTYPE_DEBIT_ONLY_IF : TORequest.DEBITTYPE_DEBIT_ONLY_IF
			);
	}

	///////////////////////////////////////////////////////////////////////////

	@Override
	public TimeOffRequestEntity submitTimeOffRequest(RequestContext context, ID actId, int debitType, Date startTime, Date endTime,
	                                          String comment, boolean addToWaitlist, Date waitlistExpiration) throws WFOException {
		try {
<span class="nc" id="L329">			final boolean addWaitlistRank = true;</span>
<span class="nc" id="L330">			m_context = context;</span>
<span class="nc" id="L331">			User user = m_context.getUser();</span>
<span class="nc" id="L332">			ID userEmpId = user.getEmployeeID();</span>
<span class="nc" id="L333">			TORequest toReq = instantiateTOReq(context,userEmpId, actId, debitType, startTime, endTime, comment, addToWaitlist, waitlistExpiration);</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">			if (!RequestUtil.isAuthToUpdate(context, toReq)) {</span>
<span class="nc" id="L335">				throw new BusinessWFOException(&quot;not authorized to create a time off request&quot;, Response.Status.CONFLICT);</span>
			}
<span class="nc" id="L337">			ID requestID = TimeOffRequestsMH.createTORequest(toReq, comment);</span>

<span class="nc" id="L339">			Map&lt;ID,String&gt; activityIDNameMap = new HashMap&lt;ID, String&gt;();</span>
<span class="nc" id="L340">			toReq = (TORequest) RequestsMH.getRequest(requestID, Request.REQUESTTYPE_TIMEOFF);</span>
<span class="nc" id="L341">			TimeOffRequestEntity reqEntity = createTORequestEntity(toReq, activityIDNameMap, m_context, true, addWaitlistRank);</span>

<span class="nc" id="L343">			return reqEntity;</span>
<span class="nc" id="L344">		} catch (RmHardValidationException ex) {</span>
<span class="nc" id="L345">			throw RmUtils.handleFacadeException(context, ex, logger);</span>
<span class="nc" id="L346">		} catch (BusinessWFOException e) {</span>
<span class="nc" id="L347">			logger.error(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L348">			throw e;</span>
<span class="nc" id="L349">		} catch (Exception e) {</span>
<span class="nc" id="L350">			logger.error(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L351">			throw new SystemWFOException(e.getLocalizedMessage());</span>
		}
	}

	private TORequest instantiateTOReq(RequestContext context, ID userEmpId, ID actId, int debitType, Date startTime, Date endTime,
	                                   String comment, boolean addToWaitlist, Date waitlistExpiration) {
<span class="nc" id="L357">		TORequest toReq = new TORequest(TORequest.DL_BASIC);</span>
<span class="nc" id="L358">		toReq.setEmployeeID(userEmpId);</span>
<span class="nc" id="L359">		toReq.setTimeOffType(actId);</span>
<span class="nc" id="L360">		toReq.setTimeOffDebitType(getDebitType(debitType));</span>
<span class="nc" id="L361">		toReq.setRequestChoiceList(createTOChoiceList(context,userEmpId,startTime, endTime));</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">		if (addToWaitlist) {</span>
<span class="nc" id="L363">			toReq.setWaitlistInfo(makeWaitlist(waitlistExpiration));</span>
		}

<span class="nc" id="L366">		return toReq;</span>
	}


	// refer to TimeOffRequestFormPopupPM.extractParameters()
	private Collection&lt;TOChoice&gt; createTOChoiceList(RequestContext context,ID empID, Date startTime, Date endTime) {
<span class="nc" id="L372">		List&lt;TOChoice&gt; choiceList = new ArrayList&lt;TOChoice&gt;(2);</span>

		// Round the dates to the nearest interval
<span class="nc bnc" id="L375" title="All 2 branches missed.">		if (startTime !=null) {</span>
<span class="nc" id="L376">			int interval=TIME_INTERVAL;</span>
			try {
<span class="nc" id="L378">				interval = TimeOffRequestUtil.getSettingTimeOffRoundInterval(context, empID);</span>
<span class="nc" id="L379">			} catch (Exception e) {</span>
<span class="nc" id="L380">				logger.error(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L381">			}</span>
<span class="nc" id="L382">			startTime = TimeOffRequestUtil.roundToNearestInterval(context.getViewingTimeZone(),startTime,interval);</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">			if (endTime!=null) {</span>
<span class="nc" id="L384">				endTime = TimeOffRequestUtil.roundToNearestInterval(context.getViewingTimeZone(),endTime,interval);</span>
			} else {
<span class="nc" id="L386">				endTime = TimeZoneUtil.addDay(startTime);</span>
			}
		}
<span class="nc" id="L389">		TOChoice choice = new TOChoice();</span>

<span class="nc" id="L391">		choice.setRank(1);</span>
<span class="nc" id="L392">		choice.setUserRank(1);</span>
<span class="nc" id="L393">		choice.setStartDate(startTime);</span>
<span class="nc" id="L394">		choice.setEndDate(endTime);</span>
<span class="nc" id="L395">		choiceList.add(choice);</span>

<span class="nc" id="L397">		return choiceList;</span>
	}

	private TOWaitlist makeWaitlist(Date waitlistExpiration) {
<span class="nc" id="L401">		TOWaitlist waitlist = new TOWaitlist();</span>
<span class="nc" id="L402">		waitlist.setTOWaitlistCreatorID(m_context.getUser().getID());</span>
<span class="nc" id="L403">		waitlist.setTOWaitlistCreationDate(new Date());</span>
<span class="nc" id="L404">		waitlist.setTOWaitlistExpiryDate(waitlistExpiration);</span>

<span class="nc" id="L406">		return waitlist;</span>
	}


	///////////////////////////////////////////////////////////////////////////

	@Override
	public TimeOffRequestEntity editTimeOffRequest(RequestContext context, ID reqId, ID actId, int debitType,
	                                               Date startTime, Date endTime, String strComment)
	throws WFOException {
<span class="nc" id="L416">		m_context = context;</span>
<span class="nc" id="L417">		User user = m_context.getUser();</span>

<span class="nc" id="L419">		TimeOffRequestEntity reqEntity = null;</span>
		try {
<span class="nc" id="L421">			ID userEmpId = user.getEmployeeID();</span>
<span class="nc" id="L422">			TORequest toReq = TimeOffRequestsMH.getTORequest(reqId);</span>

<span class="nc bnc" id="L424" title="All 2 branches missed.">			if (!RequestUtil.isAuthToUpdate(context, toReq)) {</span>
<span class="nc" id="L425">				throw new BusinessWFOException(&quot;Not authorized to update a time off request&quot;, Response.Status.CONFLICT);</span>
			}

			// the mobile app only supports one time off request choice
			// editing existing requests with more than one time off request choice is not supported
<span class="nc" id="L430">			List&lt;TOChoice&gt; choiceList = toReq.getRequestChoiceList();</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">			if (choiceList.size() &gt; 1) {</span>
<span class="nc" id="L432">				throw new BusinessWFOException(&quot;Requests with more than one TimeOffRequestChoice are not supported.&quot;, Response.Status.CONFLICT);</span>
			}
<span class="nc" id="L434">			toReq.setTimeOffType(actId);</span>
<span class="nc" id="L435">			toReq.setTimeOffDebitType(getDebitType(debitType));</span>
<span class="nc" id="L436">			toReq.setRequestChoiceList(createTOChoiceList(context,userEmpId,startTime, endTime));</span>
<span class="nc" id="L437">			toReq.clearValidationCache();</span>

<span class="nc" id="L439">			TimeOffRequestsMH.updateTORequest(toReq, strComment);</span>

<span class="nc" id="L441">			toReq = TimeOffRequestsMH.getTORequest(reqId);</span>
<span class="nc" id="L442">			Map&lt;ID,String&gt; activityIDNameMap = new HashMap&lt;ID, String&gt;();</span>
<span class="nc" id="L443">			final boolean addWaitlistRank = true;</span>
<span class="nc" id="L444">			reqEntity = createTORequestEntity(toReq, activityIDNameMap, m_context, true, addWaitlistRank);</span>
<span class="nc" id="L445">		} catch (BusinessWFOException e) {</span>
<span class="nc" id="L446">			logger.error(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L447">			throw e;</span>
<span class="nc" id="L448">		} catch (RmHardValidationException ex) {</span>
<span class="nc" id="L449">			throw RmUtils.handleFacadeException(context, ex, logger);</span>
<span class="nc" id="L450">		} catch (Exception e) {</span>
<span class="nc" id="L451">			logger.error(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L452">			throw new SystemWFOException(e.getLocalizedMessage());</span>
<span class="nc" id="L453">		}</span>

<span class="nc" id="L455">		return reqEntity;</span>
	}

	///////////////////////////////////////////////////////////////////////////

	@Override
	public TimeOffRequestEntity processTimeOffRequest(RequestContext context, ID reqId, int actionCode, String comment)
			throws WFOException {
		try {
<span class="nc" id="L464">			m_context = context;</span>
<span class="nc" id="L465">			final boolean addWaitlistRank = true;</span>

<span class="nc" id="L467">			TORequest toReq = TimeOffRequestsMH.getTORequest(reqId);</span>

<span class="nc bnc" id="L469" title="All 2 branches missed.">			if (ActionCode.APPROVE.getActionCode() == actionCode) {</span>
<span class="nc" id="L470">				Collection&lt;ID&gt; choiceIds = Collections.singleton(toReq.getFirstTOChoice().getID());</span>
<span class="nc" id="L471">				TimeOffRequestsMH.approveTORequests(reqId, choiceIds, toReq.getObjectVersionNumber(), comment);</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">			} else if (ActionCode.TENTATIVELYAPPROVE.getActionCode() == actionCode) {</span>
<span class="nc" id="L473">				TimeOffRequestsMH.tentativelyApproveTORequest(reqId, toReq.getFirstTOChoice().getID(), toReq.getObjectVersionNumber(),</span>
						comment);
<span class="nc bnc" id="L475" title="All 2 branches missed.">			} else if (ActionCode.DENY.getActionCode() == actionCode) {</span>
<span class="nc" id="L476">				TimeOffRequestsMH.denyTORequest(reqId, toReq.getObjectVersionNumber(), comment);</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">			} else if (ActionCode.ADDTOWAITLIST.getActionCode() == actionCode) {</span>
<span class="nc" id="L478">				Pair&lt;Boolean, String&gt; pair = TimeOffRequestsMH.addRequestToWaitlist(context, reqId, comment, toReq.getExpirationDate());</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">				if (!pair.getFirst().booleanValue()) {</span>
<span class="nc" id="L480">					throw new BusinessWFOException(pair.getSecond().toString(), Response.Status.CONFLICT);</span>
				}
<span class="nc bnc" id="L482" title="All 2 branches missed.">			} else if (ActionCode.WITHDRAW.getActionCode() == actionCode) {</span>
<span class="nc" id="L483">				Pair&lt;Boolean, String&gt; pair = TimeOffRequestsMH.requestWithdrawOfApprovedRequest(toReq,Request.REQUESTTYPE_TIMEOFF,</span>
						 RequestAuditTrail.STATUS_WITHDRAWN, comment);
<span class="nc bnc" id="L485" title="All 2 branches missed.">				if (!pair.getFirst().booleanValue()) {</span>
<span class="nc" id="L486">					throw new BusinessWFOException(pair.getSecond(), Response.Status.CONFLICT);</span>
				}
<span class="nc bnc" id="L488" title="All 2 branches missed.">			} else if (ActionCode.ESCALATE.getActionCode() == actionCode) {</span>
<span class="nc" id="L489">				RequestsMH.changeRequestStatus(reqId, Request.REQUESTTYPE_TIMEOFF, toReq.getObjectVersionNumber(),</span>
						RequestAuditTrail.STATUS_ESCALATED, comment);
<span class="nc bnc" id="L491" title="All 2 branches missed.">			} else if (ActionCode.CANCEL_WITHDRAWAL.getActionCode() == actionCode) {</span>
<span class="nc" id="L492">				Pair&lt;Boolean, String&gt; pair = TimeOffRequestsMH.cancelWithdrawOfApprovedRequest(context, reqId, comment);</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">				if (!pair.getFirst().booleanValue()) {</span>
<span class="nc" id="L494">					throw new BusinessWFOException(pair.getSecond(), Response.Status.CONFLICT);</span>
				}
<span class="nc" id="L496">			} else {</span>
<span class="nc" id="L497">				throw new BusinessWFOException(&quot;ActionCode not supported&quot;, Response.Status.CONFLICT);</span>
			}

<span class="nc" id="L500">			toReq = TimeOffRequestsMH.getTORequest(reqId);</span>
<span class="nc" id="L501">			Map&lt;ID, String&gt; activityIDNameMap = new HashMap&lt;ID, String&gt;();</span>
<span class="nc" id="L502">			return createTORequestEntity(toReq, activityIDNameMap, context, true, addWaitlistRank);</span>
<span class="nc" id="L503">		} catch (RmHardValidationException ex) {</span>
<span class="nc" id="L504">			throw RmUtils.handleFacadeException(context, ex, logger);</span>
<span class="nc" id="L505">		} catch (BusinessWFOException ex) {</span>
<span class="nc" id="L506">			logger.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L507">			throw ex;</span>
<span class="nc" id="L508">		} catch (Exception ex) {</span>
<span class="nc" id="L509">			logger.error(ex.getLocalizedMessage(), ex);</span>
<span class="nc" id="L510">			throw new SystemWFOException(ex.getLocalizedMessage());</span>
		}
	}

	@Override
	public ShiftAssignmentDetailData getShiftAssignmentDetail(ShiftAssignmentDetailRequestQuery query) {
		try {
<span class="nc" id="L517">			return this.getFlexTimeRequestsMH().getShiftAssignmentDetail(query.getContext(), query.getUserId(), query.getEmployeeId(), query.getFromDate());</span>
<span class="nc" id="L518">		} catch (Exception e) {</span>
<span class="nc" id="L519">			logger.info(&quot;TimeOffRequestFacadeImpl.getShiftAssignmentDetail(...): query[&quot; + query + &quot;]&quot;);</span>
<span class="nc" id="L520">			logger.error(&quot;TimeOffRequestFacadeImpl.getShiftAssignmentDetail(...)&quot;, e);</span>
		}

<span class="nc" id="L523">		return new ShiftAssignmentDetailData();</span>
	}

	@Override
	public TimeOffRequestEntity getRequest(RequestContext context, ID requestID) throws WFOException {
<span class="nc" id="L528">		TimeOffRequestEntity reqEntity = null;</span>
		try {
<span class="nc" id="L530">			TORequest request = TimeOffRequestsMH.getTORequest(requestID);</span>
<span class="nc" id="L531">			RmUtils.assertNotNull(context, request, requestID);</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">			if (!com.bluepumpkin.web.rm.requests.RequestUtil.isAuthToView(context, request)) {</span>
<span class="nc" id="L533">				RmUtils.throwUnauthorizedRequest(context);</span>
			}

<span class="nc" id="L536">			Map&lt;ID, String&gt; activityIDNameMap = new HashMap&lt;ID, String&gt;();</span>
<span class="nc" id="L537">			final boolean addWaitlistRank = true;</span>
<span class="nc" id="L538">			reqEntity = createTORequestEntity(request, activityIDNameMap, context, true, addWaitlistRank);</span>
<span class="nc" id="L539">		} catch (BusinessWFOException e) {</span>
<span class="nc" id="L540">			logger.error(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L541">			throw e;</span>
<span class="nc" id="L542">		} catch (RmHardValidationException ex) {</span>
<span class="nc" id="L543">			throw RmUtils.handleFacadeException(context, ex, logger);</span>
<span class="nc" id="L544">		} catch (Exception e) {</span>
<span class="nc" id="L545">			logger.error(e.getLocalizedMessage(), e);</span>
<span class="nc" id="L546">			throw new SystemWFOException(e.getLocalizedMessage());</span>
<span class="nc" id="L547">		}</span>

<span class="nc" id="L549">		return reqEntity;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>