<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AvaliableHoursValidationRule.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.timeoff.validation</a> &gt; <span class="el_source">AvaliableHoursValidationRule.java</span></div><h1>AvaliableHoursValidationRule.java</h1><pre class="source lang-java linenums">/*
 * AvaliableHoursValidationRule.java
 * Copyright (c) 2002, Blue Pumpkin Software, Inc.
 * All rights reserved.
 */

package com.bluepumpkin.ejb.rm.requests.timeoff.validation;

import java.util.Collection;
import java.util.Date;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validatable;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResultAggregator;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidatorForMultiChoice;
import com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.TimeOffIntervalAllocationUtil;
import com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.ejb.TimeOffRequestChoiceSegment;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOChoice;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.util.RmUtil;
import com.bluepumpkin.ejb.rm.util.TOCalendarUtil;
import com.bluepumpkin.ejb.rm.util.TORequestUtil;

/**
 * Rule in UI: Time Off Pool has available time off hours.
 * &lt;p/&gt;
 * Check if enough time off hours are available for each day of each TOChoce.
 * Available hours for each day is the difference between the allocated TO hours
 * for that day (in the TO allocation calendar) and already used TO hours for
 * that day.
 * &lt;p/&gt;
 * Calculate available time off hours for each &quot;bucket&quot; (i.e. organization,
 * day, optional team or shift start, etc....) during the request time interval.
 * Check if there are enough available hours for the requested time off in each
 * bucket.
 * &lt;p/&gt;
 * &lt;p/&gt;
 * For &quot;debit and debit-if&quot; timeoff types, use time off lengths and spread them across days if necessary.
 * Approved debit requests must use persisted length values. &lt;br&gt;
 * For &quot;don't debit&quot; timeoff type, TORequest does not suport time off lengths, so this rule does not apply.
 * &lt;p/&gt;
 * &lt;p/&gt;
 * Applies equally for tentative and non tentative requests as only events from the published schedule
 * are used.
 * &lt;p/&gt;
 */
<span class="nc" id="L53">public class AvaliableHoursValidationRule implements ValidatorForMultiChoice {</span>
<span class="nc" id="L54">	private static final String CLASSNAME = AvaliableHoursValidationRule.class.getName();</span>

<span class="nc" id="L56">	private static final Category LOG = Log.initCategory(CLASSNAME);</span>

	DailyTimeOffPoolHasAvailableHoursValidation dailyPoolValidator;
	
	
	@Override
	public ValidationResult validateForMultiChoice(Validatable validatable) throws Exception {
<span class="nc" id="L63">		return validate(validatable);</span>
	}


	@Override
	public ValidationResult validate(Validatable request) throws Exception {
<span class="nc" id="L69">		TORequest toRequest = (TORequest) request;</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">		if (toRequest.isUnavailability()) {</span>
<span class="nc" id="L71">			return null;</span>
		}
<span class="nc" id="L73">		return validateAvailableHours(toRequest);</span>
	}
	
	
	
	

	ValidationResult validateAvailableHours(TORequest request) throws Exception { // NOSONAR

		// RM License allows interval  and daily pools
<span class="nc" id="L83">		boolean useIntervalPool = TORequestUtil.isUseIntervalTOPool(request);</span>
<span class="nc" id="L84">		boolean useDailyPool = usesDailyPool(request);</span>

<span class="nc bnc" id="L86" title="All 4 branches missed.">		if (!useIntervalPool &amp;&amp; !useDailyPool) {</span>
<span class="nc" id="L87">			return null;</span>
		}

<span class="nc" id="L90">		ValidationResultAggregator result = new ValidationResultAggregator();</span>
<span class="nc" id="L91">		Date start = request.getCache().getDateRange().getStartDate();</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">		if (request.getCache().getTOPool(start) == null) {</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">			for (TOChoice choice : request.getTOChoicesAdjustedForValidation()) {</span>
<span class="nc" id="L94">				result.add(ValidationUtil.setSoftValidationResult(choice, RmEjbBundleKey.TO_POOL_NOT_ASSIGNED, request.getCache()</span>
<span class="nc" id="L95">						.getEmployeeNameByID(), choice.getStartDate(), choice.getEndDate(), CLASSNAME));</span>
<span class="nc" id="L96">			}</span>

<span class="nc" id="L98">			return result.get();</span>
		}

<span class="nc bnc" id="L101" title="All 2 branches missed.">		if (useIntervalPool) {</span>
<span class="nc" id="L102">			result.add(checkAvailableHoursForIntervalPool(request));</span>
		}

		// Now test daily
<span class="nc bnc" id="L106" title="All 2 branches missed.">		if (useDailyPool) { // NOSONAR</span>
			
<span class="nc bnc" id="L108" title="All 2 branches missed.">			if (dailyPoolValidator == null) {</span>
<span class="nc" id="L109">				dailyPoolValidator = new DailyTimeOffPoolHasAvailableHoursValidation();</span>
			}
<span class="nc" id="L111">			result.add(dailyPoolValidator.validate(request));</span>
		}

<span class="nc" id="L114">		return result.get();</span>

	}
	
	boolean usesDailyPool(TORequest request) throws Exception {
<span class="nc" id="L119">		boolean useDailyPool = TORequestUtil.isUseDailyTOPool(request);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">		if (!useDailyPool) {</span>
<span class="nc" id="L121">			return false;</span>
		}
		
		//If we got here then the request uses a daily pool activity, but we need to check if it is an time off allotment activity
<span class="nc bnc" id="L125" title="All 2 branches missed.">		if(!TOCalendarUtil.useOnlyAllotmentActivities()) {</span>
<span class="nc" id="L126">			return useDailyPool;</span>
		}
		
<span class="nc" id="L129">		ID activity = request.getTimeOffType();</span>
<span class="nc" id="L130">		Collection&lt;ID&gt; allotmentActivities = TOCalendarUtil.getListOfDailyPoolAllotmentActivities(activity);</span>
<span class="nc" id="L131">		return allotmentActivities.contains(request.getTimeOffType());</span>
	}


	
	// Interval pools have allocation by intervals
	ValidationResult checkAvailableHoursForIntervalPool(TORequest request) throws Exception { // NOSONAR

<span class="nc" id="L139">		String methodName = &quot;checkAvailableHoursForIntervalPool&quot;;</span>
<span class="nc" id="L140">		logEnter(methodName, request);</span>

<span class="nc" id="L142">		Map&lt;Integer, TimeOffRequestChoiceSegment&gt; listOfIntervalFailures = TimeOffIntervalAllocationUtil.checkAllocation(request);</span>

		
<span class="nc bnc" id="L145" title="All 4 branches missed.">		if (listOfIntervalFailures == null || listOfIntervalFailures.isEmpty()) {</span>
<span class="nc" id="L146">			logExit(methodName, &quot;&quot;);</span>
<span class="nc" id="L147">			return null;</span>
		}

<span class="nc" id="L150">		ValidationResult result = null;</span>

<span class="nc bnc" id="L152" title="All 2 branches missed.">		for (TOChoice choice : request.getTOChoicesAdjustedForValidation()) {</span>

<span class="nc" id="L154">			Date choiceStartDate = choice.getStartDate();</span>
<span class="nc" id="L155">			Date choiceEndDate = choice.getEndDate();</span>

<span class="nc bnc" id="L157" title="All 2 branches missed.">			if (listOfIntervalFailures.containsKey(choice.getID().toInt())) {</span>
<span class="nc" id="L158">				TimeOffRequestChoiceSegment failedSeg = listOfIntervalFailures.get(choice.getID().toInt());</span>

				// Build validation result, store in choice.
<span class="nc" id="L161">				result = ValidationUtil.setSoftValidationResult(choice,</span>
						RmEjbBundleKey.TIMEOFFINTERVALALLOCATION_NOT_ENOUGH_AVAILABLE_HOURS, request
<span class="nc" id="L163">						.getCache().getEmployeeNameByID(), choiceStartDate, choiceEndDate, request.getCache().getTOPool(failedSeg.getStart()).getName(),</span>
<span class="nc" id="L164">						failedSeg.getStart(), CLASSNAME);</span>
			}

<span class="nc" id="L167">		}</span>
		
<span class="nc" id="L169">		logExit(methodName, &quot;&quot;);</span>
<span class="nc" id="L170">		return result;</span>

	}

	private void logEnter(String methodName,Object obj){
<span class="nc bnc" id="L175" title="All 2 branches missed.">		if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L176">			LOG.debug(RmUtil.dumpEnterMethod(methodName, obj));</span>
		}
<span class="nc" id="L178">	}</span>
	
	private void logExit(String methodName, Object obj){
<span class="nc bnc" id="L181" title="All 2 branches missed.">		if (LOG.isDebugEnabled()){</span>
<span class="nc" id="L182">			LOG.debug(RmUtil.dumpExitMethod(methodName, obj));</span>
		}
<span class="nc" id="L184">	}</span>





}

	
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>