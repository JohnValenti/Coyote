<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffBidEmployeePeriodImportRH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.timeoffbid</a> &gt; <span class="el_source">TimeOffBidEmployeePeriodImportRH.java</span></div><h1>TimeOffBidEmployeePeriodImportRH.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.timeoffbid;

import java.text.ParseException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.StringTokenizer;

import javax.servlet.http.HttpServletRequest;

import org.apache.commons.fileupload.FileItem;

import weblogic.wsee.util.StringUtil;

import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.rm.setup.timeoffbid.model.TimeOffBidEmployee;
import com.bluepumpkin.web.bbm.l10n.BbmWebBundleKey;
import com.bluepumpkin.web.bbm.organization.OrganizationRequestHandler;
import com.bluepumpkin.web.rm.Log;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.l10n.RmWebLogBundleKey;
import com.bluepumpkin.web.rm.util.ImportExportUtil;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.base.WebException;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.IOUtil;
import com.witness.web.uif.util.reflection.ParameterUtil;

<span class="nc" id="L32">public class TimeOffBidEmployeePeriodImportRH extends OrganizationRequestHandler {</span>
<span class="fc" id="L33">	private static final Category log = Log.initCategory(TimeOffBidEmployeePeriodImportRH.class.getName());</span>

	/**
	 * Processes Request submitted from the AvailableTimeOff pages
	 *
	 * @param context The Request Context
	 */
	@Override
	public void processRequest(RequestContext context) throws WebException {
<span class="nc" id="L42">		TimeOffBidEmployeePeriodImportPopupPM model = new TimeOffBidEmployeePeriodImportPopupPM(context);</span>

		// get data from the request
<span class="nc" id="L45">		model.extractParameters(context.getRequest());</span>
<span class="nc" id="L46">		context.setPageModel(model);</span>

<span class="nc bnc" id="L48" title="All 2 branches missed.">		if (isAction(context, PageAction.IMPORT)) {</span>
			try {
<span class="nc" id="L50">				processUpload(model, context);</span>
<span class="nc" id="L51">			} catch (NumberFormatException ex) {</span>
<span class="nc" id="L52">				log.l7dError(RmWebLogBundleKey.UNABLE_TO_UPLOAD_DATA_FROM_FILE, ex);</span>
<span class="nc" id="L53">				model.addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.IMPORT_PERIOD_INVALID, RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L54">			} catch (Exception ex) {</span>
<span class="nc" id="L55">				log.l7dError(RmWebLogBundleKey.UNABLE_TO_UPLOAD_DATA_FROM_FILE, ex);</span>
<span class="nc" id="L56">				model.addPageMessage(Message.ERROR_TYPE, BbmWebBundleKey.UploadDataFailure, BbmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc" id="L57">			}</span>
		}
<span class="nc" id="L59">	}</span>

	/**
	 * Handles the request from the Import Dialog to update the maximum approve time off
	 * 
	 * @param model Employee Import Dialog
	 * @param context Web Context
	 * @throws ParseException File Parse Exception 
	 * @throws NumberFormatException Number Format Exception
	 * @throws Exception Exception
	 */
	public void processUpload(TimeOffBidEmployeePeriodImportPopupPM model, RequestContext context) throws NumberFormatException, Exception {
<span class="nc" id="L71">		Collection&lt;TimeOffBidEmployee&gt; notInBid = null;</span>
<span class="nc" id="L72">		final String tab = &quot;tab&quot;;</span>
<span class="nc" id="L73">		final String tabCharactor = &quot;\t&quot;;</span>
<span class="nc" id="L74">		final String carriageReturn = &quot;\r\n&quot;;</span>
<span class="nc" id="L75">		final String fileItem = &quot;file&quot;;</span>
<span class="nc" id="L76">		int firstNameIdx = 0;</span>
<span class="nc" id="L77">		int lastNameIdx = 0;</span>
<span class="nc" id="L78">		int count = 1;</span>

		try {
<span class="nc" id="L81">			HttpServletRequest request = context.getRequest();</span>
			@SuppressWarnings(&quot;rawtypes&quot;)
<span class="nc" id="L83">			Map fileMap = ParameterUtil.getExtractedFileMap(request);</span>
<span class="nc" id="L84">			Map paramMap = ParameterUtil.getParameterMap(request);</span>

<span class="nc" id="L86">			FileItem file = (FileItem) fileMap.get(fileItem);</span>
<span class="nc" id="L87">			String fileContent = IOUtil.readStringFromTextFile(file, 10 * 1024 * 1024, context);</span>

			// now process the info to save data
<span class="nc" id="L90">			String delimiter = model.getDelimiter();</span>
<span class="nc" id="L91">			int numLines = 0;</span>
<span class="nc" id="L92">			int colIndex = 0;</span>
<span class="nc" id="L93">			Collection&lt;TimeOffBidEmployee&gt; employees = new ArrayList&lt;TimeOffBidEmployee&gt;();</span>

			// Get the number of lines to skip
<span class="nc bnc" id="L96" title="All 2 branches missed.">			numLines = StringUtil.isEmpty(model.getNumLines()) ? 0 : parseString(model.getNumLines());</span>

			// Check for the Tab delimiter
<span class="nc bnc" id="L99" title="All 4 branches missed.">			if (delimiter == null || tab.equals(delimiter)) {</span>
<span class="nc" id="L100">				delimiter = tabCharactor;</span>
			}

<span class="nc" id="L103">			StringTokenizer aToken = new StringTokenizer(fileContent, carriageReturn);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">			while (aToken.hasMoreTokens()) {</span>
<span class="nc" id="L105">				String data = aToken.nextToken();</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">				if (count &gt; numLines) {</span>
<span class="nc" id="L107">					List&lt;String&gt; dataList = ImportExportUtil.parseData(data, delimiter);</span>

<span class="nc" id="L109">					TimeOffBidEmployee employee = new TimeOffBidEmployee();</span>

					// Last Name
<span class="nc" id="L112">					lastNameIdx = setLastName(dataList, employee, paramMap, TimeOffBidEmployeePeriodImportPopupPM.LAST_NAME_FN);</span>

					// First Name
<span class="nc" id="L115">					firstNameIdx = setFirstName(dataList, employee, paramMap, TimeOffBidEmployeePeriodImportPopupPM.FIRST_NAME_FN);</span>

					// Period
<span class="nc" id="L118">					setPeriod(dataList, employee, paramMap, TimeOffBidEmployeePeriodImportPopupPM.PERIOD_TIME_FN, model.getImportUnitType());</span>

					// Period Type (Unit)
<span class="nc" id="L121">					employee.setPeriodType(parseString(model.getImportUnitType()));</span>

					// Time Off Bid ID (Unit)
<span class="nc" id="L124">					employee.setTimeOffBidID(parseString(model.getTimeOffBidID()));</span>

					// Add to the collection
<span class="nc" id="L127">					employees.add(employee);</span>
<span class="nc" id="L128">				} else {</span>
<span class="nc" id="L129">					count++;</span>
				}
<span class="nc" id="L131">			}</span>

			// Update Bidders
<span class="nc" id="L134">			notInBid = TimeOffBidModelHandler.assignMaxApprovedTimeToBidder(employees);</span>
<span class="nc" id="L135">		} catch (NumberFormatException ex) {</span>
<span class="nc" id="L136">			throw ex;</span>
<span class="nc" id="L137">		} catch (Exception ex) {</span>
<span class="nc" id="L138">			throw ex;</span>
<span class="nc" id="L139">		}</span>

		// Check the number of objects returned from the update.
		// If greater then zero, those employees are not in the Bid.
		// Display an error message to alert the user. 
<span class="nc bnc" id="L144" title="All 2 branches missed.">		if (isAction(context, PageAction.IMPORT)) {</span>
<span class="nc" id="L145">			model.setPageDirty(false);</span>
<span class="nc" id="L146">			model.setIsRefreshOpenerOnClose(true);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">			if (notInBid.isEmpty()) {</span>
<span class="nc" id="L148">				model.setIsCloseAfterLoad(true);</span>
			} else {
<span class="nc" id="L150">				model.setIsCloseAfterLoad(false);</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">				processAssignmentResults(model, notInBid, firstNameIdx &lt; lastNameIdx);</span>
			}
		}
<span class="nc" id="L154">	}</span>

	/**
	 * Sets the employee last name gathered from the import data stream
	 * 
	 * @param dataList Data gathered from the imported file
	 * @param employee Employee object to store data from the import stream
	 * @param paramMap Map that contains the indexes for items in the import stream
	 * @param param Key to retrieve index to map to data in the import stream
	 * @return The index of the last name in the import stream
	 */
	protected int setLastName(List &lt;String&gt; dataList, TimeOffBidEmployee employee, Map paramMap, String param) {
<span class="nc" id="L166">		int colIndex = 0;</span>
<span class="nc" id="L167">		String str = &quot;&quot;;</span>
<span class="nc" id="L168">		final String negOne = &quot;-1&quot;;</span>
		
		try {
<span class="nc" id="L171">			colIndex = Integer.parseInt(ParameterUtil.getParameter(paramMap, param));</span>
<span class="nc" id="L172">			str = dataList.get(colIndex - 1);</span>
<span class="nc bnc" id="L173" title="All 4 branches missed.">			if (str != null &amp;&amp; !str.equals(negOne)) {</span>
<span class="nc" id="L174">				employee.setLastName(str);</span>
			}
<span class="nc" id="L176">		} catch (Exception e) {</span>
<span class="nc" id="L177">			log.debug(e);</span>
<span class="nc" id="L178">		}</span>
<span class="nc" id="L179">		return colIndex;</span>
	}
	
	/**
	 * Sets the employee first name gathered from the import data stream
	 * 
	 * @param dataList Data gathered from the imported file
	 * @param employee Employee object to store data from the import stream
	 * @param paramMap Map that contains the indexes for items in the import stream
	 * @param param Key to retrieve index to map to data in the import stream
	 * @return The index of the first name in the import stream
	 */
	protected int setFirstName(List &lt;String&gt; dataList, TimeOffBidEmployee employee, Map paramMap, String param) {
<span class="nc" id="L192">		int colIndex = 0;</span>
<span class="nc" id="L193">		String str = &quot;&quot;;</span>
<span class="nc" id="L194">		final String negOne = &quot;-1&quot;;</span>
		
		try {
<span class="nc" id="L197">			colIndex = Integer.parseInt(ParameterUtil.getParameter(paramMap, param));</span>
<span class="nc" id="L198">			str = dataList.get(colIndex - 1);</span>
<span class="nc bnc" id="L199" title="All 4 branches missed.">			if (str != null &amp;&amp; !str.equals(negOne)) {</span>
<span class="nc" id="L200">				employee.setFirstName(str);</span>
			}
<span class="nc" id="L202">		} catch (Exception e) {</span>
<span class="nc" id="L203">			log.debug(e);</span>
<span class="nc" id="L204">		}</span>
<span class="nc" id="L205">		return colIndex;</span>
	}
	
	/**
	 * Sets the employee period gathered from the import data stream
	 * 
	 * @param dataList Data gathered from the imported file
	 * @param employee Employee object to store data from the import stream
	 * @param paramMap Map that contains the indexes for items in the import stream
	 * @param param Key to retrieve index to map to data in the import stream
	 * @return The index of the period in the import stream
	 */
	protected int setPeriod(List &lt;String&gt; dataList, TimeOffBidEmployee employee, Map paramMap, String param, String unitType) {
<span class="nc" id="L218">		int colIndex = 0;</span>
<span class="nc" id="L219">		String str = &quot;&quot;;</span>
<span class="nc" id="L220">		final String negOne = &quot;-1&quot;;</span>
<span class="nc" id="L221">		final int maxDaysLeapYear = 366;</span>
<span class="nc" id="L222">		final int maxDays = 365;</span>
<span class="nc" id="L223">		final int maxWeeks = 52;</span>
		
		try {
<span class="nc" id="L226">			colIndex = Integer.parseInt(ParameterUtil.getParameter(paramMap, param));</span>
<span class="nc" id="L227">			str = dataList.get(colIndex - 1);</span>
<span class="nc bnc" id="L228" title="All 4 branches missed.">			if (str != null &amp;&amp; !str.equals(negOne)) {</span>
<span class="nc" id="L229">				int period = Integer.parseInt(str);</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">				if (Integer.parseInt(unitType) == TimeOffBidEmployeePeriodImportPopupPM.DAYS) {</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">					if (period &gt; maxDays) {</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">						if (TimeOffBidUtil.isLeapYear(-1)) {</span>
<span class="nc" id="L233">							employee.setMaxApprovePeriod(maxDaysLeapYear);</span>
						} else {
<span class="nc" id="L235">							employee.setMaxApprovePeriod(maxDays);</span>
						}
<span class="nc bnc" id="L237" title="All 2 branches missed.">					} else if (period &lt; 0) {</span>
<span class="nc" id="L238">						employee.setMaxApprovePeriod(0);</span>
					} else {
<span class="nc" id="L240">						employee.setMaxApprovePeriod(period);</span>
					}
				} else {
<span class="nc bnc" id="L243" title="All 2 branches missed.">					if (period &gt; maxWeeks) {</span>
<span class="nc" id="L244">						employee.setMaxApprovePeriod(maxWeeks);</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">					} else if (period &lt; 0) {</span>
<span class="nc" id="L246">						employee.setMaxApprovePeriod(0);</span>
					} else {
<span class="nc" id="L248">						employee.setMaxApprovePeriod(period);</span>
					}
				}
			}
<span class="nc" id="L252">		} catch (Exception e) {</span>
<span class="nc" id="L253">			log.debug(e);</span>
<span class="nc" id="L254">			throw new NumberFormatException(e.getMessage());</span>
<span class="nc" id="L255">		}</span>
<span class="nc" id="L256">		return colIndex;</span>
	}
	
	/**
	 * Converts string data in to an int
	 * 
	 * @param data string to convert to an int
	 * @return int value derived from the data parameter
	 * @throws Exception Thrown if data can be converted to an int
	 */
	protected int parseString(String data) throws Exception {
		int result;
		
		try {
<span class="nc" id="L270">			result = Integer.parseInt(data);</span>
<span class="nc" id="L271">		} catch (Exception e) {</span>
<span class="nc" id="L272">			log.debug(e);</span>
<span class="nc" id="L273">			throw e;</span>
<span class="nc" id="L274">		}</span>
<span class="nc" id="L275">		return result;</span>
	}
	

	/**
	 * Process the returned employees that are not in the current bid and add them to an error message displayed to the user
	 * 
	 * @param model Employee Import Dialog
	 * @param notInBid Collection of employees that are not in the current bid
	 */
	protected void processAssignmentResults(TimeOffBidEmployeePeriodImportPopupPM model, Collection&lt;TimeOffBidEmployee&gt; notInBid, boolean firstNameFirst) {
<span class="nc" id="L286">		String args[] = new String[2];</span>
<span class="nc" id="L287">		String comma = &quot;, &quot;;</span>
<span class="nc" id="L288">		String semiColon = &quot;; &quot;;</span>
<span class="nc" id="L289">		String space = &quot; &quot;;</span>

<span class="nc" id="L291">		int idx = 0;</span>
<span class="nc" id="L292">		StringBuilder employeeNames = new StringBuilder();</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">		for (Iterator&lt;TimeOffBidEmployee&gt; it = notInBid.iterator(); it.hasNext();) {</span>
<span class="nc" id="L294">			TimeOffBidEmployee employee = it.next();</span>

			// Add a semicolon after the first name in the list if more than one.
<span class="nc bnc" id="L297" title="All 2 branches missed.">			if (idx != 0) {</span>
<span class="nc" id="L298">				employeeNames.append(semiColon);</span>
			}

			// Format Name based on the import sequence
<span class="nc bnc" id="L302" title="All 2 branches missed.">			if (firstNameFirst) {</span>
<span class="nc" id="L303">				employeeNames.append(employee.getFirstName()).append(space).append(employee.getLastName());</span>
			} else {
<span class="nc" id="L305">				employeeNames.append(employee.getLastName()).append(comma).append(employee.getFirstName());</span>
			}
<span class="nc" id="L307">			idx++;</span>
<span class="nc" id="L308">		}</span>

		// Add elements to the args
<span class="nc" id="L311">		args[0] = model.getTimeOffBidName();</span>
<span class="nc" id="L312">		args[1] = employeeNames.toString();</span>
<span class="nc" id="L313">		model.addPageMessage(Message.ERROR_TYPE, RmWebBundleKey.EMPLOYEES_NOT_IN_BID, RmWebBundleKey.BUNDLE_NAME, args);</span>
<span class="nc" id="L314">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>