<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RequestUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests</a> &gt; <span class="el_source">RequestUtil.java</span></div><h1>RequestUtil.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests;

import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.ResourceBundle;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.localization.Localizer;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.workresource.OrganizationScopeManagerProxy;
import com.bluepumpkin.ejb.bbm.workresource.model.EmployeeName;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.commonrequestmanager.model.RequestFilter;
import com.bluepumpkin.ejb.rm.requests.custshift.model.CustShiftReq;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.model.ShiftBidAuction;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequest;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.swap.withdraw.model.ShiftSwapWithdraw;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.requests.timeoff.validation.TimeOffChoiceContainsHoliday;
import com.bluepumpkin.ejb.rm.requests.timeoff.validation.TimeOffChoiceContainsOrgChange;
import com.bluepumpkin.ejb.rm.requests.timeoff.validation.TimeOffChoiceHasZeroLength;
import com.bluepumpkin.ejb.rm.requests.timeoff.withdraw.model.TOWithdraw;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.rm.auction.AuctionMH;
import com.bluepumpkin.web.rm.keys.RmPageAction;
import com.bluepumpkin.web.rm.l10n.RmWebBundleKey;
import com.bluepumpkin.web.rm.requests.filter.RequestsFilterBoxPC;
import com.bluepumpkin.web.rm.setup.validation.ValidationModelHandler;
import com.bluepumpkin.web.rm.validation.ValidationResources;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.base.Message;
import com.witness.web.uif.keys.ImageFileID;
import com.witness.web.uif.keys.PageAction;
import com.witness.web.uif.l10n.UIFWebBundleKey;
import com.witness.web.uif.pagecomponent.PageComponent;
import com.witness.web.uif.pagecomponent.message.MessagePC;
import com.witness.web.uif.pagemodel.PageModel;
import com.witness.web.uif.security.UserAuthorizationException;
import com.witness.web.uif.system.RequestContext;
import com.witness.web.uif.util.HtmlUtil;
import com.witness.web.uif.util.js.JSUtil;
import com.witness.web.uif.validator.InLengthRangeFieldValidator;

/**
 * Title:        RequestUtil
 * Description:  Utility class to provide useful methods to deal with Request
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc
 * @author       David Su, dsu
 * @version      1.0
 *
 * Created on September 17, 2002, 2:42 PM
 */
public final class RequestUtil {
	private static final String REQUEST_TYPE = &quot;RequestUtil_REQUEST_TYPE&quot;;
	private static final String SWAPBOARD_VIEW_MODE = &quot;RequestUtil_SWAPBOARD_VIEW_MODE&quot;;
<span class="nc" id="L73">	private static final String TO_CHOICE_LEN_ZERO_VAL_NAME = TimeOffChoiceHasZeroLength.class.getName();</span>
<span class="nc" id="L74">	private static final String TO_CHOICE_LEN_CONTAINS_HOL_VAL_NAME = TimeOffChoiceContainsHoliday.class.getName();</span>
<span class="nc" id="L75">	private static final String TO_CHOICE_CONTAINS_ORG_CHANGE_VAL_NAME = TimeOffChoiceContainsOrgChange.class.getName();</span>

	/** Creates a new instance of RequestUtil */
<span class="nc" id="L78">	private RequestUtil() {</span>
<span class="nc" id="L79">	}</span>

	/**
	 * Return Localized Action
	 */
	public static String getLocalizedAction(Localizer localizer, ResourceBundle bundle, String action) {
<span class="nc" id="L85">		String rbKey = null;</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">		if (PageAction.EDIT.equals(action)) {</span>
<span class="nc" id="L87">			rbKey = UIFWebBundleKey.EDIT;</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">		} else if (PageAction.SUBMIT_TO_MGR.equals(action)) {</span>
<span class="nc" id="L89">			rbKey = UIFWebBundleKey.SUBMIT_TO_MGR;</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">		} else if (PageAction.VIEW_DETAIL.equals(action)) {</span>
<span class="nc" id="L91">			rbKey = UIFWebBundleKey.VIEW_DETAIL;</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">		} else if (PageAction.DENY.equals(action)) {</span>
<span class="nc" id="L93">			rbKey = UIFWebBundleKey.DENY;</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">		} else if (PageAction.WITHDRAW.equals(action)) {</span>
<span class="nc" id="L95">			rbKey = UIFWebBundleKey.WITHDRAW;</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">		} else if (PageAction.WITHDRAW_NEGOTIATION.equals(action)) {</span>
<span class="nc" id="L97">			rbKey = UIFWebBundleKey.WITHDRAW;</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">		} else if (PageAction.APPROVE.equals(action)) {</span>
<span class="nc" id="L99">			rbKey = UIFWebBundleKey.APPROVE;</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">		} else if (PageAction.TENTATIVELY_APPROVE.equals(action)) {</span>
<span class="nc" id="L101">			rbKey = UIFWebBundleKey.TENTATIVELY_APPROVE;</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">		} else if (PageAction.VIEW_SCHEDULE.equals(action)) {</span>
<span class="nc" id="L103">			rbKey = UIFWebBundleKey.VIEW_SCHEDULE;</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">		} else if (PageAction.ESCALATE.equals(action)) {</span>
<span class="nc" id="L105">			rbKey = UIFWebBundleKey.ESCALATE;</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">		} else if (RmPageAction.ADD_TO_WAITLIST_ACTION.equals(action)) {</span>
			//use rmwebbundle here
<span class="nc" id="L108">			return localizer.i18n(localizer.getBundle(RmWebBundleKey.BUNDLE_NAME), RmWebBundleKey.ADD_TO_WAITLIST_ACTION);</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">		} else if (RmPageAction.ADD_TO_MAN_WAITLIST_ACTION.equals(action)) {</span>
			//use rmwebbundle here
<span class="nc" id="L111">			return localizer.i18n(localizer.getBundle(RmWebBundleKey.BUNDLE_NAME), RmWebBundleKey.ADD_TO_MAN_WAITLIST_ACTION);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">		} else if (PageAction.ACCEPT_WITHDRAW_ACTION.equals(action)) {</span>
<span class="nc" id="L113">			rbKey = UIFWebBundleKey.ACCEPT_WITHDRAW;</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">		} else if (PageAction.REJECT_WITHDRAW_ACTION.equals(action)) {</span>
<span class="nc" id="L115">			rbKey = UIFWebBundleKey.REJECT_WITHDRAW;</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">		} else if (PageAction.CANCEL_WITHDRAW_ACTION.equals(action)) {</span>
<span class="nc" id="L117">			rbKey = UIFWebBundleKey.CANCEL_WITHDRAW;</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">		}else if (PageAction.COPY.equals(action)) {</span>
			//use rmwebbundle here
<span class="nc" id="L120">			return localizer.i18n(localizer.getBundle(RmWebBundleKey.BUNDLE_NAME), RmWebBundleKey.COPY_TIMEOFF_CHOICES);</span>
		}
<span class="nc bnc" id="L122" title="All 2 branches missed.">		return rbKey != null ? localizer.i18n(bundle, rbKey) : action;</span>
	}

	/**
	 * Return true if Request Form Save Button is enabled for specified Request
	 */
	public static boolean isRequestFormSaveBtnEnabled(RequestAggregate request) {
		// Disable Save Button when Request is already Approved 
		// or Denied (QC 192700)
<span class="nc bnc" id="L131" title="All 2 branches missed.">		String status = request != null ? request.getRequestStatus() : null;</span>
<span class="nc bnc" id="L132" title="All 4 branches missed.">		return ! (RequestAuditTrail.STATUS_APPROVED.equals(status)||RequestAuditTrail.STATUS_DENIED.equals(status));</span>
	}

	/**
	 * Add Page Message to indicate that a request has been saved and its status
	 * is displayed
	 */
	public static void addSavedRequestMsg(RequestAggregate request, PageModel model) {
<span class="nc" id="L140">		addSavedRequestMsg(request.getRequestStatus(), model);</span>
<span class="nc" id="L141">	}</span>

	public static void addSavedRequestMsg(String s, PageModel model) {
<span class="nc" id="L144">		String[] imgLbl = getImgAndL10nDisplayForStatus(s, model.getLocalizer());</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">		String status = imgLbl == null ? &quot;-&quot; : imgLbl[1];</span>

<span class="nc" id="L147">		String[] args = new String[] { status };</span>
<span class="nc" id="L148">		model.addPageMessage(Message.INFO_TYPE, RmWebBundleKey.REQUEST_SAVED_WITH_STATUS, RmWebBundleKey.BUNDLE_NAME, args);</span>
<span class="nc" id="L149">	}</span>

	public static void cacheMyRequestType(RequestContext context, String type) {
<span class="nc" id="L152">		context.setAttribute(RequestContext.SESSION_SCOPE, REQUEST_TYPE, type);</span>
<span class="nc" id="L153">	}</span>

	public static String getCachedMyRequestType(RequestContext context) {
<span class="nc" id="L156">		return (String) context.getAttribute(RequestContext.SESSION_SCOPE, REQUEST_TYPE);</span>
	}

	public static void cacheSwapBoardViewMode(RequestContext context, String viewMode) {
<span class="nc" id="L160">		context.setUserProperty(SWAPBOARD_VIEW_MODE, viewMode);</span>
<span class="nc" id="L161">	}</span>

	public static String getCachedSwapBoardViewMode(RequestContext context) {
<span class="nc" id="L164">		return context.getUserProperty(SWAPBOARD_VIEW_MODE);</span>
	}

	/**
	 * Create Comment UI
	 */
	public static String createCommentUI(String name, String value, int cols, int rows, PageComponent pc, String label) {
<span class="nc" id="L171">		final int COMMENT_MAX_LEN = 200;</span>
<span class="nc" id="L172">		return createTextArea(name, value, cols, rows, COMMENT_MAX_LEN, pc, UIFWebBundleKey.COMMENTS, UIFWebBundleKey.BUNDLE_NAME, label);</span>
	}

	/**
	 * Create Comment UI
	 */
	public static String createCommentUI(String name, String value, int cols, int rows, PageComponent pc, boolean isReadOnly, String label) {
<span class="nc" id="L179">		final int COMMENT_MAX_LEN = 200;</span>
<span class="nc" id="L180">		return createTextArea(name, value, cols, rows, COMMENT_MAX_LEN, pc, UIFWebBundleKey.COMMENTS, UIFWebBundleKey.BUNDLE_NAME,</span>
				isReadOnly, label);
	}

	/**
	 * Create Text Area with Validation for length added
	 */
	public static String createTextArea(String name, String value, int cols, int rows, int maxLen, PageComponent pc, String rbKey,
			String rbName, String label) {
<span class="nc" id="L189">		return createTextArea(name, value, cols, rows, maxLen, pc, rbKey, rbName, false, label);</span>
	}

	/**
	 * Create Text Area with Validation for length added
	 */
	public static String createTextArea(String name, String value, int cols, int rows, int maxLen, PageComponent pc, String rbKey,
			String rbName, boolean isReadOnly, String label) {

<span class="nc" id="L198">		InLengthRangeFieldValidator validator = new InLengthRangeFieldValidator(pc, name, rbKey, rbName, 0, maxLen);</span>
<span class="nc" id="L199">		pc.addValidator(validator);</span>

<span class="nc" id="L201">		return HtmlUtil.makeTextAreaInput(name, cols, rows, JSUtil.ON_CHANGE, true, isReadOnly, false, value, label);</span>
	}

	/**
	 * Create MessagePC used to render comments
	 *
	 * @param context The Request Context
	 * @param width The with in pixel for the rendered component
	 * @param height The height in pixel for the rendered component
	 * @param css The Css used by the rendered component
	 */
	public static MessagePC createCmntMsgPC(RequestContext context, String width, String height, String css) {
<span class="nc" id="L213">		MessagePC msgPC = new MessagePC(context, &quot;rCmnts&quot;);</span>
<span class="nc" id="L214">		msgPC.setWidth(width);</span>
<span class="nc" id="L215">		msgPC.setHeight(height);</span>
<span class="nc" id="L216">		msgPC.setWrapperCSS(css);</span>
<span class="nc" id="L217">		msgPC.setMessageStyle(&quot;font-size:9px;&quot;);</span>
<span class="nc" id="L218">		msgPC.setMsgPreFmtEnabled(true);</span>
<span class="nc" id="L219">		return msgPC;</span>
	}

	/**
	 * Return Request Comments as Message objects
	 */
	public static Collection&lt;Message&gt; getCommentsAsMessages(RequestAggregate request) {
<span class="nc" id="L226">		Collection atList = request.getAuditTrail();</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">		if (atList.isEmpty()) {</span>
<span class="nc" id="L228">			return Collections.emptyList();</span>
		}

<span class="nc" id="L231">		ArrayList&lt;Message&gt; msgList = new ArrayList&lt;Message&gt;(atList.size());</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">		for (Iterator it = atList.iterator(); it.hasNext();) {</span>
<span class="nc" id="L233">			RequestAuditTrail rqt = (RequestAuditTrail) it.next();</span>
<span class="nc" id="L234">			Message msg = new Message(Message.INFO_TYPE, rqt.getNote());</span>
<span class="nc" id="L235">			msg.setIsHtmlCodeAllowed(true);</span>
<span class="nc" id="L236">			msgList.add(msg);</span>
<span class="nc" id="L237">		}</span>
<span class="nc" id="L238">		return msgList;</span>
	}

	/**
	 * Return String array where first element is the assocated image
	 * and second is the localizer status display.
	 *
	 * return null if invalid status;
	 */
	public static String[] getImgAndL10nDisplayForStatus(String status, Localizer localizer) {
<span class="nc" id="L248">		String[] result = new String[2];</span>
<span class="nc" id="L249">		ResourceBundle bundle = localizer.getBundle(RmWebBundleKey.BUNDLE_NAME);</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">		if (RequestAuditTrail.STATUS_PENDING.equals(status)) {</span>
<span class="nc" id="L251">			result[0] = ImageFileID.STATUS_PENDING;</span>
<span class="nc" id="L252">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_PENDING);</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">		} else if (RequestAuditTrail.STATUS_DENIED.equals(status)) {</span>
<span class="nc" id="L254">			result[0] = ImageFileID.STATUS_DENIED;</span>
<span class="nc" id="L255">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_DENIED);</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">		} else if (RequestAuditTrail.STATUS_WITHDRAWN.equals(status)) {</span>
<span class="nc" id="L257">			result[0] = ImageFileID.STATUS_WITHDRAWN;</span>
<span class="nc" id="L258">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_WITHDRAWN);</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">		} else if (RequestAuditTrail.STATUS_APPROVED.equals(status)) {</span>
<span class="nc" id="L260">			result[0] = ImageFileID.STATUS_APPROVED;</span>
<span class="nc" id="L261">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_APPROVED);</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">		} else if (RequestAuditTrail.STATUS_TENTATIVE.equals(status)) {</span>
<span class="nc" id="L263">			result[0] = ImageFileID.STATUS_TENTATIVELY_APPROVED;</span>
<span class="nc" id="L264">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_TENTATIVE);</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">		} else if (RequestAuditTrail.STATUS_NEGOTIATION.equals(status)) {</span>
<span class="nc" id="L266">			result[0] = ImageFileID.STATUS_IN_NEGOTIATION;</span>
<span class="nc" id="L267">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_NEGOTIATION);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">		} else if (RequestAuditTrail.STATUS_ESCALATED.equals(status)) {</span>
<span class="nc" id="L269">			result[0] = ImageFileID.STATUS_ESCALATED;</span>
<span class="nc" id="L270">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_ESCALATED);</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">		} else if (RequestFilter.EXPIRED_STATUS.equals(status)) {</span>
<span class="nc" id="L272">			result[0] = ImageFileID.STATUS_EXPIRED;</span>
<span class="nc" id="L273">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_EXPIRED);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">		} else if (RequestAuditTrail.STATUS_INVALID.equals(status)) {</span>
<span class="nc" id="L275">			result[0] = ImageFileID.STATUS_INVALID;</span>
<span class="nc" id="L276">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_INVALID);</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">		} else if (RequestAuditTrail.STATUS_WAITLIST.equals(status)) {</span>
<span class="nc" id="L278">			result[0] = ImageFileID.STATUS_WAITLIST;</span>
<span class="nc" id="L279">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_WAITLIST);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">		} else if (RequestAuditTrail.STATUS_WITHDRAW_REQUEST.equals(status)) {</span>
<span class="nc" id="L281">			result[0] = ImageFileID.STATUS_WITHDRAW_REQUEST;</span>
<span class="nc" id="L282">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_WITHDRAW_REQUEST);</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">		} else if (RequestAuditTrail.STATUS_WITHDRAW_REJECT.equals(status)) {</span>
<span class="nc" id="L284">			result[0] = ImageFileID.STATUS_WITHDRAW_REJECT;</span>
<span class="nc" id="L285">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_WITHDRAW_REJECT);</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">		} else if (RequestAuditTrail.STATUS_WITHDRAW_ACCEPT.equals(status)) {</span>
<span class="nc" id="L287">			result[0] = ImageFileID.STATUS_WITHDRAW_ACCEPT;</span>
<span class="nc" id="L288">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_WITHDRAW_ACCEPT);</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">		} else if (RequestAuditTrail.STATUS_WITHDRAW_CANCEL.equals(status)) {</span>
<span class="nc" id="L290">			result[0] = ImageFileID.STATUS_WITHDRAW_CANCEL;</span>
<span class="nc" id="L291">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_WITHDRAW_CANCEL);</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">		} else if (RequestAuditTrail.STATUS_WITHDRAW_NEGOTIATION.equals(status)) {</span>
<span class="nc" id="L293">			result[0] = ImageFileID.STATUS_WITHDRAW_NEGOTIATION;</span>
<span class="nc" id="L294">			result[1] = localizer.i18n(bundle, RmWebBundleKey.STATUS_WITHDRAW_NEGOTIATION);</span>
		} else {
<span class="nc" id="L296">			result = null;</span>
		}

<span class="nc" id="L299">		return result;</span>
	}

	/**
	 * Create Request Status Icon
	 */
	public static String createStatusIcon(String status, boolean isForAgent, Localizer localizer, RequestAggregate request) {
		// Agents don't see Tentative Status
<span class="nc bnc" id="L307" title="All 4 branches missed.">		if (isForAgent &amp;&amp; RequestAuditTrail.STATUS_TENTATIVE.equals(status)) {</span>
<span class="nc" id="L308">			status = RequestAuditTrail.STATUS_PENDING;</span>
		}

<span class="nc" id="L311">		String[] imgAndAltText = getImgAndL10nDisplayForStatus(status, localizer);</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">		if (imgAndAltText == null) {</span>
<span class="nc" id="L313">			return status;</span>
		}

<span class="nc" id="L316">		String src = imgAndAltText[0];</span>
<span class="nc" id="L317">		String alt = imgAndAltText[1];</span>
<span class="nc" id="L318">		String imgStr = HtmlUtil.imageTag(src, alt, true, true);</span>
<span class="nc bnc" id="L319" title="All 4 branches missed.">		if (request != null &amp;&amp; request.isTimeOffRequest()) {</span>
<span class="nc" id="L320">			TOWithdraw toWithdraw = ((TORequest) request).getWithdrawInfo();</span>
<span class="nc bnc" id="L321" title="All 4 branches missed.">			if (toWithdraw != null &amp;&amp; RequestAuditTrail.isRequestForWithdrawalStates(toWithdraw.getRequestStatus())) {</span>
<span class="nc" id="L322">				imgAndAltText = getImgAndL10nDisplayForStatus(toWithdraw.getRequestStatus(), localizer);</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">				if (imgAndAltText != null) {</span>
<span class="nc" id="L324">					src = imgAndAltText[0];</span>
<span class="nc" id="L325">					alt = imgAndAltText[1];</span>
<span class="nc" id="L326">					imgStr += &quot;&lt;BR&gt;&quot; + HtmlUtil.imageTag(src, alt, true, true);</span>
				}
			}
		}
<span class="nc bnc" id="L330" title="All 4 branches missed.">		if (request != null &amp;&amp; request.isShiftSwapRequest()) {</span>
<span class="nc" id="L331">			ShiftSwapWithdraw ssWithdraw = ((ShiftSwapRequest) request).getWithdrawInfo();</span>
<span class="nc bnc" id="L332" title="All 4 branches missed.">			if (ssWithdraw != null &amp;&amp; RequestAuditTrail.isRequestForWithdrawalStates(ssWithdraw.getRequestStatus())) {</span>
<span class="nc" id="L333">				imgAndAltText = getImgAndL10nDisplayForStatus(ssWithdraw.getRequestStatus(), localizer);</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">				if (imgAndAltText != null) {</span>
<span class="nc" id="L335">					src = imgAndAltText[0];</span>
<span class="nc" id="L336">					alt = imgAndAltText[1];</span>
<span class="nc" id="L337">					imgStr += &quot;&lt;BR&gt;&quot; + HtmlUtil.imageTag(src, alt, true, true);</span>
				}
			}
		}
<span class="nc" id="L341">		return imgStr;</span>
	}

	/**
	 * Convenience method to retrieve Employee ID from context.
	 *
	 * It adds Error Message specific to Request Pages
	 * to Model if Employee ID is not available.
	 */
	public static ID getEmpIDAndAddMsgIfNotAvailable(RequestContext context, PageModel model) {
<span class="nc" id="L351">		ID empID = context.getUser().getEmployeeID();</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">		if (empID == null) {</span>
<span class="nc" id="L353">			model.addPageMessage(Message.INFO_TYPE, UIFWebBundleKey.SCREEN_DISABLED_FOR_NON_EMP, UIFWebBundleKey.BUNDLE_NAME);</span>
		}
<span class="nc" id="L355">		return empID;</span>
	}

	/**
	 * Return Localized Date Display
	 */
	public static String getDateDisplay(RequestContext context, Date date) {
<span class="nc" id="L362">		Localizer localizer = context.getLocalizer();</span>
<span class="nc" id="L363">		TimeZone tz = context.getViewingTimeZone();</span>
<span class="nc" id="L364">		return localizer.formatDateTime(date, tz);</span>
	}

	/**
	 * Create Alert Icons with associated Message for the specified Validation results
	 */
	public static String createAlertIconsWithMsg(Collection&lt;ValidationResult&gt; validationResults, Localizer localizer, TimeZone tz) {
<span class="nc" id="L371">		StringBuilder sb = new StringBuilder(100);</span>
<span class="nc" id="L372">		Collection&lt;ValidationResult&gt; uniqueResults = getUniqueValidationResultsCollection(validationResults);</span>
<span class="nc bnc" id="L373" title="All 4 branches missed.">		if (uniqueResults == null || uniqueResults.isEmpty()) {</span>
<span class="nc" id="L374">			return sb.toString();</span>
		}

<span class="nc bnc" id="L377" title="All 2 branches missed.">		for (Iterator&lt;ValidationResult&gt; it = uniqueResults.iterator(); it.hasNext();) {</span>
<span class="nc" id="L378">			ValidationResult vr = it.next();</span>
<span class="nc" id="L379">			String alertIcon = createAlertIcon(vr, localizer, true, true);</span>
<span class="nc" id="L380">			String vrMsg = vr.getLocalizedMessage(localizer, tz);</span>

<span class="nc" id="L382">			sb.append(alertIcon).append(&quot; &quot;).append(vrMsg);</span>
<span class="nc" id="L383">			sb.append(&quot;&amp;nbsp;&lt;br&gt;&quot;);</span>
<span class="nc" id="L384">		}</span>

<span class="nc" id="L386">		return sb.toString();</span>
	}

	/**
	 * Create Unique Alert Icons for the specified Validation results.
	 *
	 * If there are two Validation result of the same type, it will only generate
	 * a single alert icon for them.
	 */
	public static String createUniqueAlertIcons(RequestAggregate request, Localizer localizer) {
<span class="nc" id="L396">		return createUniqueAlertIcons(request, localizer, false, false);</span>
	}

	/**
	 * Create Unique Alert Icons for the specified Validation results.
	 *
	 * If there are two Validation result of the same type, it will only generate
	 * a single alert icon for them.
	 */
	public static String createUniqueAlertIcons(RequestAggregate request, Localizer localizer, boolean isTabbable, boolean useAriaTooltip) {
		// Create list of unique validator's
<span class="nc" id="L407">		Collection&lt;ValidationResult&gt; uniqueValidationResults = getUniqueValidationResultsCollection(</span>
<span class="nc" id="L408">				request.getValidationResults(true));</span>

<span class="nc bnc" id="L410" title="All 4 branches missed.">		if (uniqueValidationResults == null || uniqueValidationResults.isEmpty()) {</span>
<span class="nc" id="L411">			return &quot;&quot;;</span>
		}
<span class="nc" id="L413">		String alerts = createAlertIcons(uniqueValidationResults, localizer, isTabbable, useAriaTooltip);</span>
<span class="nc bnc" id="L414" title="All 4 branches missed.">		if (alerts != null &amp;&amp; request.isTimeOffRequest() &amp;&amp;</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">				(((TORequest) request).isEligibleForAcceptWithdrawAction() ||</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">						((TORequest) request).isEligibleForRejectWithdrawAction())) {</span>
<span class="nc" id="L417">			alerts = createIconButton(ImageFileID.BLANK_SPACER, null, null) + &quot;&lt;BR&gt;&quot; + alerts;</span>
		}
<span class="nc" id="L419">		return alerts;</span>
	}

	public static Collection&lt;ValidationResult&gt; getUniqueValidationResultsCollection(
			Collection&lt;ValidationResult&gt; validationResults) {

<span class="nc bnc" id="L425" title="All 4 branches missed.">		if (validationResults == null || validationResults.isEmpty()) {</span>
<span class="nc" id="L426">			return Collections.emptyList();</span>
		}


<span class="nc" id="L430">		Map&lt;String, ValidationResult&gt; map = new LinkedHashMap&lt;&gt;();</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">		for (ValidationResult vr : validationResults) {</span>

<span class="nc bnc" id="L433" title="All 2 branches missed.">			if (map.containsKey(vr.getValidatorName())) {</span>
<span class="nc" id="L434">				continue;</span>
			}
<span class="nc" id="L436">			map.put(vr.getValidatorName(), vr);</span>
<span class="nc" id="L437">		}</span>

<span class="nc" id="L439">		return map.values();</span>
	}

	protected static String createIconButton(String src, String alt, String onClickJS) {
<span class="nc" id="L443">		return &quot;&lt;span class=\&quot;itemActionWpr\&quot;&gt;&lt;span class=\&quot;itemAction\&quot;&gt;&quot;</span>
<span class="nc" id="L444">				+ HtmlUtil.imageTag(null, src, null, null, alt, null, onClickJS, true) + &quot;&lt;/span&gt;&lt;/span&gt;&quot;;</span>
	}

	/**
	 * Create Alert Icons for the specified Validation results
	 */
	public static String createAlertIcons(Collection&lt;ValidationResult&gt; validationResults, Localizer localizer) {
<span class="nc" id="L451">		return createAlertIcons(validationResults, localizer, false, false);</span>
	}
	
	/**
	 * Create Alert Icons for the specified Validation results
	 */
	public static String createAlertIcons(Collection&lt;ValidationResult&gt; validationResults, Localizer localizer,
			boolean isTabbable, boolean useAriaTooltip) {
<span class="nc" id="L459">		StringBuilder sb = new StringBuilder(100);</span>

<span class="nc" id="L461">		sb.append(&quot;&lt;nobr&gt;&quot;);</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">		for (Iterator&lt;ValidationResult&gt; it = validationResults.iterator(); it.hasNext();) {</span>
<span class="nc" id="L463">			ValidationResult vr = it.next();</span>
<span class="nc" id="L464">			String alertIcon = createAlertIcon(vr, localizer, isTabbable, useAriaTooltip);</span>
<span class="nc" id="L465">			sb.append(alertIcon);</span>
<span class="nc" id="L466">		}</span>
<span class="nc" id="L467">		sb.append(&quot;&amp;nbsp;&lt;/nobr&gt;&quot;);</span>

<span class="nc" id="L469">		return sb.toString();</span>
	}
	
	public static String createAlertIcons(RequestAggregate request, Localizer localizer, boolean isTabbable, boolean useAriaTooltip) {
<span class="nc" id="L473">		Collection&lt;ValidationResult&gt; validationResults = getUniqueValidationResultsCollection(request.getValidationResults(true));</span>
<span class="nc" id="L474">		return createAlertIcons(validationResults, localizer, isTabbable, useAriaTooltip);</span>
	}

	/**
	 * Create Alert Icon for specified Validation Result
	 */
	public static String createAlertIcon(ValidationResult vr, Localizer localizer) {
<span class="nc" id="L481">		return createAlertIcon(vr, localizer, false, false);</span>
	}
	
	/**
	 * Create Alert Icon for specified Validation Result
	 */
	public static String createAlertIcon(ValidationResult vr, Localizer localizer, boolean isTabbable, boolean useAriaTooltip) {
<span class="nc" id="L488">		String validatorName = vr.getValidatorName();</span>
<span class="nc" id="L489">		String[] imgStrs = getImgStrings(validatorName, localizer);</span>
<span class="nc" id="L490">		String imgSrc = null;</span>
<span class="nc" id="L491">		String imgAlt = getImgAltOfSpecialRules(vr,localizer);</span>

<span class="nc bnc" id="L493" title="All 2 branches missed.">		if(!StringUtil.isEmpty(imgAlt)){</span>
			//Since special rules have similar hard validation rules when creating so it should so it should show red color to have consistency
<span class="nc" id="L495">			imgSrc =ImageFileID.ALERT_RED;</span>
		} else{
<span class="nc bnc" id="L497" title="All 2 branches missed.">			if (vr.isSoft()) {</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">				if (imgStrs == null) {</span>
<span class="nc" id="L499">					return &quot;[ERROR] - No Validation Resources found for validator:'&quot; + validatorName + &quot;'.&quot;;</span>
				} else {
<span class="nc" id="L501">					imgSrc = imgStrs[0];</span>
<span class="nc" id="L502">					imgAlt = imgStrs[1];</span>
				}
			}
		}
<span class="nc bnc" id="L506" title="All 4 branches missed.">		if (imgSrc != null &amp;&amp; imgAlt != null) {</span>
<span class="nc" id="L507">			return &quot;&lt;span class=\&quot;itemAlertWpr\&quot;&gt;&lt;span class=\&quot;itemAlert\&quot;&gt;&quot; +</span>
<span class="nc" id="L508">					HtmlUtil.imageTag(imgSrc, imgAlt, isTabbable, useAriaTooltip) + &quot;&lt;/span&gt;&lt;/span&gt;&quot;;</span>
		} else {
<span class="nc" id="L510">			return &quot;&quot;;</span>
		}
	}

	private static String getImgAltOfSpecialRules(ValidationResult vr,Localizer localizer){
<span class="nc" id="L515">		String imgAlt = null;</span>
<span class="nc" id="L516">		boolean toBidChoiceViolateMinPeriod = vr.getMessageResource().equals(</span>
				RmEjbBundleKey.TIMEOFF_BID_TOCHOICE_VIOLATE_MIN_PERIOD_VALUE);
<span class="nc bnc" id="L518" title="All 2 branches missed.">		if (toBidChoiceViolateMinPeriod) {</span>
<span class="nc" id="L519">			imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME,</span>
					RmWebBundleKey.TIMEOFF_BID_TOCHOICE_VIOLATE_MIN_PERIOD_VALUE_VALIDATION_MSG);
		}
<span class="nc" id="L522">		boolean toBidChoiceViolateMaxPeriod = vr.getMessageResource().equals(</span>
				RmEjbBundleKey.TIMEOFF_BID_TOCHOICE_VIOLATE_MAX_PERIOD_VALUE);
<span class="nc bnc" id="L524" title="All 2 branches missed.">		if (toBidChoiceViolateMaxPeriod) {</span>
<span class="nc" id="L525">			imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME,</span>
					RmWebBundleKey.TIMEOFF_BID_TOCHOICE_VIOLATE_MAX_PERIOD_VALUE_VALIDATION_MSG);
		}
<span class="nc bnc" id="L528" title="All 2 branches missed.">		boolean toContainedInSchedule = vr.getMessageResource() != null ? vr.getMessageResource().equals(</span>
				RmEjbBundleKey.TO_CONTAINED_IN_SCHEDTO) : false;
<span class="nc bnc" id="L530" title="All 2 branches missed.">		if (toContainedInSchedule) {</span>
<span class="nc" id="L531">			imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TO_CONTAINED_IN_SCHEDTO_VALIDATION_MSG);</span>
		}
<span class="nc" id="L533">		boolean toChoiceBeforeEmpStart = vr.getMessageResource().equals(RmEjbBundleKey.TO_TIMEOFF_BEFORE_START);</span>

<span class="nc bnc" id="L535" title="All 2 branches missed.">		if (toChoiceBeforeEmpStart) {</span>
<span class="nc" id="L536">			imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TO_TIMEOFF_BEFORE_START_VALIDATION_MSG);</span>
		}
<span class="nc" id="L538">		boolean toChoiceAfterEmpEnd = vr.getMessageResource().equals(RmEjbBundleKey.TO_TIMEOFF_AFTER_TERM);</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">		if (toChoiceAfterEmpEnd) {</span>
<span class="nc" id="L540">			imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TO_TIMEOFF_AFTER_TERM_VALIDATION_MSG);</span>
		}
<span class="nc" id="L542">		return imgAlt;</span>
	}

	public static String[] getImgStrings(String validatorName, Localizer localizer) {
		String imgSrc;
		String imgAlt;

<span class="nc bnc" id="L549" title="All 2 branches missed.">		if (TO_CHOICE_LEN_ZERO_VAL_NAME.equals(validatorName)) {</span>
<span class="nc" id="L550">			imgSrc = ImageFileID.ALERT_YELLOW;</span>
<span class="nc" id="L551">			imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TO_CHOICE_HAS_ZERO_LEN);</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">		} else if (TO_CHOICE_LEN_CONTAINS_HOL_VAL_NAME.equals(validatorName)) {</span>
<span class="nc" id="L553">			imgSrc = ImageFileID.ALERT_YELLOW;</span>
<span class="nc" id="L554">			imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TO_CHOICE_CONTAINS_HOLIDAY);</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">		} else if (TO_CHOICE_CONTAINS_ORG_CHANGE_VAL_NAME.equals(validatorName)) {</span>
<span class="nc" id="L556">			imgSrc = ImageFileID.ALERT_YELLOW;</span>
<span class="nc" id="L557">			imgAlt = localizer.i18n(RmWebBundleKey.BUNDLE_NAME, RmWebBundleKey.TO_CHOICE_CONTAINS_ORG_CHANGE);</span>
		} else {
<span class="nc" id="L559">			ValidationResources vrs = ValidationModelHandler.getValidationResource(validatorName);</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">			if (vrs == null) {</span>
<span class="nc" id="L561">				return null;</span>
			}

<span class="nc" id="L564">			imgSrc = vrs.getIconPath(localizer);</span>
<span class="nc" id="L565">			imgAlt = vrs.getErrorMessage(localizer);</span>
		}

<span class="nc" id="L568">		return new String[] { imgSrc, imgAlt };</span>
	}

	/**
	 * Return True if Authorized to Update Request
	 */
	public static boolean isAuthToUpdate(RequestContext context, RequestAggregate request) throws RemoteException, BbmException {
<span class="nc" id="L575">		boolean isAuth = false;</span>

<span class="nc bnc" id="L577" title="All 2 branches missed.">		if (request instanceof TORequest) {</span>
<span class="nc" id="L578">			isAuth = isAuthorized(context, (TORequest) request, true);</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">		} else if (request instanceof ShiftSwapRequest) {</span>
<span class="nc" id="L580">			isAuth = isAuthorized(context, (ShiftSwapRequest) request, true);</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">		} else if (request instanceof ShiftBidRequest) {</span>
<span class="nc" id="L582">			isAuth = isAuthorized(context, (ShiftBidRequest) request, true);</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">		} else if (request instanceof CustShiftReq) {</span>
<span class="nc" id="L584">			isAuth = isAuthorized(context, (CustShiftReq) request, true);</span>
		}

<span class="nc" id="L587">		return isAuth;</span>
	}

	/**
	 * Return True if Authorized to Update Request
	 */
	public static boolean isAuthToView(RequestContext context, RequestAggregate request) throws RemoteException, BbmException {
<span class="nc" id="L594">		boolean isAuth = false;</span>

<span class="nc bnc" id="L596" title="All 2 branches missed.">		if (request instanceof TORequest) {</span>
<span class="nc" id="L597">			isAuth = isAuthorized(context, (TORequest) request, false);</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">		} else if (request instanceof ShiftSwapRequest) {</span>
<span class="nc" id="L599">			isAuth = isAuthorized(context, (ShiftSwapRequest) request, false);</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">		} else if (request instanceof ShiftBidRequest) {</span>
<span class="nc" id="L601">			isAuth = isAuthorized(context, (ShiftBidRequest) request, false);</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">		} else if (request instanceof CustShiftReq) {</span>
<span class="nc" id="L603">			isAuth = isAuthorized(context, (CustShiftReq) request, false);</span>
		}

<span class="nc" id="L606">		return isAuth;</span>
	}

	/**
	 * Verify whether user is authorized to access the request
	 *
	 * It also adds error message to context if user is not authorized.
	 */
	public static boolean isAuthorized(RequestContext context, TORequest request, boolean isUpdate) throws RemoteException, BbmException {
<span class="nc" id="L615">		boolean isAuthorized = false;</span>

<span class="nc" id="L617">		User user = context.getUser();</span>
<span class="nc" id="L618">		boolean isMyRequest = isMyRequest(user, request);</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">		if (isMyRequest) {</span>
			ID privID;
<span class="nc bnc" id="L621" title="All 2 branches missed.">			if (!request.isFlexTimeRequest()) {</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">				privID = isUpdate ? PrivilegeKeys.TOM_MODIFYPERSONALREQUESTS_ID : PrivilegeKeys.TOM_VIEWPERSONALREQUESTS_ID;</span>
			} else {
<span class="nc bnc" id="L624" title="All 2 branches missed.">				privID = isUpdate ? PrivilegeKeys.FT_MODIFYPERSONALREQUESTS_ID : PrivilegeKeys.FT_VIEWPERSONALREQUESTS_ID;</span>
			}
<span class="nc" id="L626">			isAuthorized = user.isAuthorized(privID);</span>
<span class="nc" id="L627">		} else {</span>
			ID privID;
<span class="nc bnc" id="L629" title="All 2 branches missed.">			if (!request.isFlexTimeRequest()) {</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">				privID = isUpdate ? PrivilegeKeys.TOM_MODIFYREQUESTSFOREMPLOYEE_ID : PrivilegeKeys.TOM_VIEWREQUESTSFOREMPLOYEE_ID;</span>
			} else {
<span class="nc bnc" id="L632" title="All 2 branches missed.">				privID = isUpdate ? PrivilegeKeys.FT_MODIFYREQUESTSFOREMPLOYEE_ID : PrivilegeKeys.FT_VIEWREQUESTSFOREMPLOYEE_ID;</span>
			}
<span class="nc" id="L634">			ID empID = request.getEmployeeID();</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">			if (empID != null) {</span>
<span class="nc" id="L636">				ID orgID = RequestsMH.getEmpOrgID(context, empID);</span>
<span class="nc" id="L637">				isAuthorized = user.isAuthorized(privID, OrganizationScopeManagerProxy.getScopeID(orgID));</span>
			}
		}

<span class="nc bnc" id="L641" title="All 2 branches missed.">		if (!isAuthorized) {</span>
<span class="nc" id="L642">			addUnauthorizedMsg(context, isUpdate);</span>
		}
<span class="nc" id="L644">		return isAuthorized;</span>
	}

	/**
	 * Verify whether user is authorized to access the request
	 *
	 * It also adds error message to context if user is not authorized.
	 */
	public static boolean isAuthorized(RequestContext context, ShiftSwapRequest request, boolean isUpdate) throws RemoteException,
			BbmException {
<span class="nc" id="L654">		boolean isAuthorized = false;</span>

<span class="nc" id="L656">		User user = context.getUser();</span>
<span class="nc" id="L657">		boolean isMyRequest = isMyRequest(user, request);</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">		if (isMyRequest) {</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">			ID privID = isUpdate ? PrivilegeKeys.SS_MODIFYPERSONALREQUESTS_ID : PrivilegeKeys.SS_VIEWPERSONALREQUESTS_ID;</span>
<span class="nc" id="L660">			isAuthorized = user.isAuthorized(privID);</span>
<span class="nc" id="L661">		} else {</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">			ID privID = isUpdate ? PrivilegeKeys.SS_MODIFYREQUESTSFOREMPLOYEE_ID : PrivilegeKeys.SS_VIEWREQUESTSFOREMPLOYEE_ID;</span>

<span class="nc" id="L664">			List empIDList = request.getEmployees();</span>
<span class="nc" id="L665">			Map orgMap = RequestsMH.getEmpOrgMap(context, empIDList);</span>
<span class="nc" id="L666">			ID orgID1 = (ID) orgMap.get(empIDList.get(0));</span>
<span class="nc" id="L667">			ID orgID2 = (ID) orgMap.get(empIDList.get(1));</span>

<span class="nc bnc" id="L669" title="All 2 branches missed.">			isAuthorized = user.isAuthorized(privID, OrganizationScopeManagerProxy.getScopeID(orgID1))</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">					|| user.isAuthorized(privID, OrganizationScopeManagerProxy.getScopeID(orgID2));</span>
		}

<span class="nc bnc" id="L673" title="All 2 branches missed.">		if (!isAuthorized) {</span>
<span class="nc" id="L674">			addUnauthorizedMsg(context, isUpdate);</span>
		}
<span class="nc" id="L676">		return isAuthorized;</span>
	}

	/**
	 * Verify whether user is authorized to access the request
	 *
	 * It also adds error message to context if user is not authorized.
	 */
	public static boolean isAuthorized(RequestContext context, ShiftBidRequest request, boolean isUpdate) throws RemoteException,
			BbmException {
<span class="nc" id="L686">		boolean isAuthorized = false;</span>

<span class="nc" id="L688">		User user = context.getUser();</span>
<span class="nc" id="L689">		boolean isMyRequest = isMyRequest(user, request);</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">		if (isMyRequest) {</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">			ID privID = isUpdate ? PrivilegeKeys.SB_MODIFYPERSONALBIDS_ID : PrivilegeKeys.SB_VIEWPERSONALBIDS_ID;</span>
<span class="nc" id="L692">			isAuthorized = user.isAuthorized(privID);</span>
<span class="nc" id="L693">		} else {</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">			ID privID = isUpdate ? PrivilegeKeys.SB_MODIFYSHIFTBIDSFOREMP_ID : PrivilegeKeys.SB_VIEWSHIFTBIDSFOREMP_ID;</span>

<span class="nc" id="L696">			ID empID = request.getEmployeeID();</span>
<span class="nc" id="L697">			ID orgID = RequestsMH.getEmpOrgID(context, empID);</span>
<span class="nc" id="L698">			isAuthorized = user.isAuthorized(privID, OrganizationScopeManagerProxy.getScopeID(orgID));</span>
		}

<span class="nc bnc" id="L701" title="All 2 branches missed.">		if (!isAuthorized) {</span>
<span class="nc" id="L702">			addUnauthorizedMsg(context, isUpdate);</span>
		}
<span class="nc" id="L704">		return isAuthorized;</span>
	}

	/**
	 * Verify whether user is authorized to access the Custom Shift Request.
	 *
	 * It also adds error message to context if user is not authorized.
	 */
	public static boolean isAuthorized(RequestContext context, CustShiftReq request, boolean isUpdate) throws RemoteException, BbmException {
<span class="nc" id="L713">		boolean isAuthorized = false;</span>
<span class="nc" id="L714">		User user = context.getUser();</span>
<span class="nc" id="L715">		boolean isMyRequest = isMyRequest(user, request);</span>

<span class="nc bnc" id="L717" title="All 2 branches missed.">		if (isMyRequest) {</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">			ID privID = isUpdate ? PrivilegeKeys.CS_MODIFYPERSONALREQUESTS_ID : PrivilegeKeys.CS_VIEWPERSONALREQUESTS_ID;</span>
<span class="nc" id="L719">			isAuthorized = user.isAuthorized(privID);</span>
<span class="nc" id="L720">		} else {</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">			ID privID = isUpdate ? PrivilegeKeys.CS_MODIFYREQUESTSFOREMPLOYEE_ID : PrivilegeKeys.CS_VIEWREQUESTSFOREMPLOYEE_ID;</span>

<span class="nc" id="L723">			ID empID = request.getEmployeeID();</span>
<span class="nc" id="L724">			ID orgID = RequestsMH.getEmpOrgID(context, empID);</span>
<span class="nc" id="L725">			isAuthorized = user.isAuthorized(privID, OrganizationScopeManagerProxy.getScopeID(orgID));</span>
		}

<span class="nc bnc" id="L728" title="All 2 branches missed.">		if (!isAuthorized) {</span>
<span class="nc" id="L729">			addUnauthorizedMsg(context, isUpdate);</span>
		}

<span class="nc" id="L732">		return isAuthorized;</span>
	}

	public static Map&lt;ID, Boolean&gt; getAuctionmapForApprovedSBRequests(Collection requestList) throws Exception {
<span class="nc" id="L736">		List&lt;ID&gt; auctionIDList = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">		for (Iterator it = requestList.iterator(); it.hasNext();) {</span>
<span class="nc" id="L738">			RequestAggregate request = (RequestAggregate) it.next();</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">			if (request.getRequestType().equals(Request.REQUESTTYPE_SHIFTBID)</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">					&amp;&amp; request.getRequestStatus().equals(RequestAuditTrail.STATUS_APPROVED)) {</span>
<span class="nc" id="L741">				auctionIDList.add(((ShiftBidRequest) request).getShiftBidAuctionID());</span>
			}
<span class="nc" id="L743">		}</span>
<span class="nc" id="L744">		Map&lt;ID, Boolean&gt; auctionMap = null;</span>
		//now get the auction map
<span class="nc bnc" id="L746" title="All 4 branches missed.">		if (auctionIDList != null &amp;&amp; auctionIDList.size() &gt; 0) {</span>
<span class="nc" id="L747">			auctionMap = new HashMap&lt;ID, Boolean&gt;(auctionIDList.size());</span>
<span class="nc" id="L748">			Collection auctionIDs = AuctionMH.getAuctionsByIDs(auctionIDList);</span>
<span class="nc bnc" id="L749" title="All 2 branches missed.">			for (Iterator it = auctionIDs.iterator(); it.hasNext();) {</span>
<span class="nc" id="L750">				ShiftBidAuction auction = (ShiftBidAuction) it.next();</span>
<span class="nc" id="L751">				auctionMap.put(auction.getID(), Boolean.valueOf(auction.getIsAuctionOpen()));</span>
<span class="nc" id="L752">			}</span>
		}

<span class="nc" id="L755">		return auctionMap;</span>
	}

	/**
	 * Return true if the Specified Request belongs to current User
	 */
	public static boolean isMyRequest(User user, RequestAggregate request) {
<span class="nc bnc" id="L762" title="All 2 branches missed.">		if (request instanceof ShiftSwapRequest) {</span>
<span class="nc" id="L763">			List empIDList = ((ShiftSwapRequest) request).getEmployees();</span>
<span class="nc bnc" id="L764" title="All 4 branches missed.">			return (empIDList != null &amp;&amp; empIDList.contains(user.getEmployeeID()));</span>
		} else {
<span class="nc" id="L766">			ID empID = request.getEmployeeID();</span>
<span class="nc bnc" id="L767" title="All 4 branches missed.">			return empID != null &amp;&amp; empID.equals(user.getEmployeeID());</span>
		}
	}

	/**
	 * Add Unauthorized to access/update Request error message
	 */
	public static void addUnauthorizedMsg(RequestContext context, boolean isUpdate) {
<span class="nc bnc" id="L775" title="All 2 branches missed.">		String rbKey = isUpdate ? RmWebBundleKey.UNAUTHORIZED_TO_UPDATE_REQUEST : RmWebBundleKey.UNAUTHORIZED_TO_ACCESS_REQUEST;</span>
<span class="nc" id="L776">		addErrorMsg(context, rbKey);</span>
<span class="nc" id="L777">	}</span>

	/**
	 * Add Error Message
	 */
	private static void addErrorMsg(RequestContext context, String rbKey) {
<span class="nc" id="L783">		String rbName = RmWebBundleKey.BUNDLE_NAME;</span>
<span class="nc" id="L784">		Message msg = new Message(Message.ERROR_TYPE, rbKey, rbName);</span>
<span class="nc" id="L785">		context.addPageMessage(msg);</span>
<span class="nc" id="L786">	}</span>

	/**
	 * Return Request Type for Agents Request Page
	 */
	public static String getRequestType(RequestContext context) {
<span class="nc" id="L792">		RequestsFilterBoxPC rFilterPC = new RequestsFilterBoxPC(context);</span>
<span class="nc" id="L793">		rFilterPC.extractParameters(context.getRequest());</span>
<span class="nc" id="L794">		ID filterID = rFilterPC.getSelectedFilterID();</span>

<span class="nc" id="L796">		String reqType = null;</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">		if (filterID != null) {</span>
<span class="nc" id="L798">			reqType = RequestsMH.getRequestTypeFromFilterID(filterID);</span>
		}

<span class="nc" id="L801">		return reqType;</span>
	}

	/**
	 * Assuming current employee is a participate in the swap, get the display name of the other swap employee
	 * @param request - the shift swap request
	 * @param context - the context of the request which includes the logged in employee id
	 * @return String - the name of the swap employee
	 * @throws Exception
	 */
	public static String getSwapEmployeeName(RequestAggregate request, RequestContext context) throws Exception {
<span class="nc" id="L812">		ShiftSwapRequest ssReq = (ShiftSwapRequest) request;</span>
<span class="nc" id="L813">		List&lt;ID&gt; empIDList = ssReq.getEmployees();</span>
<span class="nc" id="L814">		ID swapID = null;</span>
<span class="nc bnc" id="L815" title="All 2 branches missed.">		if (context.getUser().getEmployeeID().compareTo(empIDList.get(0)) == 0) {</span>
<span class="nc" id="L816">			swapID = empIDList.get(1);</span>
		} else {
<span class="nc" id="L818">			swapID = empIDList.get(0);</span>
		}
<span class="nc" id="L820">		EmployeeName e = EmployeeModelHandler.getEmployeeNameByID(context, swapID);</span>
<span class="nc" id="L821">		return context.getLocalizer().formatFullName(e);</span>
	}

	/**
	 * is the logged in employee privileged for the 2 employees participating in the swap
	 * @param request - Shift Swap request
	 * @param privID
	 * @param context
	 * @return true or false
	 * @throws Exception
	 */
	public static boolean isSSAuthPriv(RequestAggregate request, ID privID, RequestContext context) throws Exception {
<span class="nc" id="L833">		ShiftSwapRequest ssReq = (ShiftSwapRequest) request;</span>
<span class="nc" id="L834">		List&lt;ID&gt; empIDList = ssReq.getEmployees();</span>

<span class="nc" id="L836">		Map&lt;ID, ID&gt; eOrgMap = RequestsMH.getEmpOrgMap(context, empIDList);</span>
<span class="nc" id="L837">		ID orgID1 = eOrgMap.get(empIDList.get(0));</span>
<span class="nc" id="L838">		ID orgID2 = eOrgMap.get(empIDList.get(1));</span>

<span class="nc bnc" id="L840" title="All 2 branches missed.">		return context.getUser().isAuthorized(privID, OrganizationScopeManagerProxy.getScopeID(orgID1))</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">				|| context.getUser().isAuthorized(privID, OrganizationScopeManagerProxy.getScopeID(orgID2));</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>