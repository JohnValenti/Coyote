<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RequestsFilterMH.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.web.rm.requests.filter</a> &gt; <span class="el_source">RequestsFilterMH.java</span></div><h1>RequestsFilterMH.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.web.rm.requests.filter;

import java.rmi.RemoteException;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.IDStringPair;
import com.bluepumpkin.common.datatypes.StringsPair;
import com.bluepumpkin.ejb.bbm.activity.model.Activity;
import com.bluepumpkin.ejb.bbm.activity.model.ActivityFilter;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.RmManagerFactory;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.commonrequestmanager.model.RequestFilter;
import com.bluepumpkin.ejb.rm.setup.calendartimeoff.ejb.CalendarTimeOffDayFacade;
import com.bluepumpkin.web.bbm.activity.ActivityModelHandler;
import com.bluepumpkin.web.bbm.campaign.CampaignModelHandler;
import com.bluepumpkin.web.bbm.employee.EmployeeModelHandler;
import com.bluepumpkin.web.bbm.organization.OrganizationModelHandler;
import com.bluepumpkin.web.bbm.skill.SkillModelHandler;
import com.bluepumpkin.web.rm.auction.AuctionMH;
import com.bluepumpkin.web.rm.requests.RequestsMH;
import com.bluepumpkin.web.rm.requests.timeoff.TimeOffRequestsMH;
import com.bluepumpkin.web.rm.timeoffbid.TimeOffBidModelHandler;
import com.verint.web.fs.workrules.WorkRulesModelHandler;
import com.witness.ejb.core.security.PrivilegeKeys;
import com.witness.ejb.core.security.model.User;
import com.witness.web.uif.system.RequestContext;

/**
 * Title: RequestsFilterMH Description: Requests Filter Model Handler Copyright: Copyright (c) 2002 Company: Blue Pumpkin Software,
 * Inc
 * 
 * @author David Su, dsu
 * @version 1.0
 * 
 *          Created on October 18, 2002, 10:42 AM
 */
<span class="nc" id="L51">public class RequestsFilterMH extends RequestsMH {</span>
	public static final String ORGANIZATION_KEY = &quot;ORGANIZATION_KEY&quot;;
	public static final String FILTER_NAME_KEY = &quot;FILTER_NAME_KEY&quot;;
	public static final String SUPERVISOR_KEY = &quot;SUPERVISOR_KEY&quot;;
	public static final String REQUEST_STATUS_KEY = &quot;REQUEST_STATUS_KEY&quot;;
	public static final String SKILL_KEY = &quot;SKILL_KEY&quot;;
	public static final String POOL_KEY = &quot;POOL_KEY&quot;;
	public static final String CAMPAIGN_KEY = &quot;CAMPAIGN_KEY&quot;;
	public static final String ACTIVITY_KEY = &quot;ACTIVITY_KEY&quot;;
	public static final String SHIFT_KEY = &quot;SHIFT_KEY&quot;;
	public static final String EXTENSION_KEY = &quot;EXTENSIONS_KEY&quot;;
	public static final String BID_KEY = &quot;BID_KEY&quot;;
	public static final String TO_ACTIVITIES_KEY = &quot;TO_ACTIVITIES_KEY&quot;;
	public static final String SHIFT_BID_AUCTION_KEY = &quot;SHIFT_BID_AUCTION_KEY&quot;;

	/**
	 * Return Request Filter
	 */
	public static RequestFilter getRequestFilter(ID filterID) throws BbmFinderException, BbmCreateException, RemoteException {
<span class="nc" id="L70">		return getRequestManager().getRequestFilterById(filterID);</span>
	}

	/**
	 * Create Request Filter
	 */
	public static ID createRequestFilter(RequestFilter filter) throws RemoteException, BbmCreateException {
<span class="nc" id="L77">		return getRequestManager().createRequestFilter(filter);</span>
	}

	/**
	 * Create Request Filter
	 */
	public static void updateRequestFilter(RequestFilter filter) throws BbmUpdateException, BbmCreateException, RemoteException {
<span class="nc" id="L84">		getRequestManager().updateRequestFilter(filter);</span>
<span class="nc" id="L85">	}</span>

	/**
	 * Delete Request Filter
	 */
	public static void deleteRequestFilter(ID filterID) throws BbmRemoveException, BbmCreateException, RemoteException {
<span class="nc" id="L91">		getRequestManager().deleteRequestFilterByID(filterID);</span>
<span class="nc" id="L92">	}</span>

	/**
	 * Return Request Filter Data
	 */
	public static Map getRequestFilterData(RequestContext context, User user, String reqType) throws RemoteException, BbmException, Exception {
<span class="nc" id="L98">		HashMap map = new HashMap(4);</span>

		// Don't include Flex Type Activities
<span class="nc" id="L101">		final int DONT_INCLUDE_FLEXTYPES = 0;</span>

<span class="nc" id="L103">		ID userID = user.getID();</span>
<span class="nc" id="L104">		IDStringPair[] filterNames = RequestsMH.getRequestFilterNamesByUserID(userID);</span>
<span class="nc" id="L105">		Collection orgList = OrganizationModelHandler.getAllOrgsInUserScopePlusAncestors(context, context.getUser());</span>
<span class="nc" id="L106">		ID orgUserID = OrganizationModelHandler.getEmployeeOrgID(context, user.getEmployeeID());</span>
<span class="nc" id="L107">		List reqStatusList = getRequestManager().getPossibleStatesForRequestType(reqType);</span>

		// Retrieve List of Supervisors
<span class="nc" id="L110">		Collection orgIDs = getViewableRequestOrgIDs(user);</span>
<span class="nc" id="L111">		Collection supervisorList = EmployeeModelHandler.getSupervisorsForOrganizations(context, orgIDs, null);</span>

		// Retrieve List of Skills
<span class="nc" id="L114">		Collection skillList = Collections.emptyList();</span>
<span class="nc bnc" id="L115" title="All 6 branches missed.">		if (Request.REQUESTTYPE_SHIFTSWAP.equals(reqType) &amp;&amp; orgList != null &amp;&amp; orgList.size() &gt; 0) {</span>
<span class="nc" id="L116">			skillList = SkillModelHandler.getAvailableSkillsInOrg(context, orgIDs);</span>
		}

		// Retrieve List of Time Off Pools, Time Off Types (not Flex Time) and Time off Bids
<span class="nc" id="L120">		Collection poolList = Collections.emptyList();</span>
<span class="nc" id="L121">		Collection bidList = Collections.emptyList();</span>
<span class="nc" id="L122">		Collection toActivitiesList = Collections.emptyList();</span>
<span class="nc" id="L123">		Collection&lt;IDStringPair&gt; shiftBidAuctionList = Collections.emptyList();</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">		if (Request.REQUESTTYPE_TIMEOFF.equals(reqType)) {</span>
<span class="nc" id="L125">			CalendarTimeOffDayFacade toCalFacade = RmManagerFactory.getInstance().getTimeOffDayFacade();</span>
<span class="nc" id="L126">			poolList = toCalFacade.getTOPoolsForOrgIDs(orgIDs);</span>
<span class="nc" id="L127">			bidList = TimeOffBidModelHandler.getTimeOffBidsForOrgIDs(orgIDs);</span>
<span class="nc" id="L128">			toActivitiesList = TimeOffRequestsMH.getTimeOffTypes(orgIDs, DONT_INCLUDE_FLEXTYPES);</span>
<span class="nc" id="L129">			map.put(POOL_KEY, poolList);</span>
<span class="nc" id="L130">			map.put(BID_KEY, bidList);</span>
<span class="nc" id="L131">			map.put(TO_ACTIVITIES_KEY, toActivitiesList);</span>
		}
		
<span class="nc bnc" id="L134" title="All 2 branches missed.">		if (Request.REQUESTTYPE_SHIFTBID.equals(reqType)){</span>
<span class="nc" id="L135">			Collection&lt;StringsPair&gt; auctionsInViewableOrgs =AuctionMH.getAuctionNamesInGiveOrgIds(orgIDs);</span>
<span class="nc" id="L136">			map.put(SHIFT_BID_AUCTION_KEY, auctionsInViewableOrgs);</span>
		}
		
		// Retrieve Campaigns/Shifts/Activities/Extensions for the Custom Shift Request Filter
<span class="nc bnc" id="L140" title="All 4 branches missed.">		if (Request.REQUESTTYPE_CUSTSHIFT.equals(reqType) || Request.REQUESTTYPE_FLEXTIME.equals(reqType)) {</span>
			// Get all the user's Campaigns that contains his scoped orgs. Should this list be filtered by his scoped
			// campaigns?
<span class="nc" id="L143">			Collection campaignList = Collections.emptyList();</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">			if (Request.REQUESTTYPE_CUSTSHIFT.equals(reqType)) {</span>
<span class="nc" id="L145">				Collection campIDs = CampaignModelHandler.getAllCampaignIDsLinkedToOrgs(context, orgIDs);</span>
<span class="nc" id="L146">				campaignList = CampaignModelHandler.getCampaignsByIDs(context, campIDs);</span>
			}

			// Get all Shifts and Extensions defined in the list of orgs (TBD: or in the user's scoped Campaigns?)
<span class="nc" id="L150">			HashMap&lt;ID, String&gt; shiftIDNamesMap = new HashMap();</span>
<span class="nc" id="L151">			HashMap&lt;ID, String&gt; extIDNamesMap = new HashMap();</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">			for (Iterator it = orgIDs.iterator(); it.hasNext();) {</span>
<span class="nc" id="L153">				ID orgID = (ID) it.next();</span>
<span class="nc" id="L154">				shiftIDNamesMap.putAll(WorkRulesModelHandler.getShiftNamesByOrg(context, orgID));</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">				if (Request.REQUESTTYPE_CUSTSHIFT.equals(reqType)) {</span>
<span class="nc" id="L156">					extIDNamesMap.putAll(WorkRulesModelHandler.getOTExtensionNamesByOrg(context, orgID));</span>
				}
<span class="nc" id="L158">			}</span>

			// Get all Activities defined in the list of orgs
<span class="nc" id="L161">			ActivityFilter activityFilter = new ActivityFilter();</span>
<span class="nc" id="L162">			activityFilter.setUsedInShift(true); // we want to see primary activities</span>
<span class="nc" id="L163">			activityFilter.setActivityId(Activity.ACTIVITY_NONE.toString(), ActivityFilter.OP_NOT_IN_LIST);</span>
<span class="nc" id="L164">			Collection activityList = ActivityModelHandler.getActivities(context, orgIDs, activityFilter, true);</span>

<span class="nc" id="L166">			map.put(CAMPAIGN_KEY, campaignList);</span>
<span class="nc" id="L167">			map.put(SHIFT_KEY, shiftIDNamesMap);</span>
<span class="nc" id="L168">			map.put(EXTENSION_KEY, extIDNamesMap);</span>
<span class="nc" id="L169">			map.put(ACTIVITY_KEY, activityList);</span>
		}

<span class="nc" id="L172">		map.put(FILTER_NAME_KEY, filterNames);</span>
<span class="nc" id="L173">		map.put(ORGANIZATION_KEY, orgList);</span>
<span class="nc" id="L174">		map.put(SUPERVISOR_KEY, supervisorList);</span>
<span class="nc" id="L175">		map.put(REQUEST_STATUS_KEY, reqStatusList);</span>
<span class="nc" id="L176">		map.put(SKILL_KEY, skillList);</span>

<span class="nc" id="L178">		return map;</span>
	}

	/**
	 * Return list of viewable requests Org IDs
	 */
	private static Set getViewableRequestOrgIDs(User user) {
<span class="nc" id="L185">		Collection ssOrgIDs = user.getAuthorizedScopes(PrivilegeKeys.SS_VIEWREQUESTSFOREMPLOYEE, Organization.SCOPE_TYPE);</span>
<span class="nc" id="L186">		Collection toOrgIDs = user.getAuthorizedScopes(PrivilegeKeys.TOM_VIEWREQUESTSFOREMPLOYEE, Organization.SCOPE_TYPE);</span>
<span class="nc" id="L187">		Collection ftOrgIDs = user.getAuthorizedScopes(PrivilegeKeys.FT_VIEWREQUESTSFOREMPLOYEE, Organization.SCOPE_TYPE);</span>
<span class="nc" id="L188">		Collection csOrgIDs = user.getAuthorizedScopes(PrivilegeKeys.CS_VIEWREQUESTSFOREMPLOYEE, Organization.SCOPE_TYPE);</span>

<span class="nc" id="L190">		Set orgIDs = new HashSet();</span>
<span class="nc" id="L191">		orgIDs.addAll(ssOrgIDs);</span>
<span class="nc" id="L192">		orgIDs.addAll(toOrgIDs);</span>
<span class="nc" id="L193">		orgIDs.addAll(csOrgIDs);</span>
<span class="nc" id="L194">		return orgIDs;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>