<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftBidRequest.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model</a> &gt; <span class="el_source">ShiftBidRequest.java</span></div><h1>ShiftBidRequest.java</h1><pre class="source lang-java linenums">/*
 * ShiftBidRequest.java
 *
 * Copyright (c) 2002, Blue Pumpkin Software, Inc.
 * All rights reserved.
 */
package com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model;


import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.List;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.workresource.model.Employee;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestDetailLevel;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationCache;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.model.ShiftBidAuction;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.ejb.ShiftBidRequestDAO;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.validation.ShiftBidRequestValidationCache;
import com.bluepumpkin.ejb.rm.util.ShiftBidAuctionUtil;

/**
 * Class represents a ShiftBidRequest.
 *
 * see {@link com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.ejb.ShiftBidAuctionManager ShiftBidAuctionManager}
 * for a description of the shift bidding process.
 *
 */
<span class="nc bnc" id="L39" title="All 2 branches missed.">public class ShiftBidRequest extends RequestAggregate {</span>

<span class="nc" id="L41">    private final static String m_DAOClassName = ShiftBidRequestDAO.class.getName();</span>

    private transient ShiftBidRequestValidationCache m_cachedSBRValidationCache;

    /**
     * ID, shiftBidderID, Preference, Name, usePoints, auctionID
     */
    public static final long DL_BASIC = RequestDetailLevel.DL_BASIC;

    /**
     * Fetches:
     * &lt;li&gt; Collection of BiddableSchedule(s) associated with this request.
     * &lt;li&gt; Collection of Shift Assignments associated with the BiddableSchedule(s)
     * for this request.
     *
     * &lt;p&gt; see {@link com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidauction.model.ShiftBidAuction ShiftBidAuction}
     * for the association between auctions, biddableScheduleInstances and shiftAssignments.
     */
    public static final long DL_SHIFT_ASSIGNMENTS_COLL = RequestDetailLevel.DL_SHIFT_ASSIGNMENTS_COLL_ROOTED_SHIFTBIDREQUEST;

    /**
     * Employee object (employee name)
     */
    public static final long DL_EMPLOYEE = RequestDetailLevel.DL_EMPLOYEE_SHIFTBIDDER_CHILD;

    /**
     * Shift Bidder object (Personal deadline)
     */
    public static final long DL_SHIFTBIDDER = RequestDetailLevel.DL_SHIFTBIDDER;

    /**
     * auction object (auction deadline, schedule period)
     */
    public static final long DL_SHIFTBID_AUCTION = RequestDetailLevel.DL_SHIFTBID_AUCTION;

    /**
     * @see RequestDetailLevel#DL_BIDDABLESCHEDULE_IDS
     */
    public static final long DL_BIDDABLESCHEDULE_IDS = RequestDetailLevel.DL_BIDDABLESCHEDULE_IDS;



    /**
     * @see RequestDetailLevel#DL_BONUSTOBEAWARDED_FOR_SHIFTBIDREQUEST
     */
    public static final long DL_BONUSTOBEAWARDED_FOR_SHIFTBID_REQUEST =
        RequestDetailLevel.DL_BONUSTOBEAWARDED_FOR_SHIFTBIDREQUEST;

    /**
     * Need DL_EMPLOYEE to get the accumulated score for shift bidder towards computation of the score.
     *
     * @see RequestDetailLevel#DL_BIDRANK_FOR_SHIFTBIDREQUEST_SHIFTBIDREQUEST_ROOTED
     */
    public static final long DL_BIDRANK_FOR_SHIFTBIDREQUEST =
        RequestDetailLevel.DL_BIDRANK_FOR_SHIFTBIDREQUEST_SHIFTBIDREQUEST_ROOTED;

    ////////////////////
<span class="nc" id="L98">	private static final ShiftBidRequestFieldInfo m_fieldInfo = new ShiftBidRequestFieldInfo();</span>

    private static final long serialVersionUID = 6452019921167641752L;


<span class="nc" id="L103">	private Pair&lt;Integer, Integer&gt; m_rankWithoutEmpPoints = new Pair&lt;Integer, Integer&gt;(0, 0);</span>

<span class="nc" id="L105">	private Pair&lt;Integer, Integer&gt; m_rankWithEmpPoints = new Pair&lt;Integer, Integer&gt;(0, 0);</span>

<span class="nc" id="L107">    private transient ShiftBidRequestOptMethods m_shiftBidRequestOptMethods = null;</span>

<span class="nc" id="L109">    private transient ShiftBidRequestSetters m_shiftBidRequestSetters = null;</span>

<span class="nc" id="L111">	private transient Collection&lt;Pair&lt;ID, TimeRange&gt;&gt; m_cachedEmpIDTimeRangePairs = null;</span>
    //  cache doesn't need to be invalidated when certain methods are called since it is read only.
<span class="nc" id="L113">	private transient List&lt;BiddableSchedule&gt; m_cachedBiddableSchedules = null;</span>
    //  cache doesn't need to be invalidated when certain methods are called since it is read only.
<span class="nc" id="L115">    private transient List&lt;ShiftAssignment&gt; m_cachedShiftAssignments = null;</span>

<span class="nc" id="L117">	private transient List&lt;ID&gt; m_cachedBiddableScheduleIDs = null;</span>

<span class="nc" id="L119">	private transient List&lt;ShiftBidRequestBiddableSchedule&gt; m_cachedShiftBidRequestBiddableSchedules = null;</span>

<span class="nc" id="L121">    private transient ShiftBidder m_cachedShiftBidder = null;</span>

	private int score;


    /**
     * During request creation, webtier sets the employee ID instead of the shift bidder ID as it is not avaialble.
     * This ID is translated to the shiftBidder ID by the back-end.
     *
     * When the request is fetched, this is set to the employee ID associated with this request,
     * provided the ID is avaliable (request loaded with proper detailLevel).
     */


<span class="nc bnc" id="L135" title="All 2 branches missed.">    public class ShiftBidRequestOptMethods  {</span>

		public List&lt;ShiftBidRequestBiddableSchedule&gt; getShiftBidRequestBiddableSchedules() {
<span class="nc bnc" id="L138" title="All 2 branches missed.">			if (m_cachedShiftBidRequestBiddableSchedules != null) {</span>
<span class="nc" id="L139">				return m_cachedShiftBidRequestBiddableSchedules;</span>
			}

<span class="nc" id="L142">			m_cachedShiftBidRequestBiddableSchedules = Collections.emptyList();</span>
			@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L144">			Collection&lt;ShiftBidRequestBiddableSchedule&gt; sbrBSColl = getChildObjects(ShiftBidRequestFieldInfo.SHIFTBIDREQUESTBIDDABLESCHEDULE_CHILDTYPE);</span>

<span class="nc bnc" id="L146" title="All 2 branches missed.">            if ( !sbrBSColl.isEmpty() )  {</span>
                // sort the associated shiftbidReqBiddableSchedules using the item order.
<span class="nc" id="L148">				m_cachedShiftBidRequestBiddableSchedules = new ArrayList&lt;ShiftBidRequestBiddableSchedule&gt;(sbrBSColl);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">                if (m_cachedShiftBidRequestBiddableSchedules.size() &gt; 1)</span>
<span class="nc" id="L150">                    Collections.sort(m_cachedShiftBidRequestBiddableSchedules, new ShiftBidAuctionUtil.ShiftBidRequestBiddableScheduleComparator());</span>
            }

<span class="nc" id="L153">            return m_cachedShiftBidRequestBiddableSchedules;</span>
        }

		public List&lt;BiddableSchedule&gt; getBiddableSchedules() {

<span class="nc bnc" id="L158" title="All 2 branches missed.">			if (m_cachedBiddableSchedules != null) {</span>
<span class="nc" id="L159">				return m_cachedBiddableSchedules;</span>
			}

<span class="nc" id="L162">			m_cachedBiddableSchedules = Collections.emptyList();</span>

<span class="nc" id="L164">			List&lt;ShiftBidRequestBiddableSchedule&gt; sbrBSList = getShiftBidRequestBiddableSchedules();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            if (!sbrBSList.isEmpty())   {</span>
<span class="nc" id="L166">				m_cachedBiddableSchedules = new ArrayList&lt;BiddableSchedule&gt;(5);</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">				for (ShiftBidRequestBiddableSchedule shiftBidRequestBiddableSchedule : sbrBSList) {</span>
                    // Note: bidSched can be null. see JavaDoc for shiftBidRequestBiddableSchedule.getBiddableSchedule().
<span class="nc" id="L169">                    BiddableSchedule bidSched = shiftBidRequestBiddableSchedule.getBiddableSchedule();</span>
<span class="nc" id="L170">                    m_cachedBiddableSchedules.add(bidSched);</span>
<span class="nc" id="L171">                }</span>
            }

<span class="nc" id="L174">            return m_cachedBiddableSchedules;</span>
        }

		public void setBiddableSchedules(List&lt;BiddableSchedule&gt; schedules) {
<span class="nc" id="L178">			m_cachedBiddableSchedules = schedules;</span>
<span class="nc" id="L179">			m_cachedBiddableScheduleIDs = new ArrayList&lt;ID&gt;(schedules.size());</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">			for (BiddableSchedule sch : schedules) {</span>
<span class="nc" id="L181">				m_cachedBiddableScheduleIDs.add(sch.getID());</span>
<span class="nc" id="L182">			}</span>
<span class="nc" id="L183">		}</span>


		@SuppressWarnings(&quot;unchecked&quot;)
		public List&lt;ID&gt; getBiddableScheduleIDs() {
            // if value already cached, return.
<span class="nc bnc" id="L189" title="All 2 branches missed.">			if (m_cachedBiddableScheduleIDs != null) {</span>
<span class="nc" id="L190">				return m_cachedBiddableScheduleIDs;</span>
			}

            // get the shiftBidREqBiddableSCheds associated with this request.
<span class="nc" id="L194">            m_cachedBiddableScheduleIDs = Collections.emptyList();</span>
<span class="nc" id="L195">            List&lt;ShiftBidRequestBiddableSchedule&gt; sbrBSList = getShiftBidRequestBiddableSchedules();</span>

            // extract the biddable schedule IDs from this list and cache.
<span class="nc bnc" id="L198" title="All 2 branches missed.">            if (!sbrBSList.isEmpty())   {</span>
<span class="nc" id="L199">                m_cachedBiddableScheduleIDs = RequestUtil.getListOfFieldValuesFromVOBases(sbrBSList,</span>
                    ShiftBidRequestBiddableScheduleFieldInfo.SHIFTBIDREQUESTBIDDABLESCHEDULE_I_BIDDABLESCHEDULEID);
            }
<span class="nc" id="L202">            return m_cachedBiddableScheduleIDs;</span>
        }

        /**
         * Returns a &lt;b&gt;sorted&lt;/b&gt; list of shift assignments associated with this request.
         *
         * @return
         */
        public List&lt;ShiftAssignment&gt; getShiftAssignments() {
<span class="nc bnc" id="L211" title="All 2 branches missed.">			if (m_cachedShiftAssignments != null) {</span>
<span class="nc" id="L212">				return m_cachedShiftAssignments;</span>
			}

<span class="nc" id="L215">			m_cachedShiftAssignments = Collections.emptyList();</span>

            // at most 7 shift assignments/week.
<span class="nc" id="L218">			m_cachedShiftAssignments = new ArrayList&lt;ShiftAssignment&gt;(7);</span>

            // collect shift assignments from biddableSchedules
<span class="nc bnc" id="L221" title="All 2 branches missed.">			for (BiddableSchedule bidSched : getBiddableSchedules()) {</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">                if (bidSched != null) {</span>
<span class="nc" id="L223">					m_cachedShiftAssignments.addAll(bidSched.getShiftAssignments());</span>
                }
<span class="nc" id="L225">            }</span>

            // sort if necessary.
<span class="nc bnc" id="L228" title="All 2 branches missed.">			if (m_cachedShiftAssignments.size() &gt; 1) {</span>
<span class="nc" id="L229">				Collections.sort(m_cachedShiftAssignments, new ShiftBidAuctionUtil.ShiftAssignmentComparator());</span>
			}

<span class="nc" id="L232">            return m_cachedShiftAssignments;</span>
        }

        /**
         * If an approved shift bid is multi shift and stitched, will return the shifts
         * without the stitching to display in the details screen of the request.
         * @return
         * @throws Exception
         */
        public List&lt;ShiftAssignment&gt; getStitchedShiftAssignments() throws Exception{
<span class="nc" id="L242">			return getShiftAssignments();</span>

        }




        public Employee getEmployee()  {
<span class="nc bnc" id="L250" title="All 4 branches missed.">            assert (getDetailLevel() &amp; DL_EMPLOYEE) != 0:&quot;(getDetailLevel() &amp; DL_EMPLOYEE) != 0: &quot; + getDetailLevel();</span>

<span class="nc" id="L252">            ShiftBidder shiftBidder = getShiftBidder();</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">            return (shiftBidder == null)?null:shiftBidder.getOptMethods().getEmployee();</span>
        }



        public ShiftBidder getShiftBidder()  {
<span class="nc bnc" id="L259" title="All 2 branches missed.">            if (m_cachedShiftBidder != null) return m_cachedShiftBidder;</span>

            // we check for DL_EMPLOYEE since DL_SHIFTBIDDER is not defined.  DL_EMPLOYEE loads
            // shiftBidder and employee.
<span class="nc bnc" id="L263" title="All 4 branches missed.">            assert (getDetailLevel() &amp; DL_EMPLOYEE) != 0:&quot;(getDetailLevel() &amp; DL_EMPLOYEE) != 0: &quot; + getDetailLevel();</span>

			@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L266">			Collection&lt;ShiftBidder&gt; shiftBidders = getChildObjects(ShiftBidRequestFieldInfo.SHIFTBIDDER_CHILDTYPE);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">            if (shiftBidders.size() != 1)</span>
<span class="nc" id="L268">                throw new IllegalArgumentException(&quot;shiftBidders.size() != 1&quot; + shiftBidders.size());</span>

<span class="nc" id="L270">            m_cachedShiftBidder = shiftBidders.iterator().next();</span>
<span class="nc bnc" id="L271" title="All 4 branches missed.">            assert m_cachedShiftBidder.getEmployeeID().equals(getEmployeeID()):&quot;m_cachedShiftBidder.getEmployeeID().equals(getEmployeeID()): &quot; + m_cachedShiftBidder.getEmployeeID() + ',' + getEmployeeID();</span>

<span class="nc" id="L273">            return m_cachedShiftBidder;</span>
        }


        public ShiftBidAuction getShiftBidAuction()  {
<span class="nc bnc" id="L278" title="All 4 branches missed.">            assert (getDetailLevel() &amp; DL_SHIFTBID_AUCTION) != 0:&quot;(getDetailLevel() &amp; DL_SHIFTBID_AUCTION) != 0: &quot; + getDetailLevel();</span>

			@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L281">			Collection&lt;ShiftBidAuction&gt; auctions = getChildObjects(ShiftBidRequestFieldInfo.SHIFTBIDAUCTION_CHILDTYPE);</span>
<span class="nc bnc" id="L282" title="All 4 branches missed.">            assert auctions.size() == 1:&quot;auctions.size() == 1: &quot; + auctions.size();</span>

<span class="nc" id="L284">            return auctions.iterator().next();</span>
        }


        /**
		 * Rank of this request is computed using the score without bonus as follows:
		 * &lt;li&gt; For FullPeriod auctions, rank of this request, among the set of all requests associated with
		 * the biddable schedule for this request.
		 * &lt;li&gt; For SingleShift auctions, a request is associated with one or more biddable schedules.  In
		 * this case, compute rank of this request, among the set of all requests associated with each biddable
		 * schedule.  Then choose the highest rank among the set of computed ranks.
		 *
		 */
		public Pair&lt;Integer, Integer&gt; getRankWithoutBonus() {
<span class="nc" id="L298">            return m_rankWithoutEmpPoints;</span>
        }


        /**
		 * Rank of this request is computed using the score with bonus as follows:
		 * &lt;li&gt; For FullPeriod auctions, rank of this request, among the set of all requests associated with
		 * the biddable schedule for this request.
		 * &lt;li&gt; For SingleShift auctions, a request is associated with one or more biddable schedules.  In
		 * this case, compute rank of this request, among the set of all requests associated with each biddable
		 * schedule.  Then choose the highest rank among the set of computed ranks.
		 *
		 */
        public Pair&lt;Integer,Integer&gt; getRankWithBonus() {
<span class="nc" id="L312">            return m_rankWithEmpPoints;</span>
        }



    }

<span class="nc" id="L319">    public class ShiftBidRequestSetters  {</span>

		public void setRankWithoutBonus(Pair&lt;Integer, Integer&gt; rankWithoutBonus) {
<span class="nc" id="L322">            m_rankWithoutEmpPoints = rankWithoutBonus;</span>
<span class="nc" id="L323">        }</span>



		public void setRankWithBonus(Pair&lt;Integer, Integer&gt; rankWithBonus) {
<span class="nc" id="L328">            m_rankWithEmpPoints = rankWithBonus;</span>
<span class="nc" id="L329">        }</span>





        /**
         * @param sbAuction
         */
        public void setShiftBidAuction(ShiftBidAuction sbAuction) {
<span class="nc" id="L339">            m_cachedEmpIDTimeRangePairs = null; //invalidate as value cached was obtained from shiftBidAuction.</span>
<span class="nc" id="L340">            fillChildObject(ShiftBidRequestFieldInfo.SHIFTBIDAUCTION_CHILDTYPE, sbAuction);</span>
<span class="nc" id="L341">            addDetailLevel(DL_SHIFTBID_AUCTION);</span>
<span class="nc" id="L342">        }</span>


        /**
         * @param shiftBidder
         */
        public void setShiftBidder(ShiftBidder shiftBidder) {
<span class="nc" id="L349">            fillChildObject(ShiftBidRequestFieldInfo.SHIFTBIDDER_CHILDTYPE, shiftBidder);</span>
<span class="nc" id="L350">            addDetailLevel(DL_SHIFTBIDDER);</span>
<span class="nc" id="L351">            addDetailLevel(DL_EMPLOYEE);</span>
<span class="nc" id="L352">        }</span>




    }



    public static long getDetailLevelForValidation()   {
<span class="nc" id="L362">        return DL_BASIC | DL_SHIFTBIDDER | DL_EMPLOYEE | DL_SHIFTBID_AUCTION | DL_SHIFT_ASSIGNMENTS_COLL;</span>
    }

    public ShiftBidRequest(long detailLevel) {
<span class="nc" id="L366">        super(Request.REQUESTTYPE_SHIFTBID, detailLevel);</span>
<span class="nc" id="L367">    }</span>

	public String getName() {
<span class="nc" id="L370">		return getFormattedFieldValue(ShiftBidRequestFieldInfo.SHIFTBIDREQUEST_S_NAME);</span>
	}

	public ID getShiftBidderID() {
<span class="nc" id="L374">		return getFieldValueID(ShiftBidRequestFieldInfo.SHIFTBIDREQUEST_I_SHIFTBIDDERID);</span>
	}

	public int getPreference() {
<span class="nc" id="L378">		return getFieldValueInt(ShiftBidRequestFieldInfo.SHIFTBIDREQUEST_N_PREFERENCE);</span>
	}

    public boolean getIsBonusUsed()  {
<span class="nc" id="L382">        return getFieldValueBoolean(ShiftBidRequestFieldInfo.SHIFTBIDREQUEST_B_ISBONUSUSED);</span>
    }

    public ID getShiftBidAuctionID() {
<span class="nc" id="L386">        return getFieldValueID(ShiftBidRequestFieldInfo.SHIFTBIDREQUEST_I_SHIFTBIDAUCTIONID);</span>
    }

    /**
     * Returns a {@link Pair Pair} object as an element of the collection. The Pair
     * contains the empID (not the shiftBidder ID) and time range which encompasses all
     * shift assignments associated with this request. Presently this time range is the
     * start and end of the SP associated with the auction.
     *
     * For this method to return valid results,
     * use {@link #DL_SHIFTBIDDER DL_SHIFTBIDDER} and
     * {@link #DL_SHIFT_ASSIGNMENTS_COLL DL_SHIFT_ASSIGNMENTS_COLL} for detailLevel.
     *
     * @see com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate#getEmpIDTimeRangePairs()
     */
    @Override
	public Collection&lt;Pair&lt;ID, TimeRange&gt;&gt; getEmpIDTimeRangePairs() {
<span class="nc bnc" id="L403" title="All 2 branches missed.">		if (m_cachedEmpIDTimeRangePairs != null) {</span>
<span class="nc" id="L404">			return m_cachedEmpIDTimeRangePairs;</span>
		}

<span class="nc" id="L407">		ID empID = getEmployeeID();</span>
<span class="nc" id="L408">		List&lt;ShiftAssignment&gt; shiftAssns = getOptMethods().getShiftAssignments();</span>

<span class="nc" id="L410">		Pair&lt;ID, TimeRange&gt; empIDTimeRangePair = null;</span>

<span class="nc bnc" id="L412" title="All 2 branches missed.">		if (shiftAssns.isEmpty()) {</span>
			// When there is no shift assignment (for approved request, it may be the case)
			//get the dates from auction
<span class="nc" id="L415">			ShiftBidAuction sbAuction = getOptMethods().getShiftBidAuction();</span>
<span class="nc" id="L416">			empIDTimeRangePair = new Pair&lt;ID, TimeRange&gt;(empID,</span>
<span class="nc" id="L417">					new TimeRange(sbAuction.getStartTime(), sbAuction.getEndTime()));</span>
<span class="nc" id="L418">		}</span>
		else {
<span class="nc" id="L420">			empIDTimeRangePair = new Pair&lt;ID, TimeRange&gt;(empID, new TimeRange(</span>
<span class="nc" id="L421">					shiftAssns.get(0).getStartTime(),</span>
<span class="nc" id="L422">					shiftAssns.get(shiftAssns.size() - 1).getEndTime()));</span>
		}


		// QC46055 some approved shiftbidrequests do not get published
<span class="nc" id="L427">		ShiftBidAuction sbAuction = getOptMethods().getShiftBidAuction();</span>
<span class="nc" id="L428">		TimeRange timeRange = empIDTimeRangePair.getSecond();</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">		if (sbAuction.getStartTime().before(timeRange.getStartDate()))</span>
<span class="nc" id="L430">			timeRange.setStartDate(sbAuction.getStartTime());</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">		if (sbAuction.getEndTime().after(timeRange.getEndDate()))</span>
<span class="nc" id="L432">			timeRange.setEndDate(sbAuction.getEndTime());</span>
<span class="nc" id="L433">		empIDTimeRangePair.setSecond(timeRange);</span>

<span class="nc" id="L435">		m_cachedEmpIDTimeRangePairs = Collections.singletonList(empIDTimeRangePair);</span>

<span class="nc" id="L437">		return m_cachedEmpIDTimeRangePairs;</span>
	}

    public ShiftBidRequestOptMethods getOptMethods()  {
<span class="nc bnc" id="L441" title="All 2 branches missed.">        return (m_shiftBidRequestOptMethods = (m_shiftBidRequestOptMethods == null)?</span>
            new ShiftBidRequestOptMethods():m_shiftBidRequestOptMethods);
    }

    public ShiftBidRequestSetters getSetters()  {
<span class="nc bnc" id="L446" title="All 2 branches missed.">        return (m_shiftBidRequestSetters = (m_shiftBidRequestSetters == null)?</span>
            new ShiftBidRequestSetters():m_shiftBidRequestSetters);
    }


    public void setName(String name) {
<span class="nc" id="L452">        setFieldValue(ShiftBidRequestFieldInfo.SHIFTBIDREQUEST_S_NAME, name);</span>
<span class="nc" id="L453">    }</span>

    public void setShiftBidderID(ID id) {
<span class="nc" id="L456">        setFieldValue(ShiftBidRequestFieldInfo.SHIFTBIDREQUEST_I_SHIFTBIDDERID, id);</span>
<span class="nc" id="L457">    }</span>

    public void setPreference(int preference) {
<span class="nc" id="L460">        setFieldValue(ShiftBidRequestFieldInfo.SHIFTBIDREQUEST_N_PREFERENCE, preference);</span>
<span class="nc" id="L461">    }</span>

    public void setIsBonusUsed(boolean isBonusUsed)  {
<span class="nc" id="L464">        setFieldValue(ShiftBidRequestFieldInfo.SHIFTBIDREQUEST_B_ISBONUSUSED, isBonusUsed);</span>
<span class="nc" id="L465">    }</span>

    /**
     * &lt;b&gt;Note&lt;/b&gt;:  The passed biddableScheduleIDs, for single shift biddable schedule auctions,
     * must be sorted by shift start times.  For FullPeriod auctions, there can only be a single biddable
     * schedule and sorting is not necessary.
     *
     * Note: This creates ShiftBidRequestBiddableSchedule child objects and adds them to the 'create
     * child list' of this object.
     *
     * @param biddableScheduleIDs
     */
	public void setBiddableScheduleIDs(List&lt;ID&gt; biddableScheduleIDs) {
        // invalidate cache
<span class="nc" id="L479">        m_cachedBiddableScheduleIDs = null;</span>
<span class="nc" id="L480">        m_cachedBiddableSchedules = null;</span>

        // add given biddable schedule ids to the shift bid request.
<span class="nc bnc" id="L483" title="All 2 branches missed.">        for (int i=0; i &lt; biddableScheduleIDs.size(); i++) {</span>
<span class="nc" id="L484">            ID bidSchedID = biddableScheduleIDs.get(i);</span>

<span class="nc" id="L486">            ShiftBidRequestBiddableSchedule sbReqBidSched =</span>
                new ShiftBidRequestBiddableSchedule(m_DAOClassName, ShiftBidRequestBiddableSchedule.DL_BASIC);
<span class="nc" id="L488">            sbReqBidSched.setBiddableScheduleID(bidSchedID);</span>
			//'item order' initialization is deferred until the shift assignments for
            // the biddable schedules are loaded during request creation time.
            //sbReqBidSched.setOrder(i+1);

<span class="nc" id="L493">            createChildObject(ShiftBidRequestFieldInfo.SHIFTBIDREQUESTBIDDABLESCHEDULE_CHILDTYPE, sbReqBidSched);</span>
        }

<span class="nc" id="L496">        addDetailLevel(ShiftBidRequest.DL_BIDDABLESCHEDULE_IDS);</span>
<span class="nc" id="L497">    }</span>

	public List&lt;ID&gt; getBiddableScheduleIDs() {
		@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L501">		Collection&lt;ShiftBidRequestBiddableSchedule&gt; sbrBSColl = getChildObjects(ShiftBidRequestFieldInfo.SHIFTBIDREQUESTBIDDABLESCHEDULE_CHILDTYPE);</span>
<span class="nc bnc" id="L502" title="All 4 branches missed.">		if (sbrBSColl == null || sbrBSColl.isEmpty()) {</span>
<span class="nc" id="L503">			return Collections.emptyList();</span>
		}
<span class="nc" id="L505">		List&lt;ID&gt; result = new ArrayList&lt;ID&gt;(sbrBSColl.size());</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">		for (ShiftBidRequestBiddableSchedule sbr : sbrBSColl) {</span>
<span class="nc" id="L507">			result.add(sbr.getBiddableScheduleID());</span>
<span class="nc" id="L508">		}</span>
<span class="nc" id="L509">		return result;</span>
	}

    public void setShiftBidAuctionID(ID auctionID) {
<span class="nc" id="L513">        setFieldValue(ShiftBidRequestFieldInfo.SHIFTBIDREQUEST_I_SHIFTBIDAUCTIONID, auctionID);</span>
<span class="nc" id="L514">    }</span>

    @Override
	public FieldInfo getFieldInfo() {
<span class="nc" id="L518">        return m_fieldInfo;</span>
    }



    @Override
	public ValidationCache getValidationCache() {
<span class="nc" id="L525">        return getValidationCacheSBR();</span>
    }


    @Override
	public Collection&lt;TimeRange&gt; getValidationTimeRanges() {
<span class="nc" id="L531">		Collection&lt;Pair&lt;ID, TimeRange&gt;&gt; empIDTimeRangePairs = getEmpIDTimeRangePairs();</span>
<span class="nc bnc" id="L532" title="All 4 branches missed.">        assert empIDTimeRangePairs.size() == 1:&quot;empIDTimeRangePairs.size() = &quot; + empIDTimeRangePairs.size();</span>

<span class="nc" id="L534">		return Collections.singletonList(empIDTimeRangePairs.iterator().next().getSecond());</span>
    }

    /**
     * Convenience method to get the associated shiftBidRequestValidationCache.  Returns
     * a ShiftBidValidationCache and not a ValidationCache.  Avoids the penalty of casting
     * the latter to the former every time getValidationCache() is used.
     */
    public ShiftBidRequestValidationCache getValidationCacheSBR() {
<span class="nc bnc" id="L543" title="All 2 branches missed.">        if (m_cachedSBRValidationCache != null) return m_cachedSBRValidationCache;</span>

<span class="nc" id="L545">        return (m_cachedSBRValidationCache = new ShiftBidRequestValidationCache(this));</span>
    }


    @Override
	public ID getRequestSubType() {
<span class="nc" id="L551">        return null;</span>
    }


    @Override
	public String toString() {
<span class="nc" id="L557">        String voBaseStr = super.toString();</span>

<span class="nc" id="L559">		StringBuilder sb = new StringBuilder(voBaseStr.length() + 128);</span>
<span class="nc" id="L560">        sb.append(voBaseStr);</span>
<span class="nc" id="L561">        sb.append(&quot;m_rankWithoutEmpPoints = &quot;).append(m_rankWithoutEmpPoints).append('\n');</span>
<span class="nc" id="L562">        sb.append(&quot;m_rankWithEmpPoints = &quot;).append(m_rankWithEmpPoints).append('\n');</span>
<span class="nc" id="L563">        return sb.toString();</span>
    }

    /**
     * Is 'GetRequestPostProcessing' (processing request after it has been fetched
     * with one of the getRequestByXXXX() methods in the request manager) necessary.  Currently
     * this is decided based on the request's status
     *
     * need to override base class method since Shift Bidding also allows display of
     * invalid requests
     *
	 * @return
	 */
	@Override
	public boolean isGetRequestPostProcNeeded() {
<span class="nc bnc" id="L578" title="All 2 branches missed.">    	return !RequestAuditTrail.STATUS_WITHDRAWN.equals(getRequestStatus());</span>
    }

	public boolean isRequestPending() {
<span class="nc" id="L582">		return RequestAuditTrail.STATUS_PENDING.equals(getRequestStatus());</span>
	}

	public int getAssignedPointsBeforeApproval() {
<span class="nc" id="L586">		return getFieldValueInt(ShiftBidRequestFieldInfo.SHIFTBIDREQUEST_N_ASSIGNEDPOINTSBEFOREAPPROVAL);</span>
	}

	/**
	 * 
	 * @return  ScoreWithBonus if the request is using bonus (IsBonusUsed is true) and the 
	 * SoreWithoutBonus if the request is not using bonus
	 * 
	 */
	public int getScore() {
<span class="nc" id="L596">		return score;</span>
	}

	public void setScore(int scoreWithBonus) {
<span class="nc" id="L600">		this.score = scoreWithBonus;</span>
<span class="nc" id="L601">	}</span>


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>