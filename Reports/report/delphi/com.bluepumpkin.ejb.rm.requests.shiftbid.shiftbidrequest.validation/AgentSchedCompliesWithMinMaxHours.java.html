<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AgentSchedCompliesWithMinMaxHours.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.validation</a> &gt; <span class="el_source">AgentSchedCompliesWithMinMaxHours.java</span></div><h1>AgentSchedCompliesWithMinMaxHours.java</h1><pre class="source lang-java linenums">/*
 * Created on Aug 19, 2003
 *
 * To change this generated comment go to
 * Window&gt;Preferences&gt;Java&gt;Code Generation&gt;Code and Comments
 */
package com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.validation;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.List;

import org.apache.log4j.Priority;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.empworkrule.model.WorkResourceMinMaxHour;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.shifts.model.ShiftsConflict;
import com.bluepumpkin.ejb.bbm.shifts.model.ShiftsUtil;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TOCalcUtil;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.bbm.workrules.model.WorkRule;
import com.bluepumpkin.ejb.bbm.workrules.model.WorkRuleUtil;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validatable;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validator;
import com.bluepumpkin.ejb.rm.requests.shiftbid.shiftbidrequest.model.ShiftBidRequest;
import com.verint.ejb.wfm.WfmManagerFactory;

/**
 * @author rrajendran
 *
 * The shift assignments associated with this shift bid request comply with the min/max hours
 * specified for the org or bidder.
 *
 */
<span class="nc" id="L46">public class AgentSchedCompliesWithMinMaxHours implements Validator {</span>
<span class="nc" id="L47">	private static final Priority m_tracePriority = RequestUtil.m_defaultTracePriority;</span>

<span class="nc" id="L49">	private static final String CLASS_NAME = AgentSchedCompliesWithMinMaxHours.class.getName();</span>
<span class="nc" id="L50">	private static final Category LOG = Log.initCategory(CLASS_NAME);</span>

	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.rm.requests.common.validation.Validator#validate(com.bluepumpkin.ejb.rm.requests.common.validation.Validatable)
	 */
	@Override
	public ValidationResult validate(Validatable validatable) throws Exception {
		ValidationResult result;
<span class="nc" id="L58">		LOG.log(m_tracePriority, &quot;Validation Rule: &quot; + CLASS_NAME + &quot; started&quot;);</span>

		try {
<span class="nc" id="L61">			ShiftBidRequest sbReq = (ShiftBidRequest) validatable;</span>

			// spStart and spEnd might be bigger than SP if requests cross SP end boundary or SP start boundary
<span class="nc" id="L64">			Date spStart = getDateRange(sbReq).getStartDate();</span>
<span class="nc" id="L65">			Date spEnd = getDateRange(sbReq).getEndDate();</span>

			
<span class="nc" id="L68">			List&lt;TimeRange&gt; allOrgWeeks = getOrgWeeksContainDuration(getOrg(sbReq), spStart, spEnd);</span>
<span class="nc" id="L69">			Date firstOrgWeekStart = allOrgWeeks.get(0).getStartDate();</span>
<span class="nc" id="L70">			Date lastOrgWeekEnd = allOrgWeeks.get(allOrgWeeks.size() - 1).getEndDate();</span>
<span class="nc" id="L71">			Collection&lt;Event&gt; requestedAndScheduledShiftAssns = getRequestedAndScheduledShiftAssns(sbReq, firstOrgWeekStart, lastOrgWeekEnd);</span>
<span class="nc" id="L72">			List&lt;TimeRange&gt; requestedOrgWeeks = getOrgWeeksContainShifts(allOrgWeeks, getRequestedShiftAssignments(sbReq));</span>

<span class="nc" id="L74">			result = null;</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">			for (TimeRange checkedWeek : requestedOrgWeeks) {</span>
<span class="nc" id="L76">				result = validate(sbReq, requestedAndScheduledShiftAssns, checkedWeek);</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">				if (result != null) {</span>
<span class="nc" id="L78">					break;</span>
				}
<span class="nc" id="L80">			}</span>

		} finally {
<span class="nc" id="L83">			LOG.log(m_tracePriority, &quot;Validation Rule: &quot; + CLASS_NAME + &quot; done&quot;);</span>
<span class="nc" id="L84">		}</span>

<span class="nc" id="L86">		return result;</span>
	}

	private Collection&lt;Event&gt; getRequestedAndScheduledShiftAssns(ShiftBidRequest sbReq, Date firstOrgWeekStart, Date lastOrgWeekEnd)
			throws Exception {
		// Shift bids only look at UNPUBLISHED scheds.
<span class="nc" id="L92">		Collection&lt;Event&gt; requestedAndScheduledShiftAssns = new ArrayList&lt;Event&gt;();</span>
		// add shift assignments for this shift bid request.
<span class="nc" id="L94">		requestedAndScheduledShiftAssns.addAll(getRequestedShiftAssignments(sbReq));</span>
		// also add shift assignments from the schedules if any
<span class="nc" id="L96">		Collection&lt;Event&gt; allScheduledEvents = getScheduledEvents(sbReq.getEmployeeID(), firstOrgWeekStart, lastOrgWeekEnd);</span>
<span class="nc" id="L97">		requestedAndScheduledShiftAssns.addAll(allScheduledEvents);</span>
<span class="nc" id="L98">		return requestedAndScheduledShiftAssns;</span>
	}

	private TimeRange getDateRange(ShiftBidRequest sbReq) throws Exception {
<span class="nc" id="L102">		return sbReq.getValidationCache().getDateRange();</span>
	}

	private Organization getOrg(ShiftBidRequest sbReq) throws Exception {
<span class="nc" id="L106">		return sbReq.getValidationCache().getOrg();</span>
	}

	private Collection&lt;ShiftAssignment&gt; getRequestedShiftAssignments(ShiftBidRequest sbReq) {
<span class="nc" id="L110">		return sbReq.getOptMethods().getShiftAssignments();</span>
	}

	@SuppressWarnings(&quot;unchecked&quot;)
	protected Collection&lt;Event&gt; getScheduledEvents(ID employeeID, Date startOfFirstWeek, Date endOfLastWeek) throws Exception {
		// Shift bids only look at UNPUBLISHED scheds.
<span class="nc" id="L116">		return ValidationUtil.getEventsForWorkResourceByType(Event.EVENT_TYPE_SHIFT_ASSIGNMENT,</span>
				employeeID, startOfFirstWeek, endOfLastWeek);
		
		
		
	}

	protected Collection&lt;WorkResourceMinMaxHour&gt; getMinMaxHourAssignments(ShiftBidRequest sbReq, TimeRange week) throws Exception {
<span class="nc" id="L124">		return WfmManagerFactory.getEmpWorkRuleManager().getMinMaxHourAssignments(sbReq.getEmployeeID(), week.getStartDate(), week.getEndDate());</span>
	}

	private ValidationResult validate(ShiftBidRequest sbReq, Collection&lt;Event&gt; requestedAndScheduledShiftAssns, TimeRange checkedWeek) throws Exception {
		ValidationResult result;
		
		
		
     

		// get min/max hours assignment for employee during the bid request's time range.
<span class="nc" id="L135">		WorkResourceMinMaxHour wrMinMaxHour = getMinMaxHourAssnForWeek(sbReq, checkedWeek);</span>

		// check if shift assignments comply with min/max hours.
<span class="nc" id="L138">		Collection&lt;ShiftsConflict&gt; minMaxResults = getMinMaxHourConflicts(sbReq, checkedWeek, wrMinMaxHour, requestedAndScheduledShiftAssns);</span>
		
	        
		// if no min/max validation errors.
<span class="nc bnc" id="L142" title="All 4 branches missed.">		if (minMaxResults == null || minMaxResults.isEmpty()) {</span>
<span class="nc" id="L143">			result = null;</span>
		} else {
			// we lose validation errors if minMaxResults has 2 or more
<span class="nc" id="L146">			result = ValidationUtil.setSoftValidationResult(sbReq,</span>
<span class="nc" id="L147">					RmEjbBundleKey.NONLOCALIZED_MESSAGE, minMaxResults.iterator().next(), CLASS_NAME);</span>
		}
<span class="nc" id="L149">		return result;</span>
	}

	private WorkResourceMinMaxHour getMinMaxHourAssnForWeek(ShiftBidRequest sbReq, TimeRange checkedWeek) throws Exception {
		WorkResourceMinMaxHour wrMinMaxHour;

<span class="nc" id="L155">		Collection&lt;WorkResourceMinMaxHour&gt; minMaxAssns = getMinMaxHourAssignments(sbReq, checkedWeek);</span>

		// return if no assignments found.
<span class="nc bnc" id="L158" title="All 4 branches missed.">		if (minMaxAssns == null || minMaxAssns.isEmpty()) {</span>
<span class="nc" id="L159">			return null;</span>
		}

<span class="nc" id="L162">		wrMinMaxHour = RequestUtil.getMinMaxHourAssnOverlappingTimeRange(minMaxAssns, checkedWeek.getStartDate(), checkedWeek.getEndDate());</span>

<span class="nc bnc" id="L164" title="All 2 branches missed.">		if (wrMinMaxHour == null) {</span>
<span class="nc" id="L165">			throw new RuntimeException(&quot;No min/max hour assignments found: ID,starttime, endttime = &quot; +</span>
<span class="nc" id="L166">				sbReq.getID() + ',' + checkedWeek.getStartDate() + ',' + checkedWeek.getEndDate());</span>
		}
<span class="nc" id="L168">		return wrMinMaxHour;</span>
	}

	private Collection&lt;ShiftsConflict&gt; getMinMaxHourConflicts(ShiftBidRequest sbReq, TimeRange checkedWeek,
			WorkResourceMinMaxHour wrMinMaxHour, Collection&lt;Event&gt; shiftAssns) throws Exception {
		// (minus 1 second from end date because the the method getMinMaxHourConflicts will add 1 second into end date )
<span class="nc" id="L174">		Calendar endCal = Calendar.getInstance(getOrg(sbReq).getTimeZone());</span>
<span class="nc" id="L175">		endCal.setTime(checkedWeek.getEndDate());</span>
<span class="nc" id="L176">		endCal.add(Calendar.SECOND, -1);</span>
<span class="nc" id="L177">		return ShiftsUtil.getMinMaxHourConflicts(shiftAssns, wrMinMaxHour,</span>
<span class="nc" id="L178">				checkedWeek.getStartDate(), endCal.getTime(), getOrg(sbReq), null);</span>
	}


	private List&lt;TimeRange&gt; getOrgWeeksContainShifts( List&lt;TimeRange&gt; orgWeeks, Collection&lt;ShiftAssignment&gt; events) 
			throws Exception {//NOSONAR

<span class="nc" id="L185">		List&lt;TimeRange&gt; result = new ArrayList&lt;TimeRange&gt;();</span>

<span class="nc bnc" id="L187" title="All 2 branches missed.">		for (TimeRange thisWeek : orgWeeks) {</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">			if (hasAssignments(thisWeek, events)) {</span>
<span class="nc" id="L189">				result.add(thisWeek);</span>
			}
<span class="nc" id="L191">		}</span>
				
<span class="nc" id="L193">		return result;</span>
	}

	private List&lt;TimeRange&gt; getOrgWeeksContainDuration(Organization org, Date start, Date end) throws Exception {

<span class="nc" id="L198">		List&lt;TimeRange&gt; result = new ArrayList&lt;TimeRange&gt;();</span>

		// find start time of first org week containing the SP start time
<span class="nc" id="L201">		Date firstOrgWeekStart = getStartOfOrgWeekContainsTime(org, start);</span>

<span class="nc" id="L203">		Calendar cal = Calendar.getInstance(org.getTimeZone());</span>
<span class="nc" id="L204">		cal.setTime(firstOrgWeekStart);</span>

<span class="nc" id="L206">		Date weekStart = cal.getTime();</span>

<span class="nc bnc" id="L208" title="All 2 branches missed.">		for (; weekStart.before(end); weekStart = cal.getTime()) {</span>
<span class="nc" id="L209">			TOCalcUtil.addDaysToCalendar(cal, Calendar.DAY_OF_WEEK);</span>
<span class="nc" id="L210">			result.add(new TimeRange(weekStart, cal.getTime()));</span>
		}

<span class="nc" id="L213">		return result;</span>
	}

	@SuppressWarnings(&quot;deprecation&quot;)
	private Date getStartOfOrgWeekContainsTime(Organization org, Date time) {
<span class="nc" id="L218">		Calendar cal = Calendar.getInstance(org.getTimeZone());</span>
<span class="nc" id="L219">		cal.setTime(time);</span>
		int nDay;
<span class="nc bnc" id="L221" title="All 2 branches missed.">		if (cal.get(Calendar.DAY_OF_WEEK) != org.getWeekStartDate()) {</span>
<span class="nc" id="L222">			nDay = cal.get(Calendar.DAY_OF_WEEK) - org.getWeekStartDate();</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">			if (nDay &lt; 0) {</span>
<span class="nc" id="L224">				nDay += 7;</span>
			}
<span class="nc bnc" id="L226" title="All 2 branches missed.">		} else if (cal.get(Calendar.HOUR) * 60 &lt; org.getDayBoundaryOffset()) {</span>
<span class="nc" id="L227">			nDay = 7;</span>
		} else {
<span class="nc" id="L229">			nDay = 0;</span>
		}
<span class="nc" id="L231">		cal.add(Calendar.DAY_OF_YEAR, -1 * nDay);</span>
<span class="nc" id="L232">		cal.set(Calendar.MINUTE, org.getDayBoundaryOffset());</span>
<span class="nc" id="L233">		return cal.getTime();</span>
	}

	private boolean hasAssignments(TimeRange duration, Collection&lt;ShiftAssignment&gt; shifts) {
		
<span class="nc bnc" id="L238" title="All 2 branches missed.">		for (ShiftAssignment assignment : shifts) {</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">			if (!WorkRuleUtil.isInPeriodAndApproved((Event) assignment, duration.getStartDate(), duration.getEndDate(), WorkRule.STARTSIN))</span>
<span class="nc" id="L240">				continue;</span>
			
<span class="nc bnc" id="L242" title="All 2 branches missed.">			if (new TimeRange(assignment.getStartTime(), assignment.getEndTime()).getOverlapDuration(duration) &gt; 0) {</span>
<span class="nc" id="L243">				return true;</span>
				
			}
<span class="nc" id="L246">		}</span>
		
<span class="nc" id="L248">		return false;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>