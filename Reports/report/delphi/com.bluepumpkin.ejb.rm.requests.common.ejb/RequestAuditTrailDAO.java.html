<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RequestAuditTrailDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.common.ejb</a> &gt; <span class="el_source">RequestAuditTrailDAO.java</span></div><h1>RequestAuditTrailDAO.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.common.ejb;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.Iterator;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.jdmo.Jdmo;
import com.bluepumpkin.common.jdmo.JdmoException;
import com.bluepumpkin.common.jdmo.JdmoRowset;
import com.bluepumpkin.common.keys.DBInfo;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.common.util.StringUtil;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.vo.FieldInfo;
import com.bluepumpkin.ejb.bbm.vo.ValueObjectBase;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrailFieldInfo;
import com.bluepumpkin.common.jdmo.JdmoUtil;

/**
 * Title:        RequestAuditTrailDAO
 * Description:  DAO class for RequestAuditTrail
 * Copyright:    Copyright (c) 2002
 * Company:      Blue Pumpkin Software, Inc.
 * @author       Robert Granat
 * @version 1.0
 */

<span class="pc bpc" id="L35" title="1 of 2 branches missed.">public class RequestAuditTrailDAO extends DAOBase {</span>

<span class="fc" id="L37">  private static Category m_cat = Log.initCategory(RequestAuditTrailDAO.class.getName());</span>
    //todo: modify to retrive auditTrail records in sorted order.    
<span class="fc" id="L39">	private final static FieldInfo m_fieldInfo = new RequestAuditTrailFieldInfo();</span>

	public RequestAuditTrailDAO() {
<span class="nc" id="L42">	   super();</span>
<span class="nc" id="L43">	}</span>

	public RequestAuditTrailDAO(Jdmo dmo) {
<span class="fc" id="L46">	   super(dmo);</span>
<span class="fc" id="L47">	}</span>

    protected FieldInfo getFieldInfo() { 
<span class="fc" id="L50">        return m_fieldInfo; </span>
    }

	protected ValueObjectBase createValueObject()
	{
<span class="fc" id="L55">	   return (new RequestAuditTrail());</span>
	}
    
	/**
	 *  compose a complete sql query statement for finder methods
	 *  &lt;br&gt;Note: Even though the retrieved audit trail records from db are sorted, the 
	 *  sorting is not preserved due to the map used to hold child objects in ValueObjectNode.
	 * 
	 *  @param  strWhere the where condition need to append to the query
	 * 
	 */
	protected StringBuffer getQuerySQL(StringBuffer strWhere)
	{
        // todo: recommend MODIFIEDAT to be an indexed column.
        // todo: assumption is that ORDER BY clause, if it exists, is
        //   the last clause of the SQL statement.           
<span class="fc" id="L71">        StringBuffer strBuf = super.getQuerySQL(strWhere);</span>
<span class="fc" id="L72">        String qry = strBuf.toString().toUpperCase();</span>
        // if 'ORDER' doesn't exist
<span class="fc bfc" id="L74" title="All 2 branches covered.">        if (qry.indexOf(&quot;ORDER&quot;) &lt; 0 ) {</span>
<span class="fc" id="L75">            return strBuf.append(&quot; ORDER BY A.MODIFIEDAT ASC&quot;);</span>
        }
        
        // an ORDER clause already exists.
<span class="fc" id="L79">        return strBuf.append(&quot;, A.MODIFIEDAT ASC&quot;);</span>
        
	}    
    
  /**
   *  insert the value object into database
   *  overwrites {@link com.bluepumpkin.ejb.bbm.dao.DAOBase#createObject(ValueObjectBase,boolean) 
   *  createObject(ValueObjectBase, boolean) in DAOBase} to handle the creation of LargeString 
   *  for Note when Note is longer than the maximum length allowed in the Note column.
   *  @param objValue object to be inserted
   *  @param bBatched indicates whether or not this createObject operation is
   *                  part of a larger batch of database operations
   *  @return value object ID
   *  @throws BbmCreateException
   */
  public ID createObject(ValueObjectBase objValue, boolean bBatched)
  throws BbmCreateException
  {
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">    if (objValue == null) return null;</span>
        
<span class="fc" id="L99">    RequestAuditTrail auditTrail = (RequestAuditTrail)objValue;</span>
<span class="fc" id="L100">    String note = auditTrail.getNote();</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">    if (note.length() &gt; DBInfo.REQUESTAUDITTRAIL_NOTE_MAXLENGTH) {</span>
      try {
<span class="nc" id="L103">        ID stringHandle = m_dmo.insertLargeString(note);</span>
<span class="nc" id="L104">        auditTrail.setNote(&quot;&quot;);</span>
<span class="nc" id="L105">        auditTrail.setStringHandle(stringHandle);</span>
      }
<span class="nc" id="L107">      catch (JdmoException ex) {</span>
<span class="nc" id="L108">       throw RequestUtil.createBbmCreateExceptionWrapper(ex, m_cat); </span>
<span class="nc" id="L109">      }</span>
    }
        
<span class="fc" id="L112">    return super.createObject(objValue, bBatched);</span>
  }   
        
    
  /**
   * get a collection of objects given a filter condition
   * overwrites the {@link com.bluepumpkin.ejb.bbm.dao.DAOBase#getObjects(String) 
   * getObjects(String) in DAOBase}, to handle the retrieval from LargeString table
   * when the Note is null and StringHandle is not null
   * @param strWhere an sql filter condition. This should NOT start with 
   * sql keywords &lt;pre&gt;WHERE&lt;/pre&gt; or &lt;pre&gt;AND&lt;/pre&gt;.  
   * @throws BbmFinderException 
   */
  public Collection getObjects(String strWhere)
  throws BbmFinderException
  {
<span class="fc" id="L128">    Collection objs = super.getObjects(strWhere);</span>
    
<span class="fc bfc" id="L130" title="All 2 branches covered.">    for (Iterator itr=objs.iterator(); itr.hasNext(); ) {</span>
<span class="fc" id="L131">      RequestAuditTrail auditTrail = (RequestAuditTrail)itr.next();</span>
<span class="fc" id="L132">      ID strHandle = auditTrail.getStringHandle();</span>
<span class="fc" id="L133">      String note = auditTrail.getNote();</span>
<span class="fc" id="L134">      boolean noteIsEmpty = StringUtil.isEmpty(note);</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">      if (strHandle != null) {</span>
<span class="nc bnc" id="L136" title="All 4 branches missed.">        assert noteIsEmpty : &quot;Note is not empty when StringHandle != null&quot; ;</span>
        try {
<span class="nc" id="L138">          note = m_dmo.getLargeString(strHandle);</span>
<span class="nc" id="L139">          auditTrail.setNote(note);</span>
        }
<span class="nc" id="L141">        catch (JdmoException ex) {</span>
<span class="nc" id="L142">          throw RequestUtil.createBbmFinderExceptionWrapper(ex, m_cat); </span>
<span class="nc" id="L143">        }</span>
      }
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">      else if (!noteIsEmpty){</span>
<span class="pc bpc" id="L146" title="3 of 4 branches missed.">        assert strHandle == null : &quot;StringHandle != null when Note is not empty&quot;;</span>
      }
<span class="fc" id="L148">    }</span>
    
<span class="fc" id="L150">    return objs;</span>
  }

  /**
   * Gets the non-null StringHandle IDs. These reference the LargeString table, and
   * are used by {@link RequestAuditTrail RequestAuditTrail} to hold Notes that are 
   * longer than the maximum length allowed in the Note column.
   * @param colIDs  IDs of RequestAuditTrail objects
   * @return a Collection of StringHandleIDs
   * @throws JdmoException
   */
  private Collection getStringHandles(Collection colIDs) 
  throws JdmoException {
<span class="nc" id="L163">    StringBuffer inClause = new StringBuffer();</span>
<span class="nc" id="L164">    inClause.append(&quot;ID in &quot;).append(m_dmo.createInClause(colIDs));</span>
<span class="nc" id="L165">    return getStringHandlesWithInClause(inClause.toString());</span>
  }

  /**
   * Gets the non-null StringHandle IDs. These reference the LargeString table, and
   * are used by {@link RequestAuditTrail RequestAuditTrail} to hold Notes that are 
   * longer than the maximum length allowed in the Note column.
   * @param requestSelect An sql select query that returns the IDs of
   * {@link com.bluepumpkin.ejb.rm.requests.common.model.Request Request} IDs.
   * @return a Collection of StringHandleIDs
   * @throws JdmoException
   */
  private Collection getStringHandles(String requestSelect)
  throws JdmoException {
<span class="fc" id="L179">    StringBuffer inClause = new StringBuffer();</span>
<span class="fc" id="L180">    inClause.append(&quot;REQUESTID IN (&quot;).append(requestSelect).append(&quot;)&quot;);</span>
<span class="fc" id="L181">    return getStringHandlesWithInClause(inClause.toString());</span>
  }

  /**
   * Gets {@link com.bluepumpkin.ejb.rm.requests.common.model.RequestAuditTrail#StringHandle 
   * StringHandles}.  
   * @param inClause A String that when used as an in clause for an SQL select statement, selects
   * {@link RequestAuditTrail RequestAuditTrail} IDs. Two examples:
   * &lt;li&gt; &quot;REQUESTID IN (SELECT ID FROM REQUEST WHERE ....)
   * &lt;li&gt; &quot;ID IN (_id1, _id2, ...)&quot;
   * @return a Collection of StringHandles, which are IDs of the LargeString table.
   * @throws JdmoException
   */
  private Collection getStringHandlesWithInClause(String inClause) 
   throws JdmoException {       
<span class="fc" id="L196">     ArrayList strHandles = new ArrayList(); </span>

<span class="fc" id="L198">     StringBuffer sqlBuf = new StringBuffer();</span>
<span class="fc" id="L199">     sqlBuf.append( &quot;SELECT STRINGHANDLE &quot;).</span>
<span class="fc" id="L200">     append( &quot;FROM &quot;).append(m_fieldInfo.getTableName()).</span>
<span class="fc" id="L201">     append(&quot; WHERE &quot;).append(inClause).</span>
<span class="fc" id="L202">     append(&quot; AND STRINGHANDLE IS NOT NULL&quot;);</span>

<span class="fc" id="L204">     JdmoRowset rs = m_dmo.createRowset(sqlBuf.toString());</span>
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">     while (rs.next()) {</span>
<span class="nc" id="L206">       ID strHandle = rs.getID(&quot;STRINGHANDLE&quot;);</span>
<span class="nc" id="L207">       strHandles.add(strHandle);</span>
<span class="nc" id="L208">     }</span>
     
<span class="fc" id="L210">     return strHandles;</span>
   }
  
  /**
   * delete objects given a list of their ids
   * overwrites the {@link com.bluepumpkin.ejb.bbm.dao.DAOBase#deleteObjects(Collection) 
   * deleteObjects(Collection) in DAOBase}, to handle the deletion of referenced rows in 
   * the LargeString table.
   * @param colIDs 
   * @throws BbmRemoveException
   */
  public void deleteObjects(Collection colIDs)
  throws BbmRemoveException
  {
    try {
<span class="nc" id="L225">      Collection strHandles = getStringHandles(colIDs);</span>
<span class="nc" id="L226">      m_dmo.deleteLargeStrings(strHandles);</span>
<span class="nc" id="L227">      super.deleteObjects(colIDs);</span>
    }
<span class="nc" id="L229">    catch (JdmoException ex) {</span>
<span class="nc" id="L230">      throw RequestUtil.createBbmRemoveExceptionWrapper(ex, m_cat); </span>
<span class="nc" id="L231">    }</span>
<span class="nc" id="L232">  }</span>
  
  /**
   * Gets ids of requests that have been modified after the specified date
   * @throws JdmoException
   */
  public Collection getRequestIDsByStatusChangeAndType(Date date) 
   throws JdmoException {       
<span class="nc" id="L240">     ArrayList requestIDs = new ArrayList(); </span>

<span class="nc" id="L242">     StringBuffer sqlBuf = new StringBuffer();</span>
<span class="nc" id="L243">     sqlBuf.append( &quot;select distinct requestid &quot;).</span>
<span class="nc" id="L244">     append( &quot;FROM &quot;).append(m_fieldInfo.getTableName()).</span>
<span class="nc" id="L245">     append(&quot; WHERE modifiedat &gt; '&quot;).append(JdmoUtil.formatDBString(date)).</span>
<span class="nc" id="L246">     append(&quot;'&quot;).</span>
<span class="nc" id="L247">     append(&quot; AND ISSTATUSCHANGE = 1&quot;);</span>
<span class="nc" id="L248">     JdmoRowset rs = m_dmo.createRowset(sqlBuf.toString());</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">     while (rs.next()) {</span>
<span class="nc" id="L250">       ID requestID = rs.getID(&quot;REQUESTID&quot;);</span>
<span class="nc" id="L251">       requestIDs.add(requestID);</span>
<span class="nc" id="L252">     }</span>
     
<span class="nc" id="L254">     return requestIDs;</span>
   }
  
  /**
   * Deletes any associated LargeString objects that are referenced by the
   * StringHandle column. This is a bit of a hack because the LargeString objects
   * won't get deleted by cascade delete (because there is no foreign key). The
   * referencing RequestAuditTrail objects are not deleted here because they will
   * be deleted by cascade delete.
   * @param strSQL An SQL select statement that returns 
   * {@link com.bluepumpkin.ejb.rm.requests.common.model.Request Request} IDs.
   * @throws BbmRemoveException
   */
  public void deleteLargeStrings(String strSQL) 
  throws BbmRemoveException {
    
    try {
<span class="fc" id="L271">      Collection strHandles = getStringHandles(strSQL);</span>
<span class="fc" id="L272">      m_dmo.deleteLargeStrings(strHandles);</span>
    }
<span class="nc" id="L274">    catch (JdmoException ex) {</span>
<span class="nc" id="L275">      throw RequestUtil.createBbmRemoveExceptionWrapper(ex, m_cat); </span>
<span class="fc" id="L276">    }</span>
<span class="fc" id="L277">   }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>