<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TimeOffIntervalAllocationManagerEJB.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.ejb</a> &gt; <span class="el_source">TimeOffIntervalAllocationManagerEJB.java</span></div><h1>TimeOffIntervalAllocationManagerEJB.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.ejb;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.TimeZone;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.base.BbmRemoveException;
import com.bluepumpkin.ejb.bbm.base.BbmUpdateException;
import com.bluepumpkin.ejb.bbm.dao.DAOBase;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.core.base.SessionEJBBase;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.requests.timeoff.ejb.TOChoiceDAO;
import com.bluepumpkin.ejb.rm.requests.timeoff.ejb.TORequestDAO;
import com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.TimeOffIntervalPaidSegmentCalculator;
import com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.TimeOffIntervalPaidSegmentCalendarEventCalculator;
import com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.model.TimeOffIntervalPaidSegment;
import com.bluepumpkin.ejb.rm.requests.timeoff.intervalallocation.model.TimeOffIntervalPaidSegmentCalendarEvent;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TOChoice;
import com.bluepumpkin.ejb.rm.requests.timeoff.model.TORequest;
import com.bluepumpkin.ejb.rm.util.RmUtil;

<span class="nc" id="L36">public class TimeOffIntervalAllocationManagerEJB extends SessionEJBBase {</span>

	private static final long serialVersionUID = 3308628928481776660L;
<span class="nc" id="L39">	private static final String CLASSNAME = TimeOffIntervalAllocationManagerEJB.class</span>
<span class="nc" id="L40">			.getName();</span>
<span class="nc" id="L41">	private static final Category LOG = Log</span>
<span class="nc" id="L42">			.initCategory(TimeOffIntervalAllocationManagerEJB.CLASSNAME);</span>

	
	// non-static initializer
	{
<span class="nc" id="L47">		super.init(TimeOffIntervalAllocationManagerEJB.class.getName());</span>
<span class="nc" id="L48">	}</span>

	/**
	 * override the base class to provide the appropriate logging category
	 */
	@Override
	protected Category getCategory() {
<span class="nc" id="L55">		return LOG;</span>
	}


	public void deleteTimeOffIntervalPaidSegmentsForTimeOffChoice(
			TOChoice toChoice) throws BbmRemoveException{

<span class="nc" id="L62">		String methodName = &quot;deleteTimeOffIntervalPaidSegmentsForTimeOffChoice&quot;;</span>
<span class="nc" id="L63">		enterMethod(methodName);</span>

		

<span class="nc bnc" id="L67" title="All 2 branches missed.">		if (toChoice == null){</span>
<span class="nc" id="L68">			return;</span>
		}
	
<span class="nc" id="L71">		TimeOffIntervalPaidSegmentDAO dao = null;</span>

		try {
<span class="nc" id="L74">			dao = new TimeOffIntervalPaidSegmentDAO();</span>
<span class="nc" id="L75">			dao.deleteTimeOffIntervalPaidSegmentsForTimeOffChoice(toChoice</span>
<span class="nc" id="L76">					.getID());</span>
<span class="nc" id="L77">		} catch (Exception e) {</span>
<span class="nc" id="L78">			throw new BbmRemoveException(e);</span>
		} finally {
<span class="nc" id="L80">			cleanUp(dao);</span>
<span class="nc" id="L81">		}</span>
<span class="nc" id="L82">		exitMethod(methodName);</span>

<span class="nc" id="L84">	}</span>



	public void updateTimeOffIntervalPaidSegment(
			TimeOffIntervalPaidSegment segment) throws BbmUpdateException{

<span class="nc" id="L91">		String methodName = &quot;updateTimeOffIntervalPaidSegment&quot;;</span>
<span class="nc" id="L92">		enterMethod(methodName);</span>

		
<span class="nc" id="L95">		TimeOffIntervalPaidSegmentDAO dao = null;</span>

		try {
<span class="nc" id="L98">			dao = new TimeOffIntervalPaidSegmentDAO();</span>
<span class="nc" id="L99">			dao.updateTimeOffIntervalPaidSegment(segment);</span>
<span class="nc" id="L100">		} catch (Exception e) {</span>
<span class="nc" id="L101">			throw new BbmUpdateException(e);</span>
		} finally {
<span class="nc" id="L103">			cleanUp(dao);</span>
<span class="nc" id="L104">		}</span>
		
<span class="nc" id="L106">		exitMethod(methodName);</span>
<span class="nc" id="L107">	}</span>

	public TimeOffIntervalPaidSegment getTimeOffIntervalPaidSegment(ID id) throws BbmFinderException{

<span class="nc" id="L111">		String methodName = &quot;getTimeOffIntervalPaidSegment&quot;;</span>
<span class="nc" id="L112">		enterMethod(methodName);</span>

	
<span class="nc" id="L115">		TimeOffIntervalPaidSegmentDAO dao = null;</span>
<span class="nc" id="L116">		TimeOffIntervalPaidSegment segment = null;</span>
		try {
<span class="nc" id="L118">			dao = new TimeOffIntervalPaidSegmentDAO();</span>
<span class="nc" id="L119">			segment = dao.getObjectByID(id);</span>
<span class="nc" id="L120">		} catch (Exception e) {</span>
<span class="nc" id="L121">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L123">			cleanUp(dao);</span>
<span class="nc" id="L124">		}</span>
		
<span class="nc" id="L126">		exitMethod(methodName);</span>
<span class="nc" id="L127">		return segment;</span>
	}

	public List&lt;TimeOffIntervalPaidSegment&gt; findTimeOffIntervalPaidSegmentsForTimeOffChoice(
			TOChoice toChoice)  throws BbmFinderException {

		
<span class="nc" id="L134">		String methodName = &quot;findTimeOffIntervalPaidSegmentsForTimeOffChoice&quot;;</span>
<span class="nc" id="L135">		enterMethod(methodName);</span>

<span class="nc" id="L137">		List&lt;TimeOffIntervalPaidSegment&gt; list = null;</span>
		
<span class="nc" id="L139">		TimeOffIntervalPaidSegmentDAO dao = null;</span>

		try {
<span class="nc" id="L142">			dao = new TimeOffIntervalPaidSegmentDAO();</span>
<span class="nc" id="L143">			list = dao.findTimeOffIntervalPaidSegmentsForTimeOffChoice(toChoice</span>
<span class="nc" id="L144">					.getID());</span>
<span class="nc" id="L145">		} catch (Exception e) {</span>
<span class="nc" id="L146">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L148">			cleanUp(dao);</span>
<span class="nc" id="L149">		}</span>
		
<span class="nc" id="L151">		exitMethod(methodName);</span>

<span class="nc" id="L153">		return list;</span>

	}

	public List&lt;TimeOffIntervalPaidSegment&gt; findTimeOffIntervalPaidSegmentsIntersectTimeRange(
			TimeRange timeRange) throws BbmFinderException {
<span class="nc" id="L159">		String methodName = &quot;findTimeOffIntervalPaidSegmentsIntersectTimeRange&quot;;</span>
<span class="nc" id="L160">		enterMethod(methodName);</span>
		
<span class="nc" id="L162">		TimeOffIntervalPaidSegmentDAO dao = null;</span>
<span class="nc" id="L163">		List&lt;TimeOffIntervalPaidSegment&gt; list = null;</span>

		try {
<span class="nc" id="L166">			dao = new TimeOffIntervalPaidSegmentDAO();</span>
<span class="nc" id="L167">			list = dao</span>
<span class="nc" id="L168">					.findTimeOffIntervalPaidSegmentsIntersectTimeRange(timeRange);</span>
<span class="nc" id="L169">		} catch (Exception e) {</span>
<span class="nc" id="L170">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L172">			cleanUp(dao);</span>
<span class="nc" id="L173">		}</span>
<span class="nc" id="L174">		exitMethod(methodName);</span>
<span class="nc" id="L175">		return list;</span>

	}



	List&lt;ID&gt; createTimeOffIntervalPaidSegments(
			Collection&lt;TimeOffIntervalPaidSegment&gt; listOfSegments, Map&lt;ID, ID&gt; mapTOChoiceToReferenceScheduleID) throws BbmCreateException{

<span class="nc" id="L184">		String methodName = &quot;createTimeOffIntervalPaidSegments&quot;;</span>
<span class="nc" id="L185">		enterMethod(methodName);</span>

<span class="nc" id="L187">		List&lt;ID&gt; listOfIDs = null;</span>
<span class="nc" id="L188">		TimeOffIntervalPaidSegmentDAO dao = null;</span>
<span class="nc" id="L189">		TOChoiceDAO toChoiceDAO = null;</span>
		
		try {
<span class="nc" id="L192">			dao = new TimeOffIntervalPaidSegmentDAO();</span>
<span class="nc" id="L193">			listOfIDs = (List&lt;ID&gt;) dao.createObjects(listOfSegments);</span>
			
			//Update the TOChoice reference schedule
<span class="nc bnc" id="L196" title="All 4 branches missed.">			if(mapTOChoiceToReferenceScheduleID != null &amp;&amp; !mapTOChoiceToReferenceScheduleID.isEmpty()){</span>
<span class="nc" id="L197">				toChoiceDAO = new TOChoiceDAO();</span>
<span class="nc" id="L198">				toChoiceDAO.updateReferenceScheduleIDs(mapTOChoiceToReferenceScheduleID);</span>
			}
			
<span class="nc" id="L201">		} catch (Exception e) {</span>
<span class="nc" id="L202">			throw new BbmCreateException(e);</span>
		} finally {
<span class="nc" id="L204">			cleanUp(dao);</span>
<span class="nc" id="L205">			cleanUp(toChoiceDAO);</span>
<span class="nc" id="L206">		}</span>
		
<span class="nc" id="L208">		exitMethod(methodName);</span>

<span class="nc" id="L210">		return listOfIDs;</span>

	}
	


	private List&lt;ID&gt; updateTimeOffIntervalPaidSegmentsForTORequest(TORequest toRequest) throws Exception{
<span class="nc" id="L217">		return onCreateTORequest(toRequest);</span>
	}
	
	/*
	 * updateTimeOffIntervalsbyTimeOffChoice
	 * Given a list of choices and requests, delete then recreate the segments per choice
	 * Called from publish/unpublish schedules. We only update the choices passed in.
	 * returns a list of segment ids created
	 */
	public List&lt;ID&gt; updateTimeOffIntervalsForTimeOffChoices(Collection&lt;TORequest&gt; listRequests, List&lt;ID&gt; timeOffChoiceIDs)
			throws BbmUpdateException {
<span class="nc" id="L228">		String methodName = &quot;updateTimeOffIntervalsForTimeOffChoices&quot;;</span>
<span class="nc" id="L229">		enterMethod(methodName);</span>
<span class="nc" id="L230">		List&lt;TimeOffIntervalPaidSegment&gt; listOfSegments = new ArrayList&lt;TimeOffIntervalPaidSegment&gt;();</span>
<span class="nc" id="L231">		Map&lt;ID, ID&gt; mapTOChoiceToReferenceScheduleID = new HashMap&lt;ID, ID&gt;();</span>
		
		try{
<span class="nc" id="L234">			deleteTimeOffIntervalsByTimeOffChoices(timeOffChoiceIDs);</span>
			
<span class="nc bnc" id="L236" title="All 2 branches missed.">			for( TORequest request : listRequests){</span>
				
<span class="nc" id="L238">				TimeOffIntervalPaidSegmentCalculator calculator = new TimeOffIntervalPaidSegmentCalculator();</span>
<span class="nc" id="L239">				List&lt;TimeOffIntervalPaidSegment&gt; segments = calculator</span>
<span class="nc" id="L240">						.updateTimeOffIntervalPaidSegmentsChoices(request, timeOffChoiceIDs);</span>
<span class="nc" id="L241">				listOfSegments.addAll(segments);</span>
				
				//Update the map of Choices to Reference Schedules
<span class="nc" id="L244">				Map&lt;ID, ID&gt; mapChoiceToRefSchedule = calculator.getMapTOChoiceReferenceScheduleID();</span>
<span class="nc" id="L245">				mapTOChoiceToReferenceScheduleID.putAll(mapChoiceToRefSchedule);</span>
<span class="nc" id="L246">			}</span>
		
<span class="nc" id="L248">		return createTimeOffIntervalPaidSegments(listOfSegments, mapTOChoiceToReferenceScheduleID);</span>
		
<span class="nc" id="L250">		} catch(Exception e){</span>
<span class="nc" id="L251">			throw new BbmUpdateException(e);</span>
		} finally{
<span class="nc" id="L253">			exitMethod(methodName);</span>
		}
		
	}
	
	// Load all requests from choiceIDs
	public Collection&lt;TORequest&gt; getTORequestsFromChoiceIDs(List&lt;ID&gt; timeOffChoiceIDs)
			throws BbmFinderException {
<span class="nc" id="L261">		String methodName = &quot;getTORequestsFromChoiceIDs&quot;;</span>
<span class="nc" id="L262">		enterMethod(methodName);</span>
<span class="nc" id="L263">		TORequestDAO toReqDao = null;</span>
		try{
<span class="nc" id="L265">			toReqDao = new TORequestDAO(TORequest.DL_BASIC| TORequest.DL_TIMEOFF_CHOICES  | TORequest.DL_TIMEOFF_CHOICES_LENGTH);</span>
<span class="nc" id="L266">			return toReqDao.getRequestsFromChoiceIDs(timeOffChoiceIDs);</span>
<span class="nc" id="L267">		}catch(Exception e){</span>
<span class="nc" id="L268">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc bnc" id="L270" title="All 4 branches missed.">			if (toReqDao != null) {</span>
<span class="nc" id="L271">				toReqDao.cleanUp();</span>
			}
<span class="nc" id="L273">			exitMethod(methodName);</span>
		}
	}
	
	private void deleteTimeOffIntervalsByTimeOffChoices(List&lt;ID&gt; timeOffChoiceIDs) throws BbmRemoveException{
	
<span class="nc" id="L279">		String methodName = &quot;deleteTimeOffIntervalsByTimeOffChoices&quot;;</span>
<span class="nc" id="L280">		enterMethod(methodName);</span>
<span class="nc" id="L281">		TimeOffIntervalPaidSegmentDAO dao = null;</span>
		try {
<span class="nc" id="L283">			dao  = new TimeOffIntervalPaidSegmentDAO();</span>
<span class="nc" id="L284">			dao.deleteTimeOffIntervalsForTimeOffChoices(timeOffChoiceIDs);</span>
<span class="nc" id="L285">		} catch (Exception e) {</span>
<span class="nc" id="L286">			throw new BbmRemoveException(e);</span>
		} finally {
<span class="nc" id="L288">			cleanUp(dao);</span>
<span class="nc" id="L289">		}</span>
		
<span class="nc" id="L291">		exitMethod(methodName);</span>
<span class="nc" id="L292">	}</span>
		
	
	
	
	private void deleteTimeOffIntervalPaidSegmentsForTORequest(TORequest request) throws BbmRemoveException{
<span class="nc" id="L298">		String methodName = &quot;deleteTimeOffIntervalPaidSegmentsForTORequest&quot;;</span>
<span class="nc" id="L299">		enterMethod(methodName);</span>

<span class="nc" id="L301">		List&lt;ID&gt; toChoiceIDs = new ArrayList&lt;ID&gt;();</span>
		
		
		@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L305">		List&lt;TOChoice&gt; list = request.getRequestChoiceList();</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">		for (TOChoice toChoice : list) {</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">			if(toChoice==null){</span>
<span class="nc" id="L308">				continue;</span>
			}
<span class="nc" id="L310">			toChoiceIDs.add(toChoice.getID());</span>
<span class="nc" id="L311">		}</span>
		
<span class="nc" id="L313">		TimeOffIntervalPaidSegmentDAO dao = null;</span>

		try {
<span class="nc" id="L316">			dao = new TimeOffIntervalPaidSegmentDAO();</span>
<span class="nc" id="L317">			dao.deleteTimeOffIntervalsForTimeOffChoices(toChoiceIDs);</span>
<span class="nc" id="L318">		} catch (Exception e) {</span>
<span class="nc" id="L319">			throw new BbmRemoveException(e);</span>
		} finally {
<span class="nc" id="L321">			cleanUp(dao);</span>
<span class="nc" id="L322">		}</span>
		
<span class="nc" id="L324">		exitMethod(methodName);</span>
<span class="nc" id="L325">	}</span>
	
	
	
	
	
	
	
	public List&lt;ID&gt; onUpdateTORequest(TORequest toRequest) throws Exception {
<span class="nc" id="L334">		return updateTimeOffIntervalPaidSegmentsForTORequest(toRequest);</span>
	}
	
	public List&lt;ID&gt; onCreateTORequest(TORequest toRequest) throws Exception {
<span class="nc" id="L338">		return createTimeOffIntervalPaidSegmentsForTORequest(toRequest);</span>
	}
	
	private List&lt;ID&gt; createTimeOffIntervalPaidSegmentsForTORequest(
			TORequest toRequest) throws Exception {
		
<span class="nc" id="L344">		deleteTimeOffIntervalPaidSegmentsForTORequest(toRequest);</span>
<span class="nc" id="L345">		TimeOffIntervalPaidSegmentCalculator calculator = new TimeOffIntervalPaidSegmentCalculator();</span>
<span class="nc" id="L346">		List&lt;TimeOffIntervalPaidSegment&gt; list = calculator.generateTimeOffIntervalPaidSegmentsForTORequest(toRequest);</span>
<span class="nc" id="L347">		Map&lt;ID, ID&gt; mapTOChoiceToReferenceSchedule = calculator.getMapTOChoiceReferenceScheduleID();</span>
<span class="nc" id="L348">		return createTimeOffIntervalPaidSegments(list, mapTOChoiceToReferenceSchedule);</span>
	}


	public List&lt;EmployeeSPTimeZone&gt; getReferenceScheduleTimeZones(Collection&lt;EmployeeDate&gt; employeeDates) throws BbmFinderException {
<span class="nc" id="L353">		ReferenceScheduleAssignmentsDAO dao = null;</span>
		try {
<span class="nc" id="L355">			dao = new ReferenceScheduleAssignmentsDAO();</span>
<span class="nc" id="L356">			return dao.getReferenceScheduleTimeZones(employeeDates);</span>
<span class="nc" id="L357">		} catch (Exception e) {</span>
<span class="nc" id="L358">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L360">			cleanUp(dao);</span>
		}
	}

	public Map&lt;EmployeeSpID, List&lt;ShiftAssignment&gt;&gt; getReferenceScheduleAssignments(Collection&lt;EmployeeSpID&gt; employeeSpIDs) throws BbmFinderException {
<span class="nc" id="L365">		ReferenceScheduleAssignmentsDAO dao = null;</span>
		try {
<span class="nc" id="L367">			dao = new ReferenceScheduleAssignmentsDAO();</span>
<span class="nc" id="L368">			return dao.getReferenceScheduleAssignments(employeeSpIDs);</span>
<span class="nc" id="L369">		} catch (Exception e) {</span>
<span class="nc" id="L370">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L372">			cleanUp(dao);</span>
		}
	}
	
	public Map&lt;EmployeeDate, ID&gt; getReferenceScheduleSPDEID(Collection&lt;EmployeeDate&gt; employeeDates) throws BbmFinderException {
<span class="nc" id="L377">		ReferenceScheduleAssignmentsDAO dao = null;</span>
		try {
<span class="nc" id="L379">			dao = new ReferenceScheduleAssignmentsDAO();</span>
<span class="nc" id="L380">			return dao.getReferenceScheduleSPDEID(employeeDates);</span>
<span class="nc" id="L381">		} catch (Exception e) {</span>
<span class="nc" id="L382">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L384">			cleanUp(dao);</span>
		}

	}
	
	public Map&lt;IdDateRange, Integer&gt; getPeriodStatus(Collection&lt;IdDateRange&gt; periods) throws BbmFinderException{
		
<span class="nc bnc" id="L391" title="All 4 branches missed.">		if (periods == null || periods.isEmpty()) {</span>
<span class="nc" id="L392">			return Collections.emptyMap();</span>
		}

<span class="nc" id="L395">		PublishingPeriodStatusDAO dao = null;</span>
		try {
<span class="nc" id="L397">			dao = new PublishingPeriodStatusDAO();</span>
<span class="nc" id="L398">			return dao.getPeriodStatus(periods);</span>
<span class="nc" id="L399">		} catch (Exception e) {</span>
<span class="nc" id="L400">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L402">			cleanUp(dao);</span>
		}
		
	}
	
	public Map&lt;Integer, TimeOffRequestChoiceSegment&gt; checkAllocation(List&lt;ID&gt; listOfRequestsIDs) throws BbmFinderException{
<span class="nc bnc" id="L408" title="All 4 branches missed.">		if (listOfRequestsIDs == null || listOfRequestsIDs.isEmpty()) {</span>
<span class="nc" id="L409">			return Collections.emptyMap();</span>
		}

<span class="nc" id="L412">		TimeoffIntervalAllocationUtilDAO dao = null;</span>
		try {
<span class="nc" id="L414">			dao = new TimeoffIntervalAllocationUtilDAO();</span>
<span class="nc" id="L415">			return dao.checkAllocation(listOfRequestsIDs);</span>
<span class="nc" id="L416">		} catch (Exception e) {</span>
<span class="nc" id="L417">			throw new BbmFinderException(e);</span>
		} finally {
<span class="nc" id="L419">			cleanUp(dao);</span>
		}
	}
	

	public List&lt;ShiftAssignment&gt; getReferenceSchedules(Organization organization,
			ID employeeID, Date start, Date end) throws BbmFinderException  {

<span class="nc" id="L427">		TimeZone tz = organization.getTimeZone();</span>

<span class="nc" id="L429">		List&lt;EmployeeDate&gt; employeeDates = Collections</span>
<span class="nc" id="L430">				.singletonList(new EmployeeDate(employeeID, start));</span>

<span class="nc" id="L432">		ReferenceScheduleLoader loader = new ReferenceScheduleLoader();</span>
<span class="nc" id="L433">		loader.initialize(employeeDates);</span>

<span class="nc" id="L435">		List&lt;ShiftAssignment&gt; referencedShiftEvents = (List&lt;ShiftAssignment&gt;) loader</span>
<span class="nc" id="L436">				.getReferenceSchedules(employeeID, start, end, tz);//NOSONAR</span>
<span class="nc" id="L437">		return referencedShiftEvents;</span>
	}

	
	public List&lt;ID&gt; updateTimeOffIntervalPaidSegmentCalendarEvents(List&lt;Event&gt; calendarEventAssignments) throws BbmUpdateException {
<span class="nc bnc" id="L442" title="All 4 branches missed.">		if (calendarEventAssignments == null || calendarEventAssignments.isEmpty()) {</span>
<span class="nc" id="L443">			return Collections.emptyList();</span>
		}
<span class="nc" id="L445">		String methodName = &quot;updateTimeOffIntervalPaidSegmentCalendarEvents&quot;;</span>
<span class="nc" id="L446">		enterMethod(methodName);</span>
		
<span class="nc" id="L448">		List&lt;TimeOffIntervalPaidSegmentCalendarEvent&gt; listOfSegments = new ArrayList&lt;TimeOffIntervalPaidSegmentCalendarEvent&gt;();</span>
		
		
		try{
<span class="nc" id="L452">			deleteTimeOffIntervalPaidSegmentCalendarEvents(calendarEventAssignments);</span>
			
				
<span class="nc" id="L455">			TimeOffIntervalPaidSegmentCalendarEventCalculator calculator = new TimeOffIntervalPaidSegmentCalendarEventCalculator();</span>
<span class="nc" id="L456">				List&lt;TimeOffIntervalPaidSegmentCalendarEvent&gt; segments = calculator</span>
<span class="nc" id="L457">						.updateTimeOffIntervalPaidSegmentsCalendarEvents(calendarEventAssignments);</span>
<span class="nc" id="L458">				listOfSegments.addAll(segments);</span>
				
		
<span class="nc" id="L461">		return createTimeOffTimeOffIntervalPaidSegmentCalendarEvents(listOfSegments);</span>
		
<span class="nc" id="L463">		} catch(Exception e){</span>
<span class="nc" id="L464">			throw new BbmUpdateException(e);</span>
		} finally{
<span class="nc" id="L466">			exitMethod(methodName);</span>
		}
	}
	
	
	private List&lt;ID&gt; createTimeOffTimeOffIntervalPaidSegmentCalendarEvents(List&lt;TimeOffIntervalPaidSegmentCalendarEvent&gt; listOfSegments)  
			throws BbmCreateException{
		
<span class="nc" id="L474">			String methodName = &quot;createTimeOffTimeOffIntervalPaidSegmentCalendarEvents&quot;;</span>
<span class="nc" id="L475">			enterMethod(methodName);</span>

			
<span class="nc" id="L478">			TimeOffIntervalPaidSegmentCalendarEventDAO dao = null;</span>
			
			try {
<span class="nc" id="L481">				dao = new TimeOffIntervalPaidSegmentCalendarEventDAO();</span>
<span class="nc" id="L482">				return (List&lt;ID&gt;) dao.createObjects(listOfSegments);</span>
				
<span class="nc" id="L484">			} catch (Exception e) {</span>
<span class="nc" id="L485">				throw new BbmCreateException(e);</span>
			} finally {
<span class="nc" id="L487">				cleanUp(dao);</span>
<span class="nc" id="L488">				exitMethod(methodName);</span>
			}

	}


	public void deleteTimeOffIntervalPaidSegmentCalendarEvents(Collection&lt;Event&gt; calendarEventAssignments) throws BbmRemoveException {
<span class="nc bnc" id="L495" title="All 4 branches missed.">		if (calendarEventAssignments == null || calendarEventAssignments.isEmpty()) {</span>
<span class="nc" id="L496">			return;</span>
		}
<span class="nc" id="L498">		List&lt;ID&gt; ids = new ArrayList&lt;ID&gt;();</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">		for(Event e : calendarEventAssignments){</span>
<span class="nc" id="L500">			ids.add(e.getID());</span>
<span class="nc" id="L501">		}</span>
		
<span class="nc" id="L503">		deleteTimeOffIntervalPaidSegmentCalendarEventsID(ids);</span>
		
<span class="nc" id="L505">	}</span>
	
	public void deleteTimeOffIntervalPaidSegmentCalendarEventsID(Collection&lt;ID&gt; calendarEventAssignmentIDs) throws BbmRemoveException {
<span class="nc bnc" id="L508" title="All 4 branches missed.">		if (calendarEventAssignmentIDs == null || calendarEventAssignmentIDs.isEmpty()) {</span>
<span class="nc" id="L509">			return;</span>
		}
<span class="nc" id="L511">		String methodName = &quot;deleteTimeOffIntervalPaidSegmentCalendarEventsID&quot;;</span>
<span class="nc" id="L512">		enterMethod(methodName);</span>

		@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L515">		TimeOffIntervalPaidSegmentCalendarEventDAO dao = null;</span>

		try {
<span class="nc" id="L518">			dao = new TimeOffIntervalPaidSegmentCalendarEventDAO();</span>
<span class="nc" id="L519">			dao.deleteTimeOffIntervalsForCalendarEventAssignment(calendarEventAssignmentIDs);</span>
<span class="nc" id="L520">		} catch (Exception e) {</span>
<span class="nc" id="L521">			throw new BbmRemoveException(e);</span>
		} finally {
<span class="nc" id="L523">			cleanUp(dao);</span>
<span class="nc" id="L524">		}</span>

<span class="nc" id="L526">		exitMethod(methodName);</span>
<span class="nc" id="L527">	}</span>
	
	



	private void enterMethod(String method){
<span class="nc" id="L534">		LOG.debug(RmUtil</span>
<span class="nc" id="L535">				.dumpEnterMethod(method));</span>

<span class="nc" id="L537">	}</span>
	private void exitMethod(String method){
<span class="nc" id="L539">		LOG.debug(RmUtil</span>
<span class="nc" id="L540">				.dumpExitMethod(method));</span>

<span class="nc" id="L542">	}</span>
	
	private static void cleanUp(TimeoffIntervalAllocationUtilDAO dao) {
<span class="nc bnc" id="L545" title="All 2 branches missed.">		if (dao != null) {</span>
<span class="nc" id="L546">			dao.cleanUp();</span>
		}
<span class="nc" id="L548">	}</span>
	
	private static void cleanUp(DAOBase dao) {//NOSONAR
<span class="nc bnc" id="L551" title="All 2 branches missed.">		if (dao != null) {</span>
<span class="nc" id="L552">			dao.cleanUp();</span>
		}
		
<span class="nc" id="L555">	}</span>
	
	private static void cleanUp(PublishingPeriodStatusDAO dao) {
<span class="nc bnc" id="L558" title="All 2 branches missed.">		if (dao != null) {</span>
<span class="nc" id="L559">			dao.cleanUp();</span>
		}
<span class="nc" id="L561">	}</span>
	
	private static void cleanUp(ReferenceScheduleAssignmentsDAO dao) {
<span class="nc bnc" id="L564" title="All 2 branches missed.">		if (dao != null) {</span>
<span class="nc" id="L565">			dao.cleanUp();</span>
		}
<span class="nc" id="L567">	}</span>
	
	
	private static void cleanUp(TOChoiceDAO toChoiceDAO) {
<span class="nc bnc" id="L571" title="All 2 branches missed.">		if (toChoiceDAO != null) {</span>
<span class="nc" id="L572">			toChoiceDAO.cleanUp();</span>
		}
<span class="nc" id="L574">	}</span>

	public Map&lt;Integer, Pair&lt;Integer, Integer&gt;&gt; getRefrenceSchedulesByDayOfWeek(TOChoice choice) throws BbmFinderException {
<span class="nc" id="L577">		return ReferenceScheduleLoader.getRefrenceSchedulesByDayOfWeek(choice);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>