<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ShiftSwapValidationCache.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.swap.request.validation</a> &gt; <span class="el_source">ShiftSwapValidationCache.java</span></div><h1>ShiftSwapValidationCache.java</h1><pre class="source lang-java linenums">/*
 * ValIDationCache.java
 * Copyright (c) 2002, Blue Pumpkin Software, Inc
 * All rights reserved.
 */
package com.bluepumpkin.ejb.rm.requests.swap.request.validation;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.campaign.model.CampaignWorkResource;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.timeoffcalculator.TOCalcUtil;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.model.RequestAggregate;
import com.bluepumpkin.ejb.rm.requests.common.validation.FilingRuleChecker;
import com.bluepumpkin.ejb.rm.requests.common.validation.FilingRuleCheckerHelper;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationCache;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.swap.shiftitem.model.ShiftSwapItem;
import com.bluepumpkin.ejb.rm.requests.swap.withdraw.validation.FilingRuleComplianceValidationRule;
import com.bluepumpkin.ejb.rm.util.RmUtil;
import com.bluepumpkin.ejb.rm.util.ShiftSwapRequestUtil;
import com.verint.ejb.wfm.WfmManagerFactory;

public class ShiftSwapValidationCache extends ValidationCache
{
    private static final String EMP_TO_SKILLS = &quot;EMP2SKILLS:&quot;;
    /**
     * Map of request's Employee ID to their organization ID during the request's time range.
     */
    private static final String EMPID_TO_ORGID_MAP_FOR_PERIOD = &quot;EMPID_TO_ORGID_MAP_FOR_PERIOD&quot;;
    private static final String EMPIDS = &quot;EMPIDS:&quot;;
    private static final String FILING_RULE_CHECKER = &quot;FILING_RULE_CHECKER&quot;;
    private static final String CALEVENT_ASSIGNS_FOR_SSITEM = &quot;CALEVENT_ASSIGNS_FOR_SSITEM&quot;;
    private static final String SWAPPED_SHIFTS_FORSSREQ = &quot;SWAPPED_SHIFTS_FORSSREQ&quot;;
    private static final String SWAPPED_SHIFTS_FORSSREQ_SAMEORGDAY = &quot;SWAPPED_SHIFTS_FORSSREQ_SAMEORGDAY&quot;;
    private static final String SHIFTS_ON_SAME_ORGDAY_SSREQ = &quot; SHIFTS_ON_SAME_ORGDAY_SSREQ&quot;;
	private static final String SHIFTS_ALIGNED_FOR_SSREQ = &quot;SHIFTS_ALIGNED_FOR_SSREQ&quot;;
    private static final String SHIFT_FOR_SSITEM_ALIGNED = &quot;SHIFT_FOR_SSITEM_ALIGNED&quot;;
    private static final String SHIFT_FOR_SSITEM = &quot;SHIFT_FOR_SSITEM&quot;;
    private static final String SHIFT_FOR_SSITEM_SHIFT_TIMEOFF = &quot;SHIFT_FOR_SSITEM_SHIFT_TIMEOFF&quot;;
    private static final String CAMPAIGNS_FOR_SSITEM = &quot;CAMPAIGNS_FOR_SSITEM&quot;;
    private static final String SWAPPED_SHIFTS_FORSSREQ_STARTINGON_SAMEORGDAY = &quot;SWAPPED_SHIFTS_FORSSREQ_STARTINGON_SAMEORGDAY&quot;;

<span class="nc" id="L62">    private static final Category m_cat = Log.initCategory(ShiftSwapValidationCache.class.getName());</span>
    private static final int ITEM_SIZE = 2;
    
    ShiftSwapRequest shiftSwapRequest;

    /**
     * Create a new validation cache for a shift swap request.
     */
    public ShiftSwapValidationCache(ShiftSwapRequest ssr) {
<span class="nc" id="L71">        super(ssr);</span>
<span class="nc" id="L72">        shiftSwapRequest = ssr;</span>
<span class="nc" id="L73">        m_cat.debug(&quot;Created ShiftSwapValidationCache: &quot; + ssr);</span>
<span class="nc" id="L74">    }</span>

	/**
	 * return a collection of orgIDs for agents associated with this request.
	 *
	 * @throws Exception
	 */
	@Override
	public Map&lt;ID, ID&gt; getEmpIDToOrgIDMap() throws Exception {
<span class="nc" id="L83">		Map&lt;ID, ID&gt; empIDToOrgIDMap = (Map&lt;ID, ID&gt;) get(EMPID_TO_ORGID_MAP_FOR_PERIOD);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">		if (empIDToOrgIDMap != null) {</span>
<span class="nc" id="L85">			return empIDToOrgIDMap;</span>
		}

<span class="nc" id="L88">		List&lt;ShiftSwapItem&gt; items = shiftSwapRequest.getShiftSwapItems();</span>

<span class="nc" id="L90">		empIDToOrgIDMap = new HashMap&lt;&gt;(2);</span>

<span class="nc bnc" id="L92" title="All 2 branches missed.">		for (ShiftSwapItem item : items) {</span>
<span class="nc" id="L93">			ID empID = item.getEmployeeID();</span>
<span class="nc" id="L94">			ID orgID = ValidationUtil.getOrgIDForEmployeeDuringPeriod(empID,</span>
<span class="nc" id="L95">					item.getStartDate(), item.getEndDate());</span>

<span class="nc bnc" id="L97" title="All 2 branches missed.">			if (!empIDToOrgIDMap.containsKey(empID)) {</span>
<span class="nc" id="L98">				empIDToOrgIDMap.put(empID, orgID);</span>
			}
<span class="nc" id="L100">		}</span>

<span class="nc" id="L102">		put(EMPID_TO_ORGID_MAP_FOR_PERIOD, empIDToOrgIDMap);</span>

<span class="nc bnc" id="L104" title="All 2 branches missed.">		if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L105">			m_cat.debug(&quot;getEmpIDToOrgIDMap: &quot; + RmUtil.dumpMap(empIDToOrgIDMap));</span>
		}
<span class="nc" id="L107">		return empIDToOrgIDMap;</span>
	}

    /**
     * Get the skills for an employee during a period.
     * @param empID - an Employee ID
     * @param start - the starting time for the period
     * @param end - the ending time for the period
     * @return the Collection of skills
     * @throws Exception
     */
    public Collection getSkillsForEmployeeDuringPeriod(ID empID, Date start, Date end)
        throws Exception {
<span class="nc" id="L120">        String key = RequestUtil.makeCacheKey(EMP_TO_SKILLS, empID, start, end);</span>

<span class="nc" id="L122">        Collection cSkills = (Collection) get(key);</span>

<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (cSkills == null) {</span>
<span class="nc" id="L125">            cSkills = ValidationUtil.getSkillsForEmployeeDuringPeriod(empID, start, end);</span>
<span class="nc" id="L126">            put(key, cSkills);</span>
        }

<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L130">			m_cat.debug(&quot;getSkillsForEmployeeDuringPeriod(&quot; + empID + ',' + start + ',' + end + &quot;): &quot; + RmUtil.dumpCollection(cSkills));</span>
		}
<span class="nc" id="L132">        return cSkills;</span>
    }

    public Collection&lt;ID&gt; getRelevantSkillsForSchedulingPeriod(Collection&lt;ShiftSwapItem&gt; items) throws Exception {
<span class="nc" id="L136">		Collection&lt;ID&gt; spIDs = new ArrayList&lt;ID&gt;();</span>
<span class="nc" id="L137">		ScheduleAccessManager sam = WfmManagerFactory.getScheduleAccessManager();</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">		for (ShiftSwapItem item: items) {</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">			ShiftAssignment sa = getShiftAssignForSSItem(item, true, !item.getIsPartial(), sam);</span>
<span class="nc bnc" id="L140" title="All 4 branches missed.">			if (sa!= null &amp;&amp; sa.getCampaignID() != null){</span>
<span class="nc" id="L141">				spIDs.add(sa.getCampaignID());</span>
			}else{
<span class="nc" id="L143">				Collection&lt;CampaignWorkResource&gt; cwColl = getCampWorkResAssnsForSSItem(item);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">				if(cwColl != null ){</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">					for(CampaignWorkResource cw : cwColl){</span>
<span class="nc" id="L146">						spIDs.add(cw.getCampaignID());</span>
<span class="nc" id="L147">					}</span>
				}
			}

<span class="nc" id="L151">		}</span>
<span class="nc" id="L152">		return ValidationUtil.getSkillsForSchedulingPeriod(spIDs);</span>
	}

    /**
     * Retrieve the IDs of Employees who have items in this Request
     */
    public List&lt;ID&gt; getEmployeeIDsForRequest() {
<span class="nc" id="L159">        String key = EMPIDS;</span>

<span class="nc" id="L161">        List&lt;ID&gt; empIDs = (List&lt;ID&gt;) get(key);</span>

<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (empIDs == null) {</span>
<span class="nc" id="L164">            List items = shiftSwapRequest.getShiftSwapItems();</span>

<span class="nc" id="L166">            empIDs = new ArrayList&lt;ID&gt;(items.size());</span>

<span class="nc bnc" id="L168" title="All 2 branches missed.">            for (Iterator itr = items.iterator(); itr.hasNext();) {</span>
<span class="nc" id="L169">                ShiftSwapItem item = (ShiftSwapItem) itr.next();</span>
<span class="nc" id="L170">                empIDs.add(item.getEmployeeID());</span>
<span class="nc" id="L171">            }</span>

<span class="nc" id="L173">            put(key, empIDs);</span>
        }

<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L177">			m_cat.debug(&quot;getSSEmployeeIDs: &quot; + RmUtil.dumpCollection(empIDs));</span>
		}
<span class="nc" id="L179">        return empIDs;</span>
    }

    /* Get the collection of soft validations for this request
    */
    @Override
	public Collection&lt;String&gt; getValidators() throws Exception {
        // get the organization ids for this request
<span class="nc" id="L187">		Collection&lt;ID&gt; orgIDs = getOrgIDs();</span>

        // because there may be more than one organization, we don't want duplicates
<span class="nc" id="L190">        Set&lt;String&gt; uniqueValidators = new HashSet&lt;String&gt;(11);</span>

<span class="nc bnc" id="L192" title="All 2 branches missed.">		for (Iterator&lt;ID&gt; itr = orgIDs.iterator(); itr.hasNext();) {</span>
<span class="nc" id="L193">            ID orgID = itr.next();</span>

<span class="nc" id="L195">            Collection&lt;String&gt; orgValidators = getValidators(orgID, getRequestType(shiftSwapRequest), null);</span>

            // add all new validators for this organization to the Set
<span class="nc" id="L198">            uniqueValidators.addAll(orgValidators);</span>
<span class="nc" id="L199">        }</span>

<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (m_cat.isDebugEnabled()) {</span>
<span class="nc" id="L202">			m_cat.debug(&quot;getValidators: &quot; + RmUtil.dumpCollection(uniqueValidators));</span>
		}
<span class="nc" id="L204">        return uniqueValidators;</span>
    }

	/**
	 * Determine if a request is a shift swap withdrawl request.
	 */
	public String getRequestType(RequestAggregate reqAgg) {
<span class="nc" id="L211">		ShiftSwapRequest ssr = (ShiftSwapRequest) reqAgg;</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">		if (ssr.isApprovedWithdrawStatusInProgress()) {</span>
<span class="nc" id="L213">			return Request.REQUESTTYPE_SHIFTSWAP_WITHDRAW;</span>
		}
<span class="nc" id="L215">		return Request.REQUESTTYPE_SHIFTSWAP;</span>
	}

	@Override
	public Collection&lt;String&gt; getValidators(ID orgID, String reqType, ID activityID) throws Exception {

<span class="nc bnc" id="L221" title="All 2 branches missed.">		if (!reqType.equals(Request.REQUESTTYPE_SHIFTSWAP_WITHDRAW)) {</span>
<span class="nc" id="L222">			return super.getValidators(orgID, reqType, activityID);</span>
		}

<span class="nc" id="L225">		Collection&lt;String&gt; allConfiguredValidators = new ArrayList&lt;String&gt;();</span>

		// Add all enabled and applicable Shift Swap validators
<span class="nc" id="L228">		allConfiguredValidators.addAll(filterUnapplicableShiftSwapWithdrawValidators(super.getValidators(orgID,</span>
				Request.REQUESTTYPE_SHIFTSWAP, null)));

		// Add all enabled Shift Swap Withdraw validators
<span class="nc" id="L232">		allConfiguredValidators.addAll(super.getValidators(orgID, Request.REQUESTTYPE_SHIFTSWAP_WITHDRAW, null));</span>

<span class="nc" id="L234">		return allConfiguredValidators;</span>
	}

	/**
	 * Remove any Shift Swap validator that does not apply to Shift Swap Withdraw requests.
	 */
	protected Collection&lt;String&gt; filterUnapplicableShiftSwapWithdrawValidators(Collection&lt;String&gt; shiftSwapValsEnabled) {

<span class="nc" id="L242">		Collection&lt;String&gt; applicableShiftSwapValidatorsOnWithdrawRequest =	getApplicableShiftSwapValidatorsOnWithdrawRequest();</span>
<span class="nc" id="L243">		Collection&lt;String&gt; filteredValidators = new ArrayList&lt;String&gt;(shiftSwapValsEnabled);</span>
<span class="nc" id="L244">		filteredValidators.retainAll(applicableShiftSwapValidatorsOnWithdrawRequest);</span>
<span class="nc" id="L245">		return filteredValidators;</span>
	}

	protected Collection&lt;String&gt; getApplicableShiftSwapValidatorsOnWithdrawRequest() {
<span class="nc" id="L249">		Collection&lt;String&gt; timeOffValidatorOnFlexRequest =</span>
<span class="nc" id="L250">				Arrays.asList(FilingRuleComplianceValidationRule.class.getName(),</span>
<span class="nc" id="L251">						SameCallCenterValidationRule.class.getName(),</span>
<span class="nc" id="L252">						SameCampaignValidationRule.class.getName(),</span>
<span class="nc" id="L253">						SameSkillsValidationRule.class.getName(),</span>
<span class="nc" id="L254">						AtLeastSameSkillsValidationRule.class.getName(),</span>
<span class="nc" id="L255">						SameProficienciesValidationRule.class.getName(),</span>
<span class="nc" id="L256">						MinMaxHoursValidationRule.class.getName(),</span>
<span class="nc" id="L257">						SameCallCenterPeriodValidationRule.class.getName(),</span>
<span class="nc" id="L258">						SamePaidHoursValidationRule.class.getName(),</span>
<span class="nc" id="L259">						CalendarEventsValidationRule.class.getName(),</span>
<span class="nc" id="L260">						CalendarEventsMustOverlapValidationRule.class.getName(),</span>
<span class="nc" id="L261">						PSSMinShiftSwapDuration.class.getName(),</span>
<span class="nc" id="L262">						PSSMinRemainingShiftDuration.class.getName(),</span>
<span class="nc" id="L263">						PSSMaxSwapDurationPerDay.class.getName(),</span>
<span class="nc" id="L264">						PSSNonSwappableActivites.class.getName(),</span>
<span class="nc" id="L265">						PSSShiftGapConditions.class.getName(),</span>
<span class="nc" id="L266">						PSSMaxAllowableOverlap.class.getName(),</span>
<span class="nc" id="L267">						MaxConsecutiveWorkingDaysRule.class.getName(),</span>
<span class="nc" id="L268">						MinTimeBetweenShiftAssignmentsRule.class.getName(),</span>
<span class="nc" id="L269">						MaxHoursAndMaxAlternateHoursPerDayValidationRule.class.getName());</span>

<span class="nc" id="L271">		return timeOffValidatorOnFlexRequest;</span>
	}

    /**
     * Get a filing rules checker for this request.
     */
    @Override
	public FilingRuleChecker getFilingRuleChecker(Object obj)
        throws Exception
    {
<span class="nc" id="L281">        ShiftSwapItem item = (ShiftSwapItem) obj;</span>

        // use empID for cache key since ShiftSwapItem.ID will be null for SSReqs being created.
<span class="nc" id="L284">        String key = RequestUtil.makeCacheKey(FILING_RULE_CHECKER, item.getEmployeeID());</span>
        // Check to see if the checker is already in the cache
<span class="nc" id="L286">        FilingRuleChecker result = (FilingRuleChecker) get(key);</span>

        // If map was in the cache, use it
<span class="nc bnc" id="L289" title="All 2 branches missed.">        if (result != null) {</span>
<span class="nc" id="L290">            m_cat.debug(&quot;getFilingRuleChecker(&quot; + item + &quot;): &quot; + result);</span>
<span class="nc" id="L291">            return result;</span>
        }

<span class="nc" id="L294">        ID idOrg = getOrgIDForEmployeeDuringPeriod(item.getEmployeeID(), item.getStartDate(),</span>
<span class="nc" id="L295">                item.getEndDate());</span>
<span class="nc" id="L296">        TimeRange itemRange = new TimeRange(item.getStartDate(), item.getEndDate());</span>

//        try {
<span class="nc" id="L299">            result = FilingRuleCheckerHelper.getChecker(idOrg, shiftSwapRequest.getRequestType(), itemRange);</span>
//        } c_atch (ValidationException e) {
//            m_cat.error(e);
//            t_hrow e;
//        }

        // Save in cache
<span class="nc" id="L306">        put(key, result);</span>

<span class="nc" id="L308">        m_cat.debug(&quot;getFilingRuleChecker(&quot; + item + &quot;): &quot; + result);</span>
<span class="nc" id="L309">        return result;</span>
    }

    public Collection getCalEventAssignsForSSItem(ShiftSwapItem ssItem, int eventType, boolean published,
        ScheduleAccessManager sam) throws Exception
    {
        // use empID for cache key since ShiftSwapItem.ID will be null for SSReqs being created.
<span class="nc" id="L316">        String key = RequestUtil.makeCacheKey(CALEVENT_ASSIGNS_FOR_SSITEM,</span>
<span class="nc" id="L317">            ssItem.getEmployeeID(), new Integer(eventType), new Boolean(published));</span>

<span class="nc" id="L319">        Collection events = null;</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">        if (!containsKey(key)) {</span>
<span class="nc" id="L321">            events = RequestUtil.getEventsDuringPeriod(ssItem.getEmployeeID(), eventType, published,</span>
<span class="nc" id="L322">             ssItem.getStartDate(), ssItem.getEndDate(), sam);</span>
<span class="nc" id="L323">            put(key, events);</span>
        } else {
<span class="nc" id="L325">            events = (Collection) get(key);</span>
<span class="nc" id="L326">            RmUtil.dumpExitMethod(&quot;getCalEventAssignsForSSItem&quot;, events);</span>
        }

<span class="nc" id="L329">        return events;</span>
    }

    public ShiftAssignment[] getSwappedShiftAssignsForReqAligned(boolean published, ScheduleAccessManager sam)
        throws Exception
    {
<span class="nc" id="L335">        String key = RequestUtil.makeCacheKey(SWAPPED_SHIFTS_FORSSREQ, new Boolean(published));</span>

<span class="nc" id="L337">        ShiftAssignment[] shifts = null;</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (!containsKey(key)) {</span>
<span class="nc" id="L339">            shifts = ShiftSwapRequestUtil.getSwappedShiftAssignsForReqAligned(shiftSwapRequest, published, sam);</span>
<span class="nc" id="L340">            put(key, shifts);</span>
        } else {
<span class="nc" id="L342">            shifts = (ShiftAssignment[]) get(key);</span>
<span class="nc" id="L343">            RmUtil.dumpExitMethod(&quot;getSwappedShiftAssignsForReqAligned&quot;, shifts);</span>
        }

<span class="nc" id="L346">        return shifts;</span>
    }

    public ShiftAssignment[] getSwappedShiftAssignsForReqSameOrgDay(boolean published, ScheduleAccessManager sam)
        throws Exception
    {
<span class="nc" id="L352">        String key = RequestUtil.makeCacheKey(SWAPPED_SHIFTS_FORSSREQ_SAMEORGDAY, new Boolean(published));</span>

<span class="nc" id="L354">        ShiftAssignment[] shifts = null;</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">        if (!containsKey(key)) {</span>
<span class="nc" id="L356">            shifts = ShiftSwapRequestUtil.getSwappedShiftAssignsForReqSameOrgDay(shiftSwapRequest, published, sam);</span>
<span class="nc" id="L357">            put(key, shifts);</span>
        } else {
<span class="nc" id="L359">            shifts = (ShiftAssignment[]) get(key);</span>
<span class="nc" id="L360">            RmUtil.dumpExitMethod(&quot;getSwappedShiftAssignsForReqSameOrgDay&quot;, shifts);</span>
        }

<span class="nc" id="L363">        return shifts;</span>
    }

    //Silk 80581
    // QA46082 - To consider only the shifts that start on the org day for comparision
    // No change in this method, other than to invoke different Util method
    public ShiftAssignment[] getSwappedSAForReqWithStartDateOnSameOrgDay(boolean published, ScheduleAccessManager sam)
        throws Exception
    {
<span class="nc" id="L372">        String key = RequestUtil.makeCacheKey(SWAPPED_SHIFTS_FORSSREQ_STARTINGON_SAMEORGDAY, new Boolean(published));</span>

<span class="nc" id="L374">        ShiftAssignment[] shifts = null;</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">        if (!containsKey(key)) {</span>
<span class="nc" id="L376">            shifts = ShiftSwapRequestUtil.getSwappedSAForReqWithStartDateOnSameOrgDay(shiftSwapRequest, published, sam);</span>
<span class="nc" id="L377">            put(key, shifts);</span>
        } else {
<span class="nc" id="L379">            shifts = (ShiftAssignment[]) get(key);</span>
<span class="nc" id="L380">            RmUtil.dumpExitMethod(&quot;getSwappedSAForReqWithStartDateOnSameOrgDay&quot;, shifts);</span>
        }

<span class="nc" id="L383">        return shifts;</span>
    }

    public ShiftAssignment[] getShiftAssignsForReqSameOrgDay(boolean published, ScheduleAccessManager sam)
        throws Exception
    {
<span class="nc" id="L389">        String key = RequestUtil.makeCacheKey(SHIFTS_ON_SAME_ORGDAY_SSREQ, new Boolean(published));</span>

<span class="nc" id="L391">        ShiftAssignment[] shifts = null;</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">        if (!containsKey(key)) {</span>
<span class="nc" id="L393">            shifts = ShiftSwapRequestUtil.getShiftAssignsForReqSameOrgDay(shiftSwapRequest, published, sam);</span>
<span class="nc" id="L394">            put(key, shifts);</span>
        } else {
<span class="nc" id="L396">            shifts = (ShiftAssignment[]) get(key);</span>
<span class="nc" id="L397">            RmUtil.dumpExitMethod(&quot;getShiftAssignsForReqSameOrgDay&quot;, shifts);</span>
        }

<span class="nc" id="L400">        return shifts;</span>
    }

	public ShiftAssignment[] getShiftAssignsForReqAligned(boolean published, ScheduleAccessManager sam)
		throws Exception {

<span class="nc" id="L406">		String key = RequestUtil.makeCacheKey(SHIFTS_ALIGNED_FOR_SSREQ, new Boolean(published));</span>

<span class="nc" id="L408">		ShiftAssignment[] shifts = null;</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">		if (!containsKey(key)) {</span>
<span class="nc" id="L410">			shifts = ShiftSwapRequestUtil.getShiftAssignsForReqAligned(shiftSwapRequest, published, sam);</span>
<span class="nc" id="L411">			put(key, shifts);</span>
		} else {
<span class="nc" id="L413">			shifts = (ShiftAssignment[]) get(key);</span>
<span class="nc" id="L414">			RmUtil.dumpExitMethod(&quot;getShiftAssignsForReqAligned&quot;, shifts);</span>
		}

<span class="nc" id="L417">		return shifts;</span>
	}

	/**
	 * @see ShiftSwapRequestUtil#getShiftAssignForSSItem(ShiftSwapItem, boolean, boolean, ScheduleAccessManager, ShiftSwapValidationCache)
	 */
	public ShiftAssignment getShiftAssignForShiftSwapItem(ShiftSwapItem ssItem, boolean published,
		ScheduleAccessManager sam) throws Exception {
<span class="nc" id="L425">			return 	getShiftAssignForSSItem(ssItem, published, false, sam);</span>
    }

	/**
	 * @see ShiftSwapRequestUtil#getShiftAssignForSSItem(ShiftSwapItem, boolean, boolean, ScheduleAccessManager, ShiftSwapValidationCache)
	 */
    public ShiftAssignment getShiftAssignForSSItemAligned(ShiftSwapItem ssItem, boolean published,
        ScheduleAccessManager sam) throws Exception {

        // use empID for cache key since ShiftSwapItem.ID will be null for SSReqs being created.
<span class="nc" id="L435">        String key = RequestUtil.makeCacheKey(SHIFT_FOR_SSITEM_ALIGNED, ssItem.getEmployeeID(),</span>
            new Boolean(published));

<span class="nc" id="L438">        ShiftAssignment shift = null;</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">        if (!containsKey(key)) {</span>
<span class="nc" id="L440">            shift = ShiftSwapRequestUtil.getShiftAssignForSSItemAligned(ssItem, published, sam, shiftSwapRequest.getCache());</span>
<span class="nc" id="L441">            put(key, shift);</span>
        } else {
<span class="nc" id="L443">            shift = (ShiftAssignment) get(key);</span>
<span class="nc" id="L444">            RmUtil.dumpExitMethod(&quot;getShiftAssignForSSItemAligned&quot;, shift);</span>
        }

<span class="nc" id="L447">        return shift;</span>
    }

    /**
	 * @see ShiftSwapRequestUtil#getShiftAssignForSSItem(ShiftSwapItem, boolean, boolean, ScheduleAccessManager, ShiftSwapValidationCache)
	 */
    public ShiftAssignment getShiftAssignForSSItem(ShiftSwapItem ssItem, boolean published, boolean aligned,
        ScheduleAccessManager sam) throws Exception {

        // use empID for cache key since ShiftSwapItem.ID will be null for SSReqs being created.
    	//Fix QC 179526 ( or QC163589-15.1.1)
<span class="nc" id="L458">        String key = RequestUtil.makeCacheKey(SHIFT_FOR_SSITEM, ssItem.getEmployeeID(),</span>
                new Boolean(published), new Boolean(aligned));

<span class="nc" id="L461">        ShiftAssignment shift = null;</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">        if (!containsKey(key)) {</span>
<span class="nc" id="L463">            shift = ShiftSwapRequestUtil.getShiftAssignForSSItem(ssItem, published, aligned, sam, shiftSwapRequest.getCache());</span>
<span class="nc" id="L464">            put(key, shift);</span>
        } else {
<span class="nc" id="L466">            shift = (ShiftAssignment) get(key);</span>
<span class="nc" id="L467">            RmUtil.dumpExitMethod(&quot;getShiftAssignForSSItemAligned&quot;, shift);</span>
        }

<span class="nc" id="L470">        return shift;</span>
    }


    /**
	 * @see ShiftSwapRequestUtil#getShiftAssignForSSItem(ShiftSwapItem, boolean, boolean, ScheduleAccessManager, ShiftSwapValidationCache)
	 */
    public ShiftAssignment getShiftAssignForSSItem(ShiftSwapItem ssItem, ScheduleAccessManager sam, boolean published,
    		                                       boolean aligned) throws Exception {

        // use empID for cache key since ShiftSwapItem.ID will be null for SSReqs being created.
    	//Fix QC 179526 ( or QC163589-15.1.1)
<span class="nc" id="L482">        String key = RequestUtil.makeCacheKey(SHIFT_FOR_SSITEM_SHIFT_TIMEOFF, ssItem.getEmployeeID(),</span>
                new Boolean(published), new Boolean(aligned));

<span class="nc" id="L485">        ShiftAssignment shift = null;</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">        if (!containsKey(key)) {</span>
<span class="nc" id="L487">            shift = ShiftSwapRequestUtil.getShiftAssignForSSItem(ssItem, sam, shiftSwapRequest.getCache(), published, aligned);</span>
<span class="nc" id="L488">            put(key, shift);</span>
        } else {
<span class="nc" id="L490">            shift = (ShiftAssignment) get(key);</span>
<span class="nc" id="L491">            RmUtil.dumpExitMethod(&quot;getShiftAssignForSSItemAligned&quot;, shift);</span>
        }

<span class="nc" id="L494">        return shift;</span>
    }

    public Collection getCampWorkResAssnsForSSItem(ShiftSwapItem ssItem) throws Exception {
        // use empID for cache key since ShiftSwapItem.ID will be null for SSReqs being created.
<span class="nc" id="L499">        String key = RequestUtil.makeCacheKey(CAMPAIGNS_FOR_SSITEM, ssItem.getEmployeeID());</span>

<span class="nc" id="L501">        Collection campaigns = null;</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">        if (!containsKey(key)) {</span>
<span class="nc" id="L503">            campaigns = ShiftSwapRequestUtil.getCampWorkResAssnsForSSItem(ssItem);</span>
<span class="nc" id="L504">            put(key, campaigns);</span>
        } else {
<span class="nc" id="L506">            campaigns = (Collection) get(key);</span>
<span class="nc" id="L507">            RmUtil.dumpExitMethod(&quot;getCampaignsForSSItem&quot;, campaigns);</span>
        }

<span class="nc" id="L510">        return campaigns;</span>
    }
    public boolean containsScheduleReaderCache(String key) {
<span class="nc" id="L513">        return containsKey(&quot;ScheduleReaderCache_&quot; + key);</span>
    }
    public ShiftAssignment getScheduleReaderCache(String key) {
<span class="nc" id="L516">        return (ShiftAssignment) get(&quot;ScheduleReaderCache_&quot; + key);</span>
    }
    public void setScheduleReaderCache(String key, ShiftAssignment shift) {
<span class="nc" id="L519">    	put(&quot;ScheduleReaderCache_&quot; + key, shift);</span>
<span class="nc" id="L520">    }</span>

    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.rm.requests.common.validation.ValidationCache#getEmployeeID()
     */
    //TODO: validationCache must declare abstract method getEmployeeIDs() instead of getEmployeeID().
    @Override
	public ID getEmployeeID() {
<span class="nc" id="L528">        throw new UnsupportedOperationException(&quot;method not implemented&quot;);</span>
    }

    /* (non-Javadoc)
     * @see com.bluepumpkin.ejb.rm.requests.common.validation.ValidationCache#getDateRange()
     */
    //  TODO: validationCache must declare abstract method getDateRanges() instead of getDateRange().
    @Override
	public TimeRange getDateRange() {
<span class="nc" id="L537">        throw new UnsupportedOperationException(&quot;method not implemented&quot;);</span>
    }
    /*Note: This is working wrong with swaping 2 employess from orgs having different timezones.(QC 199897)
     *  And swap shift over crossnight.
     *  and  Why getting startdate of the employee's organization to compare the different day 
     *  */
	public boolean isFullSwapOnDifferentDay() throws Exception {

<span class="nc" id="L545">		List&lt;ShiftSwapItem&gt; items = shiftSwapRequest.getShiftSwapItems();</span>

<span class="nc bnc" id="L547" title="All 6 branches missed.">		if (!shiftSwapRequest.isOneWay() &amp;&amp; items != null &amp;&amp; items.size() == ITEM_SIZE) {</span>
<span class="nc" id="L548">			ShiftSwapItem ssItem1 = items.get(0);</span>
<span class="nc" id="L549">			ShiftSwapItem ssItem2 = items.get(1);</span>

<span class="nc" id="L551">			Organization orgEmp1 = getOrganizationForEmployeeDuringPeriod(</span>
<span class="nc" id="L552">					ssItem1.getEmployeeID(), ssItem1.getStartDate(),</span>
<span class="nc" id="L553">					ssItem1.getEndDate());</span>

<span class="nc" id="L555">			Organization orgEmp2 = getOrganizationForEmployeeDuringPeriod(</span>
<span class="nc" id="L556">					ssItem2.getEmployeeID(), ssItem2.getStartDate(),</span>
<span class="nc" id="L557">					ssItem2.getEndDate());</span>

			// Original shifts
<span class="nc" id="L560">			Date emp1OrgEmp1Shift = TOCalcUtil.getDateForOrgDayStart(orgEmp1,</span>
<span class="nc" id="L561">					ssItem1.getStartDate());</span>
<span class="nc" id="L562">			Date emp2OrgEmp2Shift = TOCalcUtil.getDateForOrgDayStart(orgEmp2,</span>
<span class="nc" id="L563">					ssItem2.getStartDate());</span>

			// Swapped shifts (originals swapped into receiver's org timezone)
<span class="nc" id="L566">			Date emp1OrgEmp2Shift = TOCalcUtil.getDateForOrgDayStart(orgEmp1,</span>
<span class="nc" id="L567">					ssItem2.getStartDate());</span>
<span class="nc" id="L568">			Date emp2OrgEmp1Shift = TOCalcUtil.getDateForOrgDayStart(orgEmp2,</span>
<span class="nc" id="L569">					ssItem1.getStartDate());</span>

<span class="nc bnc" id="L571" title="All 2 branches missed.">			boolean different = !emp2OrgEmp2Shift.equals(emp2OrgEmp1Shift);</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">			if (!different) {</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">				different = !emp1OrgEmp1Shift.equals(emp1OrgEmp2Shift);</span>
			}

<span class="nc" id="L576">			return different;</span>
		}

<span class="nc" id="L579">		return false;</span>

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>