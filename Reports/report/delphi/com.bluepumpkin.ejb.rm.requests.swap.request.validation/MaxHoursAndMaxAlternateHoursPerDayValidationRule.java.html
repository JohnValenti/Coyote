<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MaxHoursAndMaxAlternateHoursPerDayValidationRule.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">QA Code Coverage</a> &gt; <a href="index.source.html" class="el_package">com.bluepumpkin.ejb.rm.requests.swap.request.validation</a> &gt; <span class="el_source">MaxHoursAndMaxAlternateHoursPerDayValidationRule.java</span></div><h1>MaxHoursAndMaxAlternateHoursPerDayValidationRule.java</h1><pre class="source lang-java linenums">package com.bluepumpkin.ejb.rm.requests.swap.request.validation;

import java.rmi.RemoteException;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.Iterator;
import java.util.Map;

import com.bluepumpkin.common.datatypes.ID;
import com.bluepumpkin.common.datatypes.Pair;
import com.bluepumpkin.common.datatypes.TimeRange;
import com.bluepumpkin.common.logging.Category;
import com.bluepumpkin.ejb.bbm.activity.model.Event;
import com.bluepumpkin.ejb.bbm.base.BbmCreateException;
import com.bluepumpkin.ejb.bbm.base.BbmFinderException;
import com.bluepumpkin.ejb.bbm.schedule.ejb.ScheduleAccessManager;
import com.bluepumpkin.ejb.bbm.schedule.model.ShiftAssignment;
import com.bluepumpkin.ejb.bbm.workresource.model.Organization;
import com.bluepumpkin.ejb.rm.Log;
import com.bluepumpkin.ejb.rm.RmManagerFactory;
import com.bluepumpkin.ejb.rm.l10n.RmEjbBundleKey;
import com.bluepumpkin.ejb.rm.requests.common.ejb.RequestUtil;
import com.bluepumpkin.ejb.rm.requests.common.model.Request;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validatable;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationResult;
import com.bluepumpkin.ejb.rm.requests.common.validation.ValidationUtil;
import com.bluepumpkin.ejb.rm.requests.common.validation.Validator;
import com.bluepumpkin.ejb.rm.requests.swap.request.model.ShiftSwapRequest;
import com.bluepumpkin.ejb.rm.requests.swap.shiftitem.model.ShiftSwapItem;
import com.bluepumpkin.ejb.rm.setup.validation.ejb.ValidationRuleManager;
import com.bluepumpkin.ejb.rm.util.LicenseUtil;
import com.bluepumpkin.ejb.rm.util.RmUtil;
import com.bluepumpkin.ejb.rm.util.ShiftSwapRequestUtil;

/**
 *
 * &lt;b&gt;Soft Validation: A maximum number of hours per day for an employee upon approval of a swap.
 *  A different maximum number of hours per day for an employee in instances where the previous day also included an approved swap&lt;/b&gt;
 *  Checks for both the shifts for a one-way or two way swap
 */
<span class="nc" id="L42">public class MaxHoursAndMaxAlternateHoursPerDayValidationRule implements Validator {</span>
<span class="nc" id="L43">	private static final String CLASS_NAME = MaxHoursAndMaxAlternateHoursPerDayValidationRule.class.getName();</span>
<span class="nc" id="L44">	private static final Category LOGGER = Log.initCategory(CLASS_NAME);</span>

	public static final String MAX_HOURS_PER_DAY = &quot;MAX_HOURS_PER_DAY&quot;;
	public static final String MAX_ALTERNATIVE_HOURS_PER_DAY = &quot;MAX_ALTERNATIVE_HOURS_PER_DAY&quot;;
<span class="nc" id="L48">	public static final ID RULE_ID = new ID(-194073);</span>
	private static final long MINUTE_IN_MILISECONDS = 60 * 60 * 1000;


	/* (non-Javadoc)
	 * @see com.bluepumpkin.ejb.rm.requests.common.validation.Validator#validate(com.bluepumpkin.ejb.rm.requests.common.validation.Validatable)
	 */
	@Override
	public ValidationResult validate(Validatable validatable) throws Exception {
<span class="nc" id="L57">		String methodName = &quot;validate&quot;;</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">		if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L59">			LOGGER.debug(RmUtil.dumpEnterMethod(methodName, validatable));</span>
		}
<span class="nc" id="L61">		boolean isAdvancedRMLicense = isAdvancedRMLicense();</span>
<span class="nc" id="L62">		ValidationResult result = null;</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">		if (!isAdvancedRMLicense) {</span>
<span class="nc" id="L64">			return result;</span>
		}
<span class="nc" id="L66">		ShiftSwapRequest ssr = (ShiftSwapRequest) validatable;</span>
<span class="nc" id="L67">		ShiftSwapItem ssItem1 = (ShiftSwapItem) ssr.getShiftSwapItems().get(0);</span>
<span class="nc" id="L68">		ShiftSwapItem ssItem2 = (ShiftSwapItem) ssr.getShiftSwapItems().get(1);</span>
<span class="nc" id="L69">		LOGGER.debug(&quot;===ssItem1+&quot; + ssItem1);</span>
<span class="nc" id="L70">		LOGGER.debug(&quot;===ssItem2+&quot; + ssItem2);</span>
		//get the resulting shifts from the swap
<span class="nc" id="L72">		ShiftAssignment[] saArray = getShiftAfterSwap(ssr);</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">		ShiftAssignment sa1 = !saArray[0].getWorkResourceIDs().iterator().next().equals(ssItem2.getEmployeeID()) ? saArray[1] : saArray[0];</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">		ShiftAssignment sa2 = !saArray[1].getWorkResourceIDs().iterator().next().equals(ssItem1.getEmployeeID()) ? saArray[0] : saArray[1];</span>

<span class="nc bnc" id="L76" title="All 2 branches missed.">		if (!ssItem1.getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF)) {</span>
<span class="nc" id="L77">			LOGGER.debug(&quot;===================================&quot;);</span>
<span class="nc" id="L78">			LOGGER.debug(&quot;===Run validator for workresourceID = &quot; + sa1.getWorkResourceID());</span>
<span class="nc" id="L79">			LOGGER.debug(&quot;===Shift assignment will be sa1= &quot; + sa1);</span>

<span class="nc" id="L81">			long shiftduration = ShiftSwapRequestUtil.getPaidTimeInShiftAssignment(sa1);</span>
			//Convert to hour
<span class="nc" id="L83">			float durationInHour = (float) shiftduration / MINUTE_IN_MILISECONDS;</span>
<span class="nc" id="L84">			ShiftSwapItem ssItemIn = ssItem1;</span>
<span class="nc" id="L85">			ShiftSwapItem ssItemOut = ssItem2;</span>
<span class="nc" id="L86">			result = verifyOrgDayShiftDurationForItem(durationInHour, ssItemIn, ssItemOut, ssr);</span>
		}
<span class="nc bnc" id="L88" title="All 2 branches missed.">		if (!ssItem2.getShiftType().equals(ShiftSwapItem.SWAPITEMTYPE_TIMEOFF)) {</span>
<span class="nc" id="L89">			LOGGER.debug(&quot;===================================&quot;);</span>
<span class="nc" id="L90">			LOGGER.debug(&quot;===Run validator for workresourceID = &quot; + sa2.getWorkResourceID());</span>
<span class="nc" id="L91">			LOGGER.debug(&quot;===Shift assignment will be sa2= &quot; + sa2);</span>
			//Part1: Get duration of item after the swap
<span class="nc" id="L93">			long shiftduration = ShiftSwapRequestUtil.getPaidTimeInShiftAssignment(sa2);</span>
			//Convert to hour
<span class="nc" id="L95">			float durationInHour = shiftduration / MINUTE_IN_MILISECONDS;</span>
<span class="nc" id="L96">			ShiftSwapItem ssItemIn = ssItem2;</span>
<span class="nc" id="L97">			ShiftSwapItem ssItemOut = ssItem1;</span>
<span class="nc" id="L98">			result = verifyOrgDayShiftDurationForItem(durationInHour, ssItemIn, ssItemOut, ssr);</span>
		}

<span class="nc bnc" id="L101" title="All 2 branches missed.">		if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L102">			LOGGER.debug(RmUtil.dumpExitMethod(methodName));</span>
		}
<span class="nc" id="L104">		return result;</span>
	}

	/*
	 * Find the swap item of shift swap approved for this employee on previous day.
	    /*1)If yes,
	    get all shift events in working shift of the agent on the previous day
	    then get paid duration of the shift on previous day: previousPaidDurationInHour
	   		(it includes the original shift and approved swapped shift)
	    if durationInHourIfSwap does not meet maxHour=&gt; show Flags
	    else
	     Compare previousPaidDurationInHour to the first Parameter: maxHour,
	    	if it reaches the maxHour then compare durationInHourIfSwap to the second parameter: maxAlternateHour
	    2) if no, compare durationInHourIfSwap to the first maxHour.
	 */

	protected ValidationResult verifyOrgDayShiftDurationForItem(float durationInHourIfSwap, ShiftSwapItem ssItemIn,
			ShiftSwapItem ssItemOut, ShiftSwapRequest ssr) throws Exception {
<span class="nc" id="L122">		ValidationResult result = null;</span>
<span class="nc" id="L123">		ID employeeID = ssItemOut.getEmployeeID();</span>
		//Find the organization for the receiver during the time he receive the swap
<span class="nc" id="L125">		Organization org = getOrganizationForEmployeeReceiveSwap(ssr, employeeID, ssItemIn.getStartDate(), ssItemIn.getEndDate());</span>
<span class="nc" id="L126">		boolean isValidationRequiredForOrg = isValidationRequiredForOrg(org.getID(), ssr);</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">		if (!isValidationRequiredForOrg) {</span>
<span class="nc" id="L128">			return result;</span>
		}
<span class="nc" id="L130">		LOGGER.debug(&quot;= isValidationRequiredForOrg of org.getID &quot;+ org.getID() + &quot; is =&quot; +isValidationRequiredForOrg);</span>
			//Get value setting of the organization of receiver.
<span class="nc" id="L132">			Pair&lt;Float, Float&gt; paramValues = getMaxHourAndAlternateHourInOrg(org.getID());</span>
<span class="nc" id="L133">			float maxHour =paramValues.getFirst().floatValue();</span>
<span class="nc" id="L134">			float maxAlternateHour = paramValues.getSecond().floatValue();</span>
<span class="nc" id="L135">			LOGGER.debug(&quot;===maxHour=&quot; + maxHour);</span>
<span class="nc" id="L136">			LOGGER.debug(&quot;====durationInHour=&quot; + durationInHourIfSwap);</span>
<span class="nc" id="L137">			LOGGER.debug(&quot;==== maxAlternateHour =&quot; + maxAlternateHour);</span>
<span class="nc bnc" id="L138" title="All 4 branches missed.">			if(maxHour==-1||maxAlternateHour==-1) {</span>
<span class="nc" id="L139">				return result;</span>
			}
			//Get the date before and check if this employee receive any shift swap on the date before
<span class="nc" id="L142">			TimeRange previousRange = getPreviousStartEndDate(org, ssItemIn.getStartDate());</span>
<span class="nc" id="L143">			boolean hasSwapShiftOnPreviousDay = employeeReceivedShiftSwapApproved(employeeID,</span>
<span class="nc" id="L144">														previousRange.getStartDate(), previousRange.getEndDate());</span>
<span class="nc" id="L145">			LOGGER.debug(&quot;hasSwapShiftOnPreviousDay=&quot; + hasSwapShiftOnPreviousDay);</span>
<span class="nc" id="L146">			long previousPaidDuration = 0;</span>
<span class="nc" id="L147">			float previousPaidDurationInHour = 0;</span>
			//If he had ShiftSwap on the date before, then validate with both parameters.
<span class="nc bnc" id="L149" title="All 2 branches missed.">			if (hasSwapShiftOnPreviousDay) {</span>
<span class="nc" id="L150">				LOGGER.debug(&quot;getPublishedEventsForWorkResourceByType of employee ID= &quot; + employeeID +</span>
<span class="nc" id="L151">						&quot; at range=&quot; + previousRange.getStartDate()+ &quot;-&quot; + previousRange.getEndDate());</span>
<span class="nc" id="L152">				Collection&lt;ShiftAssignment&gt; previousShiftAssigns = getPublishedEventsForWorkResourceByType(employeeID,</span>
<span class="nc" id="L153">						previousRange.getStartDate(), previousRange.getEndDate());</span>
<span class="nc" id="L154">				LOGGER.debug(&quot;previousShiftAssigns=&quot; + previousShiftAssigns);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">				for (Iterator&lt;ShiftAssignment&gt; it = previousShiftAssigns.iterator(); it.hasNext();) {</span>
<span class="nc" id="L156">					ShiftAssignment sAssgn = it.next();</span>
<span class="nc" id="L157">					previousPaidDuration += ShiftSwapRequestUtil.getPaidTimeInShiftAssignment(sAssgn);</span>
<span class="nc" id="L158">				}</span>
<span class="nc" id="L159">				previousPaidDurationInHour = (float)previousPaidDuration / MINUTE_IN_MILISECONDS;</span>
<span class="nc" id="L160">				LOGGER.debug(&quot;===previousPaidDurationInHours=&quot; + previousPaidDurationInHour);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">				if (durationInHourIfSwap &gt; maxHour) {</span>
<span class="nc" id="L162">					result = ValidationUtil.setSoftValidationResult(ssr, RmEjbBundleKey.VALIDATION_SS_MAX_HOURS_AFTER_SWAP_PER_DAY,</span>
<span class="nc" id="L163">							getEmployeeName(ssr, employeeID), String.valueOf(durationInHourIfSwap), String.valueOf(maxHour), CLASS_NAME);</span>
<span class="nc bnc" id="L164" title="All 4 branches missed.">				} else if (previousPaidDurationInHour == maxHour &amp;&amp; durationInHourIfSwap &gt; maxAlternateHour) {</span>
<span class="nc" id="L165">					result = ValidationUtil.setSoftValidationResult(ssr, RmEjbBundleKey.VALIDATION_SS_ALTERNATE_MAX_HOURS_AFTER_SWAP_PER_DAY,</span>
<span class="nc" id="L166">							getEmployeeName(ssr, employeeID), String.valueOf(durationInHourIfSwap),</span>
<span class="nc" id="L167">							String.valueOf(maxAlternateHour), String.valueOf(maxHour), CLASS_NAME);</span>
				}
<span class="nc" id="L169">			} else {</span>
				//If he did not have any shift swap, just validate with max Hours per day
<span class="nc bnc" id="L171" title="All 2 branches missed.">				if (durationInHourIfSwap &gt; maxHour) {</span>
<span class="nc" id="L172">					result = ValidationUtil.setSoftValidationResult(ssr, RmEjbBundleKey.VALIDATION_SS_MAX_HOURS_AFTER_SWAP_PER_DAY,</span>
<span class="nc" id="L173">							getEmployeeName(ssr, employeeID), String.valueOf(durationInHourIfSwap), String.valueOf(maxHour), CLASS_NAME);</span>
				}
			}

<span class="nc" id="L177">		return result;</span>
	}

	protected boolean isAdvancedRMLicense() {
<span class="nc" id="L181">		return LicenseUtil.isAdvancedRMLicense();</span>
	}

	protected ShiftAssignment[] getShiftAfterSwap(ShiftSwapRequest ssr) throws Exception {
<span class="nc" id="L185">		return ShiftSwapRequestUtil.getShiftsAfterSwap(ssr, ssr.isTentative());</span>
	}

	protected Organization getOrganizationForEmployeeReceiveSwap(ShiftSwapRequest ssr, ID employeeID, Date startTime, Date endTime) throws Exception {
<span class="nc" id="L189">		ShiftSwapValidationCache cache = (ShiftSwapValidationCache) ssr.getValidationCache();</span>
<span class="nc" id="L190">		return cache.getOrganizationForEmployeeDuringPeriod(employeeID, startTime, endTime);</span>
	}

	protected String getEmployeeName(ShiftSwapRequest ssr, ID employeeID) throws Exception {
<span class="nc" id="L194">		ShiftSwapValidationCache cache = (ShiftSwapValidationCache) ssr.getValidationCache();</span>
<span class="nc" id="L195">		return cache.getEmployeeNameByID(employeeID);</span>
	}
	protected boolean isValidationRequiredForOrg(ID orgID,ShiftSwapRequest ssr) throws Exception {
<span class="nc" id="L198">		ShiftSwapValidationCache cache = (ShiftSwapValidationCache) ssr.getValidationCache();</span>
<span class="nc" id="L199">		return cache.isValidationRequiredForOrg(orgID, Request.REQUESTTYPE_SHIFTSWAP, CLASS_NAME);</span>
	}

	protected Pair&lt;Float, Float&gt; getMaxHourAndAlternateHourInOrg(ID orgID) throws BbmCreateException, BbmFinderException, RemoteException {
<span class="nc" id="L203">		Pair&lt;Float, Float&gt; result = new Pair&lt;Float, Float&gt;(new Float(-1), new Float(-1));</span>
<span class="nc" id="L204">		ValidationRuleManager valMan = RmManagerFactory.getInstance().getValidationRuleManager();</span>
<span class="nc" id="L205">		Map&lt;String, Integer&gt; ruleParams = valMan.getValidationRuleParams(orgID, RULE_ID);</span>
<span class="nc" id="L206">		LOGGER.debug(&quot;orgID =&quot; + orgID + &quot;have ruleParams=&quot;+ ruleParams);</span>
<span class="nc bnc" id="L207" title="All 4 branches missed.">		if(ruleParams!=null&amp;&amp; !ruleParams.isEmpty()) {</span>
<span class="nc" id="L208">			float maxHour = ruleParams.get(MAX_HOURS_PER_DAY);</span>
<span class="nc" id="L209">			float maxAlternateHour = ruleParams.get(MAX_ALTERNATIVE_HOURS_PER_DAY);</span>
<span class="nc" id="L210">			result.setFirst(maxHour);</span>
<span class="nc" id="L211">			result.setSecond(maxAlternateHour);</span>
			}
<span class="nc" id="L213">		return result;</span>
	}

	protected TimeRange getPreviousStartEndDate(Organization org, Date startTime) throws BbmCreateException, BbmFinderException, RemoteException {
<span class="nc" id="L217">		TimeRange previousRange = new TimeRange(startTime, startTime);</span>
<span class="nc" id="L218">		Calendar previousStartCal = Calendar.getInstance(org.getTimeZone());</span>
<span class="nc" id="L219">		previousStartCal.setTime(startTime);</span>
<span class="nc" id="L220">		previousStartCal.set(Calendar.HOUR_OF_DAY, -24);</span>
<span class="nc" id="L221">		previousStartCal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L222">		previousStartCal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L223">		previousStartCal.add(Calendar.MINUTE, org.getDayBoundaryOffset());</span>

<span class="nc" id="L225">		Calendar previousEndCal = Calendar.getInstance(org.getTimeZone());</span>
<span class="nc" id="L226">		previousEndCal.setTime(previousStartCal.getTime());</span>
<span class="nc" id="L227">		previousEndCal.add(Calendar.HOUR, 24);</span>
<span class="nc" id="L228">		previousRange.setStartDate(previousStartCal.getTime());</span>
<span class="nc" id="L229">		previousRange.setEndDate(previousEndCal.getTime());</span>
<span class="nc" id="L230">		return previousRange;</span>
	}

	protected boolean employeeReceivedShiftSwapApproved(ID employeeId, Date startDate, Date endDate) throws Exception {
<span class="nc" id="L234">		return ShiftSwapRequestUtil.employeeReceivedShiftSwapApproved(employeeId, startDate, endDate);</span>
	}

	@SuppressWarnings(&quot;unchecked&quot;)
	protected Collection&lt;ShiftAssignment&gt; getPublishedEventsForWorkResourceByType(ID empId, Date startTime, Date endTime) throws Exception {
<span class="nc" id="L239">		ScheduleAccessManager sam = RequestUtil.getScheduleAccessManager();</span>
<span class="nc" id="L240">		return sam.getPublishedEventsForWorkResourceByType(Event.EVENT_TYPE_SHIFT_ASSIGNMENT, empId, startTime, endTime);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>